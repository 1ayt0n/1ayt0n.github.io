System.register([],(function(e,t){"use strict";return{execute:function(){function n(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function i(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24}function r(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function o(e){return--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}e({BitMask:it,CCClass:Zt,CacheMode:void 0,DebugMode:void 0,ECollider2DType:void 0,EJoint2DType:void 0,EPhysics2DDrawFlags:void 0,ERaycast2DType:void 0,ERigidBody2DType:void 0,Enum:rt,Eventify:$l,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,NodeEventType:void 0,NodeSpace:void 0,Overflow:void 0,Physics2DManifoldType:void 0,PhysicsGroup:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,TransformBit:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:VE,WorldNode3DToWorldNodeUI:GE,absMax:bn,absMaxComponent:An,approx:sn,assert:C,assertID:M,bezier:Ef,bezierByTime:jf,ccenum:st,clamp:cn,clamp01:ln,color:In,computeRatioByType:NK,createDefaultPipeline:LO,debug:A,deserialize:Oh,earcut:kj,enumerableProps:Tn,equals:an,error:S,errorID:O,find:OR,fragmentText:yF,getBaselineOffset:function(){return 0},getEnglishWordPartAtFirst:vF,getEnglishWordPartAtLast:gF,getError:L,getPathFromRoot:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(e){return e[Rc]},getWorldTransformUntilRoot:function(e,t,n){for(jn.identity(n);e!==t;)jn.fromRTS(vZ,e.rotation,e.position,e.scale),jn.multiply(n,vZ,n),e=e.parent;return n},instantiate:Kh,inverseLerp:Cn,isDisplayStats:F,isEnglishWordPartAtFirst:function(e){return _F.test(e)},isEnglishWordPartAtLast:function(e){return hF.test(e)},isUnicodeCJK:fF,isUnicodeSpace:dF,isValid:pl,lerp:un,log:y,logID:I,markAsWarning:void 0,mat4:Xn,murmurhash2_32_gc:So,nextPow2:yn,pingPong:Sn,pseudoRandom:mn,pseudoRandomRange:vn,pseudoRandomRangeInt:gn,quat:kn,randomRange:dn,randomRangeInt:pn,rect:ri,removeProperty:void 0,repeat:xn,replaceProperty:void 0,safeMeasureText:pF,sampleAnimationCurve:OK,setDefaultLogTimes:function(e){e>0&&(q=e)},setDisplayStats:z,size:ni,toDegree:_n,toRadian:hn,tween:P7,tweenUtil:R7,v2:Qn,v3:On,v4:$n,warn:x,warnID:R});var a=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;e[t]=i<<r&255}}(a);var s=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(e){return(e>0)-(e<0)},abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:n,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:i,countTrailingZeros:r,nextPow2:o,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return a[255&e]<<24|a[e>>>8&255]<<16|a[e>>>16&255]<<8|a[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>r(e)+1}});e("bits",s);var c="undefined"==typeof window?global:window,l=e("cclegacy",{_global:c});l.internal={},c.CC_BUILD=!0,c.CC_TEST=!1,c.CC_EDITOR=false,c.CC_PREVIEW=!1,c.CC_DEV=!1,c.CC_DEBUG=!1,c.CC_JSB=!1,c.CC_BYTEDANCE=!1,c.CC_WECHAT=!1,c.CC_ALIPAY=!1,c.CC_XIAOMI=!1,c.CC_BAIDU=!1,c.CC_COCOSPLAY=!1,c.CC_HUAWEI=!1,c.CC_OPPO=!1,c.CC_VIVO=!1,c.CC_MINIGAME=!1,c.CC_RUNTIME_BASED=!1,c.CC_SUPPORT_JIT=!0;var u=e("VERSION","3.5.2");c.CocosEngine=l.ENGINE_VERSION=u,c.cc=l;var h="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",_=null,f=console.log.bind(console),d=f,p=f,m=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+g.apply(void 0,[t].concat(i)))}},v=f;function g(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return l.js.formatStr.apply(null,[e].concat(n))}function y(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return f.apply(void 0,[e].concat(n))}function x(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return d.apply(void 0,[e].concat(n))}function S(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return p.apply(void 0,[e].concat(n))}function C(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return m.apply(void 0,[e,t].concat(i))}function A(){return v.apply(void 0,arguments)}function b(e){if(f=d=p=m=v=function(){},e!==N.NONE){if(e>N.ERROR){var t=function(e){if(l.game.canvas){if(!_){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",l.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(_=document.createElement("textarea")).setAttribute("rows","20"),_.setAttribute("cols","30"),_.setAttribute("disabled","true");var i=_.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(_),l.game.canvas.parentNode.appendChild(t)}_.value=_.value+e+"\r\n",_.scrollTop=_.scrollHeight}};p=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("ERROR :  "+g.apply(void 0,[e].concat(i)))},m=function(e,n){if(!e){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];t("ASSERT: "+g.apply(void 0,[n].concat(r)))}},e!==N.ERROR_FOR_WEB_PAGE&&(d=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("WARN :  "+g.apply(void 0,[e].concat(i)))}),e===N.INFO_FOR_WEB_PAGE&&(f=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t(g.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),p=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},m=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=g.apply(void 0,[t].concat(i));throw new Error(o)}});if(e!==N.ERROR&&(d=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e<=N.INFO&&(f=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=N.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);v=function(){return n.apply(void 0,arguments)}}}}function T(e){S(e.stack||e)}function E(e){return function(t){for(var n=e+" "+t+", please go to "+h+"#"+t+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var w=E("Log");function I(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];y(w.apply(void 0,[e].concat(n)))}var P=E("Warning");function R(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];x(P.apply(void 0,[e].concat(n)))}var D=E("Error");function O(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];S(D.apply(void 0,[e].concat(n)))}var N,B=E("Assert");function M(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];C(!1,B.apply(void 0,[t].concat(i)))}}function L(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return D.apply(void 0,[e].concat(n))}function F(){return!!l.profiler&&l.profiler.isShowingStats()}function z(e){l.profiler&&(e?l.profiler.showStats():l.profiler.hideStats(),l.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(N||(N=e("DebugMode",{})));var V,G,U,k,H,j,W=Object.freeze({__proto__:null,log:y,warn:x,error:S,assert:C,debug:A,_resetDebugSetting:b,_throw:T,logID:I,warnID:R,errorID:O,assertID:M,get DebugMode(){return N},getError:L,isDisplayStats:F,setDisplayStats:z}),q=10,X=0,Y=new Map;function K(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function J(e,t,n){return t&&K(e.prototype,t),n&&K(e,n),e}function Q(){return(Q=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function Z(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,ee(e,t)}function $(e){return($=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ee(e,t){return(ee=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function te(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function ne(e,t,n){return(ne=te()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&ee(r,n.prototype),r}).apply(null,arguments)}function ie(e){var t="function"==typeof Map?new Map:void 0;return(ie=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return ne(e,arguments,$(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),ee(i,e)})(e)}function re(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function oe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function ae(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return oe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?oe(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function se(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function ce(e,t,n,i,r){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}k=function(e,t,n,i,r,o,a){var s=Y.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,e+"."+t,n+"."+i),s.count++)},V=e("replaceProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=X++;Y.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:q});var r=null!=n.target?n.target:e,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:t,s=r===e,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)e[n.name]=function(){var e;return k(t,n.name,a,o,x,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return k(t,n.name,a,o,x,i,c),n.customGetter.call(this)},set:function(e){k(t,n.name,a,o,x,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){k(t,n.name,a,o,x,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return k(t,n.name,a,o,x,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return k(t,n.name,a,o,x,i,c),s?this[o]:r[o]},set:function(e){k(t,n.name,a,o,x,i,c),s?this[o]=e:r[o]=e},enumerable:!1})}))})),j=function(e,t,n,i,r){var o=Y.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,e+"."+t),o.count++)},G=e("removeProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=X++;Y.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:q});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(e,n.name,{get:function(){return j(t,n.name,S,i,r)},set:function(){j(t,n.name,S,i,r)},enumerable:!1})}))})),H=function(e,t,n,i,r){var o=Y.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,e+"."+t),o.count++)},U=e("markAsWarning",(function(e,t,n){null!=e&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(e,i);if(r&&r.configurable){var o=X++;Y.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:q});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;e[i]=function(){return H(t,i,x,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(e,i,{configurable:!0,get:function(){return H(t,i,x,o,a),c}}),r.writable&&Object.defineProperty(e,i,{set:function(e){H(t,i,x,o,a),c=e}})}else!function(t,n,i,r,o,a){if(t.get){var s=t.get;t.get=function(){return H(n,i,r,o,a),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){H(n,i,r,o,a),c.call(this,e)}}Object.defineProperty(e,i,t)}(r,t,i,x,o,a);Object.defineProperty(e,i,{enumerable:!1})}}))}));var le=function(){function e(e){this.i=0,this.array=e}var t=e.prototype;return t.remove=function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)},t.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},t.fastRemove=function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)},t.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},t.push=function(e){this.array.push(e)},J(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function ue(e,t){e.splice(t,1)}function he(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function _e(e,t){var n=e.indexOf(t);return n>=0&&(ue(e,n),!0)}function fe(e,t){return e.indexOf(t)>=0}var de=Object.freeze({__proto__:null,removeAt:ue,fastRemoveAt:he,remove:_e,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:function(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return ue(e,n),i}},verifyType:function(e,t){if(e&&e.length>0)for(var n,i=ae(e);!(n=i()).done;)if(!(n.value instanceof t))return I(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)_e(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(t)),e},contains:fe,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:le}),pe=function(){function e(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return e.prototype.getNewId=function(){return this.prefix+ ++this.id},e}();pe.global=new pe("global");var me=new pe("TmpCId."),ve="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),ge="__cid__";function ye(e){return"number"==typeof e||e instanceof Number}function xe(e){return"string"==typeof e||e instanceof String}function Se(e){for(var t in e)return!1;return!0}var Ce,Ae=(Ce={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,r){Ce.value=n,Ce.writable=i,Ce.enumerable=r,Object.defineProperty(e,t,Ce),Ce.value=void 0}),be=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),e.get=i,e.set=r,e.enumerable=o,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),Te=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.get=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.get=void 0}}(),Ee=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.set=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.set=void 0}}();function we(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function Ie(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,r=e.toString();(i="["===r.charAt(0)?/\[\w+\s*(\w+)\]/.exec(r):/function\s*(\w+)/.exec(r))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?Ie(e.constructor):""}function Pe(e,t,n,i){var r=/([^.]+)$/,o=r.exec(t)[0],a=r.exec(n)[0];function s(){return this[a]}i?be(e,o,s,(function(e){this[a]=e})):Te(e,o,s)}function Re(e,t,n,i){for(var r in n)Pe(e,t+"."+r,n[r],i)}var De=/(%d)|(%s)/,Oe=/%s/;function Ne(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+e;var r="string"==typeof e&&De.test(e);if(r)for(var o,a=ae(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?De:Oe;if(c.test(e)){var l=""+s;e=e.replace(c,l)}else e+=" "+s}else for(var u,h=ae(n);!(u=h()).done;){var _=u.value;e+=" "+_}return e}function Be(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function Me(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function Le(e,t,n){var i=Me(t,e);i&&Object.defineProperty(n,e,i)}function Fe(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){O(5402,a);continue}for(var s in a)s in e||Le(s,a,e)}}return e}function ze(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){O(5403,a);continue}for(var s in a)Le(s,a,e)}}return e}function Ve(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function Ge(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function Ue(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=Ge(e)))return!1;if(e===t)return!0}}return!1}function ke(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var He=we(!0),je=we(!0);function We(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],Ae(i.prototype,e,n),n){var r=t[n];r&&r!==i?S("A Class already exists with the same "+e+' : "'+n+'".'):t[n]=i}}}var qe=We("__cid__",He),Xe=We("__classname__",je);function Ye(e,t){if(Xe(e,t),!t.prototype.hasOwnProperty(ge)){var n=e||me.getNewId();n&&qe(n,t)}}function Ke(e,t){var n=je[t],i=He[t],r=!0;if(n&&n!==e&&(S('"'+t+'" has already been set as name or alias of another class.'),r=!1),i&&i!==e&&(S('"'+t+'" has already been set as id or alias of another class.'),r=!1),r){var o=e[ve];o||(o=[],e[ve]=o),o.push(t),je[t]=e,He[t]=e}}function Je(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete He[s];var c=a.__classname__;c&&delete je[c];var l=a[ve];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete je[h],delete He[h]}}}function Qe(e){return He[e]}function Ze(e){return je[e]}function $e(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(ge))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(ge))return e.__cid__}return""}var et=function(){var e=t.prototype;function t(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===t?e:t,i=void 0===t?null:e;this.count=0,this._pool=new Array(n),this._cleanup=i}return e.get=function(){return this._get()},e._get=function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null},e.put=function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}},e.resize=function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))},t}(),tt=de,nt={IDGenerator:pe,Pool:et,array:de,isNumber:ye,isString:xe,isEmptyObject:Se,getPropertyDescriptor:Me,addon:Fe,mixin:ze,extend:Ve,getSuper:Ge,isChildClassOf:Ue,clear:ke,value:Ae,getset:be,get:Te,set:Ee,unregisterClass:Je,getClassName:Ie,setClassName:Ye,setClassAlias:Ke,getClassByName:Ze,get _registeredClassNames(){return Q({},je)},set _registeredClassNames(e){ke(je),Object.assign(je,e)},get _registeredClassIds(){return Q({},He)},set _registeredClassIds(e){ke(He),Object.assign(He,e)},_getClassId:$e,_setClassId:qe,_getClassById:Qe,obsolete:Pe,obsoletes:Re,formatStr:Ne,shiftArguments:Be,createMap:we};function it(e){if("__bitmask__"in e)return e;Ae(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&Ae(e,a,r)}return e}function rt(e){return"__enums__"in e?e:(Ae(e,"__enums__",null,!0),rt.update(e))}function ot(e){e.hasOwnProperty("__enums__")}function at(e){ot(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function st(e){"__enums__"in e||Ae(e,"__enums__",null,!0)}l.js=nt,e("js",Object.freeze({__proto__:null,array:tt,js:nt,IDGenerator:pe,Pool:et,isNumber:ye,isString:xe,isEmptyObject:Se,value:Ae,getset:be,get:Te,set:Ee,createMap:we,getClassName:Ie,obsolete:Pe,obsoletes:Re,formatStr:Ne,shiftArguments:Be,getPropertyDescriptor:Me,addon:Fe,mixin:ze,extend:Ve,getSuper:Ge,isChildClassOf:Ue,clear:ke,_idToClass:He,_nameToClass:je,_setClassId:qe,setClassName:Ye,setClassAlias:Ke,unregisterClass:Je,_getClassById:Qe,getClassByName:Ze,_getClassId:$e})),it.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},it.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},l.BitMask=it,rt.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&Ae(e,a,r)}return Array.isArray(e.__enums__)&&at(e),e},rt||(rt=e("Enum",{})),rt.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},rt.getList=function(e){return ot(e),e.__enums__?e.__enums__:at(e)},l.Enum=rt;var ct=e("ValueType",function(){function e(){}var t=e.prototype;return t.clone=function(){return O(100,Ie(this)+".clone"),this},t.equals=function(){return!1},t.set=function(){O(100,Ie(this)+".set")},t.toString=function(){return""},e}());Ye("cc.ValueType",ct),l.ValueType=ct;var lt=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});l.macro=lt;for(var ut=/^(?:cc|dragonBones|sp|ccsg)\..+/,ht=new Array(123),_t=0;_t<123;++_t)ht[_t]=64;for(var ft=0;ft<64;++ft)ht["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(ft)]=ft;var dt=ht;function pt(e,t,n){function i(e,t,n,i){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[n]=r.get),r.set&&i&&(e[i]=r.set);else{var o=e[n];be(e,t,o,e[i])}}for(var r,o=e.prototype,a=0;a<t.length;a++){var s=(r=t[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function mt(e,t,n,i){var r=e[t];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):e[t]=i?[n,r]:[r,n]:e[t]=n}function vt(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function gt(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function yt(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function xt(e){return!(!e||e.constructor!==Object)&&Se(e)}function St(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function Ct(e){return e*lt.RAD}function At(e){return e*lt.DEG}l.misc={BUILTIN_CLASSID_RE:ut,BASE64_VALUES:dt,propertyDefine:pt,pushToMap:mt,contains:vt,isDomNode:gt,callInNextTick:yt,isPlainEmptyObj_DEV:xt,clampf:St,degreesToRadians:Ct,radiansToDegrees:At},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:ut,BASE64_VALUES:dt,propertyDefine:pt,pushToMap:mt,contains:vt,isDomNode:gt,callInNextTick:yt,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:xt,clampf:St,degreesToRadians:Ct,radiansToDegrees:At}));var bt="$_$";function Tt(e,t){var n=t?Object.create(t):{};return Ae(e,"__attrs__",n),n}function Et(e){if("function"!=typeof e)return Tt(e,It(e.constructor));for(var t,n=l.Class.getInheritanceChain(e),i=n.length-1;i>=0;i--){var r=n[i];r.hasOwnProperty("__attrs__")&&r.__attrs__||Tt(r,(t=n[i+1])&&t.__attrs__)}return Tt(e,(t=n[0])&&t.__attrs__),e.__attrs__}function wt(e,t){var n=It(e),i=t+bt,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function It(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||Et(e)}function Pt(e,t,n,i){It(e)[t+bt+n]=i}var Rt=function(){function e(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}return e.prototype.toString=function(){return this.name},e}(),Dt=e("CCInteger",new Rt("Integer",0));l.Integer=Dt,l.CCInteger=Dt;var Ot=e("CCFloat",new Rt("Float",0));l.Float=Ot,l.CCFloat=Ot;var Nt=e("CCBoolean",new Rt("Boolean",!1));l.Boolean=Nt,l.CCBoolean=Nt;var Bt=e("CCString",new Rt("String",""));function Mt(e,t){return function(n,i){var r='"'+Ie(n)+"."+i+'"',o=wt(n,i),a=o.type;if(a===Dt||a===Ot?a="Number":a!==Bt&&a!==Nt||(a=""+a),a===e){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!xt(s)){var c=typeof s,l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;R(3605,r,Ie(o.ctor))}else"Number"!==e&&R(3606,t,r,e);else{if("function"===c)return;e===Bt.default&&null==s?R(3607,r):R(3611,t,r,c)}delete o.type}}}else R(3604,r)}}l.String=Bt,l.CCString=Bt;var Lt=Object.freeze({__proto__:null,DELIMETER:bt,createAttrsSingle:Tt,createAttrs:Et,attr:wt,getClassAttrs:It,setClassAttr:Pt,PrimitiveType:Rt,CCInteger:Dt,CCFloat:Ot,CCBoolean:Nt,CCString:Bt,getTypeChecker_ET:Mt,getObjTypeChecker_ET:function(e){return function(t,n){Mt("Object","type")(t,n);var i=It(t)[n+bt+"default"],r=l.Class.getDefault(i);if(!Array.isArray(r)&&Ue(e,l.ValueType)){var o=Ie(e),a=Ne('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Ie(t),n,o);i?y(a):R(3612,a,o,Ie(t),n,o)}}}}),Ft={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function zt(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,n.call(this,t)};var o={};for(var a in i[r]=o,Ft){var s=Ft[a];e.hasOwnProperty(a)&&(o[a]=e[a],s.canUsedInGet||delete e[a])}}}function Vt(e,t,n,i){if(Array.isArray(t)){if(!(t.length>0))return O(5508,n,i);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=l.String:t===Boolean?e.type=l.Boolean:t===Number&&(e.type=l.Float))}function Gt(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function Ut(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return Gt(t,[],e);if("function"==typeof e){var n=e;return Gt(t,Ue(n,l.ValueType)?new n:null,n)}return Gt(t,e instanceof Rt?e.default:e)}return null}var kt,Ht=[];function jt(){return Ht[Ht.length-1]}l._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),Ht.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=Ht.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:jt},function(e){e[e.STANDALONE=1]="STANDALONE",e[e.IMPLICIT_VISIBLE=2]="IMPLICIT_VISIBLE",e[e.IMPLICIT_SERIALIZABLE=4]="IMPLICIT_SERIALIZABLE"}(kt||(kt={}));var Wt=bt,qt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=Ie(i);r?Qt(i,o,r,i.$super,n.mixins):O(3633,o)}this.datas=null}}};function Xt(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),tn(e,i,t,n)}function Yt(e,t,n,i){var r=i.get;i.set,r&&(tn(e,i,t,n),Pt(e,n,"serializable",!1))}function Kt(e){return"function"==typeof e?e():e}function Jt(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,Me(t,i))}function Qt(e,t,n,i,r){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(e.__props__=e.__props__.concat(a.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],r=Ut(i,!1);if(r&&(i=e[n]=r),i){var o=i.notify;o&&zt(i,n,o,e),"type"in i&&Vt(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?Yt(e,t,s,c):Xt(e,t,s,c)}var l=It(e);e.__values__=e.__props__.filter((function(e){return!1!==l[e+Wt+"serializable"]}))}function Zt(e){var t=e.name,n=e.extends,i=e.mixins,r=function(e,t,n,i){var r=l.Component,o=jt();if(o&&Ue(t,r)){if(Ue(o.cls,r))return O(3615),null;e=e||o.script}var a=function(e,t,n,i){var r=i.ctor,o=[r],a=r;Ae(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(t&&(a.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Jt(s,l.prototype),Zt._isCCClass(l)&&Jt(It(a),It(l))}s.constructor=a}return Ye(e,a),a}(e,t,n,i);if(o)if(Ue(t,r)){var s=o.uuid;s&&qe(s,a),o.cls=a}else Ue(o.cls,r)||(o.cls=a);return a}(t,n,i,e);t||(t=l.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);var o=e.properties;"function"==typeof o||n&&null===n.__props__||i&&i.some((function(e){return null===e.__props__}))?(qt.push({cls:r,props:o,mixins:i}),r.__props__=r.__values__=null):Qt(r,t,o,n,e.mixins);var a=e.editor;return a&&Ue(n,l.Component)&&l.Component._registerEditorProps(r,a),r}function $t(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__values__")}Zt._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},Zt.fastDefine=function(e,t,n){Ye(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),r=It(t),o=0;o<i.length;o++){var a=i[o];r[a+Wt+"visible"]=!1,r[a+Wt+"default"]=n[a]}},Zt.Attr=Lt,Zt.attr=wt,Zt.getInheritanceChain=function(e){for(var t=[];e=Ge(e);)e!==Object&&t.push(e);return t};var en={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function tn(e,t,n,i){var r=null,o="";function a(){return o=i+Wt,r=It(e)}"type"in t&&void 0===t.type&&R(3660,i,n);var s=t.type;s&&(en[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?rt.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=rt.getList(s)):it.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=it.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in t&&((r||a())[o+"default"]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];typeof i===n&&((r||a())[o+e]=i)}};t.editorOnly&&((r||a())[o+"editorOnly"]=!0),t.__internalFlags&kt.STANDALONE?c=!0===t.serializable||0!=(t.__internalFlags&kt.IMPLICIT_SERIALIZABLE):!1===t.serializable&&(c=!1),void 0!==c&&((r||a())[o+"serializable"]=c),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}Zt.isArray=function(e){return e=Kt(e),Array.isArray(e)},Zt.getDefault=Kt,Zt.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Zt.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Zt.getNewValueTypeCode=function(e){for(var t=Ie(e),n=e.constructor,i="new "+t+"(",r=0;r<n.__props__.length;r++)i+=e[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},l.Class=Zt;var nn=Math.PI/180,rn=180/Math.PI,on=e("EPSILON",1e-6);function an(e,t){return Math.abs(e-t)<=on*Math.max(1,Math.abs(e),Math.abs(t))}function sn(e,t,n){return n=n||on,Math.abs(e-t)<=n}function cn(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function ln(e){return e<0?0:e>1?1:e}function un(e,t,n){return e+(t-e)*n}function hn(e){return e*nn}function _n(e){return e*rn}var fn=e("random",Math.random);function dn(e,t){return Math.random()*(t-e)+e}function pn(e,t){return Math.floor(dn(e,t))}function mn(e){return(e=(9301*e+49297)%233280)/233280}function vn(e,t,n){return mn(e)*(n-t)+t}function gn(e,t,n){return Math.floor(vn(e,t,n))}function yn(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function xn(e,t){return e-Math.floor(e/t)*t}function Sn(e,t){return e=xn(e,2*t),t-Math.abs(e-t)}function Cn(e,t,n){return(n-e)/(t-e)}function An(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function bn(e,t){return Math.abs(e)>Math.abs(t)?e:t}function Tn(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var En=1/255,wn=e("Color",function(e){function t(t,n,i,r){var o;return(o=e.call(this)||this)._val=0,"string"==typeof t?o.fromHEX(t):void 0!==n?o.set(t,n,i,r):o.set(t),o}Z(t,e),t.clone=function(e){var n=new t;return e._val?n._val=e._val:n._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,n},t.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},t.set=function(e,t,n,i,r){return e.r=t,e.g=n,e.b=i,e.a=r,e},t.fromHEX=function(e,t){t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0;var n=parseInt(t.substr(6,2),16);return e.a=Number.isNaN(n)?255:n,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},t.add=function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e},t.subtract=function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e},t.multiply=function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e},t.divide=function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e},t.scale=function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e},t.lerp=function(e,t,n,i){var r=t.r,o=t.g,a=t.b,s=t.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),e},t.toArray=function(e,n,i){void 0===i&&(i=0);var r=n instanceof t||n.a>1?1/255:1;return e[i+0]=n.r*r,e[i+1]=n.g*r,e[i+2]=n.b*r,e[i+3]=n.a*r,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t},t.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},t.equals=function(e,t,n){return void 0===n&&(n=on),Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))},t.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0};var n=t.prototype;return n.clone=function(){var e=new t;return e._val=this._val,e},n.equals=function(e){return e&&this._val===e._val},n.lerp=function(e,t){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,r+=(e.b-r)*t,o+=(e.a-o)*t,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(e){return void 0===e&&(e="rgba"),"rgba"===e?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*En).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},n.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|t),this},n.toHEX=function(e){void 0===e&&(e="#rrggbb");var t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(e,t,n){var i=0,r=0,o=0;if(0===t)i=r=o=n;else if(0===n)i=r=o=0;else{1===e&&(e=0),e*=6;var a=Math.floor(e),s=e-a,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var e=this.r*En,t=this.g*En,n=this.b*En,i={h:0,s:0,v:0},r=Math.max(e,t,n),o=Math.min(e,t,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=e===r?(t-n)/a:t===r?2+(n-e)/a:4+(e-t)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(e,t,n,i){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this},n.multiply=function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&i|65280&n|255&t,this},n._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},n._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},n._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},n._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},J(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~cn(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~cn(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~cn(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~cn(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*En},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*En},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*En},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*En},set:function(e){this.a=255*e}}]),t}(ct));function In(e,t,n,i){return new wn(e,t,n,i)}wn.WHITE=Object.freeze(new wn(255,255,255,255)),wn.GRAY=Object.freeze(new wn(127,127,127,255)),wn.BLACK=Object.freeze(new wn(0,0,0,255)),wn.TRANSPARENT=Object.freeze(new wn(0,0,0,0)),wn.RED=Object.freeze(new wn(255,0,0,255)),wn.GREEN=Object.freeze(new wn(0,255,0,255)),wn.BLUE=Object.freeze(new wn(0,0,255,255)),wn.CYAN=Object.freeze(new wn(0,255,255,255)),wn.MAGENTA=Object.freeze(new wn(255,0,255,255)),wn.YELLOW=Object.freeze(new wn(255,255,0,255)),Zt.fastDefine("cc.Color",wn,{r:0,g:0,b:0,a:255}),l.Color=wn,l.color=In;var Pn=e("Vec3",function(e){function t(t,n,i){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z):(r.x=t||0,r.y=n||0,r.z=i||0),r}Z(t,e),t.zero=function(e){return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return new t(e.x,e.y,e.z)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.set=function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},t.len=function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},t.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},t.invertSafe=function(e,t){var n=t.x,i=t.y,r=t.z;return Math.abs(n)<on?e.x=0:e.x=1/n,Math.abs(i)<on?e.y=0:e.y=1/i,Math.abs(r)<on?e.z=0:e.z=1/r,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o,e.z=r*o),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.cross=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z;return e.x=r*c-o*s,e.y=o*a-i*c,e.z=i*s-r*a,e},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e},t.random=function(e,t){t=t||1;var n=2*fn()*Math.PI,i=2*fn()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,e.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,e.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,e},t.transformMat4Normal=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o)*a,e.y=(n.m01*i+n.m05*r+n.m09*o)*a,e.z=(n.m02*i+n.m06*r+n.m10*o)*a,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=i*n.m00+r*n.m03+o*n.m06,e.y=i*n.m01+r*n.m04+o*n.m07,e.z=i*n.m02+r*n.m05+o*n.m08,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14,e},t.transformQuat=function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,r=n.w*t.y+n.z*t.x-n.x*t.z,o=n.w*t.z+n.x*t.y-n.y*t.x,a=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,e.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,e.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,e},t.transformRTS=function(e,t,n,i,r){var o=t.x*r.x,a=t.y*r.y,s=t.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e},t.transformInverseRTS=function(e,t,n,i,r){var o=t.x-i.x,a=t.y-i.y,s=t.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,e},t.rotateX=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateY=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateZ=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},t.equals=function(e,t,n){void 0===n&&(n=on);var i=e.x,r=e.y,o=e.z,a=t.x,s=t.y,c=t.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},t.angle=function(e,n){t.normalize(Rn,e),t.normalize(Dn,n);var i=t.dot(Rn,Dn);return i>1?0:i<-1?Math.PI:Math.acos(i)},t.projectOnPlane=function(e,n,i){return t.subtract(e,n,t.project(e,n,i))},t.project=function(e,n,i){var r=t.lengthSqr(i);return r<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,i,t.dot(n,i)/r)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z)},n.set=function(e,t,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this},n.equals=function(e,t){return void 0===t&&(t=on),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},n.equals3f=function(e,t,n,i){return void 0===i&&(i=on),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},n.strictEquals3f=function(e,t,n){return this.x===e&&this.y===t&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},n.add3f=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},n.subtract3f=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},n.multiply3f=function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},n.divide3f=function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(e,t){return this.x=cn(this.x,e.x,t.x),this.y=cn(this.y,e.y,t.y),this.z=cn(this.z,e.z,t.z),this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=e.m03*t+e.m07*n+e.m11*i+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*r,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*r,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*r,this},t}(ct));Pn.UNIT_X=Object.freeze(new Pn(1,0,0)),Pn.UNIT_Y=Object.freeze(new Pn(0,1,0)),Pn.UNIT_Z=Object.freeze(new Pn(0,0,1)),Pn.RIGHT=Object.freeze(new Pn(1,0,0)),Pn.UP=Object.freeze(new Pn(0,1,0)),Pn.FORWARD=Object.freeze(new Pn(0,0,-1)),Pn.ZERO=Object.freeze(new Pn(0,0,0)),Pn.ONE=Object.freeze(new Pn(1,1,1)),Pn.NEG_ONE=Object.freeze(new Pn(-1,-1,-1));var Rn=new Pn,Dn=new Pn;function On(e,t,n){return new Pn(e,t,n)}Zt.fastDefine("cc.Vec3",Pn,{x:0,y:0,z:0}),l.Vec3=Pn,l.v3=On;var Nn=e("Mat3",function(e){function t(t,n,i,r,o,a,s,c,l){var u;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=e.call(this)||this,"object"==typeof t?(u.m00=t.m00,u.m01=t.m01,u.m02=t.m02,u.m03=t.m03,u.m04=t.m04,u.m05=t.m05,u.m06=t.m06,u.m07=t.m07,u.m08=t.m08):(u.m00=t,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}Z(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.set=function(e,t,n,i,r,o,a,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*a-s*l,_=-u*o+s*c,f=l*o-a*c,d=n*h+i*_+r*f;return 0===d?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(d=1/d,e.m00=h*d,e.m01=(-u*i+r*l)*d,e.m02=(s*i-r*a)*d,e.m03=_*d,e.m04=(u*n-r*c)*d,e.m05=(-s*n+r*o)*d,e.m06=f*d,e.m07=(-l*n+i*c)*d,e.m08=(a*n-i*o)*d,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return e.m00=_*i+f*a+d*l,e.m01=_*r+f*s+d*u,e.m02=_*o+f*c+d*h,e.m03=p*i+m*a+v*l,e.m04=p*r+m*s+v*u,e.m05=p*o+m*c+v*h,e.m06=g*i+y*a+x*l,e.m07=g*r+y*s+x*u,e.m08=g*o+y*c+x*h,e},t.multiplyMat4=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.m00,f=n.m01,d=n.m02,p=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return e.m00=_*i+f*a+d*l,e.m01=_*r+f*s+d*u,e.m02=_*o+f*c+d*h,e.m03=p*i+m*a+v*l,e.m04=p*r+m*s+v*u,e.m05=p*o+m*c+v*h,e.m06=g*i+y*a+x*l,e.m07=g*r+y*s+x*u,e.m08=g*o+y*c+x*h,e},t.transform=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=n.x,f=n.y;return e.m00=i,e.m01=r,e.m02=o,e.m03=a,e.m04=s,e.m05=c,e.m06=_*i+f*a+l,e.m07=_*r+f*s+u,e.m08=_*o+f*c+h,e},t.scale=function(e,t,n){var i=n.x,r=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.rotate=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=Math.sin(n),f=Math.cos(n);return e.m00=f*i+_*a,e.m01=f*r+_*s,e.m02=f*o+_*c,e.m03=f*a-_*i,e.m04=f*s-_*r,e.m05=f*c-_*o,e.m06=l,e.m07=u,e.m08=h,e},t.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},t.fromViewUp=function(e,n,i){return Pn.lengthSqr(n)<on*on?(t.identity(e),e):(i=i||Pn.UNIT_Y,Pn.normalize(Bn,Pn.cross(Bn,i,n)),Pn.lengthSqr(Bn)<on*on?(t.identity(e),e):(Pn.cross(Mn,n,Bn),t.set(e,Bn.x,Bn.y,Bn.z,Mn.x,Mn.y,Mn.z,n.x,n.y,n.z),e))},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,d=r*c,p=o*a,m=o*s,v=o*c;return e.m00=1-h-d,e.m03=u-v,e.m06=_+m,e.m01=u+v,e.m04=1-l-d,e.m07=f-p,e.m02=_-m,e.m05=f+p,e.m08=1-l-h,e},t.inverseTransposeMat4=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,C=i*l-o*s,A=r*l-o*c,b=u*p-h*d,T=u*m-_*d,E=u*v-f*d,w=h*m-_*p,I=h*v-f*p,P=_*v-f*m,R=g*P-y*I+x*w+S*E-C*T+A*b;return R?(R=1/R,e.m00=(s*P-c*I+l*w)*R,e.m01=(c*E-a*P-l*T)*R,e.m02=(a*I-s*E+l*b)*R,e.m03=(r*I-i*P-o*w)*R,e.m04=(n*P-r*E+o*T)*R,e.m05=(i*E-n*I-o*b)*R,e.m06=(p*A-m*C+v*S)*R,e.m07=(m*x-d*A-v*y)*R,e.m08=(d*C-p*x+v*g)*R,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},t.equals=function(e,t,n){return void 0===n&&(n=on),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))};var n=t.prototype;return n.clone=function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},n.set=function(e,t,n,i,r,o,a,s,c){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(e,t){return void 0===t&&(t=on),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},n.toString=function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,_=e*l+t*u+n*h;return 0===_?(this.set(0,0,0,0,0,0,0,0,0),this):(_=1/_,this.m00=l*_,this.m01=(-c*t+n*s)*_,this.m02=(o*t-n*r)*_,this.m03=u*_,this.m04=(c*e-n*a)*_,this.m05=(-o*e+n*i)*_,this.m06=h*_,this.m07=(-s*e+t*a)*_,this.m08=(r*e-t*i)*_,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return e*(c*r-o*s)+t*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,_=e.m02,f=e.m03,d=e.m04,p=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+_*s,this.m01=u*n+h*o+_*c,this.m02=u*i+h*a+_*l,this.m03=f*t+d*r+p*s,this.m04=f*n+d*o+p*c,this.m05=f*i+d*a+p*l,this.m06=m*t+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},n.scale=function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*t,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,d=r*o,p=r*a,m=r*s;return this.m00=1-u-f,this.m03=l-m,this.m06=h+p,this.m01=l+m,this.m04=1-c-f,this.m07=_-d,this.m02=h-p,this.m05=_+d,this.m08=1-c-u,this},t}(ct));Nn.IDENTITY=Object.freeze(new Nn);var Bn=new Pn,Mn=new Pn;Zt.fastDefine("cc.Mat3",Nn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),l.Mat3=Nn;var Ln=e("Quat",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}Z(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},t.rotationTo=function(e,n,i){var r=Pn.dot(n,i);return r<-.999999?(Pn.cross(Vn,Pn.UNIT_X,n),Vn.length()<1e-6&&Pn.cross(Vn,Pn.UNIT_Y,n),Pn.normalize(Vn,Vn),t.fromAxisAngle(e,Vn,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(Pn.cross(Vn,n,i),e.x=Vn.x,e.y=Vn.y,e.z=Vn.z,e.w=1+r,t.normalize(e,e))},t.getAxisAngle=function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n},t.multiply=function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,r=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,o=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,a=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=r,e.z=o,e.w=a,e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.rotateX=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+c*i,e.y=a*r+s*i,e.z=s*r-a*i,e.w=c*r-o*i,e},t.rotateY=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r-s*i,e.y=a*r+c*i,e.z=s*r+o*i,e.w=c*r-a*i,e},t.rotateZ=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+a*i,e.y=a*r-o*i,e.z=s*r+c*i,e.w=c*r-s*i,e},t.rotateAround=function(e,n,i,r){return t.invert(Fn,n),Pn.transformQuat(Vn,i,Fn),t.fromAxisAngle(Fn,Vn,r),t.multiply(e,n,Fn),e},t.rotateAroundLocal=function(e,n,i,r){return t.fromAxisAngle(Fn,i,r),t.multiply(e,n,Fn),e},t.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.slerp=function(e,t,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),_=Math.sin(h);r=Math.sin((1-i)*h)/_,o=Math.sin(i*h)/_}else r=1-i,o=i;return e.x=r*t.x+o*a,e.y=r*t.y+o*s,e.z=r*t.z+o*c,e.w=r*t.w+o*l,e},t.sqlerp=function(e,n,i,r,o,a){return t.slerp(Fn,n,o,a),t.slerp(zn,i,r,a),t.slerp(e,Fn,zn,2*a*(1-a)),e},t.invert=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},t.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},t.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},t.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.normalize=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e},t.fromAxes=function(e,n,i,r){return Nn.set(Gn,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),t.normalize(e,t.fromMat3(e,Gn))},t.fromViewUp=function(e,n,i){return Nn.fromViewUp(Gn,n,i),t.normalize(e,t.fromMat3(e,Gn))},t.fromAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e},t.fromMat3=function(e,t){var n=t.m00,i=t.m03,r=t.m06,o=t.m01,a=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+a+u;if(h>0){var _=.5/Math.sqrt(h+1);e.w=.25/_,e.x=(l-s)*_,e.y=(r-c)*_,e.z=(o-i)*_}else if(n>a&&n>u){var f=2*Math.sqrt(1+n-a-u);e.w=(l-s)/f,e.x=.25*f,e.y=(i+o)/f,e.z=(r+c)/f}else if(a>u){var d=2*Math.sqrt(1+a-n-u);e.w=(r-c)/d,e.x=(i+o)/d,e.y=.25*d,e.z=(s+l)/d}else{var p=2*Math.sqrt(1+u-n-a);e.w=(o-i)/p,e.x=(r+c)/p,e.y=(s+l)/p,e.z=.25*p}return e},t.fromEuler=function(e,t,n,i){t*=Un,n*=Un,i*=Un;var r=Math.sin(t),o=Math.cos(t),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=r*s*l+o*a*c,e.y=o*a*l+r*s*c,e.z=o*s*c-r*a*l,e.w=o*s*l-r*a*c,e},t.fromAngleZ=function(e,t){return t*=Un,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},t.toAxisX=function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e},t.toAxisY=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=i*t.x-r*t.w,e.y=1-n*t.x-r*t.z,e.z=r*t.y+n*t.w,e},t.toAxisZ=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=r*t.x-i*t.w,e.y=r*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e},t.toEuler=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=_n(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-_n(2*Math.atan2(i,a)),l=-90;else{var h=i*i,_=r*r,f=o*o;s=_n(Math.atan2(2*i*a-2*r*o,1-2*h-2*f)),c=_n(Math.atan2(2*r*a-2*i*o,1-2*_-2*f)),l=_n(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=on),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(e,t){return void 0===t&&(t=on),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.getEulerAngles=function(e){return t.toEuler(e,this)},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},n.slerp=function(e,n){return t.slerp(this,this,e,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t}(ct));Ln.IDENTITY=Object.freeze(new Ln);var Fn=new Ln,zn=new Ln,Vn=new Pn,Gn=new Nn,Un=.5*Math.PI/180;function kn(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),new Ln(e,t,n,i)}Zt.fastDefine("cc.Quat",Ln,{x:0,y:0,z:0,w:1}),l.Quat=Ln,l.quat=kn;var Hn=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),jn=e("Mat4",function(e){function t(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m){var v;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=1),(v=e.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof t?(v.m00=t.m00,v.m01=t.m01,v.m02=t.m02,v.m03=t.m03,v.m04=t.m04,v.m05=t.m05,v.m06=t.m06,v.m07=t.m07,v.m08=t.m08,v.m09=t.m09,v.m10=t.m10,v.m11=t.m11,v.m12=t.m12,v.m13=t.m13,v.m14=t.m14,v.m15=t.m15):(v.m00=t,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=_,v.m12=f,v.m13=d,v.m14=p,v.m15=m),v}Z(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=_,e.m12=f,e.m13=d,e.m14=p,e.m15=m,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m03,o=t.m06,a=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=o,e.m11=t.m14,e.m12=r,e.m13=a,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,C=i*l-o*s,A=r*l-o*c,b=u*p-h*d,T=u*m-_*d,E=u*v-f*d,w=h*m-_*p,I=h*v-f*p,P=_*v-f*m,R=g*P-y*I+x*w+S*E-C*T+A*b;return 0===R?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(R=1/R,e.m00=(s*P-c*I+l*w)*R,e.m01=(r*I-i*P-o*w)*R,e.m02=(p*A-m*C+v*S)*R,e.m03=(_*C-h*A-f*S)*R,e.m04=(c*E-a*P-l*T)*R,e.m05=(n*P-r*E+o*T)*R,e.m06=(m*x-d*A-v*y)*R,e.m07=(u*A-_*x+f*y)*R,e.m08=(a*I-s*E+l*b)*R,e.m09=(i*E-n*I-o*b)*R,e.m10=(d*C-p*x+v*g)*R,e.m11=(h*x-u*C-f*g)*R,e.m12=(s*T-a*w-c*b)*R,e.m13=(n*w-i*T+r*b)*R,e.m14=(p*y-d*S-m*g)*R,e.m15=(u*S-h*y+_*g)*R,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,_=e.m11,f=e.m12,d=e.m13,p=e.m14,m=e.m15;return(t*a-n*o)*(h*m-_*p)-(t*s-i*o)*(u*m-_*d)+(t*c-r*o)*(u*p-h*d)+(n*s-i*a)*(l*m-_*f)-(n*c-r*a)*(l*p-h*f)+(i*c-r*s)*(l*d-u*f)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,_=t.m09,f=t.m10,d=t.m11,p=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,x=n.m01,S=n.m02,C=n.m03;return e.m00=y*i+x*s+S*h+C*p,e.m01=y*r+x*c+S*_+C*m,e.m02=y*o+x*l+S*f+C*v,e.m03=y*a+x*u+S*d+C*g,y=n.m04,x=n.m05,S=n.m06,C=n.m07,e.m04=y*i+x*s+S*h+C*p,e.m05=y*r+x*c+S*_+C*m,e.m06=y*o+x*l+S*f+C*v,e.m07=y*a+x*u+S*d+C*g,y=n.m08,x=n.m09,S=n.m10,C=n.m11,e.m08=y*i+x*s+S*h+C*p,e.m09=y*r+x*c+S*_+C*m,e.m10=y*o+x*l+S*f+C*v,e.m11=y*a+x*u+S*d+C*g,y=n.m12,x=n.m13,S=n.m14,C=n.m15,e.m12=y*i+x*s+S*h+C*p,e.m13=y*r+x*c+S*_+C*m,e.m14=y*o+x*l+S*f+C*v,e.m15=y*a+x*u+S*d+C*g,e},t.transform=function(e,t,n){var i=n.x,r=n.y,o=n.z;if(t===e)e.m12=t.m00*i+t.m04*r+t.m08*o+t.m12,e.m13=t.m01*i+t.m05*r+t.m09*o+t.m13,e.m14=t.m02*i+t.m06*r+t.m10*o+t.m14,e.m15=t.m03*i+t.m07*r+t.m11*o+t.m15;else{var a=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,_=t.m06,f=t.m07,d=t.m08,p=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=a,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=_,e.m07=f,e.m08=d,e.m09=p,e.m10=m,e.m11=v,e.m12=a*i+u*r+d*o+t.m12,e.m13=s*i+h*r+p*o+t.m13,e.m14=c*i+_*r+m*o+t.m14,e.m15=l*i+f*r+v*o+t.m15}return e},t.translate=function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e},t.scale=function(e,t,n){var i=n.x,r=n.y,o=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*o,e.m09=t.m09*o,e.m10=t.m10*o,e.m11=t.m11*o,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.rotate=function(e,t,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<on)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,_=t.m01,f=t.m02,d=t.m03,p=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,x=t.m09,S=t.m10,C=t.m11,A=r*r*u+l,b=o*r*u+a*c,T=a*r*u-o*c,E=r*o*u-a*c,w=o*o*u+l,I=a*o*u+r*c,P=r*a*u+o*c,R=o*a*u-r*c,D=a*a*u+l;return e.m00=h*A+p*b+y*T,e.m01=_*A+m*b+x*T,e.m02=f*A+v*b+S*T,e.m03=d*A+g*b+C*T,e.m04=h*E+p*w+y*I,e.m05=_*E+m*w+x*I,e.m06=f*E+v*w+S*I,e.m07=d*E+g*w+C*I,e.m08=h*P+p*R+y*D,e.m09=_*P+m*R+x*D,e.m10=f*P+v*R+S*D,e.m11=d*P+g*R+C*D,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},t.rotateX=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=o*r+l*i,e.m05=a*r+u*i,e.m06=s*r+h*i,e.m07=c*r+_*i,e.m08=l*r-o*i,e.m09=u*r-a*i,e.m10=h*r-s*i,e.m11=_*r-c*i,e},t.rotateY=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,_=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r-l*i,e.m01=a*r-u*i,e.m02=s*r-h*i,e.m03=c*r-_*i,e.m08=o*i+l*r,e.m09=a*i+u*r,e.m10=s*i+h*r,e.m11=c*i+_*r,e},t.rotateZ=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,_=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r+l*i,e.m01=a*r+u*i,e.m02=s*r+h*i,e.m03=c*r+_*i,e.m04=l*r-o*i,e.m05=u*r-a*i,e.m06=h*r-s*i,e.m07=_*r-c*i,e},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRotation=function(e,t,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<on)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=r*i*l+o*s,e.m02=o*i*l-r*s,e.m03=0,e.m04=i*r*l-o*s,e.m05=r*r*l+c,e.m06=o*r*l+i*s,e.m07=0,e.m08=i*o*l+r*s,e.m09=r*o*l-i*s,e.m10=o*o*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromXRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromYRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromZRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRT=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=o*l,m=a*s,v=a*c,g=a*l;return e.m00=1-(f+p),e.m01=h+g,e.m02=_-v,e.m03=0,e.m04=h-g,e.m05=1-(u+p),e.m06=d+m,e.m07=0,e.m08=_+v,e.m09=d-m,e.m10=1-(u+f),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},t.getScaling=function(e,t){var n=qn.m00=t.m00,i=qn.m01=t.m01,r=qn.m02=t.m02,o=qn.m03=t.m04,a=qn.m04=t.m05,s=qn.m05=t.m06,c=qn.m06=t.m08,l=qn.m07=t.m09,u=qn.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(o*o+a*a+s*s),e.z=Math.sqrt(c*c+l*l+u*u),Nn.determinant(qn)<0&&(e.x*=-1),e},t.getRotation=function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e},t.toRTS=function(e,t,n,i){i.x=Pn.set(Wn,e.m00,e.m01,e.m02).length(),qn.m00=e.m00/i.x,qn.m01=e.m01/i.x,qn.m02=e.m02/i.x,i.y=Pn.set(Wn,e.m04,e.m05,e.m06).length(),qn.m03=e.m04/i.y,qn.m04=e.m05/i.y,qn.m05=e.m06/i.y,i.z=Pn.set(Wn,e.m08,e.m09,e.m10).length(),qn.m06=e.m08/i.z,qn.m07=e.m09/i.z,qn.m08=e.m10/i.z,Nn.determinant(qn)<0&&(i.x*=-1,qn.m00*=-1,qn.m01*=-1,qn.m02*=-1),Ln.fromMat3(t,qn),Pn.set(n,e.m12,e.m13,e.m14)},t.fromRTS=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=t.w,c=r+r,l=o+o,u=a+a,h=r*c,_=r*l,f=r*u,d=o*l,p=o*u,m=a*u,v=s*c,g=s*l,y=s*u,x=i.x,S=i.y,C=i.z;return e.m00=(1-(d+m))*x,e.m01=(_+y)*x,e.m02=(f-g)*x,e.m03=0,e.m04=(_-y)*S,e.m05=(1-(h+m))*S,e.m06=(p+v)*S,e.m07=0,e.m08=(f+g)*C,e.m09=(p-v)*C,e.m10=(1-(h+d))*C,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.fromRTSOrigin=function(e,t,n,i,r){var o=t.x,a=t.y,s=t.z,c=t.w,l=o+o,u=a+a,h=s+s,_=o*l,f=o*u,d=o*h,p=a*u,m=a*h,v=s*h,g=c*l,y=c*u,x=c*h,S=i.x,C=i.y,A=i.z,b=r.x,T=r.y,E=r.z;return e.m00=(1-(p+v))*S,e.m01=(f+x)*S,e.m02=(d-y)*S,e.m03=0,e.m04=(f-x)*C,e.m05=(1-(_+v))*C,e.m06=(m+g)*C,e.m07=0,e.m08=(d+y)*A,e.m09=(m-g)*A,e.m10=(1-(_+p))*A,e.m11=0,e.m12=n.x+b-(e.m00*b+e.m04*T+e.m08*E),e.m13=n.y+T-(e.m01*b+e.m05*T+e.m09*E),e.m14=n.z+E-(e.m02*b+e.m06*T+e.m10*E),e.m15=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,_=r*a,f=r*s,d=r*c,p=o*a,m=o*s,v=o*c;return e.m00=1-h-d,e.m01=u+v,e.m02=_-m,e.m03=0,e.m04=u-v,e.m05=1-l-d,e.m06=f+p,e.m07=0,e.m08=_+m,e.m09=f-p,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.frustum=function(e,t,n,i,r,o,a){var s=1/(n-t),c=1/(r-i),l=1/(o-a);return e.m00=2*o*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*o*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(r+i)*c,e.m10=(a+o)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*o*2*l,e.m15=0,e},t.perspective=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(t/2),u=1/(i-r),h=o?l/n:l,_=(o?l:l*n)*s,f=Hn[c];return e.m00=h*f[0],e.m01=h*f[1],e.m02=0,e.m03=0,e.m04=_*f[2],e.m05=_*f[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-a*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*i*u*(1-a),e.m15=0,e},t.ortho=function(e,t,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(t-n),h=1/(i-r)*c,_=1/(o-a),f=-2*u,d=-2*h,p=(t+n)*u,m=(r+i)*h,v=Hn[l];return e.m00=f*v[0],e.m01=f*v[1],e.m02=0,e.m03=0,e.m04=d*v[2],e.m05=d*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=_*(1-s),e.m11=0,e.m12=p*v[0]+m*v[2],e.m13=p*v[1]+m*v[3],e.m14=(o-s*a)*_,e.m15=1,e},t.lookAt=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,_=a-n.z,f=1/Math.sqrt(u*u+h*h+_*_),d=c*(_*=f)-l*(h*=f),p=l*(u*=f)-s*_,m=s*h-c*u,v=h*(m*=f=1/Math.sqrt(d*d+p*p+m*m))-_*(p*=f),g=_*(d*=f)-u*m,y=u*p-h*d;return e.m00=d,e.m01=v,e.m02=u,e.m03=0,e.m04=p,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=_,e.m11=0,e.m12=-(d*r+p*o+m*a),e.m13=-(v*r+g*o+y*a),e.m14=-(u*r+h*o+_*a),e.m15=1,e},t.inverseTranspose=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,_=t.m10,f=t.m11,d=t.m12,p=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,C=i*l-o*s,A=r*l-o*c,b=u*p-h*d,T=u*m-_*d,E=u*v-f*d,w=h*m-_*p,I=h*v-f*p,P=_*v-f*m,R=g*P-y*I+x*w+S*E-C*T+A*b;return R?(R=1/R,e.m00=(s*P-c*I+l*w)*R,e.m01=(c*E-a*P-l*T)*R,e.m02=(a*I-s*E+l*b)*R,e.m03=0,e.m04=(r*I-i*P-o*w)*R,e.m05=(n*P-r*E+o*T)*R,e.m06=(i*E-n*I-o*b)*R,e.m07=0,e.m08=(p*A-m*C+v*S)*R,e.m09=(m*x-d*A-v*y)*R,e.m10=(d*C-p*x+v*g)*R,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},t.equals=function(e,t,n){return void 0===n&&(n=on),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))};var n=t.prototype;return n.clone=function(){return new t(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=0),void 0===p&&(p=1),"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=_,this.m13=f,this.m14=d,this.m15=p,this.m00=e),this},n.equals=function(e,t){return void 0===t&&(t=on),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15,m=e*o-t*r,v=e*a-n*r,g=e*s-i*r,y=t*a-n*o,x=t*s-i*o,S=n*s-i*a,C=c*f-l*_,A=c*d-u*_,b=c*p-h*_,T=l*d-u*f,E=l*p-h*f,w=u*p-h*d,I=m*w-v*E+g*T+y*b-x*A+S*C;return 0===I?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(I=1/I,this.m00=(o*w-a*E+s*T)*I,this.m01=(n*E-t*w-i*T)*I,this.m02=(f*S-d*x+p*y)*I,this.m03=(u*x-l*S-h*y)*I,this.m04=(a*b-r*w-s*A)*I,this.m05=(e*w-n*b+i*A)*I,this.m06=(d*g-_*S-p*v)*I,this.m07=(c*S-u*g+h*v)*I,this.m08=(r*E-o*b+s*C)*I,this.m09=(t*b-e*E-i*C)*I,this.m10=(_*x-f*g+p*m)*I,this.m11=(l*g-c*x-h*m)*I,this.m12=(o*A-r*T-a*C)*I,this.m13=(e*T-t*A+n*C)*I,this.m14=(f*v-_*y-d*m)*I,this.m15=(c*y-l*v+u*m)*I,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,_=this.m12,f=this.m13,d=this.m14,p=this.m15;return(e*o-t*r)*(u*p-h*d)-(e*a-n*r)*(l*p-h*f)+(e*s-i*r)*(l*d-u*f)+(t*a-n*o)*(c*p-h*_)-(t*s-i*o)*(c*d-u*_)+(n*s-i*a)*(c*f-l*_)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,_=this.m11,f=this.m12,d=this.m13,p=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,x=e.m03;return this.m00=v*t+g*o+y*l+x*f,this.m01=v*n+g*a+y*u+x*d,this.m02=v*i+g*s+y*h+x*p,this.m03=v*r+g*c+y*_+x*m,v=e.m04,g=e.m05,y=e.m06,x=e.m07,this.m04=v*t+g*o+y*l+x*f,this.m05=v*n+g*a+y*u+x*d,this.m06=v*i+g*s+y*h+x*p,this.m07=v*r+g*c+y*_+x*m,v=e.m08,g=e.m09,y=e.m10,x=e.m11,this.m08=v*t+g*o+y*l+x*f,this.m09=v*n+g*a+y*u+x*d,this.m10=v*i+g*s+y*h+x*p,this.m11=v*r+g*c+y*_+x*m,v=e.m12,g=e.m13,y=e.m14,x=e.m15,this.m12=v*t+g*o+y*l+x*f,this.m13=v*n+g*a+y*u+x*d,this.m14=v*i+g*s+y*h+x*p,this.m15=v*r+g*c+y*_+x*m,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},n.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},n.scale=function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(e,t){var n=t.x,i=t.y,r=t.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<on)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,_=this.m03,f=this.m04,d=this.m05,p=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=n*n*c+s,C=i*n*c+r*a,A=r*n*c-i*a,b=n*i*c-r*a,T=i*i*c+s,E=r*i*c+n*a,w=n*r*c+i*a,I=i*r*c-n*a,P=r*r*c+s;return this.m00=l*S+f*C+v*A,this.m01=u*S+d*C+g*A,this.m02=h*S+p*C+y*A,this.m03=_*S+m*C+x*A,this.m04=l*b+f*T+v*E,this.m05=u*b+d*T+g*E,this.m06=h*b+p*T+y*E,this.m07=_*b+m*T+x*E,this.m08=l*w+f*I+v*P,this.m09=u*w+d*I+g*P,this.m10=h*w+p*I+y*P,this.m11=_*w+m*I+x*P,this},n.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},n.getScale=function(e){var t=qn.m00=this.m00,n=qn.m01=this.m01,i=qn.m02=this.m02,r=qn.m03=this.m04,o=qn.m04=this.m05,a=qn.m05=this.m06,s=qn.m06=this.m08,c=qn.m07=this.m09,l=qn.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(r*r+o*o+a*a),e.z=Math.sqrt(s*s+c*c+l*l),Nn.determinant(qn)<0&&(e.x*=-1),e},n.getRotation=function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e},n.fromRTS=function(e,t,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,_=i*l,f=r*c,d=r*l,p=o*l,m=a*s,v=a*c,g=a*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(f+p))*y,this.m01=(h+g)*y,this.m02=(_-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+p))*x,this.m06=(d+m)*x,this.m07=0,this.m08=(_+v)*S,this.m09=(d-m)*S,this.m10=(1-(u+f))*S,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,_=i*a,f=i*s,d=r*o,p=r*a,m=r*s;return this.m00=1-u-f,this.m01=l+m,this.m02=h-p,this.m03=0,this.m04=l-m,this.m05=1-c-f,this.m06=_+d,this.m07=0,this.m08=h+p,this.m09=_-d,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t}(ct));jn.IDENTITY=Object.freeze(new jn);var Wn=new Pn,qn=new Nn;function Xn(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return new jn(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p)}Zt.fastDefine("cc.Mat4",jn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),l.Mat4=jn,l.mat4=Xn;var Yn=e("Vec2",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.x=t.x,i.y=t.y):(i.x=t||0,i.y=n||0),i}Z(t,e),t.clone=function(e){return new t(e.x,e.y)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e},t.set=function(e,t,n){return e.x=t,e.y=n,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.len=function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)},t.lengthSqr=function(e){var t=e.x,n=e.y;return t*t+n*n},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y;return Math.abs(n)<on?e.x=0:e.x=1/n,Math.abs(i)<on?e.y=0:e.y=1/i,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.cross=function(e,t,n){return e instanceof Pn?(e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e):e.x*t.y-e.y*t.x},t.lerp=function(e,t,n,i){var r=t.x,o=t.y;return e.x=r+i*(n.x-r),e.y=o+i*(n.y-o),e},t.random=function(e,t){t=t||1;var n=2*fn()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m03*r+n.m06,e.y=n.m01*i+n.m04*r+n.m07,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m04*r+n.m12,e.y=n.m01*i+n.m05*r+n.m13,e},t.str=function(e){return"Vec2("+e.x+", "+e.y+")"},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},t.equals=function(e,t,n){return void 0===n&&(n=on),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))},t.angle=function(e,n){t.normalize(Kn,e),t.normalize(Jn,n);var i=t.dot(Kn,Jn);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y)},n.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},n.equals=function(e,t){return void 0===t&&(t=on),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},n.equals2f=function(e,t,n){return void 0===n&&(n=on),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},n.strictEquals2f=function(e,t){return this.x===e&&this.y===t},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this},n.clampf=function(e,t){return this.x=cn(this.x,e.x,t.x),this.y=cn(this.y,e.y,t.y),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this},n.add2f=function(e,t){return this.x+=e,this.y+=t,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},n.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},n.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this},n.divide2f=function(e,t){return this.x/=e,this.y/=t,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(e){return this.x*e.x+this.y*e.y},n.cross=function(e){return this.x*e.y-this.y*e.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=cn(i,-1,1),Math.acos(i)},n.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},n.rotate=function(e){var t=this.x,n=this.y,i=Math.sin(e),r=Math.cos(e);return this.x=r*t-i*n,this.y=i*t+r*n,this},n.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},n.transformMat4=function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this},t}(ct));Yn.ZERO=Object.freeze(new Yn(0,0)),Yn.ONE=Object.freeze(new Yn(1,1)),Yn.NEG_ONE=Object.freeze(new Yn(-1,-1)),Yn.UNIT_X=Object.freeze(new Yn(1,0)),Yn.UNIT_Y=Object.freeze(new Yn(0,1));var Kn=new Yn,Jn=new Yn;function Qn(e,t){return new Yn(e,t)}Zt.fastDefine("cc.Vec2",Yn,{x:0,y:0}),l.Vec2=Yn,l.v2=Qn;var Zn=e("Vec4",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=r||0),o}Z(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+o*o)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return n*n+i*i+r*r+o*o},t.len=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return Math.sqrt(t*t+n*n+i*i+r*r)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return t*t+n*n+i*i+r*r},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w;return Math.abs(n)<on?e.x=0:e.x=1/n,Math.abs(i)<on?e.y=0:e.y=1/i,Math.abs(r)<on?e.z=0:e.z=1/r,Math.abs(o)<on?e.w=0:e.w=1/o,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=r*a,e.w=o*a),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.random=function(e,t){t=t||1;var n=2*fn()*Math.PI,i=2*fn()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e.w=0,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,e.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,e.w=t.w,e},t.transformQuat=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,_=l*o+a*r-s*i,f=-a*i-s*r-c*o;return e.x=u*l+f*-a+h*-c-_*-s,e.y=h*l+f*-s+_*-a-u*-c,e.z=_*l+f*-c+u*-s-h*-a,e.w=t.w,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=on),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this},n.equals=function(e,t){return void 0===t&&(t=on),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.equals4f=function(e,t,n,i,r){return void 0===r&&(r=on),Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.strictEquals4f=function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=r+t*(e.z-r),this.w=o+t*(e.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(e,t){return this.x=cn(this.x,e.x,t.x),this.y=cn(this.y,e.y,t.y),this.z=cn(this.z,e.z,t.z),this.w=cn(this.w,e.w,t.w),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},n.add4f=function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},n.subtract4f=function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},n.multiply4f=function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},n.divide4f=function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},n.lengthSqr=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=this.w,r=e*e+t*t+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*r,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*r,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*r,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*r,this},t}(ct));function $n(e,t,n,i){return new Zn(e,t,n,i)}Zn.ZERO=Object.freeze(new Zn(0,0,0,0)),Zn.ONE=Object.freeze(new Zn(1,1,1,1)),Zn.NEG_ONE=Object.freeze(new Zn(-1,-1,-1,-1)),Zt.fastDefine("cc.Vec4",Zn,{x:0,y:0,z:0,w:0}),l.Vec4=Zn,l.v4=$n,V(Yn,"Vec2",[{name:"sub",newName:"subtract",target:Yn,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Yn,targetName:"Vec2"},{name:"div",newName:"divide",target:Yn,targetName:"Vec2"},{name:"dist",newName:"distance",target:Yn,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Yn,targetName:"Vec2"},{name:"mag",newName:"len",target:Yn,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Yn,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Yn,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Yn,targetName:"Vec2"}]),V(Yn.prototype,"Vec2",[{name:"mag",newName:"length",target:Yn.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Yn.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Yn.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Yn.prototype,targetName:"Vec2"}]),V(Pn,"Vec3",[{name:"sub",newName:"subtract",target:Pn,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Pn,targetName:"Vec3"},{name:"div",newName:"divide",target:Pn,targetName:"Vec3"},{name:"dist",newName:"distance",target:Pn,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Pn,targetName:"Vec3"},{name:"mag",newName:"len",target:Pn,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Pn,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Pn,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Pn,targetName:"Vec3"}]),V(Pn.prototype,"Vec3",[{name:"mag",newName:"length",target:Pn.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Pn.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Pn.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Pn.prototype,targetName:"Vec3"}]),V(Zn,"Vec4",[{name:"sub",newName:"subtract",target:Zn,targetName:"Vec4"},{name:"mul",newName:"multiply",target:Zn,targetName:"Vec4"},{name:"div",newName:"divide",target:Zn,targetName:"Vec4"},{name:"dist",newName:"distance",target:Zn,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:Zn,targetName:"Vec4"},{name:"mag",newName:"len",target:Zn,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:Zn,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Zn,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Zn,targetName:"Vec4"}]),V(Zn.prototype,"Vec4",[{name:"mag",newName:"length",target:Zn.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:Zn.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:Zn.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:Zn.prototype,targetName:"Vec4"}]),V(Ln,"Quat",[{name:"mag",newName:"len",target:Ln,targetName:"Quat"},{name:"mul",newName:"multiply",target:Ln,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Ln,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Ln,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Ln,targetName:"Quat"}]),V(Ln.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Ln.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Ln.prototype,targetName:"Quat"}]),V(wn,"Color",[{name:"sub",newName:"subtract",target:wn,targetName:"Color"},{name:"mul",newName:"multiply",target:wn,targetName:"Color"},{name:"div",newName:"divide",target:wn,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:wn,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[1].toString(16);return l.Color.fromHEX(t[0],i)}}]),V(Nn,"Mat3",[{name:"sub",newName:"subtract",target:Nn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Nn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Nn,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Nn,targetName:"Mat3"}]),V(Nn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Nn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Nn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Nn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Nn.prototype,targetName:"Mat3"}]),V(jn,"Mat4",[{name:"sub",newName:"subtract",target:jn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:jn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:jn,targetName:"Mat4"}]),V(jn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:jn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:jn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:jn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:jn.prototype,targetName:"Mat4"}]);var ei=e("AffineTransform",function(){function e(e,t,n,i,r,o){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=r,this.ty=o}return e.identity=function(){return new e},e.clone=function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.concat=function(e,t,n){var i=t.a,r=t.b,o=t.c,a=t.d,s=t.tx,c=t.ty;e.a=i*n.a+r*n.c,e.b=i*n.b+r*n.d,e.c=o*n.a+a*n.c,e.d=o*n.b+a*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty},e.invert=function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)},e.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},e.transformVec2=function(e,t,n,i){var r,o;i?(r=t,o=n):(i=n,r=t.x,o=t.y),e.x=i.a*r+i.c*o+i.tx,e.y=i.b*r+i.d*o+i.ty},e.transformSize=function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height},e.transformRect=function(e,t,n){var i=t.x+t.width,r=t.y+t.height,o=n.a*t.x+n.c*t.y+n.tx,a=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*r+n.tx,u=n.b*t.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,_=n.b*i+n.d*r+n.ty,f=Math.min(o,s,l,h),d=Math.max(o,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);e.x=f,e.y=p,e.width=d-f,e.height=m-p},e.transformObb=function(e,t,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;t.x=a,t.y=s,n.x=c+a,n.y=l+s,e.x=u+a,e.y=h+s,i.x=c+u+a,i.y=l+h+s},e}());l.AffineTransform=ei;var ti=e("Size",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.width=t.width,i.height=t.height):(i.width=t||0,i.height=n||0),i}Z(t,e),t.lerp=function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e};var n=t.prototype;return n.clone=function(){return new t(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},J(t,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),t}(ct));function ni(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),new ti(e,t)}ti.ZERO=Object.freeze(new ti(0,0)),ti.ONE=Object.freeze(new ti(1,1)),Zt.fastDefine("cc.Size",ti,{width:0,height:0}),l.size=ni,l.Size=ti;var ii=e("Rect",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.y=t.y,o.width=t.width,o.height=t.height,o.x=t.x):(o.x=t||0,o.y=n||0,o.width=i||0,o.height=r||0),o}Z(t,e),t.fromMinMax=function(e,t,n){var i=Math.min(t.x,n.x),r=Math.min(t.y,n.y),o=Math.max(t.x,n.x),a=Math.max(t.y,n.y);return e.x=i,e.y=r,e.width=o-i,e.height=a-r,e},t.lerp=function(e,t,n,i){var r=t.x,o=t.y,a=t.width,s=t.height;return e.x=r+(n.x-r)*i,e.y=o+(n.y-o)*i,e.width=a+(n.width-a)*i,e.height=s+(n.height-s)*i,e},t.intersection=function(e,t,n){var i=t.x,r=t.y,o=t.x+t.width,a=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(r,c),e.width=Math.min(o,l)-e.x,e.height=Math.min(a,u)-e.y,e},t.union=function(e,t,n){var i=t.x,r=t.y,o=t.width,a=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(r,c),e.width=Math.max(i+o,s+l)-e.x,e.height=Math.max(r+a,c+u)-e.y,e};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.width,this.height)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=r+(e.width-r)*t,this.height=o+(e.height-o)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,r=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||r<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,n=this.y,i=t+this.width,r=n+this.height,o=e.m00*t+e.m04*n+e.m12,a=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*i+e.m04*r+e.m12,_=e.m01*i+e.m05*r+e.m13,f=Math.min(o,s,l,h),d=Math.max(o,s,l,h),p=Math.min(a,c,u,_),m=Math.max(a,c,u,_);return this.x=f,this.y=p,this.width=d-f,this.height=m-p,this},n.transformMat4ToPoints=function(e,t,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;t.x=e.m00*o+e.m04*a+e.m12,t.y=e.m01*o+e.m05*a+e.m13,r.x=e.m00*s+e.m04*a+e.m12,r.y=e.m01*s+e.m05*a+e.m13,n.x=e.m00*o+e.m04*c+e.m12,n.y=e.m01*o+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13},J(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Yn(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new Yn(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new ti(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),t}(ct));function ri(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),new ii(e,t,n,i)}Zt.fastDefine("cc.Rect",ii,{x:0,y:0,width:0,height:0}),l.Rect=ii,l.rect=ri;var oi=e("MATH_FLOAT_ARRAY",Float64Array),ai=e("MathBase",function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.createFloatArray=function(e){return new oi(e)},J(t,[{key:"array",get:function(){return this._array}}]),t}(ct)),si=Object.freeze({__proto__:null,bits:s,Vec2:Yn,v2:Qn,Vec3:Pn,v3:On,Vec4:Zn,v4:$n,Quat:Ln,quat:kn,Mat3:Nn,Mat4:jn,mat4:Xn,AffineTransform:ei,Size:ti,size:ni,Rect:ii,rect:ri,Color:wn,color:In,EPSILON:on,equals:an,approx:sn,clamp:cn,clamp01:ln,lerp:un,toRadian:hn,toDegree:_n,random:fn,randomRange:dn,randomRangeInt:pn,pseudoRandom:mn,pseudoRandomRange:vn,pseudoRandomRangeInt:gn,nextPow2:yn,repeat:xn,pingPong:Sn,inverseLerp:Cn,absMaxComponent:An,absMax:bn,enumerableProps:Tn,MATH_FLOAT_ARRAY:oi,MathBase:ai});e("math",si);var ci,li,ui,hi,_i,fi,di,pi,mi,vi,gi,yi,xi,Si,Ci,Ai,bi,Ti,Ei,wi,Ii,Pi,Ri,Di,Oi,Ni,Bi,Mi,Li,Fi,zi,Vi,Gi,Ui,ki,Hi,ji,Wi,qi,Xi,Yi,Ki,Ji=new(function(){function e(){this._finalizationRegistry=null,this._gcObjects=new WeakMap}var t=e.prototype;return t.registerGCObject=function(e){return e},t.init=function(){},t.finalizationRegistryCallback=function(e){var t=this._gcObjects.get(e);t&&(this._gcObjects.delete(e),t.destroy()),this._finalizationRegistry.unregister(e)},t.destroy=function(){},e}()),Qi=function(){function e(){return Ji.registerGCObject(this)}return e.prototype.destroy=function(){},e}(),Zi=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SWAPCHAIN=1]="SWAPCHAIN",e[e.BUFFER=2]="BUFFER",e[e.TEXTURE=3]="TEXTURE",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=10]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.QUERY_POOL=15]="QUERY_POOL",e[e.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=18]="BUFFER_BARRIER",e[e.COUNT=19]="COUNT"}(ci||(ci={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(li||(li={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.NVN=5]="NVN",e[e.WEBGL=6]="WEBGL",e[e.WEBGL2=7]="WEBGL2",e[e.WEBGPU=8]="WEBGPU"}(ui||(ui={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(hi||(hi={})),function(e){e[e.ELEMENT_INDEX_UINT=0]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=1]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=2]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=3]="BLEND_MINMAX",e[e.COMPUTE_SHADER=4]="COMPUTE_SHADER",e[e.INPUT_ATTACHMENT_BENEFIT=5]="INPUT_ATTACHMENT_BENEFIT",e[e.COUNT=6]="COUNT"}(_i||(_i={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.DEPTH=54]="DEPTH",e[e.DEPTH_STENCIL=55]="DEPTH_STENCIL",e[e.BC1=56]="BC1",e[e.BC1_ALPHA=57]="BC1_ALPHA",e[e.BC1_SRGB=58]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",e[e.BC2=60]="BC2",e[e.BC2_SRGB=61]="BC2_SRGB",e[e.BC3=62]="BC3",e[e.BC3_SRGB=63]="BC3_SRGB",e[e.BC4=64]="BC4",e[e.BC4_SNORM=65]="BC4_SNORM",e[e.BC5=66]="BC5",e[e.BC5_SNORM=67]="BC5_SNORM",e[e.BC6H_UF16=68]="BC6H_UF16",e[e.BC6H_SF16=69]="BC6H_SF16",e[e.BC7=70]="BC7",e[e.BC7_SRGB=71]="BC7_SRGB",e[e.ETC_RGB8=72]="ETC_RGB8",e[e.ETC2_RGB8=73]="ETC2_RGB8",e[e.ETC2_SRGB8=74]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=77]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",e[e.EAC_R11=79]="EAC_R11",e[e.EAC_R11SN=80]="EAC_R11SN",e[e.EAC_RG11=81]="EAC_RG11",e[e.EAC_RG11SN=82]="EAC_RG11SN",e[e.PVRTC_RGB2=83]="PVRTC_RGB2",e[e.PVRTC_RGBA2=84]="PVRTC_RGBA2",e[e.PVRTC_RGB4=85]="PVRTC_RGB4",e[e.PVRTC_RGBA4=86]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=87]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=88]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",e[e.COUNT=117]="COUNT"}(fi||(fi={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(di||(di={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(pi||(pi={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(mi||(mi={})),function(e){e[e.NONE=0]="NONE"}(vi||(vi={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(gi||(gi={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(yi||(yi={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(xi||(xi={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Si||(Si={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(Ci||(Ci={})),function(e){e[e.NONE=0]="NONE",e[e.RENDER_TARGET=1]="RENDER_TARGET",e[e.SAMPLED_TEXTURE=2]="SAMPLED_TEXTURE",e[e.LINEAR_FILTER=4]="LINEAR_FILTER",e[e.STORAGE_TEXTURE=8]="STORAGE_TEXTURE",e[e.VERTEX_ATTRIBUTE=16]="VERTEX_ATTRIBUTE"}(Ai||(Ai={})),function(e){e[e.ONE=0]="ONE",e[e.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",e[e.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",e[e.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(bi||(bi={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.RELAXED=2]="RELAXED",e[e.MAILBOX=3]="MAILBOX",e[e.HALF=4]="HALF"}(Ti||(Ti={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(Ei||(Ei={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(wi||(wi={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Ii||(Ii={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Pi||(Pi={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Ri||(Ri={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Di||(Di={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(Oi||(Oi={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Ni||(Ni={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(Bi||(Bi={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Mi||(Mi={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=4]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=8]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=16]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=32]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=64]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=128]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=256]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=512]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=1024]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=2048]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=4096]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=8192]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=16384]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=32768]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=65536]="TRANSFER_READ",e[e.HOST_READ=131072]="HOST_READ",e[e.PRESENT=262144]="PRESENT",e[e.VERTEX_SHADER_WRITE=524288]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=1048576]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=2097152]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=4194304]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=8388608]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=16777216]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=33554432]="HOST_PREINITIALIZED",e[e.HOST_WRITE=67108864]="HOST_WRITE"}(Li||(Li={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Fi||(Fi={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(zi||(zi={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Vi||(Vi={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(Gi||(Gi={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(Ui||(Ui={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(ki||(ki={})),function(e){e[e.NONE=0]="NONE",e[e.LINE_WIDTH=1]="LINE_WIDTH",e[e.DEPTH_BIAS=2]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Hi||(Hi={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(ji||(ji={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(Wi||(Wi={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(qi||(qi={})),function(e){e[e.OCCLUSION=0]="OCCLUSION",e[e.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",e[e.TIMESTAMP=2]="TIMESTAMP"}(Xi||(Xi={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(Yi||(Yi={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(Ki||(Ki={}));var $i,er=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),tr=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g,y,x,S){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=1),void 0===d&&(d=0),void 0===p&&(p=0),void 0===m&&(m=new er),void 0===v&&(v=new er),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=_,this.uboOffsetAlignment=f,this.maxComputeSharedMemorySize=d,this.maxComputeWorkGroupInvocations=p,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}return e.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},e}(),nr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),ir=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}(),rr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.width=e,this.height=t,this.depth=n}return e.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},e}(),or=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=n}return e.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),ar=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=n,this.layerCount=i}return e.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),sr=function(){function e(e,t,n,i,r){void 0===e&&(e=new or),void 0===t&&(t=new nr),void 0===n&&(n=new or),void 0===i&&(i=new nr),void 0===r&&(r=new rr),this.srcSubres=e,this.srcOffset=t,this.dstSubres=n,this.dstOffset=i,this.extent=r}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},e}(),cr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=new or),void 0===t&&(t=new nr),void 0===n&&(n=new rr),void 0===i&&(i=new or),void 0===r&&(r=new nr),void 0===o&&(o=new rr),this.srcSubres=e,this.srcOffset=t,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},e}(),lr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=new nr),void 0===i&&(i=new rr),void 0===r&&(r=new or),this.buffStride=e,this.buffTexHeight=t,this.texOffset=n,this.texExtent=i,this.texSubres=r}return e.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},e}(),ur=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=e,this.top=t,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return e.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},e}(),hr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e}(),_r=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=[0]),void 0===t&&(t=[0]),void 0===n&&(n=[0]),void 0===i&&(i=[0]),void 0===r&&(r=[0]),void 0===o&&(o=[0]),void 0===a&&(a=[0]),void 0===s&&(s=[0]),this.maxBlockCounts=e,this.maxSamplerTextureCounts=t,this.maxSamplerCounts=n,this.maxTextureCounts=i,this.maxBufferCounts=r,this.maxImageCounts=o,this.maxSubpassInputCounts=a,this.setIndices=s}return e.prototype.copy=function(e){return this.maxBlockCounts=e.maxBlockCounts.slice(),this.maxSamplerTextureCounts=e.maxSamplerTextureCounts.slice(),this.maxSamplerCounts=e.maxSamplerCounts.slice(),this.maxTextureCounts=e.maxTextureCounts.slice(),this.maxBufferCounts=e.maxBufferCounts.slice(),this.maxImageCounts=e.maxImageCounts.slice(),this.maxSubpassInputCounts=e.maxSubpassInputCounts.slice(),this.setIndices=e.setIndices.slice(),this},e}(),fr=function(){function e(e,t,n,i){void 0===e&&(e=null),void 0===t&&(t=Ti.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=e,this.vsyncMode=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this},e}(),dr=function(){function e(e){void 0===e&&(e=new _r),this.bindingMappingInfo=e}return e.prototype.copy=function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this},e}(),pr=function(){function e(e,t,n,i,r){void 0===e&&(e=mi.NONE),void 0===t&&(t=yi.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=vi.NONE),this.usage=e,this.memUsage=t,this.size=n,this.stride=i,this.flags=r}return e.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},e}(),mr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0),this.buffer=e,this.offset=t,this.range=n}return e.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},e}(),vr=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return e.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},e}(),gr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=e,this.groupCountY=t,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return e.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},e}(),yr=function(){function e(e){void 0===e&&(e=[]),this.drawInfos=e}return e.prototype.copy=function(e){return Zi(this.drawInfos,e.drawInfos,vr),this},e}(),xr=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=xi.TEX2D),void 0===t&&(t=Si.NONE),void 0===n&&(n=fi.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=Ci.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=bi.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=e,this.usage=t,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return e.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this},e}(),Sr=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=null),void 0===t&&(t=xi.TEX2D),void 0===n&&(n=fi.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=e,this.type=t,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return e.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},e}(),Cr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=Ei.LINEAR),void 0===t&&(t=Ei.LINEAR),void 0===n&&(n=Ei.NONE),void 0===i&&(i=wi.WRAP),void 0===r&&(r=wi.WRAP),void 0===o&&(o=wi.WRAP),void 0===a&&(a=0),void 0===s&&(s=Ii.ALWAYS),this.minFilter=e,this.magFilter=t,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return e.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this},e}(),Ar=function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=pi.UNKNOWN),void 0===n&&(n=0),this.name=e,this.type=t,this.count=n}return e.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),br=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.members=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,Zi(this.members,e.members,Ar),this.count=e.count,this},e}(),Tr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=pi.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Er=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),wr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=pi.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Ir=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=pi.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=gi.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Pr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=gi.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.count=i,this.memoryAccess=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Rr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Dr=function(){function e(e,t){void 0===e&&(e=Ni.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}return e.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},e}(),Or=function(){function e(e,t,n,i,r,o){void 0===e&&(e=""),void 0===t&&(t=fi.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=e,this.format=t,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return e.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},e}(),Nr=function(){function e(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e,this.stages=t,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return e.prototype.copy=function(e){return this.name=e.name,Zi(this.stages,e.stages,Dr),Zi(this.attributes,e.attributes,Or),Zi(this.blocks,e.blocks,br),Zi(this.buffers,e.buffers,Pr),Zi(this.samplerTextures,e.samplerTextures,Tr),Zi(this.samplers,e.samplers,Er),Zi(this.textures,e.textures,wr),Zi(this.images,e.images,Ir),Zi(this.subpassInputs,e.subpassInputs,Rr),this},e}(),Br=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=n,this.indirectBuffer=i}return e.prototype.copy=function(e){return Zi(this.attributes,e.attributes,Or),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},e}(),Mr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=fi.UNKNOWN),void 0===t&&(t=bi.ONE),void 0===n&&(n=Bi.CLEAR),void 0===i&&(i=Mi.STORE),void 0===r&&(r=null),void 0===o&&(o=!1),this.format=e,this.sampleCount=t,this.loadOp=n,this.storeOp=i,this.barrier=r,this.isGeneralLayout=o}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.barrier=e.barrier,this.isGeneralLayout=e.isGeneralLayout,this},e}(),Lr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=fi.UNKNOWN),void 0===t&&(t=bi.ONE),void 0===n&&(n=Bi.CLEAR),void 0===i&&(i=Mi.STORE),void 0===r&&(r=Bi.CLEAR),void 0===o&&(o=Mi.STORE),void 0===a&&(a=null),void 0===s&&(s=!1),this.format=e,this.sampleCount=t,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.barrier=a,this.isGeneralLayout=s}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.barrier=e.barrier,this.isGeneralLayout=e.isGeneralLayout,this},e}(),Fr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Fi.NONE),void 0===s&&(s=Fi.NONE),this.inputs=e,this.colors=t,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return e.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this},e}(),zr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=null),this.srcSubpass=e,this.dstSubpass=t,this.barrier=n}return e.prototype.copy=function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.barrier=e.barrier,this},e}(),Vr=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=new Lr),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=n,this.dependencies=i}return e.prototype.copy=function(e){return Zi(this.colorAttachments,e.colorAttachments,Mr),this.depthStencilAttachment.copy(e.depthStencilAttachment),Zi(this.subpasses,e.subpasses,Fr),Zi(this.dependencies,e.dependencies,zr),this},e}(),Gr=function(){function e(e,t){void 0===e&&(e=Li.NONE),void 0===t&&(t=Li.NONE),this.prevAccesses=e,this.nextAccesses=t}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses,this.nextAccesses=e.nextAccesses,this},e}(),Ur=function(){function e(e,t,n,i,r){void 0===e&&(e=Li.NONE),void 0===t&&(t=Li.NONE),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=e,this.nextAccesses=t,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses,this.nextAccesses=e.nextAccesses,this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},e}(),kr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=[]),void 0===n&&(n=null),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=n}return e.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this},e}(),Hr=function(){function e(e,t,n,i,r){void 0===e&&(e=-1),void 0===t&&(t=Wi.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Ni.NONE),void 0===r&&(r=[]),this.binding=e,this.descriptorType=t,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return e.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},e}(),jr=function(){function e(e){void 0===e&&(e=[]),this.bindings=e}return e.prototype.copy=function(e){return Zi(this.bindings,e.bindings,Hr),this},e}(),Wr=function(){function e(e){void 0===e&&(e=null),this.layout=e}return e.prototype.copy=function(e){return this.layout=e.layout,this},e}(),qr=function(){function e(e){void 0===e&&(e=[]),this.setLayouts=e}return e.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},e}(),Xr=function(){function e(e){void 0===e&&(e=[]),this.attributes=e}return e.prototype.copy=function(e){return Zi(this.attributes,e.attributes,Or),this},e}(),Yr=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=Yi.PRIMARY),this.queue=e,this.type=t}return e.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},e}(),Kr=function(){function e(e){void 0===e&&(e=qi.GRAPHICS),this.type=e}return e.prototype.copy=function(e){return this.type=e.type,this},e}(),Jr=function(){function e(e,t,n){void 0===e&&(e=Xi.OCCLUSION),void 0===t&&(t=32767),void 0===n&&(n=!0),this.type=e,this.maxQueryObjects=t,this.forceWait=n}return e.prototype.copy=function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this},e}(),Qr=function(e,t,n,i,r,o,a,s){void 0===e&&(e=""),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=di.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=e,this.size=t,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},Zr=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t}return e.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},e}(),$r=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.writeMask=e,this.compareMask=t,this.reference=n}return e.prototype.copy=function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this},e}(),eo=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=new ur),void 0===t&&(t=new ir),void 0===n&&(n=new hr),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new $r),void 0===u&&(u=new $r),this.viewport=e,this.scissor=t,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return e.prototype.copy=function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this},e}(),to=function(e){function t(n){var i;return(i=e.call(this)||this)._objectType=ci.UNKNOWN,i._objectID=0,i._typedID=0,i._objectType=n,i._objectID=t._idTable[ci.UNKNOWN]++,i._typedID=t._idTable[n]++,i}return Z(t,e),J(t,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),t}(Qi);to._idTable=Array(ci.COUNT).fill(65536),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}($i||($i={}));var no=Object.freeze([new Qr("UNKNOWN",0,0,di.NONE,!1,!1,!1,!1),new Qr("A8",1,1,di.UNORM,!0,!1,!1,!1),new Qr("L8",1,1,di.UNORM,!1,!1,!1,!1),new Qr("LA8",1,2,di.UNORM,!0,!1,!1,!1),new Qr("R8",1,1,di.UNORM,!1,!1,!1,!1),new Qr("R8SN",1,1,di.SNORM,!1,!1,!1,!1),new Qr("R8UI",1,1,di.UINT,!1,!1,!1,!1),new Qr("R8I",1,1,di.INT,!1,!1,!1,!1),new Qr("R16F",2,1,di.FLOAT,!1,!1,!1,!1),new Qr("R16UI",2,1,di.UINT,!1,!1,!1,!1),new Qr("R16I",2,1,di.INT,!1,!1,!1,!1),new Qr("R32F",4,1,di.FLOAT,!1,!1,!1,!1),new Qr("R32UI",4,1,di.UINT,!1,!1,!1,!1),new Qr("R32I",4,1,di.INT,!1,!1,!1,!1),new Qr("RG8",2,2,di.UNORM,!1,!1,!1,!1),new Qr("RG8SN",2,2,di.SNORM,!1,!1,!1,!1),new Qr("RG8UI",2,2,di.UINT,!1,!1,!1,!1),new Qr("RG8I",2,2,di.INT,!1,!1,!1,!1),new Qr("RG16F",4,2,di.FLOAT,!1,!1,!1,!1),new Qr("RG16UI",4,2,di.UINT,!1,!1,!1,!1),new Qr("RG16I",4,2,di.INT,!1,!1,!1,!1),new Qr("RG32F",8,2,di.FLOAT,!1,!1,!1,!1),new Qr("RG32UI",8,2,di.UINT,!1,!1,!1,!1),new Qr("RG32I",8,2,di.INT,!1,!1,!1,!1),new Qr("RGB8",3,3,di.UNORM,!1,!1,!1,!1),new Qr("SRGB8",3,3,di.UNORM,!1,!1,!1,!1),new Qr("RGB8SN",3,3,di.SNORM,!1,!1,!1,!1),new Qr("RGB8UI",3,3,di.UINT,!1,!1,!1,!1),new Qr("RGB8I",3,3,di.INT,!1,!1,!1,!1),new Qr("RGB16F",6,3,di.FLOAT,!1,!1,!1,!1),new Qr("RGB16UI",6,3,di.UINT,!1,!1,!1,!1),new Qr("RGB16I",6,3,di.INT,!1,!1,!1,!1),new Qr("RGB32F",12,3,di.FLOAT,!1,!1,!1,!1),new Qr("RGB32UI",12,3,di.UINT,!1,!1,!1,!1),new Qr("RGB32I",12,3,di.INT,!1,!1,!1,!1),new Qr("RGBA8",4,4,di.UNORM,!0,!1,!1,!1),new Qr("BGRA8",4,4,di.UNORM,!0,!1,!1,!1),new Qr("SRGB8_A8",4,4,di.UNORM,!0,!1,!1,!1),new Qr("RGBA8SN",4,4,di.SNORM,!0,!1,!1,!1),new Qr("RGBA8UI",4,4,di.UINT,!0,!1,!1,!1),new Qr("RGBA8I",4,4,di.INT,!0,!1,!1,!1),new Qr("RGBA16F",8,4,di.FLOAT,!0,!1,!1,!1),new Qr("RGBA16UI",8,4,di.UINT,!0,!1,!1,!1),new Qr("RGBA16I",8,4,di.INT,!0,!1,!1,!1),new Qr("RGBA32F",16,4,di.FLOAT,!0,!1,!1,!1),new Qr("RGBA32UI",16,4,di.UINT,!0,!1,!1,!1),new Qr("RGBA32I",16,4,di.INT,!0,!1,!1,!1),new Qr("R5G6B5",2,3,di.UNORM,!1,!1,!1,!1),new Qr("R11G11B10F",4,3,di.FLOAT,!1,!1,!1,!1),new Qr("RGB5A1",2,4,di.UNORM,!0,!1,!1,!1),new Qr("RGBA4",2,4,di.UNORM,!0,!1,!1,!1),new Qr("RGB10A2",2,4,di.UNORM,!0,!1,!1,!1),new Qr("RGB10A2UI",2,4,di.UINT,!0,!1,!1,!1),new Qr("RGB9E5",2,4,di.FLOAT,!0,!1,!1,!1),new Qr("DEPTH",4,1,di.FLOAT,!1,!0,!1,!1),new Qr("DEPTH_STENCIL",5,2,di.FLOAT,!1,!0,!0,!1),new Qr("BC1",1,3,di.UNORM,!1,!1,!1,!0),new Qr("BC1_ALPHA",1,4,di.UNORM,!0,!1,!1,!0),new Qr("BC1_SRGB",1,3,di.UNORM,!1,!1,!1,!0),new Qr("BC1_SRGB_ALPHA",1,4,di.UNORM,!0,!1,!1,!0),new Qr("BC2",1,4,di.UNORM,!0,!1,!1,!0),new Qr("BC2_SRGB",1,4,di.UNORM,!0,!1,!1,!0),new Qr("BC3",1,4,di.UNORM,!0,!1,!1,!0),new Qr("BC3_SRGB",1,4,di.UNORM,!0,!1,!1,!0),new Qr("BC4",1,1,di.UNORM,!1,!1,!1,!0),new Qr("BC4_SNORM",1,1,di.SNORM,!1,!1,!1,!0),new Qr("BC5",1,2,di.UNORM,!1,!1,!1,!0),new Qr("BC5_SNORM",1,2,di.SNORM,!1,!1,!1,!0),new Qr("BC6H_UF16",1,3,di.UFLOAT,!1,!1,!1,!0),new Qr("BC6H_SF16",1,3,di.FLOAT,!1,!1,!1,!0),new Qr("BC7",1,4,di.UNORM,!0,!1,!1,!0),new Qr("BC7_SRGB",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ETC_RGB8",1,3,di.UNORM,!1,!1,!1,!0),new Qr("ETC2_RGB8",1,3,di.UNORM,!1,!1,!1,!0),new Qr("ETC2_SRGB8",1,3,di.UNORM,!1,!1,!1,!0),new Qr("ETC2_RGB8_A1",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ETC2_SRGB8_A1",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ETC2_RGBA8",2,4,di.UNORM,!0,!1,!1,!0),new Qr("ETC2_SRGB8_A8",2,4,di.UNORM,!0,!1,!1,!0),new Qr("EAC_R11",1,1,di.UNORM,!1,!1,!1,!0),new Qr("EAC_R11SN",1,1,di.SNORM,!1,!1,!1,!0),new Qr("EAC_RG11",2,2,di.UNORM,!1,!1,!1,!0),new Qr("EAC_RG11SN",2,2,di.SNORM,!1,!1,!1,!0),new Qr("PVRTC_RGB2",2,3,di.UNORM,!1,!1,!1,!0),new Qr("PVRTC_RGBA2",2,4,di.UNORM,!0,!1,!1,!0),new Qr("PVRTC_RGB4",2,3,di.UNORM,!1,!1,!1,!0),new Qr("PVRTC_RGBA4",2,4,di.UNORM,!0,!1,!1,!0),new Qr("PVRTC2_2BPP",2,4,di.UNORM,!0,!1,!1,!0),new Qr("PVRTC2_4BPP",2,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_4x4",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_5x4",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_5x5",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_6x5",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_6x6",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_8x5",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_8x6",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_8x8",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_10x5",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_10x6",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_10x8",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_10x10",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_12x10",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_RGBA_12x12",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_4x4",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_5x4",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_5x5",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_6x5",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_6x6",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_8x5",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_8x6",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_8x8",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_10x5",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_10x6",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_10x8",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_10x10",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_12x10",1,4,di.UNORM,!0,!1,!1,!0),new Qr("ASTC_SRGBA_12x12",1,4,di.UNORM,!0,!1,!1,!0)]),io=Wi.UNIFORM_BUFFER|Wi.DYNAMIC_UNIFORM_BUFFER|Wi.STORAGE_BUFFER|Wi.DYNAMIC_STORAGE_BUFFER,ro=Wi.SAMPLER_TEXTURE|Wi.SAMPLER|Wi.TEXTURE|Wi.STORAGE_IMAGE|Wi.INPUT_ATTACHMENT,oo=Wi.DYNAMIC_STORAGE_BUFFER|Wi.DYNAMIC_UNIFORM_BUFFER;function ao(e){return e>0&&0==(e&e-1)}function so(e,t,n,i){if(!no[e].isCompressed)return t*n*i*no[e].size;switch(e){case fi.BC1:case fi.BC1_ALPHA:case fi.BC1_SRGB:case fi.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case fi.BC2:case fi.BC2_SRGB:case fi.BC3:case fi.BC3_SRGB:case fi.BC4:case fi.BC4_SNORM:case fi.BC6H_SF16:case fi.BC6H_UF16:case fi.BC7:case fi.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case fi.BC5:case fi.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case fi.ETC_RGB8:case fi.ETC2_RGB8:case fi.ETC2_SRGB8:case fi.ETC2_RGB8_A1:case fi.EAC_R11:case fi.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case fi.ETC2_RGBA8:case fi.ETC2_SRGB8_A1:case fi.EAC_RG11:case fi.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case fi.PVRTC_RGB2:case fi.PVRTC_RGBA2:case fi.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case fi.PVRTC_RGB4:case fi.PVRTC_RGBA4:case fi.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case fi.ASTC_RGBA_4X4:case fi.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case fi.ASTC_RGBA_5X4:case fi.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case fi.ASTC_RGBA_5X5:case fi.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case fi.ASTC_RGBA_6X5:case fi.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case fi.ASTC_RGBA_6X6:case fi.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case fi.ASTC_RGBA_8X5:case fi.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case fi.ASTC_RGBA_8X6:case fi.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case fi.ASTC_RGBA_8X8:case fi.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case fi.ASTC_RGBA_10X5:case fi.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case fi.ASTC_RGBA_10X6:case fi.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case fi.ASTC_RGBA_10X8:case fi.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case fi.ASTC_RGBA_10X10:case fi.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case fi.ASTC_RGBA_12X10:case fi.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case fi.ASTC_RGBA_12X12:case fi.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function co(e,t,n,i,r){for(var o=0,a=0;a<r;++a)o+=so(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return o}var lo=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function uo(e){return lo[e]||0}function ho(e){var t=e.size/e.count;switch(e.type){case di.UNORM:case di.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case di.SNORM:case di.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case di.FLOAT:return Float32Array}return Float32Array}var _o=Object.freeze({__proto__:null,get ObjectType(){return ci},get Status(){return li},get API(){return ui},get SurfaceTransform(){return hi},get Feature(){return _i},get Format(){return fi},get FormatType(){return di},get Type(){return pi},get BufferUsageBit(){return mi},get BufferFlagBit(){return vi},get MemoryAccessBit(){return gi},get MemoryUsageBit(){return yi},get TextureType(){return xi},get TextureUsageBit(){return Si},get TextureFlagBit(){return Ci},get FormatFeatureBit(){return Ai},get SampleCount(){return bi},get VsyncMode(){return Ti},get Filter(){return Ei},get Address(){return wi},get ComparisonFunc(){return Ii},get StencilOp(){return Pi},get BlendFactor(){return Ri},get BlendOp(){return Di},get ColorMask(){return Oi},get ShaderStageFlagBit(){return Ni},get LoadOp(){return Bi},get StoreOp(){return Mi},get AccessFlagBit(){return Li},get ResolveMode(){return Fi},get PipelineBindPoint(){return zi},get PrimitiveMode(){return Vi},get PolygonMode(){return Gi},get ShadeModel(){return Ui},get CullMode(){return ki},get DynamicStateFlagBit(){return Hi},get StencilFace(){return ji},get DescriptorType(){return Wi},get QueueType(){return qi},get QueryType(){return Xi},get CommandBufferType(){return Yi},get ClearFlagBit(){return Ki},Size:er,DeviceCaps:tr,Offset:nr,Rect:ir,Extent:rr,TextureSubresLayers:or,TextureSubresRange:ar,TextureCopy:sr,TextureBlit:cr,BufferTextureCopy:lr,Viewport:ur,Color:hr,BindingMappingInfo:_r,SwapchainInfo:fr,DeviceInfo:dr,BufferInfo:pr,BufferViewInfo:mr,DrawInfo:vr,DispatchInfo:gr,IndirectBuffer:yr,TextureInfo:xr,TextureViewInfo:Sr,SamplerInfo:Cr,Uniform:Ar,UniformBlock:br,UniformSamplerTexture:Tr,UniformSampler:Er,UniformTexture:wr,UniformStorageImage:Ir,UniformStorageBuffer:Pr,UniformInputAttachment:Rr,ShaderStage:Dr,Attribute:Or,ShaderInfo:Nr,InputAssemblerInfo:Br,ColorAttachment:Mr,DepthStencilAttachment:Lr,SubpassInfo:Fr,SubpassDependency:zr,RenderPassInfo:Vr,GeneralBarrierInfo:Gr,TextureBarrierInfo:Ur,FramebufferInfo:kr,DescriptorSetLayoutBinding:Hr,DescriptorSetLayoutInfo:jr,DescriptorSetInfo:Wr,PipelineLayoutInfo:qr,InputState:Xr,CommandBufferInfo:Yr,QueueInfo:Kr,QueryPoolInfo:Jr,FormatInfo:Qr,MemoryStatus:Zr,DynamicStencilStates:$r,DynamicStates:eo,GFXObject:to,get AttributeName(){return $i},FormatInfos:no,DESCRIPTOR_BUFFER_TYPE:io,DESCRIPTOR_SAMPLER_TYPE:ro,DESCRIPTOR_DYNAMIC_TYPE:oo,DRAW_INFO_SIZE:28,IsPowerOf2:ao,FormatSize:so,FormatSurfaceSize:co,GetTypeSize:uo,getTypedArrayConstructor:ho}),fo=function(e){function t(){var t;return(t=e.call(this,ci.BUFFER)||this)._usage=mi.NONE,t._memUsage=yi.NONE,t._size=0,t._stride=1,t._count=0,t._flags=vi.NONE,t._isBufferView=!1,t}return Z(t,e),J(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),t}(to),po=function(e){function t(){var t;return(t=e.call(this,ci.COMMAND_BUFFER)||this)._queue=null,t._type=Yi.PRIMARY,t._numDrawCalls=0,t._numInstances=0,t._numTris=0,t}return Z(t,e),J(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}(to),mo=function(){function e(){this._gfxAPI=ui.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(_i.COUNT),this._formatFeatures=new Array(fi.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new Zr,this._caps=new tr,this._bindingMappingInfo=new _r,this._samplers=new Map,this._generalBarrierss=new Map,this._textureBarriers=new Map}var t=e.prototype;return t.hasFeature=function(e){return this._features[e]},t.getFormatFeatures=function(e){return this._formatFeatures[e]},J(e,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),e}();mo.canvas=void 0;var vo=function(e){function t(){var t;return(t=e.call(this,ci.SWAPCHAIN)||this)._transform=hi.IDENTITY,t._colorTexture=null,t._depthStencilTexture=null,t}return Z(t,e),J(t,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),t}(to),go=function(e){function t(){var t;return(t=e.call(this,ci.FRAMEBUFFER)||this)._renderPass=null,t._colorTextures=[],t._depthStencilTexture=null,t}return Z(t,e),J(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}(to),yo=String.prototype.charCodeAt;function xo(e){return this[e]}function So(e,t){for(var n=e.length,i=t^n,r=0,o="string"==typeof e?yo:xo;n>=4;){var a=255&o.call(e,r)|(255&o.call(e,++r))<<8|(255&o.call(e,++r))<<16|(255&o.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(e,r+2))<<16;case 2:i^=(255&o.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var Co=function(e){function t(){var t;return(t=e.call(this,ci.INPUT_ASSEMBLER)||this)._attributes=[],t._attributesHash=0,t._vertexBuffers=[],t._indexBuffer=null,t._indirectBuffer=null,t._drawInfo=new vr,t}Z(t,e);var n=t.prototype;return n.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},n.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return So(e,666)},J(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo}}]),t}(to),Ao=function(e){function t(){var t;return(t=e.call(this,ci.DESCRIPTOR_SET)||this)._layout=null,t._buffers=[],t._textures=[],t._samplers=[],t._isDirty=!1,t}Z(t,e);var n=t.prototype;return n.bindBuffer=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&io){var o=this._layout.descriptorIndices[e];this._buffers[o+n]!==t&&(this._buffers[o+n]=t,this._isDirty=!0)}},n.bindSampler=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ro){var o=this._layout.descriptorIndices[e];this._samplers[o+n]!==t&&(this._samplers[o+n]=t,this._isDirty=!0)}},n.bindTexture=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&ro){var o=this._layout.descriptorIndices[e];this._textures[o+n]!==t&&(this._textures[o+n]=t,this._isDirty=!0)}},n.getBuffer=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._buffers[n+t]},n.getSampler=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._samplers[n+t]},n.getTexture=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._textures[n+t]},J(t,[{key:"layout",get:function(){return this._layout}}]),t}(to),bo=function(e){function t(){var t;return(t=e.call(this,ci.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],t._bindingIndices=[],t._descriptorIndices=[],t}return Z(t,e),J(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}(to),To=function(e){function t(){var t;return(t=e.call(this,ci.PIPELINE_LAYOUT)||this)._setLayouts=[],t}return Z(t,e),J(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}(to),Eo=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h){void 0===e&&(e=!1),void 0===t&&(t=Gi.FILL),void 0===n&&(n=Ui.GOURAND),void 0===i&&(i=ki.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=Gi.FILL,this.shadeModel=Ui.GOURAND,this.cullMode=ki.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},J(e,[{key:"native",get:function(){return this}}]),e}(),wo=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===n&&(n=Ii.LESS),void 0===i&&(i=!1),void 0===r&&(r=Ii.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=Pi.KEEP),void 0===c&&(c=Pi.KEEP),void 0===l&&(l=Pi.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===_&&(_=Ii.ALWAYS),void 0===f&&(f=65535),void 0===d&&(d=65535),void 0===p&&(p=Pi.KEEP),void 0===m&&(m=Pi.KEEP),void 0===v&&(v=Pi.KEEP),void 0===g&&(g=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=_,this.stencilReadMaskBack=f,this.stencilWriteMaskBack=d,this.stencilFailOpBack=p,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Ii.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Ii.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Pi.KEEP,this.stencilZFailOpFront=Pi.KEEP,this.stencilPassOpFront=Pi.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Ii.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Pi.KEEP,this.stencilZFailOpBack=Pi.KEEP,this.stencilPassOpBack=Pi.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},J(e,[{key:"native",get:function(){return this}}]),e}(),Io=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=!1),void 0===t&&(t=Ri.ONE),void 0===n&&(n=Ri.ZERO),void 0===i&&(i=Di.ADD),void 0===r&&(r=Ri.ONE),void 0===o&&(o=Ri.ZERO),void 0===a&&(a=Di.ADD),void 0===s&&(s=Oi.ALL),this.blend=e,this.blendSrc=t,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=Ri.ONE,this.blendDst=Ri.ZERO,this.blendEq=Di.ADD,this.blendSrcAlpha=Ri.ONE,this.blendDstAlpha=Ri.ZERO,this.blendAlphaEq=Di.ADD,this.blendColorMask=Oi.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},e}(),Po=function(){function e(e,t,n,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===n&&(n=new hr),void 0===i&&(i=[new Io]),this.isA2C=e,this.isIndepend=t,this.blendColor=n,this.targets=i}var t=e.prototype;return t.setTarget=function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new Io),Object.assign(n,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},J(e,[{key:"native",get:function(){return this}}]),e}(),Ro=function(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=new Xr),void 0===r&&(r=new Eo),void 0===o&&(o=new wo),void 0===a&&(a=new Po),void 0===s&&(s=Vi.TRIANGLE_LIST),void 0===c&&(c=Hi.NONE),void 0===l&&(l=zi.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},Do=function(e){function t(){var t;return(t=e.call(this,ci.PIPELINE_STATE)||this)._shader=null,t._pipelineLayout=null,t._primitive=Vi.TRIANGLE_LIST,t._is=null,t._rs=new Eo,t._dss=new wo,t._bs=new Po,t._dynamicStates=Hi.NONE,t._renderPass=null,t}return Z(t,e),J(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}(to),Oo=function(e){function t(){var t;return(t=e.call(this,ci.QUEUE)||this)._type=qi.GRAPHICS,t}return Z(t,e),J(t,[{key:"type",get:function(){return this._type}}]),t}(to),No=function(e){function t(){var t;return(t=e.call(this,ci.RENDER_PASS)||this)._colorInfos=[],t._depthStencilInfo=null,t._subpasses=[],t._hash=0,t}return Z(t,e),t.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=","+r.format+","+r.sampleCount}}if(n.colors.length){e+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];e+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,"+s.format+","+s.sampleCount}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return So(e,666)},J(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),t}(to),Bo=function(e){function t(t,n){var i;return(i=e.call(this,ci.SAMPLER)||this)._info=new Cr,i._hash=0,i._info.copy(t),i._hash=n,i}return Z(t,e),t.computeHash=function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,(t|=e.maxAnisotropy<<12)|e.cmpFunc<<16},t.unpackFromHash=function(e){var t=new Cr;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t},J(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(to),Mo=function(e){function t(){var t;return(t=e.call(this,ci.SHADER)||this)._name="",t._stages=[],t._attributes=[],t._blocks=[],t._samplers=[],t}return Z(t,e),J(t,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}(to),Lo=function(e){function t(){var t;return(t=e.call(this,ci.TEXTURE)||this)._info=new xr,t._viewInfo=new Sr,t._isPowerOf2=!1,t._isTextureView=!1,t._size=0,t}return Z(t,e),t.getLevelCount=function(e,t){return Math.floor(Math.log2(Math.max(e,t)))},J(t,[{key:"type",get:function(){return this._info.type}},{key:"usage",get:function(){return this._info.usage}},{key:"format",get:function(){return this._info.format}},{key:"width",get:function(){return this._info.width}},{key:"height",get:function(){return this._info.height}},{key:"depth",get:function(){return this._info.depth}},{key:"layerCount",get:function(){return this._info.layerCount}},{key:"levelCount",get:function(){return this._info.levelCount}},{key:"samples",get:function(){return this._info.samples}},{key:"flags",get:function(){return this._info.flags}},{key:"size",get:function(){return this._size}},{key:"info",get:function(){return this._info}},{key:"viewInfo",get:function(){return this._viewInfo}},{key:"isTextureView",get:function(){return this._isTextureView}}]),t}(to),Fo=function(e){function t(t,n){var i;return(i=e.call(this,ci.GLOBAL_BARRIER)||this)._info=new Gr,i._hash=0,i._info.copy(t),i._hash=n,i}return Z(t,e),t.computeHash=function(e){return So(e.prevAccesses+" "+e.nextAccesses,666)},J(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(to),zo=function(e){function t(t,n){var i;return(i=e.call(this,ci.TEXTURE_BARRIER)||this)._info=new Ur,i._hash=0,i._info.copy(t),i._hash=n,i}return Z(t,e),t.computeHash=function(e){var t=e.prevAccesses+" "+e.nextAccesses;return t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,So(t+=e.dstQueue?e.dstQueue.type:0,666)},J(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}(to),Vo={Device:mo,Swapchain:vo,Buffer:fo,Texture:Lo,Sampler:Bo,Shader:Mo,InputAssembler:Co,RenderPass:No,Framebuffer:go,DescriptorSet:Ao,DescriptorSetLayout:bo,PipelineLayout:To,PipelineState:Do,CommandBuffer:po,Queue:Oo,GeneralBarrier:Fo,TextureBarrier:zo,RasterizerState:Eo,BlendState:Po,BlendTarget:Io,DepthStencilState:wo,PipelineStateInfo:Ro};Object.assign(Vo,_o),l.gfx=Vo;var Go={GFXDevice:!0,GFXBuffer:!0,GFXTexture:!0,GFXSampler:!0,GFXShader:!0,GFXInputAssembler:!0,GFXRenderPass:!0,GFXFramebuffer:!0,GFXPipelineState:!0,GFXCommandBuffer:!0,GFXQueue:!0,GFXObjectType:!0,GFXObject:!1,GFXAttributeName:!0,GFXType:!0,GFXFormat:!0,GFXBufferUsageBit:!0,GFXMemoryUsageBit:!0,GFXBufferFlagBit:!0,GFXBufferAccessBit:"MemoryAccessBit",GFXPrimitiveMode:!0,GFXPolygonMode:!0,GFXShadeModel:!0,GFXCullMode:!0,GFXComparisonFunc:!0,GFXStencilOp:!0,GFXBlendOp:!0,GFXBlendFactor:!0,GFXColorMask:!0,GFXFilter:!0,GFXAddress:!0,GFXTextureType:!0,GFXTextureUsageBit:!0,GFXSampleCount:!0,GFXTextureFlagBit:!0,GFXShaderStageFlagBit:!0,GFXDescriptorType:!0,GFXCommandBufferType:!0,GFXLoadOp:!0,GFXStoreOp:!0,GFXPipelineBindPoint:!0,GFXDynamicStateFlagBit:!0,GFXStencilFace:!0,GFXQueueType:!0,GFXRect:!0,GFXViewport:!0,GFXColor:!0,GFXClearFlag:!0,GFXOffset:!0,GFXExtent:!0,GFXTextureSubres:"TextureSubresLayers",GFXTextureCopy:!0,GFXBufferTextureCopy:!0,GFXFormatType:!0,GFXFormatInfo:!0,GFXMemoryStatus:!0,GFXFormatInfos:!0,GFXFormatSize:!0,GFXFormatSurfaceSize:!0,GFXGetTypeSize:!0,getTypedArrayConstructor:!1};for(var Uo in Go){var ko=Go[Uo];!0===ko?ko=Uo.slice(3):!1===ko&&(ko=Uo),V(l,"cc",[{name:Uo,newName:ko,target:l.gfx,targetName:"cc.gfx"}])}G(l,"cc",[{name:"GFX_MAX_VERTEX_ATTRIBUTES"},{name:"GFX_MAX_TEXTURE_UNITS"},{name:"GFX_MAX_ATTACHMENTS"},{name:"GFX_MAX_BUFFER_BINDINGS"},{name:"GFXTextureLayout"}]),G(_i,"Feature",[{name:"COLOR_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R32F) & FormatFeatureBit.RENDER_TARGET;"},{name:"COLOR_HALF_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R16F) & FormatFeatureBit.RENDER_TARGET;"},{name:"TEXTURE_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = (device.getFormatFeatures(Format.R32F) & (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE)) === (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE);"},{name:"TEXTURE_HALF_FLOAT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = (device.getFormatFeatures(Format.R16F) & (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE)) === (FormatFeatureBit.RENDER_TARGET | FormatFeatureBit.SAMPLED_TEXTURE);"},{name:"TEXTURE_FLOAT_LINEAR",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R32F) & FormatFeatureBit.LINEAR_FILTER;"},{name:"TEXTURE_HALF_FLOAT_LINEAR",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R16F) & FormatFeatureBit.LINEAR_FILTER;"},{name:"FORMAT_R11G11B10F",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.R11G11B10F) !== FormatFeatureBit.NONE;"},{name:"FORMAT_SRGB",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.SRGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ETC1",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ETC_RGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ETC2",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ETC2_RGB8) !== FormatFeatureBit.NONE;"},{name:"FORMAT_DXT",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.BC1) !== FormatFeatureBit.NONE;"},{name:"FORMAT_PVRTC",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.PVRTC_RGB2) !== FormatFeatureBit.NONE;"},{name:"FORMAT_ASTC",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.ASTC_RGBA_4x4) !== FormatFeatureBit.NONE;"},{name:"FORMAT_RGB8",suggest:"Please use device.getFormatFeatures() instead, like: \nlet isSupported = device.getFormatFeatures(Format.RGB8) !== FormatFeatureBit.NONE;"}]),G(Mr.prototype,"ColorAttachment",[{name:"beginAccesses",suggest:"Please assign to ColorAttachment.barrier instead"},{name:"endAccesses",suggest:"Please assign to ColorAttachment.barrier instead"}]),G(Lr.prototype,"DepthStencilAttachment",[{name:"beginAccesses",suggest:"Please assign to DepthStencilAttachment.barrier instead"},{name:"endAccesses",suggest:"Please assign to DepthStencilAttachment.barrier instead"}]),V(mo.prototype,"Device",[{name:"getGlobalBarrier",newName:"getGeneralBarrier"}]),e("gfx",Object.freeze({__proto__:null,DescriptorSet:Ao,Buffer:fo,CommandBuffer:po,get ObjectType(){return ci},get Status(){return li},get API(){return ui},get SurfaceTransform(){return hi},get Feature(){return _i},get Format(){return fi},get FormatType(){return di},get Type(){return pi},get BufferUsageBit(){return mi},get BufferFlagBit(){return vi},get MemoryAccessBit(){return gi},get MemoryUsageBit(){return yi},get TextureType(){return xi},get TextureUsageBit(){return Si},get TextureFlagBit(){return Ci},get FormatFeatureBit(){return Ai},get SampleCount(){return bi},get VsyncMode(){return Ti},get Filter(){return Ei},get Address(){return wi},get ComparisonFunc(){return Ii},get StencilOp(){return Pi},get BlendFactor(){return Ri},get BlendOp(){return Di},get ColorMask(){return Oi},get ShaderStageFlagBit(){return Ni},get LoadOp(){return Bi},get StoreOp(){return Mi},get AccessFlagBit(){return Li},get ResolveMode(){return Fi},get PipelineBindPoint(){return zi},get PrimitiveMode(){return Vi},get PolygonMode(){return Gi},get ShadeModel(){return Ui},get CullMode(){return ki},get DynamicStateFlagBit(){return Hi},get StencilFace(){return ji},get DescriptorType(){return Wi},get QueueType(){return qi},get QueryType(){return Xi},get CommandBufferType(){return Yi},get ClearFlagBit(){return Ki},Size:er,DeviceCaps:tr,Offset:nr,Rect:ir,Extent:rr,TextureSubresLayers:or,TextureSubresRange:ar,TextureCopy:sr,TextureBlit:cr,BufferTextureCopy:lr,Viewport:ur,Color:hr,BindingMappingInfo:_r,SwapchainInfo:fr,DeviceInfo:dr,BufferInfo:pr,BufferViewInfo:mr,DrawInfo:vr,DispatchInfo:gr,IndirectBuffer:yr,TextureInfo:xr,TextureViewInfo:Sr,SamplerInfo:Cr,Uniform:Ar,UniformBlock:br,UniformSamplerTexture:Tr,UniformSampler:Er,UniformTexture:wr,UniformStorageImage:Ir,UniformStorageBuffer:Pr,UniformInputAttachment:Rr,ShaderStage:Dr,Attribute:Or,ShaderInfo:Nr,InputAssemblerInfo:Br,ColorAttachment:Mr,DepthStencilAttachment:Lr,SubpassInfo:Fr,SubpassDependency:zr,RenderPassInfo:Vr,GeneralBarrierInfo:Gr,TextureBarrierInfo:Ur,FramebufferInfo:kr,DescriptorSetLayoutBinding:Hr,DescriptorSetLayoutInfo:jr,DescriptorSetInfo:Wr,PipelineLayoutInfo:qr,InputState:Xr,CommandBufferInfo:Yr,QueueInfo:Kr,QueryPoolInfo:Jr,FormatInfo:Qr,MemoryStatus:Zr,DynamicStencilStates:$r,DynamicStates:eo,GFXObject:to,get AttributeName(){return $i},FormatInfos:no,DESCRIPTOR_BUFFER_TYPE:io,DESCRIPTOR_SAMPLER_TYPE:ro,DESCRIPTOR_DYNAMIC_TYPE:oo,DRAW_INFO_SIZE:28,IsPowerOf2:ao,FormatSize:so,FormatSurfaceSize:co,GetTypeSize:uo,getTypedArrayConstructor:ho,Device:mo,Swapchain:vo,Framebuffer:go,InputAssembler:Co,DescriptorSetLayout:bo,PipelineLayout:To,RasterizerState:Eo,DepthStencilState:wo,BlendTarget:Io,BlendState:Po,PipelineStateInfo:Ro,PipelineState:Do,Queue:Oo,RenderPass:No,Sampler:Bo,Shader:Mo,Texture:Lo,GeneralBarrier:Fo,TextureBarrier:zo}));var Ho=new Pn,jo=new Pn,Wo=new Pn,qo=new Pn,Xo=new Pn,Yo=new Pn,Ko=new Array(3),Jo=new Array(3);function Qo(e,t){return Pn.dot(t.n,e)-t.d}function Zo(e,t,n){return Pn.copy(e,t),Pn.subtract(Xo,n.center,n.halfExtents),Pn.add(Yo,n.center,n.halfExtents),e.x=e.x<Xo.x?Xo.x:e.x,e.y=e.y<Xo.y?Xo.y:e.y,e.z=e.z<Xo.z?Xo.z:e.z,e.x=e.x>Yo.x?Yo.x:e.x,e.y=e.y>Yo.y?Yo.y:e.y,e.z=e.z>Yo.z?Yo.z:e.z,e}function $o(e,t,n){Pn.set(Ho,n.orientation.m00,n.orientation.m01,n.orientation.m02),Pn.set(jo,n.orientation.m03,n.orientation.m04,n.orientation.m05),Pn.set(Wo,n.orientation.m06,n.orientation.m07,n.orientation.m08),Ko[0]=Ho,Ko[1]=jo,Ko[2]=Wo,Jo[0]=n.halfExtents.x,Jo[1]=n.halfExtents.y,Jo[2]=n.halfExtents.z,Pn.subtract(qo,t,n.center),Pn.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=Pn.dot(qo,Ko[i]);r>Jo[i]&&(r=Jo[i]),r<-Jo[i]&&(r=-Jo[i]),e.x+=r*Ko[i].x,e.y+=r*Ko[i].y,e.z+=r*Ko[i].z}return e}var ea=Object.freeze({__proto__:null,point_plane:Qo,pt_point_plane:function(e,t,n){var i=Qo(t,n);return Pn.subtract(e,t,Pn.multiplyScalar(e,n.n,i))},pt_point_aabb:Zo,pt_point_obb:$o,pt_point_line:function(e,t,n,i){Pn.subtract(Ho,n,i);var r=Ho,o=Pn.lengthSqr(r);if(0==o)Pn.copy(e,n);else{Pn.subtract(Ho,t,n);var a=Pn.dot(Ho,r)/o;a<0?Pn.copy(e,n):a>1?Pn.copy(e,i):Pn.scaleAndAdd(e,n,r,a)}}}),ta={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},na=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=ta.SHAPE_LINE,this.s=new Pn(e,t,n),this.e=new Pn(i,r,o)}return e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return Pn.copy(e.s,t.s),Pn.copy(e.e,t.e),e},e.fromPoints=function(e,t,n){return Pn.copy(e.s,t),Pn.copy(e.e,n),e},e.set=function(e,t,n,i,r,o,a){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=o,e.e.z=a,e},e.len=function(e){return Pn.distance(e.s,e.e)},e.prototype.length=function(){return Pn.distance(this.s,this.e)},J(e,[{key:"type",get:function(){return this._type}}]),e}(),ia=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=ta.SHAPE_RAY,this.o=new Pn(e,t,n),this.d=new Pn(i,r,o)}return e.create=function(t,n,i,r,o,a){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return Pn.copy(e.o,t.o),Pn.copy(e.d,t.d),e},e.fromPoints=function(e,t,n){return Pn.copy(e.o,t),Pn.normalize(e.d,Pn.subtract(e.d,n,t)),e},e.set=function(e,t,n,i,r,o,a){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=o,e.d.z=a,e},e.prototype.computeHit=function(e,t){Pn.normalize(e,this.d),Pn.scaleAndAdd(e,this.o,e,t)},J(e,[{key:"type",get:function(){return this._type}}]),e}(),ra=new Pn,oa=new Pn,aa=new Pn,sa=new Pn;function ca(e){return Math.max(Math.max(e.x,e.y),e.z)}var la,ua=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new Pn(0,0,0),this._radius=0,this._type=void 0,this._type=ta.SHAPE_SPHERE,this._center=new Pn(e,t,n),this._radius=i}e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return Pn.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,n){return Pn.multiplyScalar(e.center,Pn.add(ra,t,n),.5),e.radius=.5*Pn.subtract(ra,n,t).length(),e},e.set=function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e};var t=e.prototype;return t.destroy=function(){},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){Pn.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Pn.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,n,i,r){Pn.transformMat4(r.center,this.center,e),r.radius=this.radius*ca(i)},t.translateAndRotate=function(e,t,n){Pn.transformMat4(n.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*ca(e)},t.mergePoint=function(e){this.radius<0&&(this.center.set(e),this.radius=0),Pn.subtract(oa,e,this.center);var t=oa.length();if(t>this.radius){var n=.5*(t-this.radius);this.radius+=n,Pn.multiplyScalar(oa,oa,n/t),Pn.add(this.center,this.center,oa)}},t.mergePoints=function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var n=0;n<t;n++)this.mergePoint(e[n])}},t.mergeAABB=function(e){e.getBoundary(aa,sa),this.mergePoint(aa),this.mergePoint(sa)},J(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}}]),e}(),ha=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=ta.SHAPE_TRIANGLE,this.a=new Pn(e,t,n),this.b=new Pn(i,r,o),this.c=new Pn(a,s,c)}return e.create=function(t,n,i,r,o,a,s,c,l){return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new e(t,n,i,r,o,a,s,c,l)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return Pn.copy(e.a,t.a),Pn.copy(e.b,t.b),Pn.copy(e.c,t.c),e},e.fromPoints=function(e,t,n,i){return Pn.copy(e.a,t),Pn.copy(e.b,n),Pn.copy(e.c,i),e},e.set=function(e,t,n,i,r,o,a,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=o,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e},J(e,[{key:"type",get:function(){return this._type}}]),e}();!function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(la||(la={}));var _a,fa,da,pa,ma,va,ga,ya,xa=(_a=new Pn(0,0,0),function(e,t){var n=Pn.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;Pn.multiplyScalar(_a,t.n,t.d);var i=Pn.dot(Pn.subtract(_a,_a,e.o),t.n)/n;return i<0?0:i}),Sa=(fa=new Pn(0,0,0),da=new Pn(0,0,0),pa=new Pn(0,0,0),ma=new Pn(0,0,0),va=new Pn(0,0,0),function(e,t,n){Pn.subtract(fa,t.b,t.a),Pn.subtract(da,t.c,t.a),Pn.cross(pa,e.d,da);var i=Pn.dot(fa,pa);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;Pn.subtract(ma,e.o,t.a);var o=Pn.dot(ma,pa)*r;if(o<0||o>1)return 0;Pn.cross(va,ma,fa);var a=Pn.dot(e.d,va)*r;if(a<0||o+a>1)return 0;var s=Pn.dot(da,va)*r;return s<0?0:s}),Ca=function(){var e=new Pn(0,0,0);return function(t,n){var i=n.radius,r=n.center,o=t.o,a=t.d,s=i*i;Pn.subtract(e,r,o);var c=e.lengthSqr(),l=Pn.dot(e,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),_=c<s?l+h:l-h;return _<0?0:_}}(),Aa=(ga=new Pn,ya=new Pn,function(e,t){return Pn.subtract(ga,t.center,t.halfExtents),Pn.add(ya,t.center,t.halfExtents),ba(e,ga,ya)});function ba(e,t,n){var i=e.o,r=e.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(t.x-i.x)*o,l=(n.x-i.x)*o,u=(t.y-i.y)*a,h=(n.y-i.y)*a,_=(t.z-i.z)*s,f=(n.z-i.z)*s,d=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(_,f)),p=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(_,f));return p<0||d>p?0:d>0?d:p}var Ta,Ea,wa,Ia,Pa=function(){var e=new Pn,t=new Pn,n=new Pn,i=new Pn,r=new Pn,o=new Pn,a=new Pn,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,_){s[0]=_.halfExtents.x,s[1]=_.halfExtents.y,s[2]=_.halfExtents.z,e=_.center,t=h.o,n=h.d,Pn.set(i,_.orientation.m00,_.orientation.m01,_.orientation.m02),Pn.set(r,_.orientation.m03,_.orientation.m04,_.orientation.m05),Pn.set(o,_.orientation.m06,_.orientation.m07,_.orientation.m08),Pn.subtract(a,e,t),c[0]=Pn.dot(i,n),c[1]=Pn.dot(r,n),c[2]=Pn.dot(o,n),l[0]=Pn.dot(i,a),l[1]=Pn.dot(r,a),l[2]=Pn.dot(o,a);for(var f=0;f<3;++f){if(0===c[f]){if(-l[f]-s[f]>0||-l[f]+s[f]<0)return 0;c[f]=1e-7}u[2*f+0]=(l[f]+s[f])/c[f],u[2*f+1]=(l[f]-s[f])/c[f]}var d=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),p=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return p<0||d>p?0:d>0?d:p}}(),Ra=function(){var e=new Pn,t=new Pn,n=new Pn,i=new Pn,r=new Pn,o=new Pn,a=new Pn,s=new ua;return function(c,l){var u=l.radius*l.radius,h=Pn.normalize(e,c.d),_=l.ellipseCenter0,f=l.ellipseCenter1,d=Pn.subtract(t,f,_);if(d.equals(Pn.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),ds.raySphere(c,s);var p=c.o,m=Pn.subtract(n,p,_),v=Pn.cross(i,h,d),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=Pn.subtract(r,f,p);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),ds.raySphere(c,s)}var x=Pn.cross(r,m,d),S=d.lengthSqr(),C=2*Pn.dot(v,x),A=C*C-4*g*(x.lengthSqr()-u*S);if(A<0)return 0;var b=(-C-Math.sqrt(A))/(2*g);if(b<0){s.radius=l.radius;var T=Pn.subtract(o,f,p);return m.lengthSqr()<T.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),ds.raySphere(c,s)}var E=Pn.scaleAndAdd(o,c.o,h,b),w=Pn.subtract(a,E,_),I=Pn.dot(w,d)/S;return I>=0&&I<=1?b:I<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),ds.raySphere(c,s)):I>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),ds.raySphere(c,s)):0}}(),Da=(Ta=ha.create(),Ea={distance:1/0,doubleSided:!1,mode:la.ANY},wa=0,Ia=function(e,t,n,i,r,o){e===la.CLOSEST?(wa>t||0===wa)&&(wa=t,o&&(0===o.length?o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=t,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(wa=t,o&&o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(e,t,n){if(wa=0,0===t.geometricInfo.positions.length)return wa;var i=void 0===n?Ea:n;if(ba(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,o=t.geometricInfo;!function(e,t,n,i,r){if(n===Vi.TRIANGLE_LIST)for(var o=t.length,a=0;a<o;a+=3){var s=3*t[a],c=3*t[a+1],l=3*t[a+2];Pn.set(Ta.a,e[s],e[s+1],e[s+2]),Pn.set(Ta.b,e[c],e[c+1],e[c+2]),Pn.set(Ta.c,e[l],e[l+1],e[l+2]);var u=ds.rayTriangle(i,Ta,r.doubleSided);if(!(0===u||u>r.distance)&&(Ia(r.mode,u,s,c,l,r.result),r.mode===la.ANY))return u}else if(n===Vi.TRIANGLE_STRIP)for(var h=t.length-2,_=0,f=0;f<h;f+=1){var d=3*t[f-_],p=3*t[f+_+1],m=3*t[f+2];Pn.set(Ta.a,e[d],e[d+1],e[d+2]),Pn.set(Ta.b,e[p],e[p+1],e[p+2]),Pn.set(Ta.c,e[m],e[m+1],e[m+2]),_=~_;var v=ds.rayTriangle(i,Ta,r.doubleSided);if(!(0===v||v>r.distance)&&(Ia(r.mode,v,d,p,m,r.result),r.mode===la.ANY))return v}else if(n===Vi.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];Pn.set(Ta.a,e[y],e[y+1],e[y+2]);for(var x=1;x<g;x+=1){var S=3*t[x],C=3*t[x+1];Pn.set(Ta.b,e[S],e[S+1],e[S+2]),Pn.set(Ta.c,e[C],e[C+1],e[C+2]);var A=ds.rayTriangle(i,Ta,r.doubleSided);if(!(0===A||A>r.distance)&&(Ia(r.mode,A,y,S,C,r.result),r.mode===la.ANY))return A}}}(o.positions,o.indices,r,e,i)}return wa}),Oa=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:la.ANY};return function(n,i,r){e=0;var o=void 0===r?t:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!ba(n,s,c))return e;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=Da(n,u,o);if(h)if(o.mode===la.CLOSEST)(0===e||e>h)&&(e=h,o.subIndices&&(o.subIndices[0]=l));else if(e=h,o.subIndices&&o.subIndices.push(l),o.mode===la.ANY)return h}return e&&o.mode===la.CLOSEST&&(o.result&&(o.result[0].distance=e,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),e}}(),Na=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:la.ANY},n=new ia,i=new jn;return function(r,o,a){e=0;var s=void 0===a?t:a,c=o.worldBounds;if(c&&!Aa(r,c))return e;ia.copy(n,r),o.node&&(jn.invert(i,o.node.getWorldMatrix(i)),Pn.transformMat4(n.o,r.o,i),Pn.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,_=Da(n,h,s);if(_)if(s.mode===la.CLOSEST)(0===e||e>_)&&(e=_,s.subIndices&&(s.subIndices[0]=u));else if(e=_,s.subIndices&&s.subIndices.push(u),s.mode===la.ANY)return _}return e&&s.mode===la.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),Ba=function(){var e=new Pn(0,0,0);return function(t,n){Pn.subtract(e,t.e,t.s);var i=(n.d-Pn.dot(t.s,n.n))/Pn.dot(e,n.n);return i<0||i>1?0:i}}(),Ma=function(){var e=new Pn(0,0,0),t=new Pn(0,0,0),n=new Pn(0,0,0),i=new Pn(0,0,0),r=new Pn(0,0,0),o=new Pn(0,0,0);return function(a,s,c){Pn.subtract(e,s.b,s.a),Pn.subtract(t,s.c,s.a),Pn.subtract(n,a.s,a.e),Pn.cross(r,e,t);var l=Pn.dot(n,r);if(l<=0)return 0;Pn.subtract(i,a.s,s.a);var u=Pn.dot(i,r);if(u<0||u>l)return 0;Pn.cross(o,n,i);var h=Pn.dot(t,o);if(h<0||h>l)return 0;var _=-Pn.dot(e,o);if(_<0||h+_>l)return 0;if(c){var f=1/l,d=1-(h*=f)-(_*=f);Pn.set(c,s.a.x*d+s.b.x*h+s.c.x*_,s.a.y*d+s.b.y*h+s.c.y*_,s.a.z*d+s.b.z*h+s.c.z*_)}return 1}}(),La=new ia;function Fa(e,t){La.o.set(e.s),Pn.subtract(La.d,e.e,e.s),La.d.normalize();var n=Aa(La,t);return n<=e.length()?n:0}function za(e,t){La.o.set(e.s),Pn.subtract(La.d,e.e,e.s),La.d.normalize();var n=Pa(La,t);return n<=e.length()?n:0}function Va(e,t){La.o.set(e.s),Pn.subtract(La.d,e.e,e.s),La.d.normalize();var n=Ca(La,t);return n<=e.length()?n:0}var Ga,Ua,ka,Ha,ja=(Ga=new Pn,Ua=new Pn,ka=new Pn,Ha=new Pn,function(e,t){return Pn.subtract(Ga,e.center,e.halfExtents),Pn.add(Ua,e.center,e.halfExtents),Pn.subtract(ka,t.center,t.halfExtents),Pn.add(Ha,t.center,t.halfExtents),Ga.x<=Ha.x&&Ua.x>=ka.x&&Ga.y<=Ha.y&&Ua.y>=ka.y&&Ga.z<=Ha.z&&Ua.z>=ka.z});function Wa(e,t,n,i,r,o){Pn.set(o[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),Pn.set(o[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),Pn.set(o[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),Pn.set(o[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),Pn.set(o[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),Pn.set(o[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),Pn.set(o[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),Pn.set(o[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function qa(e,t){for(var n=Pn.dot(t,e[0]),i=n,r=1;r<8;++r){var o=Pn.dot(t,e[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var Xa,Ya,Ka,Ja=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new Pn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Pn(0,0,0),i[r]=new Pn(0,0,0);var o=new Pn,a=new Pn;return function(t,r){Pn.set(e[0],1,0,0),Pn.set(e[1],0,1,0),Pn.set(e[2],0,0,1),Pn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Pn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Pn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)Pn.cross(e[6+3*s],e[s],e[3]),Pn.cross(e[7+3*s],e[s],e[4]),Pn.cross(e[7+3*s],e[s],e[5]);Pn.subtract(o,t.center,t.halfExtents),Pn.add(a,t.center,t.halfExtents),function(e,t,n){Pn.set(n[0],e.x,t.y,t.z),Pn.set(n[1],e.x,t.y,e.z),Pn.set(n[2],e.x,e.y,t.z),Pn.set(n[3],e.x,e.y,e.z),Pn.set(n[4],t.x,t.y,t.z),Pn.set(n[5],t.x,t.y,e.z),Pn.set(n[6],t.x,e.y,t.z),Pn.set(n[7],t.x,e.y,e.z)}(o,a,n),Wa(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=qa(n,e[c]),u=qa(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Qa=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=Pn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},Za=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Qa(e,t.planes[n]))return 0;return 1},$a=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new Pn(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Qa(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)Pn.subtract(e[c],r.vertices[c],i.center);t=0,n=0;for(var l=0;l<r.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var h=0;h<r.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),es=(Xa=new Pn(0,0,0),Ya=new Nn,function(e,t){return Pn.subtract(Xa,t,e.center),Pn.transformMat3(Xa,Xa,Nn.transpose(Ya,e.orientation)),n=Xa,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),ts=(Ka=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*Ka(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Ka(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Ka(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=Pn.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),ns=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===ts(e,t.planes[n]))return 0;return 1},is=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new Pn(0,0,0);var o=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=ts(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)Pn.subtract(e[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(t=o(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(t=o(e[_],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(t=o(e[f],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),rs=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new Pn(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new Pn(0,0,0),i[r]=new Pn(0,0,0);return function(t,r){Pn.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),Pn.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),Pn.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),Pn.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),Pn.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),Pn.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)Pn.cross(e[6+3*o],e[o],e[3]),Pn.cross(e[7+3*o],e[o],e[4]),Pn.cross(e[8+3*o],e[o],e[5]);Wa(t.center,t.halfExtents,e[0],e[1],e[2],n),Wa(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var a=0;a<15;++a){var s=qa(n,e[a]),c=qa(i,e[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),os=function(){for(var e=new ua,t=new Pn,n=new Pn,i=new Pn,r=new Array(8),o=0;o<8;o++)r[o]=new Pn;for(var a=new Array(8),s=0;s<8;s++)a[s]=new Pn;return function(o,s){if(0===Pn.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),ds.sphereOBB(e,o);t.x=o.orientation.m00,t.y=o.orientation.m01,t.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,Wa(o.center,o.halfExtents,t,n,i,r);var c=a,l=Pn.copy(c[0],t),u=Pn.copy(c[1],n),h=Pn.copy(c[2],i);Pn.subtract(c[3],s.center,o.center).normalize();var _=Pn.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);_.normalize(),Pn.cross(c[5],l,_),Pn.cross(c[6],u,_),Pn.cross(c[7],h,_);for(var f=0;f<8;++f){var d=qa(r,c[f]),p=Pn.dot(c[f],s.ellipseCenter0),m=Pn.dot(c[f],s.ellipseCenter1),v=Math.max(p,m),g=Math.min(p,m)-s.radius,y=v+s.radius;if(g>d[1]||d[0]>y)return 0}return 1}}(),as=function(e,t){var n=Pn.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},ss=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===as(e,t.planes[n]))return 0;return 1},cs=function(){var e=new Pn(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=Pn.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){Pn.add(e,s,Pn.multiplyScalar(e,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var _=i.planes[h];if(Pn.dot(_.n,e)<_.d)return 0}}}return 1}}(),ls=function(e,t){var n=e.radius+t.radius;return Pn.squaredDistance(e.center,t.center)<n*n},us=function(){var e=new Pn;return function(t,n){return Zo(e,t.center,n),Pn.squaredDistance(t.center,e)<t.radius*t.radius}}(),hs=function(){var e=new Pn;return function(t,n){return $o(e,t.center,n),Pn.squaredDistance(t.center,e)<t.radius*t.radius}}(),_s=function(){var e=new Pn,t=new Pn;return function(n,i){var r=n.radius+i.radius,o=r*r,a=Pn.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return Pn.squaredDistance(n.center,i.center)<o;Pn.subtract(e,n.center,i.ellipseCenter0),Pn.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=Pn.dot(e,t)/a;return s<0?Pn.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?Pn.squaredDistance(n.center,i.ellipseCenter1)<o:(Pn.scaleAndAdd(e,i.ellipseCenter0,t,s),Pn.squaredDistance(n.center,e)<o)}}(),fs=function(){var e=new Pn,t=new Pn,n=new Pn,i=new Pn,r=new Pn,o=new Pn;return function(a,s){var c,l,u=Pn.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=Pn.subtract(t,s.ellipseCenter1,s.ellipseCenter0),_=Pn.subtract(n,a.ellipseCenter0,s.ellipseCenter0),f=Pn.dot(u,u),d=Pn.dot(u,h),p=Pn.dot(h,h),m=Pn.dot(u,_),v=Pn.dot(h,_),g=f*p-d*d,y=g,x=g;g<on?(c=0,y=1,l=v,x=p):(l=f*v-d*m,(c=d*v-p*m)<0?(c=0,l=v,x=p):c>y&&(c=y,l=v+d,x=p)),l<0?(l=0,-m<0?c=0:-m>f?c=y:(c=-m,y=f)):l>x&&(l=x,-m+d<0?c=0:-m+d>f?c=y:(c=-m+d,y=f));var S=Math.abs(c)<on?0:c/y,C=Math.abs(l)<on?0:l/x,A=i;A.set(_),A.add(Pn.multiplyScalar(r,u,S)),A.subtract(Pn.multiplyScalar(o,h,C));var b=a.radius+s.radius;return A.lengthSqr()<b*b}}(),ds={raySphere:Ca,rayAABB:Aa,rayOBB:Pa,rayPlane:xa,rayTriangle:Sa,rayCapsule:Ra,raySubMesh:Da,rayMesh:Oa,rayModel:Na,lineSphere:Va,lineAABB:Fa,lineOBB:za,linePlane:Ba,lineTriangle:Ma,sphereWithSphere:ls,sphereAABB:us,sphereOBB:hs,spherePlane:as,sphereFrustum:ss,sphereFrustumAccurate:cs,sphereCapsule:_s,aabbWithAABB:ja,aabbWithOBB:Ja,aabbPlane:Qa,aabbFrustum:Za,aabbFrustumAccurate:$a,obbWithOBB:rs,obbPlane:ts,obbFrustum:ns,obbFrustumAccurate:is,obbPoint:es,obbCapsule:os,capsuleWithCapsule:fs,resolve:function(e,t,n){void 0===n&&(n=null);var i=e._type,r=t._type,o=this[i|r];return i<r?o(e,t,n):o(t,e,n)}};ds[ta.SHAPE_RAY|ta.SHAPE_SPHERE]=Ca,ds[ta.SHAPE_RAY|ta.SHAPE_AABB]=Aa,ds[ta.SHAPE_RAY|ta.SHAPE_OBB]=Pa,ds[ta.SHAPE_RAY|ta.SHAPE_PLANE]=xa,ds[ta.SHAPE_RAY|ta.SHAPE_TRIANGLE]=Sa,ds[ta.SHAPE_RAY|ta.SHAPE_CAPSULE]=Ra,ds[ta.SHAPE_LINE|ta.SHAPE_SPHERE]=Va,ds[ta.SHAPE_LINE|ta.SHAPE_AABB]=Fa,ds[ta.SHAPE_LINE|ta.SHAPE_OBB]=za,ds[ta.SHAPE_LINE|ta.SHAPE_PLANE]=Ba,ds[ta.SHAPE_LINE|ta.SHAPE_TRIANGLE]=Ma,ds[ta.SHAPE_SPHERE]=ls,ds[ta.SHAPE_SPHERE|ta.SHAPE_AABB]=us,ds[ta.SHAPE_SPHERE|ta.SHAPE_OBB]=hs,ds[ta.SHAPE_SPHERE|ta.SHAPE_PLANE]=as,ds[ta.SHAPE_SPHERE|ta.SHAPE_FRUSTUM]=ss,ds[ta.SHAPE_SPHERE|ta.SHAPE_FRUSTUM_ACCURATE]=cs,ds[ta.SHAPE_SPHERE|ta.SHAPE_CAPSULE]=_s,ds[ta.SHAPE_AABB]=ja,ds[ta.SHAPE_AABB|ta.SHAPE_OBB]=Ja,ds[ta.SHAPE_AABB|ta.SHAPE_PLANE]=Qa,ds[ta.SHAPE_AABB|ta.SHAPE_FRUSTUM]=Za,ds[ta.SHAPE_AABB|ta.SHAPE_FRUSTUM_ACCURATE]=$a,ds[ta.SHAPE_OBB]=rs,ds[ta.SHAPE_OBB|ta.SHAPE_PLANE]=ts,ds[ta.SHAPE_OBB|ta.SHAPE_FRUSTUM]=ns,ds[ta.SHAPE_OBB|ta.SHAPE_FRUSTUM_ACCURATE]=is,ds[ta.SHAPE_OBB|ta.SHAPE_CAPSULE]=os,ds[ta.SHAPE_CAPSULE]=fs,V(na.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),G(ds,"intersect",[{name:"line_quad"}]);var ps,ms,vs,gs,ys,xs,Ss,Cs=new Pn(0,0,0),As=new Pn(0,0,0),bs=l.mat4(),Ts=l.v4(),Es=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=ta.SHAPE_PLANE,this.n=new Pn(e,t,n),this.d=i}return e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return Pn.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,n,i){return Pn.subtract(Cs,n,t),Pn.subtract(As,i,t),Pn.normalize(e.n,Pn.cross(e.n,Cs,As)),e.d=Pn.dot(e.n,t),e},e.set=function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e},e.fromNormalAndPoint=function(e,t,n){return Pn.copy(e.n,t),e.d=Pn.dot(t,n),e},e.normalize=function(e,t){var n=t.n.length();return Pn.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e},e.prototype.transform=function(e){jn.invert(bs,e),jn.transpose(bs,bs),Zn.set(Ts,this.n.x,this.n.y,this.n.z,this.d),Zn.transformMat4(Ts,Ts,bs),Pn.set(this.n,Ts.x,Ts.y,Ts.z),this.d=Ts.w},J(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),e}(),ws=function(){function e(e,t,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(Ss||(Ss={}));var Is,Ps,Rs=function(){function e(e,t,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=t,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new ws(e,r,this._stride);var o=Ss.NEVER,a=!1,s=!1;for(var c in t){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=t[c],a||o!==Ss.FLOAT32?s||o!==Ss.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(e<<this._entryBits)+this._poolFlag},t.getBuffer=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][n]},t.getTypedArray=function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e,r=t,o=(this._dataType[t]===Ss.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[t];return o.subarray(r,r+a)},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freeLists[t].push(n)},e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(Is||(Is={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(Ps||(Ps={}));var Ds,Os=((ps={})[Ps.DIRTY_FLAG]=Ss.UINT32,ps[Ps.LAYER]=Ss.UINT32,ps[Ps.WORLD_SCALE]=Ss.FLOAT32,ps[Ps.WORLD_POSITION]=Ss.FLOAT32,ps[Ps.WORLD_ROTATION]=Ss.FLOAT32,ps[Ps.WORLD_MATRIX]=Ss.FLOAT32,ps[Ps.LOCAL_SCALE]=Ss.FLOAT32,ps[Ps.LOCAL_POSITION]=Ss.FLOAT32,ps[Ps.LOCAL_ROTATION]=Ss.FLOAT32,ps[Ps.COUNT]=Ss.NEVER,ps),Ns=((ms={})[Ps.DIRTY_FLAG]=Ps.LAYER-Ps.DIRTY_FLAG,ms[Ps.LAYER]=Ps.WORLD_SCALE-Ps.LAYER,ms[Ps.WORLD_SCALE]=Ps.WORLD_POSITION-Ps.WORLD_SCALE,ms[Ps.WORLD_POSITION]=Ps.WORLD_ROTATION-Ps.WORLD_POSITION,ms[Ps.WORLD_ROTATION]=Ps.WORLD_MATRIX-Ps.WORLD_ROTATION,ms[Ps.WORLD_MATRIX]=Ps.LOCAL_SCALE-Ps.WORLD_MATRIX,ms[Ps.LOCAL_SCALE]=Ps.LOCAL_POSITION-Ps.LOCAL_SCALE,ms[Ps.LOCAL_POSITION]=Ps.LOCAL_ROTATION-Ps.LOCAL_POSITION,ms[Ps.LOCAL_ROTATION]=Ps.COUNT-Ps.LOCAL_ROTATION,ms[Ps.COUNT]=1,ms),Bs=new Rs(Is.NODE,Os,Ns,Ps);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(Ds||(Ds={}));var Ms,Ls=((vs={})[Ds.PRIORITY]=Ss.UINT32,vs[Ds.STAGE]=Ss.UINT32,vs[Ds.PHASE]=Ss.UINT32,vs[Ds.PRIMITIVE]=Ss.UINT32,vs[Ds.BATCHING_SCHEME]=Ss.UINT32,vs[Ds.DYNAMIC_STATE]=Ss.UINT32,vs[Ds.HASH]=Ss.UINT32,vs[Ds.COUNT]=Ss.NEVER,vs),Fs=((gs={})[Ds.PRIORITY]=Ds.STAGE-Ds.PRIORITY,gs[Ds.STAGE]=Ds.PHASE-Ds.STAGE,gs[Ds.PHASE]=Ds.PRIMITIVE-Ds.PHASE,gs[Ds.PRIMITIVE]=Ds.BATCHING_SCHEME-Ds.PRIMITIVE,gs[Ds.BATCHING_SCHEME]=Ds.DYNAMIC_STATE-Ds.BATCHING_SCHEME,gs[Ds.DYNAMIC_STATE]=Ds.HASH-Ds.DYNAMIC_STATE,gs[Ds.HASH]=Ds.COUNT-Ds.HASH,gs[Ds.COUNT]=1,gs),zs=new Rs(Is.PASS,Ls,Fs,Ds);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(Ms||(Ms={}));var Vs=((ys={})[Ms.CENTER]=Ss.FLOAT32,ys[Ms.HALFEXTENTS]=Ss.FLOAT32,ys[Ms.COUNT]=Ss.NEVER,ys),Gs=((xs={})[Ms.CENTER]=Ms.HALFEXTENTS-Ms.CENTER,xs[Ms.HALFEXTENTS]=Ms.COUNT-Ms.HALFEXTENTS,xs[Ms.COUNT]=1,xs),Us=new Rs(Is.AABB,Vs,Gs,Ms),ks=new Pn,Hs=new Pn,js=new Pn,Ws=new Pn,qs=new Nn,Xs=function(e,t,n){qs.m00=Math.abs(n.m00),qs.m01=Math.abs(n.m01),qs.m02=Math.abs(n.m02),qs.m03=Math.abs(n.m04),qs.m04=Math.abs(n.m05),qs.m05=Math.abs(n.m06),qs.m06=Math.abs(n.m08),qs.m07=Math.abs(n.m09),qs.m08=Math.abs(n.m10),Pn.transformMat3(e,t,qs)},Ys=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=ta.SHAPE_AABB,this.center=new Pn(e,t,n),this.halfExtents=new Pn(i,r,o)}e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return Pn.copy(e.center,t.center),Pn.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,n){return Pn.add(ks,n,t),Pn.subtract(Hs,n,t),Pn.multiplyScalar(e.center,ks,.5),Pn.multiplyScalar(e.halfExtents,Hs,.5),e},e.set=function(e,t,n,i,r,o,a){return e.center.set(t,n,i),e.halfExtents.set(r,o,a),e},e.merge=function(t,n,i){return Pn.subtract(ks,n.center,n.halfExtents),Pn.subtract(Hs,i.center,i.halfExtents),Pn.add(js,n.center,n.halfExtents),Pn.add(Ws,i.center,i.halfExtents),Pn.max(Ws,js,Ws),Pn.min(js,ks,Hs),e.fromPoints(t,js,Ws)},e.toBoundingSphere=function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e},e.transform=function(e,t,n){return Pn.transformMat4(e.center,t.center,n),Xs(e.halfExtents,t.halfExtents,n),e};var t=e.prototype;return t.getBoundary=function(e,t){Pn.subtract(e,this.center,this.halfExtents),Pn.add(t,this.center,this.halfExtents)},t.transform=function(e,t,n,i,r){Pn.transformMat4(r.center,this.center,e),Xs(r.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.mergePoint=function(e){this.getBoundary(ks,Hs),e.x<ks.x&&(ks.x=e.x),e.y<ks.y&&(ks.y=e.y),e.z<ks.z&&(ks.z=e.z),e.x>Hs.x&&(Hs.x=e.x),e.y>Hs.y&&(Hs.y=e.y),e.z>Hs.z&&(Hs.z=e.z),Pn.add(js,ks,Hs),this.center.set(Pn.multiplyScalar(js,js,.5)),this.halfExtents.set(Hs.x-js.x,Hs.y-js.y,Hs.z-js.z)},t.mergePoints=function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])},t.mergeFrustum=function(e){return this.mergePoints(e.vertices)},J(e,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Ks=new Pn,Js=new Pn,Qs=new Nn,Zs=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===_&&(_=0),void 0===f&&(f=0),void 0===d&&(d=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=ta.SHAPE_OBB,this.center=new Pn(e,t,n),this.halfExtents=new Pn(i,r,o),this.orientation=new Nn(a,s,c,l,u,h,_,f,d)}e.create=function(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return new e(t,n,i,r,o,a,s,c,l,u,h,_,f,d,p)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return Pn.copy(e.center,t.center),Pn.copy(e.halfExtents,t.halfExtents),Nn.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,n){return Pn.multiplyScalar(e.center,Pn.add(Ks,t,n),.5),Pn.multiplyScalar(e.halfExtents,Pn.subtract(Js,n,t),.5),Nn.identity(e.orientation),e},e.set=function(e,t,n,i,r,o,a,s,c,l,u,h,_,f,d,p){return Pn.set(e.center,t,n,i),Pn.set(e.halfExtents,r,o,a),Nn.set(e.orientation,s,c,l,u,h,_,f,d,p),e};var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,n){Qs.m00=Math.abs(n.m00),Qs.m01=Math.abs(n.m01),Qs.m02=Math.abs(n.m02),Qs.m03=Math.abs(n.m03),Qs.m04=Math.abs(n.m04),Qs.m05=Math.abs(n.m05),Qs.m06=Math.abs(n.m06),Qs.m07=Math.abs(n.m07),Qs.m08=Math.abs(n.m08),Pn.transformMat3(e,t,Qs)}(Ks,this.halfExtents,this.orientation),Pn.subtract(e,this.center,Ks),Pn.add(t,this.center,Ks)},t.transform=function(e,t,n,i,r){Pn.transformMat4(r.center,this.center,e),Nn.fromQuat(r.orientation,n),Pn.multiply(r.halfExtents,this.halfExtents,i)},t.translateAndRotate=function(e,t,n){Pn.transformMat4(n.center,this.center,e),Nn.fromQuat(n.orientation,t)},t.setScale=function(e,t){Pn.multiply(t.halfExtents,this.halfExtents,e)},J(e,[{key:"type",get:function(){return this._type}}]),e}(),$s=function(){function e(e,t,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=ta.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=n,this.center=new Pn,this.rotation=new Ln,this.ellipseCenter0=new Pn(0,t,0),this.ellipseCenter1=new Pn(0,-t,0),this.updateCache()}var t=e.prototype;return t.transform=function(e,t,n,i,r){var o=i,a=An(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,Pn.transformMat4(r.center,this.center,e),Ln.multiply(r.rotation,this.rotation,n),r.updateCache()},t.updateCache=function(){this.updateLocalCenter(),Pn.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),Pn.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},J(e,[{key:"type",get:function(){return this._type}}]),e}(),ec=new Array(8);ec[0]=new Pn(1,1,1),ec[1]=new Pn(-1,1,1),ec[2]=new Pn(-1,-1,1),ec[3]=new Pn(1,-1,1),ec[4]=new Pn(1,1,-1),ec[5]=new Pn(-1,1,-1),ec[6]=new Pn(-1,-1,-1),ec[7]=new Pn(1,-1,-1);var tc,nc,ic=new Pn,rc=new Pn,oc=new Pn,ac=function(){function e(){this.planes=void 0,this.vertices=void 0,this._type=void 0,this._type=ta.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=Es.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new Pn}e.createFromAABB=function(e,t){var n=new Pn,i=new Pn;return Pn.subtract(n,t.center,t.halfExtents),Pn.add(i,t.center,t.halfExtents),e.vertices[0].set(n.x,i.y,n.z),e.vertices[1].set(i.x,i.y,n.z),e.vertices[2].set(i.x,n.y,n.z),e.vertices[3].set(n.x,n.y,n.z),e.vertices[4].set(n.x,i.y,i.z),e.vertices[5].set(i.x,i.y,i.z),e.vertices[6].set(i.x,n.y,i.z),e.vertices[7].set(n.x,n.y,i.z),e._type!==ta.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e},e.split=function(e,t,n,i,r){var o=Math.tan(.5*t.fov),a=o*t.aspect;ic.set(i*a,i*o,i),rc.set(r*a,r*o,r);var s=e.vertices;return oc.set(ic.x,ic.y,ic.z),Pn.transformMat4(s[0],oc,n),oc.set(-ic.x,ic.y,ic.z),Pn.transformMat4(s[1],oc,n),oc.set(-ic.x,-ic.y,ic.z),Pn.transformMat4(s[2],oc,n),oc.set(ic.x,-ic.y,ic.z),Pn.transformMat4(s[3],oc,n),oc.set(rc.x,rc.y,rc.z),Pn.transformMat4(s[4],oc,n),oc.set(-rc.x,rc.y,rc.z),Pn.transformMat4(s[5],oc,n),oc.set(-rc.x,-rc.y,rc.z),Pn.transformMat4(s[6],oc,n),oc.set(rc.x,-rc.y,rc.z),Pn.transformMat4(s[7],oc,n),e.updatePlanes(),e},e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var n=0;n<6;++n)Es.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)Pn.copy(e.vertices[i],t.vertices[i]);return e};var t=e.prototype;return t.update=function(e,t){if(Pn.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),Pn.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),Pn.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),Pn.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),Pn.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),Pn.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===ta.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();Pn.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)Pn.transformMat4(this.vertices[o],ec[o],t)}},t.transform=function(e){if(this._type===ta.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)Pn.transformMat4(this.vertices[t],this.vertices[t],e);this.updatePlanes()}},t.updatePlanes=function(){Es.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Es.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Es.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Es.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Es.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Es.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},J(e,[{key:"accurate",set:function(e){this._type=e?ta.SHAPE_FRUSTUM_ACCURATE:ta.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),e}();ac.createOrtho=function(e,t,n,i,r,o){var a=t/2,s=n/2;Pn.set(oc,a,s,-i),Pn.transformMat4(e.vertices[0],oc,o),Pn.set(oc,-a,s,-i),Pn.transformMat4(e.vertices[1],oc,o),Pn.set(oc,-a,-s,-i),Pn.transformMat4(e.vertices[2],oc,o),Pn.set(oc,a,-s,-i),Pn.transformMat4(e.vertices[3],oc,o),Pn.set(oc,a,s,-r),Pn.transformMat4(e.vertices[4],oc,o),Pn.set(oc,-a,s,-r),Pn.transformMat4(e.vertices[5],oc,o),Pn.set(oc,-a,-s,-r),Pn.transformMat4(e.vertices[6],oc,o),Pn.set(oc,a,-s,-r),Pn.transformMat4(e.vertices[7],oc,o),Es.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Es.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Es.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Es.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Es.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Es.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(tc||(tc={})),function(e){e[e.Default=tc.Default]="Default",e[e.Normal=tc.Normal]="Normal",e[e.Reverse=tc.Reverse]="Reverse",e[e.Loop=tc.Loop]="Loop",e[e.LoopReverse=tc.Loop|tc.Reverse]="LoopReverse",e[e.PingPong=tc.PingPong]="PingPong",e[e.PingPongReverse=tc.PingPong|tc.Reverse]="PingPongReverse"}(nc||(nc={})),st(nc);var sc,cc=function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}();function lc(e,t,n){void 0===n&&(n=1e-6);for(var i=0,r=e.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=e[o];if(a>t+n)r=o-1;else{if(!(a<t-n))return o;i=o+1}}return~i}sc=Symbol.iterator;var uc,hc,_c,fc=function(){function e(){this._times=[],this._values=[]}var t=e.prototype;return t[sc]=function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var n=[e._times[t],e._values[t]];return++t,{done:!1,value:n}}}},t.keyframes=function(){return this},t.times=function(){return this._times},t.values=function(){return this._values},t.getKeyframeTime=function(e){return this._times[e]},t.getKeyframeValue=function(e){return this._values[e]},t.addKeyFrame=function(e,t){return this._insertNewKeyframe(e,t)},t.removeKeyframe=function(e){this._times.splice(e,1),this._values.splice(e,1)},t.indexOfKeyframe=function(e){return lc(this._times,e)},t.updateTime=function(e,t){var n=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,n)},t.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return e[1]})))}},t.clear=function(){this._times.length=0,this._values.length=0},t.searchKeyframe=function(e){return lc(this._times,e)},t.setKeyframes=function(e,t){e.length,t.length,function(e){e.every((function(e,t,n){return 0===t||e>n[t-1]||sn(e,n[t-1],1e-6)}))}(e),this._times=e,this._values=t},t._insertNewKeyframe=function(e,t){var n=this._times,i=this._values,r=n.length,o=lc(n,e);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(e),i.unshift(t)):a===r?(n.push(e),i.push(t)):(n.splice(a-1,0,e),i.splice(a-1,0,t)),a},J(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),e}();function dc(e){return e>-1e-9&&e<1e-9}Zt.fastDefine("cc.KeyframeCurve",fc,{_times:[],_values:[]}),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(uc||(uc=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(hc||(hc=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(_c||(_c=e("TangentWeightMode",{})));var pc=function(){},mc=function(){return pc},vc=gc((function(){}));function gc(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function yc(e){return function(t){return function(n){!function(e,t,n){var i=Sc(e);if(i){var r=Cc(i,"proto");Cc(r,"editor")[t]=n}}(n,e,t)}}}var xc="__ccclassCache__";function Sc(e){return Cc(e,xc)}function Cc(e,t){return e[t]||(e[t]={})}var Ac=gc((function(e,t){var n=nt.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},r=e[xc];if(r){var o=r.proto;o&&nt.mixin(i,o),e[xc]=void 0}return Zt(i)})),bc=yc("requireComponent"),Tc=yc("executionOrder"),Ec=vc;function wc(e,t,n){var i=null;function r(e,t,n){!function(e,t,n,i,r,o){var a,s=o&&(o.get||o.set);r&&(a=Ut(r,s));var c=nt.mixin(t,a||r||{});s?(o.get&&(c.get=o.get),o.set&&(c.set=o.set)):Pc(e,c,n,i,o)}(function(e){return Sc(e.constructor)}(e),function(e,t){var n,i,r=Cc(Sc(e.constructor),"proto"),o=Cc(r,"properties");return null!==(i=o[n=t])&&void 0!==i?i:o[n]={}}(e,t),e.constructor,t,i,n)}return void 0===e?wc({type:void 0}):void 0===t?(i=e,r):void r(e,t,n)}function Ic(e,t,n){var i,r,o=Sc(e.constructor),a=Cc(o,"proto"),s=Cc(a,"properties"),c=null!==(r=s[i=t])&&void 0!==r?r:s[i]={};return c.__internalFlags|=kt.STANDALONE,n&&(n.get||n.set)?(n.get&&(c.get=n.get),n.set&&(c.set=n.set)):Pc(o,c,e.constructor,t,n),c}function Pc(e,t,n,i,r){if(r)r.initializer&&(t.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(r.initializer));else{var o=e.default||(e.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(n));o.hasOwnProperty(i)&&(t.default=o[i])}}var Rc=Symbol("cc:SerializationMetadata"),Dc=function(e,t,n){Bc(Ic(e,t,n))};function Oc(e){return function(t,n,i){var r=Ic(t,n,i);r.formerlySerializedAs=e,Bc(r)}}var Nc=function(e,t,n){var i=Ic(e,t,n);i.editorOnly=!0,Bc(i)};function Bc(e){e.__internalFlags|=kt.IMPLICIT_SERIALIZABLE}var Mc=pc,Lc=vc,Fc=mc,zc=vc,Vc=mc,Gc=mc,Uc=mc,kc=pc,Hc=mc,jc=pc,Wc=mc,qc=mc,Xc=mc,Yc=mc,Kc=mc,Jc=mc,Qc=pc,Zc=mc,$c=pc,el=pc,tl=ol(Dt),nl=ol(Ot),il=ol(Nt),rl=ol(Bt);function ol(e){return wc({type:e})}var al,sl=function(e,t,n){Ic(e,t,n).override=!0},cl=e("editorExtrasTag","__editorExtras__"),ll=function(){},ul=Object.freeze({__proto__:null,uniquelyReferenced:Mc,ccclass:Ac,property:wc,requireComponent:bc,executionOrder:Tc,disallowMultiple:Ec,allowReplicated:function(e){Zt.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:Lc,menu:Fc,playOnFocus:zc,inspector:Vc,icon:Gc,help:Uc,type:ol,integer:tl,float:nl,boolean:il,string:rl});e("_decorator",ul);var hl=1<<22,_l=[],fl=e("CCObject",function(){function e(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}e._deferredDestroy=function(){for(var e=_l.length,t=0;t<e;++t){var n=_l[t];1&n._objFlags||n._destroyImmediate()}e===_l.length?_l.length=0:_l.splice(0,e)};var t=e.prototype;return t.destroy=function(){return 1&this._objFlags?(R(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,_l.push(this),0))},t._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,i=e instanceof l._BaseNode||e instanceof l.Component,r=i?"_id":null,o={};for(n in e)if(e.hasOwnProperty(n)){if(n===r)continue;switch(typeof e[n]){case"string":o[n]="";break;case"object":case"function":o[n]=null}}if(Zt._isCCClass(t))for(var a=l.Class.Attr.getClassAttrs(t),s=t.__props__,c=0;c<s.length;c++){var u=(n=s[c])+l.Class.Attr.DELIMETER+"default";if(u in a){if(i&&"_id"===n)continue;switch(typeof a[u]){case"string":o[n]="";break;case"object":case"function":o[n]=null;break;case"undefined":o[n]=void 0}}}var h="";for(n in o){var _;_=Zt.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+Zt.escapeForJS(n)+"]=";var f=o[n];""===f&&(f='""'),h+=_+f+";\n"}return Function("o",h)}(this,e),Ae(e,"__destruct__",t,!0)),t(this)},t._destroyImmediate=function(){1&this._objFlags?O(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},J(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&hl)},set:function(e){e?this._objFlags|=hl:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),dl=fl.prototype;function pl(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}dl._deserialize=null,dl._onPreDestroy=null,Zt.fastDefine("cc.Object",fl,((al={_name:"",_objFlags:0})[cl]={},al)),Zt.Attr.setClassAttr(fl,cl,"editorOnly",!0),Zt.Attr.setClassAttr(fl,"replicated","visible",!1),Ae(fl,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),l.isValid=pl,l.Object=fl;var ml=function(){function e(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=nt.createMap(!0),this._count=0)}var t=e.prototype;return t.add=function(e,t){return e in this._map||this._count++,this._map[e]=t},t.get=function(e){return this._map[e]},t.has=function(e){return e in this._map},t.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},t.clear=function(){0!==this._count&&(this._map=nt.createMap(!0),this._count=0)},t.forEach=function(e){for(var t in this._map)e(this._map[t],t)},t.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},t.destroy=function(){this._map=null},J(e,[{key:"count",get:function(){return this._count}}]),e}(),vl=function(){function e(t,n){this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var t=e.prototype;return t.insert=function(e,t){return t>this.pipes.length?(R(4921),this):(this.pipes.splice(t,0,e),this)},t.append=function(e){return this.pipes.push(e),this},t.remove=function(e){return this.pipes.splice(e,1),this},t.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var r=(0,t[n])(e);if(r)return e.isFinish=!0,r;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},t.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},t._flow=function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))},e}();vl._pipelineId=0,function(){function e(e){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(e)for(var t in e)this._weakMap[t]=new WeakRef(e[t])}var t=e.prototype;t.add=function(e,t){return this._weakMap[e]=new WeakRef(t),t},t.has=function(e){return e in this._weakMap&&!!this._weakMap[e].deref()},t.get=function(e){return this._weakMap[e]&&this._weakMap[e].deref()},t.remove=function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()},t.clear=function(){this._weakMap=nt.createMap(!0)},t.forEach=function(e){for(var t in this._weakMap){var n=this.get(t);n&&e(n,t)}},t.find=function(e){for(var t in this._weakMap){var n=this.get(t);if(n&&e(n,t))return this._weakMap[t].deref()}return null},t.destroy=function(){this._weakMap={}},J(e,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}}])}();var gl,yl=new ml,xl=new ml,Sl=new ml,Cl=new ml,Al=new vl("normal load",[]),bl=new vl("fetch",[]),Tl=new vl("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(gl||(gl={}));var El,wl={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(El||(El={}));var Il=function(){function e(t){this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}e.create=function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n};var t=e.prototype;return t.set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},t.dispatch=function(e,t,n,i,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,r);break;case"error":this.onError&&this.onError(t,n,i,r);break;default:var o="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[o]&&this[o](t,n,i,r)}},t.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))},e}();Il.MAX_DEAD_NUM=500,Il._taskId=0,Il._deadPool=[];var Pl="0123456789abcdef".split(""),Rl=["","","",""],Dl=Rl.concat(Rl,"-",Rl,"-",Rl,"-",Rl,"-",Rl,Rl,Rl),Ol=Dl.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function Nl(e){var t=e.split("@")[0];if(22!==t.length)return e;Dl[0]=e[0],Dl[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=dt[e.charCodeAt(n)],o=dt[e.charCodeAt(n+1)];Dl[Ol[i++]]=Pl[r>>2],Dl[Ol[i++]]=Pl[(3&r)<<2|o>>4],Dl[Ol[i++]]=Pl[15&o]}return e.replace(t,Dl.join(""))}var Bl=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function Ml(e){var t=Bl.exec(e);return t?t[1]:""}function Ll(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.nativeExt&&(t.ext=t.nativeExt);var n=Cl.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),Vl(e,t)}function Fl(e){return!!e&&(e instanceof l.SceneAsset||e instanceof l.Scene)}function zl(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function Vl(e,t){var n=Il.create({input:e,options:t}),i=[];try{for(var r,o=ae(Tl.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(e){for(var c,l=ae(n.output);!(c=l()).done;)c.value.recycle();S(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var Gl=Object.freeze({__proto__:null,getUuidFromURL:Ml,getUrlWithUuid:Ll,isScene:Fl,normalize:zl,transform:Vl,decodeUuid:Nl}),Ul=new(function(){function e(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var t=e.prototype;return t.addContainer=function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))},t.removeContainer=function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,he(this._pools,e._poolHandle),e._poolHandle=-1)},t.tryShrink=function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()},t.update=function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},e}()),kl=function(){function e(){this._poolHandle=-1,Ul.addContainer(this)}return e.prototype.destroy=function(){Ul.removeContainer(this)},e}(),Hl=e("Pool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=t,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(t());return r}Z(t,e);var n=t.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freepool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(e){this._freepool[++this._nextAvail]=e},n.freeArray=function(e){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freepool[e]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var t=arguments.length>0?arguments[0]:null;t&&R(14100);var n=t||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,e.prototype.destroy.call(this)},t}(kl)),jl=e("RecyclePool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=t,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=t();return r}Z(t,e);var n=t.prototype;return n.reset=function(){this._count=0},n.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var t=0;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=0,this._count=0,e.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}},n.removeAt=function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}},J(t,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(kl)),Wl=e("CachedArray",function(e){function t(t,n){var i;return(i=e.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(t),i._initSize=t,i.length=0,i._compareFn=n,i}Z(t,e);var n=t.prototype;return n.push=function(e){this.array[this.length++]=e},n.pop=function(){return this.array[--this.length]},n.get=function(e){return this.array[e]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,e.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},n.fastRemove=function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}},n.indexOf=function(e){for(var t=0,n=this.length;t<n;++t)if(this.array[t]===e)return t;return-1},t}(kl));e("memop",Object.freeze({__proto__:null,Pool:Hl,RecyclePool:jl,CachedArray:Wl}));var ql=tt.fastRemoveAt;function Xl(){}var Yl=function(){function e(){this.callback=Xl,this.target=void 0,this.once=!1}var t=e.prototype;return t.set=function(e,t,n){this.callback=e||Xl,this.target=t,this.once=!!n},t.reset=function(){this.target=void 0,this.callback=Xl,this.once=!1},t.check=function(){return!(this.target instanceof fl&&!pl(this.target,!0))},e}(),Kl=new Hl((function(){return new Yl}),32),Jl=function(){function e(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var t=e.prototype;return t.removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),Kl.free(n),ql(this.callbackInfos,t),--t)}},t.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),Kl.free(n),ql(this.callbackInfos,t),--t)}},t.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:ql(this.callbackInfos,e),Kl.free(t)),this.containCanceled=!0},t.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),Kl.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},t.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||ql(this.callbackInfos,e);this.containCanceled=!1},t.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},e}(),Ql=new Hl((function(){return new Jl}),16),Zl=function(){function e(){this._callbackTable=we(!0),this._offCallback=void 0}var t=e.prototype;return t.on=function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=Ql.alloc());var o=Kl.alloc();o.set(t,n,i),r.callbackInfos.push(o)}return t},t.hasEventListener=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var r=i.callbackInfos;if(!t){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1},t.removeAll=function(e){var t=typeof e;if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),Ql.free(n),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===e&&r.cancel(a)}else r.removeByTarget(e)}},t.off=function(e,t,n){var i,r=this._callbackTable&&this._callbackTable[e];if(r){var o=r.callbackInfos;if(t)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===t&&s.target===n){r.cancel(a);break}}else this.removeAll(e)}null===(i=this._offCallback)||void 0===i||i.call(this)},t.emit=function(e,t,n,i,r,o){var a=this._callbackTable&&this._callbackTable[e];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var _=h.callback,f=h.target;h.once&&this.off(e,_,f),h.check()?f?_.call(f,t,n,i,r,o):_(t,n,i,r,o):this.off(e,_,f)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},t.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),Ql.free(t),delete this._callbackTable[e])}},t._registerOffCallback=function(e){this._offCallback=e},e}();function $l(e){for(var t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._callbackTable=we(!0),t}Z(t,e);var n=t.prototype;return n.once=function(e,t,n){return this.on(e,t,n,!0)},n.targetOff=function(e){this.removeAll(e)},t}(e),n=Zl.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in t.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(t.prototype,o,a)}}return t}var eu,tu,nu,iu,ru,ou,au=e("EventTarget",$l((function(){})));l.EventTarget=au,function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(eu||(eu={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(tu||(tu={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(nu||(nu={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(iu||(iu={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(ru||(ru={})),function(e){e.WEBP="WEBP",e.IMAGE_BITMAP="IMAGE_BITMAP",e.WEB_VIEW="WEB_VIEW",e.VIDEO_PLAYER="VIDEO_PLAYER",e.SAFE_AREA="SAFE_AREA",e.INPUT_TOUCH="INPUT_TOUCH",e.EVENT_KEYBOARD="EVENT_KEYBOARD",e.EVENT_MOUSE="EVENT_MOUSE",e.EVENT_TOUCH="EVENT_TOUCH",e.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(ou||(ou={}));var su,cu,lu,uu,hu=new(function(e){function t(){var t,n,i;(i=e.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(t=o.getBattery)||void 0===t||t.call(o).then((function(e){i._battery=e})),i.networkType=nu.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?ru.MOBILE_BROWSER:ru.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:tu.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,_=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);_&&(c=!0,u=_[1]||"",h=parseInt(u)||0),(_=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=_[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var f=iu.UNKNOWN;-1!==o.appVersion.indexOf("Win")?f=iu.WINDOWS:l?f=iu.IOS:-1!==o.appVersion.indexOf("Mac")?f=iu.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?f=iu.LINUX:c?f=iu.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(f=iu.LINUX),i.os=f,i.osVersion=u,i.osMainVersion=h,i.browserType=eu.UNKNOWN;var d=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),p=d?d[0].toLowerCase():iu.UNKNOWN;("safari"===p&&c||"qq"===p&&/android.*applewebkit/i.test(a))&&(p=eu.ANDROID);var m={micromessenger:eu.WECHAT,wechat:eu.WECHAT,weixin:eu.WECHAT,trident:eu.IE,edge:eu.EDGE,"360 aphone":eu.BROWSER_360,mxbrowser:eu.MAXTHON,"opr/":eu.OPERA,ubrowser:eu.UC,huaweibrowser:eu.HUAWEI};i.browserType=m[p]||p,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){g=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(e){x=!0,null==e||e.close()})).catch((function(){})));var S=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,C=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[ou.WEBP]=g,n[ou.IMAGE_BITMAP]=x,n[ou.WEB_VIEW]=!0,n[ou.VIDEO_PLAYER]=!0,n[ou.SAFE_AREA]=!1,n[ou.INPUT_TOUCH]=S,n[ou.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[ou.EVENT_MOUSE]=C,n[ou.EVENT_TOUCH]=S||C,n[ou.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}Z(t,e);var n=t.prototype;return n._registerEvent=function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t.emit("hide"))},r=function(e,i,r,o,a){n&&(n=!1,t.emit("show",e,i,r,o,a))};if(e)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(t){var n=document[e];(n=n||t.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(e){return this._featureMap[e]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(e){window.open(e)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},t}(au)),_u=/(\.[^\.\/\?\\]*)(\?.*)?$/,fu=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,du=/[^\.\/]+\/\.\.\//;function pu(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function mu(e){var t=_u.exec(e);return t?t[1]:""}function vu(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function gu(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function yu(e){var t=fu.exec(e);return t?t[2]:""}function xu(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function Su(e,t,n){if(0===t.indexOf("."))return xu(e,t);var i=e.indexOf("?"),r="",o=n?mu(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+o+r}function Cu(e){var t=e=String(e);do{t=e,e=e.replace(du,"")}while(t.length!==e.length);return e}function Au(e){return e.replace(/[\/\\]$/,"")}function bu(){return hu.os===iu.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:pu,extname:mu,mainFileName:vu,basename:gu,dirname:yu,changeExtname:xu,changeBasename:Su,_normalize:Cu,stripSep:Au,getSeperator:bu}));var Tu,Eu,wu,Iu=e("Asset",Ac("cc.Asset")((uu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).loaded=!0,se(t,"_native",lu,re(t)),t._nativeUrl="",t._file=null,t._ref=0,Object.defineProperty(re(t),"_uuid",{value:"",writable:!0}),t}Z(t,e),t.deserialize=function(e){return l.deserialize(e)};var n=t.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(e,t){void 0===t&&(t=!0),this._native=!1!==t?e||"":"/"+e},n.addRef=function(){return this._ref++,this},n.decRef=function(e){return void 0===e&&(e=!0),this._ref>0&&this._ref--,e&&l.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return A(L(12101,this._uuid)),e.prototype.destroy.call(this)},J(t,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=Ll(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=Ll(this._uuid,{__nativeName__:e,nativeExt:mu(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),t}($l(fl)),lu=ce((cu=uu).prototype,"_native",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ce(cu.prototype,"_nativeAsset",[wc],Object.getOwnPropertyDescriptor(cu.prototype,"_nativeAsset"),cu.prototype),su=cu))||su);Iu.prototype.createNode=null,l.Asset=Iu;var Pu=e("Script",Ac("cc.Script")(Tu=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(Iu))||Tu);l._Script=Pu;var Ru=e("JavaScript",Ac("cc.JavaScript")(Eu=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(Pu))||Eu);l._JavaScript=Ru;var Du,Ou,Nu,Bu,Mu,Lu,Fu,zu,Vu,Gu,Uu,ku=e("TypeScript",Ac("cc.TypeScript")(wu=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(Pu))||wu);l._TypeScript=ku;var Hu,ju,Wu,qu,Xu=new pe("Comp"),Yu=fl.Flags.IsOnLoadCalled,Ku=e("Component",(Du=Ac("cc.Component"),Ou=Wc(),Nu=ol(Pu),Bu=qc(),Du((Uu=Gu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"node",Fu,re(t)),se(t,"_enabled",zu,re(t)),se(t,"__prefab",Vu,re(t)),t._sceneGetter=null,t._id=Xu.getNewId(),t}Z(t,e);var n=t.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(e){return this.node.addComponent(e)},n.getComponent=function(e){return this.node.getComponent(e)},n.getComponents=function(e){return this.node.getComponents(e)},n.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},n.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},n.destroy=function(){return!!e.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&l.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),l.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(e){return e||(e=l.instantiate._clone(this,this)),e&&(e.node=null),e},n.schedule=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=l.macro.REPEAT_FOREVER),void 0===i&&(i=0),M(e,1619),M((t=t||0)>=0,1620),n=Number.isNaN(n)?l.macro.REPEAT_FOREVER:n,i=i||0;var r=l.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(e,this,t,n,i,o)},n.scheduleOnce=function(e,t){void 0===t&&(t=0),this.schedule(e,0,0,t)},n.unschedule=function(e){e&&l.director.getScheduler().unschedule(e,this)},n.unscheduleAllCallbacks=function(){l.director.getScheduler().unscheduleAllForTarget(this)},J(t,[{key:"name",get:function(){if(this._name)return this._name;var e=Ie(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node?this.node.name+"<"+e+">":e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=l.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&Yu}}]),t}(fl),Gu.system=null,ce((Lu=Uu).prototype,"__scriptAsset",[Ou,Nu,Bu,el],Object.getOwnPropertyDescriptor(Lu.prototype,"__scriptAsset"),Lu.prototype),Fu=ce(Lu.prototype,"node",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zu=ce(Lu.prototype,"_enabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Vu=ce(Lu.prototype,"__prefab",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mu=Lu))||Mu)),Ju=Ku.prototype;Ju.update=null,Ju.lateUpdate=null,Ju.__preload=null,Ju.onLoad=null,Ju.start=null,Ju.onEnable=null,Ju.onDisable=null,Ju.onDestroy=null,Ju.onFocusInEditor=null,Ju.onLostFocusInEditor=null,Ju.resetInEditor=null,Ju._getLocalBounds=null,Ju.onRestore=null,Ku._requireComponent=null,Ku._executionOrder=0,Ae(Ku,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),l.Component=Ku;var Qu,Zu=e("MissingScript",Ac("cc.MissingScript")(Hu=Vc()((qu=function(e){function t(){var t;return se(t=e.call(this)||this,"_$erialized",Wu,re(t)),t}return Z(t,e),t.safeFindClass=function(e){var t=Qe(e);if(t)return t;l.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){R(4600,this.node.name)},t}(Ku),Wu=ce((ju=qu).prototype,"_$erialized",[Dc,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hu=ju))||Hu)||Hu);l._MissingScript=Zu;try{var $u=Zu.__values__;0!==$u.length&&"_$erialized"===$u[$u.length-1]||(S("The '_$erialized' prop in MissingScript is missing. Please contact jare."),S("    Error props: ['"+$u+"']"))}catch(Jo){S("Error when checking MissingScript 5, "+Jo)}!function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE",e[e.AUTO=13]="AUTO"}(Qu||(Qu={}));var eh,th={auto:Qu.AUTO,landscape:Qu.LANDSCAPE,portrait:Qu.PORTRAIT};!function(e){e[e.Unknown=0]="Unknown",e[e.SubFrame=1]="SubFrame",e[e.BrowserWindow=2]="BrowserWindow",e[e.Fullscreen=3]="Fullscreen"}(eh||(eh={}));var nh=new(function(e){function t(){var t,n,i,r,o,a;(t=e.call(this)||this).isFrameRotated=!1,t.handleResizeEvent=!0,t._gameFrame=void 0,t._gameContainer=void 0,t._gameCanvas=void 0,t._isProportionalToFrame=!1,t._cachedFrameStyle={width:"0px",height:"0px"},t._cachedContainerStyle={width:"0px",height:"0px"},t._cbToUpdateFrameBuffer=void 0,t._supportFullScreen=!1,t._touchEventName=void 0,t._onFullscreenChange=void 0,t._onFullscreenError=void 0,t._orientationChangeTimeoutId=-1,t._cachedFrameSize=new ti(0,0),t._exactFitScreen=!1,t._fn={},t._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],t._resolutionScale=1,t._orientation=Qu.AUTO,t._gameFrame=document.getElementById("GameDiv"),t._gameContainer=document.getElementById("Cocos3dGameContainer"),t._gameCanvas=document.getElementById("GameCanvas"),t._gameFrame||(t._gameFrame=document.createElement("div"),t._gameFrame.setAttribute("id","GameDiv"),null===(n=t._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(t._gameFrame,t._gameCanvas),t._gameFrame.appendChild(t._gameCanvas)),t._gameContainer||(t._gameContainer=document.createElement("div"),t._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=t._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(t._gameContainer,t._gameCanvas),t._gameContainer.appendChild(t._gameCanvas));for(var s=t._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)t._fn[s[0][l]]=a[l];break}return t._supportFullScreen=void 0!==t._fn.requestFullscreen,t._touchEventName="ontouchstart"in window?"touchend":"mousedown",t._registerEvent(),window.orientationCatcher=t._startOrientationCatcher.bind(re(t)),t}Z(t,e);var n=t.prototype;return n.init=function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=th[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var e=this;return new Promise((function(t,n){e.isFullScreen?t():(e._cachedFrameSize=e.windowSize,e._doRequestFullScreen().then((function(){t()})).catch((function(){var i=e._getFullscreenTarget();i?i.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var e=this;return new Promise((function(t,n){var i=document[e._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){e.windowSize=e._cachedFrameSize,t()})).catch(n):(e.windowSize=e._cachedFrameSize,t())}))},n._startOrientationCatcher=function(){var e=this;return new Promise((function(t){e.wInnerOld=0,e.hInnerOld=0,e.wInner=0,e.hInner=0,window.setInterval(function(){this.wInner=window.innerWidth,this.hInner=window.innerHeight,this.wInner>0&&this.hInner>0&&(this.wInner!=this.wInnerOld||this.hInner!=this.hInnerOld)&&(console.log("resize canvas to adjust window size"),-1!==this._orientationChangeTimeoutId&&clearTimeout(this._orientationChangeTimeoutId),this._updateFrameState(),this._resizeFrame(),this.emit("orientation-change"),this._orientationChangeTimeoutId=-1,this.wInnerOld=this.wInner,this.hInnerOld=this.hInner)}.bind(e),100),t()}))},n._registerEvent=function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.handleResizeEvent&&e._resizeFrame()})),"function"==typeof window.matchMedia&&function t(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){e.emit("window-resize"),t()}),{once:!0})}(),this._startOrientationCatcher(),window.addEventListener("orientationchange",(function(){-1!==e._orientationChangeTimeoutId&&clearTimeout(e._orientationChangeTimeoutId),e._orientationChangeTimeoutId=setTimeout((function(){e.handleResizeEvent&&(e._updateFrameState(),e._resizeFrame(),e.emit("orientation-change"),e._orientationChangeTimeoutId=-1)}),200+(window.fast.info.mobile?500:0))})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e),e.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(e){var t=e.clone(),n=this.devicePixelRatio;return t.width/=n,t.height/=n,t},n._resizeFrame=function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===eh.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width=e.width+"px",this._gameFrame.style.height=e.height+"px"}else{var t=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+t+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=t+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=t+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var e=this._windowType;return e===eh.Fullscreen?document[this._fn.fullscreenElement]:e===eh.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var e=this;return new Promise((function(t,n){if(e._supportFullScreen){var i=e._getFullscreenTarget();if(i){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var r=i[e._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(t).catch(n):(e._onFullscreenChange=t,e._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=t&&e===Qu.PORTRAIT||!t&&e===Qu.LANDSCAPE},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void R(9201);var e,t,n=l.view.getDesignResolutionSize(),i=this._gameFrame,r=i.clientWidth,o=i.clientHeight,a=n.width,s=n.height,c=r/a,u=o/s,h=this._gameContainer.style;c<u?(e=r,t=s*c):(e=a*u,t=o),h.width=e+"px",h.height=t+"px"}else{var _=this._gameContainer.style;_.width="100%",_.height="100%"}(/HuaweiBrowser/i.test(window.navigator.userAgent)||this._gameFrame&&(this._cachedFrameStyle.width!==this._gameFrame.style.width||this._cachedFrameStyle.height!==this._gameFrame.style.height||this._cachedContainerStyle.width!==this._gameContainer.style.width||this._cachedContainerStyle.height!==this._gameContainer.style.height))&&(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else R(9201)},J(t,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var e;return Math.min(null!==(e=window.devicePixelRatio)&&void 0!==e?e:1,2)}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===eh.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):R(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new ti(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){var t;e!==this._resolutionScale&&(this._resolutionScale=e,null===(t=this._cbToUpdateFrameBuffer)||void 0===t||t.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new ti(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(R(9201),new ti(0,0));var e,t,n;switch(this._windowType){case eh.SubFrame:return this._gameFrame?new ti(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(R(9201),new ti(0,0));case eh.Fullscreen:return e=this._getFullscreenTarget(),t=this.isFrameRotated?e.clientHeight:e.clientWidth,n=this.isFrameRotated?e.clientWidth:e.clientHeight,new ti(t,n);case eh.BrowserWindow:return t=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new ti(t,n);case eh.Unknown:default:return new ti(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?eh.Fullscreen:this._gameFrame?this._exactFitScreen?eh.BrowserWindow:eh.SubFrame:(R(9201),eh.Unknown)}}]),t}(au)),ih=function(){function e(){}var t=e.prototype;return t._init=function(e){nh.init(e,(function(){var e,t=l.director;(null===(e=t.root)||void 0===e?void 0:e.pipeline)?t.root.pipeline.pipelineSceneData.shadingScale=nh.resolutionScale:R(1220)}))},t.fullScreen=function(){return nh.isFullScreen},t.requestFullScreen=function(e,t,n){return arguments.length>0&&R(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),nh.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==n||n()}))},t.exitFullScreen=function(){return nh.exitFullScreen()},t.autoFullScreen=function(e,t){var n;null===(n=this.requestFullScreen(e,t))||void 0===n||n.catch((function(){}))},t.disableAutoFullScreen=function(){},J(e,[{key:"devicePixelRatio",get:function(){return nh.devicePixelRatio}},{key:"windowSize",get:function(){return nh.windowSize},set:function(e){nh.windowSize=e}},{key:"resolution",get:function(){return nh.resolution}},{key:"supportsFullScreen",get:function(){return nh.supportFullScreen}}]),e}(),rh=e("screen",new ih);l.screen=rh;var oh=e("sys",{Feature:ou,hasFeature:function(e){return hu.hasFeature(e)},NetworkType:nu,Language:tu,OS:iu,Platform:ru,BrowserType:eu,isNative:hu.isNative,isBrowser:hu.isBrowser,isMobile:hu.isMobile,isLittleEndian:hu.isLittleEndian,platform:hu.platform,language:hu.language,languageCode:hu.nativeLanguage,os:hu.os,osVersion:hu.osVersion,osMainVersion:hu.osMainVersion,browserType:hu.browserType,browserVersion:hu.browserVersion,windowPixelResolution:rh.windowSize,capabilities:{canvas:!0,opengl:!0,webp:hu.hasFeature(ou.WEBP),imageBitmap:hu.hasFeature(ou.IMAGE_BITMAP),touches:hu.hasFeature(ou.INPUT_TOUCH),mouse:hu.hasFeature(ou.EVENT_MOUSE),keyboard:hu.hasFeature(ou.EVENT_KEYBOARD),accelerometer:hu.hasFeature(ou.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return hu.networkType},getBatteryLevel:function(){return hu.getBatteryLevel()},garbageCollect:function(){hu.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",y(e+="Using "+(l.game.renderType===l.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){hu.openURL(e)},now:function(){return hu.now()},restartVM:function(){hu.restartJSVM()},getSafeAreaRect:function(){var e=l.view,t=nh.safeAreaEdge,n=nh.windowSize,i=new Yn(t.left,t.bottom),r=new Yn(n.width-t.right,n.height-t.top);e._convertToUISpace(i),e._convertToUISpace(r);var o=i.x,a=i.y,s=r.x-i.x,c=r.y-i.y;return new ii(o,a,s,c)}});!function(){try{var e=oh.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){R(5200)};oh.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}oh.__isWebIOS14OrIPadOS14Env=(oh.os===iu.IOS||oh.os===iu.OSX)&&hu.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),l.sys=oh;var ah=e("serializeTag",Symbol("[[Serialize]]")),sh=e("deserializeTag",Symbol("[[Deserialize]]")),ch=function(){function e(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}return J(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function lh(e){var t=e;return{chunks:t.chunks,document:t.document}}function uh(e){if(e.length<16)throw new hh(L(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new hh(L(13100));var n=t.getUint32(4,!0);if(1!==n)throw new hh(L(13101,n));if(t.getUint32(8,!0)!==t.byteLength)throw new hh(L(13102));var i=12,r=t.getUint32(i,!0);i+=4;var o=new Uint8Array(t.buffer,i+t.byteOffset,r);i+=r;var a,s=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(L(13104))}(o);try{a=JSON.parse(s)}catch(e){throw new hh(e)}for(var c=[];i<t.byteLength;){i%8!=0&&(i+=8-i%8);var l=t.getUint32(i,!0);i+=4,c.push(new Uint8Array(t.buffer,i+t.byteOffset,l)),i+=l}if(i!==t.byteLength)throw new hh(L(13102));return new ch(a,c)}var hh=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(ie(Error));function _h(e,t,n,i,r){if(t instanceof l.ValueType){r||e.push("if(prop){");var o=Ie(t);e.push("s._deserializeFastDefinedObject(o"+n+",prop,"+o+");"),r||e.push("}else o"+n+"=null;")}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+i+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function e(){this._viewOrPaddings=[],this._length=0}var t=e.prototype;t.alignAs=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},t.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},t.get=function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t),t+=n.byteLength)})),e},J(e,[{key:"byteLength",get:function(){return this._length}}])}(),l.internal.parseCCONJson=lh,l.internal.decodeCCONBinary=uh,l.internal.CCON=ch;var fh="$_$default",dh="$_$formerlySerializedAs",ph=function(e){function t(){return e.call(this,(function(e){e.clear()}),1)||this}return Z(t,e),t.prototype.get=function(e,t,n,i,r){var o=this._get();return o?(o.reset(e,t,n,i,r),o):new mh(e,t,n,i,r)},t}(et),mh=function(){function e(e,t,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced}var t=e.prototype;return t.reset=function(e,t,n,i){this.result=e,this.customEnv=i,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced},t.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},t.deserialize=function(e){var t,n=!1;e instanceof ch?(n=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:n};var i=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},t._deserializeObject=function(e,t,n,i){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,n,i):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},t._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},t._deserializeTypedArrayViewRef=function(e){var t=e.offset,n=e.length,i=e.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,n)},t._deserializeArray=function(e){for(var t,n=new Array(e.length),i=0;i<e.length;i++)"object"==typeof(t=e[i])&&t?this._deserializeAndAssignField(n,t,""+i)&&(n[i]=null):n[i]=t;return n},t._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},t._deserializeTypeTaggedObject=function(e,t,n,i){var r=this,o=e.__type__,a=this._classFinder(o,e,n,i);if(!a)return this._classFinder===Qe&&this._reportMissingClass(o),null;var s=function(e){var n=new e;return t>=0&&(r.deserializedList[t]=n),n}(a);return this._deserializeInto(e,s,a),s},t._deserializeInto=function(e,t,n,i){void 0===i&&(i=!1),i||!t[sh]?t._deserialize?t._deserialize(e.content,this):l.Class._isCCClass(n)?this._deserializeFireClass(t,e,n):this._deserializeFastDefinedObject(t,e,n):this._runCustomizedDeserialize(e,t,n)},t._runCustomizedDeserialize=function(e,t,n){var i=this,r={readProperty:function(t){var n=e[t];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(e,t,n,!0)},readSuper:function(){var r=Ge(n);r&&i._deserializeInto(e,t,r)}};t[sh](r,this._context)},t._deserializeFireClass=function(e,t,n){var i;if(n.hasOwnProperty("__deserialize__"))i=n.__deserialize__;else{i=function(e,t){for(var n=It(t),i=t.__values__,r=["var prop;"],o=ut.test($e(t)),a=0;a<i.length;a++){var s=i[a],c=void 0,u=void 0;Zt.IDENTIFIER_RE.test(s)?(u='"'+s+'"',c="."+s):c="["+(u=Zt.escapeForJS(s))+"]";var h=c;if(n[s+dh]){var _=n[s+dh];h=Zt.IDENTIFIER_RE.test(_)?"."+_:"["+Zt.escapeForJS(_)+"]"}r.push("prop=d"+h+";"),r.push('if(typeof prop!=="undefined"){');var f=Zt.getDefault(n[s+fh]);if(o){var d=void 0,p=n[s+"$_$type"];if(void 0===f&&p)d=p instanceof Rt;else{var m=typeof f;d="string"===m||"number"===m||"boolean"===m}d?r.push("o"+c+"=prop;"):_h(r,f,c,u,!0)}else r.push('if(typeof prop!=="object"){o'+c+"=prop;}else{"),_h(r,f,c,u,!1),r.push("}");r.push("}")}return(l.js.isChildClassOf(t,l._BaseNode)||l.js.isChildClassOf(t,l.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,n);try{if(n===Zu){var r=n.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(S("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),S("    Error props: ['"+r+"']. Please contact jare."));var o=i;i=function(e,t,n,i){o(e,t,n,i),t._$erialized||S("Unable to stash previously serialized data. "+JSON.stringify(n))}}}catch(e){S("Error when checking MissingScript 6, "+e)}Ae(n,"__deserialize__",i,!0)}i(this,e,t,n)},t._deserializeAndAssignField=function(e,t,n){var i=t.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)e[n]=r;else{var o,a=this._serializedData[i];e[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,e,n)}}else{var s=t.__uuid__;if(s){var c=t.__expectedType__;this.result.push(e,n,s,c)}else e[n]=this._deserializeObject(t,-1)}return!1},t._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var n=this.deserializedList[t];if(n)return n;var i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},t._fillPlainObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!=typeof i?"__type__"!==n&&(e[n]=i):i?this._deserializeAndAssignField(e,i,n)&&(e[n]=null):e[n]=null}},t._deserializeFastDefinedObject=function(e,t,n){if(n===l.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===l.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==l.Color){if(n===l.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var i=It(n),r=n.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];void 0!==s||t.hasOwnProperty(a)||(s=Zt.getDefault(i[a+fh])),"object"!=typeof s?e[a]=s:s?this._deserializeAndAssignField(e,s,a):e[a]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var c=t.a;e.a=void 0===c?255:c}},e}();mh.pool=new ph;var vh=[Yn,Pn,Zn,Ln,wn,ti,ii,jn];function gh(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var yh=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},gh,gh,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){jn.fromArray(e,t,1)}],xh=e("Details",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},t.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},t.push=function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")},e}());function Sh(e,t){for(var n=e[4][t[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=t[c];for(;c<t.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,wh[u])(e,r,l,t[c])}return r}function Ch(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):O(5303,Ie(t)),i}function Ah(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function bh(e){return function(t,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)e(t,r,o,r[o])}}function Th(e,t,n,i){t[n]=null,e[8][i]=t}function Eh(e,t,n,i){t[n]=Sh(e,i)}xh.pool=new et((function(e){e.reset()}),5),xh.pool.get=function(){return this._get()||new xh};var wh=new Array(13);function Ih(e,t,n){return e||n(t),Object}function Ph(e,t,n,i,r,o,a){var s=e(t);if(!s){if(r)return void(n[i]=function(t,n,i){return function(){var r=e(i)||Ih(o,i,a);return t[n]=r,new r}}(n,i,t));s=Ih(o,t,a)}n[i]=s}function Rh(e,t,n,i){for(var r=n||Qe,o=e[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?Ph(r,s[0],s,0,t,n,i):Ph(r,s,o,a,t,n,i)}}function Dh(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var r=t[i];r[0]=n[r[0]]}}function Oh(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var i,r=!t;if(t=t||xh.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof Nh}return!1}(e)){t.init(e),n=n||{};var o,a=e[0],s=!1;if("object"==typeof a&&(s=a.preprocessed,a=a.version),a<1)throw new Error(L(5304,a));n._version=a,n.result=t,e[0]=n,s||(Rh(e,!1,n.classFinder,null!==(o=n.reportMissingClass)&&void 0!==o?o:Oh.reportMissingClass),Dh(e)),l.game._isCloning=!0;var c=e[5],u=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,r=t[t.length-1],o=t.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)t[a]=Sh(e,t[a]);for(var s=e[3],c=0;c<i;++c,++a){var l=n[c],u=t[a];if(l>=0){var h=s[l];t[a]=Ch(e,h,u)}else(0,wh[l=~l])(e,t,a,u)}return r}(e);l.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,r=0,o=3*e[i];r<o;r+=3){var a=e[r],s=t[e[r+2]],c=e[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=t[e[r]],u=t[e[r+2]],h=e[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],c,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],r=e[8],o=e[9],a=e[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=t[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(e),i=c[u]}else i=function(e,t,n){var i,r=(n=n||{}).classFinder||Qe,o=n.createAssetRefs||oh.platform===ru.EDITOR_CORE,a=n.customEnv,s=n.ignoreEditorOnly,c=null!==(i=n.reportMissingClass)&&void 0!==i?i:l.deserialize.reportMissingClass;t.init();var u=mh.pool.get(t,r,c,a,s);l.game._isCloning=!0;var h=u.deserialize(e);return l.game._isCloning=!1,mh.pool.put(u),o&&t.assignAssetsBy(EditorExtends.serialize.asAsset),h}(e,t,n);return r&&xh.pool.put(t),i}wh[0]=function(e,t,n,i){t[n]=i},wh[1]=Ah,wh[2]=bh(Ah),wh[3]=bh(Th),wh[4]=Eh,wh[5]=function(e,t,n,i){yh[i[0]](t[n],i)},wh[6]=Th,wh[7]=function(e,t,n,i){t[n].set(i)},wh[8]=function(e,t,n,i){var r=new vh[i[0]];yh[i[0]](r,i),t[n]=r},wh[9]=bh(Eh),wh[10]=function(e,t,n,i){var r=e[3][i[0]];t[n]=Ch(e,r,i[1])},wh[11]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,wh[s])(e,r,a,c)}},wh[12]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,wh[s])(e,r,o,a)}},Oh.Details=xh,Oh.reportMissingClass=function(e){O(5302,e)};var Nh=function(e){this.preprocessed=!0,this.version=e};function Bh(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}l.deserialize=Oh;var Mh,Lh,Fh,zh,Vh,Gh,Uh,kh,Hh,jh,Wh,qh=fl.Flags.Destroyed,Xh=fl.Flags.PersistentMask,Yh=[];function Kh(e){var t;if(e instanceof fl){if(e._instantiate)return l.game._isCloning=!0,t=e._instantiate(null,!0),l.game._isCloning=!1,t;if(e instanceof l.Asset)throw new TypeError(L(6903))}return l.game._isCloning=!0,t=Jh(e),l.game._isCloning=!1,t}function Jh(e,t){var n;Qh(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,r=Yh.length;i<r;++i)Yh[i]._iN$t=null;return Yh.length=0,n}function Qh(e,t,n){nt.value(e,"_iN$t",t,!0),Yh.push(e);var i=e.constructor;if($t(i))!function(e,t,n,i){for(var r=e.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];if("object"==typeof s&&s){var c=n[a];c instanceof ct&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||Zh(s,i)}else n[a]=s}}(i,e,t,n);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var o=e[r];if("object"==typeof o&&o){if(o===t)continue;t[r]=o._iN$t||Zh(o,n)}else t[r]=o}e instanceof fl&&(t._objFlags&=Xh)}function Zh(e,t){if(e instanceof ct)return e.clone();if(e instanceof l.Asset)return e;var n;if(ArrayBuffer.isView(e)){var i=e.length;n=new e.constructor(i),e._iN$t=n,Yh.push(e);for(var r=0;r<i;++r)n[r]=e[r];return n}if(Array.isArray(e)){var o=e.length;n=new Array(o),e._iN$t=n,Yh.push(e);for(var a=0;a<o;++a){var s=e[a];n[a]="object"==typeof s&&s?s._iN$t||Zh(s,t):s}return n}if(e._objFlags&qh)return null;var c=e.constructor;if($t(c)){if(t)if(t instanceof l.Component){if(e instanceof l._BaseNode||e instanceof l.Component)return e}else if(t instanceof l._BaseNode)if(e instanceof l._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof l.Component&&e.node&&!e.node.isChildOf(t))return e;n=new c}else if(c===Object)n={};else{if(c)return e;n=Object.create(null)}return Qh(e,n,t),n}function $h(e,t){return(t<<3)+e}function e_(e){return n_[e]}function t_(e){switch(e){case jh.Uint8:return Uint8Array;case jh.Uint16:return Uint16Array;case jh.Uint32:return Uint32Array;case jh.Int8:return Int8Array;case jh.Int16:return Int16Array;case jh.Int32:return Int32Array;case jh.Float32:return Float32Array;case jh.Float64:return Float64Array}}Kh._clone=Jh,l.instantiate=Kh,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(jh||(jh={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(Wh||(Wh={})),e("CompactValueTypeArray",Ac("cc.CompactValueTypeArray")((kh=Uh=function(){function e(){se(this,"_byteOffset",Fh,this),se(this,"_unitCount",zh,this),se(this,"_unitElement",Vh,this),se(this,"_length",Gh,this)}return e.lengthFor=function(e,t,n){return e_(t).requiredUnits*e.length*t_(n).BYTES_PER_ELEMENT},e.compress=function(t,n,i,r,o,a){for(var s=e_(n),c=t_(i),l=s.requiredUnits*t.length,u=new c(r,o,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var _=new e;return _._unitElement=$h(i,n),_._byteOffset=a,_._unitCount=l,_._length=t.length,_},e.prototype.decompress=function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=e_(n.elementType),o=new(t_(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},e}(),Uh.StorageUnit=jh,Uh.ElementType=Wh,Fh=ce((Lh=kh).prototype,"_byteOffset",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zh=ce(Lh.prototype,"_unitCount",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Vh=ce(Lh.prototype,"_unitElement",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $h(jh.Uint8,Wh.Scalar)}}),Gh=ce(Lh.prototype,"_length",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mh=Lh))||Mh);var n_=((Hh={})[Wh.Scalar]={requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}},Hh[Wh.Vec2]={requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new Pn(e[2*t],e[2*t+1])}},Hh[Wh.Vec3]={requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new Pn(e[3*t],e[3*t+1],e[3*t+2])}},Hh[Wh.Vec4]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Zn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Hh[Wh.Quat]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Ln(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Hh[Wh.Mat4]={requiredUnits:16,compress:function(e,t,n){jn.toArray(e,n,16*t)},decompress:function(e,t){return jn.fromArray(new jn,e,16*t)}},Hh);function i_(){return 0}function r_(e){return e}function o_(e){return e*e}function a_(e){return e*(2-e)}function s_(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function c_(e){return e*e*e}function l_(e){return--e*e*e+1}function u_(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function h_(e){return e*e*e*e}function __(e){return 1- --e*e*e*e}function f_(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function d_(e){return e*e*e*e*e}function p_(e){return--e*e*e*e*e+1}function m_(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function v_(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function g_(e){return Math.sin(e*Math.PI/2)}function y_(e){return.5*(1-Math.cos(Math.PI*e))}function x_(e){return 0===e?0:Math.pow(1024,e-1)}function S_(e){return 1===e?1:1-Math.pow(2,-10*e)}function C_(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function A_(e){return 1-Math.sqrt(1-e*e)}function b_(e){return Math.sqrt(1- --e*e)}function T_(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function E_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function w_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function I_(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function P_(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function R_(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function D_(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function O_(e){return 1-N_(1-e)}function N_(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function B_(e){return e<.5?.5*O_(2*e):.5*N_(2*e-1)+.5}function M_(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function L_(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}l._decorator=ul;var F_=X_(o_,a_),z_=X_(c_,l_),V_=X_(h_,__),G_=X_(d_,p_),U_=X_(v_,g_),k_=X_(x_,S_),H_=X_(A_,b_),j_=X_(E_,w_),W_=X_(P_,R_),q_=X_(O_,N_);function X_(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var Y_,K_,J_=Object.freeze({__proto__:null,constant:i_,linear:r_,quadIn:o_,quadOut:a_,quadInOut:s_,cubicIn:c_,cubicOut:l_,cubicInOut:u_,quartIn:h_,quartOut:__,quartInOut:f_,quintIn:d_,quintOut:p_,quintInOut:m_,sineIn:v_,sineOut:g_,sineInOut:y_,expoIn:x_,expoOut:S_,expoInOut:C_,circIn:A_,circOut:b_,circInOut:T_,elasticIn:E_,elasticOut:w_,elasticInOut:I_,backIn:P_,backOut:R_,backInOut:D_,bounceIn:O_,bounceOut:N_,bounceInOut:B_,smooth:M_,fade:L_,quadOutIn:F_,cubicOutIn:z_,quartOutIn:V_,quintOutIn:G_,sineOutIn:U_,expoOutIn:k_,circOutIn:H_,elasticOutIn:j_,backOutIn:W_,bounceOutIn:q_});e("easing",J_),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(K_||(K_={}));var Q_,Z_=((Y_={})[K_.CONSTANT]=i_,Y_[K_.LINEAR]=r_,Y_[K_.QUAD_IN]=o_,Y_[K_.QUAD_OUT]=a_,Y_[K_.QUAD_IN_OUT]=s_,Y_[K_.QUAD_OUT_IN]=F_,Y_[K_.CUBIC_IN]=c_,Y_[K_.CUBIC_OUT]=l_,Y_[K_.CUBIC_IN_OUT]=u_,Y_[K_.CUBIC_OUT_IN]=z_,Y_[K_.QUART_IN]=h_,Y_[K_.QUART_OUT]=__,Y_[K_.QUART_IN_OUT]=f_,Y_[K_.QUART_OUT_IN]=V_,Y_[K_.QUINT_IN]=d_,Y_[K_.QUINT_OUT]=p_,Y_[K_.QUINT_IN_OUT]=m_,Y_[K_.QUINT_OUT_IN]=G_,Y_[K_.SINE_IN]=v_,Y_[K_.SINE_OUT]=g_,Y_[K_.SINE_IN_OUT]=y_,Y_[K_.SINE_OUT_IN]=U_,Y_[K_.EXPO_IN]=x_,Y_[K_.EXPO_OUT]=S_,Y_[K_.EXPO_IN_OUT]=C_,Y_[K_.EXPO_OUT_IN]=k_,Y_[K_.CIRC_IN]=A_,Y_[K_.CIRC_OUT]=b_,Y_[K_.CIRC_IN_OUT]=T_,Y_[K_.CIRC_OUT_IN]=H_,Y_[K_.ELASTIC_IN]=E_,Y_[K_.ELASTIC_OUT]=w_,Y_[K_.ELASTIC_IN_OUT]=I_,Y_[K_.ELASTIC_OUT_IN]=j_,Y_[K_.BACK_IN]=P_,Y_[K_.BACK_OUT]=R_,Y_[K_.BACK_IN_OUT]=D_,Y_[K_.BACK_OUT_IN]=W_,Y_[K_.BOUNCE_IN]=O_,Y_[K_.BOUNCE_OUT]=N_,Y_[K_.BOUNCE_IN_OUT]=B_,Y_[K_.BOUNCE_OUT_IN]=q_,Y_[K_.SMOOTH]=M_,Y_[K_.FADE]=L_,Y_);function $_(e){return Z_[e]}i(255),i(65280);var ef,tf,nf,rf=uc.LINEAR<<0|_c.NONE<<8|K_.LINEAR<<16,of=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).value=0,t.rightTangent=0,t.rightTangentWeight=0,t.leftTangent=0,t.leftTangentWeight=0,t._flags=rf,t}return Z(t,e),J(t,[{key:"interpolationMode",get:function(){return(255&this._flags)>>0},set:function(e){this._flags&=-256,this._flags|=e<<0}},{key:"tangentWeightMode",get:function(){return(65280&this._flags)>>8},set:function(e){this._flags&=-65281,this._flags|=e<<8}},{key:"easingMethod",get:function(){return(16711680&this._flags)>>16},set:function(e){this._flags&=-16711681,this._flags|=e<<16}}]),t}(ll);function af(e){var t=new of;if("number"==typeof e)t.value=e;else{var n=e.interpolationMode,i=e.tangentWeightMode,r=e.value,o=e.rightTangent,a=e.rightTangentWeight,s=e.leftTangent,c=e.leftTangentWeight,l=e.easingMethod,u=e[cl];t.value=null!=r?r:t.value,t.rightTangent=null!=o?o:t.rightTangent,t.rightTangentWeight=null!=a?a:t.rightTangentWeight,t.leftTangent=null!=s?s:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=n?n:t.interpolationMode,t.tangentWeightMode=null!=i?i:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,u&&(t[cl]=u)}return t}Zt.fastDefine("cc.RealKeyframeValue",of,((Q_={interpolationMode:uc.LINEAR,tangentWeightMode:_c.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:K_.LINEAR})[cl]=void 0,Q_)),Zt.Attr.setClassAttr(of,cl,"editorOnly",!0),(ef=of,null!==(nf=(tf=ef)[Rc])&&void 0!==nf?nf:tf[Rc]={}).uniquelyReferenced=!0;var sf,cf=e("RealCurve",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).preExtrapolation=hc.CLAMP,t.postExtrapolation=hc.CLAMP,t}Z(t,e);var n=t.prototype;return n.evaluate=function(e){var t=this._times,n=this._values,i=t.length;if(0===i)return 0;var r=t[0],o=t[i-1];if(e<r){var a=this.preExtrapolation,s=n[0];if(a===hc.CLAMP||i<2)return s.value;switch(a){case hc.LINEAR:return bf(r,n[0].value,t[1],n[1].value,e);case hc.LOOP:e=Cf(e,r,o);break;case hc.PING_PONG:e=Af(e,r,o);break;default:return s.value}}else if(e>o){var c=this.postExtrapolation,l=n[i-1];if(c===hc.CLAMP||i<2)return l.value;switch(c){case hc.LINEAR:return bf(o,l.value,t[i-2],n[i-2].value,e);case hc.LOOP:e=Cf(e,r,o);break;case hc.PING_PONG:e=Af(e,r,o);break;default:return l.value}}var u=lc(t,e);if(u>=0)return n[u].value;var h=~u,_=h-1,f=t[_],d=n[_],p=t[h];return function(e,t,n,i,r){var o=n-e;switch(t.interpolationMode){default:case uc.CONSTANT:return t.value;case uc.LINEAR:var a=t.easingMethod===K_.LINEAR?r:$_(t.easingMethod)(r);return un(t.value,i.value,a);case uc.CUBIC:var s=1/3,c=t.rightTangent,l=t.rightTangentWeight,u=0!=(t.tangentWeightMode&_c.RIGHT),h=i.leftTangent,_=i.leftTangentWeight,f=0!=(i.tangentWeightMode&_c.LEFT);if(u||f){var d=0;if(u)d=l;else{var p=o,m=o*c;d=Math.sqrt(p*p+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*d+e,y=Math.sin(v)*d+t.value,x=0;if(f)x=_;else{var S=o,C=o*h;x=Math.sqrt(S*S+C*C)*s}var A=Math.atan(h),b=(g-e)/o,T=(-Math.cos(A)*x+n-e)/o,E=y,w=-Math.sin(A)*x+i.value,I=[0,0,0],P=function(e,t,n,i,r){var o=n/i,a=t/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+e/i),u=c*c*c,h=l*l+u,_=0;if(dc(h)){if(dc(l))return r[0]=0,1;var f=Math.cbrt(-l);return r[0]=2*f,r[1]=-f,2}if(h<0){var d=1/3*Math.acos(-l/Math.sqrt(-u)),p=2*Math.sqrt(-c);r[0]=p*Math.cos(d),r[1]=-p*Math.cos(d+Math.PI/3),r[2]=-p*Math.cos(d-Math.PI/3),_=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,_=1}for(var y=1/3*o,x=0;x<_;++x)r[x]-=y;return _}(0-r,3*b,3*T-6*b,3*(b-T)+1,I),R=function(e,t,n){var i=n;if(1===t)i=e[0];else{i=-1/0;for(var r=0;r<t;++r){var o=e[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(I,P,r);return Tf(t.value,E,w,i.value,R)}var D=t.value+s*c*o,O=i.value-s*h*o;return Tf(t.value,D,O,i.value,r)}}(f,d,p,n[h],(e-f)/(p-f))},n.addKeyFrame=function(t,n){return e.prototype.addKeyFrame.call(this,t,af(n))},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return af(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return af(e[1])})))}},n.isConstant=function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(n){return sn(n.value,t,e)}))},n[ah]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+lf+lf+uf+hf*r+yf*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=lf,o.setUint8(a,this.postExtrapolation),a+=lf,o.setUint32(a,r,!0),a+=uf,n.forEach((function(e,t){return o.setFloat32(a+hf*t,e,!0)})),a+=hf*r;for(var s,c=ae(i);!(s=c()).done;){var l=s.value;a=xf(o,l,a)}var u=new Uint8Array(o.buffer,0,a);e.writeProperty("bytes",u);var h=i.map((function(e){return e[cl]}));h.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",h)}else e.writeThis()},n[sh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=lf,this.postExtrapolation=i.getUint8(r),r+=lf;var o=i.getUint32(r,!0);r+=uf;var a=Array.from({length:o},(function(e,t){return i.getFloat32(r+hf*t,!0)}));r+=hf*o;for(var s=new Array(o),c=0;c<o;++c){var l=af({});r=Sf(i,l,r),s[c]=l}n.byteLength;var u=e.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(e,t){return s[t][cl]=e}))),this._times=a,this._values=s}else e.readThis()},t}(fc));Zt.fastDefine("cc.RealCurve",cf,{_times:[],_values:[],preExtrapolation:hc.CLAMP,postExtrapolation:hc.CLAMP}),function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(sf||(sf={}));var lf=1,uf=4,hf=4,_f=af({}),ff=_f.interpolationMode,df=_f.tangentWeightMode,pf=_f.leftTangent,mf=_f.leftTangentWeight,vf=_f.rightTangent,gf=_f.rightTangentWeight,yf=26;function xf(e,t,n){var i=0,r=n,o=r;r+=4;var a=t.value,s=t.interpolationMode,c=t.tangentWeightMode,l=t.rightTangent,u=t.rightTangentWeight,h=t.leftTangent,_=t.leftTangentWeight,f=t.easingMethod;return e.setFloat32(r,a,!0),r+=4,s!==ff&&(i|=sf.INTERPOLATION_MODE,e.setUint8(r,s),r+=1),c!==df&&(i|=sf.TANGENT_WEIGHT_MODE,e.setUint8(r,c),r+=1),h!==pf&&(i|=sf.LEFT_TANGENT,e.setFloat32(r,h,!0),r+=4),_!==mf&&(i|=sf.LEFT_TANGENT_WEIGHT,e.setFloat32(r,_,!0),r+=4),l!==vf&&(i|=sf.RIGHT_TANGENT,e.setFloat32(r,l,!0),r+=4),u!==gf&&(i|=sf.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,u,!0),r+=4),i|=f<<8,e.setUint32(o,i,!0),r}function Sf(e,t,n){var i=n,r=e.getUint32(i,!0);i+=4,t.value=e.getFloat32(i,!0),i+=4,r&sf.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(i),i+=1),r&sf.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(i),i+=1),r&sf.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(i,!0),i+=4),r&sf.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(i,!0),i+=4),r&sf.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(i,!0),i+=4),r&sf.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return t.easingMethod=o,i}function Cf(e,t,n){return t+xn(e-t,n-t)}function Af(e,t,n){return t+Sn(e-t,n-t)}function bf(e,t,n,i,r){return t+(i-t)/(n-e)*(r-e)}function Tf(e,t,n,i,r){var o=1-r;return o*o*o*e+3*o*o*r*t+3*o*r*r*n+r*r*r*i}function Ef(e,t,n,i,r){var o=1-r;return o*(o*(e+(3*t-e)*r)+3*n*r*r)+i*r*r*r}l.bezier=Ef;var wf,If,Pf,Rf,Df,Of,Nf,Bf,Mf,Lf,Ff,zf=Math.cos,Vf=Math.acos,Gf=Math.max,Uf=2*Math.PI,kf=Math.sqrt;function Hf(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function jf(e,t){var n=function(e,t){var n,i,r,o,a=t-0,s=t-e[0],c=3*a,l=3*s,u=3*(t-e[2]),h=1/(-a+l-u+(t-1)),_=1/3,f=(c-6*s+u)*h,d=f*_,p=(-c+l)*h,m=(3*p-f*f)*_,v=m*_,g=(2*f*f*f-9*f*p+a*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*_,C=kf(S*S*S),A=-g/(2*C),b=Vf(A<-1?-1:A>1?1:A),T=2*Hf(C);return i=T*zf(b*_)-d,r=T*zf((b+Uf)*_)-d,o=T*zf((b+2*Uf)*_)-d,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?Gf(i,r,o):Gf(i,r):o>=0&&o<=1?Gf(i,o):i:r>=0&&r<=1?o>=0&&o<=1?Gf(r,o):r:o}if(0===x)return r=-(n=y<0?Hf(-y):-Hf(y))-d,(i=2*n-d)>=0&&i<=1?r>=0&&r<=1?Gf(i,r):i:r;var E=kf(x);return(n=Hf(-y+E))-Hf(y+E)-d}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}l.bezierByTime=jf,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(Ff||(Ff=e("QuatInterpolationMode",{})));var Wf=Ac("cc.QuatKeyframeValue")(wf=Mc((Pf=ce((If=function(e){var t=void 0===e?{}:e,n=t.value,i=t.interpolationMode,r=t.easingMethod;se(this,"interpolationMode",Pf,this),se(this,"value",Rf,this),se(this,"easingMethod",Df,this),this.value=n?Ln.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ff.SLERP}}),Rf=ce(If.prototype,"value",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ln.clone(Ln.IDENTITY)}}),Df=ce(If.prototype,"easingMethod",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return K_.LINEAR}}),wf=If))||wf)||wf;function qf(e){return new Wf(e)}var Xf,Yf=e("QuatCurve",Ac("cc.QuatCurve")((Lf=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",Bf,re(t)),se(t,"postExtrapolation",Mf,re(t)),t}Z(t,e);var n=t.prototype;return n.evaluate=function(e,t){var n;null!==(n=t)&&void 0!==n||(t=new Ln);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return t;var c=i[0],l=i[s-1];if(e<c){var u=r[0];switch(a){case hc.LOOP:e=c+xn(e-c,l-c);break;case hc.PING_PONG:e=c+Sn(e-c,l-c);break;case hc.CLAMP:default:return Ln.copy(t,u.value)}}else if(e>l){var h=r[s-1];switch(o){case hc.LOOP:e=c+xn(e-c,l-c);break;case hc.PING_PONG:e=c+Sn(e-c,l-c);break;case hc.CLAMP:default:return Ln.copy(t,h.value)}}var _=lc(i,e);if(_>=0)return Ln.copy(t,r[_].value);var f=~_,d=f-1,p=i[d],m=r[d],v=i[f],g=r[f],y=(e-p)/(v-p);switch(m.interpolationMode){default:case Ff.CONSTANT:return Ln.copy(t,m.value);case Ff.SLERP:var x=m.easingMethod,S=x===K_.LINEAR?y:Array.isArray(x)?jf(x,y):$_(x)(y);return Ln.slerp(t,m.value,g.value,S)}},n.addKeyFrame=function(t,n){var i=new Wf(n);return e.prototype.addKeyFrame.call(this,t,i)},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return qf(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return qf(e[1])})))}},n[ah]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(e,t,n){var i=n[0];r&&e.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=ed*(r?1:o),s=i.reduce((function(e,t){var n=t.easingMethod;return e+(Array.isArray(n)?td+4*id:td)}),0),c=0,l=new DataView(new ArrayBuffer(c+=Jf+Qf+Zf*o+4*$f*o+s+a+0)),u=0,h=0;r&&(h|=Xf.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=Jf,l.setUint32(u,o,!0),u+=Qf,n.forEach((function(e,t){return l.setFloat32(u+Zf*t,e,!0)})),u+=Zf*o,i.forEach((function(e,t){var n=e.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*$f*t;l.setFloat32(s+0*$f,i,!0),l.setFloat32(s+1*$f,r,!0),l.setFloat32(s+2*$f,o,!0),l.setFloat32(s+3*$f,a,!0)})),u+=4*$f*o,i.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(l.setUint8(u,nd),++u,l.setFloat32(u+0*id,t[0],!0),l.setFloat32(u+1*id,t[1],!0),l.setFloat32(u+2*id,t[2],!0),l.setFloat32(u+3*id,t[3],!0),u+=4*id):(l.setUint8(u,t),++u)}));var _=u;u+=a;var f=_;i.forEach((function(e){var t=e.interpolationMode;l.setUint8(f,t),r||(f+=ed)}));var d=new Uint8Array(l.buffer);e.writeProperty("bytes",d)}else e.writeThis()},n[sh]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=Jf;var a=o&Xf.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=Qf;var c=Array.from({length:s},(function(e,t){return i.getFloat32(r+Zf*t,!0)})),l=r+=Zf*s;r+=4*$f*s;var u=Array.from({length:s},(function(e,t){var n=l+4*$f*t,o=i.getFloat32(n+0*$f,!0),a=i.getFloat32(n+1*$f,!0),s=i.getFloat32(n+2*$f,!0),c=i.getFloat32(n+3*$f,!0),u=i.getUint8(r);++r;var h=qf({value:{x:o,y:a,z:s,w:c}});return u!==nd?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*id,!0),i.getFloat32(r+1*id,!0),i.getFloat32(r+2*id,!0),i.getFloat32(r+3*id,!0)],r+=4*id),h}));if(a){var h=i.getUint8(r);++r;for(var _=0;_<s;++_)u[_].interpolationMode=h}else{for(var f=0;f<s;++f){var d=i.getUint8(r+f);u[f].interpolationMode=d}r+=s}this._times=c,this._values=u}else e.readThis()},t}(fc),Bf=ce((Nf=Lf).prototype,"preExtrapolation",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hc.CLAMP}}),Mf=ce(Nf.prototype,"postExtrapolation",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hc.CLAMP}}),Of=Nf))||Of);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(Xf||(Xf={}));var Kf,Jf=1,Qf=4,Zf=4,$f=4,ed=1,td=1,nd=255,id=4,rd=e("ObjectCurve",Ac("cc.ObjectCurve")(Kf=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.prototype.evaluate=function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var n=cn(~t-1,0,this._values.length-1);return this._values[n]},t}(fc))||Kf),od=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};Zt.fastDefine("cc.Keyframe",od,{time:0,value:0,inTangent:0,outTangent:0});var ad=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n},e}(),sd=function(){function e(e){if(void 0===e&&(e=null),this.cachedKey=void 0,e instanceof cf)this._curve=e;else{var t=new cf;this._curve=t,t.preExtrapolation=hc.LOOP,t.postExtrapolation=hc.CLAMP,e?t.assignSorted(e.map((function(e){return[e.time,{interpolationMode:uc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):t.assignSorted([[0,{interpolationMode:uc.CUBIC,value:1}],[1,{interpolationMode:uc.CUBIC,value:1}]])}this.cachedKey=new ad}var t=e.prototype;return t.addKey=function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:uc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()},t.evaluate_slow=function(e){return this._curve.evaluate(e)},t.evaluate=function(e){var t=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=e,o=e<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case hc.LOOP:r=xn(e-a,s-a)+a;break;case hc.PING_PONG:r=Sn(e-a,s-a)+a;break;case hc.CLAMP:default:r=cn(e,a,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var c=this.findIndex(t,r),l=Math.min(c+1,i);return this.calcOptimizedKey(t,c,l),t.evaluate(r)},t.calcOptimizedKey=function(e,t,n){var i=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(t),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;e.index=t,e.time=i,e.endTime=r;var h=r-i,_=l-a,f=1/(h*h),d=s*h,p=u*h;e.coefficient[0]=(d+p-_-_)*f/h,e.coefficient[1]=(_+_+_-d-d-p)*f,e.coefficient[2]=s,e.coefficient[3]=a},t.findIndex=function(e,t){var n=this._curve,i=n.keyFramesCount,r=e.index;if(-1!==r)if(t>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>t)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=t?h=l:u=l;return u},J(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=e[0],n=e[1],i=new od;return i.time=t,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:uc.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return ld(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=cd(e)}},{key:"postWrapMode",get:function(){return ld(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=cd(e)}}]),e}();function cd(e){switch(e){default:case tc.Default:case tc.Normal:case tc.Clamp:return hc.CLAMP;case tc.PingPong:return hc.PING_PONG;case tc.Loop:return hc.LOOP}}function ld(e){switch(e){default:case hc.LINEAR:case hc.CLAMP:return tc.Clamp;case hc.PING_PONG:return tc.PingPong;case hc.LOOP:return tc.Loop}}function ud(e,t){console.warn(e+" is deprecated, please use "+t+" instead.")}sd.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Zt.fastDefine("cc.AnimationCurve",sd,{_curve:null}),V(ds,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var hd=function(e){function t(){var t;return t=e.call(this)||this,ud("line","Line"),t}return Z(t,e),t}(na),_d=function(e){function t(){var t;return t=e.call(this)||this,ud("plane","Plane"),t}return Z(t,e),t}(Es),fd=function(e){function t(){var t;return t=e.call(this)||this,ud("ray","Ray"),t}return Z(t,e),t}(ia),dd=function(e){function t(){var t;return t=e.call(this)||this,ud("triangle","Triangle"),t}return Z(t,e),t}(ha),pd=function(e){function t(){var t;return t=e.call(this)||this,ud("sphere","Sphere"),t}return Z(t,e),t}(ua),md=function(e){function t(){var t;return t=e.call(this)||this,ud("aabb","AABB"),t}return Z(t,e),t}(Ys),vd=function(e){function t(){var t;return t=e.call(this)||this,ud("obb","OBB"),t}return Z(t,e),t}(Zs),gd=function(e){function t(){var t;return t=e.call(this)||this,ud("capsule","Capsule"),t}return Z(t,e),t}($s),yd=function(e){function t(){var t;return t=e.call(this)||this,ud("frustum","Frustum"),t}return Z(t,e),t}(ac),xd=Object.freeze({__proto__:null,distance:ea,enums:ta,intersect:ds,Line:na,Plane:Es,Ray:ia,Triangle:ha,Sphere:ua,AABB:Ys,OBB:Zs,Capsule:$s,Frustum:ac,Keyframe:od,AnimationCurve:sd,get ERaycastMode(){return la},line:hd,plane:_d,ray:fd,triangle:dd,sphere:pd,aabb:md,obb:vd,capsule:gd,frustum:yd});e("geometry",xd);var Sd={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Cd=e("Layers",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,n=0,i=ae(e);!(t=i()).done;)n|=t.value;return n},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;e.Enum[t],L(2104,t),e.Enum[t]=i,nt.value(e.Enum,String(i),t),e.BitMask[t]=i,nt.value(e.BitMask,String(i),t)}else console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){if(t>19||t<0)console.warn("do not change buildin layers.");else{var n=1<<t;delete e.Enum[e.Enum[n]],delete e.Enum[n],delete e.BitMask[e.BitMask[n]],delete e.BitMask[n]}},e.nameToLayer=function(t){return void 0===t?(console.warn("name can't be undefined"),-1):n(e.Enum[t])},e.layerToName=function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[1<<t]},e}());Cd.Enum=rt(Sd),Cd.BitMask=it(Q({},Sd)),l.Layers=Cd;var Ad,bd,Td="MainFlow",Ed="ForwardFlow",wd="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(Ad||(Ad={})),l.RenderPassStage=Ad,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(bd||(bd={}));var Id,Pd={bindings:[],layouts:{}},Rd={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",e[e.COUNT=7]="COUNT"}(Id||(Id={}));var Dd,Od=Id.SAMPLER_SHADOWMAP,Nd=Id.COUNT-Od;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",e[e.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",e[e.COUNT=14]="COUNT"}(Dd||(Dd={}));var Bd,Md=Dd.SAMPLER_JOINTS,Ld=Dd.STORAGE_REFLECTION-Md,Fd=Dd.COUNT-Md-Ld;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(Bd||(Bd={}));var zd=new _r([Od,0,Md],[Nd,0,Ld],[0,0,0],[0,0,0],[0,0,0],[0,0,Fd],[0,0,0],[0,2,1]),Vd=function(){};Vd.SIZE=4*(Vd.COUNT=4+(Vd.SCREEN_SIZE_OFFSET=4+(Vd.NATIVE_SIZE_OFFSET=4+(Vd.TIME_OFFSET=0)))),Vd.NAME="CCGlobal",Vd.BINDING=Id.UBO_GLOBAL,Vd.DESCRIPTOR=new Hr(Vd.BINDING,Wi.UNIFORM_BUFFER,1,Ni.ALL),Vd.LAYOUT=new br(Bd.GLOBAL,Vd.BINDING,Vd.NAME,[new Ar("cc_time",pi.FLOAT4,1),new Ar("cc_screenSize",pi.FLOAT4,1),new Ar("cc_nativeSize",pi.FLOAT4,1)],1),Pd.layouts[Vd.NAME]=Vd.LAYOUT,Pd.bindings[Vd.BINDING]=Vd.DESCRIPTOR;var Gd=function(){};Gd.SIZE=4*(Gd.COUNT=4+(Gd.VIEW_PORT_OFFSET=4+(Gd.NEAR_FAR_OFFSET=4+(Gd.GLOBAL_FOG_ADD_OFFSET=4+(Gd.GLOBAL_FOG_BASE_OFFSET=4+(Gd.GLOBAL_FOG_COLOR_OFFSET=4+(Gd.AMBIENT_GROUND_OFFSET=4+(Gd.AMBIENT_SKY_OFFSET=4+(Gd.MAIN_LIT_COLOR_OFFSET=4+(Gd.MAIN_LIT_DIR_OFFSET=4+(Gd.EXPOSURE_OFFSET=4+(Gd.SCREEN_SCALE_OFFSET=4+(Gd.CAMERA_POS_OFFSET=16+(Gd.MAT_VIEW_PROJ_INV_OFFSET=16+(Gd.MAT_VIEW_PROJ_OFFSET=16+(Gd.MAT_PROJ_INV_OFFSET=16+(Gd.MAT_PROJ_OFFSET=16+(Gd.MAT_VIEW_INV_OFFSET=16+(Gd.MAT_VIEW_OFFSET=0))))))))))))))))))),Gd.NAME="CCCamera",Gd.BINDING=Id.UBO_CAMERA,Gd.DESCRIPTOR=new Hr(Gd.BINDING,Wi.UNIFORM_BUFFER,1,Ni.ALL),Gd.LAYOUT=new br(Bd.GLOBAL,Gd.BINDING,Gd.NAME,[new Ar("cc_matView",pi.MAT4,1),new Ar("cc_matViewInv",pi.MAT4,1),new Ar("cc_matProj",pi.MAT4,1),new Ar("cc_matProjInv",pi.MAT4,1),new Ar("cc_matViewProj",pi.MAT4,1),new Ar("cc_matViewProjInv",pi.MAT4,1),new Ar("cc_cameraPos",pi.FLOAT4,1),new Ar("cc_screenScale",pi.FLOAT4,1),new Ar("cc_exposure",pi.FLOAT4,1),new Ar("cc_mainLitDir",pi.FLOAT4,1),new Ar("cc_mainLitColor",pi.FLOAT4,1),new Ar("cc_ambientSky",pi.FLOAT4,1),new Ar("cc_ambientGround",pi.FLOAT4,1),new Ar("cc_fogColor",pi.FLOAT4,1),new Ar("cc_fogBase",pi.FLOAT4,1),new Ar("cc_fogAdd",pi.FLOAT4,1),new Ar("cc_nearFar",pi.FLOAT4,1),new Ar("cc_viewPort",pi.FLOAT4,1)],1),Pd.layouts[Gd.NAME]=Gd.LAYOUT,Pd.bindings[Gd.BINDING]=Gd.DESCRIPTOR;var Ud=function(){};Ud.SIZE=4*(Ud.COUNT=4+(Ud.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(Ud.SHADOW_COLOR_OFFSET=4+(Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(Ud.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(Ud.SHADOW_PROJ_INFO_OFFSET=4+(Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(Ud.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(Ud.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(Ud.MAT_LIGHT_VIEW_OFFSET=16+(Ud.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),Ud.NAME="CCShadow",Ud.BINDING=Id.UBO_SHADOW,Ud.DESCRIPTOR=new Hr(Ud.BINDING,Wi.UNIFORM_BUFFER,1,Ni.ALL),Ud.LAYOUT=new br(Bd.GLOBAL,Ud.BINDING,Ud.NAME,[new Ar("cc_matLightPlaneProj",pi.MAT4,1),new Ar("cc_matLightView",pi.MAT4,1),new Ar("cc_matLightViewProj",pi.MAT4,1),new Ar("cc_shadowInvProjDepthInfo",pi.FLOAT4,1),new Ar("cc_shadowProjDepthInfo",pi.FLOAT4,1),new Ar("cc_shadowProjInfo",pi.FLOAT4,1),new Ar("cc_shadowNFLSInfo",pi.FLOAT4,1),new Ar("cc_shadowWHPBInfo",pi.FLOAT4,1),new Ar("cc_shadowLPNNInfo",pi.FLOAT4,1),new Ar("cc_shadowColor",pi.FLOAT4,1),new Ar("cc_planarNDInfo",pi.FLOAT4,1)],1),Pd.layouts[Ud.NAME]=Ud.LAYOUT,Pd.bindings[Ud.BINDING]=Ud.DESCRIPTOR;var kd=Id.SAMPLER_SHADOWMAP,Hd=new Hr(kd,Wi.SAMPLER_TEXTURE,1,Ni.FRAGMENT),jd=new Tr(Bd.GLOBAL,kd,"cc_shadowMap",pi.SAMPLER2D,1);Pd.layouts.cc_shadowMap=jd,Pd.bindings[kd]=Hd;var Wd=Id.SAMPLER_ENVIRONMENT,qd=new Hr(Wd,Wi.SAMPLER_TEXTURE,1,Ni.FRAGMENT),Xd=new Tr(Bd.GLOBAL,Wd,"cc_environment",pi.SAMPLER_CUBE,1);Pd.layouts.cc_environment=Xd,Pd.bindings[Wd]=qd;var Yd=Id.SAMPLER_DIFFUSEMAP,Kd=new Hr(Yd,Wi.SAMPLER_TEXTURE,1,Ni.FRAGMENT),Jd=new Tr(Bd.GLOBAL,Yd,"cc_diffuseMap",pi.SAMPLER_CUBE,1);Pd.layouts.cc_diffuseMap=Jd,Pd.bindings[Yd]=Kd;var Qd=Id.SAMPLER_SPOT_LIGHTING_MAP,Zd=new Hr(Qd,Wi.SAMPLER_TEXTURE,1,Ni.FRAGMENT),$d=new Tr(Bd.GLOBAL,Qd,"cc_spotLightingMap",pi.SAMPLER2D,1);Pd.layouts.cc_spotLightingMap=$d,Pd.bindings[Qd]=Zd;var ep=function(){};ep.SIZE=4*(ep.COUNT=4+(ep.LOCAL_SHADOW_BIAS=4+(ep.LIGHTINGMAP_UVPARAM=16+(ep.MAT_WORLD_IT_OFFSET=16+(ep.MAT_WORLD_OFFSET=0))))),ep.NAME="CCLocal",ep.BINDING=Dd.UBO_LOCAL,ep.DESCRIPTOR=new Hr(ep.BINDING,Wi.UNIFORM_BUFFER,1,Ni.VERTEX|Ni.COMPUTE),ep.LAYOUT=new br(Bd.LOCAL,ep.BINDING,ep.NAME,[new Ar("cc_matWorld",pi.MAT4,1),new Ar("cc_matWorldIT",pi.MAT4,1),new Ar("cc_lightingMapUVParam",pi.FLOAT4,1),new Ar("cc_localShadowBias",pi.FLOAT4,1)],1),Rd.layouts[ep.NAME]=ep.LAYOUT,Rd.bindings[ep.BINDING]=ep.DESCRIPTOR;var tp=function(){};tp.SIZE=4*(tp.COUNT=4+(tp.WORLD_BOUND_HALF_EXTENTS=4+(tp.WORLD_BOUND_CENTER=0))),tp.NAME="CCWorldBound",tp.BINDING=Dd.UBO_LOCAL,tp.DESCRIPTOR=new Hr(tp.BINDING,Wi.UNIFORM_BUFFER,1,Ni.VERTEX|Ni.COMPUTE),tp.LAYOUT=new br(Bd.LOCAL,tp.BINDING,tp.NAME,[new Ar("cc_worldBoundCenter",pi.FLOAT4,1),new Ar("cc_worldBoundHalfExtents",pi.FLOAT4,1)],1),Rd.layouts[tp.NAME]=tp.LAYOUT,Rd.bindings[tp.BINDING]=tp.DESCRIPTOR;var np="a_matWorld0",ip=function(){};ip.BATCHING_COUNT=10,ip.MAT_WORLDS_OFFSET=0,ip.SIZE=4*(ip.COUNT=16*ip.BATCHING_COUNT),ip.NAME="CCLocalBatched",ip.BINDING=Dd.UBO_LOCAL,ip.DESCRIPTOR=new Hr(ip.BINDING,Wi.UNIFORM_BUFFER,1,Ni.VERTEX|Ni.COMPUTE),ip.LAYOUT=new br(Bd.LOCAL,ip.BINDING,ip.NAME,[new Ar("cc_matWorlds",pi.MAT4,ip.BATCHING_COUNT)],1),Rd.layouts[ip.NAME]=ip.LAYOUT,Rd.bindings[ip.BINDING]=ip.DESCRIPTOR;var rp=function(){};rp.LIGHTS_PER_PASS=1,rp.SIZE=4*(rp.COUNT=(rp.LIGHT_DIR_OFFSET=(rp.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(rp.LIGHT_COLOR_OFFSET=(rp.LIGHT_POS_OFFSET=0)+4*rp.LIGHTS_PER_PASS)+4*rp.LIGHTS_PER_PASS)+4*rp.LIGHTS_PER_PASS)+4*rp.LIGHTS_PER_PASS),rp.NAME="CCForwardLight",rp.BINDING=Dd.UBO_FORWARD_LIGHTS,rp.DESCRIPTOR=new Hr(rp.BINDING,Wi.DYNAMIC_UNIFORM_BUFFER,1,Ni.FRAGMENT),rp.LAYOUT=new br(Bd.LOCAL,rp.BINDING,rp.NAME,[new Ar("cc_lightPos",pi.FLOAT4,rp.LIGHTS_PER_PASS),new Ar("cc_lightColor",pi.FLOAT4,rp.LIGHTS_PER_PASS),new Ar("cc_lightSizeRangeAngle",pi.FLOAT4,rp.LIGHTS_PER_PASS),new Ar("cc_lightDir",pi.FLOAT4,rp.LIGHTS_PER_PASS)],1),Rd.layouts[rp.NAME]=rp.LAYOUT,Rd.bindings[rp.BINDING]=rp.DESCRIPTOR;var op=function(){};op.LIGHTS_PER_PASS=10;var ap=function(){};ap.SIZE=4*(ap.COUNT=4+(ap.JOINTS_TEXTURE_INFO_OFFSET=0)),ap.NAME="CCSkinningTexture",ap.BINDING=Dd.UBO_SKINNING_TEXTURE,ap.DESCRIPTOR=new Hr(ap.BINDING,Wi.UNIFORM_BUFFER,1,Ni.VERTEX),ap.LAYOUT=new br(Bd.LOCAL,ap.BINDING,ap.NAME,[new Ar("cc_jointTextureInfo",pi.FLOAT4,1)],1),Rd.layouts[ap.NAME]=ap.LAYOUT,Rd.bindings[ap.BINDING]=ap.DESCRIPTOR;var sp=function(){};sp.SIZE=4*(sp.COUNT=4+(sp.JOINTS_ANIM_INFO_OFFSET=0)),sp.NAME="CCSkinningAnimation",sp.BINDING=Dd.UBO_SKINNING_ANIMATION,sp.DESCRIPTOR=new Hr(sp.BINDING,Wi.UNIFORM_BUFFER,1,Ni.VERTEX),sp.LAYOUT=new br(Bd.LOCAL,sp.BINDING,sp.NAME,[new Ar("cc_jointAnimInfo",pi.FLOAT4,1)],1),Rd.layouts[sp.NAME]=sp.LAYOUT,Rd.bindings[sp.BINDING]=sp.DESCRIPTOR;var cp=function(){};cp.SIZE=4*(cp.COUNT=360+(cp.JOINTS_OFFSET=0)),cp.NAME="CCSkinning",cp.BINDING=Dd.UBO_SKINNING_TEXTURE,cp.DESCRIPTOR=new Hr(cp.BINDING,Wi.UNIFORM_BUFFER,1,Ni.VERTEX),cp.LAYOUT=new br(Bd.LOCAL,cp.BINDING,cp.NAME,[new Ar("cc_joints",pi.FLOAT4,90)],1),Rd.layouts[cp.NAME]=cp.LAYOUT,Rd.bindings[cp.BINDING]=cp.DESCRIPTOR;var lp=function(){};lp.MAX_MORPH_TARGET_COUNT=60,lp.OFFSET_OF_WEIGHTS=0,lp.OFFSET_OF_VERTICES_COUNT=4+(lp.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(lp.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*lp.MAX_MORPH_TARGET_COUNT)),lp.COUNT_BASE_4_BYTES=4*Math.ceil(lp.MAX_MORPH_TARGET_COUNT/4)+4,lp.SIZE=4*lp.COUNT_BASE_4_BYTES,lp.NAME="CCMorph",lp.BINDING=Dd.UBO_MORPH,lp.DESCRIPTOR=new Hr(lp.BINDING,Wi.UNIFORM_BUFFER,1,Ni.VERTEX),lp.LAYOUT=new br(Bd.LOCAL,lp.BINDING,lp.NAME,[new Ar("cc_displacementWeights",pi.FLOAT4,lp.MAX_MORPH_TARGET_COUNT/4),new Ar("cc_displacementTextureInfo",pi.FLOAT4,1)],1),Rd.layouts[lp.NAME]=lp.LAYOUT,Rd.bindings[lp.BINDING]=lp.DESCRIPTOR;var up=function(){};up.NAME="CCUILocal",up.BINDING=Dd.UBO_UI_LOCAL,up.DESCRIPTOR=new Hr(up.BINDING,Wi.DYNAMIC_UNIFORM_BUFFER,1,Ni.VERTEX),up.LAYOUT=new br(Bd.LOCAL,up.BINDING,up.NAME,[new Ar("cc_local_data",pi.FLOAT4,1)],1),Rd.layouts[up.NAME]=up.LAYOUT,Rd.bindings[up.BINDING]=up.DESCRIPTOR;var hp=Dd.SAMPLER_JOINTS,_p=new Hr(hp,Wi.SAMPLER_TEXTURE,1,Ni.VERTEX),fp=new Tr(Bd.LOCAL,hp,"cc_jointTexture",pi.SAMPLER2D,1);Rd.layouts.cc_jointTexture=fp,Rd.bindings[hp]=_p;var dp=Dd.SAMPLER_MORPH_POSITION,pp=new Hr(dp,Wi.SAMPLER_TEXTURE,1,Ni.VERTEX),mp=new Tr(Bd.LOCAL,dp,"cc_PositionDisplacements",pi.SAMPLER2D,1);Rd.layouts.cc_PositionDisplacements=mp,Rd.bindings[dp]=pp;var vp=Dd.SAMPLER_MORPH_NORMAL,gp=new Hr(vp,Wi.SAMPLER_TEXTURE,1,Ni.VERTEX),yp=new Tr(Bd.LOCAL,vp,"cc_NormalDisplacements",pi.SAMPLER2D,1);Rd.layouts.cc_NormalDisplacements=yp,Rd.bindings[vp]=gp;var xp=Dd.SAMPLER_MORPH_TANGENT,Sp=new Hr(xp,Wi.SAMPLER_TEXTURE,1,Ni.VERTEX),Cp=new Tr(Bd.LOCAL,xp,"cc_TangentDisplacements",pi.SAMPLER2D,1);Rd.layouts.cc_TangentDisplacements=Cp,Rd.bindings[xp]=Sp;var Ap=Dd.SAMPLER_LIGHTMAP,bp=new Hr(Ap,Wi.SAMPLER_TEXTURE,1,Ni.FRAGMENT),Tp=new Tr(Bd.LOCAL,Ap,"cc_lightingMap",pi.SAMPLER2D,1);Rd.layouts.cc_lightingMap=Tp,Rd.bindings[Ap]=bp;var Ep=Dd.SAMPLER_SPRITE,wp=new Hr(Ep,Wi.SAMPLER_TEXTURE,1,Ni.FRAGMENT),Ip=new Tr(Bd.LOCAL,Ep,"cc_spriteTexture",pi.SAMPLER2D,1);Rd.layouts.cc_spriteTexture=Ip,Rd.bindings[Ep]=wp;var Pp=Dd.SAMPLER_REFLECTION,Rp=new Hr(Pp,Wi.SAMPLER_TEXTURE,1,Ni.FRAGMENT),Dp=new Tr(Bd.LOCAL,Pp,"cc_reflectionTexture",pi.SAMPLER2D,1);Rd.layouts.cc_reflectionTexture=Dp,Rd.bindings[Pp]=Rp;var Op=Dd.STORAGE_REFLECTION,Np=new Hr(Op,Wi.STORAGE_IMAGE,1,Ni.COMPUTE),Bp=new Ir(Bd.LOCAL,Op,"cc_reflectionStorage",pi.IMAGE2D,1);Rd.layouts.cc_reflectionStorage=Bp,Rd.bindings[Op]=Np;var Mp,Lp,Fp=Cd.makeMaskExclude([Cd.BitMask.UI_2D,Cd.BitMask.GIZMOS,Cd.BitMask.EDITOR,Cd.BitMask.SCENE_GIZMO,Cd.BitMask.PROFILER]),zp=Cd.makeMaskExclude([Cd.BitMask.UI_2D,Cd.BitMask.PROFILER]),Vp=Cd.Enum.ALL;function Gp(e){return(e.getFormatFeatures(fi.R32F)&(Ai.RENDER_TARGET|Ai.SAMPLED_TEXTURE))==(Ai.RENDER_TARGET|Ai.SAMPLED_TEXTURE)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:Td,PIPELINE_FLOW_FORWARD:Ed,PIPELINE_FLOW_SHADOW:wd,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return Ad},get RenderPriority(){return bd},globalDescriptorSetLayout:Pd,localDescriptorSetLayout:Rd,get PipelineGlobalBindings(){return Id},get ModelLocalBindings(){return Dd},get SetIndex(){return Bd},bindingMappingInfo:zd,UBOGlobal:Vd,UBOCamera:Gd,UBOShadow:Ud,UNIFORM_SHADOWMAP_BINDING:kd,UNIFORM_ENVIRONMENT_BINDING:Wd,UNIFORM_DIFFUSEMAP_BINDING:Yd,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:Qd,UBOLocal:ep,UBOWorldBound:tp,INST_MAT_WORLD:np,UBOLocalBatched:ip,UBOForwardLight:rp,UBODeferredLight:op,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:ap,UBOSkinningAnimation:sp,INST_JOINT_ANIM_INFO:"a_jointAnimInfo",UBOSkinning:cp,UBOMorph:lp,UBOUILocal:up,UNIFORM_JOINT_TEXTURE_BINDING:hp,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:dp,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:vp,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:xp,UNIFORM_LIGHTMAP_TEXTURE_BINDING:Ap,UNIFORM_SPRITE_TEXTURE_BINDING:Ep,UNIFORM_REFLECTION_TEXTURE_BINDING:Pp,UNIFORM_REFLECTION_STORAGE_BINDING:Op,CAMERA_DEFAULT_MASK:Fp,CAMERA_EDITOR_MASK:zp,MODEL_ALWAYS_MASK:Vp,supportsR16HalfFloatTexture:function(e){return(e.getFormatFeatures(fi.R16F)&(Ai.RENDER_TARGET|Ai.SAMPLED_TEXTURE))==(Ai.RENDER_TARGET|Ai.SAMPLED_TEXTURE)},supportsR32FloatTexture:Gp}));var Up=4227858432,kp=66060288,Hp=1044480,jp=function(e,t,n,i){return void 0===i&&(i=0),t<<26&Up|e<<20&kp|n<<12&Hp|4095&i},Wp=function(e){return(e&Up)>>>26},qp=function(e){return(e&kp)>>>20},Xp=function(e){return(e&Hp)>>>12},Yp=function(e){return 4095&e},Kp=function(e,t){return 67108863&e|t<<26&Up},Jp=((Mp={})[pi.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Mp[pi.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]},Mp[pi.INT2]=function(e,t,n){return void 0===n&&(n=0),Yn.fromArray(t,e,n)},Mp[pi.INT3]=function(e,t,n){return void 0===n&&(n=0),Pn.fromArray(t,e,n)},Mp[pi.INT4]=function(e,t,n){return void 0===n&&(n=0),Zn.fromArray(t,e,n)},Mp[pi.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]},Mp[pi.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Yn.fromArray(t,e,n)},Mp[pi.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),Pn.fromArray(t,e,n)},Mp[pi.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Zn.fromArray(t,e,n)},Mp[pi.MAT3]=function(e,t,n){return void 0===n&&(n=0),Nn.fromArray(t,e,n)},Mp[pi.MAT4]=function(e,t,n){return void 0===n&&(n=0),jn.fromArray(t,e,n)},Mp),Qp=((Lp={})[pi.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Lp[pi.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Lp[pi.INT2]=function(e,t,n){return void 0===n&&(n=0),Yn.toArray(e,t,n)},Lp[pi.INT3]=function(e,t,n){return void 0===n&&(n=0),Pn.toArray(e,t,n)},Lp[pi.INT4]=function(e,t,n){return void 0===n&&(n=0),Zn.toArray(e,t,n)},Lp[pi.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Lp[pi.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Yn.toArray(e,t,n)},Lp[pi.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),Pn.toArray(e,t,n)},Lp[pi.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),Zn.toArray(e,t,n)},Lp[pi.MAT3]=function(e,t,n){return void 0===n&&(n=0),Nn.toArray(e,t,n)},Lp[pi.MAT4]=function(e,t,n){return void 0===n&&(n=0),jn.toArray(e,t,n)},Lp),Zp=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function $p(e){switch(e){case pi.BOOL:case pi.INT:case pi.UINT:case pi.FLOAT:return Zp[0];case pi.BOOL2:case pi.INT2:case pi.UINT2:case pi.FLOAT2:return Zp[1];case pi.BOOL4:case pi.INT4:case pi.UINT4:case pi.FLOAT4:return Zp[2];case pi.MAT4:return Zp[3];case pi.SAMPLER2D:return"default-texture";case pi.SAMPLER_CUBE:return"default-cube-texture"}return Zp[0]}function em(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var tm=new jr;function nm(e){return Math.ceil(Math.log2(Math.max(e,2)))}function im(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function rm(e,t,n,i,r){for(var o=e.builtins[i],a=[],s=function(e){var t=o.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&io))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.shaderInfo.blocks,a);for(var l=[],u=function(e){var t=o.samplerTextures[e],i=n.layouts[t.name],a=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&a&&a.descriptorType&ro))return console.warn("builtin samplerTexture '"+t.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,l),r&&r.sort((function(e,t){return e.binding-t.binding}))}function om(e){return e.members.reduce((function(e,t){return e+uo(t.type)*t.count}),0)}function am(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function sm(e){switch(e.gfxAPI){case ui.GLES2:case ui.WEBGL:return"glsl1";case ui.GLES3:case ui.WEBGL2:return"glsl3";default:return"glsl4"}}var cm,lm,um,hm,_m,fm,dm,pm,mm=new(function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var n=0;n<e.techniques.length;n++)for(var i=e.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=Q({},e),i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var o=t.range;r=nm(o[1]-o[0]+1),t._map=function(e){return e-o[0]}}else"string"===t.type?(r=nm(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Nr,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(om(l)),s.bindings.push(new Hr(l.binding,Wi.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new br(Bd.MATERIAL,l.binding,l.name,l.members.map((function(e){return new Ar(e.name,e.type,e.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new Hr(h.binding,Wi.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new Tr(Bd.MATERIAL,h.binding,h.name,h.type,h.count))}for(var _=0;_<n.samplers.length;_++){var f=n.samplers[_];s.bindings.push(new Hr(f.binding,Wi.SAMPLER,f.count,f.stageFlags)),s.shaderInfo.samplers.push(new Er(Bd.MATERIAL,f.binding,f.name,f.count))}for(var d=0;d<n.textures.length;d++){var p=n.textures[d];s.bindings.push(new Hr(p.binding,Wi.TEXTURE,p.count,p.stageFlags)),s.shaderInfo.textures.push(new wr(Bd.MATERIAL,p.binding,p.name,p.type,p.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new Hr(v.binding,Wi.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new Pr(Bd.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new Hr(y.binding,Wi.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new Ir(Bd.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var x=0;x<n.subpassInputs.length;x++){var S=n.subpassInputs[x];s.bindings.push(new Hr(S.binding,Wi.INPUT_ATTACHMENT,S.count,S.stageFlags)),s.shaderInfo.subpassInputs.push(new Rr(Bd.MATERIAL,S.binding,S.name,S.count))}s.gfxAttributes=[];for(var C=0;C<n.attributes.length;C++){var A=n.attributes[C];s.gfxAttributes.push(new Or(A.name,A.format,A.isNormalized,0,A.isInstanced,A.location))}rm(n,s,Rd,"locals"),s.shaderInfo.stages.push(new Dr(Ni.VERTEX,"")),s.shaderInfo.stages.push(new Dr(Ni.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];t[s.name]=jp(i.binding,s.type,s.count,o),o+=(uo(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=jp(l.binding,l.type,l.count)}return t}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,n){void 0===n&&(n=!1);var i=this._templates[t],r=this._templateInfos[i.hash];return r.setLayouts.length||(tm.bindings=r.bindings,r.setLayouts[Bd.MATERIAL]=e.createDescriptorSetLayout(tm),tm.bindings=Rd.bindings,r.setLayouts[Bd.LOCAL]=e.createDescriptorSetLayout(tm)),r.setLayouts[n?Bd.LOCAL:Bd.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=t[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],_=t[h.name];_&&h._map&&(l|=h._map(_)<<h._offset)}return l.toString(16)+"|"+n.hash},t.destroyShaderByDefines=function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(t._cache[e].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];A("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},t.getGFXShader=function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var o=this._cache[r];if(o)return o;var a=this._templates[t],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(e,t),rm(a,s,Pd,"globals"),s.setLayouts[Bd.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new qr(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=r.name,a=e[o],s=im(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),u=a.glsl3,h=sm(e);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(e,t,n){for(var i=[],r=e.attributes,o=t.gfxAttributes,a=0;a<r.length;a++)am(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,c),this._cache[r]=e.createShader(s.shaderInfo)},e}());l.programLib=mm;var vm=e("EffectAsset",Ac("cc.EffectAsset")((pm=dm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"techniques",um,re(t)),se(t,"shaders",hm,re(t)),se(t,"combinations",_m,re(t)),se(t,"hideInEditor",fm,re(t)),t}Z(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name]===e&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}},t.get=function(e){if(t._effects[e])return t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null},t.getAll=function(){return t._effects};var n=t.prototype;return n.onLoaded=function(){mm.register(this),t.register(this),l.game.once(l.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var e=this,t=l.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){for(var i=r[t],o=0;o<i.length;++o){var a=Q({},n);a[t]=i[o],e.push(a)}return e}),[])}),[{}]).forEach((function(e){return mm.getGFXShader(t.device,i.name,e,t.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)},n.destroy=function(){return t.remove(this),e.prototype.destroy.call(this)},n.initDefault=function(n){e.prototype.initDefault.call(this,n);var i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(Iu),dm._effects={},um=ce((lm=pm).prototype,"techniques",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hm=ce(lm.prototype,"shaders",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_m=ce(lm.prototype,"combinations",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fm=ce(lm.prototype,"hideInEditor",[Dc,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cm=lm))||cm);l.EffectAsset=vm;var gm,ym,xm,Sm,Cm,Am,bm,Tm,Em,wm,Im,Pm,Rm,Dm,Om,Nm=1024;!function(e){e[e.RGB565=fi.R5G6B5]="RGB565",e[e.RGB5A1=fi.RGB5A1]="RGB5A1",e[e.RGBA4444=fi.RGBA4]="RGBA4444",e[e.RGB888=fi.RGB8]="RGB888",e[e.RGB32F=fi.RGB32F]="RGB32F",e[e.RGBA8888=fi.RGBA8]="RGBA8888",e[e.RGBA32F=fi.RGBA32F]="RGBA32F",e[e.A8=fi.A8]="A8",e[e.I8=fi.L8]="I8",e[e.AI8=fi.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=fi.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=fi.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=Nm++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=fi.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=fi.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=Nm++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=fi.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=Nm++]="RGBA_ETC1",e[e.RGB_ETC2=fi.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=fi.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=fi.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=fi.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=fi.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=fi.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=fi.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=fi.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=fi.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=fi.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=fi.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=fi.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=fi.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=fi.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=fi.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=fi.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(gm||(gm={})),function(e){e[e.REPEAT=wi.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=wi.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=wi.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=wi.BORDER]="CLAMP_TO_BORDER"}(ym||(ym={})),function(e){e[e.NONE=Ei.NONE]="NONE",e[e.LINEAR=Ei.LINEAR]="LINEAR",e[e.NEAREST=Ei.POINT]="NEAREST"}(xm||(xm={})),st(fi);var Bm,Mm,Lm,Fm,zm=new pe("Tex"),Vm=Ac("cc.TextureBase")((Om=Dm=function(e){function t(){var t;return se(t=e.call(this)||this,"_format",Am,re(t)),se(t,"_minFilter",bm,re(t)),se(t,"_magFilter",Tm,re(t)),se(t,"_mipFilter",Em,re(t)),se(t,"_wrapS",wm,re(t)),se(t,"_wrapT",Im,re(t)),se(t,"_wrapR",Pm,re(t)),se(t,"_anisotropy",Rm,re(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=new Cr,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=zm.getNewId(),t._gfxDevice=t._getGFXDevice(),t._textureHash=So(t._id,666),t}Z(t,e);var n=t.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(e,t,n){void 0===n&&(n=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var t,n=e.prototype.destroy.call(this);return n&&(null===(t=l.director.root)||void 0===t?void 0:t.batcher2D)&&l.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):O(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},n._getGFXDevice=function(){return l.director.root?l.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(e){this._format=void 0===e?gm.RGBA8888:e},n._getGFXPixelFormat=function(e){return e===gm.RGBA_ETC1?e=gm.RGB_ETC1:e===gm.RGB_A_PVRTC_4BPPV1?e=gm.RGB_PVRTC_4BPPV1:e===gm.RGB_A_PVRTC_2BPPV1&&(e=gm.RGB_PVRTC_2BPPV1),e},J(t,[{key:"isCompressed",get:function(){return this._format>=gm.RGB_ETC1&&this._format<=gm.RGBA_ASTC_12x12||this._format>=gm.RGB_A_PVRTC_2BPPV1&&this._format<=gm.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(Iu),Dm.PixelFormat=gm,Dm.WrapMode=ym,Dm.Filter=xm,Am=ce((Cm=Om).prototype,"_format",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gm.RGBA8888}}),bm=ce(Cm.prototype,"_minFilter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xm.LINEAR}}),Tm=ce(Cm.prototype,"_magFilter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xm.LINEAR}}),Em=ce(Cm.prototype,"_mipFilter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xm.NONE}}),wm=ce(Cm.prototype,"_wrapS",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ym.REPEAT}}),Im=ce(Cm.prototype,"_wrapT",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ym.REPEAT}}),Pm=ce(Cm.prototype,"_wrapR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ym.REPEAT}}),Rm=ce(Cm.prototype,"_anisotropy",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Sm=Cm))||Sm;function Gm(e){return!!(l.sys.hasFeature(l.sys.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}l.TextureBase=Vm;var Um=e("ImageAsset",Ac("cc.ImageAsset")((Fm=Lm=function(e){function t(t){var n;return(n=e.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=gm.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&n.reset(t),n}Z(t,e);var n=t.prototype;return n.reset=function(e){Gm(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):Gm(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(e){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var i,r=l.director.root?l.director.root.device:null,o=n.split("_"),a=Number.MAX_VALUE,s=this._format,c="",u=l.macro.SUPPORT_TEXTURE_FORMATS,h=ae(o);!(i=h()).done;){var _=i.value.split("@"),f=parseInt(_[0],void 0),d=t.extnames[f]||_[0],p=u.indexOf(d);if(-1!==p&&p<a){var m=_[1]?parseInt(_[1]):this._format;if(!(".astc"!==d||r&&r.getFormatFeatures(fi.ASTC_RGBA_4X4)&Ai.SAMPLED_TEXTURE))continue;if(!(".pvr"!==d||r&&r.getFormatFeatures(fi.PVRTC_RGBA4)&Ai.SAMPLED_TEXTURE))continue;if(!(m!==gm.RGB_ETC1&&m!==gm.RGBA_ETC1||r&&r.getFormatFeatures(fi.ETC_RGB8)&Ai.SAMPLED_TEXTURE))continue;if(!(m!==gm.RGB_ETC2&&m!==gm.RGBA_ETC2||r&&r.getFormatFeatures(fi.ETC2_RGB8)&Ai.SAMPLED_TEXTURE))continue;if(".webp"===d&&!l.sys.hasFeature(l.sys.Feature.WEBP))continue;a=p,c=d,s=m}}c?(this._setRawAsset(c),this._format=s):R(3121)},n.initDefault=function(n){if(e.prototype.initDefault.call(this,n),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),t._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},J(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||Gm(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||Gm(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=gm.RGB_ETC1&&this._format<=gm.RGBA_ASTC_12x12||this._format>=gm.RGB_A_PVRTC_2BPPV1&&this._format<=gm.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),t}(Iu),Lm.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Lm._sharedPlaceHolderCanvas=null,ce((Mm=Fm).prototype,"_nativeAsset",[sl],Object.getOwnPropertyDescriptor(Mm.prototype,"_nativeAsset"),Mm.prototype),Bm=Mm))||Bm);l.ImageAsset=Um;var km=new WeakMap,Hm=new WeakSet,jm=new WeakSet;function Wm(e,t){var n;n=Zu.safeFindClass;var i,r=xh.pool.get();try{i=Oh(e,r,{classFinder:n,customEnv:t})}catch(e){throw S(e),xh.pool.put(r),e}i._uuid=t.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:Nl(h),owner:a[u],prop:s[u],type:nt._getClassById(c[u])}}return km.set(i,l),i._native&&Hm.add(i),xh.pool.put(r),i}var qm,Xm=new(function(){function e(){this._depends=new ml}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?Q({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var n,i,r=null;if(Array.isArray(t)||t.__type__||t instanceof ch){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var o=Wm(t,{__uuid__:e});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=e),Sl.add(e+"@import",o)}catch(t){xl.remove(e+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=km.get(e),i=0,r=n.length;i<r;i++)t.deps.push(n[i].uuid);return Hm.has(e)&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=function(e){return n=(t=e)[1],t[10].map((function(e){return n[e]}));var t,n}(e);return t.forEach((function(e,n){return t[n]=Nl(e)})),t},t._descend=function(e,t,n){for(var i=this.getDeps(e),r=0;r<i.length;r++){var o=i[r];t[o]||(t[o]=!0,n.push(o),this._descend(o,t,n))}},e}()),Ym=[new lr];function Km(e){return e&&0==(e&e-1)}var Jm,Qm,Zm,$m,ev,tv,nv=Ac("cc.SimpleTexture")(qm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gfxTexture=null,t._gfxTextureView=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t._baseLevel=0,t._maxLevel=1e3,t}Z(t,e);var n=t.prototype;return n.getGFXTexture=function(){return this._gfxTextureView},n.destroy=function(){return this._tryDestroyTextureView(),this._tryDestroyTexture(),e.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var r=Ym[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,Ym):i.copyTexImagesToTexture([e],this._gfxTexture,Ym)}}},n._assignImage=function(e,t,n){var i=e.data;if(i&&(this.uploadData(i,t,n),this._checkTextureLoaded(),lt.CLEANUP_IMAGE_CACHE)){var r=Xm.getDeps(this._uuid),o=r.indexOf(e._uuid);-1!==o&&(he(r,o),e.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},n._setMipRange=function(e,t){this._baseLevel=e<1?0:e,this._maxLevel=t<1?0:t},n.setMipRange=function(e,t){M(e<=t,3124),this._setMipRange(e,t);var n=this._getGFXDevice();if(n){var i=this._createTextureView(n);this._tryDestroyTextureView(),this._gfxTextureView=i}},n._getGfxTextureCreateInfo=function(){return null},n._getGfxTextureViewCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTextureView(),this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&(this._createTexture(e),this._gfxTextureView=this._createTextureView(e))}},n._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=Ci.NONE;this._mipFilter!==xm.NONE&&function(e,t,n){return!(e.gfxAPI===ui.WEBGL)||Km(t)&&Km(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=Ci.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Si.SAMPLED|Si.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._createTextureView=function(e){if(!this._gfxTexture)return null;var t=this._maxLevel<this._mipmapLevel?this._maxLevel:this._mipmapLevel-1,n=this._getGfxTextureViewCreateInfo({texture:this._gfxTexture,format:this._getGFXFormat(),baseLevel:this._baseLevel,levelCount:t-this._baseLevel+1});return n?e.createTexture(n):null},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},n._tryDestroyTextureView=function(){this._gfxTextureView&&(this._gfxTextureView.destroy(),this._gfxTextureView=null)},J(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(Vm))||qm;l.SimpleTexture=nv;var iv,rv,ov,av,sv,cv,lv,uv=e("Texture2D",(Jm=Ac("cc.Texture2D"),Qm=ol([Um]),Jm((tv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",ev,re(t)),t}Z(t,e);var n=t.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var n=void 0===e.baseLevel?0:e.baseLevel,i=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(n,i),this._tryReset()},n.create=function(e,t,n,i,r,o){void 0===n&&(n=gm.RGBA8888),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=1e3),this.reset({width:e,height:t,format:n,mipmapLevel:i,baseLevel:r,maxLevel:o})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new Um,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,nt._getClassId(Um))}},n._getGfxTextureCreateInfo=function(e){var t=new xr(xi.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e),t},n._getGfxTextureViewCreateInfo=function(e){var t=new Sr;return t.type=xi.TEX2D,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Um;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},J(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(nv),ev=ce(($m=tv).prototype,"_mipmaps",[Qm],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zm=$m))||Zm));l.Texture2D=uv,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(lv||(lv={}));var hv=e("TextureCube",Ac("cc.TextureCube")((cv=sv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"isRGBE",ov,re(t)),se(t,"_mipmaps",av,re(t)),t}Z(t,e),t.fromTexture2DArray=function(e,n){for(var i=[],r=e.length/6,o=0;o<r;o++){var a=6*o;i.push({front:e[a+lv.front].image,back:e[a+lv.back].image,left:e[a+lv.left].image,right:e[a+lv.right].image,top:e[a+lv.top].image,bottom:e[a+lv.bottom].image})}return(n=n||new t).mipmaps=i,n};var n=t.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format);var t=void 0===e.mipmapLevel?1:e.mipmapLevel;this._setMipmapLevel(t);var n=void 0===e.baseLevel?0:e.baseLevel,i=void 0===e.maxLevel?1e3:e.maxLevel;this._setMipRange(n,i),this._tryReset()},n.updateMipmaps=function(e,t){var n=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),r=function(t){var i=e+t;_v(n._mipmaps[i],(function(e,t){n._assignImage(e,i,t)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new Um,back:new Um,left:new Um,right:new Um,top:new Um,bottom:new Um};var o=i.mipmaps[r],a=nt._getClassId(Um);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(e){var t=new xr(xi.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},n._getGfxTextureViewCreateInfo=function(e){var t=new Sr;return t.type=xi.CUBE,t.baseLayer=0,t.layerCount=6,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Um;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},J(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel}),this._mipmaps.forEach((function(e,n){_v(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length,baseLevel:this._baseLevel,maxLevel:this._maxLevel})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(nv),sv.FaceIndex=lv,ov=ce((rv=cv).prototype,"isRGBE",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),av=ce(rv.prototype,"_mipmaps",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),iv=rv))||iv);function _v(e,t){t(e.front,lv.front),t(e.back,lv.back),t(e.left,lv.left),t(e.right,lv.right),t(e.top,lv.top),t(e.bottom,lv.bottom)}l.TextureCube=hv;var fv,dv,pv,mv=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:3642336485,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:54,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"geometry-renderer",techniques:[{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|line-vs:vert|line-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{primitive:1,blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]},{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:front",priority:245,depthStencilState:{depthTest:!1,depthWrite:!1}}]},{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:front",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}},{rasterizerState:{cullMode:2},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"geometry-renderer|triangle-vs:vert|triangle-fs:back",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1,depthFunc:4}}]}],shaders:[{name:"geometry-renderer|line-vs:vert|line-fs:front",hash:3617431e3,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|line-vs:vert|line-fs:back",hash:4168905198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:front",hash:4034582016,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|dashed-line-vs:vert|dashed-line-fs:back",hash:1762165009,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|triangle-vs:vert|triangle-fs:front",hash:4143142643,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:44,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"geometry-renderer|triangle-vs:vert|triangle-fs:back",hash:826026446,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_FORWARD_PIPELINE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:44,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:4284763886,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:851293782,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:64,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:2502358098,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:585841727,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:2499219289,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:67215139,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},specularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrength:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4079105024,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:223,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:75},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["CC_USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:14},{name:"a_texCoord1",defines:[],format:21,location:15}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3928335406,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:184,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:75},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3669699677,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:71,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:71},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["CC_USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:2218105608,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:69,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3152709001,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:198,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:14}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:837263906,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:682261797,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3663548873,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:670444562,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:2587574837,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:69},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2},{name:"depth_stencil",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:3542426468,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:217,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:2960965003,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:2207113861,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"CC_USE_LIGHTMAP",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["USE_INSTANCING","CC_USE_BAKED_ANIMATION"],format:44,isInstanced:!0,location:6},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","CC_USE_LIGHTMAP"],format:44,isInstanced:!0,location:10},{name:"a_localShadowBias",defines:["USE_INSTANCING","CC_RECEIVE_SHADOW"],format:21,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:13}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),vv={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 front() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvarying float v_distance;\nvec4 back() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_normal;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nvoid main() { gl_FragColor = front(); }"},{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute highp vec3 a_position;\nattribute vec4 a_normal;\nattribute vec4 a_color;\nvarying vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nvoid main() { gl_FragColor = back(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\nuniform highp vec4 cc_localShadowBias;\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\nvec2 CCGetShadowBias()\n{\n#if USE_INSTANCING\nreturn vec2(a_localShadowBias.x + cc_shadowWHPBInfo.w, a_localShadowBias.y + cc_shadowLPNNInfo.z);\n#elif !USE_BATCHING\nreturn vec2(cc_localShadowBias.x + cc_shadowWHPBInfo.w, cc_localShadowBias.y + cc_shadowLPNNInfo.z);\n#else\nreturn vec2(cc_shadowWHPBInfo.w, cc_shadowLPNNInfo.z);\n#endif\n}\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying mediump vec3 v_normal;\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying mediump vec2 v_uv1;\n#endif\n#if CC_RECEIVE_SHADOW\nvarying mediump vec2 v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvarying mediump vec4 v_tangent;\n#endif\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.z;\nv_luv.z = cc_lightingMapUVParam.w;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.z;\nv_luv.z = a_lightingMapUVParam.w;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if CC_RECEIVE_SHADOW\nv_shadowBias = CCGetShadowBias();\n#endif\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent.xyz = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_tangent.w = In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying mediump vec2 v_uv1;\n#endif\nvarying mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nvarying mediump vec2 v_shadowBias;\n#endif\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying mediump vec4 v_tangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = lightColor.xyz * v_luv.z;\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\nvec3 bitangent = cross(v_normal, v_tangent.xyz) * v_tangent.w;\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent.xyz) +\n(nmmp.y * emissiveScaleParam.w) * normalize(bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.specularIntensity = 0.5;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying vec2 v_uv1;\n#endif\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\n#if HAS_SECOND_UV\nvarying vec2 v_uv1;\n#endif\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\n#if CC_RECEIVE_SHADOW\nvarying vec2 v_shadowBias;\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if CC_USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.z;\nluv.z = lightMapUVParam.w;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if CC_RECEIVE_SHADOW\nv_shadowBias = vec2(0.0, 0.0);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nvarying vec2 v_shadowBias;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 tangent = vec3(1.0, 0.0, 0.0);\nvec3 binormal = vec3(0.0, 0.0, 1.0);\nbinormal = cross(tangent, v_normal);\ntangent = cross(v_normal, binormal);\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(tangent) +\nnmmp.y * normalize(binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#if LAYERS == 1\ns.specularIntensity = 0.5;\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = lightColor.xyz * luv.z;\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nuniform sampler2D depth_stencil;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragData[2];\nfloat depth = texture2D(depth_stencil, v_uv).x;\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\nfloat depth = texture2D(depth_stencil, v_uv).x;\n#endif\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.specularIntensity = 0.5;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if !USE_INSTANCING\n#if USE_BATCHING\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nattribute highp vec4 a_jointAnimInfo;\n#endif\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nattribute vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nattribute float a_vertexId;\n#endif\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nout float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nin float v_distance;\nvec4 front() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nout float v_distance;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\npos.z -= 0.000001;\nv_color = a_color;\nv_distance = dot(a_position, vec3(1.0, 1.0, 1.0));\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nin float v_distance;\nvec4 back() {\nif (fract(v_distance) > 0.5) {\ndiscard;\n}\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_normal;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 front() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(v_color);\n#else\nreturn v_color;\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = front(); }"},{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin highp vec3 a_position;\nin vec4 a_normal;\nin vec4 a_color;\nout vec4 v_color;\nvec4 vert () {\nvec4 pos = cc_matViewProj * vec4(a_position, 1);\nv_color = a_color;\nfloat intensity = dot(vec3(1, 2, 4), a_normal.xyz);\nv_color.rgb -= a_normal.w * intensity * 0.1;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec4 v_color;\nvec4 back() {\n#if USE_FORWARD_PIPELINE\nreturn CCFragOutput(vec4(v_color.rgb, v_color.a * 0.2));\n#else\nreturn vec4(v_color.rgb, v_color.a * 0.2);\n#endif\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = back(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#if SAMPLE_FROM_RT\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\nvec2 CCGetShadowBias()\n{\n#if USE_INSTANCING\nreturn vec2(a_localShadowBias.x + cc_shadowWHPBInfo.w, a_localShadowBias.y + cc_shadowLPNNInfo.z);\n#elif !USE_BATCHING\nreturn vec2(cc_localShadowBias.x + cc_shadowWHPBInfo.w, cc_localShadowBias.y + cc_shadowLPNNInfo.z);\n#else\nreturn vec2(cc_shadowWHPBInfo.w, cc_shadowLPNNInfo.z);\n#endif\n}\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout lowp vec4 v_color;\n#endif\nout vec3 v_position;\nout mediump vec3 v_normal;\nout vec2 v_uv;\n#if HAS_SECOND_UV\nout mediump vec2 v_uv1;\n#endif\n#if CC_RECEIVE_SHADOW\nout mediump vec2 v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nout mediump vec4 v_tangent;\n#endif\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.z;\nv_luv.z = cc_lightingMapUVParam.w;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.z;\nv_luv.z = a_lightingMapUVParam.w;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if CC_RECEIVE_SHADOW\nv_shadowBias = CCGetShadowBias();\n#endif\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent.xyz = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_tangent.w = In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nin vec3 v_position;\nin vec2 v_uv;\n#if HAS_SECOND_UV\nin mediump vec2 v_uv1;\n#endif\nin mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nin mediump vec2 v_shadowBias;\n#endif\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin mediump vec4 v_tangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = lightColor.xyz * v_luv.z;\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\nvec3 bitangent = cross(v_normal, v_tangent.xyz) * v_tangent.w;\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent.xyz) +\n(nmmp.y * emissiveScaleParam.w) * normalize(bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.specularIntensity = 0.5;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrixFull(out mat4 matWorld, out mat4 matWorldIT)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\n}\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || CC_USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\n#if HAS_SECOND_UV\nout vec2 v_uv1;\n#endif\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nCCVertInput(In);\nmat4 matWorld, matWorldIT;\nCCGetWorldMatrixFull(matWorld, matWorldIT);\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\n#if HAS_SECOND_UV\nin vec2 v_uv1;\n#endif\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if CC_RECEIVE_SHADOW\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\n#if CC_RECEIVE_SHADOW\nout vec2 v_shadowBias;\n#endif\nout highp vec3 v_position;\nout mediump vec3 v_normal;\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if CC_USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.z;\nluv.z = lightMapUVParam.w;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if CC_RECEIVE_SHADOW\nv_shadowBias = vec2(0.0, 0.0);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n#endif\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if CC_RECEIVE_SHADOW\nin vec2 v_shadowBias;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 tangent = vec3(1.0, 0.0, 0.0);\nvec3 binormal = vec3(0.0, 0.0, 1.0);\nbinormal = cross(tangent, v_normal);\ntangent = cross(v_normal, binormal);\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(tangent) +\nnmmp.y * normalize(binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\n#if CC_RECEIVE_SHADOW\ns.shadowBias = v_shadowBias;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#if LAYERS == 1\ns.specularIntensity = 0.5;\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.specularIntensity = 0.5;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = lightColor.xyz * luv.z;\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal, float normalBias)\n{\nvec4 newShadowPos = shadowPos;\nif(normalBias > EPSILON_LOWP)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * normalBias * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > EPSILON) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos, float bias) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, bias);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > EPSILON) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > EPSILON) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCSpotShadowFactorBase(vec4 shadowPos, vec3 worldPos, vec2 shadowBias)\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nreturn CCGetSpotLightShadowFactorSoft2X(shadowPos, worldPos, shadowBias.x);\n}else if (pcf > 0.9) {\nreturn CCGetSpotLightShadowFactorSoft(shadowPos, worldPos, shadowBias.x);\n}else {\nreturn CCGetSpotLightShadowFactorHard(shadowPos, worldPos, shadowBias.x);\n}\n}\nfloat CCShadowFactorBase(vec4 shadowPos, vec3 N, vec2 shadowBias)\n{\nfloat realtimeShadow = 1.0;\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N, shadowBias.y);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) {\nrealtimeShadow =  CCGetShadowFactorSoft2X(pos, shadowBias.x);\n}else if (pcf > 0.9) {\nrealtimeShadow = CCGetShadowFactorSoft(pos, shadowBias.x);\n}else {\nrealtimeShadow = CCGetShadowFactorHard(pos, shadowBias.x);\n}\nreturn mix(realtimeShadow, 1.0, cc_shadowNFLSInfo.w);\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\nfloat specularIntensity;\n#if CC_RECEIVE_SHADOW\nvec2 shadowBias;\n#endif\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.08 * s.specularIntensity), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse / PI;\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\nshadow = CCShadowFactorBase(shadowPos, N, s.shadowBias);\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\n#if CC_USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > EPSILON_LOWP) {\nfinalColor = diffuse * s.lightmap.rgb * shadow;\n}\n#endif\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n#define LIGHTS_PER_PASS 1\n#else\n#define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = litRadiusSqr / max(litRadiusSqr, distSqr);\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / PI;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = PI * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\nshadow = CCSpotShadowFactorBase(shadowPos, position, s.shadowBias);\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\nuniform sampler2D depth_stencil;\n#endif\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\nfloat depth = texture(depth_stencil, v_uv).x;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\nfloat depth = texture(depth_stencil, v_uv).x;\n#endif\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.specularIntensity = 0.5;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout vec4 In)\n{\nIn = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if !USE_INSTANCING\n#if USE_BATCHING\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\nhighp vec4 cc_localShadowBias;\n};\n#endif\n#endif\nvoid CCGetWorldMatrix(out mat4 matWorld)\n{\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nCCVertInput(position);\nmat4 matWorld;\nCCGetWorldMatrix(matWorld);\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\n#endif\n#if CC_USE_MORPH\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nnormal.xyz = normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\ntangent.xyz = tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n#if CC_USE_BAKED_ANIMATION\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\nvoid CCGetJointTextureCoords(float pixelsPerJoint, float jointIdx, out highp float x, out highp float y, out highp float invSize)\n{\n#if USE_INSTANCING\nhighp float temp = pixelsPerJoint * (a_jointAnimInfo.x * a_jointAnimInfo.y + jointIdx) + a_jointAnimInfo.z;\n#else\nhighp float temp = pixelsPerJoint * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + jointIdx) + cc_jointTextureInfo.z;\n#endif\ninvSize = cc_jointTextureInfo.w;\nhighp float tempY = floor(temp * invSize);\nx = floor(temp - tempY * cc_jointTextureInfo.x);\ny = (tempY + 0.5) * invSize;\n}\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(3.0, i, x, y, invSize);\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\nhighp float x, y, invSize;\nCCGetJointTextureCoords(12.0, i, x, y, invSize);\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout vec4 position, inout vec3 normal, inout vec4 tangent) {\nmat4 m = skinMatrix();\nposition = m * position;\nnormal = (m * vec4(normal, 0.0)).xyz;\ntangent.xyz = (m * vec4(tangent.xyz, 0.0)).xyz;\n}\n#endif\nvoid CCVertInput(inout StandardVertInput In)\n{\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In.position, In.normal, In.tangent);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In.position, In.normal, In.tangent);\n#endif\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nCCVertInput(In);\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#define QUATER_PI         0.78539816340\n#define HALF_PI           1.57079632679\n#define PI                3.14159265359\n#define PI2               6.28318530718\n#define PI4               12.5663706144\n#define INV_QUATER_PI     1.27323954474\n#define INV_HALF_PI       0.63661977237\n#define INV_PI            0.31830988618\n#define INV_PI2           0.15915494309\n#define INV_PI4           0.07957747155\n#define EPSILON           1e-6\n#define EPSILON_LOWP      1e-4\n#define LOG2              1.442695\n#define EXP_VALUE         2.71828183f\n#define FP_MAX            65504.0\n#define FP_SCALE          0.0009765625\n#define FP_SCALE_INV      1024.0\n#define GRAY_VECTOR       vec3(0.299, 0.587, 0.114)\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#endif\n#if USE_INSTANCING\n#if CC_USE_BAKED_ANIMATION\nin highp vec4 a_jointAnimInfo;\n#endif\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if CC_USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#if CC_RECEIVE_SHADOW\nin vec2 a_localShadowBias;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\n#endif\n#if CC_USE_MORPH\nin float a_vertexId;\n#endif\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},gv=function(){function e(){this._device=null,this._resources={}}var t=e.prototype;return t.initBuiltinRes=function(e){var t=this;this._device=e;for(var n=this._resources,i=new Uint8Array(16),r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),c=0,u=0;u<4;u++)i[c]=0,i[c+1]=0,i[c+2]=0,i[c+3]=255,r[c]=0,r[c+1]=0,r[c+2]=0,r[c+3]=0,o[c]=119,o[c+1]=119,o[c+2]=119,o[c+3]=255,a[c]=255,a[c+1]=255,a[c+2]=255,a[c+3]=255,s[c]=127,s[c+1]=127,s[c+2]=255,s[c+3]=255,c+=4;var h=new Uint8Array(1024);c=0;for(var _=0;_<256;_++)h[c]=221,h[c+1]=221,h[c+2]=221,h[c+3]=255,c+=4;c=0;for(var f=0;f<8;f++){for(var d=0;d<8;d++)h[c]=85,h[c+1]=85,h[c+2]=85,h[c+3]=255,c+=4;c+=32}c+=32;for(var p=0;p<8;p++){for(var m=0;m<8;m++)h[c]=85,h[c+1]=85,h[c+2]=85,h[c+3]=255,c+=4;c+=32}var v={width:2,height:2,_data:i,_compressed:!1,format:uv.PixelFormat.RGBA8888},g={width:2,height:2,_data:r,_compressed:!1,format:uv.PixelFormat.RGBA8888},y={width:2,height:2,_data:o,_compressed:!1,format:uv.PixelFormat.RGBA8888},x={width:2,height:2,_data:a,_compressed:!1,format:uv.PixelFormat.RGBA8888},S={width:2,height:2,_data:s,_compressed:!1,format:uv.PixelFormat.RGBA8888},C={width:16,height:16,_data:h,_compressed:!1,format:uv.PixelFormat.RGBA8888},A=new Um(v),b=new uv;b._uuid="black-texture",b.image=A,n[b._uuid]=b;var T=new Um(g),E=new uv;E._uuid="empty-texture",E.image=T,n[E._uuid]=E;var w=new hv;w._uuid="black-cube-texture",w.setMipFilter(hv.Filter.NEAREST),w.image={front:new Um(v),back:new Um(v),left:new Um(v),right:new Um(v),top:new Um(v),bottom:new Um(v)},n[w._uuid]=w;var I=new Um(y),P=new uv;P._uuid="grey-texture",P.image=I,n[P._uuid]=P;var R=new Um(x),D=new uv;D._uuid="white-texture",D.image=R,n[D._uuid]=D;var O=new hv;O._uuid="white-cube-texture",O.setMipFilter(hv.Filter.NEAREST),O.image={front:new Um(x),back:new Um(x),left:new Um(x),right:new Um(x),top:new Um(x),bottom:new Um(x)},n[O._uuid]=O;var N=new Um(S),B=new uv;B._uuid="normal-texture",B.image=N,n[B._uuid]=B;var M=new Um(C),L=new uv;L._uuid="default-texture",L.image=M,n[L._uuid]=L;var F=new hv;if(F.setMipFilter(hv.Filter.NEAREST),F._uuid="default-cube-texture",F.image={front:new Um(C),back:new Um(C),left:new Um(C),right:new Um(C),top:new Um(C),bottom:new Um(C)},n[F._uuid]=F,l.SpriteFrame){var z=new l.SpriteFrame,V=A,G=new uv;G.image=V,z.texture=G,z._uuid="default-spriteframe",n[z._uuid]=z}var U=sm(e);if(!U)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var k=vv[U];return k?Promise.resolve().then((function(){mv.forEach((function(e,t){var n=Object.assign(new l.EffectAsset,e);n.shaders.forEach((function(e,n){var i=k[t][n];i&&(e[U]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+U+" but shaders of that version are not assembled in this build."))},t.get=function(e){return this._resources[e]},t._initMaterials=function(){var e=this._resources,t=[],n=new l.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var i=new l.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",l.color("#ffff00")),e[i._uuid]=i,t.push(i);var r=new l.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",l.color("#ff00ff")),e[r._uuid]=r,t.push(r);var o=new l.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[o._uuid]=o,t.push(o);var a=new l.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[a._uuid]=a,t.push(a);var s=new l.Material;s._uuid="ui-sprite-material",s.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[s._uuid]=s,t.push(s);var c=new l.Material;c._uuid="ui-alpha-test-material",c.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);var u=new l.Material;u._uuid="ui-sprite-gray-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[u._uuid]=u,t.push(u);var h=new l.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[h._uuid]=h,t.push(h);var _=new l.Material;_._uuid="ui-sprite-gray-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[_._uuid]=_,t.push(_);var f=new l.Material;f._uuid="ui-graphics-material",f.initialize({effectName:"graphics"}),e[f._uuid]=f,t.push(f);var d=new l.Material;d._uuid="default-particle-material",d.initialize({effectName:"particle"}),e[d._uuid]=d,t.push(d);var p=new l.Material;p._uuid="default-particle-gpu-material",p.initialize({effectName:"particle-gpu"}),e[p._uuid]=p,t.push(p);var m=new l.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),e[m._uuid]=m,t.push(m);var v=new l.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),e[v._uuid]=v,t.push(v);var g=new l.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[g._uuid]=g,t.push(g),l.game.on(l.Game.EVENT_GAME_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},e}(),yv=e("builtinResMgr",l.builtinResMgr=new gv),xv=e("getPhaseID",(fv=new Map,dv=0,function(e){return"number"==typeof e?e:(fv.has(e)||(fv.set(e,1<<dv),dv++),fv.get(e))})),Sv=e("InstancedBuffer",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,n,i){void 0===i&&(i=null);var r=t.buffer.length;if(r){var o=e.inputAssembler,a=e.descriptorSet.getTexture(Ap),s=i;s||(s=e.shaders[n]);for(var c=e.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,_=u.data;u.data=new Uint8Array(h),u.data.set(_),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var f=this._device.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,32*r,r)),d=new Uint8Array(32*r),p=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],x=new Or(y.name,y.format,y.isNormalized,p.length,!0);m.push(x)}d.set(t.buffer),p.push(f);var S=new Br(m,p,v),C=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:32,vb:f,data:d,ia:C,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}()),Cv=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=e.passes[t],c=e.shaders[t],l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var _=this.batches[h];if(_.vbs.length===i.length&&_.mergeCount<ip.BATCHING_COUNT){u=!0;for(var f=0;f<_.vbs.length;++f)if(_.vbs[f].stride!==i[f].stride){u=!1;break}if(u){for(var d=0;d<_.vbs.length;++d){var p=i[d],m=_.vbs[d],v=_.vbDatas[d];(r=(a+_.vbCount)*p.stride)>m.size&&(m.resize(r),_.vbDatas[d]=new Uint8Array(r),_.vbDatas[d].set(v)),_.vbDatas[d].set(p.buffer,_.vbCount*p.stride)}var g=_.vbIdxData;(o=4*(a+_.vbCount))>_.vbIdx.size&&(_.vbIdx.resize(o),_.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),_.vbIdxData.set(g),g=_.vbIdxData);var y=_.vbCount,x=y+a,S=_.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var C=y;C<x;C++)g[C]=S+.1;return jn.toArray(_.uboData,n.transform.worldMatrix,ip.MAT_WORLDS_OFFSET+16*_.mergeCount),_.mergeCount||(l.bindBuffer(ip.BINDING,_.ubo),l.update(),_.pass=s,_.shader=c,_.descriptorSet=l),++_.mergeCount,_.vbCount+=a,void(_.ia.vertexCount+=a)}}}for(var A=[],b=[],T=[],E=0;E<i.length;++E){var w=i[E],I=this._device.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,w.count*w.stride,w.stride));I.update(w.buffer.buffer),A.push(I),b.push(new Uint8Array(I.size)),T.push(I)}var P=this._device.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,4*a,4)),R=new Float32Array(a);R.fill(0),P.update(R),T.push(P);for(var D=e.inputAssembler.attributes,O=new Array(D.length+1),N=0;N<D.length;++N)O[N]=D[N];O[D.length]=new Or("a_dyn_batch_id",fi.R32F,!1,i.length);var B=new Br(O,T),M=this._device.createInputAssembler(B),L=this._device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,ip.SIZE,ip.SIZE));l.bindBuffer(ip.BINDING,L),l.update();var F=new Float32Array(ip.COUNT);jn.toArray(F,n.transform.worldMatrix,ip.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:A,vbDatas:b,vbIdx:P,vbIdxData:R,vbCount:a,ia:M,ubo:L,uboData:F,pass:s,shader:c,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}(),Av=new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.DEVICE),bv=new mr(null),Tv=new Wr(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(pv||(pv={}));var Ev=function(){function e(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Po,this._dss=new wo,this._rs=new Eo,this._priority=bd.DEFAULT,this._stage=Ad.DEFAULT,this._phase=xv("default"),this._primitive=Vi.TRIANGLE_LIST,this._batchingScheme=pv.NONE,this._dynamicStates=Hi.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(xv(t.phase));var n=e._bs;if(t.blendState){var i=t.blendState,r=i.targets;r&&r.forEach((function(e,t){n.setTarget(t,e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e){var t,n=mm.getKey(e.program,e.defines)+","+e._primitive+","+e._dynamicStates;return n+=function(e){for(var t,n=",bs,"+e.isA2C,i=ae(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(e._bs),n+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),So(n+=",rs,"+(t=e._rs).cullMode+","+t.depthBias+","+t.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=pi.UNKNOWN);var i=this._propertyHandleMap[e];return i?(n?i=Kp(i,n):t&&(i=Kp(i,Wp(i)-t)),i+t):0},t.getBinding=function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1},t.setUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);Qp[r](a,n,o),this._setRootBufferDirty(!0)},t.getUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);return Jp[r](a,n,o)},t.setUniformArray=function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=uo(r)>>2,a=this._getBlockView(r,i),s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=o)null!==n[c]&&Qp[r](a,n[c],s);this._setRootBufferDirty(!0)},t.bindTexture=function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)},t.bindSampler=function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)},t.setDynamicState=function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t._setRootBufferDirty=function(e){this._rootBufferDirty=e},t.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):O(12006)},t.getInstancedBuffer=function(e){return void 0===e&&(e=0),this._instancedBuffers[e]||(this._instancedBuffers[e]=new Sv(this))},t.getBatchedBuffer=function(e){return void 0===e&&(e=0),this._batchedBuffers[e]||(this._batchedBuffers[e]=new Cv(this))},t._initNative=function(){},t._destroy=function(){},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},t.resetUniform=function(t){var n=this.getHandle(t);if(n){for(var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),o=e.getOffsetFromHandle(n),a=e.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[t],l=c&&c.value||$p(i),u=(uo(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},t.resetTexture=function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),o=e.getBindingFromHandle(i),a=this._properties[t],s=a&&a.value,c=s?s+"-texture":$p(r),l=yv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?Bo.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),_=this._device.getSampler(h);this._descriptorSet.bindSampler(o,_,n),this._descriptorSet.bindTexture(o,u,n)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=0,i=0;i<t.members.length;i++){for(var r=t.members[i],o=this._getBlockView(r.type,t.binding),a=this._properties[r.name],s=a&&a.value||$p(r.type),c=(uo(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)},t.tryCompile=function(){var t=this._root.pipeline;if(!t)return!1;this._syncBatchingScheme();var n=mm.getGFXShader(this._device,this._programName,this._defines,t);return n?(this._shader=n,this._setPipelineLayout(mm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=mm.getGFXShader(this._device,this._programName,this._defines,t),o=0;o<e.length;o++){var a=e[o];delete this._defines[a.name]}return r},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._setPriority=function(e){this._priority=e},t._setStage=function(e){this._stage=e},t._setPhase=function(e){this._phase=e},t._setPrimitive=function(e){this._primitive=e},t._setState=function(e,t,n,i){this._bs=e,this._dss=t,this._rs=n,this._descriptorSet=i},t._doInit=function(t,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(bd.DEFAULT),this._setStage(Ad.DEFAULT),this._setPhase(xv("default")),this._setPrimitive(Vi.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?Q({},t.defines):t.defines,this._shaderInfo=mm.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),Tv.layout=mm.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(Tv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=mm.getTemplateInfo(t.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,_=0;_<r.length;_++){var f=a[_];l.push(h),h+=Math.ceil(f/c)*c,u=f}var d=l[l.length-1]+u;d&&(Av.size=16*Math.ceil(d/16),this._rootBuffer=i.createBuffer(Av),this._rootBlock=new ArrayBuffer(d));for(var p=0,m=0;p<r.length;p++){var v=r[p].binding,g=a[p];bv.buffer=this._rootBuffer,bv.offset=l[m++],bv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(bv);this._blocks[v]=new Float32Array(this._rootBlock,bv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var x=this._propertyHandleMap=s,S={};for(var C in this._properties){var A=this._properties[C];A.handleInfo&&(S[C]=this.getHandle.apply(this,A.handleInfo))}Object.assign(x,S)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(_i.INSTANCED_ARRAYS)?this._setBatchingScheme(pv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(pv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(pv.VB_MERGING):this._setBatchingScheme(pv.NONE)},t._setBatchingScheme=function(e){this._batchingScheme=e},t._setDynamicState=function(e){this._dynamicStates=e},t._setHash=function(e){this._hash=e},t._getBlockView=function(e,t){return e<pi.FLOAT?this._blocksInt[t]:this._blocks[t]},t._setPipelineLayout=function(e){this._pipelineLayout=e},t._initPassFromTarget=function(e,t,n,i){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(n,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(mm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^i)},J(e,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return mm.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),e}();Ev.getTypeFromHandle=Wp,Ev.getBindingFromHandle=qp,Ev.getCountFromHandle=Xp,Ev.getOffsetFromHandle=Yp;var wv=e("PipelineStateManager",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,n,i,r){var o=t.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=t.pipelineLayout,c=new Xr(r.attributes),l=new Ro(n,s,i,c,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);a=e.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},e}());wv._PSOHashMap=new Map;var Iv=new ur,Pv=new ir;function Rv(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var Dv,Ov,Nv,Bv,Mv,Lv,Fv,zv,Vv,Gv,Uv=null;function kv(e,t,n,i,r){if(i&&i.enabled&&r===Uv){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;Iv.width=Pv.width=r.window.width,Iv.height=Pv.height=r.window.height;var u=wv.getOrCreatePipelineState(e,s[0],c[0],t,a);n.setViewport(Iv),n.setScissor(Pv),n.bindPipelineState(u),n.bindDescriptorSet(Bd.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(Bd.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var Hv,jv,Wv,qv,Xv,Yv=new Zn,Kv=e("Material",(Dv=Ac("cc.Material"),Ov=ol(vm),Dv((Gv=function(e){function t(){var t;return se(t=e.call(this)||this,"_effectAsset",Mv,re(t)),se(t,"_techIdx",Lv,re(t)),se(t,"_defines",Fv,re(t)),se(t,"_states",zv,re(t)),se(t,"_props",Vv,re(t)),t._passes=[],t._hash=0,t}Z(t,e),t.getHash=function(e){for(var t,n=0,i=ae(e.passes);!(t=i()).done;)n^=t.value.hash;return n};var n=t.prototype;return n.initialize=function(e){this._passes.length?R(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(e),this._update())},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=ae(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: "+e+".")},n.getProperty=function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(e in o)return o[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null},n.copy=function(e,t){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var n=0;n<e._props.length;n++)this._props[n]=Q({},e._props[n]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=Q({},e._defines[i]);this._states.length=e._states.length;for(var r=0;r<e._states.length;r++)this._states[r]=Q({},e._states[r]);this._effectAsset=e._effectAsset,t&&this._fillInfo(t),this._update()},n._fillInfo=function(e){void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=vm.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states)},n._prepareInfo=function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(t[r]||(t[r]={}),n[r])},n._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],i=0;i<t;++i){var r=e.passes[i],o=r.passIndex=i,a=r.defines=this._defines[o]||(this._defines[o]={});if(r.stateOverrides=this._states[o]||(this._states[o]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var s=new Ev(l.director.root);s.initialize(r),n.push(s)}}return n},n._update=function(e){var n=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,e)this._passes.forEach((function(e,t){var i=n._props[t];for(var r in i||(i=n._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,n._props[e.propertyIndex]),i)n._uploadProperty(e,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=t.getHash(this)},n._uploadProperty=function(e,t,n){var i=e.getHandle(t);if(!i)return!1;if(Ev.getTypeFromHandle(i)<pi.SAMPLER1D)if(Array.isArray(n))e.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=e.properties[t])||void 0===r?void 0:r.linear){var o=n;Rv(Yv,o),Yv.w=o.w,n=Yv}e.setUniform(i,n)}else e.resetUniform(t);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(e,i,n[a],a);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0},n._bindTexture=function(e,t,n,i){var r=Ev.getBindingFromHandle(t);if(n instanceof Lo)e.bindTexture(r,n,i);else if(n instanceof Vm){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;e.bindTexture(r,o,i),e.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=ae(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0},technique:0}),this.setProperty("mainColor",new wn("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},J(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(Iu),Mv=ce((Bv=Gv).prototype,"_effectAsset",[Ov],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lv=ce(Bv.prototype,"_techIdx",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fv=ce(Bv.prototype,"_defines",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zv=ce(Bv.prototype,"_states",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vv=ce(Bv.prototype,"_props",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Nv=Bv))||Nv));l.Material=Kv,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(Hv||(Hv={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(jv||(jv={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(Wv||(Wv={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(qv||(qv={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(Xv||(Xv={}));var Jv=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Qv=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],Zv=[100,200,400,800],$v=new Pn,eg=new Pn,tg=new jn,ng=Ki.STENCIL<<1,ig=[],rg=function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=Hv.VERTICAL,this._fov=hn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new hr(.2,.2,.2,1),this._viewport=new ii(0,0,1,1),this._orientedViewport=new ii(0,0,1,1),this._curTransform=hi.IDENTITY,this._isProjDirty=!0,this._matView=new jn,this._matProj=new jn,this._matProjInv=new jn,this._matViewProj=new jn,this._matViewProjInv=new jn,this._frustum=new ac,this._forward=new Pn,this._position=new Pn,this._priority=0,this._aperture=Wv.F16_0,this._apertureValue=void 0,this._shutter=Xv.D125,this._shutterValue=0,this._iso=qv.ISO100,this._isoValue=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Ki.NONE,this._clearDepth=1,this._visibility=Fp,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=Jv[this._aperture],this._shutterValue=Qv[this._shutter],this._isoValue=Zv[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!ig.length){var t=e.capabilities.clipSpaceSignY;ig[hi.IDENTITY]=new jn(1,0,0,0,0,t),ig[hi.ROTATE_90]=new jn(0,1,0,0,-t,0),ig[hi.ROTATE_180]=new jn(-1,0,0,0,0,-t),ig[hi.ROTATE_270]=new jn(0,-1,0,0,t,0)}}var t=e.prototype;return t._setWidth=function(e){this._width=e},t._setHeight=function(e){this._height=e},t._setScene=function(e){this._scene=e},t._updateAspect=function(e){if(void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain;(t&&t.surfaceTransform||hi.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},t._init=function(){},t._destroy=function(){},t.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=Ki.NONE,this.clearDepth=1,this.visibility=Fp,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t.destroy=function(){this._node=null,this.detachFromScene(),this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},t.attachToScene=function(e){this._enabled=!0,this._setScene(e)},t.detachFromScene=function(){this._enabled=!1,this._setScene(null)},t.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._updateAspect())},t.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._updateAspect(!1),this.isWindowSize=!1},t.syncCameraEditor=function(){},t.update=function(e){var t;if(void 0===e&&(e=!1),this._node){var n=!1;(this._node.hasChangedFlags||e)&&(jn.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(t=this.window)||void 0===t?void 0:t.swapchain,r=i&&i.surfaceTransform||hi.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===jv.PERSPECTIVE)jn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===Hv.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;jn.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}jn.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(jn.multiply(this._matViewProj,this._matProj,this._matView),jn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.setViewportInOrientedSpace=function(e){var t,n=e.x,i=e.width,r=e.height,o=this._device.capabilities.screenSpaceSignY<0?1-e.y-r:e.y,a=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(a&&a.surfaceTransform||hi.IDENTITY){case hi.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case hi.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case hi.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case hi.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||l.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var n=t.swapchain;(n&&n.surfaceTransform||hi.IDENTITY)%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===jv.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Hn[this._curTransform];Pn.set($v,(t-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var _=$v.x,f=$v.y;return $v.x=_*h[0]+f*h[2]*u,$v.y=_*h[1]+f*h[3]*u,Pn.transformMat4(l?$v:e.o,$v,this._matViewProjInv),l?(this._node.getWorldPosition(eg),ia.fromPoints(e,eg,$v)):Pn.transformQuat(e.d,Pn.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Hn[this._curTransform];if(this._proj===jv.PERSPECTIVE){Pn.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,1);var u=e.x,h=e.y;e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,Pn.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition($v),Pn.lerp(e,$v,e,un(this._nearClip/this._farClip,1,t.z))}else{Pn.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,2*t.z-1);var _=e.x,f=e.y;e.x=_*l[0]+f*l[2]*c,e.y=_*l[1]+f*l[3]*c,Pn.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var n=this._device.capabilities.clipSpaceSignY,i=Hn[this._curTransform];Pn.transformMat4(e,t,this._matViewProj);var r=e.x,o=e.y;e.x=r*i[0]+o*i[2]*n,e.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return e.x=c+.5*(e.x+1)*u,e.y=l+.5*(e.y+1)*h,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,i){jn.multiply(e,this._matViewProj,t),jn.multiply(e,ig[this._curTransform],e);var r=n/2,o=i/2;return jn.identity(tg),jn.transform(tg,tg,Pn.set($v,r,o,0)),jn.scale(tg,tg,Pn.set($v,r,o,1)),jn.multiply(e,tg,e),e},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},J(e,[{key:"name",get:function(){return this._name}},{key:"scene",get:function(){return this._scene}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=Jv[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=Qv[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=Zv[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"aspect",get:function(){return this._aspect}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"viewport",get:function(){return this._viewport},set:function(e){R(8302),this.setViewportInOrientedSpace(e)}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}(),og=rt({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),ag=rt({Planar:0,ShadowMap:1}),sg=rt({HARD:0,SOFT:1,SOFT_2X:2}),cg=ag.ShadowMap+1,lg=function(){function e(){this.fixedSphere=new ua(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new jn,this.matShadowProj=new jn,this.matShadowViewProj=new jn,this._enabled=!1,this._type=cg,this._distance=0,this._normal=new Pn(0,1,0),this._shadowColor=new wn(0,0,0,76),this._size=new Yn(512,512),this._shadowMapDirty=!1,this._matLight=new jn,this._material=null,this._instancingMaterial=null}var t=e.prototype;return t.getPlanarShader=function(e){return this._material||(this._material=new Kv,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)},t.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new Kv,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)},t._setEnable=function(e){this._enabled=e},t._setType=function(e){this._type=this.enabled?e:cg},t.initialize=function(e){this._setEnable(e.enabled),this._setType(e.type),this.normal=e.planeDirection,this.distance=e.planeHeight,this.shadowColor=e.shadowColor,this.maxReceived=e.maxReceived,this.size=e.size},t.activate=function(){this.enabled&&this.type===ag.Planar&&this._updatePlanarInfo()},t._updatePlanarInfo=function(){this._material||(this._material=new Kv,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new Kv,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},t._destroy=function(){},t.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){Pn.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),e}();lg.MAX_FAR=2e3,lg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),l.Shadows=lg;var ug=new Pn,hg=(new Pn,new Pn,new Pn),_g=new jn,fg=new Ys,dg=new Ys,pg=!1,mg=ua.create(0,0,0,1),vg=new ua,gg=new ac;gg.accurate=!0;var yg=new ac;yg.accurate=!0;var xg=new ac,Sg=new jn,Cg=new jn,Ag=new jn,bg=new jn,Tg=new jn,Eg=new jn,wg=new jn,Ig=new Pn,Pg=new Yn,Rg=new Pn,Dg=new Pn,Og=new Pn(0,0,0),Ng=(new Ys,new Hl((function(){return{model:null,depth:0}}),128)),Bg=new Hl((function(){return{model:null,depth:0}}),128),Mg=new Hl((function(){return{model:null,depth:0}}),128);function Lg(e,t){var n=0;e.node&&(Pn.subtract(ug,e.node.worldPosition,t.position),n=Pn.dot(ug,t.forward));var i=Ng.alloc();return i.model=e,i.depth=n,i}function Fg(e,t){var n=0;e.node&&(Pn.subtract(ug,e.node.worldPosition,t.position),n=Pn.dot(ug,t.forward));var i=Bg.alloc();return i.model=e,i.depth=n,i}function zg(e,t){var n=0;e.node&&(Pn.subtract(ug,e.node.worldPosition,t.position),n=Pn.dot(ug,t.forward));var i=Mg.alloc();return i.model=e,i.depth=n,i}function Vg(e,t,n){var i=t.direction,r=e.normal,o=e.distance+.001,a=1/Pn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=e.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,jn.toArray(n,f,Ud.MAT_LIGHT_PLANE_PROJ_OFFSET)}function Gg(e,t){Pn.normalize(ug,e.normal),t[Ud.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=ug.x,t[Ud.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=ug.y,t[Ud.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=ug.z,t[Ud.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=e.distance}function Ug(e,t){var n=e.pipelineSceneData.validPunctualLights;n.length=0;for(var i=t.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(ua.set(mg,o.position.x,o.position.y,o.position.z,o.range),ds.sphereFrustum(mg,t.frustum)&&n.push(o))}for(var a=t.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(ua.set(mg,c.position.x,c.position.y,c.position.z,c.range),ds.sphereFrustum(mg,t.frustum)&&n.push(c))}}function kg(e,t){var n=t.scene,i=n.mainLight,r=e.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;Ng.freeArray(s),s.length=0;var c=r.castShadowObjects;Mg.freeArray(c),c.length=0,pg=!1;var l=null;if(o.enabled&&(e.pipelineUBO.updateShadowUBORange(Ud.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===ag.ShadowMap))if(l=e.pipelineSceneData.dirShadowObjects,Bg.freeArray(l),l.length=0,i&&i.node)!function(e,t,n,i,r){var o=t.device;if(n.shadowFixedArea){var a=n.shadowOrthoSize,s=n.shadowOrthoSize,c=n.shadowNear,l=n.shadowFar;jn.fromRT(Sg,n.node.getWorldRotation(),n.node.getWorldPosition()),jn.invert(Cg,Sg),jn.ortho(bg,-a,a,-s,s,c,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),jn.multiply(Tg,bg,Cg),jn.invert(Ag,Cg),r.matShadowView=Cg,r.matShadowProj=bg,r.matShadowViewProj=Tg,ac.createOrtho(e,2*a,2*s,c,l,Ag)}else{var u=n.shadowInvisibleOcclusionRange,h=r.size.x;!function(e,t){if(t.node){var n=t.node,i=n.getWorldPosition(),r=n.getWorldRotation();jn.fromRT(e,r,i),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(_g,i),ac.split(gg,i,_g,.1,n.shadowDistance),yg=ac.clone(gg),jn.fromRT(Sg,n.node.rotation,Og),jn.invert(Cg,Sg),jn.invert(Ag,Cg);var _=Cg.clone();yg.transform(Cg),Ys.fromPoints(fg,new Pn(1e7,1e7,1e7),new Pn(-1e7,-1e7,-1e7)),fg.mergeFrustum(yg);var f=2*fg.halfExtents.z;hg.set(fg.center.x,fg.center.y,fg.center.z+fg.halfExtents.z+u),Pn.transformMat4(hg,hg,Ag),jn.fromRT(Sg,n.node.rotation,hg),jn.invert(Cg,Sg),jn.invert(Ag,Cg);var d=Pn.distance(gg.vertices[0],gg.vertices[6]);vg.center.set(0,0,0),vg.radius=-1,vg.mergePoints(gg.vertices);var p=.8*d+.4*vg.radius;r.shadowCameraFar=f+u;var m=.5*p;if(jn.ortho(bg,-m,m,-m,m,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),h>0){jn.multiply(Eg,bg,_),Pn.transformMat4(Ig,hg,Eg);var v=2/h;Pg.set(v,v);var g=Ig.x%Pg.x,y=Ig.y%Pg.y;Rg.set(Ig.x-g,Ig.y-y,Ig.z),jn.invert(wg,Eg),Pn.transformMat4(Dg,Rg,wg),jn.fromRT(Sg,n.node.rotation,Dg),jn.invert(Cg,Sg),jn.invert(Ag,Cg),ac.createOrtho(e,p,p,.1,r.shadowCameraFar,Ag)}else{for(var x=0;x<8;x++)e.vertices[x].set(0,0,0);e.updatePlanes()}jn.multiply(Tg,bg,Cg),r.matShadowView=Cg,r.matShadowProj=bg,r.matShadowViewProj=Tg}}(xg,e,i,t,o);else{for(var u=0;u<8;u++)xg.vertices[u].set(0,0,0);xg.updatePlanes()}i&&o.type===ag.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,r=n.normal,o=n.distance+.001,a=1/Pn.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,_=r.z,f=n.matLight;f.m00=1-u*s,f.m01=-u*c,f.m02=-u*l,f.m03=0,f.m04=-h*s,f.m05=1-h*c,f.m06=-h*l,f.m07=0,f.m08=-_*s,f.m09=-_*c,f.m10=1-_*l,f.m11=0,f.m12=s*o,f.m13=c*o,f.m14=l*o,f.m15=1,e.pipelineUBO.updateShadowUBORange(Ud.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),a.enabled&&a.model&&t.clearFlag&ng&&s.push(Lg(a.model,t));for(var h=n.models,_=t.visibility,f=0;f<h.length;f++){var d=h[f];if(d.enabled&&(d.castShadow&&c.push(zg(d,t)),o.firstSetCSM&&d.worldBounds&&(pg||(dg.copy(d.worldBounds),pg=!0),Ys.merge(dg,dg,d.worldBounds)),d.node&&(_&d.node.layer)===d.node.layer||_&d.visFlags)){if(null!=l&&d.castShadow&&d.worldBounds&&ds.aabbFrustum(d.worldBounds,xg)&&l.push(Fg(d,t)),d.worldBounds&&!ds.aabbFrustum(d.worldBounds,t.frustum))continue;s.push(Lg(d,t))}}}var Hg,jg=new Cr(Ei.LINEAR,Ei.LINEAR,Ei.NONE,wi.CLAMP,wi.CLAMP,wi.CLAMP),Wg=new Cr(Ei.POINT,Ei.POINT,Ei.NONE,wi.CLAMP,wi.CLAMP,wi.CLAMP),qg=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device,this._linearSampler=this._device.getSampler(jg),this._pointSampler=this._device.getSampler(Wg);var t=new jr(Pd.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new Wr(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(e,t),i=n.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(e,t),i=n.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(e,t),i=n.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var n=this._globalDescriptorSet,i=t.createDescriptorSet(new Wr(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var r=Id.UBO_GLOBAL;r<Id.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=t.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,Ud.SIZE,Ud.SIZE));i.bindBuffer(Ud.BINDING,o),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},J(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}(),Xg=0,Yg={},Kg=new Wr(null),Jg=function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=bd.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var t=e.prototype;return t._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},t._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},t._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},t._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},t._createWorldBoundDescriptorSet=function(e){this._worldBoundDescriptorSet=this._device.createDescriptorSet(e)},t._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},t._setSubMesh=function(e){this._subMesh=e},t._init=function(){},t.initialize=function(e,t,n){void 0===n&&(n=null);var i=l.director.root;this._device=i.device,Kg.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(Kg);var r=l.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),o=new Wr(null);if(o.layout=r.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(e),this._patches=n,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===pv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=bd.DEFAULT,t[0].phase===xv("reflection")){var a=i.mainWindow.width,s=i.mainWindow.height,c=512;s<a?(a=c*a/s,s=c):s=c*s/(a=c),this._reflectionTex=this._device.createTexture(new xr(xi.TEX2D,Si.STORAGE|Si.TRANSFER_SRC|Si.SAMPLED,fi.RGBA8,a,s)),this.descriptorSet.bindTexture(Pp,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new Cr(Ei.LINEAR,Ei.LINEAR,Ei.NONE,wi.CLAMP,wi.CLAMP,wi.CLAMP)),this.descriptorSet.bindSampler(Pp,this._reflectionSampler),this.descriptorSet.bindTexture(Op,this._reflectionTex)}},t._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},t.initPlanarShadowShader=function(){var e=l.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},t._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},t.initPlanarShadowInstanceShader=function(){var e=l.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},t._destroy=function(){},t.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=bd.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,n=e.length;t<n;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},J(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?O(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===pv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),Kg.layout=e[0].localSetLayout,this._createDescriptorSet(Kg)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===pv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Qg=new jn,Zg=[{name:"CC_RECEIVE_SHADOW",value:!0}],$g=[{name:"CC_USE_LIGHTMAP",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(Hg||(Hg={}));var ey=new Cr(Ei.LINEAR,Ei.LINEAR,Ei.NONE,wi.CLAMP,wi.CLAMP,wi.CLAMP),ty=new Cr(Ei.LINEAR,Ei.LINEAR,Ei.LINEAR,wi.CLAMP,wi.CLAMP,wi.CLAMP),ny=function(){function e(){this.type=Hg.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(ep.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new Zn,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._shadowBias=0,this._shadowNormalBias=0,this._enabled=!0,this._visFlags=Cd.Enum.NONE,this._device=l.director.root.device}var t=e.prototype;return t._setReceiveShadow=function(e){this._receiveShadow=e},t._init=function(){},t.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Cd.Enum.NONE,this._inited=!0)},t._destroySubmodel=function(e){e.destroy()},t._destroy=function(){},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},t.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t._applyLocalData=function(){},t._applyLocalBuffer=function(){},t._applyWorldBoundBuffer=function(){},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){jn.toArray(this._localData,i,ep.MAT_WORLD_OFFSET),jn.inverseTranspose(Qg,i);var a=Math.abs(jn.determinant(Qg)),s=1/Math.sqrt(a);jn.multiplyScalar(Qg,Qg,s),jn.toArray(this._localData,Qg,ep.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},t._updateNativeBounds=function(){},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=Ys.fromPoints(Ys.create(),e,t),this._worldBounds=Ys.clone(this._modelBounds),this._updateNativeBounds())},t._createSubModel=function(){return new Jg},t.initSubModel=function(e,t,n){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){Zn.toArray(this._localData,t,ep.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,this.onMacroPatchesStateChanged(),null===e&&(e=yv.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=this._device.getSampler(e.mipmaps.length>1?ty:ey),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(Ap,n),a.bindSampler(Ap,i),a.update()}},t.updateLocalShadowBias=function(){var e=this._localData;e[ep.LOCAL_SHADOW_BIAS+0]=this._shadowBias,e[ep.LOCAL_SHADOW_BIAS+1]=this._shadowNormalBias,e[ep.LOCAL_SHADOW_BIAS+2]=0,e[ep.LOCAL_SHADOW_BIAS+3]=0,this._localDataUpdated=!0},t.getMacroPatches=function(){var e=this.receiveShadow?Zg:null;return null!=this._lightmap&&(e=e?e.concat($g):$g),e},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var n=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(n.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1},t._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(_i.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=no[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<e.length;s++){var c=e[s];if(c.isInstanced){var l=new Or;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=no[c.format],h=new(ho(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}t.batchingScheme===pv.INSTANCING&&t.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(np)),this._localDataUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.DEVICE,ep.SIZE,ep.SIZE)),this._applyLocalBuffer())},t._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.DEVICE,tp.SIZE,tp.SIZE)),this._applyWorldBoundBuffer())},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(ep.BINDING,this._localBuffer)},t._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(tp.BINDING,this._worldBoundBuffer)},J(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),iy=function(){function e(){this._groundAlbedoHDR=new Zn(.2,.2,.2,1),this._skyColorHDR=new Zn(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new Zn(.2,.2,.2,1),this._skyColorLDR=new Zn(.2,.5,.8,1),this._skyIllumLDR=0,this._enabled=!1}var t=e.prototype;return t.initialize=function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.set(e.groundAlbedoHDR),this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.set(e.groundAlbedoLDR),this._skyIllumLDR=e.skyIllumLDR},t._destroy=function(){},t.destroy=function(){this._destroy()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e)}},{key:"skyIllum",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();iy.SUN_ILLUM=65e3,iy.SKY_ILLUM=2e4,l.Ambient=iy;var ry=function(e){function t(t,n){var i;(i=e.call(this,t.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=t,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var _=c._descriptorSet.getSampler(u.binding,h),f=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,_,h),i._descriptorSet.bindTexture(u.binding,f,h)}return e.prototype.tryCompile.call(re(i)),i}Z(t,e);var n=t.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),Ev.fillPipelineInfo(this,e),Ev.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!em(this._defines,t))return!1;var n=e.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(pv.NONE)},n._onStateChange=function(){this._setHash(Ev.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},J(t,[{key:"parent",get:function(){return this._parent}}]),t}(Ev),oy=function(e){function t(t){var n;return(n=e.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=t.parent,n._owner=t.owner||null,n._subModelIdx=t.subModelIdx||0,n.copy(n._parent),n}Z(t,e);var n=t.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=ae(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in e)o[a]=e[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=Kv.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new ry(t[n],this));return e},J(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(Kv),ay=null,sy=null,cy=rt({HEMISPHERE_DIFFUSE:0,AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION:1,DIFFUSEMAP_WITH_REFLECTION:2}),ly=function(){function e(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var t=e.prototype;return t._setEnabled=function(e){this._enabled=e},t._setUseIBL=function(e){this._useIBL=e},t._setUseHDR=function(e){this._useHDR=e},t._setUseDiffuseMap=function(e){this._useDiffuseMap=e},t.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setUseDiffuseMap(e.applyDiffuseMap),this._setUseHDR(e.useHDR)},t.setEnvMaps=function(e,t){this._envmapHDR=e,this._envmapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.setDiffuseMaps=function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.activate=function(){var e=l.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=yv.get("default-cube-texture"),this._model||(this._model=l.director.root.createModel(l.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var t=this._default.isRGBE;if(this.envmap&&(t=this.envmap.isRGBE),!sy){var n=new Kv;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:t}}),sy=new oy({parent:n})}this.enabled&&(ay||(ay=l.utils.createMesh(l.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,ay.renderingSubMeshes[0],sy)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=l.director.root,t=e.pipeline,n=this.useIBL?this.isRGBE?2:1:0,i=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;t.macros.CC_USE_IBL===n&&t.macros.CC_USE_DIFFUSEMAP===i&&t.macros.CC_USE_HDR===r||(t.macros.CC_USE_IBL=n,t.macros.CC_USE_DIFFUSEMAP=i,t.macros.CC_USE_HDR=r,e.onGlobalPipelineStateChanged()),this.enabled&&sy&&sy.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,sy)},t._updateGlobalBinding=function(){if(this._globalDSManager){var e=l.director.root.device,t=this.envmap?this.envmap:this._default;if(t){var n=t.getGFXTexture(),i=e.getSampler(t.getSamplerInfo());this._globalDSManager.bindSampler(Wd,i),this._globalDSManager.bindTexture(Wd,n)}var r=this.diffuseMap?this.diffuseMap:this._default;if(r){var o=r.getGFXTexture(),a=e.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(Yd,a),this._globalDSManager.bindTexture(Yd,o)}this._globalDSManager.update()}},t._destroy=function(){},t.destroy=function(){this._destroy()},J(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._setUseHDR(e),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this._updatePipeline()}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();l.Skybox=ly;var uy=new Zn,hy=rt({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),_y=hy.LAYERED+1,fy=function(){function e(){this._fogColor=new wn("#C8C8C8"),this._colorArray=new Zn(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var t=e.prototype;return t._setType=function(e){this._type=this.enabled?e:_y},t._setEnable=function(e){this._enabled=e},t._setAccurate=function(e){this._accurate=e},t.initialize=function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setAccurate(e.accurate),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=l.director.root,t=this.enabled?this.type:_y,n=this.accurate?1:0,i=e.pipeline;i.macros.CC_USE_FOG===t&&i.macros.CC_USE_ACCURATE_FOG===n||(i.macros.CC_USE_FOG=t,i.macros.CC_USE_ACCURATE_FOG=n,e.onGlobalPipelineStateChanged())},t._destroy=function(){},t.destroy=function(){this._destroy()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e?this.activate():(this._type=_y,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._setAccurate(e),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),uy.set(e.x,e.y,e.z,e.w),Rv(this._colorArray,uy)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),e}();l.Fog=fy;var dy,py,my,vy=function(){function e(){this._enabled=!1,this._minPos=new Pn(0,0,0),this._maxPos=new Pn(0,0,0),this._depth=0}var t=e.prototype;return t.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},t._destroy=function(){},t.destroy=function(){this._destroy()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"native",get:function(){return this._nativeObj}}]),e}();function gy(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(dy||(dy=e("NodeSpace",{}))),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(py||(py=e("TransformBit",{}))),l.internal.TransformBit=py,function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(my||(my={}));var yy,xy,Sy=function(e){return 4*Math.PI*Math.PI*e*e},Cy=function(){function e(){this._baked=!1,this._color=new Pn(1,1,1),this._colorTemp=6550,this._colorTempRGB=new Pn(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=my.UNKNOWN}var t=e.prototype;return t._init=function(){},t._destroy=function(){},t.initialize=function(){this._init(),this.color=new Pn(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._destroy()},t.update=function(){},J(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,gy(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=py.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Ay=new Pn(0,0,-1),by=new Pn,Ty=function(e){function t(){var t;return(t=e.call(this)||this)._dir=new Pn(1,-1,-1),t._illuminanceHDR=iy.SUN_ILLUM,t._illuminanceLDR=1,t._shadowEnabled=!1,t._shadowPcf=sg.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._shadowSaturation=1,t._shadowDistance=100,t._shadowInvisibleOcclusionRange=200,t._shadowFixedArea=!1,t._shadowNear=.1,t._shadowFar=10,t._shadowOrthoSize=5,t._type=my.DIRECTIONAL,t}Z(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=iy.SUN_ILLUM,this.direction=new Pn(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=Pn.transformQuat(by,Ay,this._node.worldRotation))},J(t,[{key:"direction",get:function(){return this._dir},set:function(e){Pn.normalize(this._dir,e)}},{key:"illuminance",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}},{key:"shadowSaturation",get:function(){return this._shadowSaturation},set:function(e){this._shadowSaturation=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,lg.MAX_FAR)}},{key:"shadowInvisibleOcclusionRange",get:function(){return this._shadowInvisibleOcclusionRange},set:function(e){this._shadowInvisibleOcclusionRange=Math.min(e,lg.MAX_FAR)}},{key:"shadowFixedArea",get:function(){return this._shadowFixedArea},set:function(e){this._shadowFixedArea=e}},{key:"shadowNear",get:function(){return this._shadowNear},set:function(e){this._shadowNear=e}},{key:"shadowFar",get:function(){return this._shadowFar},set:function(e){this._shadowFar=Math.min(e,lg.MAX_FAR)}},{key:"shadowOrthoSize",get:function(){return this._shadowOrthoSize},set:function(e){this._shadowOrthoSize=e}}]),t}(Cy),Ey=function(e){Z(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=Ys.create(),t._pos=new Pn,t._type=my.SPHERE,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminanceHDR=1700/Sy(.15),this.luminanceLDR=1},t.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;Ys.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},J(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),n}(Cy),wy=new Pn(0,0,-1),Iy=new Ln,Py=new jn,Ry=new jn,Dy=new jn,Oy=new jn,Ny=function(e){Z(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._dir=new Pn(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._shadowEnabled=!1,t._shadowPcf=sg.HARD,t._shadowBias=1e-5,t._shadowNormalBias=0,t._aabb=Ys.create(),t._frustum=ac.create(),t._pos=new Pn,t._type=my.SPOT,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t._setDirection=function(e){this._dir.set(e)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.luminanceHDR=1700/Sy(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new Pn(1,-1,-1))},t.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),Pn.transformQuat(this._dir,wy,this._node.getWorldRotation(Iy)),Pn.normalize(this._dir,this._dir),Ys.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Py),jn.invert(Py,Py),jn.perspective(Ry,this._angle,1,.001,this._range),jn.multiply(Dy,Ry,Py),this._frustum.update(Dy,Oy),this._needUpdate=!1)},J(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}},{key:"shadowEnabled",get:function(){return this._shadowEnabled},set:function(e){this._shadowEnabled=e}},{key:"shadowPcf",get:function(){return this._shadowPcf},set:function(e){this._shadowPcf=e}},{key:"shadowBias",get:function(){return this._shadowBias},set:function(e){this._shadowBias=e}},{key:"shadowNormalBias",get:function(){return this._shadowNormalBias},set:function(e){this._shadowNormalBias=e}}]),n}(Cy),By=function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,!0},t.activate=function(){},t.update=function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=ae(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=py.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=ae(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=ae(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._destroy=function(){},t._createNativeObject=function(){},J(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"batches",get:function(){return this._batches}},{key:"native",get:function(){return this._nativeObj}}]),e}(),My=Object.freeze({__proto__:null,get CameraFOVAxis(){return Hv},get CameraProjection(){return jv},get CameraAperture(){return Wv},get CameraISO(){return qv},get CameraShutter(){return Xv},SKYBOX_FLAG:ng,Camera:rg,get ModelType(){return Hg},Model:ny,SubModel:Jg,Ambient:iy,EnvironmentLightingType:cy,Skybox:ly,ShadowSize:og,ShadowType:ag,PCFType:sg,Shadows:lg,FogType:hy,Fog:fy,Octree:vy,ColorTemperatureToRGB:gy,get LightType(){return my},nt2lm:Sy,Light:Cy,DirectionalLight:Ty,SphereLight:Ey,SpotLight:Ny,RenderScene:By});function Ly(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function Fy(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(yy||(yy={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(xy||(xy={}));var zy=function(){function e(e){this._device=void 0,this._format=fi.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new lr,this._region1=new lr,this._region2=new lr,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=no[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=ho(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=Fy(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=e;var a={chunkIdx:n,start:i,end:i+e,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,Ly(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;A("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture(new xr(xi.TEX2D,Si.SAMPLED|Si.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++},t.update=function(e,t){var n=[],i=[],r=e.start/this._formatSize,o=t.byteLength/this._formatSize,a=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)},t._findAvailableSpace=function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<o.length;a++){var s=o[a];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1},t._McDonaldAlloc=function(e){e=Fy(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var o={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,Ly(a)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l},e}();G(By.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),G(By.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var Vy={};G(Vy,"CameraVisFlags",[{name:"GENERAL"}]),V(Vy,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Cd.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Cd.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Cd.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Cd.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Cd.BitMask,targetName:"UI_2D"}]),l.CameraVisFlags=Vy;var Gy={};G(Gy,"VisibilityFlags",[{name:"GENERAL"}]),V(Gy,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Cd.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Cd.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Cd.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Cd.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Cd.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Cd.Enum,targetName:"UI_2D"}]),l.VisibilityFlags=Gy,V(Ev.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),G(rg.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),G(lg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),G(Ny.prototype,"SpotLight.prototype",[{name:"aspect"}]);var Uy=function(e){if(void 0===Yg[e]){var t=1<<Xg;Yg[e]=t,Xg+=1}},ky=Object.freeze({__proto__:null,addStage:Uy,scene:My,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,r=0;r<i;++r)n.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&n.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&n.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&n.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var o=[];o.push(new Or($i.ATTR_POSITION,fi.RGB32F)),t.normals&&o.push(new Or($i.ATTR_NORMAL,fi.RGB32F)),t.uvs&&o.push(new Or($i.ATTR_TEX_COORD,fi.RG32F)),t.colors&&o.push(new Or($i.ATTR_COLOR,fi.RGB32F));var a=e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new Br(o,[a],s))},get RenderQueue(){return yy},get PassStage(){return xy},genHandle:jp,getTypeFromHandle:Wp,getBindingFromHandle:qp,getCountFromHandle:Xp,getOffsetFromHandle:Yp,customizeType:Kp,type2reader:Jp,type2writer:Qp,getDefaultFromType:$p,overrideMacros:em,get BatchingSchemes(){return pv},Pass:Ev,getDeviceShaderVersion:sm,programLib:mm,nearestPOT:Ly,TextureBufferPool:zy,MaterialInstance:oy,PassInstance:ry,get PoolType(){return Is},NULL_HANDLE:0,get NodeView(){return Ps},NodePool:Bs,get PassView(){return Ds},PassPool:zs,get AABBView(){return Ms},AABBPool:Us,RenderScene:By,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null,NativeGeometryRenderer:null,CameraVisFlags:Vy,VisibilityFlags:Gy});e("renderer",ky);var Hy,jy=new Pn,Wy=new Pn,qy=new Pn,Xy=new Pn,Yy=new Pn,Ky=new Pn,Jy=new Pn,Qy=new Pn,Zy=new Pn,$y=new Pn;!function(e){e[e.LINE=0]="LINE",e[e.DASHED_LINE=1]="DASHED_LINE",e[e.TRIANGLE=2]="TRIANGLE"}(Hy||(Hy={}));var ex,tx,nx,ix,rx,ox,ax,sx,cx,lx,ux=function(){function e(){this._maxVertices=0,this._vertexCount=0,this._stride=0}var t=e.prototype;return t.init=function(e,t,n,i){this._maxVertices=t,this._vertexCount=0,this._stride=n,this._vertices=new Float32Array(t*n/Float32Array.BYTES_PER_ELEMENT),this._buffer=e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,t*n,n)),this._inputAssembler=e.createInputAssembler(new Br(i,[this._buffer],null))},t.empty=function(){return 0===this._vertexCount},t.reset=function(){this._vertexCount=0},t.update=function(){if(!this.empty()){var e=Math.min(this._vertexCount,this._maxVertices)*this._stride;this._buffer.update(this._vertices,e)}},t.destroy=function(){this._inputAssembler&&this._inputAssembler.destroy(),this._buffer&&this._buffer.destroy()},e}(),hx=function(){this.lines=[],this.dashedLines=[],this.triangles=[];for(var e=0;e<2;e++)this.lines[e]=new ux,this.dashedLines[e]=new ux,this.triangles[e]=new ux},_x=function(){function e(){this._device=null,this._pipeline=null,this._buffers=void 0,this._nativeObj=null,this._buffers=new hx}var t=e.prototype;return t.activate=function(e,t,n){this._device=e,this._pipeline=t;for(var i=[new Or($i.ATTR_POSITION,fi.RGB32F),new Or($i.ATTR_COLOR,fi.RGBA32F)],r=[new Or($i.ATTR_POSITION,fi.RGB32F),new Or($i.ATTR_NORMAL,fi.RGBA32F),new Or($i.ATTR_COLOR,fi.RGBA32F)],o=n?n.maxLines:1e5,a=n?n.maxDashedLines:1e4,s=n?n.maxTriangles:1e4,c=Float32Array.BYTES_PER_ELEMENT*(Pn.length+wn.length),l=Float32Array.BYTES_PER_ELEMENT*(Pn.length+Zn.length+wn.length),u=0;u<2;u++)this._buffers.lines[u].init(this._device,2*o,c,i),this._buffers.dashedLines[u].init(this._device,2*a,c,i),this._buffers.triangles[u].init(this._device,3*s,l,r)},t.flush=function(){},t.render=function(e,t){this.update();for(var n=this._pipeline.pipelineSceneData.geometryRendererPasses,i=this._pipeline.pipelineSceneData.geometryRendererShaders,r=0,o=[1,2],a=0;a<2;a++){var s=this._buffers.lines[a];if(!s.empty()){var c=new vr;c.vertexCount=s._vertexCount;for(var l=0;l<o[a];l++){var u=n[r+l],h=i[r+l],_=wv.getOrCreatePipelineState(this._device,u,h,e,s._inputAssembler);t.bindPipelineState(_),t.bindDescriptorSet(Bd.MATERIAL,u.descriptorSet),t.bindInputAssembler(s._inputAssembler),t.draw(c)}}r+=o[a]}for(var f=0;f<2;f++){var d=this._buffers.dashedLines[f];if(!d.empty()){var p=new vr;p.vertexCount=d._vertexCount;for(var m=0;m<o[f];m++){var v=n[r+m],g=i[r+m],y=wv.getOrCreatePipelineState(this._device,v,g,e,d._inputAssembler);t.bindPipelineState(y),t.bindDescriptorSet(Bd.MATERIAL,v.descriptorSet),t.bindInputAssembler(d._inputAssembler),t.draw(p)}}r+=o[f]}for(var x=0;x<2;x++){var S=this._buffers.triangles[x];if(!S.empty()){var C=new vr;C.vertexCount=S._vertexCount;for(var A=0;A<o[x];A++){var b=n[r+A],T=i[r+A],E=wv.getOrCreatePipelineState(this._device,b,T,e,S._inputAssembler);t.bindPipelineState(E),t.bindDescriptorSet(Bd.MATERIAL,b.descriptorSet),t.bindInputAssembler(S._inputAssembler),t.draw(C)}}r+=o[x]}this.reset()},t.destroy=function(){for(var e=0;e<2;e++)this._buffers.lines[e].destroy(),this._buffers.dashedLines[e].destroy(),this._buffers.triangles[e].destroy()},t.empty=function(){for(var e=0;e<2;e++)if(!this._buffers.lines[e].empty()||!this._buffers.dashedLines[e].empty()||!this._buffers.triangles[e].empty())return!1;return!0},t.update=function(){for(var e=0;e<2;e++)this._buffers.lines[e].update(),this._buffers.dashedLines[e].update(),this._buffers.triangles[e].update()},t.reset=function(){for(var e=0;e<2;e++)this._buffers.lines[e].reset(),this._buffers.dashedLines[e].reset(),this._buffers.triangles[e].reset()},t.addDashedLine=function(e,t,n,i){void 0===i&&(i=!0);var r=this._buffers.dashedLines[i?1:0];if(r._vertexCount+2>r._maxVertices)R(12008);else{var o=r._vertexCount*(Pn.length+wn.length);Pn.toArray(r._vertices,e,o),o+=Pn.length,wn.toArray(r._vertices,n,o),o+=wn.length,Pn.toArray(r._vertices,t,o),o+=Pn.length,wn.toArray(r._vertices,n,o),r._vertexCount+=2}},t.addLine=function(e,t,n,i){void 0===i&&(i=!0);var r=this._buffers.lines[i?1:0];if(r._vertexCount+2>r._maxVertices)R(12008);else{var o=r._vertexCount*(Pn.length+wn.length);Pn.toArray(r._vertices,e,o),o+=Pn.length,wn.toArray(r._vertices,n,o),o+=wn.length,Pn.toArray(r._vertices,t,o),o+=Pn.length,wn.toArray(r._vertices,n,o),r._vertexCount+=2}},t.addTriangle=function(e,t,n,i,r,o,a){if(void 0===r&&(r=!0),void 0===o&&(o=!0),void 0===a&&(a=!1),r)return this.addLine(e,t,i,o),this.addLine(t,n,i,o),void this.addLine(n,e,i,o);var s=this._buffers.triangles[o?1:0];if(s._vertexCount+3>s._maxVertices)R(12009);else{var c=new Zn(Zn.ZERO);if(!a){var l=new Pn(t.x-e.x,t.y-e.y,t.z-e.z),u=new Pn(n.x-e.x,n.y-e.y,n.z-e.z),h=new Pn;Pn.normalize(h,Pn.cross(h,l,u)),c.set(h.x,h.y,h.z,1)}var _=s._vertexCount*(Pn.length+Zn.length+wn.length);Pn.toArray(s._vertices,e,_),_+=Pn.length,Zn.toArray(s._vertices,c,_),_+=Zn.length,wn.toArray(s._vertices,i,_),_+=wn.length,Pn.toArray(s._vertices,t,_),_+=Pn.length,Zn.toArray(s._vertices,c,_),_+=Zn.length,wn.toArray(s._vertices,i,_),_+=wn.length,Pn.toArray(s._vertices,n,_),_+=Pn.length,Zn.toArray(s._vertices,c,_),_+=Zn.length,wn.toArray(s._vertices,i,_),s._vertexCount+=3}},t.addQuad=function(e,t,n,i,r,o,a,s){void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),o?(this.addLine(e,t,r,a),this.addLine(t,n,r,a),this.addLine(n,i,r,a),this.addLine(i,e,r,a)):(this.addTriangle(e,t,n,r,o,a,s),this.addTriangle(e,n,i,r,o,a,s))},t.addBoundingBox=function(e,t,n,i,r,o,a){void 0===n&&(n=!0),void 0===i&&(i=!0),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=new jn),jy.set(e.center.x-e.halfExtents.x,e.center.y-e.halfExtents.y,e.center.z-e.halfExtents.z),Wy.set(e.center.x+e.halfExtents.x,e.center.y+e.halfExtents.y,e.center.z+e.halfExtents.z),qy.set(jy.x,jy.y,jy.z),Xy.set(Wy.x,jy.y,jy.z),Yy.set(jy.x,Wy.y,jy.z),Ky.set(Wy.x,Wy.y,jy.z),Jy.set(jy.x,jy.y,Wy.z),Qy.set(Wy.x,jy.y,Wy.z),Zy.set(jy.x,Wy.y,Wy.z),$y.set(Wy.x,Wy.y,Wy.z),o&&(Pn.transformMat4(qy,qy,a),Pn.transformMat4(Xy,Xy,a),Pn.transformMat4(Yy,Yy,a),Pn.transformMat4(Ky,Ky,a),Pn.transformMat4(Jy,Jy,a),Pn.transformMat4(Qy,Qy,a),Pn.transformMat4(Zy,Zy,a),Pn.transformMat4($y,$y,a)),n?(this.addLine(Zy,$y,t,i),this.addLine($y,Ky,t,i),this.addLine(Ky,Yy,t,i),this.addLine(Yy,Zy,t,i),this.addLine(Jy,Qy,t,i),this.addLine(Qy,Xy,t,i),this.addLine(Xy,qy,t,i),this.addLine(qy,Jy,t,i),this.addLine(Zy,Jy,t,i),this.addLine($y,Qy,t,i),this.addLine(Ky,Xy,t,i),this.addLine(Yy,qy,t,i)):(this.addQuad(Jy,Qy,$y,Zy,t,n,i,r),this.addQuad(Qy,Xy,Ky,$y,t,n,i,r),this.addQuad(Xy,qy,Yy,Ky,t,n,i,r),this.addQuad(qy,Jy,Zy,Yy,t,n,i,r),this.addQuad(Zy,$y,Ky,Yy,t,n,i,r),this.addQuad(qy,Xy,Qy,Jy,t,n,i,r))},t.addCross=function(e,t,n,i){void 0===i&&(i=!0);var r=.5*t,o=new Pn(e.x-r,e.y,e.z),a=new Pn(e.x+r,e.y,e.z);this.addLine(o,a,n,i),o.set(e.x,e.y-r,e.z),a.set(e.x,e.y+r,e.z),this.addLine(o,a,n,i),o.set(e.x,e.y,e.z-r),a.set(e.x,e.y,e.z+r),this.addLine(o,a,n,i)},t.addFrustum=function(e,t,n){void 0===n&&(n=!0);var i=e.vertices;this.addLine(i[0],i[1],t,n),this.addLine(i[1],i[2],t,n),this.addLine(i[2],i[3],t,n),this.addLine(i[3],i[0],t,n),this.addLine(i[4],i[5],t,n),this.addLine(i[5],i[6],t,n),this.addLine(i[6],i[7],t,n),this.addLine(i[7],i[4],t,n),this.addLine(i[0],i[4],t,n),this.addLine(i[1],i[5],t,n),this.addLine(i[2],i[6],t,n),this.addLine(i[3],i[7],t,n)},t.addCapsule=function(e,t,n,i,r,o,a,s,c,l,u){void 0===r&&(r=32),void 0===o&&(o=8),void 0===a&&(a=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new jn);for(var h=2*Math.PI/r,_=Math.PI/2/o,f=new Pn(e.x,e.y-n/2,e.z),d=new Pn(e.x,e.y+n/2,e.z),p=new Array,m=new Array,v=0;v<o+1;v++){for(var g=new Array,y=new Array,x=v*_,S=Math.sin(x),C=Math.cos(x),A=0;A<r+1;A++){var b=A*h,T=Math.sin(b),E=Math.cos(b),w=new Pn(t*S*E,t*C,t*S*T),I=new Pn(f.x+w.x,f.y-w.y,f.z+w.z),P=new Pn(d.x+w.x,d.y+w.y,d.z+w.z);g.push(I),y.push(P)}p.push(g),m.push(y)}if(l)for(var R=0;R<o+1;R++)for(var D=0;D<r+1;D++)Pn.transformMat4(p[R][D],p[R][D],u),Pn.transformMat4(m[R][D],m[R][D],u);for(var O=0;O<o;O++)for(var N=0;N<r;N++)this.addTriangle(p[O+1][N],p[O][N+1],p[O][N],i,a,s,c),this.addTriangle(p[O+1][N],p[O+1][N+1],p[O][N+1],i,a,s,c),this.addTriangle(m[O][N],m[O+1][N+1],m[O+1][N],i,a,s,c),this.addTriangle(m[O][N],m[O][N+1],m[O+1][N+1],i,a,s,c);for(var B=p[o],M=m[o],L=0;L<r;L++)this.addTriangle(M[L],B[L+1],B[L],i,a,s,c),this.addTriangle(M[L],M[L+1],B[L+1],i,a,s,c)},t.addCylinder=function(e,t,n,i,r,o,a,s,c,l){void 0===r&&(r=32),void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new jn);for(var u=2*Math.PI/r,h=new Pn(e.x,e.y-n/2,e.z),_=new Pn(e.x,e.y+n/2,e.z),f=new Array,d=new Array,p=0;p<r+1;p++){var m=p*u,v=new Pn(t*Math.cos(m),0,t*Math.sin(m)),g=new Pn(v.x+h.x,v.y+h.y,v.z+h.z),y=new Pn(v.x+_.x,v.y+_.y,v.z+_.z);f.push(g),d.push(y)}if(c){Pn.transformMat4(h,h,l),Pn.transformMat4(_,_,l);for(var x=0;x<r+1;x++)Pn.transformMat4(f[x],f[x],l),Pn.transformMat4(d[x],d[x],l)}for(var S=0;S<r;S++)this.addTriangle(_,d[S+1],d[S],i,o,a,s),this.addTriangle(h,f[S],f[S+1],i,o,a,s),this.addTriangle(d[S],f[S+1],f[S],i,o,a,s),this.addTriangle(d[S],d[S+1],f[S+1],i,o,a,s)},t.addCone=function(e,t,n,i,r,o,a,s,c,l){void 0===r&&(r=32),void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new jn);for(var u=2*Math.PI/r,h=new Pn(e.x,e.y-n/2,e.z),_=new Pn(e.x,e.y+n/2,e.z),f=new Array,d=0;d<r+1;d++){var p=new Pn(t*Math.cos(d*u),0,t*Math.sin(d*u)),m=new Pn(p.x+h.x,p.y+h.y,p.z+h.z);f.push(m)}if(c){Pn.transformMat4(h,h,l),Pn.transformMat4(_,_,l);for(var v=0;v<r+1;v++)Pn.transformMat4(f[v],f[v],l)}for(var g=0;g<r;g++)this.addTriangle(_,f[g+1],f[g],i,o,a,s),this.addTriangle(h,f[g],f[g+1],i,o,a,s)},t.addCircle=function(e,t,n,i,r,o,a){void 0===i&&(i=32),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=new jn);for(var s=2*Math.PI/i,c=new Array,l=0;l<i+1;l++){var u=new Pn(t*Math.cos(l*s),0,t*Math.sin(l*s)),h=new Pn(u.x+e.x,u.y+e.y,u.z+e.z);c.push(h)}if(o)for(var _=0;_<i+1;_++)Pn.transformMat4(c[_],c[_],a);for(var f=0;f<i;f++)this.addLine(c[f],c[f+1],n,r)},t.addArc=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=32),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=new jn);for(var l=hn(i),u=(hn(r)-l)/o,h=new Array,_=0;_<o+1;_++){var f=new Pn(t*Math.cos(_*u+l),0,t*Math.sin(_*u+l)),d=new Pn(f.x+e.x,f.y+e.y,f.z+e.z);h.push(d)}if(s)for(var p=0;p<o+1;p++)Pn.transformMat4(h[p],h[p],c);for(var m=0;m<o;m++)this.addLine(h[m],h[m+1],n,a)},t.addPolygon=function(e,t,n,i,r,o,a,s,c){void 0===i&&(i=6),void 0===r&&(r=!0),void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=!1),void 0===c&&(c=new jn),r?this.addCircle(e,t,n,i,o,s,c):this.addDisc(e,t,n,i,r,o,a,s,c)},t.addDisc=function(e,t,n,i,r,o,a,s,c){void 0===i&&(i=32),void 0===r&&(r=!0),void 0===o&&(o=!0),void 0===a&&(a=!1),void 0===s&&(s=!1),void 0===c&&(c=new jn);for(var l=2*Math.PI/i,u=new Array,h=new Pn(e),_=0;_<i+1;_++){var f=new Pn(t*Math.cos(_*l),0,t*Math.sin(_*l)),d=new Pn(f.x+h.x,f.y+h.y,f.z+h.z);u.push(d)}if(s){Pn.transformMat4(h,h,c);for(var p=0;p<i+1;p++)Pn.transformMat4(u[p],u[p],c)}for(var m=0;m<i;m++)this.addTriangle(h,u[m],u[m+1],n,r,o,a);if(!r)for(var v=0;v<i;v++)this.addTriangle(h,u[v+1],u[v],n,r,o,a)},t.addSector=function(e,t,n,i,r,o,a,s,c,l,u){void 0===o&&(o=32),void 0===a&&(a=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new jn);for(var h=hn(i),_=(hn(r)-h)/o,f=new Array,d=new Pn(e),p=0;p<o+1;p++){var m=new Pn(t*Math.cos(p*_),0,t*Math.sin(p*_)),v=new Pn(m.x+d.x,m.y+d.y,m.z+d.z);f.push(v)}if(l){Pn.transformMat4(d,d,u);for(var g=0;g<o+1;g++)Pn.transformMat4(f[g],f[g],u)}for(var y=0;y<o;y++)this.addTriangle(d,f[y],f[y+1],n,a,s,c);if(!a)for(var x=0;x<o;x++)this.addTriangle(d,f[x+1],f[x],n,a,s,c)},t.addSphere=function(e,t,n,i,r,o,a,s,c,l){void 0===i&&(i=32),void 0===r&&(r=16),void 0===o&&(o=!0),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===l&&(l=new jn);for(var u=2*Math.PI/i,h=Math.PI/r,_=new Array,f=0;f<r+1;f++){for(var d=new Array,p=f*h,m=Math.sin(p),v=Math.cos(p),g=0;g<i+1;g++){var y=g*u,x=Math.sin(y),S=Math.cos(y),C=new Pn(t*m*S,t*v,t*m*x),A=new Pn(e.x+C.x,e.y+C.y,e.z+C.z);d.push(A)}_.push(d)}if(c)for(var b=0;b<r+1;b++)for(var T=0;T<i+1;T++)Pn.transformMat4(_[b][T],_[b][T],l);for(var E=0;E<r;E++)for(var w=0;w<i;w++)this.addTriangle(_[E][w],_[E+1][w+1],_[E+1][w],n,o,a,s),this.addTriangle(_[E][w],_[E][w+1],_[E+1][w+1],n,o,a,s)},t.addTorus=function(e,t,n,i,r,o,a,s,c,l,u){void 0===r&&(r=32),void 0===o&&(o=16),void 0===a&&(a=!0),void 0===s&&(s=!0),void 0===c&&(c=!1),void 0===l&&(l=!1),void 0===u&&(u=new jn);for(var h=2*Math.PI/r,_=2*Math.PI/o,f=new Array,d=0;d<r+1;d++){for(var p=new Array,m=d*h,v=Math.sin(m),g=Math.cos(m),y=0;y<o+1;y++){var x=y*_,S=Math.sin(x),C=Math.cos(x),A=new Pn((t+n*C)*g,n*S,(t+n*C)*v),b=new Pn(e.x+A.x,e.y+A.y,e.z+A.z);p.push(b)}f.push(p)}if(l)for(var T=0;T<r+1;T++)for(var E=0;E<o+1;E++)Pn.transformMat4(f[T][E],f[T][E],u);for(var w=0;w<r;w++)for(var I=0;I<o;I++)this.addTriangle(f[w][I+1],f[w+1][I],f[w][I],i,a,s,c),this.addTriangle(f[w][I+1],f[w+1][I+1],f[w+1][I],i,a,s,c)},t.addOctahedron=function(e,t,n,i,r,o,a,s){void 0===i&&(i=!0),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=new jn);var c=new Array;if(c.push(new Pn(t+e.x,e.y,e.z)),c.push(new Pn(e.x,e.y,e.z-t)),c.push(new Pn(-t+e.x,e.y,e.z)),c.push(new Pn(e.x,e.y,e.z+t)),c.push(new Pn(e.x,e.y+t,e.z)),c.push(new Pn(e.x,e.y-t,e.z)),a)for(var l=0;l<c.length;l++)Pn.transformMat4(c[l],c[l],s);i?(this.addLine(c[0],c[1],n,r),this.addLine(c[1],c[2],n,r),this.addLine(c[2],c[3],n,r),this.addLine(c[3],c[0],n,r),this.addLine(c[0],c[4],n,r),this.addLine(c[1],c[4],n,r),this.addLine(c[2],c[4],n,r),this.addLine(c[3],c[4],n,r),this.addLine(c[0],c[5],n,r),this.addLine(c[1],c[5],n,r),this.addLine(c[2],c[5],n,r),this.addLine(c[3],c[5],n,r)):(this.addTriangle(c[0],c[1],c[4],n,i,r,o),this.addTriangle(c[1],c[2],c[4],n,i,r,o),this.addTriangle(c[2],c[3],c[4],n,i,r,o),this.addTriangle(c[3],c[0],c[4],n,i,r,o),this.addTriangle(c[0],c[3],c[5],n,i,r,o),this.addTriangle(c[3],c[2],c[5],n,i,r,o),this.addTriangle(c[2],c[1],c[5],n,i,r,o),this.addTriangle(c[1],c[0],c[5],n,i,r,o))},t.addBezier=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=32),void 0===a&&(a=!0),void 0===s&&(s=!1),void 0===c&&(c=new jn);var l=1/o,u=new Array,h=new Pn(e),_=new Pn(t),f=new Pn(n),d=new Pn(i);s&&(Pn.transformMat4(h,h,c),Pn.transformMat4(_,_,c),Pn.transformMat4(f,f,c),Pn.transformMat4(d,d,c));for(var p=0;p<o+1;p++){var m=p*l,v=(1-m)*(1-m)*(1-m),g=3*m*(1-m)*(1-m),y=3*m*m*(1-m),x=m*m*m,S=new Pn(v*h.x+g*_.x+y*f.x+x*d.x,v*h.y+g*_.y+y*f.y+x*d.y,v*h.z+g*_.z+y*f.z+x*d.z);u.push(S)}for(var C=0;C<o;C++)this.addLine(u[C],u[C+1],r,a)},t.addMesh=function(e,t,n,i,r,o){void 0===i&&(i=!0),void 0===r&&(r=!1),void 0===o&&(o=new jn);for(var a=0;a<t.length;a+=3){var s=new Pn(e.x+t[a].x,e.y+t[a].y,e.z+t[a].z),c=new Pn(e.x+t[a+1].x,e.y+t[a+1].y,e.z+t[a+1].z),l=new Pn(e.x+t[a+2].x,e.y+t[a+2].y,e.z+t[a+2].z);r&&(Pn.transformMat4(s,s,o),Pn.transformMat4(c,c,o),Pn.transformMat4(l,l,o)),this.addLine(s,c,n,i),this.addLine(c,l,n,i),this.addLine(l,s,n,i)}},t.addIndexedMesh=function(e,t,n,i,r,o,a){void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=new jn);for(var s=0;s<n.length;s+=3){var c=new Pn(e.x+t[n[s]].x,e.y+t[n[s]].y,e.z+t[n[s]].z),l=new Pn(e.x+t[n[s+1]].x,e.y+t[n[s+1]].y,e.z+t[n[s+1]].z),u=new Pn(e.x+t[n[s+2]].x,e.y+t[n[s+2]].y,e.z+t[n[s+2]].z);o&&(Pn.transformMat4(c,c,a),Pn.transformMat4(l,l,a),Pn.transformMat4(u,u,a)),this.addLine(c,l,i,r),this.addLine(l,u,i,r),this.addLine(u,c,i,r)}},J(e,[{key:"native",get:function(){return this._nativeObj}}]),e}(),fx=new jn,dx=new jn,px=new jn,mx=new Zn,vx=new Zn(0,0,1,0),gx=function(){function e(){this._globalUBO=new Float32Array(Vd.COUNT),this._cameraUBO=new Float32Array(Gd.COUNT),this._shadowUBO=new Float32Array(Ud.COUNT)}e.updateGlobalUBOView=function(e,t){var n=l.director.root,i=t,r=Math.floor(e.width),o=Math.floor(e.height);i[Vd.TIME_OFFSET]=n.cumulativeTime,i[Vd.TIME_OFFSET+1]=n.frameTime,i[Vd.TIME_OFFSET+2]=l.director.getTotalFrames(),i[Vd.SCREEN_SIZE_OFFSET]=r,i[Vd.SCREEN_SIZE_OFFSET+1]=o,i[Vd.SCREEN_SIZE_OFFSET+2]=1/r,i[Vd.SCREEN_SIZE_OFFSET+3]=1/o,i[Vd.NATIVE_SIZE_OFFSET]=r,i[Vd.NATIVE_SIZE_OFFSET+1]=o,i[Vd.NATIVE_SIZE_OFFSET+2]=1/i[Vd.NATIVE_SIZE_OFFSET],i[Vd.NATIVE_SIZE_OFFSET+3]=1/i[Vd.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,t,n){var i,r=(n.scene?n.scene:l.director.getScene().renderScene).mainLight,o=e.pipelineSceneData,a=o.ambient,s=o.skybox,c=o.fog,u=o.shadows,h=t,_=n.exposure,f=o.isHDR;if(h[Gd.SCREEN_SCALE_OFFSET]=o.shadingScale,h[Gd.SCREEN_SCALE_OFFSET+1]=o.shadingScale,h[Gd.SCREEN_SCALE_OFFSET+2]=1/h[Gd.SCREEN_SCALE_OFFSET],h[Gd.SCREEN_SCALE_OFFSET+3]=1/h[Gd.SCREEN_SCALE_OFFSET+1],h[Gd.EXPOSURE_OFFSET]=_,h[Gd.EXPOSURE_OFFSET+1]=1/_,h[Gd.EXPOSURE_OFFSET+2]=f?1:0,h[Gd.EXPOSURE_OFFSET+3]=1/rg.standardExposureValue,r){var d=r.shadowEnabled&&u.type===ag.ShadowMap?1:0,p=r.direction;if(vx.set(p.x,p.y,p.z,d),Zn.toArray(h,vx,Gd.MAIN_LIT_DIR_OFFSET),Pn.toArray(h,r.color,Gd.MAIN_LIT_COLOR_OFFSET),r.useColorTemperature){var m=r.colorTemperatureRGB;h[Gd.MAIN_LIT_COLOR_OFFSET]*=m.x,h[Gd.MAIN_LIT_COLOR_OFFSET+1]*=m.y,h[Gd.MAIN_LIT_COLOR_OFFSET+2]*=m.z}h[Gd.MAIN_LIT_COLOR_OFFSET+3]=f?r.illuminance*_:r.illuminance}else vx.set(0,0,1,0),Zn.toArray(h,vx,Gd.MAIN_LIT_DIR_OFFSET),Zn.toArray(h,Zn.ZERO,Gd.MAIN_LIT_COLOR_OFFSET);var v=a.skyColor;v.w=f?a.skyIllum*_:a.skyIllum,h[Gd.AMBIENT_SKY_OFFSET+0]=v.x,h[Gd.AMBIENT_SKY_OFFSET+1]=v.y,h[Gd.AMBIENT_SKY_OFFSET+2]=v.z,h[Gd.AMBIENT_SKY_OFFSET+3]=v.w,h[Gd.AMBIENT_GROUND_OFFSET+0]=a.groundAlbedo.x,h[Gd.AMBIENT_GROUND_OFFSET+1]=a.groundAlbedo.y,h[Gd.AMBIENT_GROUND_OFFSET+2]=a.groundAlbedo.z,h[Gd.AMBIENT_GROUND_OFFSET+3]=s.envmap?null===(i=s.envmap)||void 0===i?void 0:i.mipmapLevel:1,jn.toArray(h,n.matView,Gd.MAT_VIEW_OFFSET),jn.toArray(h,n.node.worldMatrix,Gd.MAT_VIEW_INV_OFFSET),Pn.toArray(h,n.position,Gd.CAMERA_POS_OFFSET),jn.toArray(h,n.matProj,Gd.MAT_PROJ_OFFSET),jn.toArray(h,n.matProjInv,Gd.MAT_PROJ_INV_OFFSET),jn.toArray(h,n.matViewProj,Gd.MAT_VIEW_PROJ_OFFSET),jn.toArray(h,n.matViewProjInv,Gd.MAT_VIEW_PROJ_INV_OFFSET),h[Gd.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var g=c.colorArray;h[Gd.GLOBAL_FOG_COLOR_OFFSET]=g.x,h[Gd.GLOBAL_FOG_COLOR_OFFSET+1]=g.y,h[Gd.GLOBAL_FOG_COLOR_OFFSET+2]=g.z,h[Gd.GLOBAL_FOG_COLOR_OFFSET+3]=g.z,h[Gd.GLOBAL_FOG_BASE_OFFSET]=c.fogStart,h[Gd.GLOBAL_FOG_BASE_OFFSET+1]=c.fogEnd,h[Gd.GLOBAL_FOG_BASE_OFFSET+2]=c.fogDensity,h[Gd.GLOBAL_FOG_ADD_OFFSET]=c.fogTop,h[Gd.GLOBAL_FOG_ADD_OFFSET+1]=c.fogRange,h[Gd.GLOBAL_FOG_ADD_OFFSET+2]=c.fogAtten,h[Gd.NEAR_FAR_OFFSET]=n.nearClip,h[Gd.NEAR_FAR_OFFSET+1]=n.farClip,h[Gd.VIEW_PORT_OFFSET]=o.shadingScale*n.window.width*n.viewport.x,h[Gd.VIEW_PORT_OFFSET+1]=o.shadingScale*n.window.height*n.viewport.y,h[Gd.VIEW_PORT_OFFSET+2]=o.shadingScale*n.window.width*n.viewport.z,h[Gd.VIEW_PORT_OFFSET+3]=o.shadingScale*n.window.height*n.viewport.w},e.updateShadowUBOView=function(e,t,n){var i=e.device,r=n.scene.mainLight,o=e.pipelineSceneData.shadows,a=t;if(o.enabled){if(r&&r.shadowEnabled&&o.type===ag.ShadowMap){var s=.1,c=0,l=o.matShadowView,u=o.matShadowProj,h=o.matShadowViewProj;r.shadowFixedArea?(s=r.shadowNear,c=r.shadowFar):(s=.1,c=o.shadowCameraFar),jn.toArray(t,l,Ud.MAT_LIGHT_VIEW_OFFSET),a[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[Ud.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[Ud.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[Ud.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[Ud.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,jn.toArray(t,h,Ud.MAT_LIGHT_VIEW_PROJ_OFFSET);var _=Gp(i)?0:1;a[Ud.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,a[Ud.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,a[Ud.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[Ud.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.shadowSaturation,a[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.shadowPcf,a[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.shadowBias,a[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=_,a[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.shadowNormalBias,a[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===ag.Planar&&(Vg(o,r,a),Gg(o,a));wn.toArray(a,o.shadowColor,Ud.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var i=e.device,r=e.pipelineSceneData.shadows,o=t,a=Gp(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case my.DIRECTIONAL:var _=n;_.shadowFixedArea?(s=_.shadowNear,c=_.shadowFar):(s=.1,c=r.shadowCameraFar),jn.toArray(t,l,Ud.MAT_LIGHT_VIEW_OFFSET),o[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[Ud.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[Ud.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[Ud.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[Ud.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,jn.toArray(t,h,Ud.MAT_LIGHT_VIEW_PROJ_OFFSET),mx.set(s,c,0,1-_.shadowSaturation),Zn.toArray(o,mx,Ud.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),mx.set(0,a,_.shadowNormalBias,0),Zn.toArray(o,mx,Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),mx.set(r.size.x,r.size.y,_.shadowPcf,_.shadowBias),Zn.toArray(o,mx,Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET);break;case my.SPOT:var f=n;jn.invert(fx,n.node.getWorldMatrix()),jn.toArray(o,fx,Ud.MAT_LIGHT_VIEW_OFFSET),jn.perspective(dx,n.angle,1,.001,n.range),jn.multiply(px,dx,fx),jn.toArray(o,px,Ud.MAT_LIGHT_VIEW_PROJ_OFFSET),mx.set(.01,n.range,0,0),Zn.toArray(o,mx,Ud.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),mx.set(1,a,f.shadowNormalBias,0),Zn.toArray(o,mx,Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET),mx.set(r.size.x,r.size.y,f.shadowPcf,f.shadowBias),Zn.toArray(o,mx,Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET)}wn.toArray(o,r.shadowColor,Ud.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,Vd.SIZE,Vd.SIZE));n.bindBuffer(Vd.BINDING,i);var r=e.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,Gd.SIZE,Gd.SIZE));n.bindBuffer(Gd.BINDING,r);var o=e.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,Ud.SIZE,Ud.SIZE));n.bindBuffer(Ud.BINDING,o)},t.updateGlobalUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),r[0].updateBuffer(i.getBuffer(Vd.BINDING),this._globalUBO),n.bindBuffer(Vd.BINDING,i.getBuffer(Vd.BINDING)),n.update()},t.updateCameraUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(i.getBuffer(Gd.BINDING),this._cameraUBO),n.bindBuffer(Gd.BINDING,i.getBuffer(Gd.BINDING)),n.update()},t.updateShadowUBO=function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=t.scene.mainLight;a&&o.has(a)&&i.bindTexture(kd,o.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),i.update(),r[0].updateBuffer(i.getBuffer(Ud.BINDING),this._shadowUBO)}},t.updateShadowUBOLight=function(t,n){e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),t.bindTexture(kd,yv.get("default-texture").getGFXTexture()),t.bindTexture(Qd,yv.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(Ud.BINDING).update(this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof jn?jn.toArray(this._shadowUBO,t,e):t instanceof wn&&wn.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}();gx._combineSignY=0;var yx,xx,Sx,Cx,Ax,bx,Tx,Ex,wx,Ix,Px,Rx,Dx,Ox=e("RenderStage",(ex=Ac("RenderStage"),tx=Zc(),nx=Zc(),ix=Zc(),ex((lx=function(){function e(){se(this,"_name",ax,this),se(this,"_priority",sx,this),this._enabled=!0,se(this,"_tag",cx,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},J(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),ax=ce((ox=lx).prototype,"_name",[tx,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sx=ce(ox.prototype,"_priority",[nx,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cx=ce(ox.prototype,"_tag",[ix,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rx=ox))||rx));l.RenderStage=Ox;var Nx,Bx=e("RenderFlow",(yx=Ac("RenderFlow"),xx=Zc(),Sx=Zc(),Cx=Zc(),Ax=Zc(),bx=ol([Ox]),yx((Dx=function(){function e(){se(this,"_name",wx,this),se(this,"_priority",Ix,this),se(this,"_tag",Px,this),se(this,"_stages",Rx,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},J(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),wx=ce((Ex=Dx).prototype,"_name",[xx,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ix=ce(Ex.prototype,"_priority",[Sx,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Px=ce(Ex.prototype,"_tag",[Cx,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Rx=ce(Ex.prototype,"_stages",[Ax,bx,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Tx=Ex))||Tx));l.RenderFlow=Bx,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(Nx||(Nx=e("PipelineEventType",{})));var Mx,Lx,Fx,zx,Vx,Gx,Ux,kx,Hx,jx,Wx,qx,Xx,Yx,Kx,Jx=e("PipelineEventProcessor",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}Z(t,e);var n=t.prototype;return n.on=function(e,t,n,i){return this.eventTargetOn(e,t,n,i)},n.once=function(e,t,n){return this.eventTargetOnce(e,t,n)},t}(au)),Qx=new ir,Zx=new ur,$x=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},eS=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},tS=e("RenderPipeline",(Mx=Ac("cc.RenderPipeline"),Lx=Zc(),Fx=Zc(),zx=ol([Bx]),Mx((Hx=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_tag",Ux,re(t)),se(t,"_flows",kx,re(t)),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new Jx,t._commandBuffers=[],t._pipelineUBO=new gx,t._macros={},t._constantMacros="",t._profiler=null,t._geometryRenderer=new _x,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new ir,t._clusterEnabled=!1,t._bloomEnabled=!1,t}Z(t,e);var n=t.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.createRenderPass=function(e,t,n){var i=this._device,r=new Mr,o=new Lr;r.format=t,o.format=n,o.stencilStoreOp=Mi.DISCARD,o.depthStoreOp=Mi.DISCARD,e&Ki.COLOR||(e&ng?r.loadOp=Bi.DISCARD:(r.loadOp=Bi.LOAD,r.barrier=i.getGeneralBarrier(new Gr(Li.COLOR_ATTACHMENT_WRITE,Li.COLOR_ATTACHMENT_WRITE)))),(e&Ki.DEPTH_STENCIL)!==Ki.DEPTH_STENCIL&&(e&Ki.DEPTH||(o.depthLoadOp=Bi.LOAD),e&Ki.STENCIL||(o.stencilLoadOp=Bi.LOAD)),o.barrier=i.getGeneralBarrier(new Gr(Li.DEPTH_STENCIL_ATTACHMENT_WRITE,Li.DEPTH_STENCIL_ATTACHMENT_WRITE));var a=new Vr([r],o);return i.createRenderPass(a)},n.getRenderPass=function(e,t){var n=this._renderPasses.get(e);return n||(n=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(e,n),n)},n.applyFramebufferRatio=function(e){for(var t=this.pipelineSceneData,n=this._width*t.shadingScale,i=this._height*t.shadingScale,r=e.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);e.depthStencilTexture&&e.depthStencilTexture.resize(n,i),e.destroy(),e.initialize(new kr(e.renderPass,r,e.depthStencilTexture))},n.generateRenderArea=function(e,t){var n=e.viewport,i=e.window.width,r=e.window.height;t.x=n.x*i,t.y=n.y*r,t.width=n.width*i,t.height=n.height*r},n.generateViewport=function(e,t){this.generateRenderArea(e,Qx),t||(t=Zx);var n=this.pipelineSceneData.shadingScale;return t.left=Qx.x*n,t.top=Qx.y*n,t.width=Qx.width*n,t.height=Qx.height*n,t},n.generateScissor=function(e,t){t||(t=Qx),this.generateRenderArea(e,t);var n=this.pipelineSceneData.shadingScale;return t.x*=n,t.y*=n,t.width*=n,t.height*=n,t},n.activate=function(){var e=l.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new qg(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this),this._geometryRenderer.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(Nx.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;t>=0;--t){var n=e[t];if(n.window.swapchain)return void(Uv=n)}Uv=null}(e);for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){this.emit(Nx.RENDER_CAMERA_BEGIN,n),Ug(this,n),kg(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(Nx.RENDER_CAMERA_END,n)}}this.emit(Nx.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var n=0;n<t.downsampleTexs.length;++n)t.downsampleTexs[n].destroy(),t.downsampleFramebuffers[n].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(e,t){var n=new Float32Array(16),i=t.x/this._width,r=(t.x+t.width)/this._width,o=t.y/this._height,a=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(e){case hi.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case hi.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case hi.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case hi.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var e=new eS,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE|yi.HOST,n,t));if(!i)return e;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,o,r));if(!a)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Or("a_position",fi.RG32F),c[1]=new Or("a_texCoord",fi.RG32F);var l=this._device.createInputAssembler(new Br(c,[i],a));return e.quadIB=a,e.quadVB=i,e.quadIA=l,e},n.updateQuadVertexData=function(e,t){var n=this._lastUsedRenderArea;if(n.x!==e.x||n.y!==e.y||n.width!==e.width||n.height!==e.height){var i=this._genQuadVertexData(hi.IDENTITY,e);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||hi.IDENTITY,e);this._quadVBOnscreen.update(r),n.copy(e)}},n.destroy=function(){for(var t,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),this._geometryRenderer.destroy(),e.prototype.destroy.call(this)},n._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.getFormatFeatures(fi.RGBA32F)&(Ai.RENDER_TARGET|Ai.SAMPLED_TEXTURE)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(_i.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(hu.os===iu.ANDROID&&hu.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(lt.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=e},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new $x,t=this.device,n=new Mr;n.format=fi.RGBA8,n.loadOp=Bi.CLEAR,n.storeOp=Mi.STORE,n.barrier=t.getGeneralBarrier(new Gr(Li.NONE,Li.COLOR_ATTACHMENT_WRITE)),e.renderPass=t.createRenderPass(new Vr([n]));var i=this._width,r=this._height;e.prefiterTex=t.createTexture(new xr(xi.TEX2D,Si.COLOR_ATTACHMENT|Si.SAMPLED,fi.RGBA8,i>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new kr(e.renderPass,[e.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)e.downsampleTexs.push(t.createTexture(new xr(xi.TEX2D,Si.COLOR_ATTACHMENT|Si.SAMPLED,fi.RGBA8,i>>1,r>>1))),e.downsampleFramebuffers[o]=t.createFramebuffer(new kr(e.renderPass,[e.downsampleTexs[o]])),e.upsampleTexs.push(t.createTexture(new xr(xi.TEX2D,Si.COLOR_ATTACHMENT|Si.SAMPLED,fi.RGBA8,i,r))),e.upsampleFramebuffers[o]=t.createFramebuffer(new kr(e.renderPass,[e.upsampleTexs[o]])),i>>=1,r>>=1;e.combineTex=t.createTexture(new xr(xi.TEX2D,Si.COLOR_ATTACHMENT|Si.SAMPLED,fi.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new kr(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},n.on=function(e,t,n,i){return this._eventProcessor.on(e,t,n,i)},n.once=function(e,t,n){return this._eventProcessor.once(e,t,n)},n.off=function(e,t,n){this._eventProcessor.off(e,t,n)},n.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},n.targetOff=function(e){this._eventProcessor.targetOff(e)},n.removeAll=function(e){this._eventProcessor.removeAll(e)},n.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},J(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"geometryRenderer",get:function(){return this._geometryRenderer}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}}]),t}(Iu),Ux=ce((Gx=Hx).prototype,"_tag",[Lx,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kx=ce(Gx.prototype,"_flows",[Fx,zx,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vx=Gx))||Vx));l.RenderPipeline=tS,function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(jx||(jx={})),function(e){e[e.FORWARD=10]="FORWARD"}(Wx||(Wx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(qx||(qx={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(Xx||(Xx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(Yx||(Yx={}));var nS=new Mr;nS.format=fi.RGBA8;var iS=new Lr;iS.format=fi.DEPTH_STENCIL;var rS,oS,aS,sS,cS,lS,uS,hS,_S,fS,dS,pS,mS,vS,gS,yS,xS,SS,CS,AS,bS,TS,ES,wS,IS,PS,RS,DS,OS,NS,BS,MS,LS,FS,zS,VS,GS,US,kS,HS,jS,WS,qS,XS,YS,KS,JS,QS,ZS,$S,eC,tC,nC,iC,rC,oC,aC,sC,cC,lC,uC,hC,_C,fC,dC,pC,mC,vC,gC,yC,xC,SC,CC,AC,bC,TC,EC,wC,IC,PC=new Vr([nS],iS),RC={width:1,height:1,renderPassInfo:PC},DC=e("RenderTexture",Ac("cc.RenderTexture")(Kx=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._window=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},n.reset=function(e){this.initialize(e)},n.destroy=function(){if(this._window){var t=l.director.root;null==t||t.destroyWindow(this._window),this._window=null}return e.prototype.destroy.call(this)},n.resize=function(e,t){this._width=Math.floor(cn(e,1,2048)),this._height=Math.floor(cn(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(t,n){var i=t;this._width=i.w,this._height=i.h,this._name=i.n,e.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(e){var t=l.director.root;RC.title=this._name,RC.width=this._width,RC.height=this._height,RC.renderPassInfo=e&&e.passInfo?e.passInfo:PC,nS.barrier=t.device.getGeneralBarrier(new Gr(Li.FRAGMENT_SHADER_READ_TEXTURE,Li.FRAGMENT_SHADER_READ_TEXTURE)),this._window?(this._window.destroy(),this._window.initialize(t.device,RC)):this._window=t.createWindow(RC)},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),n=n||this.width,i=i||this.height;var o=this.getGFXTexture();if(!o)return O(7606),null;var a=4*n*i;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return O(7607,a),null;var s=this._getGFXDevice(),c=[],l=[],u=new lr;return u.texOffset.x=e,u.texOffset.y=t,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(o,c,l),r},J(t,[{key:"window",get:function(){return this._window}}]),t}(Vm))||Kx);l.RenderTexture=DC,st(xi),st(Si),st(Mi),st(Bi),st(Li),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(IC||(IC={})),st(IC),rS=Ac("RenderTextureDesc"),oS=ol(xi),aS=ol(Si),sS=ol(fi),rS((lS=ce((cS=function(){se(this,"name",lS,this),se(this,"type",uS,this),se(this,"usage",hS,this),se(this,"format",_S,this),se(this,"width",fS,this),se(this,"height",dS,this)}).prototype,"name",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uS=ce(cS.prototype,"type",[oS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xi.TEX2D}}),hS=ce(cS.prototype,"usage",[aS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Si.COLOR_ATTACHMENT}}),_S=ce(cS.prototype,"format",[sS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fi.UNKNOWN}}),fS=ce(cS.prototype,"width",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),dS=ce(cS.prototype,"height",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),cS));var OC,NC=(pS=Ac("RenderTextureConfig"),mS=ol(DC),pS((yS=ce((gS=function(){se(this,"name",yS,this),se(this,"texture",xS,this)}).prototype,"name",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xS=ce(gS.prototype,"texture",[mS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vS=gS))||vS),BC=(SS=Ac("MaterialConfig"),CS=ol(Kv),SS((bS=ce((AS=function(){se(this,"name",bS,this),se(this,"material",TS,this)}).prototype,"name",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),TS=ce(AS.prototype,"material",[CS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AS)),ES=Ac("FrameBufferDesc"),wS=ol([Bt]),IS=ol(DC),ES((RS=ce((PS=function(){se(this,"name",RS,this),se(this,"renderPass",DS,this),se(this,"colorTextures",OS,this),se(this,"depthStencilTexture",NS,this),se(this,"texture",BS,this)}).prototype,"name",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),DS=ce(PS.prototype,"renderPass",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OS=ce(PS.prototype,"colorTextures",[wS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NS=ce(PS.prototype,"depthStencilTexture",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),BS=ce(PS.prototype,"texture",[IS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PS)),MS=Ac("ColorDesc"),LS=ol(fi),FS=ol(Bi),zS=ol(Mi),VS=ol([Li]),GS=ol([Li]),MS((HS=ce((kS=function(){se(this,"format",HS,this),se(this,"loadOp",jS,this),se(this,"storeOp",WS,this),se(this,"sampleCount",qS,this),se(this,"beginAccesses",XS,this),se(this,"endAccesses",YS,this)}).prototype,"format",[LS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fi.UNKNOWN}}),jS=ce(kS.prototype,"loadOp",[FS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bi.CLEAR}}),WS=ce(kS.prototype,"storeOp",[zS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.STORE}}),qS=ce(kS.prototype,"sampleCount",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),XS=ce(kS.prototype,"beginAccesses",[VS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.NONE}}),YS=ce(kS.prototype,"endAccesses",[GS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.COLOR_ATTACHMENT_WRITE}}),US=kS))||US),MC=(KS=Ac("DepthStencilDesc"),JS=ol(fi),QS=ol(Bi),ZS=ol(Mi),$S=ol(Bi),eC=ol(Mi),tC=ol(Li),nC=ol(Li),KS((oC=ce((rC=function(){se(this,"format",oC,this),se(this,"depthLoadOp",aC,this),se(this,"depthStoreOp",sC,this),se(this,"stencilLoadOp",cC,this),se(this,"stencilStoreOp",lC,this),se(this,"sampleCount",uC,this),se(this,"beginAccesses",hC,this),se(this,"endAccesses",_C,this)}).prototype,"format",[JS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fi.UNKNOWN}}),aC=ce(rC.prototype,"depthLoadOp",[QS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bi.CLEAR}}),sC=ce(rC.prototype,"depthStoreOp",[ZS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.STORE}}),cC=ce(rC.prototype,"stencilLoadOp",[$S],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bi.CLEAR}}),lC=ce(rC.prototype,"stencilStoreOp",[eC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mi.STORE}}),uC=ce(rC.prototype,"sampleCount",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),hC=ce(rC.prototype,"beginAccesses",[tC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.NONE}}),_C=ce(rC.prototype,"endAccesses",[nC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.DEPTH_STENCIL_ATTACHMENT_WRITE}}),iC=rC))||iC);fC=Ac("RenderPassDesc"),dC=ol([BC]),pC=ol(MC),fC((vC=ce((mC=function(){se(this,"index",vC,this),se(this,"colorAttachments",gC,this),se(this,"depthStencilAttachment",yC,this)}).prototype,"index",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),gC=ce(mC.prototype,"colorAttachments",[dC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yC=ce(mC.prototype,"depthStencilAttachment",[pC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new MC}}),mC)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(OC||(OC={})),st(OC);var LC=(xC=Ac("RenderQueueDesc"),SC=ol(OC),CC=ol([Bt]),xC((TC=ce((bC=function(){se(this,"isTransparent",TC,this),se(this,"sortMode",EC,this),se(this,"stages",wC,this)}).prototype,"isTransparent",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),EC=ce(bC.prototype,"sortMode",[SC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OC.FRONT_TO_BACK}}),wC=ce(bC.prototype,"stages",[CC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AC=bC))||AC);function FC(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function zC(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var VC=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new jl((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Wl(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,n){var i=e.model.subModels[t],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=e.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=wv.getOrCreatePipelineState(e,c,l,t,s);n.bindPipelineState(u),n.bindDescriptorSet(Bd.MATERIAL,c.descriptorSet),n.bindDescriptorSet(Bd.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}();function GC(e){for(var t=0,n=0;n<e.stages.length;n++)t|=xv(e.stages[n]);var i=FC;switch(e.sortMode){case OC.BACK_TO_FRONT:i=zC;break;case OC.FRONT_TO_BACK:i=FC}return new VC({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function UC(e){e.clear()}function kC(e){e.sort()}var HC=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}n=t.next()}},t.recordCommandBuffer=function(e,t,n,i){void 0===i&&(i=null);for(var r=this.queue.values(),o=r.next();!o.done;){for(var a=!1,s=0;s<o.value.batches.length;++s){var c=o.value.batches[s];if(c.mergeCount){if(!a){var l=c.shader,u=wv.getOrCreatePipelineState(e,c.pass,l,t,c.ia);n.bindPipelineState(u),n.bindDescriptorSet(Bd.MATERIAL,c.pass.descriptorSet),a=!0}i&&n.bindDescriptorSet(Bd.GLOBAL,i),n.bindDescriptorSet(Bd.LOCAL,c.descriptorSet,o.value.dynamicOffsets),n.bindInputAssembler(c.ia),n.draw(c.ia)}}o=r.next()}},e}(),jC=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()},t.recordCommandBuffer=function(e,t,n,i){void 0===i&&(i=null);for(var r=this.queue.values(),o=r.next();!o.done;){var a=o.value,s=a.instances,c=a.pass;if(a.hasPendingModels){n.bindDescriptorSet(Bd.MATERIAL,c.descriptorSet);for(var l=null,u=0;u<s.length;++u){var h=s[u];if(h.count){var _=h.shader,f=wv.getOrCreatePipelineState(e,c,_,t,h.ia);l!==f&&(n.bindPipelineState(f),l=f),i&&n.bindDescriptorSet(Bd.GLOBAL,i),n.bindDescriptorSet(Bd.LOCAL,h.descriptorSet,o.value.dynamicOffsets),n.bindInputAssembler(h.ia),n.draw(h.ia)}}}o=r.next()}},e}(),WC=new Hl((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),qC=new Float32Array(4),XC=[],YC=[],KC=new jn,JC=new jn;function QC(e,t){return!(!t.worldBounds||ds.aabbWithAABB(t.worldBounds,e.aabb))}function ZC(e,t){return!(!t.worldBounds||ds.aabbWithAABB(t.worldBounds,e.aabb)&&ds.aabbFrustum(t.worldBounds,e.frustum))}var $C=xv("forward-add"),eA=[];function tA(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===$C){o=a,n=!0;break}t.push(o)}return n}var nA,iA,rA,oA,aA,sA,cA,lA,uA,hA,_A,fA=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(Ud.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new jC,this._batchedQueue=new HC;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(rp.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new mr(this._lightBuffer,0,rp.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}WC.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,n=0;n<t.length;n++){var i=t[n],r=e.get(i);r&&(r.getBuffer(Ud.BINDING).destroy(),r.getTexture(kd).destroy(),r.getTexture(Qd).destroy(),r.destroy()),e.delete(i)}},t.gatherLightPasses=function(e,t){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(tA(a,eA)&&(YC.length=0,this._lightCulling(o,n),YC.length))for(var s=0;s<a.length;s++){var c=eA[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(rp.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,n){for(var i=this._pipeline.globalDSManager,r=0;r<YC.length;r++){var o=YC[r],a=i.getOrCreateDescriptorSet(o);this._instancedQueue.recordCommandBuffer(e,t,n,a),this._batchedQueue.recordCommandBuffer(e,t,n,a)}for(var s=0;s<this._lightPasses.length;s++){var c=this._lightPasses[s],l=c.subModel,u=c.passIdx,h=c.dynamicOffsets,_=c.lights,f=l.passes[u],d=l.shaders[u],p=l.inputAssembler,m=wv.getOrCreatePipelineState(e,f,d,t,p),v=f.descriptorSet,g=l.descriptorSet;n.bindPipelineState(m),n.bindDescriptorSet(Bd.MATERIAL,v),n.bindInputAssembler(p);for(var y=0;y<h.length;++y){var x=_[y],S=i.getOrCreateDescriptorSet(x);XC[0]=h[y],n.bindDescriptorSet(Bd.GLOBAL,S),n.bindDescriptorSet(Bd.LOCAL,g,XC),n.draw(p)}}},t._lightCulling=function(e,t){for(var n=!1,i=!function(e){for(var t=e.subModels,n=0;n<t.length;++n)for(var i=t[n].passes,r=0;r<i.length;++r){var o=i[r].batchingScheme;if(o===pv.INSTANCING)return!0;if(o===pv.VB_MERGING)return!0}return!1}(e),r=0;r<t.length;r++){var o=t[r];switch(o.type){case my.SPHERE:i&&(n=QC(o,e));break;case my.SPOT:i&&(n=ZC(o,e))}n||YC.push(r)}},t._addRenderQueue=function(e,t,n,i){var r=e.batchingScheme;if(r===pv.INSTANCING)for(var o=0;o<YC.length;o++){var a=YC[o],s=e.getInstancedBuffer(a);s.merge(t,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===pv.VB_MERGING)for(var c=0;c<YC.length;c++){var l=YC[c],u=e.getBatchedBuffer(l);u.merge(t,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=WC.alloc();h.subModel=t,h.passIdx=i;for(var _=0;_<YC.length;_++){var f=YC[_];h.lights.push(f),h.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(h)}},t._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=e.scene.mainLight,s=Gp(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],_=c.getOrCreateDescriptorSet(u);if(_){var f=void 0,d=void 0;switch(h.type){case my.SPHERE:a&&(Vg(r,a,this._shadowUBO),Gg(r,this._shadowUBO)),this._shadowUBO[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=1,this._shadowUBO[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=0,this._shadowUBO[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=0,this._shadowUBO[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,wn.toArray(this._shadowUBO,r.shadowColor,Ud.SHADOW_COLOR_OFFSET);break;case my.SPOT:var p=h;if(a&&(Vg(r,a,this._shadowUBO),Gg(r,this._shadowUBO)),jn.invert(KC,h.node.getWorldMatrix()),jn.perspective(JC,h.angle,1,.001,h.range),f=JC.clone(),d=JC.clone().invert(),jn.multiply(JC,JC,KC),jn.toArray(this._shadowUBO,KC,Ud.MAT_LIGHT_VIEW_OFFSET),jn.toArray(this._shadowUBO,JC,Ud.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[Ud.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[Ud.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[Ud.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[Ud.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=0,this._shadowUBO[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=p.shadowPcf,this._shadowUBO[Ud.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=p.shadowBias,this._shadowUBO[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=p.shadowNormalBias,this._shadowUBO[Ud.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=f.m10,this._shadowUBO[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=f.m14,this._shadowUBO[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=f.m11,this._shadowUBO[Ud.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=f.m15,this._shadowUBO[Ud.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=d.m10,this._shadowUBO[Ud.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=d.m14,this._shadowUBO[Ud.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=d.m11,this._shadowUBO[Ud.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=d.m15,this._shadowUBO[Ud.SHADOW_PROJ_INFO_OFFSET+0]=f.m00,this._shadowUBO[Ud.SHADOW_PROJ_INFO_OFFSET+1]=f.m05,this._shadowUBO[Ud.SHADOW_PROJ_INFO_OFFSET+2]=1/f.m00,this._shadowUBO[Ud.SHADOW_PROJ_INFO_OFFSET+3]=1/f.m05,wn.toArray(this._shadowUBO,r.shadowColor,Ud.SHADOW_COLOR_OFFSET),o.has(h)){var m,v=null===(m=o.get(h))||void 0===m?void 0:m.colorTextures[0];v&&_.bindTexture(Qd,v)}}_.update(),t.updateBuffer(_.getBuffer(Ud.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=yn(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new mr(this._lightBuffer,0,rp.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case my.SPHERE:if(Pn.toArray(qC,l.position),qC[3]=0,this._lightBufferData.set(qC,c+rp.LIGHT_POS_OFFSET),qC[0]=l.size,qC[1]=l.range,qC[2]=0,qC[3]=0,this._lightBufferData.set(qC,c+rp.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Pn.toArray(qC,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;qC[0]*=u.x,qC[1]*=u.y,qC[2]*=u.z}qC[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(qC,c+rp.LIGHT_COLOR_OFFSET);break;case my.SPOT:if(Pn.toArray(qC,l.position),qC[3]=1,this._lightBufferData.set(qC,c+rp.LIGHT_POS_OFFSET),qC[0]=l.size,qC[1]=l.range,qC[2]=l.spotAngle,qC[3]=o.enabled&&l.shadowEnabled&&o.type===ag.ShadowMap?1:0,this._lightBufferData.set(qC,c+rp.LIGHT_SIZE_RANGE_ANGLE_OFFSET),Pn.toArray(qC,l.direction),this._lightBufferData.set(qC,c+rp.LIGHT_DIR_OFFSET),Pn.toArray(qC,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;qC[0]*=h.x,qC[1]*=h.y,qC[2]*=h.z}qC[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(qC,c+rp.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),dA=new Ys,pA=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new jC,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===ag.Planar&&!(i.normal.length()<1e-6)){var r=e.scene,o=e.frustum,a=0!=(e.visibility&Cd.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var _=this._castModels[h];if(!_.worldBounds||(Ys.transform(dA,_.worldBounds,i.matLight),ds.aabbFrustum(dA,o)))if(_.isInstancingEnabled)for(var f=_.subModels,d=0;d<f.length;d++){var p=f[d];u.merge(p,_.instancedAttributes,0,p.planarInstanceShader)}else this._pendingModels.push(_)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===ag.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(Bd.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,_=u.inputAssembler,f=wv.getOrCreatePipelineState(e,r,h,t,_);n.bindPipelineState(f),n.bindDescriptorSet(Bd.LOCAL,u.descriptorSet),n.bindInputAssembler(_),n.draw(_)}}},e}(),mA=function(){function e(){this._phaseID=xv("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=e.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var _=s.shaders[u],f=s.inputAssembler,d=wv.getOrCreatePipelineState(i,h,_,t,f);r.bindPipelineState(d),r.bindDescriptorSet(Bd.MATERIAL,h.descriptorSet);var p=s.descriptorSet;r.bindDescriptorSet(Bd.LOCAL,p),r.bindInputAssembler(f),r.draw(f)}}}},e}(),vA=[new hr(0,0,0,1)],gA=e("ForwardStage",(nA=Ac("ForwardStage"),iA=ol([LC]),rA=Zc(),nA((lA=cA=function(e){function t(){var t;return se(t=e.call(this)||this,"renderQueues",sA,re(t)),t._renderQueues=[],t._renderArea=new ir,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=xv("default"),t._clearFlag=4294967295,t._batchedQueue=new HC,t._instancedQueue=new jC,t._uiPhase=new mA,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=GC(this.renderQueues[i]);this._additiveLightQueue=new fA(this._pipeline),this._planarQueue=new pA(this._pipeline),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(UC);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===pv.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(f===pv.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,o,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(kC);var m=t.commandBuffers[0];t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m),e.clearFlag&Ki.COLOR&&(vA[0].x=e.clearColor.x,vA[0].y=e.clearColor.y,vA[0].z=e.clearColor.z,vA[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea);var v=e.window.framebuffer,g=t.getRenderPass(e.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,vA,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Bd.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(Bd.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._pipeline.geometryRenderer.render(g,m),this._uiPhase.render(e,g),kv(n,g,m,t.profiler,e),m.endRenderPass()},t}(Ox),cA.initInfo={name:"ForwardStage",priority:Wx.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:OC.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:OC.BACK_TO_FRONT,stages:["default","planarShadow"]}]},sA=ce((aA=lA).prototype,"renderQueues",[iA,Dc,rA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oA=aA))||oA)),yA=e("ForwardFlow",Ac("ForwardFlow")((_A=hA=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new gA;n.initialize(gA.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(Bx),hA.initInfo={name:Ed,priority:qx.FORWARD,stages:[]},uA=_A))||uA),xA=new jn,SA=new jn,CA=new jn,AA=new Ys,bA=xv("shadow-caster"),TA=[];function EA(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===bA){o=a,n=!0;break}t.push(o)}return n}var wA,IA,PA,RA,DA,OA,NA=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new jC,this._batchedQueue=new HC}var t=e.prototype;return t.gatherLightPasses=function(e,t,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(n&&o.enabled&&o.type===ag.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case my.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;EA(l.subModels,TA)&&this.add(l,TA)}break;case my.SPOT:jn.invert(xA,n.node.getWorldMatrix()),jn.perspective(SA,n.angle,1,.001,n.range),jn.multiply(CA,SA,xA);for(var u=0;u<s.length;u++){var h=s[u].model;EA(h.subModels,TA)&&(h.worldBounds&&(Ys.transform(AA,h.worldBounds,CA),!ds.aabbFrustum(AA,t.frustum))||this.add(h,TA))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t){for(var n=e.subModels,i=0;i<n.length;i++){var r=n[i],o=t[i],a=r.passes[o];if(a.batchingScheme===pv.INSTANCING){var s=a.getInstancedBuffer();s.merge(r,e.instancedAttributes,o),this._instancedQueue.queue.add(s)}else if(a.batchingScheme===pv.VB_MERGING){var c=a.getBatchedBuffer();c.merge(r,o,e),this._batchedQueue.queue.add(c)}else{var l=r.shaders[o];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=wv.getOrCreatePipelineState(e,a,o,t,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(Bd.MATERIAL,l),n.bindDescriptorSet(Bd.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}(),BA=[new hr(1,1,1,1)],MA=e("ShadowStage",Ac("ShadowStage")((PA=IA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowFrameBuffer=null,t._renderArea=new ir,t._light=null,t._globalDS=null,t}Z(t,e);var n=t.prototype;return n.setUsage=function(e,t,n){this._globalDS=e,this._light=t,this._shadowFrameBuffer=n},n.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},n.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){BA[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,BA,e.clearDepth,e.clearStencil),t.endRenderPass()}},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,e,this._light,a);var s=e.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=t.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,BA,e.clearDepth,e.clearStencil),a.bindDescriptorSet(Bd.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._additiveShadowQueue=new NA(t)},t}(Ox),IA.initInfo={name:"ShadowStage",priority:Wx.FORWARD,tag:0},wA=PA))||wA),LA=[],FA=e("ShadowFlow",Ac("ShadowFlow")((OA=DA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowRenderPass=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new MA;n.initialize(MA.initInfo),this._stages.push(n)}return!0},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===ag.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===my.SPOT&&(LA.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var u=t.descriptorSet;i.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var h=i.get(l),_=0;_<this._stages.length;_++){var f=this._stages[_];f.setUsage(u,l,h),f.render(e)}}for(var d=0;d<LA.length;d++){var p=LA[d],m=t.globalDSManager.getOrCreateDescriptorSet(d);i.has(p)||this._initShadowFrameBuffer(t,p,e.window.swapchain);for(var v=i.get(p),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,p,v),y.render(e)}}LA.length=0}else this.clearShadowMap(LA,e)}},n.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(t.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(e,t){var n=e.device,i=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,o=Gp(n)?fi.R32F:fi.RGBA8;if(!this._shadowRenderPass){var a=new Mr;a.format=o,a.loadOp=Bi.CLEAR,a.storeOp=Mi.STORE,a.sampleCount=1;var s=new Lr;s.format=fi.DEPTH_STENCIL,s.depthLoadOp=Bi.CLEAR,s.depthStoreOp=Mi.DISCARD,s.stencilLoadOp=Bi.CLEAR,s.stencilStoreOp=Mi.DISCARD,s.sampleCount=1;var c=new Vr([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new xr(xi.TEX2D,Si.COLOR_ATTACHMENT|Si.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new xr(xi.TEX2D,Si.DEPTH_STENCIL_ATTACHMENT,fi.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new kr(this._shadowRenderPass,l,u));r.set(t,h)},n.clearShadowMap=function(e,t){var n=this._pipeline,i=n.pipelineSceneData,r=t.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(t)}}for(var l=0;l<e.length;l++){var u=e[l],h=i.shadowFrameBufferMap.get(u),_=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var f=0;f<this._stages.length;f++){var d=this._stages[f];d.setUsage(_,u,h),d.clearFramebuffer(t)}}},n.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=Gp(i)?fi.R32F:fi.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new xr(xi.TEX2D,Si.COLOR_ATTACHMENT|Si.SAMPLED,o,t.x,t.y)));var u=c.depthStencilTexture;u&&u.resize(t.x,t.y);var h=c.renderPass;c.destroy(),c.initialize(new kr(h,l,u)),s=a.next()}else s=a.next()}e.shadowMapDirty=!1},t}(Bx),DA.initInfo={name:wd,priority:qx.SHADOW,tag:IC.SCENE,stages:[]},RA=OA))||RA);function zA(e,t){for(var n,i=ae(t);!(n=i()).done;){var r=n.value;Array.isArray(r)?zA(e,r):e.push(r)}}function VA(e){var t=[];return zA(t,e),t.join("")}var GA=fl.Flags.Destroyed,UA=fl.Flags.PersistentMask,kA=Zt.IDENTIFIER_RE,HA="var ",jA="o",WA={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},qA=Zt.escapeForJS,XA=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return HA+this.varName+"="+this.expression+";"},e}();function YA(e,t){return t instanceof XA?new XA(t.varName,e+t.expression):e+t}function KA(e,t,n){Array.isArray(n)?(n[0]=YA(t,n[0]),e.push(n)):e.push(YA(t,n)+";")}var JA=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];KA(e,t+QA(i[0])+"=",i[1])}},e}();function QA(e){return kA.test(e)?"."+e:"["+qA(e)+"]"}JA.pool=void 0,JA.pool=new et((function(e){e._exps.length=0,e._targetExp=null}),1),JA.pool.get=function(e){var t=this._get()||new JA;return t._targetExp=e,t};var ZA=function(){function e(e,t){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=we(),ze(this.funcModuleCache,WA),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(n=HA+this.globalVariables.join(",")+";");var i=VA(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var n=Ie(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var o=this.funcs.indexOf(e);o<0&&(o=this.funcs.length,this.funcs.push(e));var a="F["+o+"]";return t&&(a="("+a+")"),this.funcModuleCache[n]=a,a},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,n,i){var r=JA.pool.get(i),o=t.constructor.__props__;o||(o=Object.keys(t));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),JA.pool.put(r)},t.enumerateCCClass=function(e,t,n){for(var i=n.__values__,r=It(n),o=0;o<i.length;o++){var a=i[o],s=t[a],c=r[a+"$_$default"];if(!$A(c,s))if("object"==typeof s&&s instanceof l.ValueType&&(c=Zt.getDefault(c))&&c.constructor===s.constructor){var u=jA+QA(a);this.setValueType(e,c,s,u)}else this.setObjProp(e,t,a,s)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new XA(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)KA(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]));return n},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var n="a"+ ++this.localVariableId,i=[new XA(n,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&KA(i,n+"["+r+"]=",e[r]);return i},t.enumerateField=function(e,t,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=YA(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?qA(n):("_objFlags"===t&&e instanceof fl&&(n&=UA),n)},t.setObjProp=function(e,t,n,i){KA(e,jA+QA(n)+"=",this.enumerateField(t,n,i))},t.enumerateObject=function(e,t){var n=t.constructor;if($t(n))this.enumerateCCClass(e,t,n);else for(var i in t)if(t.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=t[i];"object"==typeof r&&r&&r===t._iN$t||this.setObjProp(e,t,i,r)}},t.instantiateObj=function(e){if(e instanceof l.ValueType)return Zt.getNewValueTypeCode(e);if(e instanceof l.Asset)return this.getObjRef(e);if(e._objFlags&GA)return null;var t,n=e.constructor;if($t(n)){if(this.parent)if(this.parent instanceof l.Component){if(e instanceof l._BaseNode||e instanceof l.Component)return this.getObjRef(e)}else if(this.parent instanceof l._BaseNode)if(e instanceof l._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof l.Component){var i;if(!(null===(i=e.node)||void 0===i?void 0:i.isChildOf(this.parent)))return this.getObjRef(e)}t=new XA(jA,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new XA(jA,"{}");else{if(n)return this.getObjRef(e);t=new XA(jA,"Object.create(null)")}var r=[t];return e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e),this.enumerateObject(r,e),["(function(){",r,"return o;})();"]},e}();function $A(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof l.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return Se(e)&&Se(t)}return!1}var eb,tb,nb,ib,rb,ob,ab,sb,cb,lb,ub=function(){function e(e){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=e}return e.prototype.applyOpacity=function(e){this._opacity=this._localOpacity*e},e.markOpacityTree=function(){},J(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?R(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e,this.colorDirty=!0}}]),e}();fl.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed",e.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(eb||(eb=e("NodeEventType",{})));var hb=fl.Flags.Destroying,_b=fl.Flags.DontDestroy,fb=fl.Flags.Deactivating,db=new pe("Node");function pb(e){return e?"string"==typeof e?Ze(e):e:(O(3804),null)}var mb,vb,gb,yb,xb,Sb,Cb,Ab,bb,Tb,Eb,wb=e("BaseNode",Ac("cc.BaseNode")((lb=cb=function(e){Z(n,e),n._setScene=function(e){e._updateScene()},n._findComponent=function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===t)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof t)return s}return null},n._findComponents=function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===t&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}},n._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],o=n._findComponent(r,t);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,t)))return o}return null},n._findChildComponents=function(e,t,i){for(var r=0;r<e.length;++r){var o=e[r];n._findComponents(o,t,i),o._children.length>0&&n._findChildComponents(o._children,t,i)}};var t=n.prototype;function n(t){var n;return se(n=e.call(this,t)||this,"_parent",ib,re(n)),se(n,"_children",rb,re(n)),se(n,"_active",ob,re(n)),se(n,"_components",ab,re(n)),se(n,"_prefab",sb,re(n)),n._scene=null,n._activeInHierarchy=!1,n._id=db.getNewId(),n._name=void 0,n._eventProcessor=new l.NodeEventProcessor(re(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==t?t:"New Node",n}return t._updateScene=function(){null==this._parent?S("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){ze(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(eb.PARENT_CHANGED,n),n&&!(n._objFlags&hb)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(eb.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(eb.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},t.getChildByUuid=function(e){if(!e)return y("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null},t.getChildByName=function(e){if(!e)return y("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null},t.getChildByPath=function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&fb)O(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},t.walk=function(e,t){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&e?e(o):l&&t&&t(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=pb(e);return t?n._findComponent(this,t):null},t.getComponents=function(e){var t=pb(e),i=[];return t&&n._findComponents(this,t,i),i},t.getComponentInChildren=function(e){var t=pb(e);return t?n._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=pb(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=Ze(e)))throw l._RF.peek()&&O(3808,e),TypeError(L(3807,e))}else{if(!e)throw TypeError(L(3804));t=e}if("function"!=typeof t)throw TypeError(L(3809));if(!Ue(t,l.Component))throw TypeError(L(3810));var n=t._requireComponent;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++){var r=n[i];this.getComponent(r)||this.addComponent(r)}else{var o=n;this.getComponent(o)||this.addComponent(o)}var a=new t;return a.node=this,this._components.push(a),this._activeInHierarchy&&l.director._nodeActivator.activateComp(a),a},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof Ku?e:this.getComponent(e))&&t.destroy()}else O(3813)},t.on=function(e,t,n,i){switch(void 0===i&&(i=!1),e){case eb.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)},t.off=function(e,t,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(e,t,n,i),!this._eventProcessor.hasEventListener(e))switch(e){case eb.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,n,i){this._eventProcessor.once(e,t,n,i)},t.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(eb.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&hb)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&O(3815)}}else O(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(eb.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return e||(e=l.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof l.Scene||l.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&l.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=hb;var e=this._parent,t=!!e&&0!=(e._objFlags&hb);if(this._persistNode&&l.game.removePersistRootNode(this),!t&&e){this.emit(eb.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(eb.CHILD_REMOVED,this)}this.emit(eb.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var o=this._components,a=0;a<o.length;++a)o[a]._destroyImmediate();return t},J(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&_b)>0},set:function(e){e?this._objFlags|=_b:this._objFlags&=~_b}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(e=!!e,this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&l.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(fl),cb.idGenerator=db,cb._stacks=[[]],cb._stackId=0,ce((nb=lb).prototype,"_persistNode",[wc],Object.getOwnPropertyDescriptor(nb.prototype,"_persistNode"),nb.prototype),ce(nb.prototype,"name",[kc],Object.getOwnPropertyDescriptor(nb.prototype,"name"),nb.prototype),ce(nb.prototype,"children",[kc],Object.getOwnPropertyDescriptor(nb.prototype,"children"),nb.prototype),ce(nb.prototype,"active",[kc],Object.getOwnPropertyDescriptor(nb.prototype,"active"),nb.prototype),ce(nb.prototype,"activeInHierarchy",[kc],Object.getOwnPropertyDescriptor(nb.prototype,"activeInHierarchy"),nb.prototype),ce(nb.prototype,"parent",[kc],Object.getOwnPropertyDescriptor(nb.prototype,"parent"),nb.prototype),ib=ce(nb.prototype,"_parent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rb=ce(nb.prototype,"_children",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ob=ce(nb.prototype,"_active",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ab=ce(nb.prototype,"_components",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sb=ce(nb.prototype,"_prefab",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tb=nb))||tb);l._BaseNode=wb;var Ib=new Pn,Pb=new Ln,Rb=new Ln,Db=new Ln,Ob=new Nn,Nb=new Nn,Bb=new jn,Mb=[],Lb=[],Fb=[],zb=function(){function e(){this._chunks=[],this._freelists=[],this._createChunk()}var t=e.prototype;return t.alloc=function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)},t.free=function(e,t){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===e)return void this._freelists[i].push(t)},t.clear=function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)},t._createChunk=function(){this._chunks.push(new Uint32Array(e.CAPACITY_PER_CHUNK));for(var t=[],n=e.CAPACITY_PER_CHUNK-1;n>=0;n--)t.push(n);this._freelists.push(t)},t._createView=function(e){return Fb[0]=this._chunks[e],Fb[1]=this._freelists[e].pop(),Fb},e}();zb.CAPACITY_PER_CHUNK=256;var Vb,Gb,Ub,kb,Hb,jb,Wb,qb,Xb,Yb,Kb,Jb,Qb,Zb,$b,eT,tT,nT,iT,rT,oT,aT,sT,cT,lT,uT,hT,_T,fT,dT,pT,mT,vT,gT,yT,xT,ST,CT,AT,bT,TT,ET,wT,IT,PT,RT,DT,OT,NT,BT,MT,LT,FT,zT,VT,GT,UT,kT,HT,jT,WT,qT,XT,YT,KT,JT,QT,ZT,$T,eE=new zb,tE=Symbol("ReserveContentsForAllSyncablePrefab"),nE=e("Node",(mb=Ac("cc.Node"),vb=ol(Pn),mb((Eb=Tb=function(e){Z(n,e);var t=n.prototype;function n(t){var n;return(n=e.call(this,t)||this)._uiProps=new ub(re(n)),n._static=!1,se(n,"_lpos",xb,re(n)),se(n,"_lrot",Sb,re(n)),se(n,"_lscale",Cb,re(n)),se(n,"_layer",Ab,re(n)),se(n,"_euler",bb,re(n)),n._dirtyFlagsPri=py.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return t._init=function(){var e=eE.alloc(),t=e[0],n=e[1];this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=n;var i=new Uint32Array(t.buffer,t.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new Pn,this._rot=new Ln,this._scale=new Pn(1,1,1),this._mat=new jn},n.isNode=function(e){return e instanceof n&&(e.constructor===n||!(e instanceof l.Scene))},t._onPreDestroy=function(){var e=this._onPreDestroyBase();return eE.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e},t[ah]=function(e){e.writeThis()},t.setParent=function(t,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,n)},t._onSetParent=function(t,n){if(e.prototype._onSetParent.call(this,t,n),n){var i=this._parent;i?(i.updateWorldTransform(),sn(jn.determinant(i._mat),0,on)?(R(14200),this._dirtyFlags|=py.TRS,this.updateWorldTransform()):(jn.multiply(Bb,jn.invert(Bb,i._mat),this._mat),jn.toRTS(Bb,this._lrot,this._lpos,this._lscale))):(Pn.copy(this._lpos,this._pos),Ln.copy(this._lrot,this._rot),Pn.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(py.TRS)},t._onHierarchyChanged=function(t){this.eventProcessor.reattach(),e.prototype._onHierarchyChangedBase.call(this,t)},t._onBatchCreated=function(e){this.hasChangedFlags=py.TRS,this._dirtyFlags|=py.TRS;for(var t=this._children.length,n=0;n<t;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)},t._onBeforeSerialize=function(){this.eulerAngles},t._onPostActivated=function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(py.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},t.translate=function(e,t){var n=t||dy.LOCAL;if(n===dy.LOCAL)Pn.transformQuat(Ib,e,this._lrot),this._lpos.x+=Ib.x,this._lpos.y+=Ib.y,this._lpos.z+=Ib.z;else if(n===dy.WORLD)if(this._parent){Ln.invert(Pb,this._parent.worldRotation),Pn.transformQuat(Ib,e,Pb);var i=this.worldScale;this._lpos.x+=Ib.x/i.x,this._lpos.y+=Ib.y/i.y,this._lpos.z+=Ib.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(py.POSITION),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.POSITION)},t.rotate=function(e,t){var n=t||dy.LOCAL;if(Ln.normalize(Pb,e),n===dy.LOCAL)Ln.multiply(this._lrot,this._lrot,Pb);else if(n===dy.WORLD){var i=this.worldRotation;Ln.multiply(Rb,Pb,i),Ln.invert(Pb,i),Ln.multiply(Rb,Pb,Rb),Ln.multiply(this._lrot,this._lrot,Rb)}this._eulerDirty=!0,this.invalidateChildren(py.ROTATION),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.ROTATION)},t.lookAt=function(e,t){this.getWorldPosition(Ib),Pn.subtract(Ib,Ib,e),Pn.normalize(Ib,Ib),Ln.fromViewUp(Pb,Ib,t),this.setWorldRotation(Pb)},t._setDirtyNode=function(e,t){Mb[e]=t},t.invalidateChildren=function(e){var t,n,i,r=0,o=0,a=0,s=0,c=0,l=e|py.POSITION;for(Mb[0]=this;r>=0;){if(c=(t=Mb[r--])._hasChangedFlags[0],s=t._dirtyFlagsPri,t.isValid&&(s&c&e)!==e)for(s|=e,t._dirtyFlagsPri=s,t._hasChangedFlags[0]=c|e,a=(i=t._children).length,o=0;o<a;o++)n=i[o],Mb[++r]=n;e=l}},t.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)this._setDirtyNode(n++,t),t=t._parent;for(var i=0;n;)i|=(e=Mb[--n])._dirtyFlags,t?(i&py.POSITION&&(Pn.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&py.RS&&(jn.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),jn.multiply(e._mat,t._mat,e._mat),i&py.ROTATION&&Ln.multiply(e._rot,t._rot,e._lrot),Nn.fromQuat(Ob,Ln.conjugate(Db,e._rot)),Nn.multiplyMat4(Ob,Ob,e._mat),e._scale.x=Ob.m00,e._scale.y=Ob.m04,e._scale.z=Ob.m08)):(i&py.POSITION&&(Pn.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&py.RS&&(i&py.ROTATION&&Ln.copy(e._rot,e._lrot),i&py.SCALE&&(Pn.copy(e._scale,e._lscale),jn.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=py.NONE,t=e}},t.setPosition=function(e,t,n){void 0===t&&void 0===n?Pn.copy(this._lpos,e):void 0===n?Pn.set(this._lpos,e,t,this._lpos.z):Pn.set(this._lpos,e,t,n),this.invalidateChildren(py.POSITION),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.POSITION)},t.getPosition=function(e){return e?Pn.set(e,this._lpos.x,this._lpos.y,this._lpos.z):Pn.copy(new Pn,this._lpos)},t.setRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Ln.copy(this._lrot,e):Ln.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(py.ROTATION),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.ROTATION)},t.setRotationFromEuler=function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(Pn.copy(this._euler,e),Ln.fromEuler(this._lrot,e.x,e.y,e.z)):(Pn.set(this._euler,e,t,i),Ln.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(py.ROTATION),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.ROTATION)},t.getRotation=function(e){return e?Ln.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Ln.copy(new Ln,this._lrot)},t.setScale=function(e,t,n){void 0===t&&void 0===n?Pn.copy(this._lscale,e):void 0===n?Pn.set(this._lscale,e,t,this._lscale.z):Pn.set(this._lscale,e,t,n),this.invalidateChildren(py.SCALE),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.SCALE)},t.getScale=function(e){return e?Pn.set(e,this._lscale.x,this._lscale.y,this._lscale.z):Pn.copy(new Pn,this._lscale)},t.inverseTransformPoint=function(e,t){Pn.copy(e,t);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)Pn.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=Mb[--i];return e},t.setWorldPosition=function(e,t,n){void 0===t||void 0===n?Pn.copy(this._pos,e):Pn.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),Pn.transformMat4(r,this._pos,jn.invert(Bb,i._mat))):Pn.copy(r,this._pos),this.invalidateChildren(py.POSITION),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.POSITION)},t.getWorldPosition=function(e){return this.updateWorldTransform(),e?Pn.copy(e,this._pos):Pn.copy(new Pn,this._pos)},t.setWorldRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Ln.copy(this._rot,e):Ln.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),Ln.multiply(this._lrot,Ln.conjugate(this._lrot,this._parent._rot),this._rot)):Ln.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(py.ROTATION),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.ROTATION)},t.setWorldRotationFromEuler=function(e,t,n){Ln.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),Ln.multiply(this._lrot,Ln.conjugate(this._lrot,this._parent._rot),this._rot)):Ln.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(py.ROTATION),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.ROTATION)},t.getWorldRotation=function(e){return this.updateWorldTransform(),e?Ln.copy(e,this._rot):Ln.copy(new Ln,this._rot)},t.setWorldScale=function(e,t,n){void 0===t||void 0===n?Pn.copy(this._scale,e):Pn.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),Nn.fromQuat(Ob,Ln.conjugate(Db,i._rot)),Nn.multiplyMat4(Ob,Ob,i._mat),Nb.m00=this._scale.x,Nb.m04=this._scale.y,Nb.m08=this._scale.z,Nn.multiply(Ob,Nb,Nn.invert(Ob,Ob)),this._lscale.x=Pn.set(Ib,Ob.m00,Ob.m01,Ob.m02).length(),this._lscale.y=Pn.set(Ib,Ob.m03,Ob.m04,Ob.m05).length(),this._lscale.z=Pn.set(Ib,Ob.m06,Ob.m07,Ob.m08).length()):Pn.copy(this._lscale,this._scale),this.invalidateChildren(py.SCALE),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.SCALE)},t.getWorldScale=function(e){return this.updateWorldTransform(),e?Pn.copy(e,this._scale):Pn.copy(new Pn,this._scale)},t.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new jn;return jn.copy(t,this._mat)},t.getWorldRS=function(e){this.updateWorldTransform();var t=e||new jn;return jn.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},t.getWorldRT=function(e){this.updateWorldTransform();var t=e||new jn;return jn.fromRT(t,this._rot,this._pos)},t.setRTS=function(e,t,n){var i=0;e&&(i|=py.ROTATION,void 0!==e.w?(Ln.copy(this._lrot,e),this._eulerDirty=!0):(Pn.copy(this._euler,e),Ln.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(Pn.copy(this._lpos,t),i|=py.POSITION),n&&(Pn.copy(this._lscale,n),i|=py.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,i))},t.pauseSystemEvents=function(e){this._eventProcessor.setEnabled(!1,e)},t.resumeSystemEvents=function(e){this._eventProcessor.setEnabled(!0,e)},n.resetHasChangedFlags=function(){eE.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,Mb.length=0,Lb.length=0)},t.getPathInHierarchy=function(){for(var e=this.name,t=this.parent;t&&t instanceof n;)e=t.name+"/"+e,t=t.parent;return e},J(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Ln.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){Pn.set(this._euler,0,0,e),Ln.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(py.ROTATION),1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){jn.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(py.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(eb.TRANSFORM_CHANGED,py.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return Pn.transformQuat(new Pn,Pn.FORWARD,this.worldRotation)},set:function(e){var t=e.length();Pn.multiplyScalar(Ib,e,-1/t),Ln.fromViewUp(Pb,Ib),this.setWorldRotation(Pb)}},{key:"up",get:function(){return Pn.transformQuat(new Pn,Pn.UP,this.worldRotation)}},{key:"right",get:function(){return Pn.transformQuat(new Pn,Pn.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(eb.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}}]),n}(wb),Tb.EventType=eb,Tb.NodeSpace=dy,Tb.TransformDirtyBit=py,Tb.TransformBit=py,Tb.reserveContentsForAllSyncablePrefabTag=tE,Tb.ClearFrame=0,Tb.ClearRound=1e3,xb=ce((yb=Eb).prototype,"_lpos",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn}}),Sb=ce(yb.prototype,"_lrot",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln}}),Cb=ce(yb.prototype,"_lscale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(1,1,1)}}),Ab=ce(yb.prototype,"_layer",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cd.Enum.DEFAULT}}),bb=ce(yb.prototype,"_euler",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn}}),ce(yb.prototype,"eulerAngles",[vb],Object.getOwnPropertyDescriptor(yb.prototype,"eulerAngles"),yb.prototype),ce(yb.prototype,"angle",[kc],Object.getOwnPropertyDescriptor(yb.prototype,"angle"),yb.prototype),ce(yb.prototype,"layer",[kc],Object.getOwnPropertyDescriptor(yb.prototype,"layer"),yb.prototype),gb=yb))||gb));l.Node=nE;var iE=Ac("cc.TargetInfo")((Ub=ce((Gb=function(){se(this,"localID",Ub,this)}).prototype,"localID",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vb=Gb))||Vb,rE=(kb=Ac("cc.TargetOverrideInfo"),Hb=ol(fl),jb=ol(iE),Wb=ol(nE),qb=ol(iE),kb((Kb=ce((Yb=function(){se(this,"source",Kb,this),se(this,"sourceInfo",Jb,this),se(this,"propertyPath",Qb,this),se(this,"target",Zb,this),se(this,"targetInfo",$b,this)}).prototype,"source",[Dc,Hb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Jb=ce(Yb.prototype,"sourceInfo",[Dc,jb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qb=ce(Yb.prototype,"propertyPath",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zb=ce(Yb.prototype,"target",[Dc,Wb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$b=ce(Yb.prototype,"targetInfo",[Dc,qb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xb=Yb))||Xb),oE=Ac("cc.CompPrefabInfo")((nT=ce((tT=function(){se(this,"fileId",nT,this)}).prototype,"fileId",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),eT=tT))||eT,aE=(iT=Ac("CCPropertyOverrideInfo"),rT=ol(iE),iT((uT=function(){function e(){se(this,"targetInfo",sT,this),se(this,"propertyPath",cT,this),se(this,"value",lT,this)}return e.prototype.isTarget=function(){},e}(),sT=ce((aT=uT).prototype,"targetInfo",[Dc,rT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cT=ce(aT.prototype,"propertyPath",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lT=ce(aT.prototype,"value",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),oT=aT))||oT),sE=(hT=Ac("cc.MountedChildrenInfo"),_T=ol(iE),fT=ol([nE]),hT((gT=function(){function e(){se(this,"targetInfo",mT,this),se(this,"nodes",vT,this)}return e.prototype.isTarget=function(){},e}(),mT=ce((pT=gT).prototype,"targetInfo",[Dc,_T],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vT=ce(pT.prototype,"nodes",[Dc,fT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dT=pT))||dT),cE=(yT=Ac("cc.MountedComponentsInfo"),xT=ol(iE),ST=ol([Ku]),yT((ET=function(){function e(){se(this,"targetInfo",bT,this),se(this,"components",TT,this)}return e.prototype.isTarget=function(){},e}(),bT=ce((AT=ET).prototype,"targetInfo",[Dc,xT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TT=ce(AT.prototype,"components",[Dc,ST],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CT=AT))||CT),lE=(wT=Ac("cc.PrefabInstance"),IT=ol(nE),PT=ol([sE]),RT=ol([cE]),DT=ol([aE]),OT=ol([iE]),wT((UT=function(){function e(){se(this,"fileId",MT,this),se(this,"prefabRootNode",LT,this),se(this,"mountedChildren",FT,this),se(this,"mountedComponents",zT,this),se(this,"propertyOverrides",VT,this),se(this,"removedComponents",GT,this),this.targetMap={}}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),MT=ce((BT=UT).prototype,"fileId",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),LT=ce(BT.prototype,"prefabRootNode",[Dc,IT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),FT=ce(BT.prototype,"mountedChildren",[Dc,PT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zT=ce(BT.prototype,"mountedComponents",[Dc,RT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VT=ce(BT.prototype,"propertyOverrides",[Dc,DT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),GT=ce(BT.prototype,"removedComponents",[Dc,OT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NT=BT))||NT),uE=(kT=Ac("cc.PrefabInfo"),HT=ol(nE),jT=ol(lE),WT=ol([rE]),kT((YT=ce((XT=function(){se(this,"root",YT,this),se(this,"asset",KT,this),se(this,"fileId",JT,this),se(this,"instance",QT,this),se(this,"targetOverrides",ZT,this),se(this,"nestedPrefabInstanceRoots",$T,this)}).prototype,"root",[Dc,HT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),KT=ce(XT.prototype,"asset",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),JT=ce(XT.prototype,"fileId",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),QT=ce(XT.prototype,"instance",[Dc,jT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ZT=ce(XT.prototype,"targetOverrides",[Dc,WT],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),$T=ce(XT.prototype,"nestedPrefabInstanceRoots",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),qT=XT))||qT);function hE(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return O(3701,e.name),void(t.instance=void 0);var n=e._objFlags,i=e._parent,r=e._id,o=e._prefab;e[cl],l.game._isCloning=!0,t.asset._doInstantiate(e),l.game._isCloning=!1,e._objFlags=n,e._parent=i,e._id=r,e._prefab&&(e._prefab.instance=null==o?void 0:o.instance)}}function _E(e,t,n){var i;if(t&&e){var r=t,o=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&o&&(t[o.fileId]={},r=t[o.fileId]);var a=e._prefab;a&&(r[a.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)_E(e.children[u],r,!1)}}function fE(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function dE(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=fE(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&!o._children.includes(u)&&(o._children.push(u),u._parent=o,_E(u,a,!1),u._siblingIndex=o._children.length-1,yE(u,!0))}}}}function pE(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=fE(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function mE(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r){var o=fE(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function vE(e,t,n){if(!(t.length<=0))for(var i=null,r=0;r<t.length;r++){var o=t[r];if(o&&o.targetInfo){if(!(i=fE(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof ct?a[c].set(o.value):a[c]=o.value}}}}function gE(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=fE(c.localID,h.targetMap))}if(s){var _,f=a.targetInfo;if(f){var d=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(d&&d.targetMap&&(_=fE(f.localID,d.targetMap))){var p=a.propertyPath.slice(),m=s;if(p.length>0){var v=p.pop();if(!v)return;for(var g=0;g<p.length&&(m=m[p[g]]);g++);if(!m)continue;m[v]=_}}}}}}function yE(e,t){void 0===t&&(t=!1);var n=e._prefab,i=null==n?void 0:n.instance;if(i){hE(e);var r={};i.targetMap=r,_E(e,r,!0),dE(0,i.mountedChildren,r),mE(0,i.removedComponents,r),pE(0,i.mountedComponents,r),vE(0,i.propertyOverrides,r)}t&&e&&e.children&&e.children.forEach((function(e){yE(e,!0)}))}function xE(e){var t=e._prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){yE(e)}))}l._PrefabInfo=uE;var SE,CE,AE,bE,TE,EE,wE,IE,PE,RE,DE,OE,NE,BE,ME=Object.freeze({__proto__:null,TargetInfo:iE,TargetOverrideInfo:rE,CompPrefabInfo:oE,PropertyOverrideInfo:aE,MountedChildrenInfo:sE,MountedComponentsInfo:cE,PrefabInstance:lE,PrefabInfo:uE,createNodeWithPrefab:hE,generateTargetMap:_E,getTarget:fE,applyMountedChildren:dE,applyMountedComponents:pE,applyRemovedComponents:mE,applyPropertyOverrides:vE,applyTargetOverrides:gE,expandPrefabInstanceNode:yE,expandNestedPrefabInstanceNode:xE}),LE=rt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),FE=e("Prefab",Ac("cc.Prefab")((wE=EE=function(e){function t(){var t;return se(t=e.call(this)||this,"data",AE,re(t)),se(t,"optimizationPolicy",bE,re(t)),se(t,"persistent",TE,re(t)),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}Z(t,e);var n=t.prototype;return n.createNode=function(e){var t=l.instantiate(this);t.name=this.name,e(null,t)},n.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof l._BaseNode&&e,new ZA(e,t).result)},n._doInstantiate=function(e){return this.data._prefab||R(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},n._instantiate=function(){var e;return this.optimizationPolicy!==LE.SINGLE_INSTANCE&&(this.optimizationPolicy===LE.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new nE,this.data.name="(Missing Node)";var n=new l._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var e=this.data;xE(e),gE(e)},t}(Iu),EE.OptimizationPolicy=LE,EE.OptimizationPolicyThreshold=3,AE=ce((CE=wE).prototype,"data",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bE=ce(CE.prototype,"optimizationPolicy",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return LE.AUTO}}),TE=ce(CE.prototype,"persistent",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),SE=CE))||SE);nt.value(FE,"_utils",ME),l.Prefab=FE,Pe(l,"cc._Prefab","Prefab"),e("PrefabLink",(IE=Ac("cc.PrefabLink"),PE=ol(FE),RE=Hc(),IE((BE=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"prefab",NE,re(t)),t}return Z(t,e),t}(Ku),NE=ce((OE=BE).prototype,"prefab",[PE,Dc,RE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DE=OE))||DE));var zE=new Pn;function VE(e,t,n,i){i||(i=new Pn),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function GE(e,t,n){return n||(n=new Pn),e.worldToScreen(t,n),n.x/=l.view.getScaleX(),n.y/=l.view.getScaleY(),n}var UE,kE,HE=e("convertUtils",{WorldNode3DToLocalNodeUI:VE,WorldNode3DToWorldNodeUI:GE});l.pipelineUtils=HE,V(l.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||zE;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),G(Vm.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),V(DC.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var jE,WE=e("BufferAsset",Ac("cc.BufferAsset")((ce((kE=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._buffer=null,t}Z(t,e);var n=t.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},J(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(Iu)).prototype,"_nativeAsset",[sl],Object.getOwnPropertyDescriptor(kE.prototype,"_nativeAsset"),kE.prototype),UE=kE))||UE);l.BufferAsset=WE;var qE=((jE={})[di.UNORM]="Uint",jE[di.SNORM]="Int",jE[di.UINT]="Uint",jE[di.INT]="Int",jE[di.UFLOAT]="Float",jE[di.FLOAT]="Float",jE.default="Uint",jE);function XE(e){return""+(qE[e.type]||qE.default)+e.size/e.count*8}function YE(e,t,n,i,r,o,a){void 0===n&&(n=fi.R32F),void 0===i&&(i=0),void 0===r&&(r=e.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=no[n];o||(o=s.size);for(var c="set"+XE(s),l="get"+XE(s),u=s.size/s.count,h=Math.floor(r/o),_=oh.isLittleEndian,f=0;f<h;++f)for(var d=i+o*f,p=0;p<s.count;++p){var m=d+u*p,v=e[l](m,_);a[c](m,t(v,p,e),_)}return a}var KE,JE,QE=e("RenderingSubMesh",function(){var e=t.prototype;function t(e,t,n,i,r,o){void 0===i&&(i=null),void 0===r&&(r=null),void 0===o&&(o=!0),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._isOwnerOfIndexBuffer=!0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new Br(t,e,i,r),this._isOwnerOfIndexBuffer=o,this._init()}return e._init=function(){},e.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx];n.indexView&&(t=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=e.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(e.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=e.readIndices(this.subMeshIdx),_=0;_<t;++_)for(var f=_*s,d=h[_]*s,p=0;p<s;++p)u[f+p]=l[d+p];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(e.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},e.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._isOwnerOfIndexBuffer&&this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},e.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new Or("a_vertexId",fi.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}},e._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},J(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Pn.ZERO,max:Pn.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Pn.ZERO,max:Pn.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,$i.ATTR_POSITION),i=e.readIndices(t),r=new Pn,o=new Pn,a=this.attributes.find((function(e){return e.name===$i.ATTR_POSITION}));if(a){var s=no[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,o=this.mesh.struct,a=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===a.jointMapIndex||!o.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=l.director.root.device,c=0;c<a.vertexBundelIndices.length;c++){var u=o.vertexBundles[a.vertexBundelIndices[c]];r=0,i=fi.UNKNOWN;for(var h=0;h<u.attributes.length;h++){var _=u.attributes[h];if(_.name===$i.ATTR_JOINTS){i=_.format;break}r+=no[_.format].size}i?function(){var l=new Uint8Array(e.mesh.data.buffer,u.view.offset,u.view.length),h=new DataView(l.slice().buffer),_=o.jointMaps[a.jointMapIndex];YE(h,(function(e){return _.indexOf(e)}),i,r,u.view.length,u.view.stride,h);var f=s.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,u.view.length,u.view.stride));f.update(h.buffer),t.push(f),n.push(c)}():t.push(this.vertexBuffers[a.vertexBundelIndices[c]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(s)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),t}());!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(KE||(KE=e("SystemEventType",{}))),function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.KEY_DOWN="keydown",e.KEY_PRESSING="key-pressing",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion"}(JE||(JE={})),l.SystemEventType=KE;var ZE,$E=new Array(16),ew=null,tw=new Yn,nw=[eb.TOUCH_START,eb.TOUCH_MOVE,eb.TOUCH_END,eb.TOUCH_CANCEL],iw=[eb.MOUSE_DOWN,eb.MOUSE_ENTER,eb.MOUSE_MOVE,eb.MOUSE_LEAVE,eb.MOUSE_UP,eb.MOUSE_WHEEL];!function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",e[e.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(ZE||(ZE={}));var rw,ow,aw,sw,cw,lw,uw,hw,_w,fw,dw,pw,mw,vw,gw,yw,xw,Sw,Cw,Aw,bw,Tw,Ew,ww,Iw,Pw,Rw,Dw,Ow,Nw,Bw,Mw,Lw,Fw,zw,Vw,Gw,Uw,kw,Hw,jw,Ww,qw,Xw,Yw,Kw,Jw,Qw,Zw,$w,eI,tI,nI,iI,rI,oI,aI,sI,cI,lI,uI,hI,_I,fI,dI,pI,mI,vI,gI,yI,xI,SI,CI,AI,bI,TI,EI,wI,II,PI,RI,DI,OI,NI,BI,MI,LI,FI,zI,VI,GI,UI,kI,HI,jI,WI,qI,XI,YI,KI,JI,QI,ZI,$I,eP,tP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,_P,fP,dP,pP,mP,vP,gP,yP,xP,SP,CP,AP,bP,TP,EP,wP,IP,PP,RP,DP,OP,NP,BP,MP,LP=function(){function e(e){this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._isEnabled=!1,this._node=void 0,this._node=e}var t=e.prototype;return t.setEnabled=function(t,n){if(void 0===n&&(n=!1),this._isEnabled!==t){this._isEnabled=t;var i=this.node.children;if(t&&this._attachMask(),e.callbacksInvoker.emit(ZE.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(t,!0)}},t.reattach=function(){var t,n=this;this.node.walk((function(i){t||(t=n._searchComponentsInParent(e._maskComp)),i.eventProcessor.maskList=t}))},t.destroy=function(){ew===this._node&&(ew=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),e.callbacksInvoker.emit(ZE.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.on=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n),t},t.once=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n,!0),t},t.off=function(e,t,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(e,t,n)},t.targetOff=function(t){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(t),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(t),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||e.callbacksInvoker.emit(ZE.REMOVE_POINTER_EVENT_PROCESSOR,this)},t.emit=function(e,t,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){var t,n=this.node,i=0;for(e.target=n,$E.length=0,this.getCapturingTargets(e.type,$E),e.eventPhase=1,i=$E.length-1;i>=0;--i)if((t=$E[i]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,$E),e.propagationStopped))return void($E.length=0);if($E.length=0,e.eventPhase=2,e.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,$E),e.eventPhase=3,i=0;i<$E.length;++i)if((t=$E[i]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void($E.length=0);$E.length=0},t.hasEventListener=function(e,t,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(e,t,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(e,t,n)),i},t.getCapturingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},t.getBubblingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},t._searchComponentsInParent=function(e){var t=this.node;if(e){for(var n=0,i=[],r=t;r&&nE.isNode(r);r=r.parent,++n){var o=r.getComponent(e);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},t._attachMask=function(){this.maskList=this._searchComponentsInParent(e._maskComp)},t._isTouchEvent=function(e){return-1!==nw.indexOf(e)},t._isMouseEvent=function(e){return-1!==iw.indexOf(e)},t._hasTouchListeners=function(){for(var e=0;e<nw.length;++e){var t=nw[e];if(this.hasEventListener(t))return!0}return!1},t._hasMouseListeners=function(){for(var e=0;e<iw.length;++e){var t=iw[e];if(this.hasEventListener(t))return!0}return!1},t._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},t._tryEmittingAddEvent=function(t){var n=this._isTouchEvent(t),i=this._isMouseEvent(t);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||e.callbacksInvoker.emit(ZE.ADD_POINTER_EVENT_PROCESSOR,this)},t._newCallbacksInvoker=function(){var t=this,n=new Zl;return n._registerOffCallback((function(){t.shouldHandleEventTouch&&!t._hasTouchListeners()&&(t.shouldHandleEventTouch=!1),t.shouldHandleEventMouse&&!t._hasMouseListeners()&&(t.shouldHandleEventMouse=!1),t._hasPointerListeners()||e.callbacksInvoker.emit(ZE.REMOVE_POINTER_EVENT_PROCESSOR,t)})),n},t._handleEventMouse=function(e){switch(e.type){case JE.MOUSE_DOWN:return this._handleMouseDown(e);case JE.MOUSE_MOVE:return this._handleMouseMove(e);case JE.MOUSE_UP:return this._handleMouseUp(e);case JE.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},t._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(tw),!t._uiProps.uiTransformComp.hitTest(tw)||(e.type=eb.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(tw),t._uiProps.uiTransformComp.hitTest(tw)?(this.previousMouseIn||(ew&&ew!==t&&(e.type=eb.MOUSE_LEAVE,ew.dispatchEvent(e),ew.eventProcessor.previousMouseIn=!1),ew=t,e.type=eb.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=eb.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=eb.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,ew=null),1)))},t._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(tw),!t._uiProps.uiTransformComp.hitTest(tw)||(e.type=eb.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(tw),!t._uiProps.uiTransformComp.hitTest(tw)||(e.type=eb.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},t._handleEventTouch=function(e){switch(e.type){case JE.TOUCH_START:return this._handleTouchStart(e);case JE.TOUCH_MOVE:return this._handleTouchMove(e);case JE.TOUCH_END:return this._handleTouchEnd(e);case JE.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},t._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getLocation(tw),!t._uiProps.uiTransformComp.hitTest(tw)||(e.type=eb.TOUCH_START,e.bubbles=!0,t.dispatchEvent(e),0)))},t._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=eb.TOUCH_MOVE,e.bubbles=!0,t.dispatchEvent(e),0))},t._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getLocation(tw),t._uiProps.uiTransformComp.hitTest(tw)?e.type=eb.TOUCH_END:e.type=eb.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},t._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=eb.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},J(e,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),e}();LP._maskComp=null,LP.callbacksInvoker=new Zl,l.NodeEventProcessor=LP;var FP=new Pn(0,1,0),zP=new Pn,VP=new Zn,GP=new wn,UP=new Ln,kP=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},HP=e("AmbientInfo",(rw=Ac("cc.AmbientInfo"),ow=Hc(),aw=qc(),sw=ol(Ot),cw=qc(),lw=Hc(),uw=qc(),hw=Oc("_skyColor"),_w=Oc("_skyIllum"),fw=Oc("_groundAlbedo"),rw((ce((pw=function(){function e(){se(this,"_skyColorHDR",mw,this),se(this,"_skyIllumHDR",vw,this),se(this,"_groundAlbedoHDR",gw,this),se(this,"_skyColorLDR",yw,this),se(this,"_skyIllumLDR",xw,this),se(this,"_groundAlbedoLDR",Sw,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},J(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=l.director.root.pipeline.pipelineSceneData.isHDR;return VP.set(e?this._skyColorHDR:this._skyColorLDR),kP(VP),GP.set(255*VP.x,255*VP.y,255*VP.z,255)},set:function(e){VP.set(e.x,e.y,e.z,e.w),l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(VP):this._skyColorLDR.set(VP),this._resource&&this._resource.skyColor.set(VP)}},{key:"skyColor",set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=l.director.root.pipeline.pipelineSceneData.isHDR;return VP.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),kP(VP),GP.set(255*VP.x,255*VP.y,255*VP.z,255)},set:function(e){VP.set(e.x,e.y,e.z,e.w),l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(VP):this._groundAlbedoLDR.set(VP),this._resource&&this._resource.groundAlbedo.set(VP)}},{key:"groundAlbedo",set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}}]),e}()).prototype,"skyLightingColor",[ow,kc,aw],Object.getOwnPropertyDescriptor(pw.prototype,"skyLightingColor"),pw.prototype),ce(pw.prototype,"skyIllum",[kc,sw,cw],Object.getOwnPropertyDescriptor(pw.prototype,"skyIllum"),pw.prototype),ce(pw.prototype,"groundLightingColor",[lw,kc,uw],Object.getOwnPropertyDescriptor(pw.prototype,"groundLightingColor"),pw.prototype),mw=ce(pw.prototype,"_skyColorHDR",[Dc,hw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.5,.8,1)}}),vw=ce(pw.prototype,"_skyIllumHDR",[Dc,_w],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iy.SKY_ILLUM}}),gw=ce(pw.prototype,"_groundAlbedoHDR",[Dc,fw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.2,.2,1)}}),yw=ce(pw.prototype,"_skyColorLDR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.5,.8,1)}}),xw=ce(pw.prototype,"_skyIllumLDR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iy.SKY_ILLUM}}),Sw=ce(pw.prototype,"_groundAlbedoLDR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Zn(.2,.2,.2,1)}}),dw=pw))||dw));l.AmbientInfo=HP;var jP=e("SkyboxInfo",(Cw=Ac("cc.SkyboxInfo"),Aw=qc(),bw=ol(cy),Tw=qc(),Ew=qc(),ww=ol(hv),Iw=qc(),Pw=Hc(),Rw=ol(hv),Dw=Zc(),Ow=ol(hv),Nw=Oc("_envmap"),Bw=ol(hv),Mw=ol(hv),Lw=ol(hv),Cw((ce((zw=function(){function e(){se(this,"_envLightingType",Vw,this),se(this,"_envmapHDR",Gw,this),se(this,"_envmapLDR",Uw,this),se(this,"_diffuseMapHDR",kw,this),se(this,"_diffuseMapLDR",Hw,this),se(this,"_enabled",jw,this),se(this,"_useHDR",Ww,this),this._resource=null}return e.prototype.activate=function(e){this.envLightingType=this._envLightingType,this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},J(e,[{key:"applyDiffuseMap",get:function(){return cy.DIFFUSEMAP_WITH_REFLECTION===this._envLightingType},set:function(e){this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"envLightingType",get:function(){return this._envLightingType},set:function(e){this.envmap||cy.HEMISPHERE_DIFFUSE===e?(cy.HEMISPHERE_DIFFUSE===e?(this.useIBL=!1,this.applyDiffuseMap=!1):cy.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION===e?(this.useIBL=!0,this.applyDiffuseMap=!1):cy.DIFFUSEMAP_WITH_REFLECTION===e&&(this.useIBL=!0,this.applyDiffuseMap=!0),this._envLightingType=e):(this.useIBL=!1,this.applyDiffuseMap=!1,this._envLightingType=cy.HEMISPHERE_DIFFUSE,R(15001))}},{key:"useIBL",get:function(){return cy.HEMISPHERE_DIFFUSE!==this._envLightingType},set:function(e){this._resource&&(this._resource.useIBL=e)}},{key:"useHDR",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,this.envLightingType===cy.DIFFUSEMAP_WITH_REFLECTION&&(null===this.diffuseMap?(this.envLightingType=cy.AUTOGEN_HEMISPHERE_DIFFUSE_WITH_REFLECTION,R(15e3)):this.diffuseMap.isDefault&&R(15002))),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){var t=l.director.root.pipeline.pipelineSceneData.isHDR;t?this._envmapHDR=e:this._envmapLDR=e,e||(t?this._diffuseMapHDR=null:this._diffuseMapLDR=null,this.applyDiffuseMap=!1,this.useIBL=!1,this.envLightingType=cy.HEMISPHERE_DIFFUSE,R(15001)),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this.applyDiffuseMap,this._resource.envmap=e)}},{key:"diffuseMap",get:function(){return l.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){l.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),e}()).prototype,"enabled",[kc,Aw],Object.getOwnPropertyDescriptor(zw.prototype,"enabled"),zw.prototype),ce(zw.prototype,"envLightingType",[kc,bw,Tw],Object.getOwnPropertyDescriptor(zw.prototype,"envLightingType"),zw.prototype),ce(zw.prototype,"useHDR",[kc,Ew],Object.getOwnPropertyDescriptor(zw.prototype,"useHDR"),zw.prototype),ce(zw.prototype,"envmap",[kc,ww,Iw],Object.getOwnPropertyDescriptor(zw.prototype,"envmap"),zw.prototype),ce(zw.prototype,"diffuseMap",[Pw,kc,jc,Rw,Dw],Object.getOwnPropertyDescriptor(zw.prototype,"diffuseMap"),zw.prototype),Vw=ce(zw.prototype,"_envLightingType",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cy.HEMISPHERE_DIFFUSE}}),Gw=ce(zw.prototype,"_envmapHDR",[Dc,Ow,Nw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uw=ce(zw.prototype,"_envmapLDR",[Dc,Bw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kw=ce(zw.prototype,"_diffuseMapHDR",[Dc,Mw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Hw=ce(zw.prototype,"_diffuseMapLDR",[Dc,Lw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jw=ce(zw.prototype,"_enabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ww=ce(zw.prototype,"_useHDR",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Fw=zw))||Fw));l.SkyboxInfo=jP;var WP=e("FogInfo",(qw=Ac("cc.FogInfo"),Xw=qc(),Yw=Zc(),Kw=qc(),Jw=Zc(),Qw=qc(),Zw=ol(hy),$w=Zc(),eI=qc(),tI=Hc(),nI=ol(Ot),iI=Xc(),rI=Jc(),oI=qc(),aI=Hc(),sI=ol(Ot),cI=Jc(),lI=qc(),uI=Hc(),hI=ol(Ot),_I=Jc(),fI=qc(),dI=Hc(),pI=ol(Ot),mI=Yc(),vI=Jc(),gI=qc(),yI=Hc(),xI=ol(Ot),SI=Jc(),CI=qc(),AI=Hc(),bI=ol(Ot),TI=Jc(),EI=qc(),qw((GI=VI=function(){function e(){se(this,"_type",PI,this),se(this,"_fogColor",RI,this),se(this,"_enabled",DI,this),se(this,"_fogDensity",OI,this),se(this,"_fogStart",NI,this),se(this,"_fogEnd",BI,this),se(this,"_fogAtten",MI,this),se(this,"_fogTop",LI,this),se(this,"_fogRange",FI,this),se(this,"_accurate",zI,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),VI.FogType=hy,ce((II=GI).prototype,"enabled",[kc,Xw,Yw],Object.getOwnPropertyDescriptor(II.prototype,"enabled"),II.prototype),ce(II.prototype,"accurate",[kc,Kw,Jw],Object.getOwnPropertyDescriptor(II.prototype,"accurate"),II.prototype),ce(II.prototype,"fogColor",[kc,Qw],Object.getOwnPropertyDescriptor(II.prototype,"fogColor"),II.prototype),ce(II.prototype,"type",[kc,Zw,$w,eI],Object.getOwnPropertyDescriptor(II.prototype,"type"),II.prototype),ce(II.prototype,"fogDensity",[tI,nI,iI,rI,Qc,oI],Object.getOwnPropertyDescriptor(II.prototype,"fogDensity"),II.prototype),ce(II.prototype,"fogStart",[aI,sI,cI,lI],Object.getOwnPropertyDescriptor(II.prototype,"fogStart"),II.prototype),ce(II.prototype,"fogEnd",[uI,hI,_I,fI],Object.getOwnPropertyDescriptor(II.prototype,"fogEnd"),II.prototype),ce(II.prototype,"fogAtten",[dI,pI,mI,vI,gI],Object.getOwnPropertyDescriptor(II.prototype,"fogAtten"),II.prototype),ce(II.prototype,"fogTop",[yI,xI,SI,CI],Object.getOwnPropertyDescriptor(II.prototype,"fogTop"),II.prototype),ce(II.prototype,"fogRange",[AI,bI,TI,EI],Object.getOwnPropertyDescriptor(II.prototype,"fogRange"),II.prototype),PI=ce(II.prototype,"_type",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hy.LINEAR}}),RI=ce(II.prototype,"_fogColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn("#C8C8C8")}}),DI=ce(II.prototype,"_enabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),OI=ce(II.prototype,"_fogDensity",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),NI=ce(II.prototype,"_fogStart",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),BI=ce(II.prototype,"_fogEnd",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),MI=ce(II.prototype,"_fogAtten",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),LI=ce(II.prototype,"_fogTop",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),FI=ce(II.prototype,"_fogRange",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),zI=ce(II.prototype,"_accurate",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wI=II))||wI)),qP=e("ShadowsInfo",(UI=Ac("cc.ShadowsInfo"),kI=qc(),HI=ol(ag),jI=Hc(),WI=Hc(),qI=qc(),XI=ol(Ot),YI=Hc(),KI=qc(),JI=ol(Dt),QI=qc(),ZI=Hc(),$I=ol(og),eP=qc(),tP=Hc(),UI((ce((iP=function(){function e(){se(this,"_enabled",rP,this),se(this,"_type",oP,this),se(this,"_normal",aP,this),se(this,"_distance",sP,this),se(this,"_shadowColor",cP,this),se(this,"_maxReceived",lP,this),se(this,"_size",uP,this),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(UP),this.planeDirection=Pn.transformQuat(zP,FP,UP),e.getWorldPosition(zP),this.planeHeight=Pn.dot(this._normal,zP)},t.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"planeDirection",get:function(){return this._normal},set:function(e){Pn.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"planeHeight",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=-e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}}]),e}()).prototype,"enabled",[kc,kI],Object.getOwnPropertyDescriptor(iP.prototype,"enabled"),iP.prototype),ce(iP.prototype,"type",[kc,HI],Object.getOwnPropertyDescriptor(iP.prototype,"type"),iP.prototype),ce(iP.prototype,"shadowColor",[jI],Object.getOwnPropertyDescriptor(iP.prototype,"shadowColor"),iP.prototype),ce(iP.prototype,"planeDirection",[WI,qI],Object.getOwnPropertyDescriptor(iP.prototype,"planeDirection"),iP.prototype),ce(iP.prototype,"planeHeight",[kc,XI,YI,KI],Object.getOwnPropertyDescriptor(iP.prototype,"planeHeight"),iP.prototype),ce(iP.prototype,"maxReceived",[JI,QI,ZI],Object.getOwnPropertyDescriptor(iP.prototype,"maxReceived"),iP.prototype),ce(iP.prototype,"shadowMapSize",[$I,eP,tP],Object.getOwnPropertyDescriptor(iP.prototype,"shadowMapSize"),iP.prototype),rP=ce(iP.prototype,"_enabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oP=ce(iP.prototype,"_type",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ag.Planar}}),aP=ce(iP.prototype,"_normal",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(0,1,0)}}),sP=ce(iP.prototype,"_distance",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cP=ce(iP.prototype,"_shadowColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(0,0,0,76)}}),lP=ce(iP.prototype,"_maxReceived",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),uP=ce(iP.prototype,"_size",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn(512,512)}}),nP=iP))||nP));l.ShadowsInfo=qP;var XP=e("DEFAULT_WORLD_MIN_POS",new Pn(-1024,-1024,-1024)),YP=e("DEFAULT_WORLD_MAX_POS",new Pn(1024,1024,1024)),KP=e("DEFAULT_OCTREE_DEPTH",8),JP=e("OctreeInfo",(hP=Ac("cc.OctreeInfo"),_P=qc(),fP=qc(),dP=Wc(),pP=qc(),mP=Wc(),vP=Xc(),gP=ol(Dt),yP=qc(),hP((ce((SP=function(){function e(){se(this,"_enabled",CP,this),se(this,"_minPos",AP,this),se(this,"_maxPos",bP,this),se(this,"_depth",TP,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}}]),e}()).prototype,"enabled",[kc,_P],Object.getOwnPropertyDescriptor(SP.prototype,"enabled"),SP.prototype),ce(SP.prototype,"minPos",[kc,fP,dP],Object.getOwnPropertyDescriptor(SP.prototype,"minPos"),SP.prototype),ce(SP.prototype,"maxPos",[kc,pP,mP],Object.getOwnPropertyDescriptor(SP.prototype,"maxPos"),SP.prototype),ce(SP.prototype,"depth",[kc,vP,Qc,gP,yP],Object.getOwnPropertyDescriptor(SP.prototype,"depth"),SP.prototype),CP=ce(SP.prototype,"_enabled",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),AP=ce(SP.prototype,"_minPos",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(XP)}}),bP=ce(SP.prototype,"_maxPos",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(YP)}}),TP=ce(SP.prototype,"_depth",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KP}}),xP=SP))||xP)),QP=e("SceneGlobals",(EP=Ac("cc.SceneGlobals"),wP=ol(jP),EP((MP=function(){function e(){se(this,"ambient",RP,this),se(this,"shadows",DP,this),se(this,"_skybox",OP,this),se(this,"fog",NP,this),se(this,"octree",BP,this)}return e.prototype.activate=function(){var e=l.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree)},J(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),RP=ce((PP=MP).prototype,"ambient",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new HP}}),DP=ce(PP.prototype,"shadows",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qP}}),OP=ce(PP.prototype,"_skybox",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jP}}),NP=ce(PP.prototype,"fog",[kc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new WP}}),ce(PP.prototype,"skybox",[kc,wP],Object.getOwnPropertyDescriptor(PP.prototype,"skybox"),PP.prototype),BP=ce(PP.prototype,"octree",[kc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new JP}}),IP=PP))||IP));l.SceneGlobals=QP;var ZP=e("Event",function(){function e(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}var t=e.prototype;return t.unuse=function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},t.reuse=function(e,t){this.type=e,this.bubbles=t||!1},t.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},t.getCurrentTarget=function(){return this.currentTarget},t.getType=function(){return this.type},e}());ZP.NO_TYPE="no_type",ZP.TOUCH="touch",ZP.MOUSE="mouse",ZP.KEYBOARD="keyboard",ZP.ACCELERATION="acceleration",ZP.NONE=0,ZP.CAPTURING_PHASE=1,ZP.AT_TARGET=2,ZP.BUBBLING_PHASE=3,l.Event=ZP;var $P=e("EventAcceleration",function(e){function t(t,n){var i;return(i=e.call(this,KE.DEVICEMOTION,n)||this).acc=void 0,i.acc=t,i}return Z(t,e),t}(ZP));ZP.EventAcceleration=$P;var eR=e("EventKeyboard",function(e){function t(t,n,i){var r;return"boolean"==typeof n&&(n=n?KE.KEY_DOWN:KE.KEY_UP),(r=e.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==KE.KEY_UP,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r}return Z(t,e),J(t,[{key:"isPressed",get:function(){return this._isPressed}}]),t}(ZP));ZP.EventKeyboard=eR;var tR=e("EventMouse",function(e){function t(n,i,r){var o;return(o=e.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=t.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}Z(t,e);var n=t.prototype;return n.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(e,t){this._x=e,this._y=t},n.getLocation=function(e){return e||(e=new Yn),Yn.set(e,this._x,this._y),e},n.getLocationInView=function(e){return e||(e=new Yn),Yn.set(e,this._x,l.view._designResolutionSize.height-this._y),e},n.getUILocation=function(e){return e||(e=new Yn),Yn.set(e,this._x,this._y),l.view._convertToUISpace(e),e},n.getPreviousLocation=function(e){return e||(e=new Yn),Yn.set(e,this._prevX,this._prevY),e},n.getUIPreviousLocation=function(e){return e||(e=new Yn),Yn.set(e,this._prevX,this._prevY),l.view._convertToUISpace(e),e},n.getDelta=function(e){return e||(e=new Yn),Yn.set(e,this._x-this._prevX,this._y-this._prevY),e},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(e){return e||(e=new Yn),Yn.set(e,(this._x-this._prevX)/l.view.getScaleX(),(this._y-this._prevY)/l.view.getScaleY()),e},n.getUIDeltaX=function(){return(this._x-this._prevX)/l.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/l.view.getScaleY()},n.setButton=function(e){this._button=e},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var e=l.view.getViewportRect();return(this._x-e.x)/l.view.getScaleX()},n.getUILocationY=function(){var e=l.view.getViewportRect();return(this._y-e.y)/l.view.getScaleY()},J(t,[{key:"eventType",get:function(){return this._eventType}}]),t}(ZP));tR.BUTTON_MISSING=-1,tR.BUTTON_LEFT=0,tR.BUTTON_RIGHT=2,tR.BUTTON_MIDDLE=1,tR.BUTTON_4=3,tR.BUTTON_5=4,tR.BUTTON_6=5,tR.BUTTON_7=6,tR.BUTTON_8=7,ZP.EventMouse=tR;var nR=new Yn,iR=e("EventTouch",function(e){function t(t,n,i,r){var o;return void 0===r&&(r=[]),(o=e.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=t||[],o._allTouches=r,o}Z(t,e);var n=t.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},n.getLocation=function(e){return this.touch?this.touch.getLocation(e):new Yn},n.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new Yn},n.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new Yn},n.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new Yn},n.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new Yn},n.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new Yn},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(e){return this.touch?this.touch.getDelta(e):new Yn},n.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new Yn},n.getDeltaX=function(){return this.touch?this.touch.getDelta(nR).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(nR).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(ZP));iR.MAX_TOUCHES=5,ZP.EventTouch=iR;var rR,oR=e("Acceleration",(function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=n,this.timestamp=i}));!function(e){e[e.NONE=0]="NONE",e[e.MOBILE_BACK=6]="MOBILE_BACK",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(rR||(rR=e("KeyCode",{})));var aR=new Yn,sR=e("Touch",function(){function e(e,t,n){void 0===n&&(n=0),this._point=new Yn,this._prevPoint=new Yn,this._lastModified=0,this._id=0,this._startPoint=new Yn,this._startPointCaptured=!1,this.setTouchInfo(n,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new Yn),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new Yn),e.set(this._point.x,this._point.y),l.view._convertToUISpace(e),e},t.getUILocationX=function(){var e=l.view.getViewportRect();return(this._point.x-e.x)/l.view.getScaleX()},t.getUILocationY=function(){var e=l.view.getViewportRect();return(this._point.y-e.y)/l.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new Yn),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new Yn),e.set(this._prevPoint.x,this._prevPoint.y),l.view._convertToUISpace(e),e},t.getStartLocation=function(e){return e||(e=new Yn),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new Yn),e.set(this._startPoint.x,this._startPoint.y),l.view._convertToUISpace(e),e},t.getDelta=function(e){return e||(e=new Yn),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new Yn),aR.set(this._point),aR.subtract(this._prevPoint),e.set(l.view.getScaleX(),l.view.getScaleY()),Yn.divide(e,aR,e),e},t.getLocationInView=function(e){return e||(e=new Yn),e.set(this._point.x,l.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new Yn),e.set(this._prevPoint.x,l.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new Yn),e.set(this._startPoint.x,l.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,n){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new Yn(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new Yn(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=l.game.frameStartTime},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new Yn(e.x,e.y):new Yn(e||0,t||0),this._lastModified=l.game.frameStartTime},J(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());l.Touch=sR;var cR,lR,uR=function(){function e(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new au,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,hu.browserType===eu.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._didAccelerate=function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=t;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=e.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=e;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(nh.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),hu.os===iu.ANDROID&&hu.browserType!==eu.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new oR(n,i,r,l),h=new $P(u);this._eventTarget.emit(JE.DEVICEMOTION,h)}},t.start=function(){var e=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&e._registerEvent()})).catch((function(){})):this._registerEvent()},t.stop=function(){this._unregisterEvent()},t.setInterval=function(e){this._intervalInMileSeconds=e},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),hR={Backspace:rR.BACKSPACE,Tab:rR.TAB,Enter:rR.ENTER,ShiftLeft:rR.SHIFT_LEFT,ControlLeft:rR.CTRL_LEFT,AltLeft:rR.ALT_LEFT,ShiftRight:rR.SHIFT_RIGHT,ControlRight:rR.CTRL_RIGHT,AltRight:rR.ALT_RIGHT,Pause:rR.PAUSE,CapsLock:rR.CAPS_LOCK,Escape:rR.ESCAPE,Space:rR.SPACE,PageUp:rR.PAGE_UP,PageDown:rR.PAGE_DOWN,End:rR.END,Home:rR.HOME,ArrowLeft:rR.ARROW_LEFT,ArrowUp:rR.ARROW_UP,ArrowRight:rR.ARROW_RIGHT,ArrowDown:rR.ARROW_DOWN,Insert:rR.INSERT,Delete:rR.DELETE,Digit0:rR.DIGIT_0,Digit1:rR.DIGIT_1,Digit2:rR.DIGIT_2,Digit3:rR.DIGIT_3,Digit4:rR.DIGIT_4,Digit5:rR.DIGIT_5,Digit6:rR.DIGIT_6,Digit7:rR.DIGIT_7,Digit8:rR.DIGIT_8,Digit9:rR.DIGIT_9,KeyA:rR.KEY_A,KeyB:rR.KEY_B,KeyC:rR.KEY_C,KeyD:rR.KEY_D,KeyE:rR.KEY_E,KeyF:rR.KEY_F,KeyG:rR.KEY_G,KeyH:rR.KEY_H,KeyI:rR.KEY_I,KeyJ:rR.KEY_J,KeyK:rR.KEY_K,KeyL:rR.KEY_L,KeyM:rR.KEY_M,KeyN:rR.KEY_N,KeyO:rR.KEY_O,KeyP:rR.KEY_P,KeyQ:rR.KEY_Q,KeyR:rR.KEY_R,KeyS:rR.KEY_S,KeyT:rR.KEY_T,KeyU:rR.KEY_U,KeyV:rR.KEY_V,KeyW:rR.KEY_W,KeyX:rR.KEY_X,KeyY:rR.KEY_Y,KeyZ:rR.KEY_Z,Numpad0:rR.NUM_0,Numpad1:rR.NUM_1,Numpad2:rR.NUM_2,Numpad3:rR.NUM_3,Numpad4:rR.NUM_4,Numpad5:rR.NUM_5,Numpad6:rR.NUM_6,Numpad7:rR.NUM_7,Numpad8:rR.NUM_8,Numpad9:rR.NUM_9,NumpadMultiply:rR.NUM_MULTIPLY,NumpadAdd:rR.NUM_PLUS,NumpadSubtract:rR.NUM_SUBTRACT,NumpadDecimal:rR.NUM_DECIMAL,NumpadDivide:rR.NUM_DIVIDE,NumpadEnter:rR.NUM_ENTER,F1:rR.F1,F2:rR.F2,F3:rR.F3,F4:rR.F4,F5:rR.F5,F6:rR.F6,F7:rR.F7,F8:rR.F8,F9:rR.F9,F10:rR.F10,F11:rR.F11,F12:rR.F12,NumLock:rR.NUM_LOCK,ScrollLock:rR.SCROLL_LOCK,Semicolon:rR.SEMICOLON,Equal:rR.EQUAL,Comma:rR.COMMA,Minus:rR.DASH,Period:rR.PERIOD,Slash:rR.SLASH,Backquote:rR.BACK_QUOTE,BracketLeft:rR.BRACKET_LEFT,Backslash:rR.BACKSLASH,BracketRight:rR.BRACKET_RIGHT,Quote:rR.QUOTE},_R=function(){function e(){this._eventTarget=new au,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=this,t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",(function(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){var n=e._getInputEvent(t,JE.KEY_PRESSING);e._eventTarget.emit(JE.KEY_PRESSING,n)}else{var i=e._getInputEvent(t,JE.KEY_DOWN);e._eventTarget.emit(JE.KEY_DOWN,i)}})),null==t||t.addEventListener("keyup",(function(t){var n=e._getInputEvent(t,JE.KEY_UP);t.stopPropagation(),t.preventDefault(),e._eventTarget.emit(JE.KEY_UP,n)}))},t._getInputEvent=function(e,t){var n,i=(n=e.code,hR[n]||rR.NONE);return new eR(i,t)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),fR=function(){function e(){this._canvas=void 0,this._eventTarget=new au,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Yn,hu.hasFeature(ou.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new ii(t.x,t.y,t.width,t.height):new ii(0,0,0,0)},t._getLocation=function(e){var t=this._getCanvasRect(),n=nh.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+e.movementX:e.clientX-t.x,r=this._pointLocked?this._preMousePos.y/n-e.movementY:t.y+t.height-e.clientY;if(nh.isFrameRotated){var o=i;i=t.height-r,r=o}return new Yn(i*=n,r*=n)},t._registerEvent=function(){var e,t,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback(JE.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback(JE.MOUSE_MOVE));var o=this._createCallback(JE.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._createCallback=function(e){var t=this;return function(n){var i,r=t._getLocation(n),o=n.button;switch(e){case JE.MOUSE_DOWN:null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case JE.MOUSE_UP:t._isPressed=!1;break;case JE.MOUSE_MOVE:t._isPressed||(o=tR.BUTTON_MISSING)}var a=new tR(e,!1,t._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,t._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,a)}},t._handleMouseWheel=function(e){var t=JE.MOUSE_WHEEL,n=this._getLocation(e),i=e.button,r=new tR(t,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(n.x,n.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),dR=new Yn,pR=new(function(){function e(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var t=e.prototype;return t._cloneTouch=function(e){var t=e.getID();e.getStartLocation(dR);var n=new sR(dR.x,dR.y,t);return e.getLocation(dR),n.setPoint(dR.x,dR.y),e.getPreviousLocation(dR),n.setPrevPoint(dR),n},t._createTouch=function(e,t,n){if(this._touchMap.has(e))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(e)){var i=new sR(t,n,e);return this._touchMap.set(e,i),this._updateTouch(i,t,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},t.releaseTouch=function(e){this._touchMap.has(e)&&this._touchMap.delete(e)},t.getTouch=function(e,t,n){var i=this._touchMap.get(e);return i?this._updateTouch(i,t,n):i=this._createTouch(e,t,n),i?this._cloneTouch(i):void 0},t.getAllTouches=function(){var e=this,t=[];return this._touchMap.forEach((function(n){if(n){var i=e._cloneTouch(n);t.push(i)}})),t},t._updateTouch=function(e,t,n){e.getLocation(dR),e.setPrevPoint(dR),e.setPoint(t,n)},t._checkTouchMapSizeMoreThanMax=function(e){var t=this;if(this._touchMap.has(e))return!1;var n=lt.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(e){i-e.lastModified>lt.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+e.getID()+"."),t.releaseTouch(e.getID()))})),n>=this._touchMap.size},e}()),mR=function(){function e(){this._canvas=void 0,this._eventTarget=new au,hu.hasFeature(ou.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._registerEvent=function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(JE.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(JE.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(JE.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(JE.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(n){for(var i,r=t._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=t._getLocation(c,r),h=pR.getTouch(l,u.x,u.y);h&&(e!==JE.TOUCH_END&&e!==JE.TOUCH_CANCEL||pR.releaseTouch(l),o.push(h))}}if(n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),e===JE.TOUCH_START&&(null===(i=t._canvas)||void 0===i||i.focus()),o.length>0){var _=new iR(o,!1,e,lt.ENABLE_MULTI_TOUCH?pR.getAllTouches():o);t._eventTarget.emit(e,_)}}},t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new ii(t.x,t.y,t.width,t.height):new ii(0,0,0,0)},t._getLocation=function(e,t){var n=e.clientX-t.x,i=t.y+t.height-e.clientY;if(nh.isFrameRotated){var r=n;n=t.height-i,i=r}var o=nh.devicePixelRatio;return new Yn(n*=o,i*=o)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}();!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.UI=1]="UI"}(lR||(lR={}));var vR=function(){function e(e){this.priority=lR.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=e}return e.prototype.dispatchEvent=function(e){return this._inputEventTarget.emit(e.type,e),!0},e}(),gR=((cR={})[JE.MOUSE_DOWN]=JE.TOUCH_START,cR[JE.MOUSE_MOVE]=JE.TOUCH_MOVE,cR[JE.MOUSE_UP]=JE.TOUCH_END,cR),yR=e("Input",function(){function e(){this._dispatchImmediately=!0,this._eventTarget=new au,this._touchInput=new mR,this._mouseInput=new fR,this._keyboardInput=new _R,this._accelerometerInput=new uR,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new vR(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var t=e.prototype;return t.on=function(e,t,n){return this._eventTarget.on(e,t,n),t},t.once=function(e,t,n){return this._eventTarget.once(e,t,n),t},t.off=function(e,t,n){this._eventTarget.off(e,t,n)},t.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},t.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},t._simulateEventTouch=function(e){var t=gR[e.type],n=pR.getTouch(0,e.getLocationX(),e.getLocationY());if(n){var i=[n],r=new iR(i,!1,t,i);t===JE.TOUCH_END&&pR.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},t._registerEventDispatcher=function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort((function(e,t){return t.priority-e.priority}))},t._emitEvent=function(e){for(var t=this._eventDispatcherList.length,n=0;n<t&&this._eventDispatcherList[n].dispatchEvent(e);++n);},t._registerEvent=function(){var e=this;if(oh.hasFeature(oh.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(JE.TOUCH_START,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(JE.TOUCH_MOVE,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(JE.TOUCH_END,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(JE.TOUCH_CANCEL,(function(n){e._dispatchOrPushEventTouch(n,t)}))}if(oh.hasFeature(oh.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(JE.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(JE.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(JE.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(JE.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,n)}))}if(oh.hasFeature(oh.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(JE.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(JE.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(JE.KEY_UP,(function(t){e._dispatchOrPushEvent(t,i)}))}if(oh.hasFeature(oh.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(JE.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,r)}))}},t._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},t._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)},t._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var n=e.getTouches(),i=n.length,r=0;r<i;++r)e.touch=n[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)},t._frameDispatchEvents=function(){for(var e=this._eventMouseList,t=0,n=e.length;t<n;++t){var i=e[t];this._emitEvent(i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,_=0,f=h.length;_<f;++_){var d=h[_];this._emitEvent(d)}for(var p=this._eventAccelerationList,m=0,v=p.length;m<v;++m){var g=p[m];this._emitEvent(g)}this._clearEvents()},e}());yR.EventType=JE;var xR=e("input",new yR),SR=e("SystemEvent",function(e){function t(){var t;return t=e.call(this)||this,xR.on(JE.MOUSE_DOWN,(function(e){t.emit(KE.MOUSE_DOWN,e)})),xR.on(JE.MOUSE_MOVE,(function(e){t.emit(KE.MOUSE_MOVE,e)})),xR.on(JE.MOUSE_UP,(function(e){t.emit(KE.MOUSE_UP,e)})),xR.on(JE.MOUSE_WHEEL,(function(e){t.emit(KE.MOUSE_WHEEL,e)})),xR.on(JE.TOUCH_START,(function(e){t.emit(KE.TOUCH_START,e.touch,e)})),xR.on(JE.TOUCH_MOVE,(function(e){t.emit(KE.TOUCH_MOVE,e.touch,e)})),xR.on(JE.TOUCH_END,(function(e){t.emit(KE.TOUCH_END,e.touch,e)})),xR.on(JE.TOUCH_CANCEL,(function(e){t.emit(KE.TOUCH_CANCEL,e.touch,e)})),xR.on(JE.KEY_DOWN,(function(e){t.emit(KE.KEY_DOWN,e)})),xR.on(JE.KEY_PRESSING,(function(e){t.emit(KE.KEY_DOWN,e)})),xR.on(JE.KEY_UP,(function(e){t.emit(KE.KEY_UP,e)})),xR.on(JE.DEVICEMOTION,(function(e){t.emit(KE.DEVICEMOTION,e)})),t}Z(t,e);var n=t.prototype;return n.setAccelerometerEnabled=function(e){xR.setAccelerometerEnabled(e)},n.setAccelerometerInterval=function(e){xR.setAccelerometerInterval(e)},n.on=function(t,n,i,r){return e.prototype.on.call(this,t,n,i,r),n},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i)},t}(au));SR.EventType=KE,l.SystemEvent=SR;var CR,AR=e("systemEvent",new SR);l.systemEvent=AR,V(KE,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),V(ZP,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:SR.EventType,targetName:"SystemEvent.EventType"}]),U(ZP,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),V(tR,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:SR.EventType,targetName:"SystemEvent.EventType"}}))),V(tR,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:SR.EventType,targetName:"SystemEvent.EventType"}]),U(tR.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),V(iR,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:SR.EventType,targetName:"SystemEvent.EventType"}]),V(iR,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:SR.EventType,targetName:"SystemEvent.EventType"}]),V(iR,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:SR.EventType,targetName:"SystemEvent.EventType"}]),V(iR,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:SR.EventType,targetName:"SystemEvent.EventType"}]),U(iR.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),V(iR.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:iR,targetName:"EventTouch"}]),U(lt.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),U(lt.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),U(lt.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),U(lt.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),U(lt,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),V(wb.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),V(nE.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Yn),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new ti),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),G(QP.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"},{name:"fixedArea"},{name:"pcf"},{name:"bias"},{name:"normalBias"},{name:"near"},{name:"far"},{name:"shadowDistance"},{name:"invisibleOcclusionRange"},{name:"orthoSize"},{name:"saturation"}]),V(QP.prototype,"SceneGlobals.prototype",[{name:"distance",newName:"planeHeight"},{name:"normal",newName:"planeDirection"}]),G(nE.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),V(ub.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),G(Cd,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),V(Cd,"Layers",[{name:"Default",newName:"DEFAULT",target:Cd.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Cd.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Cd.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Cd.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Cd.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Cd.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Cd.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Cd.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Cd,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Cd,targetName:"Layers"}]),G(Cd.Enum,"Layers.Enum",[{name:"ALWAYS"}]),G(Cd.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var bR,TR,ER,wR,IR=fl.Flags.HideInHierarchy,PR=fl.Flags.DontSave,RR=e("PrivateNode",Ac("cc.PrivateNode")(CR=function(e){function t(t){var n;return R(12003,(n=e.call(this,t)||this).name),n.hideFlags|=PR|IR,n}return Z(t,e),t}(nE))||CR);V(KE,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:nE.EventType,targetName:"Node.EventType"}}))),V(nE.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:SR.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:SR.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:SR.EventType,targetName:"SystemEvent.EventType"}]),l.PrivateNode=RR;var DR=e("Scene",Ac("cc.Scene")((ce((TR=function(e){Z(n,e);var t=n.prototype;function n(t){var n;return se(n=e.call(this,t)||this,"autoReleaseAssets",ER,re(n)),se(n,"_globals",wR,re(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=Pn.ZERO,n._rot=Ln.IDENTITY,n._scale=Pn.ONE,n._mat=jn.IDENTITY,n._dirtyFlags=0,n._lpos=Pn.ZERO,n._lrot=Ln.IDENTITY,n._lscale=Pn.ONE,n._activeInHierarchy=!1,l.director&&l.director.root&&(n._renderScene=l.director.root.createScene({})),n._inited=!l.game||!l.game._isCloning,n._init(),n}return t._updateScene=function(){this._scene=this},t._init=function(){},t.destroy=function(){var e=fl.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return this._renderScene&&l.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(L(3822))},t._onHierarchyChanged=function(){},t._onBatchCreated=function(t){e.prototype._onBatchCreated.call(this,t);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)},t.getPosition=function(e){return Pn.copy(e||new Pn,Pn.ZERO)},t.getRotation=function(e){return Ln.copy(e||new Ln,Ln.IDENTITY)},t.getScale=function(e){return Pn.copy(e||new Pn,Pn.ONE)},t.getWorldPosition=function(e){return Pn.copy(e||new Pn,Pn.ZERO)},t.getWorldRotation=function(e){return Ln.copy(e||new Ln,Ln.IDENTITY)},t.getWorldScale=function(e){return Pn.copy(e||new Pn,Pn.ONE)},t.getWorldMatrix=function(e){return jn.copy(e||new jn,jn.IDENTITY)},t.getWorldRS=function(e){return jn.copy(e||new jn,jn.IDENTITY)},t.getWorldRT=function(e){return jn.copy(e||new jn,jn.IDENTITY)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(xE(this),gE(this),this._onBatchCreated(false),this._inited=!0),this.walk(wb._setScene)},t._activate=function(e){e=!1!==e,l.director._nodeActivator.activateNode(this,e),this._globals.activate(),this._renderScene&&this._renderScene.activate()},J(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return Pn.ZERO}},{key:"worldPosition",get:function(){return Pn.ZERO}},{key:"rotation",get:function(){return Ln.IDENTITY}},{key:"worldRotation",get:function(){return Ln.IDENTITY}},{key:"scale",get:function(){return Pn.ONE}},{key:"worldScale",get:function(){return Pn.ONE}},{key:"eulerAngles",get:function(){return Pn.ZERO}},{key:"worldMatrix",get:function(){return jn.IDENTITY}}]),n}(wb)).prototype,"globals",[kc],Object.getOwnPropertyDescriptor(TR.prototype,"globals"),TR.prototype),ER=ce(TR.prototype,"autoReleaseAssets",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wR=ce(TR.prototype,"_globals",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new QP}}),bR=TR))||bR);function OR(e,t){if(!t){var n=l.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}l.Scene=DR,l.find=OR;var NR=tt.fastRemoveAt,BR=fl.Flags.IsStartCalled,MR=fl.Flags.IsOnEnableCalled;function LR(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,o=e.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=e[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function FR(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}fl.Flags.IsEditorOnEnableCalled;var zR=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=le;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function VR(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}zR.stableRemoveInactive=FR;var GR=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},n.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},n.cancelInactive=function(e){FR(this._zero,e),FR(this._neg,e),FR(this._pos,e)},n.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(VR),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(VR),this._invoke(t),t.array.length=0)},t}(zR),UR=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=LR(n,e);i<0&&n.splice(~i,0,e)}},n.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=LR(n.array,e);i>=0&&n.removeAt(i)}},n.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(zR);function kR(e,t,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",r=t?Function("it","dt",i):Function("it",i);return function(e,t,n){return function(i,r){try{t(i,r)}catch(t){l._throw(t);var o=i.array;for(n&&(o[i.i]._objFlags|=n),++i.i;i.i<o.length;++i.i)try{e(o[i.i],r)}catch(e){l._throw(e),n&&(o[i.i]._objFlags|=n)}}}}(Function("c","dt",e),r,n)}var HR=kR("c.start();c._objFlags|="+BR,!1,BR),jR=kR("c.update(dt)",!0),WR=kR("c.lateUpdate(dt)",!0),qR=function(e){var t=l.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var i=n[e.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||t._onEnabled(i))}},XR=function(){function e(){this._deferredComps=[],this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new GR(HR),this.updateInvoker=new UR(jR),this.lateUpdateInvoker=new UR(WR),this._updating=!1},t._onEnabled=function(e){l.director.getScheduler().resumeTarget(e),e._objFlags|=MR,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){l.director.getScheduler().pauseTarget(e),e._objFlags&=~MR;var t=this._deferredComps.indexOf(e);t>=0?NR(this._deferredComps,t):(!e.start||e._objFlags&BR||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&MR)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&MR&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&BR||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),YR=fl.Flags.IsPreloadStarted,KR=fl.Flags.IsOnLoadStarted,JR=fl.Flags.IsOnLoadCalled,QR=fl.Flags.Deactivating,ZR=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.add=function(e){this._zero.array.push(e)},n.remove=function(e){this._zero.fastRemove(e)},n.cancelInactive=function(e){zR.stableRemoveInactive(this._zero,e)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(zR),$R=kR("c.__preload();"),eD=kR("c.onLoad();c._objFlags|="+JR,!1,JR),tD=new et(4);function nD(e,t,n){O(3817,e.name,n),console.log("Corrupted component value:",t),t?e._removeComponent(t):tt.removeAt(e._components,n)}tD.get=function(){var e=this._get()||{preload:new ZR($R),onLoad:new GR(eD),onEnable:new GR(qR)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var iD,rD,oD,aD,sD,cD,lD,uD,hD=e("NodeActivator",function(){function e(){this.resetComp=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var n=tD.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),tD.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=ae(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(YR),o.onLoad.cancelInactive(KR),o.onEnable.cancelInactive()}}e.emit(eb.ACTIVE_IN_HIERARCHY_CHANGED,e)},t.activateComp=function(e,t,n,i){if(pl(e,!0)&&(e._objFlags&YR||(e._objFlags|=YR,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&KR||(e._objFlags|=KR,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=JR):e._objFlags|=JR),e._enabled)){if(!e.node._activeInHierarchy)return;l.director._compScheduler.enableComp(e,i)}},t.destroyComp=function(e){l.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&JR&&e.onDestroy()},t._activateNodeRecursively=function(e,t,n,i){if(e._objFlags&QR)O(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,o=0;o<r;++o){var a=e._components[o];a instanceof l.Component?this.activateComp(a,t,n,i):(nD(e,a,o),--o,--r)}for(var s=0,c=e._children.length;s<c;++s){var u=e._children[s];u._active&&this._activateNodeRecursively(u,t,n,i)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=QR,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var i=e._components[n];if(i._enabled&&(l.director._compScheduler.disableComp(i),e._activeInHierarchy))return void(e._objFlags&=~QR)}for(var r=0,o=e._children.length;r<o;++r){var a=e._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),e._activeInHierarchy))return void(e._objFlags&=~QR)}e._onPostActivated(!1),e._objFlags&=~QR},e}()),_D=e("SceneAsset",Ac("cc.SceneAsset")((aD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"scene",oD,re(t)),t}Z(t,e);var n=t.prototype;return n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new DR("New Scene")},n.validate=function(){return!!this.scene},t}(Iu),oD=ce((rD=aD).prototype,"scene",[kc,Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iD=rD))||iD);l.SceneAsset=_D;var fD,dD,pD,mD,vD=e("TextAsset",Ac("cc.TextAsset")((uD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"text",lD,re(t)),t}return Z(t,e),t.prototype.toString=function(){return this.text},t}(Iu),lD=ce((cD=uD).prototype,"text",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sD=cD))||sD);l.TextAsset=vD;var gD=e("JsonAsset",Ac("cc.JsonAsset")((mD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"json",pD,re(t)),t}return Z(t,e),t}(Iu),pD=ce((dD=mD).prototype,"json",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fD=dD))||fD);l.JsonAsset=gD;var yD,xD,SD,CD,AD,bD,TD,ED,wD,ID,PD,RD,DD,OD,ND,BD,MD,LD,FD,zD,VD,GD,UD,kD,HD,jD,WD,qD,XD,YD,KD,JD,QD,ZD,$D,eO,tO,nO,iO=function(){var e=t.prototype;function t(){this.fog=new fy,this.ambient=new iy,this.skybox=new ly,this.shadows=new lg,this.octree=new vy,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._geometryRendererMaterials=[],this._geometryRendererPasses=[],this._geometryRendererShaders=[],this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,this.initGeometryRendererMaterials(),this.initOcclusionQuery(),!0},e.initGeometryRendererMaterials=function(){for(var e=0,t=0;t<6;t++){this._geometryRendererMaterials[t]=new Kv,this._geometryRendererMaterials[t]._uuid="geometry-renderer-material-"+t,this._geometryRendererMaterials[t].initialize({effectName:"geometry-renderer",technique:t});for(var n=0;n<this._geometryRendererMaterials[t].passes.length;++n)this._geometryRendererPasses[e]=this._geometryRendererMaterials[t].passes[n],this._geometryRendererShaders[e]=this._geometryRendererMaterials[t].passes[n].getShaderVariant(),e++}},e.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new Kv;e._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant()}},e.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){var e,t,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},e._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(t);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=e.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Or("a_position",fi.RGB32F)],c=new Br(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(c)},J(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(Nx.ATTACHMENT_SCALE_CAHNGED,e))}},{key:"geometryRendererPasses",get:function(){return this._geometryRendererPasses}},{key:"geometryRendererShaders",get:function(){return this._geometryRendererShaders}}]),t}(),rO=e("ForwardPipeline",(yD=Ac("ForwardPipeline"),xD=ol([NC]),SD=Zc(),yD((TD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"renderTextures",bD,re(t)),t._postRenderPass=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new FA;n.initialize(FA.initInfo),this._flows.push(n);var i=new yA;i.initialize(yA.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new iO,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(O(2402),1))},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(kd,t),this._descriptorSet.bindTexture(kd,yv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Qd,t),this._descriptorSet.bindTexture(Qd,yv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Vd.BINDING).destroy(),this._descriptorSet.getBuffer(Ud.BINDING).destroy(),this._descriptorSet.getBuffer(Gd.BINDING).destroy(),this._descriptorSet.getTexture(kd).destroy(),this._descriptorSet.getTexture(Qd).destroy())},J(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(tS),bD=ce((AD=TD).prototype,"renderTextures",[xD,Dc,SD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CD=AD))||CD)),oO=[new hr(0,0,0,0),new hr(0,0,0,0),new hr(0,0,0,0)],aO=e("GbufferStage",(ED=Ac("GbufferStage"),wD=ol([LC]),ID=Zc(),ED((ND=OD=function(e){function t(){var t;return se(t=e.call(this)||this,"renderQueues",DD,re(t)),t._renderQueues=[],t._renderArea=new ir,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=xv("default"),t._batchedQueue=new HC,t._instancedQueue=new jC,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=GC(this.renderQueues[i])},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(UC),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var _=h[o];if(_.phase===this._phaseID){var f=_.batchingScheme;if(f===pv.INSTANCING){var d=_.getInstancedBuffer();d.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(d)}else if(f===pv.VB_MERGING){var p=_.getBatchedBuffer();p.merge(u,o,c.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(kC);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),e.clearFlag&Ki.COLOR&&(t.pipelineSceneData.isHDR?Rv(oO[0],e.clearColor):(oO[0].x=e.clearColor.x,oO[0].y=e.clearColor.y,oO[0].z=e.clearColor.z)),oO[0].w=e.clearColor.w;var v=t.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,oO,e.clearDepth,e.clearStencil),m.setScissor(t.generateScissor(e)),m.setViewport(t.generateViewport(e)),m.bindDescriptorSet(Bd.GLOBAL,t.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},t}(Ox),OD.initInfo={name:"GbufferStage",priority:Xx.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:OC.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:OC.BACK_TO_FRONT,stages:["default"]}]},DD=ce((RD=ND).prototype,"renderQueues",[wD,Dc,ID],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PD=RD))||PD)),sO=[new hr(0,0,0,1)],cO=e("LightingStage",(BD=Ac("LightingStage"),MD=ol(Kv),LD=Zc(),FD=ol([LC]),zD=Zc(),BD((jD=HD=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=op.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new ir,t._uiPhase=void 0,se(t,"_deferredMaterial",UD,re(t)),se(t,"renderQueues",kD,re(t)),t._phaseID=xv("default"),t._renderQueues=[],t._uiPhase=new mA,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.gatherLights=function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,r=e.scene.spotLights,o=ua.create(0,0,0,1),a=new Float32Array(4),s=e.exposure,c=0,l=Zn.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var _=i[h];if(ua.set(o,_.position.x,_.position.y,_.position.z,_.range),ds.sphereFrustum(o,e.frustum)){if(Pn.toArray(a,_.position),a[3]=0,this._lightBufferData.set(a,c*l),Pn.toArray(a,_.color),_.useColorTemperature){var f=_.colorTemperatureRGB;a[0]*=f.x,a[1]*=f.y,a[2]*=f.z}t.pipelineSceneData.isHDR?a[3]=_.luminance*s*this._lightMeterScale:a[3]=_.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=_.size,a[1]=_.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var d=0;d<r.length&&c<this._maxDeferredLights;d++,++c){var p=r[d];if(ua.set(o,p.position.x,p.position.y,p.position.z,p.range),ds.sphereFrustum(o,e.frustum)){if(Pn.toArray(a,p.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),Pn.toArray(a,p.color),p.useColorTemperature){var m=p.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}t.pipelineSceneData.isHDR?a[3]=p.luminance*s*this._lightMeterScale:a[3]=p.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=p.size,a[1]=p.range,a[2]=p.spotAngle,this._lightBufferData.set(a,c*l+2*u),Pn.toArray(a,p.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n._createStageDescriptor=function(e){var t=this._pipeline.device,n=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;n=Math.ceil(n/t.capabilities.uboOffsetAlignment)*t.capabilities.uboOffsetAlignment,this._deferredLitsBufs=t.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,n,t.capabilities.uboOffsetAlignment));var i=t.createBuffer(new mr(this._deferredLitsBufs,0,n));this._lightBufferData=new Float32Array(n/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet=t.createDescriptorSet(new Wr(e.localSetLayout)),this._descriptorSet.bindBuffer(rp.BINDING,i);var r=t.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.DEVICE,ep.SIZE,ep.SIZE));this._descriptorSet.bindBuffer(ep.BINDING,r)},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._uiPhase.activate(t);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=GC(this.renderQueues[i]);this._planarQueue=new pA(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],r=t.pipelineSceneData,o=r.renderObjects;this._planarQueue.gatherShadowPasses(e,i),t.generateRenderArea(e,this._renderArea);for(var a=t.getPipelineRenderData(),s=r.deferredLightingMaterial.passes[0],c=s.getShaderVariant(),l=0;l<3;++l)s.descriptorSet.bindTexture(l,a.gbufferRenderTargets[l]),s.descriptorSet.bindSampler(l,a.sampler);s.descriptorSet.bindTexture(3,a.outputDepth),s.descriptorSet.bindSampler(3,a.sampler),s.descriptorSet.update(),this._descriptorSet||this._createStageDescriptor(s),this.gatherLights(e),e.clearFlag&Ki.COLOR&&(sO[0].x=e.clearColor.x,sO[0].y=e.clearColor.y,sO[0].z=e.clearColor.z),sO[0].w=0;var u=a.outputFrameBuffer,h=u.renderPass;t.pipelineUBO.updateShadowUBO(e),i.beginRenderPass(h,u,this._renderArea,sO,e.clearDepth,e.clearStencil),i.setScissor(t.generateScissor(e)),i.setViewport(t.generateViewport(e)),i.bindDescriptorSet(Bd.GLOBAL,t.descriptorSet);var _=t.quadIAOffscreen,f=null;null!=s&&null!=c&&null!=_&&(f=wv.getOrCreatePipelineState(n,s,c,h,_)),null!=f&&(this._descriptorSet.update(),i.bindPipelineState(f),i.bindDescriptorSet(Bd.MATERIAL,s.descriptorSet),i.bindDescriptorSet(Bd.LOCAL,this._descriptorSet),i.bindInputAssembler(_),i.draw(_)),this._renderQueues.forEach(UC);for(var d=0,p=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(d=0;d<y.length;++d){var x=y[d].passes;for(p=0;p<x.length;++p)if(x[p].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,d,p)}}if(o.length>0){this._renderQueues.forEach(kC);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,h,i);this._planarQueue.recordCommandBuffer(n,h,i)}this._pipeline.geometryRenderer.render(h,i),this._uiPhase.render(e,h),i.endRenderPass()},t}(Ox),HD.initInfo={name:"LightingStage",priority:Xx.LIGHTING,tag:0},UD=ce((GD=jD).prototype,"_deferredMaterial",[MD,Dc,LD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kD=ce(GD.prototype,"renderQueues",[FD,Dc,zD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VD=GD))||VD)),lO=[new hr(0,0,0,1)],uO=e("PostProcessStage",(WD=Ac("PostProcessStage"),qD=ol(Kv),XD=Zc(),YD=ol([LC]),KD=Zc(),WD((tO=eO=function(e){function t(){var t;return se(t=e.call(this)||this,"_postProcessMaterial",ZD,re(t)),se(t,"renderQueues",$D,re(t)),t._renderArea=new ir,t._stageDesc=void 0,t._localUBO=void 0,t._uiPhase=new mA,t}Z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){var t=this._pipeline,n=t.device,i=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var o=e.viewport;this._renderArea.x=o.x*e.window.width,this._renderArea.y=o.y*e.window.height,this._renderArea.width=o.width*e.window.width,this._renderArea.height=o.height*e.window.height;var a=t.getPipelineRenderData(),s=e.window.framebuffer,c=t.getRenderPass(e.clearFlag,s);e.clearFlag&Ki.COLOR&&(lO[0].x=e.clearColor.x,lO[0].y=e.clearColor.y,lO[0].z=e.clearColor.z),lO[0].w=e.clearColor.w,r.beginRenderPass(c,s,this._renderArea,lO,e.clearDepth,e.clearStencil),r.bindDescriptorSet(Bd.GLOBAL,t.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();t.bloomEnabled?l.descriptorSet.bindTexture(0,a.bloom.combineTex):l.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,a.sampler),l.descriptorSet.update();var h=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=h&&(_=wv.getOrCreatePipelineState(n,l,u,c,h));var f=t.pipelineSceneData.renderObjects;null!=_&&f.length>0&&(this._stageDesc||(this._stageDesc=n.createDescriptorSet(new Wr(l.localSetLayout)),this._localUBO=n.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.DEVICE,ep.SIZE,ep.SIZE)),this._stageDesc.bindBuffer(ep.BINDING,this._localUBO)),this._stageDesc.update(),r.bindPipelineState(_),r.bindDescriptorSet(Bd.MATERIAL,l.descriptorSet),r.bindDescriptorSet(Bd.LOCAL,this._stageDesc),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(e,c),kv(n,c,r,t.profiler,e),r.endRenderPass()},t}(Ox),eO.initInfo={name:"PostProcessStage",priority:jx.POST_PROCESS,tag:0},ZD=ce((QD=tO).prototype,"_postProcessMaterial",[qD,Dc,XD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$D=ce(QD.prototype,"renderQueues",[YD,Dc,KD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JD=QD))||JD));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(nO||(nO={}));var hO,_O,fO,dO,pO,mO,vO,gO,yO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._antiAliasing=nO.NONE,t}Z(t,e);var n=t.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),t.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var e=new Kv;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var n=new Kv;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new Kv;r._uuid="builtin-post-process-material",lt.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=nO.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(t,n){return e.prototype.activate.call(this,t,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},J(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var n=new Kv;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(iO),xO=[new hr(0,0,0,1)],SO=function(){};SO.SIZE=4*(SO.COUNT=4+(SO.TEXTURE_SIZE_OFFSET=0));var CO,AO,bO,TO,EO,wO,IO,PO,RO,DO,OO=e("BloomStage",(hO=Ac("BloomStage"),_O=ol(Kv),fO=Zc(),hO((gO=vO=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,se(t,"_bloomMaterial",mO,re(t)),t._renderArea=new ir,t._bloomUBO=[],t}Z(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(e){var t,n=this._pipeline;if(n.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,SO.SIZE,SO.SIZE));e.clearFlag&Ki.COLOR&&(xO[0].x=e.clearColor.x,xO[0].y=e.clearColor.y,xO[0].z=e.clearColor.z),xO[0].w=e.clearColor.w,this._prefilterPass(e,n),this._downsamplePass(e,n),this._upsamplePass(e,n),this._combinePass(e,n)}},n._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(SO.COUNT);a[SO.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,xO,0,0),n.bindDescriptorSet(Bd.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet(Bd.MATERIAL,i.descriptorSet);var s=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=wv.getOrCreatePipelineState(t.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,o=new Float32Array(SO.COUNT),a=0;a<this.iterations;++a){o[SO.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[SO.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,xO,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Bd.MATERIAL,s.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=wv.getOrCreatePipelineState(t.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(e,t){var n=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,o=new Float32Array(SO.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[SO.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[SO.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,xO,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(Bd.MATERIAL,c.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=wv.getOrCreatePipelineState(t.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(SO.COUNT);a[SO.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,xO,0,0),n.bindDescriptorSet(Bd.GLOBAL,t.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Bd.MATERIAL,s.descriptorSet);var c=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=wv.getOrCreatePipelineState(t.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},t}(Ox),vO.initInfo={name:"BloomStage",priority:jx.BLOOM,tag:0},mO=ce((pO=gO).prototype,"_bloomMaterial",[_O,Dc,fO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dO=pO))||dO)),NO=e("MainFlow",Ac("MainFlow")((bO=AO=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new aO;n.initialize(aO.initInfo),this._stages.push(n);var i=new cO;i.initialize(cO.initInfo),this._stages.push(i);var r=new OO;r.initialize(OO.initInfo),this._stages.push(r);var o=new uO;o.initialize(uO.initInfo),this._stages.push(o)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(Bx),AO.initInfo={name:Td,priority:Yx.MAIN,stages:[]},CO=bO))||CO),BO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return Z(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),MO=e("DeferredPipeline",(TO=Ac("DeferredPipeline"),EO=ol([NC]),wO=Zc(),TO((DO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,se(t,"renderTextures",RO,re(t)),t}Z(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new FA;n.initialize(FA.initInfo),this._flows.push(n);var i=new NO;i.initialize(NO.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new yO,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(O(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(kd,n),this._descriptorSet.bindTexture(kd,yv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Qd,n),this._descriptorSet.bindTexture(Qd,yv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new eS;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new Mr;o.format=fi.RGBA16F,o.loadOp=Bi.CLEAR,o.storeOp=Mi.STORE;var a=new Mr;a.format=fi.RGBA16F,a.loadOp=Bi.CLEAR,a.storeOp=Mi.STORE;var s=new Mr;s.format=fi.RGBA16F,s.loadOp=Bi.CLEAR,s.storeOp=Mi.STORE;var c=new Lr;c.format=fi.DEPTH_STENCIL,c.depthLoadOp=Bi.CLEAR,c.depthStoreOp=Mi.STORE,c.stencilLoadOp=Bi.CLEAR,c.stencilStoreOp=Mi.STORE;var l=new Vr([o,a,s],c);this._gbufferRenderPass=t.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Mr;u.format=fi.RGBA8,u.loadOp=Bi.CLEAR,u.storeOp=Mi.STORE,u.barrier=t.getGeneralBarrier(new Gr(Li.NONE,Li.COLOR_ATTACHMENT_WRITE));var h=new Lr;h.format=fi.DEPTH_STENCIL,h.depthLoadOp=Bi.LOAD,h.depthStoreOp=Mi.DISCARD,h.stencilLoadOp=Bi.LOAD,h.stencilStoreOp=Mi.DISCARD,u.barrier=t.getGeneralBarrier(new Gr(Li.DEPTH_STENCIL_ATTACHMENT_WRITE,Li.DEPTH_STENCIL_ATTACHMENT_WRITE));var _=new Vr([u],h);this._lightingRenderPass=t.createRenderPass(_)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(Vd.BINDING).destroy(),this._descriptorSet.getBuffer(Ud.BINDING).destroy(),this._descriptorSet.getBuffer(Gd.BINDING).destroy(),this._descriptorSet.getTexture(kd).destroy(),this._descriptorSet.getTexture(Qd).destroy())},n._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.outputRenderTargets.length;n++)e.outputRenderTargets[n].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var e=this,t=this.device,n=this._pipelineRenderData=new BO,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(t.createTexture(new xr(xi.TEX2D,Si.COLOR_ATTACHMENT|Si.SAMPLED,fi.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=t.createTexture(new xr(xi.TEX2D,Si.DEPTH_STENCIL_ATTACHMENT|Si.SAMPLED,fi.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=t.createFramebuffer(new kr(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(t.createTexture(new xr(xi.TEX2D,Si.COLOR_ATTACHMENT|Si.SAMPLED,fi.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=t.createFramebuffer(new kr(this._lightingRenderPass,n.outputRenderTargets,null)),n.sampler=this.globalDSManager.pointSampler,this.on(Nx.ATTACHMENT_SCALE_CAHNGED,(function(t){n.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,e.applyFramebufferRatio(n.gbufferFrameBuffer),e.applyFramebufferRatio(n.outputFrameBuffer)}))},t}(tS),RO=ce((PO=DO).prototype,"renderTextures",[EO,Dc,wO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IO=PO))||IO));function LO(){var e=new rO;return e.initialize({flows:[]}),e}var FO=new Yn,zO=function(){var e=t.prototype;function t(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return e.pauseRendering=function(){this.isPause=!0},e.resumeRendering=function(){this.isPause=!1},e.main=function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new hr(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new hr(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{l.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?l.view.setDesignResolutionSize(n.width,n.height,n.policy):l.view.setDesignResolutionSize(960,640,4),this.device=e.device,this.swapchain=e.mainWindow.swapchain,this.framebuffer=e.mainWindow.framebuffer,l.game.once(l.Game.EVENT_GAME_INITED,(function(){l.director._lateUpdate=performance.now()}),l.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else S("RENDER ROOT IS NULL.")},e.setOnFinish=function(e){if(this._directCall&&e)return t._ins=void 0,void e();this.callBack=e},e._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),l.game.resume())},e.preInit=function(){var e=this.settings.clearColor;this.clearColors=[new hr(e.x,e.y,e.z,e.w)];var t=this.device,n=this.swapchain;this.renderArea=new ir(0,0,n.width,n.height),this.cmdBuff=t.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=t.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=t.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new Or("a_position",fi.RG32F),new Or("a_texCoord",fi.RG32F)],u=new Br(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(u),this.projection=new jn,jn.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,n.surfaceTransform)},e.init=function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),l.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,r=e.device,o=e.swapchain;jn.ortho(e.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;e.startTime<0&&(e.startTime=n);var l=n-e.startTime,u=l_(ln(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=e.logoTexture.width,_=e.logoTexture.height,f=c*i.displayRatio,d=f*h/_,p=f;if(o.surfaceTransform!==hi.ROTATE_90&&o.surfaceTransform!==hi.ROTATE_270||(d=f*a/s,p=f*_/h*s/a),e.logoMat.setProperty("resolution",FO.set(a,s),0),e.logoMat.setProperty("scale",FO.set(d,p),0),e.logoMat.setProperty("translate",FO.set(.5*a,.5*s),0),e.logoMat.setProperty("percent",u),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var m=.5*c,v=e.watermarkTexture.width,g=m,y=m*e.watermarkTexture.height/v;o.surfaceTransform!==hi.ROTATE_90&&o.surfaceTransform!==hi.ROTATE_270||(g=.5*m,y=m*a/s*.5),e.watermarkMat.setProperty("resolution",FO.set(a,s),0),e.watermarkMat.setProperty("scale",FO.set(g,y),0),e.watermarkMat.setProperty("translate",FO.set(.5*a,.1*s),0),e.watermarkMat.setProperty("percent",u),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.isPause||(e.frame(),l>i.totalTime&&(e.splashFinish=!0)),requestAnimationFrame(t)}}))},e.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},e.initLogo=function(){var e=this.device;this.logoMat=new Kv,this.logoMat.initialize({effectName:"splash-screen"});var t=new Cr;t.addressU=wi.CLAMP,t.addressV=wi.CLAMP,t.addressW=wi.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new xr(xi.TEX2D,Si.SAMPLED|Si.TRANSFER_DST,fi.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new lr;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},e.initWarterMark=function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height;var t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var r=new lr;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new xr(xi.TEX2D,Si.SAMPLED|Si.TRANSFER_DST,fi.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new Kv,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},e.frame=function(){var e=this.device,t=this.swapchain;e.acquire([t]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=t.width,r.height=t.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=wv.getOrCreatePipelineState(e,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(Bd.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=wv.getOrCreatePipelineState(e,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(Bd.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),e.flushCommands([n]),e.queue.submit([n]),e.present()},e.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,t._ins=void 0},J(t,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return t._ins||(t._ins=new t),t._ins}}]),t}();zO._ins=void 0,l.internal.SplashScreen=zO;var VO=e("System",function(){function e(){this._id="",this._priority=0,this._executeInEditMode=!1}e.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0};var t=e.prototype;return t.init=function(){},t.update=function(){},t.postUpdate=function(){},J(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),e}());VO.Priority=rt({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var GO=new pe("Scheduler"),UO=function(e,t,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=n,this.markedForDeletion=i};UO.get=function(e,t,n,i){var r=UO._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=n,r.markedForDeletion=i):r=new UO(e,t,n,i),r},UO.put=function(e){UO._listEntries.length<20&&(e.target=null,UO._listEntries.push(e))},UO._listEntries=[];var kO=function(e,t,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=n,this.callback=i};kO.get=function(e,t,n,i){var r=kO._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=n,r.callback=i):r=new kO(e,t,n,i),r},kO.put=function(e){kO._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,kO._hashUpdateEntries.push(e))},kO._hashUpdateEntries=[];var HO=function(e,t,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};HO.get=function(e,t,n,i,r,o){var a=HO._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new HO(e,t,n,i,r,o),a},HO.put=function(e){HO._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,HO._hashTimerEntries.push(e))},HO._hashTimerEntries=[];var jO=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var t=e.prototype;return t.initWithCallback=function(e,t,n,i,r,o){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=i,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===l.macro.REPEAT_FOREVER,!0},t.getInterval=function(){return this._interval},t.setInterval=function(e){this._interval=e},t.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},t.getCallback=function(){return this._callback},t.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},t.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();jO._timers=[],jO.get=function(){return jO._timers.pop()||new jO},jO.put=function(e){jO._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,jO._timers.push(e))};var WO,qO=e("Scheduler",function(e){function t(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=we(!0),t._hashForTimers=we(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}Z(t,e),t.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?R(1513):e.id=GO.getNewId())};var n=t.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(o=a[t],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(e),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updates0List;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updatesPosList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,t,n,i,r,o){if("function"!=typeof e){var a=e;e=t,t=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!i,i=l.macro.REPEAT_FOREVER,r=0),M(t,1502);var s=t.uuid||t.id;if(s){var c,u,h=this._hashForTimers[s];if(h?h.paused!==o&&R(1511):(h=HO.get(null,t,0,null,null,o),this._arrayForTimers.push(h),this._hashForTimers[s]=h),null==h.timers)h.timers=[];else for(u=0;u<h.timers.length;++u)if((c=h.timers[u])&&e===c._callback)return I(1507,c.getInterval(),n),void(c._interval=n);(c=jO.get()).initWithCallback(this,e,t,n,i,r),h.timers.push(c),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else O(1510)},n.scheduleUpdate=function(e,t,n){var i=e.uuid||e.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return I(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(e)}var o,a=UO.get(e,t,n,!1);0===t?(o=this._updates0List,this._appendIn(o,a)):(o=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,t)),this._hashForUpdates[i]=kO.get(o,a,e,null)}else O(1510)},n.unschedule=function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(e===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),jO.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else O(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else O(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)jO.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else O(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(VO.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(e){var t,n,i,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)n=r[t],this.unscheduleAllForTarget(n.target);var o=0;if(e<0)for(t=0;t<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){M(e,1508),M(t,1509);var n=t.uuid||t.id;if(!n)return O(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(e===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(VO.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(e){var t,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(t=a[n])&&(t.paused=!0,o.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){M(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else O(1510)},n.resumeTarget=function(e){M(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else O(1510)},n.isTargetPaused=function(e){M(e,1505);var t=e.uuid||e.id;if(!t)return O(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}HO.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[t],UO.put(r),kO.put(n)}},n._priorityIn=function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},t}(VO));qO.ID="scheduler",l.Scheduler=qO;var XO=((WO={})[Qu.PORTRAIT]=hi.IDENTITY,WO[Qu.LANDSCAPE_RIGHT]=hi.ROTATE_90,WO[Qu.PORTRAIT_UPSIDE_DOWN]=hi.ROTATE_180,WO[Qu.LANDSCAPE_LEFT]=hi.ROTATE_270,WO),YO=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e,t){if(this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._setSwapchain(t.swapchain),this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var n=0;n<t.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(e.createTexture(new xr(xi.TEX2D,Si.COLOR_ATTACHMENT|Si.SAMPLED|Si.TRANSFER_SRC,t.renderPassInfo.colorAttachments[n].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==fi.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new xr(xi.TEX2D,Si.DEPTH_STENCIL_ATTACHMENT|Si.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(e.createFramebuffer(new kr(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,XO[nh.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new kr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=ae(this._cameras);!(i=r()).done;)i.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},t._init=function(){},t._destroy=function(){},t._setSwapchain=function(e){this._swapchain=e},t._setFrameBuffer=function(e){this._framebuffer=e},J(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),e}(),KO=e("Root",function(){function e(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=l.internal.DataPoolManager&&new l.internal.DataPoolManager(e),By.registerCreateFunc(this),YO.registerCreateFunc(this),this._cameraPool=new Hl((function(){return new rg(t._device)}),4,(function(e){return e.destroy()}))}var t=e.prototype;return t.initialize=function(){this._init();var e=l.game._swapchain,t=new Mr;t.format=e.colorTexture.format;var n=new Lr;n.format=e.depthStencilTexture.format,n.depthStoreOp=Mi.DISCARD,n.stencilStoreOp=Mi.DISCARD;var i=new Vr([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:i,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(yv.initBuiltinRes(this._device))},t.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},t.resize=function(e,t){for(var n,i=ae(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(e,t)}},t.setRenderPipeline=function(e){e instanceof MO&&(this._useDeferredPipeline=!0);var t=!1;if(e||(e=LO(),t=!0),this._pipeline=e,this._useDeferredPipeline&&this.device.hasFeature(_i.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return t&&this._pipeline.destroy(),this._pipeline=null,!1;var n=l.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&l.internal.Batcher2D&&(this._batcher=new l.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},t.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},t.activeWindow=function(e){this._curWindow=e},t.resetCumulativeTime=function(){this._setCumulativeTime(0)},t.frameMove=function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();for(var n=this._windows,i=[],r=0;r<n.length;r++)n[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([l.game._swapchain]);var o=this._scenes,a=l.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<o.length;s++)o[s].update(a);l.director.emit(l.Director.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()},t.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},t.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},t.destroyWindows=function(){for(var e,t=ae(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},t.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},t.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},t.destroyScenes=function(){for(var e,t=ae(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},t.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new Hl((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n},t.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):R(1300,e.constructor.name),e.destroy()},t.createCamera=function(){return this._cameraPool.alloc()},t.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new Hl((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n},t.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case my.SPHERE:e.scene.removeSphereLight(e);break;case my.SPOT:e.scene.removeSpotLight(e)}e.destroy()},t._init=function(){},t._destroy=function(){},t._setCumulativeTime=function(e){this._cumulativeTime+=e},t._setFrameTime=function(e){this._frameTime=e},J(e,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),e}());l.Root=KO;var JO=e("Game",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._swapchain=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t._onEngineInitedCallback=[],t}Z(t,e);var i=t.prototype;return i.setFrameRate=function(e){this.frameRate=e},i.getFrameRate=function(){return this.frameRate},i.step=function(){l.director.tick(this.frameTime/1e3)},i.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},i.resume=function(){this._paused&&(xR._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},i.isPaused=function(){return this._paused},i.restart=function(){var e=this;return new Promise((function(e){return l.director.once(l.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var n in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[n]);return l.director.getScene().destroy(),l.Object._deferredDestroy(),l.director.reset(),l.profiler.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},i.end=function(){hu.close()},i.on=function(e,n,i,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(e,n,i,r)},i.once=function(e,n,i){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)},i.init=function(e){var t=this;if(this._initConfig(e),rh._init({configOrientation:e.orientation||"auto",exactFitScreen:e.exactFitScreen}),this.config.assetOptions&&l.assetManager.init(this.config.assetOptions),this.config.layers)for(var i=this.config.layers,r=0;r<i.length;r++){var o=i[r],a=n(o.value);Cd.addLayer(o.name,a)}return this._initEngine().then((function(){return t._initEvents(),l.director.root&&l.director.root.dataPoolManager&&l.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},i.run=function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,Ji.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},i.addPersistRootNode=function(e){if(l.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=l.director._scene;if(l.isValid(n))if(e.parent){if(!(e.parent instanceof l.Scene))return void R(3801);if(e.parent!==n)return void R(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,l.assetManager._releaseManager._addPersistNodeRef(e)}}else R(3800)},i.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",l.assetManager._releaseManager._removePersistNodeRef(e))},i.isPersistRootNode=function(e){return!!e._persistNode},i.onEngineInitedAsync=function(e){this._onEngineInitedCallback.push(e)},i._initEngine=function(){var e=this;this._initDevice();var n=l.director;return Promise.resolve(n._init()).then((function(){l.view.init(),y("Cocos Creator v"+u),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,l.internal.dynamicAtlasManager&&(l.internal.dynamicAtlasManager.enabled=!lt.CLEANUP_IMAGE_CACHE)})).then((function(){var t=e._onEngineInitedCallback.map((function(e){return e()})).filter(Boolean);return e._onEngineInitedCallback.length=0,Promise.all(t)}))},i._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},i._stTime=function(e){var t=performance.now(),n=Math.max(0,t-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(e,i)},i._ctTime=function(e){window.clearTimeout(e)},i._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},i._updateCallback=function(){var e,t=this,n=l.director;if(30===this._frameRate){var i=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(i=!i)||n.tick(t._calculateDT(e))}}else e=function(e){n.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},i._runMainLoop=function(){if(this._inited){var e=this.config,t=l.director;z(!!e.showFPS),t.startAnimation(),this.resume()}},i._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=N.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>3||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,b(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},i._determineRenderType=function(){var e=this.config,n=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=t.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(L(3820,n))},i._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var n=new dr(zd),i=!!window.WebGL2RenderingContext,r=window.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||oh.browserType===eu.UC)&&(i=!1);var o=[];i&&l.WebGL2Device&&o.push(l.WebGL2Device),l.WebGLDevice&&o.push(l.WebGLDevice),l.EmptyDevice&&o.push(l.EmptyDevice),mo.canvas=this.canvas;for(var a=0;a<o.length&&(this._gfxDevice=new o[a],!this._gfxDevice.initialize(n));a++);}else this.renderType===t.RENDER_TYPE_HEADLESS&&l.EmptyDevice&&(this._gfxDevice=new l.EmptyDevice,this._gfxDevice.initialize(new dr(zd)));if(!this._gfxDevice)return S("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);var s=new fr(this.canvas),c=rh.windowSize;s.width=c.width,s.height=c.height,this._swapchain=this._gfxDevice.createSwapchain(s),this.canvas.oncontextmenu=function(){return!1}}},i._initEvents=function(){hu.on("show",this._onShow,this),hu.on("hide",this._onHide,this)},i._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},i._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},i._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},i._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){l.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof tS?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){x(n),x("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},i._showSplashScreen=function(){if(l.internal.SplashScreen){var e=l.internal.SplashScreen.instance;return e.main(l.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},i._setRenderPipeline=function(e){l.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},i._safeEmit=function(e){this.emit(e)},J(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(au));JO.EVENT_HIDE="game_on_hide",JO.EVENT_SHOW="game_on_show",JO.EVENT_LOW_MEMORY="game_on_low_memory",JO.EVENT_GAME_INITED="game_inited",JO.EVENT_ENGINE_INITED="engine_inited",JO.EVENT_RENDERER_INITED="renderer_inited",JO.EVENT_RESTART="game_on_restart",JO.RENDER_TYPE_CANVAS=0,JO.RENDER_TYPE_WEBGL=1,JO.RENDER_TYPE_OPENGL=2,JO.RENDER_TYPE_HEADLESS=3,JO.DEBUG_DT_THRESHOLD=1,l.Game=JO;var QO=e("game",l.game=new JO),ZO=e("Director",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new qO,t._compScheduler=new XR,t._nodeActivator=new hD,t._systems=[],QO.once(JO.EVENT_RENDERER_INITED,t._initOnRendererInitialized,re(t)),t}Z(t,e);var n=t.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),l.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),l.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(t.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(e,t,n){e instanceof _D&&(e=e.scene),M(e instanceof DR,1216),e._load();for(var i=Object.keys(QO._persistRootNodes).map((function(e){return QO._persistRootNodes[e]})),r=0;r<i.length;r++){var o=i[r];o.emit(l.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var a=e.uuid===o._originalSceneId&&e.getChildByUuid(o.uuid);if(a){var s=a.getSiblingIndex();a._destroyImmediate(),e.insertChild(o,s)}else o.parent=e}var c=this._scene;l.isValid(c)&&c.destroy(),l.assetManager._releaseManager._autoRelease(c,e,QO._persistRootNodes),this._scene=null,fl._deferredDestroy(),t&&t(),this.emit(l.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(l.Director.EVENT_AFTER_SCENE_LAUNCH,e)},n.runScene=function(e,t,n){var i=this;e instanceof _D&&(e=e.scene),M(e,1205),M(e instanceof DR,1216),e._load(),this.once(l.Director.EVENT_END_FRAME,(function(){i.runSceneImmediate(e,t,n)}))},n.loadScene=function(e,t,n){var i=this;if(this._loadingScene)return R(1208,e,this._loadingScene),!1;var r=l.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return r?(this.emit(l.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),r.loadScene(e,(function(r,o){console.timeEnd("LoadScene "+e),i._loadingScene="",r?(S(r),t&&t(r)):i.runSceneImmediate(o,n,t)})),!0):(O(1209,e),!1)},n.preloadScene=function(e,t,n){var i=l.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(i)i.preloadScene(e,null,t,n);else{var r='Can not preload the scene "'+e+'" because it is not in the build settings.';n&&n(new Error(r)),S("preloadScene: "+r)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return QO.deltaTime},n.getTotalTime=function(){return QO.totalTime},n.getCurrentTime=function(){return QO.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(qO.ID,e,200))},n.registerSystem=function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(VO.sortByPriority)},n.unregisterSystem=function(e){tt.fastRemove(this._systems,e),this._systems.sort(VO.sortByPriority)},n.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},n.getAnimationManager=function(){return this.getSystem(l.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(e){var t;t=QO._calculateDT(e),this.tick(t)},n.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),xR._frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var n=0;n<this._systems.length;++n)this._systems[n].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),fl._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),nE.resetHasChangedFlags(),nE.clearNodeArray(),Ul.update(e),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(qO.ID,this._scheduler,200),this.emit(t.EVENT_INIT)},n._init=function(){return this._root=new KO(QO._gfxDevice),this._root.initialize({}).catch((function(e){return O(1217),Promise.reject(e)}))},J(t,[{key:"root",get:function(){return this._root}}]),t}(au));ZO.EVENT_INIT="director_init",ZO.EVENT_RESET="director_reset",ZO.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",ZO.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",ZO.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",ZO.EVENT_BEFORE_UPDATE="director_before_update",ZO.EVENT_AFTER_UPDATE="director_after_update",ZO.EVENT_BEFORE_DRAW="director_before_draw",ZO.EVENT_AFTER_DRAW="director_after_draw",ZO.EVENT_BEFORE_COMMIT="director_before_commit",ZO.EVENT_BEFORE_PHYSICS="director_before_physics",ZO.EVENT_AFTER_PHYSICS="director_after_physics",ZO.EVENT_BEGIN_FRAME="director_begin_frame",ZO.EVENT_END_FRAME="director_end_frame",ZO.instance=void 0,l.Director=ZO;var $O=e("director",ZO.instance=l.director=new ZO),eN={};V(eN,"vmath",[{name:"vec2",newName:"Vec2",target:si,targetName:"math"},{name:"vec3",newName:"Vec3",target:si,targetName:"math"},{name:"vec4",newName:"Vec4",target:si,targetName:"math"},{name:"quat",newName:"Quat",target:si,targetName:"math"},{name:"mat3",newName:"Mat3",target:si,targetName:"math"},{name:"mat4",newName:"Mat4",target:si,targetName:"math"},{name:"color4",newName:"Color",target:si,targetName:"math"},{name:"rect",newName:"Rect",target:si,targetName:"math"},{name:"approx",newName:"approx",target:si,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:si,targetName:"math"},{name:"equals",newName:"equals",target:si,targetName:"math"},{name:"clamp",newName:"clamp",target:si,targetName:"math"},{name:"clamp01",newName:"clamp01",target:si,targetName:"math"},{name:"lerp",newName:"lerp",target:si,targetName:"math"},{name:"toRadian",newName:"toRadian",target:si,targetName:"math"},{name:"toDegree",newName:"toDegree",target:si,targetName:"math"},{name:"random",newName:"random",target:si,targetName:"math"},{name:"randomRange",newName:"randomRange",target:si,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:si,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:si,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:si,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:si,targetName:"math"},{name:"repeat",newName:"repeat",target:si,targetName:"math"},{name:"pingPong",newName:"pingPong",target:si,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:si,targetName:"math"}]),l.vmath=eN,V(qO.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:qO,targetName:"Scheduler"}]),V(qO,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return VO.Priority.SCHEDULER}}]),G(qO,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),V(Jg.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),G(Jg.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),V(KO.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),U(QO,"game",[{name:"collisionMatrix"},{name:"groupList"}]),U(ZO.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),G(ZO.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var tN,nN={topLeft:l.v2(0,0),topRight:l.v2(0,0),top:l.v2(0,0),bottomLeft:l.v2(0,0),bottomRight:l.v2(0,0),bottom:l.v2(0,0),center:l.v2(0,0),left:l.v2(0,0),right:l.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,r=e.y,o=r+n,a=i+t;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+t/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+t/2,this.bottom.y=r,this.center.x=i+t/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};l.visibleRect=nN;var iN=new ti,rN=((tN={})[lt.ORIENTATION_AUTO]=Qu.AUTO,tN[lt.ORIENTATION_LANDSCAPE]=Qu.LANDSCAPE,tN[lt.ORIENTATION_PORTRAIT]=Qu.PORTRAIT,tN),oN=e("View",function(e){function t(){var t;(t=e.call(this)||this)._designResolutionSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var n=aN,i=sN;return t._designResolutionSize=new ti(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new ii(0,0,0,0),t._visibleRect=new ii(0,0,0,0),t._autoFullScreen=!1,t._retinaEnabled=!1,t._resizeCallback=null,t._rpExactFit=new cN(n.EQUAL_TO_FRAME,i.EXACT_FIT),t._rpShowAll=new cN(n.EQUAL_TO_FRAME,i.SHOW_ALL),t._rpNoBorder=new cN(n.EQUAL_TO_FRAME,i.NO_BORDER),t._rpFixedHeight=new cN(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),t._rpFixedWidth=new cN(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,t}Z(t,e);var n=t.prototype;return n.init=function(){var e=rh.windowSize,t=e.width,n=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=n,this._viewportRect.width=t,this._viewportRect.height=n,this._visibleRect.width=t,this._visibleRect.height=n,iN.width=this._visibleRect.width,iN.height=this._visibleRect.height,nN&&nN.init(this._visibleRect),nh.on("window-resize",this._updateAdaptResult,this),nh.on("orientation-change",this._updateAdaptResult,this),nh.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(e){nh.handleResizeEvent=e},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){nh.orientation=rN[e]},n.adjustViewportMeta=function(){},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&rh.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){nh.resolutionScale=1;var n=nh.devicePixelRatio,i=new ti(e*n,t*n);rh.windowSize=i},n.getCanvasSize=function(){return rh.windowSize},n.getFrameSize=function(){var e=nh.devicePixelRatio,t=rh.windowSize;return t.width/=e,t.height/=e,t},n.setFrameSize=function(e,t){var n=nh.devicePixelRatio;rh.windowSize=new ti(e*n,t*n)},n.getVisibleSize=function(){return new ti(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new ti(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new Yn(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new Yn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(e){if(e instanceof cN)this._resolutionPolicy=e;else{var t=cN;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=lN.getDesignResolutionSize();lN.setDesignResolutionSize(t.width,t.height,e)},n.setDesignResolutionSize=function(e,t,n){if(e>0&&t>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),iN.width=this._visibleRect.width,iN.height=this._visibleRect.height,nN&&nN.init(this._visibleRect),this.emit("design-resolution-changed")}else O(2200)},n.getDesignResolutionSize=function(){return new ti(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,n){document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return nh.devicePixelRatio},n.convertToLocationInView=function(e,t,n,i){void 0===i&&(i=new Yn);var r=nh.devicePixelRatio*(e-n.left),o=nh.devicePixelRatio*(n.top+n.height-t);return nh.isFrameRotated?(i.x=rh.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._updateAdaptResult=function(){var e;if(!window.fast||!window.fast.info.qfun){l.director.root.resize(rh.windowSize.width,rh.windowSize.height);var t=this._designResolutionSize.width,n=this._designResolutionSize.height;t>0&&this.setDesignResolutionSize(t,n,this._resolutionPolicy)}this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)},t}(au));oN.instance=void 0;var aN=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupCanvas=function(){var e=QO.canvas;if(e){var t=rh.windowSize;e.width=t.width,e.height=t.height}},e}();aN.EQUAL_TO_FRAME=void 0,aN.PROPORTION_TO_FRAME=void 0;var sN=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,n,i,r,o){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var a=new ii(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},e}();sN.EXACT_FIT=void 0,sN.SHOW_ALL=void 0,sN.NO_BORDER=void 0,sN.FIXED_HEIGHT=void 0,sN.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="EqualToFrame",t}return Z(t,e),t.prototype.apply=function(){nh.isProportionalToFrame=!1,this._setupCanvas()},t}(aN),t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ProportionalToFrame",t}return Z(t,e),t.prototype.apply=function(){nh.isProportionalToFrame=!0,this._setupCanvas()},t}(aN);aN.EQUAL_TO_FRAME=new e,aN.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ExactFit",t}return Z(t,e),t.prototype.apply=function(e,t){var n=rh.windowSize,i=n.width,r=n.height,o=i/t.width,a=r/t.height;return this._buildResult(i,r,i,r,o,a)},t}(sN),i=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ShowAll",t}return Z(t,e),t.prototype.apply=function(e,t){var n,i,r=rh.windowSize,o=r.width,a=r.height,s=t.width,c=t.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},t}(sN),r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="NoBorder",t}return Z(t,e),t.prototype.apply=function(e,t){var n,i,r,o=rh.windowSize,a=o.width,s=o.height,c=t.width,l=t.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},t}(sN),o=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedHeight",t}return Z(t,e),t.prototype.apply=function(e,t){var n=rh.windowSize,i=n.width,r=n.height,o=r/t.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(sN),a=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedWidth",t}return Z(t,e),t.prototype.apply=function(e,t){var n=rh.windowSize,i=n.width,r=n.height,o=i/t.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}(sN);sN.EXACT_FIT=new n,sN.SHOW_ALL=new i,sN.NO_BORDER=new r,sN.FIXED_HEIGHT=new o,sN.FIXED_WIDTH=new a}();var cN=e("ResolutionPolicy",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof aN&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof sN&&(this._contentStrategy=e)},J(e,[{key:"canvasSize",get:function(){return rh.windowSize}}]),e}());cN.EXACT_FIT=0,cN.NO_BORDER=1,cN.SHOW_ALL=2,cN.FIXED_HEIGHT=3,cN.FIXED_WIDTH=4,cN.UNKNOWN=5,cN.ContainerStrategy=aN,cN.ContentStrategy=sN,l.ResolutionPolicy=cN;var lN=e("view",oN.instance=l.view=new oN);l.winSize=iN,G(oN.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),U(oN.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),U(l,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),U(oh,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),V(oh,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:oh.Language,targetName:"sys.Language"}}))),V(oh,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:oh.OS,targetName:"sys.OS"}}))),V(oh,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:oh.BrowserType,targetName:"sys.BrowserType"}}))),V(oh,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:oh.BrowserType,targetName:"sys.BrowserType"}]),V(oh,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:oh.Platform,targetName:"sys.Platform"}}))),V(oh,"sys",[{name:"IPHONE",newName:"IOS",target:oh.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:oh.Platform,targetName:"sys.Platform"}]),G(oh,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),V(oh,"sys",[{name:"windowPixelResolution",target:rh,targetName:"screen",newName:"windowSize"}]),U(rh,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var uN=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new ml,this.scenes=new ml,this.paths=new ml}var t=e.prototype;return t.init=function(e){var t=this;!function(e){var t=e.uuids,n=e.paths,i=e.types,r=e.deps,o=e.paths=Object.create(null);if(!1===e.debug){for(var a=0,s=t.length;a<s;a++)t[a]=Nl(t[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),_=0,f=t.length;_<f;_++){var d=t[_];t[_]=h[d]=Nl(d)}t=h}for(var p in n){var m=n[p];o[t[p]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var x=e.packs;for(var S in x)for(var C=x[S],A=0;A<C.length;++A)C[A]=t[C[A]];var b=e.versions;if(b)for(var T in b)for(var E=b[T],w=0;w<E.length;w+=2){var I=E[w];E[w]=t[I]||I}var P=e.redirect;if(P)for(var R=0;R<P.length;R+=2)P[R]=t[P[R]],P[R+1]=r[P[R+1]];if(e.extensionMap){var D=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(i,r){e.extensionMap[n][r]=t[i]||i}))};for(var O in e.extensionMap)D(O)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(e){var i=t.assetInfos.get(e);i&&(i.extension=n)}))};for(var i in e.extensionMap)n(i)},t.getInfoWithPath=function(e,t){if(!e)return null;e=zl(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(nt.isChildClassOf(o.ctor,t))return o}}return null},t.getDirWithPath=function(e,t,n){"/"===(e=zl(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var o=0,a=n.length;o<a;o++){var s=n[o];t&&!nt.isChildClassOf(s.ctor,t)||i.push(s)}})),i},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,n){return n.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}},t._initPath=function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=nt._getClassById(o),t.has(r)?a?t.get(r).push(s):t.get(r).unshift(s):t.add(r,[s])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var r=e[i],o=n.get(r);o.url=i,t.add(i,o)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],r={uuid:n,packedUuids:i,ext:".json"};t.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=t.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];t.get(o).ver=n[i+1]}if(n=e.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];t.get(c).nativeVer=n[a+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var r=e[n];t.get(r).redirect=e[n+1]}},e}();function hN(e,t){e._uuid&&t.push(e._uuid)}function _N(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=e[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof Iu&&hN(s,t)}else if(o.constructor&&o.constructor!==Object)o instanceof Iu&&hN(o,t);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof Iu&&hN(u,t)}}}}function fN(e,t){for(var n=0;n<e._components.length;n++)_N(e._components[n],t);for(var i=0;i<e._children.length;i++)fN(e._children[i],t)}function dN(e,t,n,i){n.push(e._uuid);for(var r=Xm.getDeps(e._uuid),o=0,a=r.length;o<a;o++){var s=yl.get(r[o]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||dN(s,t,n,i)}}}var pN=[],mN=new(function(){function e(){this._persistNodeDeps=new ml,this._toDelete=new ml,this._eventListener=!1}var t=e.prototype;return t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];fN(e,t);for(var n=0,i=t.length;n<i;n++){var r=yl.get(t[n]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var r=yl.get(t[n]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,n){if(e){for(var i=Xm.getDeps(e.uuid),r=0,o=i.length;r<o;r++){var a=yl.get(i[r]);a&&a.decRef(e.autoReleaseAssets)}var s=Xm._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=yl.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&Xm.remove(e.uuid)}var _=Xm._depends.get(t.uuid);for(var f in _&&(_.persistDeps=[]),n){for(var d,p,m=n[f],v=this._persistNodeDeps.get(m.uuid),g=ae(v);!(p=g()).done;){var y=p.value,x=yl.get(y);x&&x.addRef()}_&&(d=_.persistDeps).push.apply(d,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof Iu&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,yt(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var n=e._uuid;if(this._toDelete.remove(n),pl(e,!0)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,dN(e,t,pN,-1),pN.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&dN(yl.get(n),t,pN,1);return pN.length=0,t[e._uuid]}(e)>0)){yl.remove(n);for(var i=Xm.getDeps(n),r=0,o=i.length;r<o;r++){var a=yl.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),Xm.remove(n)}},e}()),vN=null;function gN(e,t){for(var n=0,i=e.input.length;n<i;n++){var r=e.input[n];t&&!r.isNative&&r.content instanceof Iu&&r.content.decRef(!1),r.recycle()}e.input=null}function yN(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function xN(e,t,n,i,r){void 0===r&&(r=0),e(r,(function(o,a){r++,!o||r>t?i&&i(o,a):setTimeout((function(){xN(e,t,n,i,r)}),n)}))}function SN(e,t,n,i,r){try{for(var o=Xm.parse(e,t),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(Q({},o.nativeDep)))}catch(e){S(e.message,e.stack)}}function CN(e,t,n){t&&(n=void 0!==n?n:l.assetManager.cacheAsset,Fl(t)||!n||t.isDefault||yl.add(e,t))}function AN(e,t,n){var i=0,r=[],o=e.length;0===o&&n&&n(r);for(var a=function(e){e&&r.push(e),++i===o&&n&&n(r)},s=0;s<o;s++)t(e[s],a)}function bN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a="function"==typeof e;t?(o=t,a||(r=null)):void 0===t&&a&&(o=e,i=null,r=null),void 0!==t&&a&&(r=e,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function TN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a=nt.isChildClassOf(e,Iu);t?(o=t,a&&(r=null)):void 0!==t||a||(o=e,r=null,i=null),void 0===t||a||(r=e,i=null)}return{type:i,onProgress:r||vN,onComplete:o}}function EN(e,t,n,i){if(void 0===i&&(i={}),!n[t]||i[t])return!1;i[t]=!0;var r=!1,o=Xm.getDeps(t);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===e||EN(e,c,n,i)){r=!0;break}}return r}function wN(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof Iu&&i.push(e.addRef())})):n instanceof Iu&&i.push(n.addRef()),yt((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var IN=function(){function e(){this._config=new uN}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,n){return this._config.getDirWithPath(e,t,n)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),Cl.add(e.name,this)},t.load=function(e,t,n,i){var r=TN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c={__requestType__:gl.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(e)};l.assetManager.loadAny(e,c,a,s)},t.preload=function(e,t,n,i){var r=TN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;l.assetManager.preloadAny(e,{__requestType__:gl.PATH,type:o,bundle:this.name},a,s)},t.loadDir=function(e,t,n,i){var r=TN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;l.assetManager.loadAny(e,{__requestType__:gl.DIR,type:o,bundle:this.name,__outputAsArray__:!0},a,s)},t.preloadDir=function(e,t,n,i){var r=TN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;l.assetManager.preloadAny(e,{__requestType__:gl.DIR,type:o,bundle:this.name},a,s)},t.loadScene=function(e,t,n,i){var r=bN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"scene",o.bundle=this.name,l.assetManager.loadAny({scene:e},o,a,(function(e,t){if(e)S(e.message,e.stack);else if(t instanceof _D&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");s&&s(e,t)}))},t.preloadScene=function(e,t,n,i){var r=bN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.bundle=this.name,l.assetManager.preloadAny({scene:e},o,a,(function(t){t&&O(1210,e,t.message),s&&s(t)}))},t.get=function(e,t){var n=this.getInfoWithPath(e,t);return n&&yl.get(n.uuid)||null},t.release=function(e,t){var n=this.get(e,t);n&&mN.tryRelease(n,!0)},t.releaseUnusedAssets=function(){var e=this;yl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&mN.tryRelease(t)}))},t.releaseAll=function(){var e=this;yl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&mN.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},J(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),PN=e("resources",new IN);function RN(e,t,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(L(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=e,i}function DN(e,t,n,i){var r=new XMLHttpRequest,o="download failed: "+e+", status: ";if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)r.setRequestHeader(a,t.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}l.resources=PN;var ON={};function NN(e,t,n){if(ON[e])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),ON[e]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(L(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var BN=/^(?:\w+:\/\/|\.+\/).+/,MN=function(e,t,n){(oh.hasFeature(oh.Feature.IMAGE_BITMAP)&&l.assetManager.allowImageBitmap?LN:RN)(e,t,n)},LN=function(e,t,n){t.xhrResponseType="blob",DN(e,t,t.onFileProgress,n)},FN=function(e,t,n){t.xhrResponseType="json",DN(e,t,t.onFileProgress,n)},zN=function(e,t,n){t.xhrResponseType="arraybuffer",DN(e,t,t.onFileProgress,n)},VN=function(e,t,n){FN(e,t,(function(t,i){if(t)n(t);else{var r=lh(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){zN(""+vu(e)+n,{},(function(e,n){t?r(t):i(new Uint8Array(n))}))}))}))).then((function(e){var t=new ch(r.document,e);n(null,t)})).catch((function(e){n(e)}))}}))},GN=function(e,t,n){zN(e,t,(function(e,t){if(e)n(e);else try{var i=uh(new Uint8Array(t));n(null,i)}catch(e){n(e)}}))},UN=function(e,t,n){t.xhrResponseType="text",DN(e,t,t.onFileProgress,n)},kN=function(e,t,n){var i=gu(e),r=e;BN.test(r)||(r=-1!==HN.remoteBundles.indexOf(i)?HN.remoteServerAddress+"remote/"+i:"assets/"+i);var o=t.version||HN.bundleVers[i],a=0,s=null,c=null;FN(r+"/config."+(o?o+".":"")+"json",t,(function(e,t){c=e,(s=t)&&(s.base=r+"/"),2==++a&&n(c,s)})),NN(r+"/index."+(o?o+".":"")+"js",t,(function(e){c=e,2==++a&&n(e,s)}))},HN=new(function(){function e(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=RN,this.downloadDomAudio=null,this.downloadFile=DN,this.downloadScript=NN,this._downloaders={".png":MN,".jpg":MN,".bmp":MN,".jpeg":MN,".gif":MN,".ico":MN,".tiff":MN,".webp":MN,".image":MN,".pvr":zN,".pkm":zN,".astc":zN,".txt":UN,".xml":UN,".vsh":UN,".fsh":UN,".atlas":UN,".tmx":UN,".tsx":UN,".json":FN,".ExportJson":FN,".plist":UN,".ccon":VN,".cconb":GN,".fnt":UN,".binary":zN,".bin":zN,".dbbin":zN,".skel":zN,".js":NN,bundle:kN,default:UN},this._downloading=new ml,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var t=e.prototype;return t.init=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n},t.register=function(e,t){"object"==typeof e?ze(this._downloaders,e):this._downloaders[e]=t},t.download=function(e,t,n,i,r){var o=this,a=xl.get(e);if(a)r(null,a);else{var s=this._downloading.get(e);if(s){s.push(r);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,_=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,f=this._downloaders[n]||this._downloaders.default;xN((function(n,a){if(0===n&&o._downloading.add(e,[r]),o.limited){o._updateTime();var s=function(e,t){o._totalNum--,o._handleQueueInNextFrame(h,_),a(e,t)};o._totalNum<h&&o._totalNumThisPeriod<_?(f(yN(t,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:f}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,_))}else f(yN(t,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(t,n){t||xl.add(e,n);for(var i=o._downloading.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))}}},t.loadSubpackage=function(e,t){l.assetManager.loadBundle(e,null,t)},t._updateTime=function(){var e=performance.now(),t=l.game.deltaTime,n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)},t._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(yN(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)},t._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(yt(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},J(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),e}());function jN(e,t,n,i){var r=null,o=null;try{(r=new Um)._nativeUrl=e,r._nativeAsset=t}catch(e){o=e}i(o,r)}function WN(e,t,n,i){var r=new gD;r.json=t,i(null,r)}function qN(e,t,n,i){var r=new vD;r.text=t,i(null,r)}function XN(e,t,n,i){var r=new WE;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function YN(e,t,n,i){var r=new Iu;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function KN(e,n,i,r){var o=Cl.get(n.name);o||(o=n.name===El.RESOURCES?PN:new IN,n.base=n.base||e+"/",o.init(n)),t.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var JN=new(function(){function e(){this._creating=new ml,this._producers={".png":jN,".jpg":jN,".bmp":jN,".jpeg":jN,".gif":jN,".ico":jN,".tiff":jN,".webp":jN,".image":jN,".pvr":jN,".pkm":jN,".txt":qN,".xml":qN,".vsh":qN,".fsh":qN,".atlas":qN,".tmx":qN,".tsx":qN,".fnt":qN,".json":WN,".ExportJson":WN,".binary":XN,".bin":XN,".dbbin":XN,".skel":XN,bundle:KN,default:YN}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?nt.mixin(this._producers,e):this._producers[e]=t},t.create=function(e,t,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=yl.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(r):(this._creating.add(e,[r]),a(e,t,i,(function(t,n){!t&&n instanceof Iu&&(n._uuid=e,CN(e,n,i.cacheAsset));for(var r=o._creating.remove(e),a=0,s=r.length;a<s;a++)r[a](t,n)})))}else r(null,s)},e}()),QN=new(function(){function e(){this._loading=new ml,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,n,i){var r=nt.createMap(!0),o=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(L(5304,e[0]));Rh(e,!0,void 0,Oh.reportMissingClass),Dh(e);for(var t=new Nh(e[0]),n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=0;s<a.length;++s)a[s].unshift(t,n,i,r,o);return a}(t)).length!==e.length&&O(4915);for(var a=0;a<e.length;a++)r[e[a]+"@import"]=t[a]}else{var s=nt._getClassId(uv),c=nt._getClassId(Um);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&O(4915);for(var u=0;u<e.length;u++)r[e[u]+"@import"]=Bh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&O(4915);for(var _=0;_<e.length;_++)r[e[_]+"@import"]=h[_]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?nt.mixin(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,n,i,r){t?(0,this._unpackers[n])(e,t,i,r):r(new Error("package data is wrong!"))},t.load=function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(xl.has(e.id))n(null,xl.get(e.id));else{var r=e.info.packs,o=r.find((function(e){return i._loading.has(e.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:e.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:e.id}]);var a=Vl(o.uuid,{ext:o.ext,bundle:e.config.name});HN.download(o.uuid,a,o.ext,e.options,(function(t,n){xl.remove(o.uuid),t&&S(t.message,t.stack),i.unpack(o.packedUuids,n,o.ext,e.options,(function(e,n){if(!e)for(var r in n)xl.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else HN.download(e.id,e.url,e.ext,e.options,n)},e}());function ZN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress,o=[],a=r.total,s=i.__exclude__=i.__exclude__||Object.create(null);e.output=[],AN(e.input,(function(i,c){if(!i.isNative&&yl.has(i.uuid)){var u=yl.get(i.uuid);return i.content=u.addRef(),e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i),void c()}QN.load(i,e.options,(function(u,h){u?e.isFinish||(!l.assetManager.force||n?(S(u.message,u.stack),r.canInvoke=!1,t(u)):(e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i))):e.isFinish||(i.file=h,e.output.push(i),i.isNative||(s[i.uuid]=!0,SN(i.uuid,h,s,o,i.config),r.total=a+o.length),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i)),c()}))}),(function(){if(e.isFinish)return gN(e,!0),void e.dispatch("error");if(o.length>0){var a=Il.create({input:o,progress:r,options:i,onProgress:e.onProgress,onError:Il.prototype.recycle,onComplete:function(i){var r;i||((r=e.output).push.apply(r,a.output),a.recycle()),n&&$N(e),t(i)}});bl.async(a)}else n&&$N(e),t()}))}function $N(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var eB=new(function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return R(5100),{};for(var n=null,i=0,r=t.childNodes.length;i<r&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t},n._parseArray=function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t},n._parseDict=function(e){for(var t={},n="",i=0,r=e.childNodes.length;i<r;i++){var o=e.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:t[n]=this._parseNode(o))}return t},t}(function(){function e(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()));function tB(e,t){return e[t]<<8|e[t+1]}var nB=new(function(){function e(){this._parsing=new ml,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))},t.parsePVRTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],_=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:_,height:h,format:0}}}catch(e){i=e}n(i,r)},t.parsePKMTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o),s=tB(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=tB(a,12),l=tB(a,14);tB(a,8),tB(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,r)},t.parseASTCTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?gm.RGBA_ASTC_4x4:5===e?4===t?gm.RGBA_ASTC_5x4:gm.RGBA_ASTC_5x5:6===e?5===t?gm.RGBA_ASTC_6x5:gm.RGBA_ASTC_6x6:8===e?5===t?gm.RGBA_ASTC_8x5:6===t?gm.RGBA_ASTC_8x6:gm.RGBA_ASTC_8x8:10===e?5===t?gm.RGBA_ASTC_10x5:6===t?gm.RGBA_ASTC_10x6:8===t?gm.RGBA_ASTC_10x8:gm.RGBA_ASTC_10x10:10===t?gm.RGBA_ASTC_12x10:gm.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),_=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:_,format:u}}catch(e){i=e}n(i,r)},t.parsePlist=function(e,t,n){var i=null,r=eB.parse(e);r||(i=new Error("parse failed")),n(i,r)},t.parseImport=function(e,t,n){if(e){var i=null,r=null;try{i=Wm(e,t)}catch(e){r=e}n(r,i)}else n(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?ze(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,n,i,r){var o=this,a=Sl.get(e);if(a)r(null,a);else{var s=this._parsing.get(e);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(e,[r]),c(t,i,(function(t,n){t?xl.remove(e):Fl(n)||Sl.add(e,n);for(var i=o._parsing.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))):r(null,t)}}},e}());function iB(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress;i.__exclude__=i.__exclude__||Object.create(null),e.output=[],AN(e.input,(function(o,a){var s=Il.create({input:o,onProgress:e.onProgress,options:i,progress:r,onComplete:function(i,c){i&&!e.isFinish&&(!l.assetManager.force||n?(S(i.message,i.stack),r.canInvoke=!1,t(i)):r.canInvoke&&e.dispatch("progress",++r.finish,r.total,o)),e.output.push(c),s.recycle(),a(null)}});rB.async(s)}),(function(){if(i.__exclude__=null,e.isFinish)return gN(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,r=t.length;i<r;i++)n.push(t[i].content);else e.output=t[0].content}(e),gN(e,!0),t()}))}var rB=new vl("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&yl.has(o)?t():QN.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,r=e.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)nB.parse(o,a,n.ext,s,(function(r,a){r?t(r):(n.content=a,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),xl.remove(o),Sl.remove(o),t())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,_=l.err,f=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||EN(c,c,r)?(h&&h.addRef(),n.content=h,t(_)):f.push({done:t,item:n})}else if(!s.reloadAsset&&yl.has(c)){var d=yl.get(c);n.content=d.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,nB.parse(o,a,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,r=e.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),SN(a,t,Object.create(null),h,l),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=h.length,i);var _=e.options.__exclude__[a]={content:t,finish:!1,callbacks:[{done:n,item:i}]},f=Il.create({input:h,options:e.options,onProgress:e.onProgress,onError:Il.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),_.finish=!0,_.err=e,!e){for(var n,i=Array.isArray(f.output)?f.output:[f.output],r=Object.create(null),o=ae(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof Iu?c._uuid+"@import":a+"@native"]=c)}!function(e,t,n){var i=km.get(t);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(S("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Iu){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}km.delete(t)}Hm.has(t)&&(n[e+"@native"]?t._nativeAsset=n[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),Hm.delete(t))}(a,t,r);try{"function"!=typeof t.onLoaded||jm.has(t)||Hm.has(t)||(t.onLoaded(),jm.add(t))}catch(e){S("The asset "+a+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}xl.remove(s),Sl.remove(s),CN(a,t,u),f.recycle()}for(var l=_.callbacks,h=0,d=l.length;h<d;h++){var p=l[h];t.addRef&&t.addRef(),p.item.content=t,p.done(e)}l.length=0}});Al.async(f)}(e,i,t)}))}}]);function oB(e,t){var n=e.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case gl.PATH:case gl.UUID:case gl.DIR:case gl.SCENE:case gl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}e.options=r;var a=Il.create({input:e.input,options:i}),s=null;try{e.output=e.source=Tl.sync(a)}catch(e){s=e;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),t(s)}var aB=function(){function e(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},J(e,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),e}();aB.MAX_DEAD_NUM=500,aB._deadPool=[];var sB=[];function cB(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var r,o=n[i],a=aB.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[t.__requestType__||gl.UUID]=n[i]),"object"==typeof o)for(var l in Fe(o,t),o.preset&&Fe(o,wl[o.preset]),o){switch(l){case gl.UUID:if("break"===function(){var e,t=a.uuid=Nl(o.uuid);if(!o.bundle){var n=Cl.find((function(e){return!!e.getAssetInfo(t)}));o.bundle=n&&n.name}if(Cl.has(o.bundle)){if(s=Cl.get(o.bundle).config,(c=s.getAssetInfo(t))&&c.redirect){if(!Cl.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=Cl.get(c.redirect).config,c=s.getAssetInfo(t)}a.config=s,a.info=c}return a.ext=o.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case gl.DIR:if(Cl.has(o.bundle)){Cl.get(o.bundle).config.getDirWithPath(o.dir,o.type,sB);for(var u,h=ae(sB);!(u=h()).done;){var _=u.value;n.push({uuid:_.uuid,__isNative__:!1,ext:_.extension||".json",bundle:o.bundle})}sB.length=0}a.recycle(),a=null;break;case gl.PATH:if(Cl.has(o.bundle)){if(s=Cl.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!Cl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Cl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case gl.SCENE:if(!o.bundle){var f=Cl.find((function(e){return!!e.getSceneInfo(o.scene)}));o.bundle=f&&f.name}if(Cl.has(o.bundle)){if(s=Cl.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!Cl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Cl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case gl.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||mu(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(e.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function lB(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var i=t[n];if(!i.url){var r,o,a=i.config;o=i.isNative?a&&a.nativeBase?a.base+a.nativeBase:l.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:l.assetManager.generalImportBase;var s=i.uuid,c="";i.info&&(c=i.isNative?i.info.nativeVer?"."+i.info.nativeVer:"":i.info.ver?"."+i.info.ver:""),r=".ttf"===i.ext?o+"/"+s.slice(0,2)+"/"+s+c+"/"+i.options.__nativeName__:o+"/"+s.slice(0,2)+"/"+s+c+i.ext,i.url=r}}return null}var uB=e("AssetManager",function(){function e(){this.pipeline=Al.append(oB).append(iB),this.fetchPipeline=bl.append(oB).append(ZN),this.transformPipeline=Tl.append(cB).append(lB),this.bundles=Cl,this.assets=yl,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Xm,this.force=!1,this.allowImageBitmap=!oh.isMobile,this.utils=Gl,this.downloader=HN,this.parser=nB,this.packManager=QN,this.cacheAsset=!0,this.cacheManager=null,this.presets=wl,this.factory=JN,this.preprocessPipe=oB,this.fetchPipe=ZN,this.loadPipe=iB,this.references=null,this._releaseManager=mN,this._files=xl,this._parsed=Sl,this._parsePipeline=null}var t=e.prototype;return t.init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n},t.getBundle=function(e){return Cl.get(e)||null},t.removeBundle=function(e){e._destroy(),Cl.remove(e.name)},t.loadAny=function(e,t,n,i){var r=bN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",e=Array.isArray(e)?e.slice():e;var c=Il.create({input:e,onProgress:a,onComplete:wN(s),options:o});Al.async(c)},t.preloadAny=function(e,t,n,i){var r=bN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=Il.create({input:e,onProgress:a,onComplete:wN(s),options:o});bl.async(c)},t.loadRemote=function(e,t,n){var i=bN(t,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,n){t?(S(t.message,t.stack),o&&o(t,n)):JN.create(e,n,r.ext||mu(e),r,(function(e,t){o&&o(e,t)}))}))):wN(o)(null,this.assets.get(e))},t.loadBundle=function(e,t,n){var i=bN(t,void 0,n),r=i.options,o=i.onComplete,a=gu(e);this.bundles.has(a)?wN(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,n){t?(S(t.message,t.stack),o&&o(t,n)):JN.create(e,n,"bundle",r,(function(e,t){o&&o(e,t)}))})))},t.releaseAsset=function(e){mN.tryRelease(e,!0)},t.releaseUnusedAssets=function(){yl.forEach((function(e){mN.tryRelease(e)}))},t.releaseAll=function(){yl.forEach((function(e){mN.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},J(e,[{key:"main",get:function(){return Cl.get(El.MAIN)||null}},{key:"resources",get:function(){return Cl.get(El.RESOURCES)||null}}]),e}());uB.Pipeline=vl,uB.Task=Il,uB.Cache=ml,uB.RequestItem=aB,uB.Bundle=IN,uB.BuiltinBundleName=El;var hB=e("assetManager",l.assetManager=new uB);l.AssetManager=uB;var _B=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],fB=[".mp3",".ogg",".wav",".m4a"];function dB(){return!0}var pB={transformURL:function(e){var t=Ml(e);if(!t)return e;var n=Cl.find((function(e){return!!e.getAssetInfo(t)}));if(!n)return e;var i,r=n.getAssetInfo(t);if(!(i=e.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==e.indexOf(i))return e;var o=!1;if(".ttf"===mu(e)&&(o=!0),o){var a=yu(e),s=gu(e);e=a+"."+i+"/"+s}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return e+"."+i}));return e}},mB=e("CCLoader",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=TN}var t=e.prototype;return t.load=function(e,t,n){void 0===n&&void 0!==t&&(n=t,t=null);for(var i=Array.isArray(e)?e:[e],r=0;r<i.length;r++){var o=i[r];"string"==typeof o?i[r]={url:o,__isNative__:!0}:(o.type&&(o.ext="."+o.type,o.type=void 0),o.url&&(o.__isNative__=!0))}var a=[],s=[];hB.loadAny(i,null,(function(e,n,i){i.content&&(_B.includes(i.ext)?a.push(i.content):fB.includes(i.ext)&&s.push(i.content)),t&&t(e,n,i)}),(function(e,t){var r=null;if(!e){t=Array.isArray(t)?t:[t];for(var o=function(e){var n=t[e];if(!(n instanceof Iu)){var r=n,o=i[e].url;a.includes(r)?JN.create(o,n,".png",{},(function(n,i){r=t[e]=i})):s.includes(r)&&JN.create(o,n,".mp3",{},(function(n,i){r=t[e]=i})),yl.add(o,r)}},c=0;c<t.length;c++)o(c);if(t.length>1){var l=Object.create(null);t.forEach((function(e){l[e._uuid]=e})),r={isCompleted:dB,_map:l}}else r=t[0]}n&&n(e,r)}))},t.getXMLHttpRequest=function(){return new XMLHttpRequest},t.getItem=function(e){return hB.assets.has(e)?{content:hB.assets.get(e)}:null},t.loadRes=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c=mu(e);c&&!PN.getInfoWithPath(e,o)&&(e=e.slice(0,-c.length)),PN.load(e,o,a,s)},t.loadResArray=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;e.forEach((function(t,n){var i=mu(t);i&&!PN.getInfoWithPath(t,o)&&(e[n]=t.slice(0,-i.length))})),PN.load(e,o,a,s)},t.loadResDir=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;PN.loadDir(e,o,a,(function(t,n){var i=[];t||(i=PN.getDirWithPath(e,o).map((function(e){return e.path}))),s&&s(t,n,i)}))},t.getRes=function(e,t){return yl.has(e)?yl.get(e):PN.get(e,t)},t.getResCount=function(){return yl.count},t.getDependsRecursively=function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return Xm.getDepsRecursively(t).concat([t])},t.addDownloadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({url:e},n)}};for(var i in e)n(i);HN.register(t)},t.addLoadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({content:e},n)}};for(var i in e)n(i);nB.register(t)},t.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];"string"==typeof n&&(n=yl.get(n)),hB.releaseAsset(n)}else e&&("string"==typeof e&&(e=yl.get(e)),hB.releaseAsset(e))},t.releaseAsset=function(e){hB.releaseAsset(e)},t.releaseRes=function(e,t){PN.release(e,t)},t.releaseAll=function(){hB.releaseAll(),yl.clear()},t.removeItem=function(e){return!!yl.remove(e)},t.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},t.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var n=Xm.getDepsRecursively(e),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=t},t.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},J(e,[{key:"onProgress",set:function(e){vN=e}},{key:"_cache",get:function(){if(yl instanceof ml)return yl._map;var e={};return yl.forEach((function(t,n){e[n]=t})),e}},{key:"md5Pipe",get:function(){return pB}},{key:"downloader",get:function(){return HN}},{key:"loader",get:function(){return hB.parser}}]),e}()),vB=e("loader",new mB),gB=e("AssetLibrary",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,hB.init(e),e.rawAssets&&PN.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:El.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){hB.loadAny(e,t)}}),yB=e("url",{});V(yB,"url",[{name:"normalize",target:hB.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?Vl({path:xu(e.substr(10)),bundle:El.RESOURCES,__isNative__:!0,ext:mu(e)}):""}}]),G(gB,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),G(vB,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"loader.assetLoader was removed, assetLoader and md5Pipe were merged into assetManager.transformPipeline"}]),V(l,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return vB}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return gB}},{name:"Pipeline",target:uB,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return yB}}]),G(l,"cc",[{name:"LoadingItems",suggest:L(1400,"LoadingItems","AssetManager.Task")}]),V(lt,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:HN,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),V($O,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var t;return hB.main?null===(t=hB.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),V(QO,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return hB.main&&hB.main.config.scenes.forEach((function(t){e.push(t)})),e}}]);var xB,SB,CB,AB,bB,TB,EB,wB,IB,PB,RB,DB,OB,NB,BB=mN._autoRelease;mN._autoRelease=function(e,t,n){BB.call(mN,e,t,n);for(var i=vB._autoReleaseSetting,r=Object.keys(i),o=0;o<r.length;o++){var a=r[o];if(!0===i[a]){var s=yl.get(a);s&&mN.tryRelease(s)}}};var MB,LB,FB,zB,VB,GB,UB,kB,HB,jB,WB,qB,XB,YB,KB,JB,QB,ZB,$B,eM,tM,nM,iM,rM,oM,aM,sM,cM,lM,uM,hM,_M,fM,dM,pM,mM,vM,gM,yM,xM,SM,CM,AM,bM,TM,EM,wM,IM,PM,RM,DM,OM,NM,BM,MM,LM,FM,zM,VM,GM,UM,kM,HM,jM,WM,qM,XM,YM,KM,JM,QM=e("EventHandler",(xB=Ac("cc.ClickEvent"),SB=ol(l.Node),CB=qc(),AB=qc(),bB=qc(),TB=qc(),xB((NB=function(){function e(){se(this,"target",IB,this),se(this,"component",PB,this),se(this,"_componentId",RB,this),se(this,"handler",DB,this),se(this,"customEventData",OB,this)}e.emitEvents=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=t.length;o<a;o++){var s=t[o];s instanceof e&&s.emit(i)}};var t=e.prototype;return t.emit=function(e){var t=this.target;if(l.isValid(t)){this._genCompIdIfNeeded();var n=l.js._getClassById(this._componentId),i=t.getComponent(n);if(l.isValid(i)){var r=i[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(i,e))}}},t._compName2Id=function(e){var t=l.js.getClassByName(e);return l.js._getClassId(t)},t._compId2Name=function(e){var t=l.js._getClassById(e);return l.js.getClassName(t)},t._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},J(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),e}(),IB=ce((wB=NB).prototype,"target",[Dc,SB,Dc,CB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PB=ce(wB.prototype,"component",[Dc,kc,AB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),RB=ce(wB.prototype,"_componentId",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),DB=ce(wB.prototype,"handler",[Dc,kc,bB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),OB=ce(wB.prototype,"customEventData",[Dc,kc,TB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),EB=wB))||EB));l.Component.EventHandler=QM;var ZM,$M,eL,tL,nL,iL,rL,oL,aL,sL,cL=new Pn,lL=rt(jv),uL=rt(Hv),hL=rt(Wv),_L=rt(Xv),fL=rt(qv),dL=rt({SKYBOX:ng|Ki.DEPTH_STENCIL,SOLID_COLOR:Ki.ALL,DEPTH_ONLY:Ki.DEPTH_STENCIL,DONT_CLEAR:Ki.NONE}),pL=(MB=Ac("cc.Camera"),LB=Uc(),FB=Fc(),zB=Zc(),VB=qc(),GB=ol(Cd.BitMask),UB=Zc(),kB=qc(),HB=ol(dL),jB=Zc(),WB=qc(),qB=Zc(),XB=qc(),YB=Zc(),KB=qc(),JB=Zc(),QB=qc(),ZB=ol(lL),$B=Zc(),eM=qc(),tM=ol(uL),nM=Zc(),iM=Hc(),rM=qc(),oM=Zc(),aM=Hc(),sM=qc(),cM=Zc(),lM=Hc(),uM=qc(),hM=Zc(),_M=qc(),fM=Zc(),dM=qc(),pM=ol(hL),mM=Zc(),vM=qc(),gM=ol(_L),yM=Zc(),xM=qc(),SM=ol(fL),CM=Zc(),AM=qc(),bM=Zc(),TM=qc(),EM=ol(DC),wM=Zc(),IM=qc(),ZM=MB(PM=LB(PM=FB(PM=Lc((JM=KM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_projection",DM,re(t)),se(t,"_priority",OM,re(t)),se(t,"_fov",NM,re(t)),se(t,"_fovAxis",BM,re(t)),se(t,"_orthoHeight",MM,re(t)),se(t,"_near",LM,re(t)),se(t,"_far",FM,re(t)),se(t,"_color",zM,re(t)),se(t,"_depth",VM,re(t)),se(t,"_stencil",GM,re(t)),se(t,"_clearFlags",UM,re(t)),se(t,"_rect",kM,re(t)),se(t,"_aperture",HM,re(t)),se(t,"_shutter",jM,re(t)),se(t,"_iso",WM,re(t)),se(t,"_screenScale",qM,re(t)),se(t,"_visibility",XM,re(t)),se(t,"_targetTexture",YM,re(t)),t._camera=null,t._inEditorMode=!1,t._flows=void 0,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=py.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(e,t,n){return n||(n=ia.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n},n.worldToScreen=function(e,t){return t||(t=new Pn),this._camera&&this._camera.worldToScreen(t,e),t},n.screenToWorld=function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t},n.convertToUINode=function(e,t,n){if(n||(n=new Pn),!this._camera)return n;this.worldToScreen(e,cL);var i=t.getComponent("cc.UITransform"),r=lN.getVisibleSize(),o=cL.x-.5*this._camera.width,a=cL.y-.5*this._camera.height;return cL.x=o/l.view.getScaleX()+.5*r.width,cL.y=a/l.view.getScaleY()+.5*r.height,i&&i.convertToNodeSpaceAR(cL,n),n},n._createCamera=function(){this._camera||(this._camera=l.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?l.director.root&&l.director.root.mainWindow:l.director.root&&l.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=hn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}},J(t,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===Hv.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=hn(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var n=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?l.director.root&&l.director.root.mainWindow:l.director.root&&l.director.root.tempWindow)}}]),t}(Ku),KM.ProjectionType=lL,KM.FOVAxis=uL,KM.ClearFlag=dL,KM.Aperture=hL,KM.Shutter=_L,KM.ISO=fL,KM.TARGET_TEXTURE_CHANGE="tex-change",DM=ce((RM=JM).prototype,"_projection",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lL.PERSPECTIVE}}),OM=ce(RM.prototype,"_priority",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NM=ce(RM.prototype,"_fov",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),BM=ce(RM.prototype,"_fovAxis",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uL.VERTICAL}}),MM=ce(RM.prototype,"_orthoHeight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),LM=ce(RM.prototype,"_near",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),FM=ce(RM.prototype,"_far",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),zM=ce(RM.prototype,"_color",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn("#333333")}}),VM=ce(RM.prototype,"_depth",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),GM=ce(RM.prototype,"_stencil",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),UM=ce(RM.prototype,"_clearFlags",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dL.SOLID_COLOR}}),kM=ce(RM.prototype,"_rect",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ii(0,0,1,1)}}),HM=ce(RM.prototype,"_aperture",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hL.F16_0}}),jM=ce(RM.prototype,"_shutter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _L.D125}}),WM=ce(RM.prototype,"_iso",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fL.ISO100}}),qM=ce(RM.prototype,"_screenScale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),XM=ce(RM.prototype,"_visibility",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fp}}),YM=ce(RM.prototype,"_targetTexture",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ce(RM.prototype,"priority",[zB,VB],Object.getOwnPropertyDescriptor(RM.prototype,"priority"),RM.prototype),ce(RM.prototype,"visibility",[GB,UB,kB],Object.getOwnPropertyDescriptor(RM.prototype,"visibility"),RM.prototype),ce(RM.prototype,"clearFlags",[HB,jB,WB],Object.getOwnPropertyDescriptor(RM.prototype,"clearFlags"),RM.prototype),ce(RM.prototype,"clearColor",[qB,XB],Object.getOwnPropertyDescriptor(RM.prototype,"clearColor"),RM.prototype),ce(RM.prototype,"clearDepth",[YB,KB],Object.getOwnPropertyDescriptor(RM.prototype,"clearDepth"),RM.prototype),ce(RM.prototype,"clearStencil",[JB,QB],Object.getOwnPropertyDescriptor(RM.prototype,"clearStencil"),RM.prototype),ce(RM.prototype,"projection",[ZB,$B,eM],Object.getOwnPropertyDescriptor(RM.prototype,"projection"),RM.prototype),ce(RM.prototype,"fovAxis",[tM,nM,iM,rM],Object.getOwnPropertyDescriptor(RM.prototype,"fovAxis"),RM.prototype),ce(RM.prototype,"fov",[oM,aM,sM],Object.getOwnPropertyDescriptor(RM.prototype,"fov"),RM.prototype),ce(RM.prototype,"orthoHeight",[cM,lM,uM],Object.getOwnPropertyDescriptor(RM.prototype,"orthoHeight"),RM.prototype),ce(RM.prototype,"near",[hM,_M],Object.getOwnPropertyDescriptor(RM.prototype,"near"),RM.prototype),ce(RM.prototype,"far",[fM,dM],Object.getOwnPropertyDescriptor(RM.prototype,"far"),RM.prototype),ce(RM.prototype,"aperture",[pM,mM,vM],Object.getOwnPropertyDescriptor(RM.prototype,"aperture"),RM.prototype),ce(RM.prototype,"shutter",[gM,yM,xM],Object.getOwnPropertyDescriptor(RM.prototype,"shutter"),RM.prototype),ce(RM.prototype,"iso",[SM,CM,AM],Object.getOwnPropertyDescriptor(RM.prototype,"iso"),RM.prototype),ce(RM.prototype,"rect",[bM,TM],Object.getOwnPropertyDescriptor(RM.prototype,"rect"),RM.prototype),ce(RM.prototype,"targetTexture",[EM,wM,IM],Object.getOwnPropertyDescriptor(RM.prototype,"targetTexture"),RM.prototype),PM=RM))||PM)||PM)||PM)||PM,e({Camera:ZM,CameraComponent:ZM}),ZM);l.Camera=pL;var mL={parent:null,owner:null,subModelIdx:0},vL=e("RenderableComponent",($M=Ac("cc.RenderableComponent"),eL=ol(Kv),tL=Zc(),nL=Wc(),iL=ol([Kv]),$M((ce((oL=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_visFlags",aL,re(t)),se(t,"_materials",sL,re(t)),t._materialInstances=[],t._models=[],t}Z(t,e);var n=t.prototype;return n.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},n.setMaterial=function(e,t){e&&e instanceof oy&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n&&(n.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])},n.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){mL.parent=this._materials[e],mL.owner=this,mL.subModelIdx=e;var t=new oy(mL);mL.parent=null,mL.owner=null,mL.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]},n.setMaterialInstance=function(e,t){if("number"==typeof e){R(12007);var n=e;e=t,t=n}var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)},n.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},J(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){for(var t=e.length,n=this._materials.length,i=t;i<n;i++)this.setMaterialInstance(null,i);this._materials.length=t,this._materialInstances.length=t;for(var r=0;r<t;r++)this._materialInstances[r]!=e[r]&&this.setMaterialInstance(e[r],r)}}]),t}(Ku)).prototype,"sharedMaterials",[eL,tL,nL],Object.getOwnPropertyDescriptor(oL.prototype,"sharedMaterials"),oL.prototype),aL=ce(oL.prototype,"_visFlags",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cd.Enum.NONE}}),sL=ce(oL.prototype,"_materials",[iL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rL=oL))||rL));l.RenderableComponent=vL,V(pL,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),V(pL.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),l.CameraComponent=pL,nt.setClassAlias(pL,"cc.CameraComponent"),l.math=si,l.geometry=xd;var gL=new Pn,yL=new jn;function xL(e,t,n,i){var r=n.chunk,o=n.data,a=r.vb,s=n.vertexCount;e.getWorldMatrix(yL);for(var c=0,l=0;l<s;l++){var u=o[l];Pn.set(gL,u.x,u.y,0),Pn.transformMat4(gL,gL,yL),a[c++]=gL.x,a[c++]=gL.y,a[c++]=gL.z,wn.toArray(a,i,c+2),c+=6}for(var h=r.bufferId,_=r.vertexOffset,f=r.vertexAccessor.getMeshBuffer(r.bufferId),d=r.vertexAccessor.getIndexBuffer(h),p=f.indexOffset,m=0,v=s/4;m<v;m++){var g=_+4*m;d[p++]=g,d[p++]=g+1,d[p++]=g+2,d[p++]=g+1,d[p++]=g+3,d[p++]=g+2}f.indexOffset+=n.indexCount,f.setDirty()}var SL={},CL=function(){function e(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new AL;n.initWithSize(e,t),this._texture=n,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var t=e.prototype;return t.insertSpriteFrame=function(e){var t=e.rect,n=e.texture,i=this._innerTextureInfos[n.getId()],r=t.x,o=t.y;if(i)r+=i.x,o+=i.y;else{var a=n.width,s=n.height;if(this._x+a+2>this._width&&(this._x=2,this._y=this._nexty),this._y+s+2>this._nexty&&(this._nexty=this._y+s+2),this._nexty>this._height)return null;l.internal.dynamicAtlasManager.textureBleeding&&((a<=8||s<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,r+=this._x,o+=this._y,this._x+=a+2}var c={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(e),c},t.deleteInnerTexture=function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)},t.isEmpty=function(){return this._count<=0},t.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,n=e.length;t<n;t++){var i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},t.destroy=function(){this.reset(),this._texture.destroy()},e}(),AL=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=gm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new lr;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(uv),bL=function(){function e(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var t=e.prototype;return t.newAtlas=function(){var e=this._atlases[++this._atlasIndex];return e||(e=new CL(this._textureSize,this._textureSize),this._atlases.push(e)),e},t.beforeSceneLoad=function(){this.reset()},t.insertSpriteFrame=function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==xm.LINEAR||t.magFilter!==xm.LINEAR||t.mipFilter!==xm.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(e);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(e)},t.reset=function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1},t.deleteAtlasSpriteFrame=function(e){if(e._original){for(var t,n=this._atlases.length-1;n>=0;n--)t=this._atlases[n],nt.array.fastRemove(t._innerSpriteFrames,e);var i=e._original._texture;this.deleteAtlasTexture(i)}},t.deleteAtlasTexture=function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)},t.packToDynamicAtlas=function(e,t){if(t&&!t._original&&t.packable&&t.texture&&t.texture.width>0&&t.texture.height>0){var n=this.insertSpriteFrame(t);n&&t._setDynamicAtlasFrame(n)}},J(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),l.director.on(l.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),l.director.off(l.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}}]),e}();bL.instance=void 0;var TL,EL,wL,IL=e("dynamicAtlasManager",bL.instance=new bL);l.internal.dynamicAtlasManager=IL;var PL,RL,DL,OL,NL=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],BL=e("SpriteFrame",Ac("cc.SpriteFrame")((wL=EL=function(e){function t(){var t;return(t=e.call(this)||this).vertices=null,t.uv=[],t.unbiasUV=[],t.uvSliced=[],t._rect=new ii,t._offset=new Yn,t._originalSize=new ti,t._rotated=!1,t._capInsets=[0,0,0,0],t._atlasUuid="",t._texture=void 0,t._isFlipUVY=!1,t._isFlipUVX=!1,t._original=null,t._packable=!0,t}Z(t,e),t.createWithImage=function(e){var n=e instanceof Um?e:new Um(e),i=new uv;i.image=n;var r=new t;return r.texture=i,r};var n=t.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(e){this.rotated=e},n.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},n.setRect=function(e){this.rect=e},n.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},n.setOriginalSize=function(e){this.originalSize=e},n.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},n.setOffset=function(e){this.offset=e},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(e,t){void 0===t&&(t=!1);var n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(O(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height&&(O(3301,this.name+"/"+e.name,i,e.height),1))},n.destroy=function(){return this._packable&&IL&&IL.deleteAtlasSpriteFrame(this),e.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var e=this._rect,n=this.texture,i=n.width,r=n.height,o=this._capInsets[0],a=this._capInsets[2],s=e.width-o-a,c=this._capInsets[1],l=this._capInsets[3],u=e.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){NL[0].u=e.x/i,NL[1].u=(e.x+l)/i,NL[2].u=(e.x+l+u)/i,NL[3].u=(e.x+e.height)/i,NL[3].v=e.y/r,NL[2].v=(e.y+o)/r,NL[1].v=(e.y+o+s)/r,NL[0].v=(e.y+e.width)/r;for(var _=0;_<4;++_)for(var f=NL[_],d=0;d<4;++d){var p=NL[3-d];h.push({u:f.u,v:p.v})}}else{NL[0].u=e.x/i,NL[1].u=(e.x+o)/i,NL[2].u=(e.x+o+s)/i,NL[3].u=(e.x+e.width)/i,NL[3].v=e.y/r,NL[2].v=(e.y+c)/r,NL[1].v=(e.y+c+u)/r,NL[0].v=(e.y+e.height)/r;for(var m=0;m<4;++m)for(var v=NL[m],g=0;g<4;++g){var y=NL[g];h.push({u:y.u,v:v.v})}}this.emit(t.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var e=this._rect,t=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:e.x/r,s=0===r?1:(e.x+e.height)/r,c=0===o?0:e.y/o,l=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=s,t[1]=l,t[2]=s,t[3]=c,t[4]=a,t[5]=l,t[6]=a,t[7]=c):this._isFlipUVX?(t[0]=s,t[1]=c,t[2]=s,t[3]=l,t[4]=a,t[5]=c,t[6]=a,t[7]=l):this._isFlipUVY?(t[0]=a,t[1]=l,t[2]=a,t[3]=c,t[4]=s,t[5]=l,t[6]=s,t[7]=c):(t[0]=a,t[1]=c,t[2]=a,t[3]=l,t[4]=s,t[5]=c,t[6]=s,t[7]=l);var u=0===r?0:e.x/r,h=0===r?1:(e.x+e.height)/r,_=0===o?0:e.y/o,f=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVY?(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_):(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f)}else{var d=0===r?0:e.x/r,p=0===r?1:(e.x+e.width)/r,m=0===o?1:(e.y+e.height)/o,v=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=p,t[1]=v,t[2]=d,t[3]=v,t[4]=p,t[5]=m,t[6]=d,t[7]=m):this._isFlipUVX?(t[0]=p,t[1]=m,t[2]=d,t[3]=m,t[4]=p,t[5]=v,t[6]=d,t[7]=v):this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=p,t[3]=v,t[4]=d,t[5]=m,t[6]=p,t[7]=m):(t[0]=d,t[1]=m,t[2]=p,t[3]=m,t[4]=d,t[5]=v,t[6]=p,t[7]=v);var g=0===r?0:e.x/r,y=0===r?1:(e.x+e.width)/r,x=0===o?1:(e.y+e.height)/o,S=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVX?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVY?(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x):(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S)}var C=this.vertices;if(C){C.nu.length=0,C.nv.length=0;for(var A=0;A<C.u.length;A++)C.nu[A]=C.u[A]/r,C.nv[A]=C.v[A]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var e=IL;if(e){var t=this._texture;if(t instanceof uv&&!t.isCompressed){var n=this.width,i=this.height;!t.image||n>e.maxFrameSize||i>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(e){var t=e,n=t.rect;n&&(this._rect=new ii(n.x,n.y,n.width,n.height));var i=t.offset;t.offset&&(this._offset=new Yn(i.x,i.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new ti(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable;var o=t.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var e,n,i,r,o,a,s,c,l=new t,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(e=u.nu)||void 0===e?void 0:e.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(e){this._texture=e;var t=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(n.rect=new ii(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new ti(t.width,t.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new uv;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},J(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?e!==this._texture&&this.reset({texture:e},!0):R(3122,this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}}]),t}(Iu),EL.EVENT_UV_UPDATED="uv_updated",TL=wL))||TL);l.SpriteFrame=BL;var ML,LL=e("SpriteAtlas",Ac("cc.SpriteAtlas")((OL=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"spriteFrames",DL,re(t)),t}Z(t,e);var n=t.prototype;return n.getTexture=function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null},n.getSpriteFrame=function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null},n.getSpriteFrames=function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e},n._serialize=function(){},n._deserialize=function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=we();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1],$e(BL))},t}(Iu),DL=ce((RL=OL).prototype,"spriteFrames",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return we()}}),PL=RL))||PL);l.SpriteAtlas=LL;var FL,zL,VL,GL,UL=e("Font",Ac("cc.Font")(ML=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(Iu))||ML);l.Font=UL;var kL,HL,jL,WL,qL,XL,YL,KL,JL,QL=e("TTFFont",Ac("cc.TTFFont")((GL=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_fontFamily",VL,re(t)),t}return Z(t,e),t.prototype.initDefault=function(t){this._fontFamily="Arial",e.prototype.initDefault.call(this,t)},J(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:mu(this._native),__isNative__:!0}}}]),t}(UL),VL=ce((zL=GL).prototype,"_fontFamily",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ce(zL.prototype,"_nativeAsset",[sl,rl],Object.getOwnPropertyDescriptor(zL.prototype,"_nativeAsset"),zL.prototype),ce(zL.prototype,"_nativeDep",[sl],Object.getOwnPropertyDescriptor(zL.prototype,"_nativeDep"),zL.prototype),FL=zL))||FL);l.TTFFont=QL;var ZL,$L=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},eF=function(){function e(e){this.letterDefinitions={},this.texture=e}var t=e.prototype;return t.addLetterDefinitions=function(e,t){this.letterDefinitions[e]=t},t.cloneLetterDefinition=function(){for(var e={},t=0,n=Object.keys(this.letterDefinitions);t<n.length;t++){var i=n[t],r=new $L;ze(r,this.letterDefinitions[i]),e[i]=r}return e},t.getTexture=function(){return this.texture},t.getLetter=function(e){return this.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null},t.clear=function(){this.letterDefinitions={}},e}(),tF=e("BitmapFont",(kL=Ac("cc.BitmapFont"),HL=ol(BL),kL((JL=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"fntDataStr",qL,re(t)),se(t,"spriteFrame",XL,re(t)),se(t,"fontSize",YL,re(t)),se(t,"fntConfig",KL,re(t)),t}return Z(t,e),t.prototype.onLoaded=function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new eF(e.texture));var t=this.fntConfig;if(t){var n=t.fontDefDictionary;for(var i in n){var r=new $L,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else x("The fnt config is not exists!")},t}(UL),qL=ce((WL=JL).prototype,"fntDataStr",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),XL=ce(WL.prototype,"spriteFrame",[HL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YL=ce(WL.prototype,"fontSize",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),KL=ce(WL.prototype,"fntConfig",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jL=WL))||jL));l.BitmapFont=tF;var nF=e("LabelAtlas",Ac("cc.LabelAtlas")(ZL=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(tF))||ZL);l.LabelAtlas=nF;var iF=e("BASELINE_RATIO",.26),rF=e("MIDDLE_RATIO",(iF+1)/2-iF);var oF=new et(2);oF.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var aF,sF=new(function(){function e(e){this.count=0,this.limit=0,this.datas={},this.limit=e}var t=e.prototype;return t.moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},t.put=function(e,t){var n=oF.get();if(n.key=e,n.value=t,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,oF.put(i)}this.moveToHead(n)},t.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},t.get=function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null},t.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},t.has=function(e){return!!this.datas[e]},t.delete=function(e){var t=this.datas[e];this.remove(t)},e}())(100),cF=/([a-zA-Z0-9--]+|\S)/,lF=/^[!,.:;'}\]%\?>]/,uF=/([a-zA-Z0-9--iI]+|\S)$/,hF=/[a-zA-Z0-9--iI]+$/,_F=/^[a-zA-Z0-9--iI]/;function fF(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function dF(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function pF(e,t,n){var i=(n||e.font)+""+t,r=sF.get(i);if(null!==r)return r;var o=e.measureText(t),a=o&&o.width||0;return sF.put(i,a),a}function mF(e,t,n){var i=t,r=n,o=e[t];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==t){var a=e[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return e.substring(i,r)}function vF(e){return _F.exec(e)}function gF(e){return hF.exec(e)}function yF(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;for(var o=e;t>n&&o.length>1;){for(var a=o.length*(n/t)|0,s=mF(o,a),c=t-i(s),l=s,u=0,h=0;c>n&&h++<100;)a*=n/c,c=t-i(s=mF(o,a|=0));for(h=0;s&&c<=n&&h++<100;){var _=cF.exec(s);l=s,c=t-i(s=mF(o,a+=u=_?_[0].length:1))}0==(a-=u)?(a=1,l=mF(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=mF(o,2));var f=mF(o,0,a),d=void 0;lF.test(l||s)&&(0==(a-=(d=uF.exec(f))?d[0].length:0)&&(a=1),l=mF(o,a),f=mF(o,0,a)),_F.test(l)&&(d=hF.exec(f))&&f!==d[0]&&(l=mF(o,a-=d[0].length),f=mF(o,0,a)),(0===r.length||(f=f.trim()).length>0)&&r.push(f),t=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var xF=e("CanvasPool",function(){function e(){this.pool=[]}e.getInstance=function(){return aF||(aF=new e),aF};var t=e.prototype;return t.get=function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),n=t.getContext("2d");e={canvas:t,context:n}}return e},t.put=function(e){this.pool.length>=lt.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)},e}()),SF=wn.WHITE.clone(),CF=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},AF="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",bF=function(){function e(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}var t=e.prototype;return t.updateRenderData=function(){this._updateProperties(),this._updateTexture()},t.destroy=function(){this.image=null},t._updateProperties=function(){if(this.data=xF.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=pF(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+iF)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*iF/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Um),this.image.reset(this.canvas)},t._updateTexture=function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,n=this.canvas.width,i=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,n,i),e.fillStyle=AF,e.fillRect(0,0,n,i),e.font=t.fontDesc;var r=t.fontSize,o=n/2,a=i/2+r*rF+0*r,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",t.isOutlined){var c=t.out||SF;e.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",e.lineWidth=2*t.margin,e.strokeText(this.char,o,a)}e.fillText(this.char,o,a)}},e}(),TF=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=gm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new lr;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(uv),EF=function(){function e(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new TF;n.initWithSize(e,t),this.fontDefDictionary=new eF(n),this._halfBleed=1,this._width=e,this._height=t,$O.on(ZO.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var t=e.prototype;return t.insertLetterTexture=function(e){var t=e.image,n=$O.root.device;if(!t||!this.fontDefDictionary||!n)return null;var i=t.width,r=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return R(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var o=new CF;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=e.width-2,o.h=e.height-2,o.xAdvance=o.w,o.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,o),o},t.update=function(){this._dirty&&(this._dirty=!1)},t.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},t.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},t.getTexture=function(){return this.fontDefDictionary.getTexture()},t.beforeSceneLoad=function(){this.clearAllCache()},t.clearAllCache=function(){this.destroy();var e=new TF;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e},t.getLetter=function(e){return this.fontDefDictionary.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e,t){var n=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new bF(e,t);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},J(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(),wF={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:wn.WHITE.clone(),isOutlined:!1,out:wn.WHITE.clone(),margin:0},IF=[new Or($i.ATTR_POSITION,fi.RGB32F)],PF=[new Or($i.ATTR_POSITION,fi.RGB32F),new Or($i.ATTR_COLOR,fi.RGBA32F)],RF=[new Or($i.ATTR_POSITION,fi.RGB32F),new Or($i.ATTR_TEX_COORD,fi.RG32F),new Or($i.ATTR_COLOR,fi.RGBA32F)],DF=[new Or($i.ATTR_POSITION,fi.RGB32F),new Or($i.ATTR_TEX_COORD,fi.RG32F),new Or($i.ATTR_COLOR,fi.RGBA32F),new Or($i.ATTR_COLOR2,fi.RGBA32F)];function OF(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=no[i.format].count}return t}function NF(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=no[i.format].size}return t}l.internal.vfmtPosUvColor=RF,l.internal.vfmtPosUvTwoColor=DF,e("UIVertexFormat",Object.freeze({__proto__:null,vfmt:IF,vfmtPosColor:PF,vfmtPosUvColor:RF,vfmtPosUvTwoColor:DF,getComponentPerVertex:OF,getAttributeStride:NF}));var BF,MF,LF,FF,zF,VF,GF,UF,kF,HF,jF,WF,qF,XF,YF,KF=NF(RF)>>2,JF=new Hl((function(){return{x:0,y:0,z:0,u:0,v:0,color:wn.WHITE.clone()}}),128),QF=null,ZF=e("BaseRenderData",function(){function e(e){void 0===e&&(e=RF),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=RF,this._floatStride=e===RF?KF:NF(e)>>2,this._vertexFormat=e}return e.prototype.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},J(e,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),e}()),$F=e("RenderData",function(e){function t(t,n){var i;return void 0===t&&(t=RF),(i=e.call(this,t)||this).indices=null,i.vertDirty=!0,i.frame=void 0,i.layer=0,i.blendHash=-1,i.textureHash=0,i.nodeDirty=!0,i.passDirty=!0,i.textureDirty=!0,i.hashDirty=!0,i._data=[],i._pivotX=0,i._pivotY=0,i._width=0,i._height=0,i._accessor=null,n||(n=$O.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i}Z(t,e),t.add=function(e,n){void 0===e&&(e=RF),QF||(QF=new jl((function(){return new t}),32));var i=QF.add();return i._floatStride=e===RF?KF:NF(e)>>2,i._vertexFormat=e,n||(n=$O.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i},t.remove=function(e){var t=QF.data.indexOf(e);-1!==t&&(e.clear(),e._accessor=null,QF.removeAt(t))};var n=t.prototype;return n.resize=function(e,t){e===this._vc&&t===this._ic&&this.chunk||(this._vc=e,this._ic=t,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(e,t),this.updateHash())},n.resizeAndCopy=function(e,t){if(e!==this._vc||t!==this._ic||!this.chunk){this._vc=e,this._ic=t;var n=this.chunk;this.chunk=this._accessor.allocateChunk(e,t),n&&(this.chunk.vb.set(n.vb),this._accessor.recycleChunk(n)),this.updateHash()}},n.getMeshBuffer=function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null},n.updateNode=function(e){this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(e){this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var e=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=So(e,666),this.hashDirty=!1},n.updateRenderData=function(e,t){if(this.passDirty&&(this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=e.node.scene?e._getRenderScene():null;this.layer=e.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},J(t,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)JF.free(t[i]);for(i=n;i<e;i++)t[i]=JF.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),t}(ZF)),ez=e("MeshRenderData",function(e){function t(t){var n;return void 0===t&&(t=RF),(n=e.call(this,t)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}Z(t,e),t.add=function(e){void 0===e&&(e=RF);var t=tz.add();return t._floatStride=e===RF?KF:NF(e)>>2,t._vertexFormat=e,t},t.remove=function(e){var t=tz.data.indexOf(e);-1!==t&&(tz.data[t].clear(),tz.removeAt(t))};var n=t.prototype;return n.request=function(e,t){var n=this._byteLength+e*this.stride;return!!this.reserve(e,t)&&(this._vc+=e,this._ic+=t,this._byteLength=n,this.vertexRange=this._vc,this.indexRange=this._ic,!0)},n.reserve=function(e,t){var n=this._byteLength+e*this.stride,i=this.indexCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.resize=function(e,t){var n=e*this.stride;e>=0&&t>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=e,this._ic=t,this._byteLength=n,this.updateRange(0,e,0,t)},n.updateRange=function(e,t,n,i){t>=0&&i>=0&&t<=this._vc&&this._ic,this.vertexStart=e,this.indexStart=n,this.vertexRange=t,this.indexRange=i},n.requestIA=function(e){this._initIAInfo(e);var t=this._iaPool.add();return t.firstIndex=this.indexStart,t.indexCount=this.indexRange,t},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var e=this._ic,t=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,e),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(t);var r=e<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(e){var t=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=e.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,r,r))),this._iaInfo=new Br(this._vertexFormat,i,this._indexBuffer),this._iaPool=new jl((function(){return e.createInputAssembler(t._iaInfo)}),1,(function(e){e.destroy()}))}},n._reallocBuffer=function(e,t){var n=this.vData;this.vData=new Float32Array(e),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(t),i&&this.iData.set(i,0)},J(t,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),t}(ZF)),tz=new jl((function(){return new ez}),32),nz=new Yn,iz=new Yn,rz=new Pn,oz=new jn,az=new jn,sz=new jn,cz=new jn(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),lz=new ii,uz=function(t){return e({UITransform:t,UITransformComponent:t}),t}((BF=Ac("cc.UITransform"),MF=Uc(),LF=Tc(110),FF=Fc(),zF=Zc(),VF=qc(),GF=Zc(),UF=qc(),BF(kF=MF(kF=LF(kF=FF(kF=Ec(kF=Lc((XF=qF=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._priority=0,se(t,"_contentSize",jF,re(t)),se(t,"_anchorPoint",WF,re(t)),t}Z(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&t.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(eb.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(eb.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(e,t){var n=this._contentSize;if(void 0===t){if(sn((e=e).width,n.width,on)&&sn(e.height,n.height,on))return;n.width=e.width,n.height=e.height}else{if(sn(e=e,n.width,on)&&sn(t,n.height,on))return;n.width=e,n.height=t}this.node.emit(eb.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(eb.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(e){for(var t=this._contentSize.width,n=this._contentSize.height,i=nz,r=iz,o=this._getRenderScene().cameras,a=0;a<o.length;a++){var s=o[a];if(s.visibility&this.node.layer){s.node.getWorldRT(oz);var c=oz.m12,l=oz.m13,u=nN.center;if(oz.m12=u.x-(oz.m00*c+oz.m04*l),oz.m13=u.y-(oz.m01*c+oz.m05*l),jn.invert(oz,oz),Yn.transformMat4(i,e,oz),this.node.getWorldMatrix(sz),jn.invert(oz,sz),!jn.strictEquals(oz,cz)){Yn.transformMat4(r,i,oz),r.x+=this._anchorPoint.x*t,r.y+=this._anchorPoint.y*n;var h=!1;if(r.x>=0&&r.y>=0&&r.x<=t&&r.y<=n&&(h=this._maskTest(i)),h)return!0}}}return!1},n.hitTest=function(e){for(var t=this._contentSize.width,n=this._contentSize.height,i=rz,r=nz,o=iz,a=this._getRenderScene().cameras,s=0;s<a.length;s++){var c=a[s];if(c.visibility&this.node.layer&&(Pn.set(i,e.x,e.y,0),c.screenToWorld(i,i),Yn.set(r,i.x,i.y),this.node.getWorldMatrix(sz),jn.invert(oz,sz),!jn.strictEquals(oz,cz))){Yn.transformMat4(o,r,oz),o.x+=this._anchorPoint.x*t,o.y+=this._anchorPoint.y*n;var l=!1;if(o.x>=0&&o.y>=0&&o.x<=t&&o.y<=n&&(l=this._maskTest(r)),l)return!0}}return!1},n._maskTest=function(e){var t,n,i=null===(t=this.node)||void 0===t||null===(n=t.eventProcessor)||void 0===n?void 0:n.maskList;if(i)for(var r=this.node,o=i.length,a=0,s=0;r&&s<o;++a,r=r.parent){var c=i[s];if(a===c.index){if(r!==c.comp.node){i.length=s;break}var l=c.comp;if(l&&l._enabled&&!l.isHit(e))return!1;s++}else if(a>c.index){i.length=s;break}}return!0},n.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(sz),jn.invert(oz,sz),t||(t=new Pn),Pn.transformMat4(t,e,oz)},n.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(sz),t||(t=new Pn),Pn.transformMat4(t,e,sz)},n.getBoundingBox=function(){jn.fromRTS(az,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new ii(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(az),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(sz),this.getBoundingBoxTo(sz)):this.getBoundingBox()},n.getBoundingBoxTo=function(e){jn.fromRTS(az,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new ii(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(jn.multiply(sz,e,az),r.transformMat4(sz),!this.node.children)return r;for(var o,a=ae(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(t);if(c){var l=c.getBoundingBoxTo(e);l&&ii.union(r,r,l)}}}return r},n.getComputeAABB=function(e){var t=this._contentSize.width,n=this._contentSize.height;lz.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),lz.transformMat4(this.node.worldMatrix);var i=lz.x+.5*lz.width,r=lz.y+.5*lz.height,o=this.node.worldPosition.z,a=lz.width/2,s=lz.height/2;return null!=e?(Ys.set(e,i,r,o,a,s,.001),e):new Ys(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var e=this.node._uiProps.uiComp;e&&(e.markForUpdateRenderData(),e.renderData&&(e.renderData.vertDirty=!0))},t.insertChangeMap=function(e){var n=e.uuid;t.priorityChangeNodeMap.has(n)||t.priorityChangeNodeMap.set(n,e)},t._sortChildrenSibling=function(e){var t=e.children;t&&t.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))},t._sortSiblings=function(){t.priorityChangeNodeMap.forEach((function(e){t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()},t._cleanChangeMap=function(){t.priorityChangeNodeMap.clear()},J(t,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(eb.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(eb.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(eb.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(eb.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(eb.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(eb.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?R(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=$O.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=$O.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}}]),t}(Ku),qF.EventType=eb,qF.priorityChangeNodeMap=new Map,ce((HF=XF).prototype,"contentSize",[zF,VF],Object.getOwnPropertyDescriptor(HF.prototype,"contentSize"),HF.prototype),ce(HF.prototype,"anchorPoint",[GF,UF],Object.getOwnPropertyDescriptor(HF.prototype,"anchorPoint"),HF.prototype),jF=ce(HF.prototype,"_contentSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(100,100)}}),WF=ce(HF.prototype,"_anchorPoint",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn(.5,.5)}}),kF=HF))||kF)||kF)||kF)||kF)||kF)||kF));$O.on(ZO.EVENT_AFTER_UPDATE,uz._sortSiblings),$O.on(ZO.EVENT_BEFORE_SCENE_LAUNCH,uz._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(YF||(YF={}));var hz,_z,fz,dz,pz,mz,vz,gz,yz,xz,Sz,Cz,Az,bz,Tz,Ez,wz,Iz,Pz,Rz,Dz=e("StencilManager",function(){function e(){this.stage=YF.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Ii.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Pi.KEEP,zFailOp:Pi.KEEP,passOp:Pi.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var t=e.prototype;return t.pushMask=function(e){this._maskStack.push(e)},t.clear=function(e){e.stencilStage=e.inverted?YF.CLEAR_INVERTED:YF.CLEAR},t.enterLevel=function(e){e.graphics.stencilStage=e.inverted?YF.ENTER_LEVEL_INVERTED:YF.ENTER_LEVEL},t.enableMask=function(){this.stage=YF.ENABLED},t.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=YF.DISABLED:this.stage=YF.ENABLED)},t.getWriteMask=function(){return 1<<this._maskStack.length-1},t.getExitWriteMask=function(){return 1<<this._maskStack.length},t.getStencilRef=function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e},t.reset=function(){this._maskStack.length=0,this.stage=YF.DISABLED},t.destroy=function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()},t.getStencilStage=function(e,t){var n=0,i=!1,r=!1,o=Ii.LESS,a=this.stencilStateMap;if(t&&t.passes[0]){var s=t.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|e<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=e<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(e);var u=new wo(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},t.getStencilHash=function(e){return e<<8|this._maskStack.length},t.setStateFromStage=function(e){var t=this._stencilPattern;e===YF.DISABLED?(t.stencilTest=!1,t.func=Ii.ALWAYS,t.failOp=Pi.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===YF.ENABLED?(t.func=Ii.EQUAL,t.failOp=Pi.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===YF.CLEAR?(t.func=Ii.NEVER,t.failOp=Pi.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===YF.CLEAR_INVERTED||e===YF.ENTER_LEVEL?(t.func=Ii.NEVER,t.failOp=Pi.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===YF.ENTER_LEVEL_INVERTED&&(t.func=Ii.NEVER,t.failOp=Pi.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))},J(e,[{key:"pattern",get:function(){return this._stencilPattern}}]),e}());Dz.sharedManager=null,Dz.sharedManager=new Dz,st(Ri),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(Rz||(Rz=e("InstanceMaterialType",{})));var Oz,Nz,Bz,Mz,Lz,Fz,zz,Vz,Gz,Uz,kz,Hz,jz,Wz,qz,Xz,Yz,Kz,Jz,Qz,Zz,$z,eV,tV,nV,iV,rV,oV,aV,sV,cV,lV,uV,hV,_V,fV,dV,pV,mV,vV,gV,yV,xV,SV,CV,AV,bV,TV,EV,wV,IV,PV,RV,DV,OV,NV,BV,MV,LV,FV,zV,VV,GV,UV,kV,HV,jV,WV,qV,XV,YV=function(t){return e({Renderable2D:t,RenderComponent:t,UIRenderable:t}),t}((hz=Ac("cc.Renderable2D"),_z=bc(uz),fz=Hc(),dz=ol(Kv),pz=ol(Kv),mz=Zc(),vz=qc(),gz=Wc(),yz=Zc(),xz=qc(),hz(Sz=_z(Sz=Ec(Sz=Lc((Pz=Iz=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_materials",Az,re(t)),se(t,"_customMaterial",bz,re(t)),t.stencilStage=YF.DISABLED,se(t,"_srcBlendFactor",Tz,re(t)),se(t,"_dstBlendFactor",Ez,re(t)),se(t,"_color",wz,re(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._delegateSrc=null,t._instanceMaterialType=-1,t._blendState=new Po,t._blendHash=0,t._useVertexOpacity=!1,t._lastParent=null,t}Z(t,e);var n=t.prototype;return n.updateBlendHash=function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(eb.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(eb.SIZE_CHANGED,this._nodeStateChange,this),this.node.on(eb.PARENT_CHANGED,this._colorDirty,this),this.updateMaterial(),this._renderFlag=this._canRender(),this._colorDirty()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(eb.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(eb.SIZE_CHANGED,this._nodeStateChange,this),this.node.off(eb.PARENT_CHANGED,this._colorDirty,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++){var t=this._materialInstances[e];t&&t.destroy()}this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(e){if(void 0===e&&(e=!0),this._renderFlag=this._canRender(),e){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else this._renderDataFlag=e},n.requestRenderData=function(){var e=$F.add();return this._renderData=e,e},n.destroyRenderData=function(){this._renderData&&($F.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(e){this._renderDataFlag&&(this._assembler.updateRenderData(this,e),this._renderDataFlag=!1),this._renderFlag&&this._render(e)},n.postUpdateAssembler=function(e){this._postAssembler&&this._renderFlag&&this._postRender(e)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._renderData&&(this._renderData.material=e,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var e=this._blendState.targets[0];e||(e=new Io,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=Ri.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var n=this.node.children[e].getComponent(t);n&&n.markForUpdateRenderData()}},n._colorDirty=function(){this.node._uiProps.colorDirty=!0},n._onMaterialModified=function(t,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),e.prototype._onMaterialModified.call(this,t,n)},n._updateBuiltinMaterial=function(){var e;switch(this._instanceMaterialType){case Rz.ADD_COLOR:e=yv.get("ui-base-material");break;case Rz.GRAYSCALE:e=yv.get("ui-sprite-gray-material");break;case Rz.USE_ALPHA_SEPARATED:e=yv.get("ui-sprite-alpha-sep-material");break;case Rz.USE_ALPHA_SEPARATED_AND_GRAY:e=yv.get("ui-sprite-gray-alpha-sep-material");break;default:e=yv.get("ui-sprite-material")}return e},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},J(t,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"color",get:function(){return this._color},set:function(e){this._color.equals(e)||(this._color.set(e),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}},{key:"useVertexOpacity",get:function(){return this._useVertexOpacity}}]),t}(vL),Iz.BlendState=Ri,Iz.Assembler=null,Iz.PostAssembler=null,Az=ce((Cz=Pz).prototype,"_materials",[sl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ce(Cz.prototype,"sharedMaterials",[sl,fz],Object.getOwnPropertyDescriptor(Cz.prototype,"sharedMaterials"),Cz.prototype),bz=ce(Cz.prototype,"_customMaterial",[dz],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ce(Cz.prototype,"customMaterial",[pz,mz,vz,gz,el],Object.getOwnPropertyDescriptor(Cz.prototype,"customMaterial"),Cz.prototype),ce(Cz.prototype,"color",[yz,xz],Object.getOwnPropertyDescriptor(Cz.prototype,"color"),Cz.prototype),Tz=ce(Cz.prototype,"_srcBlendFactor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.SRC_ALPHA}}),Ez=ce(Cz.prototype,"_dstBlendFactor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.ONE_MINUS_SRC_ALPHA}}),wz=ce(Cz.prototype,"_color",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wn.WHITE.clone()}}),Sz=Cz))||Sz)||Sz)||Sz)||Sz));l.internal.Renderable2D=YV,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(jV||(jV=e("HorizontalTextAlignment",{}))),st(jV),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(WV||(WV=e("VerticalTextAlignment",{}))),st(WV),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(qV||(qV=e("Overflow",{}))),st(qV),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(XV||(XV=e("CacheMode",{}))),st(XV);var KV,JV,QV,ZV=function(t){return e({Label:t,LabelComponent:t}),t}((Oz=Ac("cc.Label"),Nz=Uc(),Bz=Tc(110),Mz=Fc(),Lz=Zc(),Fz=qc(),zz=ol(jV),Vz=Zc(),Gz=qc(),Uz=ol(WV),kz=Zc(),Hz=qc(),jz=Zc(),Wz=qc(),qz=Zc(),Xz=Hc(),Yz=qc(),Kz=Zc(),Jz=qc(),Qz=Hc(),Zz=Zc(),$z=qc(),eV=ol(qV),tV=Zc(),nV=qc(),iV=Zc(),rV=qc(),oV=ol(UL),aV=Zc(),sV=Hc(),cV=qc(),lV=Zc(),uV=qc(),hV=ol(XV),_V=Zc(),fV=qc(),dV=Zc(),pV=qc(),mV=Zc(),vV=qc(),gV=Zc(),yV=qc(),xV=Hc(),SV=Zc(),CV=qc(),Oz(AV=Nz(AV=Bz(AV=Mz((HV=kV=function(e){function t(){var t;return se(t=e.call(this)||this,"_string",TV,re(t)),se(t,"_horizontalAlign",EV,re(t)),se(t,"_verticalAlign",wV,re(t)),se(t,"_actualFontSize",IV,re(t)),se(t,"_fontSize",PV,re(t)),se(t,"_fontFamily",RV,re(t)),se(t,"_lineHeight",DV,re(t)),se(t,"_overflow",OV,re(t)),se(t,"_enableWrapText",NV,re(t)),se(t,"_font",BV,re(t)),se(t,"_isSystemFontUsed",MV,re(t)),se(t,"_spacingX",LV,re(t)),se(t,"_isItalic",FV,re(t)),se(t,"_isBold",zV,re(t)),se(t,"_isUnderline",VV,re(t)),se(t,"_underlineHeight",GV,re(t)),se(t,"_cacheMode",UV,re(t)),t._N$file=null,t._texture=null,t._ttfSpriteFrame=null,t._userDefinedFont=null,t._assemblerData=null,t._fontAtlas=null,t._letterTexture=null,t._ttfSpriteFrame=null,t}Z(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var t=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),t){var n=t;n.image&&n.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,e.prototype.onDestroy.call(this)},n.updateRenderData=function(e){void 0===e&&(e=!1),this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){e.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!e.prototype._canRender.call(this)||!this._string)return!1;var t=this._font;if(t&&t instanceof tF){var n=t.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof tF){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===XV.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new BL,this._assemblerData=this._assembler.getAssemblerData();var n=new Um(this._assemblerData.canvas),i=new uv;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==XV.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var e=!1;if(this.cacheMode!==XV.CHAR){var t=this._texture.texture;if(t instanceof Vm){var n=t.getPixelFormat();e=n===gm.RGBA_ETC1||n===gm.RGB_A_PVRTC_4BPPV1||n===gm.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?Rz.USE_ALPHA_SEPARATED:Rz.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},n._updateBlendFunc=function(){e.prototype._updateBlendFunc.call(this)},J(t,[{key:"string",get:function(){return this._string},set:function(e){e=null==e?"":e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==XV.BITMAP||this._font instanceof tF||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===XV.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof tF?this._font.fontSize:-1}}]),t}(YV),kV.HorizontalAlign=jV,kV.VerticalAlign=WV,kV.Overflow=qV,kV.CacheMode=XV,kV._canvasPool=xF.getInstance(),ce((bV=HV).prototype,"string",[Lz,Fz,$c],Object.getOwnPropertyDescriptor(bV.prototype,"string"),bV.prototype),ce(bV.prototype,"horizontalAlign",[zz,Vz,Gz],Object.getOwnPropertyDescriptor(bV.prototype,"horizontalAlign"),bV.prototype),ce(bV.prototype,"verticalAlign",[Uz,kz,Hz],Object.getOwnPropertyDescriptor(bV.prototype,"verticalAlign"),bV.prototype),ce(bV.prototype,"fontSize",[jz,Wz],Object.getOwnPropertyDescriptor(bV.prototype,"fontSize"),bV.prototype),ce(bV.prototype,"fontFamily",[qz,Xz,Yz],Object.getOwnPropertyDescriptor(bV.prototype,"fontFamily"),bV.prototype),ce(bV.prototype,"lineHeight",[Kz,Jz],Object.getOwnPropertyDescriptor(bV.prototype,"lineHeight"),bV.prototype),ce(bV.prototype,"spacingX",[Qz,Zz,$z],Object.getOwnPropertyDescriptor(bV.prototype,"spacingX"),bV.prototype),ce(bV.prototype,"overflow",[eV,tV,nV],Object.getOwnPropertyDescriptor(bV.prototype,"overflow"),bV.prototype),ce(bV.prototype,"enableWrapText",[iV,rV],Object.getOwnPropertyDescriptor(bV.prototype,"enableWrapText"),bV.prototype),ce(bV.prototype,"font",[oV,aV,sV,cV],Object.getOwnPropertyDescriptor(bV.prototype,"font"),bV.prototype),ce(bV.prototype,"useSystemFont",[lV,uV],Object.getOwnPropertyDescriptor(bV.prototype,"useSystemFont"),bV.prototype),ce(bV.prototype,"cacheMode",[hV,_V,fV],Object.getOwnPropertyDescriptor(bV.prototype,"cacheMode"),bV.prototype),ce(bV.prototype,"isBold",[dV,pV],Object.getOwnPropertyDescriptor(bV.prototype,"isBold"),bV.prototype),ce(bV.prototype,"isItalic",[mV,vV],Object.getOwnPropertyDescriptor(bV.prototype,"isItalic"),bV.prototype),ce(bV.prototype,"isUnderline",[gV,yV],Object.getOwnPropertyDescriptor(bV.prototype,"isUnderline"),bV.prototype),ce(bV.prototype,"underlineHeight",[xV,kc,SV,CV],Object.getOwnPropertyDescriptor(bV.prototype,"underlineHeight"),bV.prototype),TV=ce(bV.prototype,"_string",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),EV=ce(bV.prototype,"_horizontalAlign",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jV.CENTER}}),wV=ce(bV.prototype,"_verticalAlign",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WV.CENTER}}),IV=ce(bV.prototype,"_actualFontSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PV=ce(bV.prototype,"_fontSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),RV=ce(bV.prototype,"_fontFamily",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),DV=ce(bV.prototype,"_lineHeight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),OV=ce(bV.prototype,"_overflow",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qV.NONE}}),NV=ce(bV.prototype,"_enableWrapText",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),BV=ce(bV.prototype,"_font",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MV=ce(bV.prototype,"_isSystemFontUsed",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),LV=ce(bV.prototype,"_spacingX",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FV=ce(bV.prototype,"_isItalic",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zV=ce(bV.prototype,"_isBold",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),VV=ce(bV.prototype,"_isUnderline",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GV=ce(bV.prototype,"_underlineHeight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),UV=ce(bV.prototype,"_cacheMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XV.NONE}}),AV=bV))||AV)||AV)||AV)||AV));l.Label=ZV,function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(KV||(KV={})),st(KV),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(JV||(JV={})),st(JV),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(QV||(QV={})),st(QV);var $V=Math.PI,eG=Math.min,tG=Math.max,nG=Math.cos,iG=Math.sin,rG=Math.abs,oG=Math.sign,aG=.5522847493;function sG(e,t,n,i,r){e.moveTo(t-i,n),e.bezierCurveTo(t-i,n+r*aG,t-i*aG,n+r,t,n+r),e.bezierCurveTo(t+i*aG,n+r,t+i,n+r*aG,t+i,n),e.bezierCurveTo(t+i,n-r*aG,t+i*aG,n-r,t,n-r),e.bezierCurveTo(t-i*aG,n-r,t-i,n-r*aG,t-i,n),e.close()}function cG(e,t,n,i,r,o,a,s,c,l,u){var h,_,f,d,p,m,v,g,y,x,S,C,A,b,T,E;l>10||(p=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(t+i))+(f=.5*(i+o))),g=.5*((_=.5*(n+r))+(d=.5*(r+a))),((T=rG((i-s)*(b=c-n)-(r-c)*(A=s-t)))+(E=rG((o-s)*b-(a-c)*A)))*(T+E)<e.tessTol*(A*A+b*b)?e.addPoint(s,c,0===u?u|QV.PT_BEVEL:u):(cG(e,t,n,h,_,v,g,S=.5*(v+(y=.5*(f+p))),C=.5*(g+(x=.5*(d+m))),l+1,0),cG(e,S,C,y,x,p,m,s,c,l+1,u)))}var lG,uG,hG,_G,fG,dG,pG,mG,vG,gG,yG,xG,SG,CG,AG,bG,TG,EG,wG,IG,PG,RG,DG,OG,NG,BG,MG,LG,FG,zG,VG,GG,UG,kG,HG,jG,WG,qG,XG,YG,KG,JG,QG,ZG,$G,eU,tU,nU=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return Z(t,e),t.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},t}(Yn),iU=function(){function e(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return e.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},e}(),rU=function(){function e(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=wn.WHITE.clone(),this.lineCap=KV.BUTT,this.strokeColor=wn.BLACK.clone(),this.lineJoin=JV.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var t=e.prototype;return t.moveTo=function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,QV.PT_CORNER),this._commandX=e,this._commandY=t},t.lineTo=function(e,t){this.addPoint(e,t,QV.PT_CORNER),this._commandX=e,this._commandY=t},t.bezierCurveTo=function(e,t,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==e||s.y!==t||n!==r||i!==o?(cG(this,s.x,s.y,e,t,n,i,r,o,0,QV.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},t.quadraticCurveTo=function(e,t,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(e-r),o+2/3*(t-o),n+2/3*(e-n),i+2/3*(t-i),n,i)},t.arc=function(e,t,n,i,r,o){!function(e,t,n,i,r,o,a){var s,c,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0,g=0,y=0,x=0,S=0,C=0;if(u=o-r,a=a||!1)if(rG(u)>=2*$V)u=2*$V;else for(;u<0;)u+=2*$V;else if(rG(u)>=2*$V)u=2*-$V;else for(;u>0;)u-=2*$V;for(c=0|tG(1,eG(rG(u)/(.5*$V)+.5,5)),h=rG(4/3*(1-nG(s=u/c/2))/iG(s)),a||(h=-h),C=0;C<=c;C++)d=t+(_=nG(l=r+u*(C/c)))*i,p=n+(f=iG(l))*i,m=-f*i*h,v=_*i*h,0===C?e.moveTo(d,p):e.bezierCurveTo(g+x,y+S,d-m,p-v,d,p),g=d,y=p,x=m,S=v}(this,e,t,n,i,r,o)},t.ellipse=function(e,t,n,i){sG(this,e,t,n,i),this._curPath.complex=!1},t.circle=function(e,t,n){sG(this,e,t,n,n),this._curPath.complex=!1},t.rect=function(e,t,n,i){this.moveTo(e,t),this.lineTo(e+n,t),this.lineTo(e+n,t+i),this.lineTo(e,t+i),this.close(),this._curPath.complex=!1},t.roundRect=function(e,t,n,i,r){!function(e,t,n,i,r,o){if(o<.1)e.rect(t,n,i,r);else{var a=eG(o,.5*rG(i))*oG(i),s=eG(o,.5*rG(r))*oG(r);e.moveTo(t,n+s),e.lineTo(t,n+r-s),e.bezierCurveTo(t,n+r-s*(1-aG),t+a*(1-aG),n+r,t+a,n+r),e.lineTo(t+i-a,n+r),e.bezierCurveTo(t+i-a*(1-aG),n+r,t+i,n+r-s*(1-aG),t+i,n+r-s),e.lineTo(t+i,n+s),e.bezierCurveTo(t+i,n+s*(1-aG),t+i-a*(1-aG),n,t+i-a,n),e.lineTo(t+a,n),e.bezierCurveTo(t+a*(1-aG),n,t,n+s*(1-aG),t,n+s),e.close()}}(this,e,t,n,i,r),this._curPath.complex=!1},t.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,n=e.length;t<n;t++){var i=e[t];i&&ez.remove(i)}this._renderDataList.length=0},t.close=function(){this._curPath.closed=!0},t.requestRenderData=function(){var e=ez.add();return this._renderDataList.push(e),e},t.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},t.addPoint=function(e,t,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=e,a.y=t):(a=new nU(e,t),r.push(a)),a.flags=n,o.push(a)}},t._addPath=function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new iU,this.paths.push(t)),this.pathLength++,this._curPath=t,t},e}(),oU=PF.concat([new Or("a_dist",fi.R32F)]),aU=OF(oU),sU=NF(oU),cU=function(t){return e({Graphics:t,GraphicsComponent:t}),t}((lG=Ac("cc.Graphics"),uG=Uc(),hG=Tc(110),_G=Fc(),fG=qc(),dG=ol(JV),pG=qc(),mG=ol(KV),vG=qc(),gG=qc(),yG=qc(),xG=qc(),SG=Hc(),lG(CG=uG(CG=hG(CG=_G((DG=RG=function(e){function t(){var t;return(t=e.call(this)||this).impl=null,t.model=null,se(t,"_lineWidth",bG,re(t)),se(t,"_strokeColor",TG,re(t)),se(t,"_lineJoin",EG,re(t)),se(t,"_lineCap",wG,re(t)),se(t,"_fillColor",IG,re(t)),se(t,"_miterLimit",PG,re(t)),t._isDrawing=!1,t._isNeedUploadData=!0,t._graphicsUseSubMeshes=[],t._instanceMaterialType=Rz.ADD_COLOR,t.impl=new rU,t}Z(t,e);var n=t.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=$O.root.createModel(ny),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){this._sceneGetter=null,this.model&&($O.root.destroyModel(this.model),this.model=null);var t=this._graphicsUseSubMeshes.length;if(t>0){for(var n=0;n<t;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),e.prototype.onDestroy.call(this)},n.moveTo=function(e,t){this.impl&&this.impl.moveTo(e,t)},n.lineTo=function(e,t){this.impl&&this.impl.lineTo(e,t)},n.bezierCurveTo=function(e,t,n,i,r,o){this.impl&&this.impl.bezierCurveTo(e,t,n,i,r,o)},n.quadraticCurveTo=function(e,t,n,i){this.impl&&this.impl.quadraticCurveTo(e,t,n,i)},n.arc=function(e,t,n,i,r,o){this.impl&&this.impl.arc(e,t,n,i,r,o)},n.ellipse=function(e,t,n,i){this.impl&&this.impl.ellipse(e,t,n,i)},n.circle=function(e,t,n){this.impl&&this.impl.circle(e,t,n)},n.rect=function(e,t,n,i){this.impl&&this.impl.rect(e,t,n,i)},n.roundRect=function(e,t,n,i,r){this.impl&&this.impl.roundRect(e,t,n,i,r)},n.fillRect=function(e,t,n,i){this.rect(e,t,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=yv.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(e){if(this.model){if(this.model.subModels.length<=e){var t=l.director.root.device,n=t.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,65535*sU,sU)),i=t.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new QE([n],oU,Vi.TRIANGLE_LIST,i);r.subMeshIdx=0,this.model.initSubModel(e,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else R(4500,this.node.name)},n._uploadData=function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<t.length;i++){var r=t[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*aU);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);o.indexBuffer.update(s),o.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),n=this.model.subModels.length;if(t.length>n)for(var i=n;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)},n._canRender=function(){return!!e.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},J(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),t}(YV),RG.LineJoin=JV,RG.LineCap=KV,ce((AG=DG).prototype,"lineWidth",[kc,fG],Object.getOwnPropertyDescriptor(AG.prototype,"lineWidth"),AG.prototype),ce(AG.prototype,"lineJoin",[dG,pG],Object.getOwnPropertyDescriptor(AG.prototype,"lineJoin"),AG.prototype),ce(AG.prototype,"lineCap",[mG,vG],Object.getOwnPropertyDescriptor(AG.prototype,"lineCap"),AG.prototype),ce(AG.prototype,"strokeColor",[gG],Object.getOwnPropertyDescriptor(AG.prototype,"strokeColor"),AG.prototype),ce(AG.prototype,"fillColor",[yG],Object.getOwnPropertyDescriptor(AG.prototype,"fillColor"),AG.prototype),ce(AG.prototype,"miterLimit",[xG],Object.getOwnPropertyDescriptor(AG.prototype,"miterLimit"),AG.prototype),ce(AG.prototype,"color",[sl,SG],Object.getOwnPropertyDescriptor(AG.prototype,"color"),AG.prototype),bG=ce(AG.prototype,"_lineWidth",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),TG=ce(AG.prototype,"_strokeColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wn.BLACK.clone()}}),EG=ce(AG.prototype,"_lineJoin",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return JV.MITER}}),wG=ce(AG.prototype,"_lineCap",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KV.BUTT}}),IG=ce(AG.prototype,"_fillColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wn.WHITE.clone()}}),PG=ce(AG.prototype,"_miterLimit",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),CG=AG))||CG)||CG)||CG)||CG));l.Graphics=cU;var lU,uU=new jn,hU=new Yn,_U=new jn,fU=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(lU||(lU={})),st(lU);var dU=function(t){return e({Mask:t,MaskComponent:t}),t}((OG=Ac("cc.Mask"),NG=Uc(),BG=Tc(110),MG=Fc(),LG=ol(lU),FG=qc(),zG=Zc(),VG=qc(),GG=Hc(),UG=ol(BL),kG=Hc(),HG=Hc(),jG=Xc(),WG=Hc(),qG=Hc(),OG(XG=NG(XG=BG(XG=MG((tU=eU=function(e){function t(){var t;return(t=e.call(this)||this)._clearStencilMtl=null,t._clearModel=null,se(t,"_type",KG,re(t)),se(t,"_inverted",JG,re(t)),se(t,"_segments",QG,re(t)),se(t,"_spriteFrame",ZG,re(t)),se(t,"_alphaThreshold",$G,re(t)),t._graphics=null,t._clearModelMesh=null,t._instanceMaterialType=Rz.ADD_COLOR,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),e.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){e.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){this._clearModel&&this._clearModelMesh&&($O.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),e.prototype.onDestroy.call(this)},n.isHit=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=n.width,r=n.height,o=hU;this.node.getWorldMatrix(uU),jn.invert(_U,uU),Yn.transformMat4(o,e,_U);var a=t.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===lU.RECT||this.type===lU.GRAPHICS_STENCIL||this.type===lU.IMAGE_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===lU.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(e){e.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(e){this._postAssembler&&e.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(t){e.prototype._nodeStateChange.call(this,t),this._updateGraphics()},n._canRender=function(){return!!e.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==lU.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var e=this._graphics=new cU;e._objFlags|=fl.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;var t=wn.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===lU.RECT||this._type===lU.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var n=e.contentSize,i=n.width,r=n.height,o=e.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===lU.RECT)t.rect(a,s,i,r);else if(this._type===lU.ELLIPSE){for(var c=function(e,t,n){fU.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)fU.push(new Pn(t.x*Math.cos(i*r)+e.x,t.y*Math.sin(i*r)+e.y,0));return fU}(new Pn(a+i/2,s+r/2,0),new Pn(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}},n._createClearModel=function(){if(!this._clearModel){var e=yv.get("default-clear-stencil");this._clearStencilMtl=new oy({parent:e,owner:this,subModelIdx:0}),this._clearModel=$O.root.createModel(ny),this._clearModel.node=this._clearModel.transform=this.node;var t=NF(IF),n=l.director.root.device,i=n.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.DEVICE,4*t,t)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(r);var o=n.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a),this._clearModelMesh=new QE([i],IF,Vi.TRIANGLE_LIST,o),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var e,t=this._graphics;t.stencilStage=YF.DISABLED,this._type===lU.IMAGE_STENCIL?(e=yv.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=yv.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==lU.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},J(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==lU.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=YF.DISABLED,this._graphics&&(this._graphics.stencilStage=YF.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=cn(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this._type===lU.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===lU.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),t}(YV),eU.Type=lU,ce((YG=tU).prototype,"type",[LG,FG],Object.getOwnPropertyDescriptor(YG.prototype,"type"),YG.prototype),ce(YG.prototype,"inverted",[zG,VG],Object.getOwnPropertyDescriptor(YG.prototype,"inverted"),YG.prototype),ce(YG.prototype,"segments",[GG],Object.getOwnPropertyDescriptor(YG.prototype,"segments"),YG.prototype),ce(YG.prototype,"spriteFrame",[UG,kG],Object.getOwnPropertyDescriptor(YG.prototype,"spriteFrame"),YG.prototype),ce(YG.prototype,"alphaThreshold",[HG,jG,Qc],Object.getOwnPropertyDescriptor(YG.prototype,"alphaThreshold"),YG.prototype),ce(YG.prototype,"color",[sl,WG],Object.getOwnPropertyDescriptor(YG.prototype,"color"),YG.prototype),ce(YG.prototype,"customMaterial",[sl,qG],Object.getOwnPropertyDescriptor(YG.prototype,"customMaterial"),YG.prototype),KG=ce(YG.prototype,"_type",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lU.RECT}}),JG=ce(YG.prototype,"_inverted",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),QG=ce(YG.prototype,"_segments",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),ZG=ce(YG.prototype,"_spriteFrame",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$G=ce(YG.prototype,"_alphaThreshold",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),XG=YG))||XG)||XG)||XG)||XG));LP._maskComp=dU,l.Mask=dU;var pU,mU,vU,gU,yU,xU,SU,CU,AU,bU,TU,EU,wU,IU,PU,RU,DU,OU,NU,BU,MU,LU,FU,zU,VU,GU,UU,kU,HU,jU,WU,qU,XU,YU,KU,JU,QU,ZU,$U,ek,tk,nk,ik,rk,ok,ak,sk,ck,lk,uk,hk,_k,fk,dk,pk,mk,vk,gk,yk,xk,Sk,Ck,Ak=/^(click)(\s)*=|(param)(\s)*=/,bk=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,Tk=e("HtmlTextParser",function(){function e(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var t=e.prototype;return t.parse=function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,n=e.length;t<n;){var i=e.indexOf(">",t),r=-1;if(i>=0&&(r=e.lastIndexOf("<",i))<t-1&&(r=e.indexOf("<",i+1),i=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=n;else{var o=e.substring(t,r),a=e.substring(r+1,i);""===a&&(o=e.substring(t,i+1)),this._processResult(o),-1===i?i=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(a),t=i+1}}return this._resultObjectArray},t._attributeToObject=function(e){e=e.trim();var t={},n=/^(color|size)(\s)*=/.exec(e),i="",r=0,o="";if(n){if(i=n[0],""===(e=e.substring(i.length).trim()))return t;switch(r=e.indexOf(" "),i[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(o=e.substring(r+1).trim(),t.event=this._processEventHandler(o)),t}if((n=/^(br(\s)*\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var a="",s=-1;if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var c;n=bk.exec(e);for(var l=!1;n;){var u=(i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length)).length;if(i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),a=e.substring(u).trim(),s="src"===i?this.getRightQuotationIndex(a):-1,c=(r=a.indexOf(" ",s+1>=a.length?-1:s+1))>-1?a.substr(0,r):a,e=a.substring(r).trim(),c.endsWith("/")&&(c=c.slice(0,-1)),"src"===i){switch(c.charCodeAt(0)){case 34:case 39:l=!0,c=c.slice(1,-1)}t.isImage=!0,t.src=c}else if("height"===i)t.imageHeight=parseInt(c);else if("width"===i)t.imageWidth=parseInt(c);else if("align"===i){switch(c.charCodeAt(0)){case 34:case 39:c=c.slice(1,-1)}t.imageAlign=c.toLowerCase()}else"offset"===i?t.imageOffset=c:"click"===i&&(t.event=this._processEventHandler(i+"="+c));t.event&&"param"===i&&(t.event[i]=c.replace(/^"|"$/g,"")),n=bk.exec(e)}return l&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(e)){var h={color:"#ffffff",width:1};if(e=n[0].substring("outline".length).trim()){var _,f=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=f.exec(e);n;)i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),_=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),"click"===i?t.event=this._processEventHandler(i+"="+_):"color"===i?h.color=_:"width"===i&&(h.width=parseInt(_)),t.event&&"param"===i&&(t.event[i]=_.replace(/^"|"$/g,"")),n=f.exec(e)}t.outline=h}if((n=/^(on|u|b|i)(\s)*/.exec(e))&&n[0].length>0){switch(i=n[0],e=e.substring(i.length).trim(),i[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t},t.getRightQuotationIndex=function(e){var t=-1,n=-1,i=e.indexOf("'"),r=e.indexOf('"'),o=r>-1&&(r<i||-1===i);return i>-1&&(i<r||-1===r)?(t=i,n=e.indexOf("'",t+1>=e.length?-1:t+1)):o&&(t=r,n=e.indexOf('"',t+1>=e.length?-1:t+1)),n},t._processEventHandler=function(e){for(var t={},n=0,i=!1,r=Ak.exec(e);r;){var o=r[0],a="";if(i=!1,'"'===(e=e.substring(o.length).trim()).charAt(0))(n=e.indexOf('"',1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else if("'"===e.charAt(0))(n=e.indexOf("'",1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(e);n=(a=s?s[0]:"").length}i&&(t[o=o.substring(0,o.length-1).trim()]=a),e=e.substring(n).trim(),r=Ak.exec(e)}return t},t._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}},t._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},t._escapeSpecialSymbol=function(e){for(var t,n=ae(this._specialSymbolArray);!(t=n()).done;){var i=t.value,r=i[0],o=i[1];e=e.replace(r,o)}return e},e}()),Ek=function(t){return e({LabelOutline:t,LabelOutlineComponent:t}),t}((pU=Ac("cc.LabelOutline"),mU=Uc(),vU=Tc(110),gU=Fc(),yU=bc(ZV),xU=qc(),SU=qc(),pU(CU=mU(CU=vU(CU=gU(CU=yU(CU=Lc((EU=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_color",bU,re(t)),se(t,"_width",TU,re(t)),t}Z(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(ZV);e&&e.updateRenderData(!0)},J(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(Ku),bU=ce((AU=EU).prototype,"_color",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(0,0,0,255)}}),TU=ce(AU.prototype,"_width",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),ce(AU.prototype,"color",[xU],Object.getOwnPropertyDescriptor(AU.prototype,"color"),AU.prototype),ce(AU.prototype,"width",[SU],Object.getOwnPropertyDescriptor(AU.prototype,"width"),AU.prototype),CU=AU))||CU)||CU)||CU)||CU)||CU)||CU));l.LabelOutline=Ek,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(yk||(yk={})),st(yk),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(xk||(xk={})),st(xk),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(Sk||(Sk={})),st(Sk),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(Ck||(Ck={}));var wk,Ik=function(t){return e({Sprite:t,SpriteComponent:t}),t}((wU=Ac("cc.Sprite"),IU=Uc(),PU=Tc(110),RU=Fc(),DU=ol(LL),OU=Zc(),NU=qc(),BU=ol(BL),MU=Zc(),LU=qc(),FU=ol(yk),zU=Zc(),VU=qc(),GU=ol(xk),UU=Zc(),kU=qc(),HU=Zc(),jU=qc(),WU=Xc(),qU=Zc(),XU=qc(),YU=Xc(),KU=Zc(),JU=qc(),QU=Hc(),ZU=Zc(),$U=qc(),ek=Zc(),tk=qc(),nk=ol(Sk),ik=Zc(),rk=qc(),wU(ok=IU(ok=PU(ok=RU((gk=vk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_spriteFrame",sk,re(t)),se(t,"_type",ck,re(t)),se(t,"_fillType",lk,re(t)),se(t,"_sizeMode",uk,re(t)),se(t,"_fillCenter",hk,re(t)),se(t,"_fillStart",_k,re(t)),se(t,"_fillRange",fk,re(t)),se(t,"_isTrimmedMode",dk,re(t)),se(t,"_useGrayscale",pk,re(t)),se(t,"_atlas",mk,re(t)),t}Z(t,e);var n=t.prototype;return n.__preload=function(){this.changeMaterialForDefine(),e.prototype.__preload.call(this)},n.onEnable=function(){e.prototype.onEnable.call(this),this._activateMaterial();var t=this._spriteFrame;t&&(this._updateUVs(),this._type===yk.SLICED&&t.on(BL.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===yk.SLICED&&this._spriteFrame.off(BL.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){e.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var n=!1;if(e instanceof Vm){var i=e.getPixelFormat();n=i===gm.RGBA_ETC1||i===gm.RGB_A_PVRTC_4BPPV1||i===gm.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=Rz.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=Rz.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=Rz.GRAYSCALE:this._instanceMaterialType=Rz.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var t=e.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof DC){var n=Q({SAMPLE_FROM_RT:!0},t.passes[0].defines),i=new Kv;i.initialize({effectAsset:t.effectAsset,defines:n}),t=i}return t},n._render=function(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!e.prototype._canRender.call(this))return!1;var t=this._spriteFrame;return!(!t||!t.texture)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===yk.SLICED?this._spriteFrame.on(BL.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(BL.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(Sk.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(Sk.TRIMMED===this._sizeMode){var t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(e){var t=this._spriteFrame;e&&this._type===yk.SLICED&&e.off(BL.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;t&&(e&&e.texture===t.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===yk.SLICED&&t.on(BL.EVENT_UV_UPDATED,this._updateUVs,this))},J(t,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===xk.RADIAL||this._fillType===xk.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===yk.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=cn(e,0,1),this._type===yk.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=cn(e,-1,1),this._type===yk.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===yk.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==Sk.CUSTOM&&this._applySpriteSize())}}]),t}(YV),vk.FillType=xk,vk.Type=yk,vk.SizeMode=Sk,vk.EventType=Ck,ce((ak=gk).prototype,"spriteAtlas",[DU,OU,NU],Object.getOwnPropertyDescriptor(ak.prototype,"spriteAtlas"),ak.prototype),ce(ak.prototype,"spriteFrame",[BU,MU,LU],Object.getOwnPropertyDescriptor(ak.prototype,"spriteFrame"),ak.prototype),ce(ak.prototype,"type",[FU,zU,VU],Object.getOwnPropertyDescriptor(ak.prototype,"type"),ak.prototype),ce(ak.prototype,"fillType",[GU,UU,kU],Object.getOwnPropertyDescriptor(ak.prototype,"fillType"),ak.prototype),ce(ak.prototype,"fillCenter",[HU,jU],Object.getOwnPropertyDescriptor(ak.prototype,"fillCenter"),ak.prototype),ce(ak.prototype,"fillStart",[WU,qU,XU],Object.getOwnPropertyDescriptor(ak.prototype,"fillStart"),ak.prototype),ce(ak.prototype,"fillRange",[YU,KU,JU],Object.getOwnPropertyDescriptor(ak.prototype,"fillRange"),ak.prototype),ce(ak.prototype,"trim",[QU,ZU,$U],Object.getOwnPropertyDescriptor(ak.prototype,"trim"),ak.prototype),ce(ak.prototype,"grayscale",[kc,ek,tk],Object.getOwnPropertyDescriptor(ak.prototype,"grayscale"),ak.prototype),ce(ak.prototype,"sizeMode",[nk,ik,rk],Object.getOwnPropertyDescriptor(ak.prototype,"sizeMode"),ak.prototype),sk=ce(ak.prototype,"_spriteFrame",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ck=ce(ak.prototype,"_type",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yk.SIMPLE}}),lk=ce(ak.prototype,"_fillType",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xk.HORIZONTAL}}),uk=ce(ak.prototype,"_sizeMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sk.TRIMMED}}),hk=ce(ak.prototype,"_fillCenter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn(0,0)}}),_k=ce(ak.prototype,"_fillStart",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fk=ce(ak.prototype,"_fillRange",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dk=ce(ak.prototype,"_isTrimmedMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),pk=ce(ak.prototype,"_useGrayscale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),mk=ce(ak.prototype,"_atlas",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ok=ak))||ok)||ok)||ok)||ok));l.Sprite=Ik;var Pk,Rk,Dk,Ok,Nk,Bk,Mk,Lk,Fk,zk,Vk,Gk,Uk,kk,Hk,jk,Wk,qk,Xk,Yk,Kk,Jk,Qk,Zk,$k,eH,tH,nH,iH,rH,oH,aH,sH,cH,lH,uH,hH,_H,fH,dH,pH,mH,vH,gH,yH,xH,SH,CH,AH,bH,TH,EH,wH=e("RenderRoot2D",Ac("cc.RenderRoot2D")(wk=Tc(100)(wk=Fc()(wk=bc(uz)(wk=Ec(wk=Lc(wk=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.onEnable=function(){l.director.root.batcher2D.addScreen(this)},n.onDisable=function(){l.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){l.director.root.batcher2D.removeScreen(this)},t}(Ku))||wk)||wk)||wk)||wk)||wk)||wk),IH=new Pn,PH=rt({OVERLAY:0,INTERSPERSE:1}),RH=function(t){return e({Canvas:t,CanvasComponent:t}),t}((Pk=Ac("cc.Canvas"),Rk=Uc(),Dk=Tc(100),Ok=Fc(),Nk=ol(pL),Bk=qc(),Mk=qc(),Lk=ol(pL),Pk(Fk=Rk(Fk=Dk(Fk=Ok(Fk=Lc(Fk=Ec((ce((zk=function(e){function t(){var t;return se(t=e.call(this)||this,"_cameraComponent",Vk,re(t)),se(t,"_alignCanvasWithScreen",Gk,re(t)),t._thisOnCameraResized=void 0,t._fitDesignResolution=void 0,t._pos=new Pn,t._renderMode=PH.OVERLAY,t._thisOnCameraResized=t._onResizeCamera.bind(re(t)),t}Z(t,e);var n=t.prototype;return n.__preload=function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(pL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(eb.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){e.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(pL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){e.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(pL.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this.node.off(eb.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=nN.height/2;else{var e=rh.windowSize;this._cameraComponent.orthoHeight=e.height/lN.getScaleY()/2}this.node.getWorldPosition(IH),this._cameraComponent.node.setWorldPosition(IH.x,IH.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===PH.OVERLAY?t|1<<30:t&~(1<<30)}return 0},J(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}}]),t}(wH)).prototype,"cameraComponent",[Nk,Bk],Object.getOwnPropertyDescriptor(zk.prototype,"cameraComponent"),zk.prototype),ce(zk.prototype,"alignCanvasWithScreen",[Mk],Object.getOwnPropertyDescriptor(zk.prototype,"alignCanvasWithScreen"),zk.prototype),Vk=ce(zk.prototype,"_cameraComponent",[Lk],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gk=ce(zk.prototype,"_alignCanvasWithScreen",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Fk=zk))||Fk)||Fk)||Fk)||Fk)||Fk)||Fk));l.Canvas=RH,G(e("UIComponent",Ac("cc.UIComponent")(Uk=bc(uz)(Uk=Tc(110)(Uk=Ec(Uk=Lc(Uk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastParent=null,t.stencilStage=YF.DISABLED,t}Z(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},t}(Ku))||Uk)||Uk)||Uk)||Uk)||Uk).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),G(YV.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor"},{name:"dstBlendFactor"}]),V(RH.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:wn.BLACK},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),U(uz.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),l.UITransformComponent=uz,nt.setClassAlias(uz,"cc.UITransformComponent"),nt.setClassAlias(YV,"cc.RenderComponent"),l.CanvasComponent=RH,nt.setClassAlias(RH,"cc.CanvasComponent");var DH=new Tk,OH="RICHTEXT_CHILD",NH="RICHTEXT_Image_CHILD",BH=new et((function(e){if(!l.isValid(e.node))return!1;var t=e.node.getComponent(Ek);return t&&(t.width=0),!0}),20),MH=new et((function(e){return l.isValid(e.node)}),10);function LH(e){return{node:new nE(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function FH(e,t){var n;e===OH?n=BH._get():e===NH&&(n=MH._get());var i=(n=n||LH(e)).node;return i||(i=new nE(e)),i.hideFlags|=fl.Flags.DontSave|fl.Flags.HideInHierarchy,e===NH?(n.comp=i.getComponent(Ik)||i.addComponent(Ik),n.comp.spriteFrame=t,n.comp.type=Ik.Type.SLICED,n.comp.sizeMode=Ik.SizeMode.CUSTOM):(n.comp=i.getComponent(ZV)||i.addComponent(ZV),n.comp.string=t,n.comp.horizontalAlign=jV.LEFT,n.comp.verticalAlign=WV.TOP,n.comp.underlineHeight=2),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var zH,VH=function(t){return e({RichText:t,RichTextComponent:t}),t}((kk=Ac("cc.RichText"),Hk=Uc(),jk=Tc(110),Wk=Fc(),qk=qc(),Xk=ol(jV),Yk=qc(),Kk=ol(WV),Jk=qc(),Qk=qc(),Zk=qc(),$k=ol(UL),eH=qc(),tH=qc(),nH=Zc(),iH=ol(XV),rH=qc(),oH=qc(),aH=qc(),sH=ol(LL),cH=qc(),lH=qc(),kk(uH=Hk(uH=jk(uH=Wk(uH=Lc((EH=TH=function(e){function t(){var t;return se(t=e.call(this)||this,"_lineHeight",_H,re(t)),se(t,"_string",fH,re(t)),se(t,"_horizontalAlign",dH,re(t)),se(t,"_verticalAlign",pH,re(t)),se(t,"_fontSize",mH,re(t)),se(t,"_maxWidth",vH,re(t)),se(t,"_fontFamily",gH,re(t)),se(t,"_font",yH,re(t)),se(t,"_isSystemFontUsed",xH,re(t)),se(t,"_userDefinedFont",SH,re(t)),se(t,"_cacheMode",CH,re(t)),se(t,"_imageAtlas",AH,re(t)),se(t,"_handleTouchEvent",bH,re(t)),t._textArray=[],t._segments=[],t._labelSegmentsCache=[],t._linesWidth=[],t._lineCount=1,t._labelWidth=0,t._labelHeight=0,t._layoutDirty=!0,t._lineOffsetX=0,t._updateRichTextStatus=void 0,t._labelChildrenNum=0,t._updateRichTextStatus=t._updateRichText,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this.node.on(eb.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(eb.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var e,t=ae(this._segments);!(e=t()).done;){var n=e.value;n.node.removeFromParent(),n.type===OH?BH.put(n):n.type===NH&&MH.put(n)}this.node.off(eb.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(eb.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(eb.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(eb.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))},n._createFontLabel=function(e){return FH(OH,e)},n._createImage=function(e){return FH(NH,e)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n.SplitLongStringApproximatelyIn2048=function(e,t){var n=[];if(this._calculateSize(t,e).x<2048)n.push(e);else for(var i=e.split("\n"),r=0;r<i.length;r++)if(this._calculateSize(t,i[r]).x<2048)n.push(i[r]);else{var o=this.splitLongStringOver2048(i[r],t);n.push.apply(n,o)}return n},n.splitLongStringOver2048=function(e,t){for(var n=[],i=e,r=0,o=i.length/2,a=i.substring(r,o),s=i.substring(o),c=this._calculateSize(t,a),l=(this._calculateSize(t,s),1*this.maxWidth);c.x>l;){if((o/=2)<1){o*=2;break}a=a.substring(r,o),s=i.substring(o),c=this._calculateSize(t,a)}for(var u=1e3,h=1;u&&r<e.length;){for(;u&&c.x<l;){var _=vF(s);_&&_.length>0&&(h=_[0].length),o+=h,a=i.substring(r,o),s=i.substring(o),c=this._calculateSize(t,a),u--}for(;u&&a.length>=2&&c.x>l;)o-=h,a=i.substring(r,o),c=this._calculateSize(t,a),h=1,u--;if(a.length>=2){var f=gF(a);f&&f.length>0&&a!==f[0]&&(o-=f[0].length,a=i.substring(r,o))}if(n.push(a),r=o,o+=a.length,a=i.substring(r,o),s=i.substring(o),u--,this._calculateSize(t,s).x<2048){r=e.length,o=e.length,a=s,n.push(a);break}c=this._calculateSize(t,a)}return n},n._measureText=function(e,t){var n=this,i=function(t){return n._calculateSize(e,t).width};return t?i(t):i},n._calculateSize=function(e,t){var n;return 0===this._labelSegmentsCache.length?(n=this._createFontLabel(t),this._labelSegmentsCache.push(n)):(n=this._labelSegmentsCache[0]).node.getComponent(ZV).string=t,n.styleIndex=e,this._applyTextAttribute(n),n.node._uiProps.uiTransformComp.contentSize},n._onTouchEnded=function(e){for(var t,n=this,i=this.node.getComponents(Ku),r=function(){var r=t.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var n=t[o];t.enabledInHierarchy&&n&&n.call(t,e,a)})),e.propagationStopped=!0)},o=ae(this._segments);!(t=o()).done;)r()},n._containsTouchLocation=function(e,t){var n=e.node.getComponent(uz);return!!n&&n.getBoundingBoxToWorld().contains(t)},n._resetState=function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var n=e[t];if(n.name===OH||n.name===NH){n.parent===this.node?n.parent=null:e.splice(t,1);var i=LH(n.name);i.node=n,n.name===OH?(i.comp=n.getComponent(ZV),BH.put(i)):(i.comp=n.getComponent(Ik),MH.put(i)),this._labelChildrenNum--}}this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(e){for(var t=this.node.children.length-1;t>=0;t--){var n=this.node.children[t];n.name!==OH&&n.name!==NH||(n.active=e)}},n._addLabelSegment=function(e,t){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(e);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(ZV);i&&(i.string=e)}var r=n.comp;return r.verticalAlign!==this._verticalAlign&&(r.verticalAlign=this._verticalAlign),n.styleIndex=t,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.insertChild(n.node,this._labelChildrenNum++),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(e,t,n){var i=t;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(e,r,e.length),a=e.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=e.substr(0,r);this._addLabelSegment(c,n),e=e.substr(r,e.length),i=this._measureText(n,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=yF(e,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],_=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=_.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(e,n)},n._isLastComponentCR=function(e){return e.length-1===e.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var n=this._textArray[t],i=e[t];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(e){if(e.style){var t=e.style,n=t.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.imageOffset&&(r.imageOffset=t.imageOffset),r.node.layer=this.node.layer,this.node.insertChild(r.node,this._labelChildrenNum++),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=t.imageWidth||0,u=t.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=t.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else R(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var e=DH.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=(o=this.SplitLongStringApproximatelyIn2048(o,i).join("\n")).split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,i),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+iF)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(e,t,n){var i=e.charAt(t);if(fF(i)||dF(i))return 1;for(var r=1,o=t+1;o<n&&!dF(i=e.charAt(o))&&!fF(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var e=0,t=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>t&&(e=0,t=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case jV.LEFT:break;case jV.CENTER:l-=this._linesWidth[c-1]/2;break;case jV.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(Ik)){var h=s.node.position.clone(),_=this._lineHeight,f=this._lineHeight*(1+iF);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=_+(f-_)/2;break;case.5:h.y+=f/2;break;default:h.y+=(f-_)/2}if(s.imageOffset){var d=s.imageOffset.split(",");if(1===d.length&&d[0]){var p=parseFloat(d[0]);Number.isInteger(p)&&(h.y+=p)}else if(2===d.length){var m=parseFloat(d[0]),v=parseFloat(d[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(Ek);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(e){var t=e.toUpperCase();return wn[t]?wn[t]:(new wn).fromHEX(e)},n._applyTextAttribute=function(e){var t=e.node.getComponent(ZV);if(t){this._resetLabelState(t);var n,i=e.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){var r=e.node.getComponent(Ek);r||(r=e.node.addComponent(Ek)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";var o=n.event;o&&(e.clickHandler=o.click||"",e.clickParam=o.param||"")}t.cacheMode=this._cacheMode,this._font instanceof UL&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);var a=t._assembler;a&&a.updateRenderData(t)}},n._applyLayer=function(){for(var e,t=ae(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer},n._resetLabelState=function(e){e.fontSize=this._fontSize,e.color=wn.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1},J(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),t}(Ku),TH.HorizontalAlign=jV,TH.VerticalAlign=WV,ce((hH=EH).prototype,"string",[$c,qk],Object.getOwnPropertyDescriptor(hH.prototype,"string"),hH.prototype),ce(hH.prototype,"horizontalAlign",[Xk,Yk],Object.getOwnPropertyDescriptor(hH.prototype,"horizontalAlign"),hH.prototype),ce(hH.prototype,"verticalAlign",[Kk,Jk],Object.getOwnPropertyDescriptor(hH.prototype,"verticalAlign"),hH.prototype),ce(hH.prototype,"fontSize",[Qk],Object.getOwnPropertyDescriptor(hH.prototype,"fontSize"),hH.prototype),ce(hH.prototype,"fontFamily",[Zk],Object.getOwnPropertyDescriptor(hH.prototype,"fontFamily"),hH.prototype),ce(hH.prototype,"font",[$k,eH],Object.getOwnPropertyDescriptor(hH.prototype,"font"),hH.prototype),ce(hH.prototype,"useSystemFont",[tH,nH],Object.getOwnPropertyDescriptor(hH.prototype,"useSystemFont"),hH.prototype),ce(hH.prototype,"cacheMode",[iH,rH],Object.getOwnPropertyDescriptor(hH.prototype,"cacheMode"),hH.prototype),ce(hH.prototype,"maxWidth",[oH],Object.getOwnPropertyDescriptor(hH.prototype,"maxWidth"),hH.prototype),ce(hH.prototype,"lineHeight",[aH],Object.getOwnPropertyDescriptor(hH.prototype,"lineHeight"),hH.prototype),ce(hH.prototype,"imageAtlas",[sH,cH],Object.getOwnPropertyDescriptor(hH.prototype,"imageAtlas"),hH.prototype),ce(hH.prototype,"handleTouchEvent",[lH],Object.getOwnPropertyDescriptor(hH.prototype,"handleTouchEvent"),hH.prototype),_H=ce(hH.prototype,"_lineHeight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),fH=ce(hH.prototype,"_string",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),dH=ce(hH.prototype,"_horizontalAlign",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jV.LEFT}}),pH=ce(hH.prototype,"_verticalAlign",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WV.TOP}}),mH=ce(hH.prototype,"_fontSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),vH=ce(hH.prototype,"_maxWidth",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),gH=ce(hH.prototype,"_fontFamily",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),yH=ce(hH.prototype,"_font",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xH=ce(hH.prototype,"_isSystemFontUsed",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SH=ce(hH.prototype,"_userDefinedFont",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),CH=ce(hH.prototype,"_cacheMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XV.NONE}}),AH=ce(hH.prototype,"_imageAtlas",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bH=ce(hH.prototype,"_handleTouchEvent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uH=hH))||uH)||uH)||uH)||uH)||uH));l.RichText=VH;var GH=function(t){return e({UIMeshRenderer:t,UIModelComponent:t}),t}(Ac("cc.UIMeshRenderer")(zH=Uc()(zH=Tc(110)(zH=Fc()(zH=Lc(zH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._modelComponent=null,t.stencilStage=YF.DISABLED,t}Z(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent||console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null)},n.updateAssembler=function(e){if(this._modelComponent){var t=this._modelComponent._collectModels();this._modelComponent._detachFromScene();for(var n=0;n<t.length;n++)t[n].enabled&&e.commitModel(this,t[n],this._modelComponent.material);return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var n=this._modelComponent.getMaterialInstance(t);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=bd.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},J(t,[{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(Ku))||zH)||zH)||zH)||zH)||zH);l.UIMeshRenderer=GH;var UH,kH,HH,jH,WH,qH,XH,YH,KH,JH,QH,ZH,$H,ej,tj,nj,ij,rj,oj,aj,sj,cj,lj,uj,hj,_j,fj,dj,pj,mj=Cd.Enum.NONE|Cd.Enum.UI_3D,vj=e("UIDrawBatch",function(){function e(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=mj,this._inputAssembler=null,this._descriptorSet=null}var t=e.prototype;return t.destroy=function(){this._passes=[]},t.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=mj,this.renderScene=null},t.fillPasses=function(e,t,n,i,r,o){if(e){var a=e.passes;if(!a)return;var s=0;this._shaders.length=a.length;for(var c=0;c<a.length;c++){this._passes[c]||(this._passes[c]=new Ev(l.director.root));var u=a[c],h=this._passes[c];u.update(),t||(t=u.depthStencilState,n=0),i||(i=u.blendState,r=0),-1===r&&(r=0),s=n<<16|r,h._initPassFromTarget(u,t,i,s),this._shaders[c]=h.getShaderVariant(o)}}},J(e,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(e){this._inputAssembler=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),e}()),gj=function(t){return e({UIStaticBatch:t,UIStaticBatchComponent:t}),t}((UH=Ac("cc.UIStaticBatch"),kH=Uc(),HH=Fc(),jH=Tc(110),WH=Hc(),UH(qH=kH(qH=HH(qH=jH((ce((XH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._init=!1,t._bufferAccessor=null,t._dirty=!0,t._uiDrawBatchList=[],t}Z(t,e);var n=t.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var e=new vj;return e.isStatic=!0,this._uiDrawBatchList.push(e),e},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return $O.root&&$O.root.batcher2D?$O.root.batcher2D:(R(9301),null)},J(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(YV)).prototype,"color",[sl,WH],Object.getOwnPropertyDescriptor(XH.prototype,"color"),XH.prototype),qH=XH))||qH)||qH)||qH)||qH)),yj=e("LabelShadow",(YH=Ac("cc.LabelShadow"),KH=Uc(),JH=Tc(110),QH=Fc(),ZH=bc(ZV),$H=qc(),ej=qc(),tj=qc(),YH(nj=KH(nj=JH(nj=QH(nj=ZH(nj=Lc((sj=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_color",rj,re(t)),se(t,"_offset",oj,re(t)),se(t,"_blur",aj,re(t)),t}Z(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(ZV);e&&e.updateRenderData(!0)},J(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}}]),t}(Ku),rj=ce((ij=sj).prototype,"_color",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(0,0,0,255)}}),oj=ce(ij.prototype,"_offset",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn(2,2)}}),aj=ce(ij.prototype,"_blur",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),ce(ij.prototype,"color",[$H],Object.getOwnPropertyDescriptor(ij.prototype,"color"),ij.prototype),ce(ij.prototype,"offset",[ej],Object.getOwnPropertyDescriptor(ij.prototype,"offset"),ij.prototype),ce(ij.prototype,"blur",[tj],Object.getOwnPropertyDescriptor(ij.prototype,"blur"),ij.prototype),nj=ij))||nj)||nj)||nj)||nj)||nj)||nj)),xj=function(t){return e({UIOpacity:t,UIOpacityComponent:t}),t}((cj=Ac("cc.UIOpacity"),lj=Uc(),uj=Tc(110),hj=Fc(),_j=qc(),cj(fj=lj(fj=uj(fj=hj(fj=Lc(fj=Ec((ce((dj=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_opacity",pj,re(t)),t}Z(t,e);var n=t.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},J(t,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=St(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}}]),t}(Ku)).prototype,"opacity",[kc,_j],Object.getOwnPropertyDescriptor(dj.prototype,"opacity"),dj.prototype),pj=ce(dj.prototype,"_opacity",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),fj=dj))||fj)||fj)||fj)||fj)||fj)||fj));l.MaskComponent=dU,nt.setClassAlias(dU,"cc.MaskComponent"),l.LabelComponent=ZV,nt.setClassAlias(ZV,"cc.LabelComponent"),l.LabelOutlineComponent=Ek,nt.setClassAlias(Ek,"cc.LabelOutlineComponent"),l.RichTextComponent=VH,nt.setClassAlias(VH,"cc.RichTextComponent"),l.SpriteComponent=Ik,nt.setClassAlias(Ik,"cc.SpriteComponent"),l.UIModelComponent=GH,nt.setClassAlias(GH,"cc.UIModelComponent"),l.GraphicsComponent=cU,nt.setClassAlias(cU,"cc.GraphicsComponent"),nt.setClassAlias(gj,"cc.UIStaticBatchComponent"),nt.setClassAlias(xj,"cc.UIOpacityComponent");var Sj=function(e,t,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=n};function Cj(e,t,n,i,r){var o=0,a=null;if(r===function(e,t,n,i){for(var r=0,o=t,a=n-i;o<n;o+=i)r+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return r}(e,t,n,i)>0)for(o=t;o<n;o+=i)a=Gj(o,e[o],e[o+1],a);else for(o=n-i;o>=t;o-=i)a=Gj(o,e[o],e[o+1],a);return a&&Lj(a,a.next)&&(Uj(a),a=a.next),a}function Aj(e,t){if(void 0===t&&(t=null),!e)return e;t||(t=e);var n=e,i=!1;do{if(i=!1,n.steiner||!Lj(n,n.next)&&0!==Mj(n.prev,n,n.next))n=n.next;else{if(Uj(n),(n=t=n.prev)===n.next)return null;i=!0}}while(i||n!==t);return t}function bj(e,t,n,i,r,o,a){if(void 0===a&&(a=0),e){!a&&o&&function(e,t,n,i){var r=e;do{null===r.z&&(r.z=Dj(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=e,e=null,o=null,a=0;n;){for(a++,i=n,s=0,t=0;t<l&&(s++,i=i.nextZ);t++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:e=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(e,i,r,o);for(var s=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,o?Ej(e,i,r,o):Tj(e))t.push(c.i/n),t.push(e.i/n),t.push(l.i/n),Uj(e),e=l.next,s=l.next;else if((e=l)===s){a?1===a?bj(e=wj(e,t,n),t,n,i,r,o,2):2===a&&Ij(e,t,n,i,r,o):bj(Aj(e),t,n,i,r,o,1);break}}}function Tj(e){var t=e.prev,n=e,i=e.next;if(Mj(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(Nj(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&Mj(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Ej(e,t,n,i){var r=e.prev,o=e,a=e.next;if(Mj(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=Dj(s,c,t,n,i),_=Dj(l,u,t,n,i),f=e.nextZ;f&&f.z<=_;){if(f!==e.prev&&f!==e.next&&Nj(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&Mj(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=h;){if(f!==e.prev&&f!==e.next&&Nj(r.x,r.y,o.x,o.y,a.x,a.y,f.x,f.y)&&Mj(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0}function wj(e,t,n){var i=e;do{var r=i.prev,o=i.next.next;!Lj(r,o)&&Fj(r,i,i.next,o)&&zj(r,o)&&zj(o,r)&&(t.push(r.i/n),t.push(i.i/n),t.push(o.i/n),Uj(i),Uj(i.next),i=e=o),i=i.next}while(i!==e);return i}function Ij(e,t,n,i,r,o){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&Bj(a,s)){var c=Vj(a,s);return a=Aj(a,a.next),c=Aj(c,c.next),bj(a,t,n,i,r,o),void bj(c,t,n,i,r,o)}s=s.next}a=a.next}while(a!==e)}function Pj(e,t){return e.x-t.x}function Rj(e,t){if(t=function(e,t){var n=t,i=e.x,r=e.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,_=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&Nj(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<_||c===_&&n.x>a.x)&&zj(n,e)&&(a=n,_=c),n=n.next;return a}(e,t)){var n=Vj(t,e);Aj(n,n.next)}}function Dj(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function Oj(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function Nj(e,t,n,i,r,o,a,s){return(r-a)*(t-s)-(e-a)*(o-s)>=0&&(e-a)*(i-s)-(n-a)*(t-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function Bj(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&Fj(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&zj(e,t)&&zj(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)}function Mj(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function Lj(e,t){return e.x===t.x&&e.y===t.y}function Fj(e,t,n,i){return!!(Lj(e,t)&&Lj(n,i)||Lj(e,i)&&Lj(n,t))||Mj(e,t,n)>0!=Mj(e,t,i)>0&&Mj(n,i,e)>0!=Mj(n,i,t)>0}function zj(e,t){return Mj(e.prev,e,e.next)<0?Mj(e,t,e.next)>=0&&Mj(e,e.prev,t)>=0:Mj(e,t,e.prev)<0||Mj(e,e.next,t)<0}function Vj(e,t){var n=new Sj(e.i,e.x,e.y),i=new Sj(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function Gj(e,t,n,i){var r=new Sj(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function Uj(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function kj(e,t,n){n=n||3;var i=t?t.length:0,r=i?t[0]*n:e.length,o=Cj(e,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,_=0,f=0;if(i&&(o=function(e,t,n,i){var r,o=[],a=0,s=null;for(a=0,r=t.length;a<r;a++)(s=Cj(e,t[a]*i,a<r-1?t[a+1]*i:e.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(Oj(s)));if(o.sort(Pj),!n)return n;for(a=0;a<o.length;a++)Rj(o[a],n),n=Aj(n,n.next);return n}(e,t,o,n)),e.length>80*n){s=l=e[0],c=u=e[1];for(var d=n;d<r;d+=n)(h=e[d])<s&&(s=h),(_=e[d+1])<c&&(c=_),h>l&&(l=h),_>u&&(u=_);f=Math.max(l-s,u-c)}return bj(o,a,n,s,c,f),a}for(var Hj=Math.PI,jj=Math.min,Wj=Math.max,qj=Math.ceil,Xj=Math.acos,Yj=Math.cos,Kj=Math.sin,Jj=Math.atan2,Qj=null,Zj=null,$j=new wn,eW=[],tW=0;tW<4;tW++)eW.push(new Pn);function nW(e,t,n){return e<t?t:e>n?n:e}var iW={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!Zj)return null;var n=Zj.getRenderDataList(),i=n[Zj.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+t:0;return(o>65535||3*o>131070)&&(++Zj.dataOffset,Zj.dataOffset<n.length?i=n[Zj.dataOffset]:(i=Zj.requestRenderData(),n[Zj.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(t,3*t),i},stroke:function(e){wn.copy($j,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){wn.copy($j,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t,n,i,r,o=.5*e.lineWidth,a=e.lineCap,s=e.lineJoin,c=e.miterLimit;if(Zj=e.impl){var l=(t=o,n=Hj,i=Zj.tessTol,r=2*Xj(t/(t+i)),Wj(2,qj(n/r)));this._calculateJoins(Zj,o,s,c);for(var u=Zj.paths,h=0,_=Zj.pathOffset,f=Zj.pathLength;_<f;_++){var d=u[_],p=d.points.length;s===JV.ROUND?h+=2*(p+d.bevel*(l+2)+1):h+=2*(p+5*d.bevel+1),d.closed||(a===KV.ROUND?h+=2*(2*l+2):h+=12)}var m=Qj=this.getRenderData(e,h);if(m){for(var v=m.vData,g=m.iData,y=Zj.pathOffset,x=Zj.pathLength;y<x;y++){var S=u[y],C=S.points,A=C.length,b=m.vertexStart,T=void 0,E=void 0,w=0,I=0,P=S.closed;if(P?(T=C[A-1],E=C[0],w=0,I=A):(T=C[0],E=C[1],w=1,I=A-1),E=E||T,!P){var R=new nU(E.x,E.y);R.subtract(T),R.normalize();var D=R.x,O=R.y;a===KV.BUTT?this._buttCapStart(T,D,O,o,0):a===KV.SQUARE?this._buttCapStart(T,D,O,o,o):a===KV.ROUND&&this._roundCapStart(T,D,O,o,l)}for(var N=w;N<I;++N)s===JV.ROUND?this._roundJoin(T,E,o,o,l):0!=(E.flags&(QV.PT_BEVEL|QV.PT_INNERBEVEL))?this._bevelJoin(T,E,o,o):(this._vSet(E.x+E.dmx*o,E.y+E.dmy*o,1),this._vSet(E.x-E.dmx*o,E.y-E.dmy*o,-1)),T=E,E=C[N+1];if(P){var B=8*b;this._vSet(v[B],v[B+1],1),this._vSet(v[B+8],v[B+8+1],-1)}else{var M=new nU(E.x,E.y);M.subtract(T),M.normalize();var L=M.x,F=M.y;a===KV.BUTT?this._buttCapEnd(E,L,F,o,0):a===KV.SQUARE?this._buttCapEnd(E,L,F,o,o):a===KV.ROUND&&this._roundCapEnd(E,L,F,o,l)}for(var z=m.indexStart,V=b+2,G=m.vertexStart;V<G;V++)g[z++]=V-2,g[z++]=V-1,g[z++]=V;m.indexStart=z}Qj=null,Zj=null}}},_expandFill:function(e){if(Zj=e.impl){for(var t=Zj.paths,n=0,i=Zj.pathOffset,r=Zj.pathLength;i<r;i++)n+=t[i].points.length;var o=Qj=this.getRenderData(e,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=Zj.pathOffset,u=Zj.pathLength;l<u;l++){var h=t[l],_=h.points,f=_.length;if(0!==f){for(var d=o.vertexStart,p=0;p<f;++p)this._vSet(_[p].x,_[p].y);var m=o.indexStart;if(h.complex){for(var v=[],g=d,y=o.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=kj(v,null,3);if(!S||0===S.length)continue;for(var C=0,A=S.length;C<A;C++)c[m++]=S[C]+d}else for(var b=d,T=d+2,E=a.vertexStart;T<E;T++)c[m++]=b,c[m++]=T-1,c[m++]=T;a.indexStart=m}}Qj=null,Zj=null}}},_calculateJoins:function(e,t,n,i){var r=0;t>0&&(r=1/t);for(var o=e.paths,a=e.pathOffset,s=e.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],_=l[0];c.bevel=0;for(var f=0;f<u;f++){var d,p,m=h.dy,v=-h.dx,g=_.dy,y=-_.dx;if(_.dmx=.5*(m+g),_.dmy=.5*(v+y),(d=_.dmx*_.dmx+_.dmy*_.dmy)>1e-6){var x=1/d;x>600&&(x=600),_.dmx*=x,_.dmy*=x}_.dx*h.dy-h.dx*_.dy>0&&(_.flags|=QV.PT_LEFT),d*(p=Wj(11,jj(h.len,_.len)*r))*p<1&&(_.flags|=QV.PT_INNERBEVEL),_.flags&QV.PT_CORNER&&(d*i*i<1||n===JV.BEVEL||n===JV.ROUND)&&(_.flags|=QV.PT_BEVEL),0!=(_.flags&(QV.PT_BEVEL|QV.PT_INNERBEVEL))&&c.bevel++,h=_,_=l[f+1]}}},_flattenPaths:function(e){for(var t=e.paths,n=e.pathOffset,i=e.pathLength;n<i;n++){var r=t[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new nU(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(e,t,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==e?(a=r+t.dy*i,s=o-t.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(e,t,n,i,r){var o=e.x-t*r,a=e.y-n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(e,t,n,i,r){var o=e.x+t*r,a=e.y+n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(e,t,n,i,r){for(var o=e.x,a=e.y,s=n,c=-t,l=0;l<r;l++){var u=l/(r-1)*Hj,h=Yj(u)*i,_=Kj(u)*i;this._vSet(o-s*h-t*_,a-c*h-n*_,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(e,t,n,i,r){var o=e.x,a=e.y,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*Hj,h=Yj(u)*i,_=Kj(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+t*_,a-c*h+n*_,1)}},_roundJoin:function(e,t,n,i,r){var o=e.dy,a=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&QV.PT_LEFT)){var h=this._chooseBevel(t.flags&QV.PT_INNERBEVEL,e,t,n),_=h[0],f=h[1],d=h[2],p=h[3],m=Jj(-a,-o),v=Jj(-c,-s);v>m&&(v-=2*Hj),this._vSet(_,f,1),this._vSet(l-o*i,t.y-a*i,-1);for(var g=nW(qj((m-v)/Hj)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+Yj(x)*i,C=u+Kj(x)*i;this._vSet(l,u,0),this._vSet(S,C,-1)}this._vSet(d,p,1),this._vSet(l-s*i,u-c*i,-1)}else{var A=this._chooseBevel(t.flags&QV.PT_INNERBEVEL,e,t,-i),b=A[0],T=A[1],E=A[2],w=A[3],I=Jj(a,o),P=Jj(c,s);P<I&&(P+=2*Hj),this._vSet(l+o*i,u+a*i,1),this._vSet(b,T,-1);for(var R=nW(qj((P-I)/Hj)*r,2,r),D=0;D<R;D++){var O=I+D/(R-1)*(P-I),N=l+Yj(O)*n,B=u+Kj(O)*n;this._vSet(N,B,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(E,w,-1)}},_bevelJoin:function(e,t,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=e.dy,f=-e.dx,d=t.dy,p=-t.dx;if(t.flags&QV.PT_LEFT){var m=this._chooseBevel(t.flags&QV.PT_INNERBEVEL,e,t,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(t.x-_*i,t.y-f*i,-1),this._vSet(u,h,1),this._vSet(t.x-d*i,t.y-p*i,-1)}else{var v=this._chooseBevel(t.flags&QV.PT_INNERBEVEL,e,t,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(t.x+_*n,t.y+f*n,1),this._vSet(r,o,-1),this._vSet(t.x+d*n,t.y+p*n,1),this._vSet(a,s,-1)}},_vSet:function(e,t,n){if(void 0===n&&(n=0),Qj){var i=Qj,r=8*i.vertexStart,o=i.vData;o[r++]=e,o[r++]=t,o[r++]=0,wn.toArray(o,$j,r),r+=4,o[r++]=n,i.vertexStart++}}},rW=e("graphicsAssembler",{getAssembler:function(){return iW}});cU.Assembler=rW;var oW=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},aW=new ii,sW=null,cW=null,lW=[],uW=[],hW=[],_W=[],fW=new ti,dW=new ti,pW=new Yn,mW=null,vW=0,gW=0,yW=0,xW=0,SW=0,CW=1,AW=null,bW="",TW=0,EW=0,wW=0,IW=0,PW=0,RW=0,DW=0,OW=!1,NW=0,BW=0,MW=0,LW={updateRenderData:function(e){e.renderData&&sW!==e&&(e.renderData.vertDirty&&(cW=(sW=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),sW.actualFontSize=TW,cW.setContentSize(dW),this.updateUVs(e),sW.renderData.vertDirty=!1,sW.markForUpdateRenderData(!1),sW=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},updateUVs:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.vertexCount,r=t.data,o=3,a=0;a<i;a++){var s=r[a];n[o]=s.u,n[o+1]=s.v,o+=9}},_updateFontScale:function(){CW=TW/EW},_updateFontFamily:function(e){var t=e.font;AW=t.spriteFrame,mW=t.fntConfig,wF.fontAtlas=t.fontDefDictionary,IL.packToDynamicAtlas(e,AW)},_updateLabelInfo:function(){wF.hash="",wF.margin=0},_updateProperties:function(e){bW=e.string.toString(),TW=e.fontSize,EW=mW?mW.fontSize:e.fontSize,wW=e.horizontalAlign,IW=e.verticalAlign,PW=e.spacingX,DW=e.overflow,RW=e._lineHeight;var t=cW.contentSize;dW.width=t.width,dW.height=t.height,DW===qV.NONE?(OW=!1,dW.width+=2*wF.margin,dW.height+=2*wF.margin):DW===qV.RESIZE_HEIGHT?(OW=!0,dW.height+=2*wF.margin):OW=e.enableWrapText,wF.lineHeight=RW,wF.fontSize=TW,this._setupBMFontOverflowMetrics()},_resetProperties:function(){mW=null,AW=null,wF.hash="",wF.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=bW,t=e.length,n=mW.kerningDict,i=lW,r=-1,o=0;o<t;++o){var a=e.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<t-1?s:0,r=a}},_multilineTextWrap:function(e){for(var t=bW.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<t;){var h=bW.charAt(u);if("\n"!==h){for(var _=e(bW,u,t),f=s,d=c,p=a,m=i,v=!1,g=0;g<_;++g){var y=u+g;if("\r"!==(h=bW.charAt(y)))if(l=wF.fontAtlas.getLetterDefinitionForChar(h,wF)){var x=m+l.offsetX*CW-wF.margin;if(OW&&MW>0&&i>0&&x+l.w*CW>MW&&!dF(h)){hW.push(a),a=0,n++,i=0,r-=RW*this._getFontScale()+0,v=!0;break}pW.x=x,pW.y=r-l.offsetY*CW,this._recordLetterInfo(pW,h,y,n),y+1<lW.length&&y<t-1&&(m+=lW[y+1]),m+=l.xAdvance*CW+PW,p=pW.x+l.w*CW,f<pW.y&&(f=pW.y),d>pW.y-l.h*CW&&(d=pW.y-l.h*CW)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+mW.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<f&&(s=f),c>d&&(c=d),o<(a=p)&&(o=a),u+=_)}else hW.push(a),a=0,n++,i=0,r-=RW*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return hW.push(a),gW=(vW=n+1)*RW*this._getFontScale(),vW>1&&(gW+=0*(vW-1)),dW.width=NW,dW.height=BW,NW<=0&&(dW.width=parseFloat(o.toFixed(2))+2*wF.margin),BW<=0&&(dW.height=parseFloat(gW.toFixed(2))+2*wF.margin),xW=dW.height,SW=0,s>0&&(xW=dW.height+s),c<-gW&&(SW=gW+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return DW===qV.SHRINK?CW:1},_getFirstWordLen:function(e,t,n){var i=e.charAt(t);if(fF(i)||"\n"===i||dF(i))return 1;var r=1,o=wF.fontAtlas.getLetterDefinitionForChar(i,wF);if(!o)return r;for(var a=o.xAdvance*CW+PW,s=t+1;s<n&&(i=e.charAt(s),o=wF.fontAtlas.getLetterDefinitionForChar(i,wF));++s){if(a+o.offsetX*CW+o.w*CW>MW&&!dF(i)&&MW>0)return r;if(a+=o.xAdvance*CW+PW,"\n"===i||dF(i)||fF(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=uW.length){var n=new oW;uW.push(n)}uW[e].char=t,uW[e].hash=""+t.charCodeAt(0)+wF.hash,uW[e].valid=!1},_recordLetterInfo:function(e,t,n,i){if(n>=uW.length){var r=new oW;uW.push(r)}var o=""+t.charCodeAt(0)+wF.hash;uW[n].line=i,uW[n].char=t,uW[n].hash=o,uW[n].valid=wF.fontAtlas.getLetter(o).valid,uW[n].x=e.x,uW[n].y=e.y},_alignText:function(){gW=0,hW.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),DW===qV.SHRINK&&TW>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||DW===qV.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),TW=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,n=0|TW,i=0;t<n;){var r=i=t+n+1>>1;if(r<=0)break;CW=r/EW,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=i-1:t=i}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return gW>dW.height},_isHorizontalClamp:function(){for(var e=!1,t=0,n=bW.length;t<n;++t){var i=uW[t];if(i.valid){var r=wF.fontAtlas.getLetterDefinitionForChar(i.char,wF);if(!r)continue;var o=i.x+r.w*CW,a=i.line;if(NW>0)if(OW){if(hW[a]>dW.width&&(o>dW.width||o<0)){e=!0;break}}else if(o>dW.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var n=hW[t],i=e>dW.width||e<0;return OW?n>dW.width&&i:i},_updateQuads:function(){if(!sW)return!1;var e=AW?AW.texture:wF.fontAtlas.getTexture(),t=sW.renderData;t.dataLength=0,t.resize(0,0);for(var n=cW.anchorPoint,i=dW,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=bW.length;s<c;++s){var l=uW[s];if(l.valid){var u=wF.fontAtlas.getLetter(l.hash);if(u){aW.height=u.h,aW.width=u.w,aW.x=u.u,aW.y=u.v;var h=l.y+yW;if(BW>0){if(h>xW){var _=h-xW;aW.y+=_,aW.height-=_,h-=_}h-u.h*CW<SW&&DW===qV.CLAMP&&(aW.height=h<SW?0:(h-SW)/CW)}var f=l.line,d=l.x+u.w/2*CW+_W[f];if(NW>0&&this._isHorizontalClamped(d,f))if(DW===qV.CLAMP)aW.width=0;else if(DW===qV.SHRINK){if(dW.width>u.w){a=!1;break}aW.width=0}if(aW.height>0&&aW.width>0){var p=this._determineRect(),m=l.x+_W[l.line];this.appendQuad(sW,e,aW,p,m-r,h-o,CW)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var e=AW.isRotated(),t=AW.getOriginalSize(),n=AW.getRect(),i=AW.getOffset(),r=i.x+(t.width-n.width)/2,o=i.y-(t.height-n.height)/2;if(e){var a=aW.x;aW.x=n.x+n.height-aW.y-aW.height-o,aW.y=a+n.y-r,aW.y<0&&(aW.height+=o)}else aW.x+=n.x-r,aW.y+=n.y+o;return e},_computeAlignmentOffset:function(){switch(_W.length=0,wW){case jV.LEFT:for(var e=0;e<vW;++e)_W.push(0);break;case jV.CENTER:for(var t=0,n=hW.length;t<n;t++)_W.push((dW.width-hW[t])/2);break;case jV.RIGHT:for(var i=0,r=hW.length;i<r;i++)_W.push(dW.width-hW[i])}if(yW=dW.height,IW!==WV.TOP){var o=dW.height-gW+RW*this._getFontScale()-EW*CW;IW===WV.BOTTOM?yW-=o:yW-=o/2}},_setupBMFontOverflowMetrics:function(){var e=dW.width,t=dW.height;DW===qV.RESIZE_HEIGHT&&(t=0),DW===qV.NONE&&(e=0,t=0),NW=e,BW=t,fW.width=e,fW.height=t,MW=e}},FW=new wn(255,255,255,255),zW={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){var t=e.node;FW.set(e.color),FW.a=255*t._uiProps.opacity,xL(t,0,e.renderData,FW)},appendQuad:function(e,t,n,i,r,o,a){var s=e.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=t.width,h=t.height,_=n.width,f=n.height,d=0,p=0,m=0,v=0;i?(d=n.x/u,v=(n.x+f)/u,p=(n.y+_)/h,m=n.y/h,l[c].u=d,l[c].v=m,l[c+1].u=d,l[c+1].v=p,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=p):(d=n.x/u,v=(n.x+_)/u,p=(n.y+f)/h,m=n.y/h,l[c].u=d,l[c].v=p,l[c+1].u=v,l[c+1].v=p,l[c+2].u=d,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-f*a,l[c+1].x=r+_*a,l[c+1].y=o-f*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+_*a,l[c+3].y=o}},updateColor:function(){}};Fe(zW,LW);var VW=null,GW=ze(LW,{getAssemblerData:function(){return VW||(VW=new EF(1024,1024)),VW.getTexture()},_updateFontFamily:function(e){wF.fontAtlas=VW,wF.fontFamily=this._getFontFamily(e);var t=e.getComponent(Ek);t&&t.enabled?(wF.isOutlined=!0,wF.margin=t.width,wF.out=t.color.clone(),wF.out.a=t.color.a*e.color.a/255):(wF.isOutlined=!1,wF.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){wF.fontDesc=this._getFontDesc(),wF.color=e.color,wF.hash=function(e){var t=e.color.toHEX(),n="";return e.isOutlined&&e.margin>0&&(n=n+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+n}(wF)},_getFontDesc:function(){return wF.fontSize.toString()+"px "+wF.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),UW=new wn(255,255,255,255),kW={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){if(e.renderData){var t=e.node;UW.a=255*t._uiProps.opacity,xL(t,0,e.renderData,UW)}},updateColor:function(){},appendQuad:zW.appendQuad};Fe(kW,GW);var HW=ZV.Overflow,jW=(1/255).toFixed(3),WW=null,qW=null,XW=null,YW="",KW="",JW=0,QW=0,ZW=[],$W=new ti,eq=0,tq=0,nq=0,iq=new wn,rq="",oq=HW.NONE,aq=!1,sq=null,cq=wn.BLACK.clone(),lq=null,uq=wn.BLACK.clone(),hq=new ii,_q=ti.ZERO.clone(),fq=ti.ZERO.clone(),dq=Yn.ZERO.clone(),pq=Yn.ZERO.clone(),mq=0,vq=0,gq=!1,yq=!1,xq=!1,Sq=["left","center","right"],Cq={getAssemblerData:function(){return ZV._canvasPool.get()},resetAssemblerData:function(e){e&&ZV._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData){if(e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this._calDynamicAtlas(e),e.actualFontSize=JW,t.setContentSize($W),this.updateVertexData(e),this.updateUVs(e),e.markForUpdateRenderData(!1),WW=null,qW=null,XW=null}e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(e){rq=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var n=e.assemblerData;n&&(WW=n.context,qW=n.canvas,XW=e.spriteFrame,KW=e.string.toString(),JW=e.fontSize,QW=JW,oq=e.overflow,fq.width=$W.width=t.width,fq.height=$W.height=t.height,vq=e.underlineHeight,eq=e.lineHeight,tq=e.horizontalAlign,nq=e.verticalAlign,iq=e.color,e.node._uiProps.opacity,gq=e.isBold,yq=e.isItalic,xq=e.isUnderline,aq=oq!==HW.NONE&&(oq===HW.RESIZE_HEIGHT||e.enableWrapText),(sq=(sq=Ek&&e.getComponent(Ek))&&sq.enabled&&sq.width>0?sq:null)&&cq.set(sq.color),(lq=(lq=yj&&e.getComponent(yj))&&lq.enabled?lq:null)&&uq.set(lq.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,n=0,i=0,r=0;if(_q.width=_q.height=0,sq&&(e=t=n=i=r=sq.width,_q.width=_q.height=2*r),lq){var o=lq.blur+r,a=lq.offset.x,s=lq.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),e=Math.max(e,s+o),t=Math.max(t,-s+o)}if(yq){var c=QW*Math.tan(.20943951);i+=c,_q.width+=c}hq.x=n,hq.y=e,hq.width=n+i,hq.height=e+t},_calculateFillTextStartPosition:function(){var e=0;tq===jV.RIGHT?e=$W.width-hq.width:tq===jV.CENTER&&(e=($W.width-hq.width)/2);var t=this._getLineHeight()*(ZW.length-1),n=JW*(1-iF/2);if(nq!==WV.TOP){var i=t+hq.height+JW-$W.height;nq===WV.BOTTOM?n-=i+=iF/2*JW:n-=i/2}n+=0*JW,dq.set(e+hq.x,n+hq.y)},_updateTexture:function(e){if(WW&&qW){WW.clearRect(0,0,qW.width,qW.height),WW.font=YW,this._calculateFillTextStartPosition();var t=this._getLineHeight();WW.lineJoin="round",sq?(WW.fillStyle="rgba("+cq.r+", "+cq.g+", "+cq.b+", "+jW+")",WW.fillRect(0,0,qW.width,qW.height)):e._srcBlendFactor===Ri.SRC_ALPHA&&(WW.fillStyle="rgba("+iq.r+", "+iq.g+", "+iq.b+", "+jW+")",WW.fillRect(0,0,qW.width,qW.height)),WW.fillStyle="rgb("+iq.r+", "+iq.g+", "+iq.b+")";var n=dq.x,i=0;this._drawTextEffect(dq,t);for(var r=0;r<ZW.length;++r)i=dq.y+r*t,sq&&WW.strokeText(ZW[r],n,i),WW.fillText(ZW[r],n,i);lq&&(WW.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){if(e.cacheMode===ZV.CacheMode.BITMAP){var t=e.ttfSpriteFrame;IL.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}var n;XW&&qW&&(n=XW instanceof BL?XW.texture:XW,0!==qW.width&&0!==qW.height&&(n.reset({width:qW.width,height:qW.height,mipmapLevel:1}),n.uploadData(qW),n.setWrapMode(ym.CLAMP_TO_EDGE,ym.CLAMP_TO_EDGE),XW instanceof BL&&(XW.rect=new ii(0,0,qW.width,qW.height),XW._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),l.director.root&&l.director.root.batcher2D&&l.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(e){if(!(e.cacheMode!==ZV.CacheMode.BITMAP||!qW||qW.width<=0||qW.height<=0)){var t=e.ttfSpriteFrame;IL.packToDynamicAtlas(e,t)}},_setupOutline:function(){WW.strokeStyle="rgba("+cq.r+", "+cq.g+", "+cq.b+", "+cq.a/255+")",WW.lineWidth=2*sq.width},_setupShadow:function(){WW.shadowColor="rgba("+uq.r+", "+uq.g+", "+uq.b+", "+uq.a/255+")",WW.shadowBlur=lq.blur,WW.shadowOffsetX=lq.offset.x,WW.shadowOffsetY=-lq.offset.y},_drawTextEffect:function(e,t){if(lq||sq||xq){var n=ZW.length>1&&lq,i=this._measureText(WW,YW),r=0,o=0;lq&&this._setupShadow(),sq&&this._setupOutline();for(var a=0;a<ZW.length;++a)r=e.x,o=e.y+a*t,n&&(sq&&WW.strokeText(ZW[a],r,o),WW.fillText(ZW[a],r,o)),xq&&(mq=i(ZW[a]),tq===jV.RIGHT?pq.x=e.x-mq:tq===jV.CENTER?pq.x=e.x-mq/2:pq.x=e.x,pq.y=o+QW/8,WW.fillRect(pq.x,pq.y,mq,vq));n&&(WW.shadowColor="transparent")}},_updateLabelDimensions:function(){$W.width=Math.min($W.width,2048),$W.height=Math.min($W.height,2048);var e=!1;qW.width!==$W.width&&(qW.width=$W.width,e=!0),qW.height!==$W.height&&(qW.height=$W.height,e=!0),e&&(WW.font=YW),WW.textAlign=Sq[tq],WW.textBaseline="alphabetic"},_getFontDesc:function(){var e=JW.toString()+"px ";return e+=rq,gq&&(e="bold "+e),yq&&(e="italic "+e),e},_getLineHeight:function(){return 0|(0===eq?JW:eq*JW/QW)},_calculateParagraphLength:function(e,t){for(var n,i=[],r=ae(e);!(n=r()).done;){var o=pF(t,n.value,YW);i.push(o)}return i},_measureText:function(e,t){return function(n){return pF(e,n,t)}},_calculateShrinkFont:function(e){if(WW){var t=this._calculateParagraphLength(e,WW),n=0,i=0,r=0;if(aq){var o=fq.width,a=fq.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|JW+1,l=0;s<c;){if((l=s+c+1>>1)<=0){I(4003);break}JW=l,YW=this._getFontDesc(),WW.font=YW;var u=this._getLineHeight();for(i=0,n=0;n<e.length;++n){var h=pF(WW,e[n],YW);i+=yF(e[n],h,o,this._measureText(WW,YW)).length*u}i>a?c=l-1:s=l}0===s?I(4003):(JW=s,YW=this._getFontDesc(),WW.font=YW)}else{for(i=e.length*this._getLineHeight(),n=0;n<e.length;++n)r<t[n]&&(r=t[n]);var _=($W.width-hq.width)/r,f=$W.height/i;JW=QW*Math.min(1,_,f)|0,YW=this._getFontDesc(),WW.font=YW}}},_calculateWrapText:function(e){if(aq&&WW){ZW=[];for(var t=fq.width,n=0;n<e.length;++n){var i=pF(WW,e[n],YW),r=yF(e[n],i,t,this._measureText(WW,YW));ZW=ZW.concat(r)}}},_calculateLabelFont:function(){if(WW){var e=KW.split("\n");switch(ZW=e,YW=this._getFontDesc(),WW.font=YW,oq){case HW.NONE:for(var t=0,n=0,i=0;i<e.length;++i){var r=pF(WW,e[i],YW);t=t>r?t:r}n=(ZW.length+iF)*this._getLineHeight();var o=parseFloat(t.toFixed(2)),a=parseFloat(n.toFixed(2));$W.width=o+hq.width,$W.height=a+hq.height,fq.width=o+_q.width,fq.height=a+_q.height;break;case HW.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case HW.CLAMP:this._calculateWrapText(e);break;case HW.RESIZE_HEIGHT:this._calculateWrapText(e);var s=(ZW.length+iF)*this._getLineHeight();$W.height=s+hq.height,fq.height=s+_q.height}}}},Aq=wn.WHITE.clone(),bq={createData:function(e){var t=e.requestRenderData();t.dataLength=2,t.resize(4,6);var n=t.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)wn.toArray(n,Aq,i),i+=9;return t},fillBuffers:function(e){var t=e.renderData.chunk,n=e.renderData.data,i=e.node,r=t.vb,o=n[0],a=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=o.x*l.x,h=a.x*l.x,_=o.y*l.y,f=a.y*l.y,d=c.x,p=c.y,m=c.z,v=c.w,g=d*p,y=m*v,x=d*d-p*p,S=v*v-m*m,C=S+x,A=2*(g-y),b=S-x,T=2*(g+y),E=s.x,w=s.y;r[0]=C*u+A*_+E,r[1]=b*_+T*u+w,r[9]=C*h+A*_+E,r[10]=b*_+T*h+w,r[18]=C*u+A*f+E,r[19]=b*f+T*u+w,r[27]=C*h+A*f+E,r[28]=b*f+T*h+w;var I=t.bufferId,P=t.vertexOffset,R=t.vertexAccessor.getMeshBuffer(t.bufferId),D=t.vertexAccessor.getIndexBuffer(I),O=R.indexOffset;D[O++]=P,D[O++]=P+1,D[O++]=P+2,D[O++]=P+2,D[O++]=P+1,D[O++]=P+3,R.indexOffset+=6},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.data;s[0].x=-o,s[0].y=-a,s[1].x=i-o,s[1].y=r-a}},updateUVs:function(e){var t=e.renderData;if(t&&e.ttfSpriteFrame){var n=t.chunk.vb,i=e.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};Fe(bq,Cq);var Tq=e("labelAssembler",{getAssembler:function(e){var t=bq;return e.font instanceof tF?t=zW:e.cacheMode===ZV.CacheMode.CHAR&&(t=kW),t}});ZV.Assembler=Tq;var Eq=Ik.FillType,wq=new jn,Iq=new Pn,Pq={updateRenderData:function(e){var t=e.spriteFrame;IL.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){if(n.updateRenderData(e,t),!n.vertDirty)return;var i=e.fillStart,r=e.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var o=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);o=o>1?1:o,this.updateUVs(e,i,o),this.updateVertexData(e,i,o)}},updateUVs:function(e,t,n){var i=e.spriteFrame,r=e.renderData.chunk.vb,o=i.width,a=i.height,s=i.rect,c=0,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0;switch(i.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=_=c,d=m=(s.x+s.height)/o,f=v=l,h=p=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=d=c,_=m=(s.x+s.width)/o,h=f=l,p=v=s.y/a),e.fillType){case Eq.HORIZONTAL:r[3]=u+(_-u)*t,r[4]=h+(f-h)*t,r[12]=u+(_-u)*n,r[13]=h+(f-h)*n,r[21]=d+(m-d)*t,r[22]=p+(v-p)*t,r[30]=d+(m-d)*n,r[31]=p+(v-p)*n;break;case Eq.VERTICAL:r[3]=u+(d-u)*t,r[4]=h+(p-h)*t,r[12]=_+(m-_)*t,r[13]=f+(v-f)*t,r[21]=u+(d-u)*n,r[22]=h+(p-h)*n,r[30]=_+(m-_)*n,r[31]=f+(v-f)*n;break;default:O(2626)}},updateVertexData:function(e,t,n){var i=e.renderData.data,r=e.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,c=r.anchorY*a,l=-s,u=-c,h=o-s,_=a-c,f=0;switch(e.fillType){case Eq.HORIZONTAL:f=l+(h-l)*n,l+=(h-l)*t,h=f;break;case Eq.VERTICAL:f=u+(_-u)*n,u+=(_-u)*t,_=f;break;default:O(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=_,i[3].x=h,i[3].y=_},createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.resize(4,6);for(var n,i=ae(t.data);!(n=i()).done;)n.value.z=0;return t},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(wq);for(var n=e.renderData.floatStride,i=e.renderData.data,r=t.vb,o=0,a=0;a<4;a++){var s=i[a];Pn.transformMat4(Iq,s,wq),r[o=a*n]=Iq.x,r[o+1]=Iq.y,r[o+2]=Iq.z}},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,o=e.color,a=o.r/255,s=o.g/255,c=o.b/255,l=e.node._uiProps.opacity,u=0;u<4;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},Rq=2*Math.PI,Dq=1e-6,Oq=new jn,Nq=new Pn,Bq=[new Yn,new Yn,new Yn,new Yn],Mq=new Array(4),Lq=new Array(8),Fq=[new Yn,new Yn,new Yn,new Yn],zq=[new Yn,new Yn,new Yn,new Yn],Vq=new Yn,Gq=[new Yn,new Yn,new Yn,new Yn];function Uq(e,t,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>Dq?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>Dq?c:0)){if(l=s/c,(e-r.x)*c>0){var h=r.y+l*(e-r.x);a[0].x=e,a[0].y=h}if((t-r.x)*c>0){var _=r.y+l*(t-r.x);a[2].x=t,a[2].y=_}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var f=r.x+u*(i-r.y);a[3].x=f,a[3].y=i}if((n-r.y)*s>0){var d=r.x+u*(n-r.y);a[1].x=d,a[1].y=n}}}function kq(e,t){var n=t.x-e.x,i=t.y-e.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function Hq(e,t,n,i,r){var o=Mq,a=o[0],s=o[1],c=o[2],l=o[3];e[t].x=n.x,e[t].y=n.y,e[t+1].x=i.x,e[t+1].y=i.y,e[t+2].x=r.x,e[t+2].y=r.y,jq((n.x-a)/(c-a),(n.y-s)/(l-s),e,t),jq((i.x-a)/(c-a),(i.y-s)/(l-s),e,t+1),jq((r.x-a)/(c-a),(r.y-s)/(l-s),e,t+2)}function jq(e,t,n,i){var r=Lq,o=r[0]+(r[2]-r[0])*e,a=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,c=r[5]+(r[7]-r[5])*e,l=n[i];l.u=o+(a-o)*t,l.v=s+(c-s)*t}for(var Wq={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;IL.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;if(n&&t){if(!n.vertDirty)return;var i=n.data,r=e.fillStart,o=e.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=Rq)+(o*=Rq);!function(e){var t=e.node._uiProps.uiTransformComp,n=t.width,i=t.height,r=t.anchorX*n,o=t.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=Mq;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=e.fillCenter,_=Vq.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,f=Vq.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;Bq[0].x=Bq[3].x=a,Bq[1].x=Bq[2].x=c,Bq[0].y=Bq[1].y=s,Bq[2].y=Bq[3].y=l;for(var d,p=ae(Gq);!(d=p()).done;){var m=d.value;Yn.set(m,0,0)}_!==u[0]&&Yn.set(Gq[0],3,0),_!==u[2]&&Yn.set(Gq[2],1,2),f!==u[1]&&Yn.set(Gq[1],0,1),f!==u[3]&&Yn.set(Gq[3],2,3)}(e),function(e){var t=e.width,n=e.height,i=e.getRect(),r=0,o=0,a=0,s=0,c=Lq;e.isRotated()?(r=i.x/t,o=(i.x+i.height)/t,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/t,o=(i.x+i.width)/t,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(t),Uq(Mq[0],Mq[2],Mq[1],Mq[3],Vq,r,Fq),Uq(Mq[0],Mq[2],Mq[1],Mq[3],Vq,r+o,zq);for(var s=0,c=0;c<4;++c){var l=Gq[c];if(l)if(o>=Rq)n.dataLength=s+3,Hq(i,s,Vq,Bq[l.x],Bq[l.y]),s+=3;else{var u=kq(Vq,Bq[l.x]),h=kq(Vq,Bq[l.y]);h<u&&(h+=Rq),u-=Rq,h-=Rq;for(var _=0;_<3;++_)u>=a||(u>=r?(n.dataLength=s+3,Hq(i,s,Vq,Bq[l.x],h>=a?zq[c]:Bq[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,Hq(i,s,Vq,Fq[c],Bq[l.y]),s+=3):(n.dataLength=s+3,Hq(i,s,Vq,Fq[c],zq[c]),s+=3))),u+=Rq,h+=Rq}}n.resize(s,s),n.updateRenderData(e,t)}},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=o+l;a.indexOffset+=n.indexCount,a.setDirty()},updateWorldVertexAndUVData:function(e,t){e.node.getWorldMatrix(Oq);for(var n=e.renderData,i=n.floatStride,r=e.renderData.data,o=t.vb,a=n.vertexCount,s=0,c=0;c<a;c++){var l=r[c];Pn.set(Nq,l.x,l.y,0),Pn.transformMat4(Nq,Nq,Oq),o[s+0]=Nq.x,o[s+1]=Nq.y,o[s+2]=Nq.z,o[s+3]=l.u,o[s+4]=l.v,s+=i}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,o=5,a=e.color,s=a.r/255,c=a.g/255,l=a.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},qq=[],Xq=0;Xq<4;Xq++)qq.push(new Pn);for(var Yq={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){var t=e.spriteFrame;IL.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateWorldVerts:function(e,t){var n=e.renderData,i=t.vb,r=n.data,o=e.node,a=r[0],s=r[1],c=o.worldMatrix,l=c.m00,u=c.m01,h=c.m04,_=c.m05,f=1===l&&0===u&&0===h&&1===_,d=c.m12,p=c.m13,m=a.x,v=s.x,g=a.y,y=s.y;if(f){var x=m+d,S=v+d,C=g+p,A=y+p;i[0]=x,i[1]=C,i[9]=S,i[10]=C,i[18]=x,i[19]=A,i[27]=S,i[28]=A}else{var b=l*m,T=l*v,E=u*m,w=u*v,I=h*g+d,P=h*y+d,R=_*g+p,D=_*y+p;i[0]=b+I,i[1]=E+R,i[9]=T+I,i[10]=w+R,i[18]=b+P,i[19]=E+D,i[27]=T+P,i[28]=w+D}},fillBuffers:function(e){if(null!==e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(i),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6}},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=t.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(e.trim)c=-a,l=-s,u=r-a,h=o-s;else{var _=e.spriteFrame,f=_.getOriginalSize(),d=_.getRect(),p=f.width,m=f.height,v=d.width,g=d.height,y=_.getOffset(),x=r/p,S=o/m,C=y.x+(p-v)/2,A=y.x-(p-v)/2;c=C*x-a,l=(y.y+(m-g)/2)*S-s,u=r+A*x-a,h=o+(y.y-(m-g)/2)*S-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,t.vertDirty=!0}},updateUVs:function(e){if(e.spriteFrame){var t=e.renderData.chunk.vb,n=e.spriteFrame.uv;t[3]=n[0],t[4]=n[1],t[12]=n[2],t[13]=n[3],t[21]=n[4],t[22]=n[5],t[30]=n[6],t[31]=n[7]}},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=5,r=e.color,o=r.r/255,a=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=t.floatStride)n[i]=o,n[i+1]=a,n[i+2]=s,n[i+3]=c}},Kq=new Pn,Jq=new jn,Qq={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.resize(16,54),t},updateRenderData:function(e){var t=e.spriteFrame;IL.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData.data,n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=e.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,_=i-c-l,f=r-u-h,d=i/(c+l),p=r/(u+h);d=Number.isNaN(d)||d>1?1:d,p=Number.isNaN(p)||p>1?1:p,_=_<0?0:_,f=f<0?0:f,t[0].x=-o,t[0].y=-a,t[1].x=c*d-o,t[1].y=h*p-a,t[2].x=t[1].x+_,t[2].y=t[1].y+f,t[3].x=i-o,t[3].y=r-a},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;a[s++]=u,a[s++]=u+1,a[s++]=u+4,a[s++]=u+1,a[s++]=u+5,a[s++]=u+4}o.indexOffset=s},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(Jq);for(var n=e.renderData,i=n.floatStride,r=n.data,o=t.vb,a=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];Pn.set(Kq,u.x,c.y,0),Pn.transformMat4(Kq,Kq,Jq),a=(4*s+l)*i,o[a++]=Kq.x,o[a++]=Kq.y,o[a++]=Kq.z}},updateUVs:function(e){if(e.spriteFrame)for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=e.spriteFrame.uvSliced,o=3,a=0;a<16;a++)n[o]=r[a].u,n[o+1]=r[a].v,o+=i},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,o=e.color,a=o.r/255,s=o.g/255,c=o.b/255,l=e.node._uiProps.opacity,u=0;u<16;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},Zq=[],$q=0;$q<4;$q++)Zq.push(new Pn);var eX=new jn,tX={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,n=e.spriteFrame;if(n&&t&&(t.updateRenderData(e,n),t.vertDirty)){var i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,_=a.height-u-h,f=r-s-c,d=o-u-h;f=f>0?f:0,d=d>0?d:0;var p=0===l?f:f/l,m=0===_?d:d/_,v=Math.ceil(m+2),g=Math.ceil(p+2);t.dataLength=Math.max(8,v+1,g+1),this.updateVerts(e,f,d,v,g),t.resize(v*g*4,v*g*6)}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=o,s[c++]=o+1,s[c++]=o+2,s[c++]=o+1,s[c++]=o+3,s[c++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData:function(e,t){var n=e.node;n.getWorldMatrix(eX);var i=e.renderData,r=i.floatStride,o=i.data,a=t.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=e.spriteFrame,h=u.rotated,_=u.uv,f=u.uvSliced,d=u.rect,p=u.insetLeft,m=u.insetRight,v=d.width-p-m,g=u.insetTop,y=u.insetBottom,x=d.height-g-y,S=c-p-m,C=l-g-y;S=S>0?S:0,C=C>0?C:0;for(var A=0===v?S:S/v,b=0===x?C:C/x,T=Math.ceil(b+2),E=Math.ceil(A+2),w=0,I=0,P=0,R=0,D=0,O=0,N=T;O<N;++O){R=o[O].y,D=o[O+1].y;for(var B=0,M=E;B<M;++B){I=o[B].x,P=o[B+1].x,Pn.set(Zq[0],I,R,0),Pn.set(Zq[1],P,R,0),Pn.set(Zq[2],I,D,0),Pn.set(Zq[3],P,D,0);for(var L=0;L<4;L++){var F=Zq[L];Pn.transformMat4(F,F,eX);var z=L*r;a[w+z]=F.x,a[w+z+1]=F.y,a[w+z+2]=F.z}w+=4*r}}w=0;for(var V=r,G=2*r,U=3*r,k=4*r,H=0,j=0,W=[],q=[],X=0,Y=T;X<Y;++X){j=C>x?C>=X*x?1:b%1:b;for(var K=0,J=E;K<J;++K){H=S>v?S>=K*v?1:A%1:A;var Q=w+3,Z=Q+1;h?(0===X?(W[0]=f[0].u,W[1]=f[0].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X<T-1?(W[0]=f[4].u,W[1]=f[4].u,W[2]=f[4].u+(f[8].u-f[4].u)*j):X===T-1&&(W[0]=f[8].u,W[1]=f[8].u,W[2]=f[12].u),0===K?(q[0]=f[0].v,q[1]=f[1].v+(f[2].v-f[1].v)*H,q[2]=f[0].v):K<E-1?(q[0]=f[1].v,q[1]=f[1].v+(f[2].v-f[1].v)*H,q[2]=f[1].v):K===E-1&&(q[0]=f[2].v,q[1]=f[3].v,q[2]=f[2].v),W[3]=W[2],q[3]=q[1]):(0===K?(W[0]=f[0].u,W[1]=f[1].u+(f[2].u-f[1].u)*H,W[2]=_[0]):K<E-1?(W[0]=f[1].u,W[1]=f[1].u+(f[2].u-f[1].u)*H,W[2]=f[1].u):K===E-1&&(W[0]=f[2].u,W[1]=f[3].u,W[2]=f[2].u),0===X?(q[0]=f[0].v,q[1]=f[0].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X<T-1?(q[0]=f[4].v,q[1]=f[4].v,q[2]=f[4].v+(f[8].v-f[4].v)*j):X===T-1&&(q[0]=f[8].v,q[1]=f[8].v,q[2]=f[12].v),W[3]=W[1],q[3]=q[2]),a[Q]=W[0],a[Z]=q[0],a[Q+V]=W[1],a[Z+V]=q[1],a[Q+G]=W[2],a[Z+G]=q[2],a[Q+U]=W[3],a[Z+U]=q[3],w+=k}}},updateVerts:function(e,t,n,i,r){var o,a,s=e.node._uiProps.uiTransformComp,c=e.renderData.data,l=e.spriteFrame,u=l.rect,h=Math.abs(s.width),_=Math.abs(s.height),f=s.anchorX*h,d=s.anchorY*_,p=l.insetLeft,m=l.insetRight,v=u.width-p-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(p+m)>1?1:s.width/(p+m),C=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,a=x>0?Math.floor(1e3*n)/1e3%x==0?x:n%x:n;for(var A=0;A<=r;A++)0===A?c[A].x=-f:A>0&&A<r?c[A].x=1===A?p*S+Math.min(v,t)-f:v>0?A===r-1?p+o+v*(A-2)-f:p+Math.min(v,t)+v*(A-2)-f:p+t-f:A===r&&(c[A].x=Math.min(p+t+m,h)-f);for(var b=0;b<=i;b++)0===b?c[b].y=-d:b>0&&b<i?c[b].y=1===b?y*C+Math.min(x,n)-d:x>0?b===i-1?y+a+(b-2)*x-d:y+Math.min(x,n)+(b-2)*x-d:y+n-d:b===i&&(c[b].y=Math.min(y+n+g,_)-d)},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,o=5,a=e.color,s=a.r/255,c=a.g/255,l=a.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},nX=Ik.Type,iX=Ik.FillType,rX=e("spriteAssembler",{getAssembler:function(e){var t=Yq,n=e;switch(n.type){case nX.SLICED:t=Qq;break;case nX.TILED:t=tX;break;case nX.FILLED:t=n.fillType===iX.RADIAL?Wq:Pq}return t}});Ik.Assembler=rX;var oX=Dz.sharedManager,aX={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){e.type===lU.IMAGE_STENCIL&&(Yq.updateRenderData(e),Yq.updateColor(e))},fillBuffers:function(e,t){(e.type!==lU.IMAGE_STENCIL||e.spriteFrame)&&(oX.pushMask(e),t.finishMergeBatches(),function(e,t){oX.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(oX.enterLevel(e),e.type===lU.IMAGE_STENCIL){Yq.fillBuffers(e,t);var n=e.graphics.getMaterialInstance(0);t.forceMergeBatches(n,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),oX.enableMask())}},sX={fillBuffers:function(){oX.exitMask()}},cX={getAssembler:function(){return aX}},lX={getAssembler:function(){return sX}};dU.Assembler=cX,dU.PostAssembler=lX;var uX=e("MeshBuffer",function(){function e(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var t=e.prototype;return t.initialize=function(e,t,n,i){this._initVDataCount=n,this._initIDataCount=i,this._attributes=t,this._floatsPerVertex=OF(t),this._initVDataCount,this._floatsPerVertex,L(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))},t.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},t.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var e=0;e<this._iaPool.length;++e){var t=this._iaPool[e];t.vertexBuffers[0]&&t.vertexBuffers[0].destroy(),t.indexBuffer&&t.indexBuffer.destroy(),t.ia.destroy()}this._iaPool.length=0},t.setDirty=function(){this._dirty=!0},t.request=function(){return R(9002),!1},t.requireFreeIA=function(e){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(e)),this._iaPool[this._nextFreeIAHandle++].ia},t.recycleIA=function(e){for(var t=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(e===t[n].ia){var i=t[n];return t[n]=t[--this._nextFreeIAHandle],void(t[this._nextFreeIAHandle]=i)}},t.checkCapacity=function(e,t){var n=(this.vertexOffset+e)*this._floatsPerVertex,i=this.indexOffset+t;return!(n>this._initVDataCount||i>this._initIDataCount)},t.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var e=oh.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,t=this.byteOffset,n=this.indexOffset,i=0;i<e;++i){var r=this._iaPool[i],o=new Float32Array(this.vData.buffer,0,t>>2),a=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];t>s.size&&s.resize(t),s.update(o),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(a)}this._dirty=!1}},t.createNewIA=function(e){var t,n,i;if(oh.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,o=Uint16Array.BYTES_PER_ELEMENT,a=e.createBuffer(new pr(mi.VERTEX|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,r,r));i=e.createBuffer(new pr(mi.INDEX|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,o,o)),n=[a],this._iaInfo=new Br(this._attributes,n,i),t=e.createInputAssembler(this._iaInfo)}else t=e.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:t,vertexBuffers:n,indexBuffer:i}},J(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),e}()),hX=[yR.EventType.MOUSE_DOWN,yR.EventType.MOUSE_MOVE,yR.EventType.MOUSE_UP,yR.EventType.MOUSE_WHEEL],_X=[yR.EventType.TOUCH_START,yR.EventType.TOUCH_MOVE,yR.EventType.TOUCH_END,yR.EventType.TOUCH_CANCEL],fX=(new(function(){function e(){this.priority=lR.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],xR._registerEventDispatcher(this),LP.callbacksInvoker.on(ZE.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),LP.callbacksInvoker.on(ZE.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),LP.callbacksInvoker.on(ZE.MARK_LIST_DIRTY,this._markListDirty,this)}var t=e.prototype;return t.dispatchEvent=function(e){var t=e.type;return _X.includes(t)?this.dispatchEventTouch(e):!hX.includes(t)||this.dispatchEventMouse(e)},t.addPointerEventProcessor=function(e){0===this._inDispatchCount?this._pointerEventProcessorList.includes(e)||(this._pointerEventProcessorList.push(e),this._isListDirty=!0):this._processorListToAdd.includes(e)||this._processorListToAdd.push(e),nt.array.remove(this._processorListToRemove,e)},t.removePointerEventProcessor=function(e){0===this._inDispatchCount?(nt.array.remove(this._pointerEventProcessorList,e),this._isListDirty=!0):this._processorListToRemove.includes(e)||this._processorListToRemove.push(e),nt.array.remove(this._processorListToAdd,e)},t.dispatchEventMouse=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=!0,r=0;r<n;++r){var o=t[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(e)){if(i=!1,!e.preventSwallow)break;e.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},t.dispatchEventTouch=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=e.touch,r=!0,o=0;o<n;++o){var a=t[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(e.type===JE.TOUCH_START){if(a._handleEventTouch(e)){if(a.claimedTouchIdList.push(i.getID()),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(a._handleEventTouch(e),e.type!==JE.TOUCH_END&&e.type!==JE.TOUCH_CANCEL||nt.array.removeAt(a.claimedTouchIdList,s),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},t._updatePointerEventProcessorList=function(){for(var e=this._processorListToAdd,t=e.length,n=0;n<t;++n)this.addPointerEventProcessor(e[n]);e.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},t._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,n=0;n<t;++n){var i=e[n],r=i.node;if(r._uiProps){var o=r._uiProps.uiTransformComp;i.cachedCameraPriority=o.cameraPriority}}e.sort(this._sortByPriority),this._isListDirty=!1}},t._sortByPriority=function(e,t){var n=e.node,i=t.node;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,_;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(_=h.parent)||void 0===_?void 0:_.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var f=r?r.getSiblingIndex():0,d=o?o.getSiblingIndex():0;return a?f-d:d-f},t._markListDirty=function(){this._isListDirty=!0},e}()),function(){function e(e,t){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=e,this._attributes=t,this._floatsPerVertex=OF(t),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var t=e.prototype;return t.initialize=function(){},t.reset=function(){},t.request=function(){},t.appendBuffers=function(){},t.uploadBuffers=function(){},t.destroy=function(){this._attributes.length=0},J(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),e}()),dX=new Hl((function(){return{offset:0,length:0}}),32),pX=function(e,t,n,i){this.vertexAccessor=e,this.bufferId=t,this.vertexOffset=n,this.vb=i},mX=function(e){function t(n,i,r,o){var a;return(a=e.call(this,n,i)||this)._freeLists=[],a._vCount=0,a._iCount=0,a._vCount=r||Math.floor(1024*lt.BATCHER2D_MEM_INCREMENT/a._vertexFormatBytes),a._iCount=o||a._vCount*t.IB_SCALE,a._allocateBuffer(),a}Z(t,e);var n=t.prototype;return n.destroy=function(){for(var t=0;t<this._buffers.length;++t){this._buffers[t].destroy();for(var n=this._freeLists[t],i=0;i<n.length;++i)dX.free(n[i])}this._buffers.length=0,this._freeLists.length=0,e.prototype.destroy.call(this)},n.reset=function(){for(var e=0;e<this._buffers.length;++e){var t=this._buffers[e];t.indexOffset=0,t.reset()}},n.getVertexBuffer=function(e){return this._buffers[e].vData},n.getIndexBuffer=function(e){return this._buffers[e].iData},n.getMeshBuffer=function(e){return this._buffers[e]},n.uploadBuffers=function(){for(var e=0;e<this._buffers.length;++e){var t=this._freeLists[e][0],n=this._buffers[e];(!t||t.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(e,t){var n=this._buffers[e];t.length&&(n.iData.set(t,n.indexOffset),n.indexOffset+=t.length)},n.allocateChunk=function(e,t){for(var n,i=e*this.vertexFormatBytes,r=null,o=0,a=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],o=c,a=l;break}if(s)break}if(s||(o=this._allocateBuffer(),(r=this._buffers[o])&&r.checkCapacity(e,t)&&(a=0,s=this._freeLists[o][a])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(o,a,s,i),new pX(this,o,u,h,t)}return O(9004,i),null},n.recycleChunk=function(e){var t=this._freeLists[e.bufferId],n=this._buffers[e.bufferId],i=e.vertexOffset*this.vertexFormatBytes,r=e.vb.byteLength;if(0!==r){for(var o=!1,a=0,s=null,c=t[a];c&&c.offset<i;)s=c,c=t[++a];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,t.splice(a,1),dX.free(c),c=null),o=!0),!o&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=dX.alloc();l.offset=i,l.length=r,t.splice(a,0,l)}o=!0}if(o)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=dX.alloc();u.offset=i,u.length=r,t.push(u)}}},n._allocateChunkFromEntry=function(e,t,n,i){var r=n.length-i,o=n.offset+i,a=this._buffers[e];a.byteOffset<o&&(a.byteOffset=o),M(r>=0,9004,e,n.offset,n.length),0===r?(this._freeLists[e].splice(t,1),dX.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){M(this._buffers.length===this._freeLists.length,9003);var e=new uX,t=this._vCount*this._floatsPerVertex;e.initialize(this._device,this._attributes,t,this._iCount),this._buffers.push(e);var n=dX.alloc();n.offset=0,n.length=e.vData.byteLength;var i=[n];return this._freeLists.push(i),this._buffers.length-1},t}(fX);mX.IB_SCALE=4;var vX=new Wr(null),gX=new jn,yX=e("UI",function(){function e(e){var t=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new Kv,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new SX,this._meshDataArray=[],this._root=e,this.device=e.device,this._batches=new Wl(64),this._drawBatchPool=new Hl((function(){return new vj}),128,(function(e){return e.destroy(t)}))}var t=e.prototype;return t.initialize=function(){return!0},t.destroy=function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(e){e.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),Dz.sharedManager.destroy()},t.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},t.removeScreen=function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)},t.sortScreens=function(){this._screens.sort(this._screenSort)},t.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,n=0;n<t.length;n++){var i=t[n];if(i.visibility&e.layer)return i}return null},t.update=function(){for(var e=this._screens,t=0,n=0;n<e.length;++n){var i=e[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var o=0;if(this._batches.length>t)for(;t<this._batches.length;++t){var a=this._batches.array[t];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},t.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(e){e.uploadBuffers()})),this._bufferAccessors.forEach((function(e){e.uploadBuffers(),e.reset()})),this._descriptorSetCache.update())},t.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._bufferAccessors.forEach((function(e){e.reset()})),this._meshDataArray.forEach((function(e){e.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),Dz.sharedManager.reset()},t.switchBufferAccessor=function(e){void 0===e&&(e=RF);var t=e===RF?36:NF(e);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==t){var n=this._bufferAccessors.get(t);n||(n=new mX(this.device,e),this._bufferAccessors.set(t,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},t.registerBufferAccessor=function(e,t){this._bufferAccessors.set(e,t)},t.updateBuffer=function(e,t){var n=this.switchBufferAccessor(e);this._currBID!==t&&(this._currBID=t,this._indexStart=n.getMeshBuffer(t).indexOffset)},t.commitComp=function(e,t,n,i,r){var o,a=0,s=-1;if(t&&t.chunk){if(!t.isValid())return;a=t.dataHash,o=t.material,s=t.chunk.bufferId}e.stencilStage=Dz.sharedManager.stage;var c=e.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),t&&!t.isMeshBuffer&&this.updateBuffer(t.vertexFormat,s),this._currRenderData=t,this._currHash=t?t.dataHash:0,this._currComponent=e,this._currTransform=r,this._currMaterial=e.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=e.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(e,this)},t.commitIA=function(e,t,n,i,r){var o,a;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;e&&(o=-1===e.blendHash?null:e.getBlendState(),c=e.blendHash,e.stencilStage=Dz.sharedManager.stage,a=null!==e.customMaterial?Dz.sharedManager.getStencilStage(e.stencilStage,i):Dz.sharedManager.getStencilStage(e.stencilStage),s=Dz.sharedManager.getStencilHash(e.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=e.node.layer,l.inputAssembler=t,l.useLocalData=r||null,n&&(l.texture=n.getGFXTexture(),l.sampler=n.getGFXSampler(),l.textureHash=n.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(i||null,a,s,o,c,null,this),this._batches.push(l)},t.commitModel=function(e,t,n){var i;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;n&&(e.stencilStage!==YF.ENABLED&&e.stencilStage!==YF.DISABLED||(e.stencilStage=Dz.sharedManager.stage),i=Dz.sharedManager.getStencilStage(e.stencilStage,n),r=Dz.sharedManager.getStencilHash(e.stencilStage));var o=l.director.getTotalFrames();t&&(t.updateTransform(o),t.updateUBOs(o));for(var a=0;a<t.subModels.length;a++){var s=this._drawBatchPool.alloc(),c=t.subModels[a];s.visFlags=e.node.layer,s.model=t,s.texture=null,s.sampler=null,s.useLocalData=null,i||(i=null),s.fillPasses(n,i,r,null,0,c.patches,this),s.inputAssembler=c.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=c.descriptorSet,this._batches.push(s)}},t.setupStaticBatch=function(e,t){this.finishMergeBatches(),this._staticVBBuffer=t,this.currStaticRoot=e},t.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},t.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},t.autoMergeBatches=function(e){var t=this._currMaterial;if(t){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var o=this._currBID,a=r.getMeshBuffer(o);if(!a)return;var s=a.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(n=a.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=a.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;e&&(c=-1===e.blendHash?null:e.getBlendState(),h=e.blendHash,l=null!==e.customMaterial?Dz.sharedManager.getStencilStage(e.stencilStage,t):Dz.sharedManager.getStencilStage(e.stencilStage),u=Dz.sharedManager.getStencilHash(e.stencilStage));var _=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();_.visFlags=this._currLayer,_.texture=this._currTexture,_.sampler=this._currSampler,_.inputAssembler=n,_.useLocalData=this._currTransform,_.textureHash=this._currTextureHash,_.samplerHash=this._currSamplerHash,_.fillPasses(t,l,u,c,h,null,this),this._batches.push(_)}}},t.forceMergeBatches=function(e,t,n){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},t.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},t.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},t.flushMaterial=function(e){this._currMaterial=e},t.walk=function(e,t){if(void 0===t&&(t=0),e.activeInHierarchy){var n=e.children,i=e._uiProps,r=i.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*i.localOpacity,i._opacity=a,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&!r.useVertexOpacity&&r.renderData&&r.renderData.vertexCount>0){!function(e,t){for(var n,i,r,o=e.vertexFormat,a=e.chunk.vb,s=0,c=0;c<o.length;++c){if(n=o[c],(i=no[n.format]).hasAlpha)if(r=e.floatStride,i.size/i.count==1)for(var l=~~cn(Math.round(255*t),0,255),u=s;u<a.length;u+=r)a[u]=(4294967040&a[u]|l)>>>0;else if(i.size/i.count==4)for(var h=s+3;h<a.length;h+=r)a[h]=t;s+=i.size>>2}}(r.renderData,a);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(n.length>0&&!e._static)for(var l=0;l<n.length;++l){var u=n[l];this.walk(u,t)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),t+=1}},t._screenSort=function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()},t._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},J(e,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}}]),e}()),xX=function(){function e(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=l.director.root.device;this._localData=new Float32Array(ep.COUNT),this._localBuffer=e.createBuffer(new pr(mi.UNIFORM|mi.TRANSFER_DST,yi.HOST|yi.DEVICE,ep.SIZE,ep.SIZE))}var t=e.prototype;return t.initialize=function(e){var t=l.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,vX.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(vX),this._descriptorSet.bindBuffer(ep.BINDING,this._localBuffer);var n=Dd.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,e.texture),this._descriptorSet.bindSampler(n,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},t.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},t.equals=function(e,t,n){return this._transform===e&&this._textureHash===t&&this._samplerHash===n},t.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},t.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},t.isValid=function(){return this._transform&&this._transform.isValid},t.uploadLocalData=function(){var e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var t=e.worldMatrix;jn.toArray(this._localData,t,ep.MAT_WORLD_OFFSET),jn.inverseTranspose(gX,t);var n=jn.determinant(gX),i=1/Math.sqrt(n);jn.multiplyScalar(gX,gX,i),jn.toArray(this._localData,gX,ep.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},J(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}(),SX=function(){function e(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Hl((function(){return new xX}),16,(function(e){return e.destroy()}))}var t=e.prototype;return t.getDescriptorSet=function(e){var t,n=l.director.root;if(e.useLocalData){for(var i=this._localDescriptorSetCache,r=0,o=i.length;r<o;r++){var a=i[r];if(a.equals(e.useLocalData,e.textureHash,e.samplerHash))return a.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(e),this._localDescriptorSetCache.push(s),s.descriptorSet}if(t=e.textureHash^e.samplerHash,this._descriptorSetCache.has(t))return this._descriptorSetCache.get(t);vX.layout=e.passes[0].localSetLayout;var c=n.device.createDescriptorSet(vX),u=Dd.SAMPLER_SPRITE;return c.bindTexture(u,e.texture),c.bindSampler(u,e.sampler),c.update(),this._descriptorSetCache.set(t,c),this._dsCacheHashByTexture.set(e.textureHash,t),c},t.update=function(){var e=this._localDescriptorSetCache,t=[];e.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=e.indexOf(n);t.push(i)}}));for(var n=t.length-1;n>=0;n--)e.splice(t[n],1)},t.reset=function(){var e=this;this._localDescriptorSetCache.forEach((function(t){e._localCachePool.free(t)})),this._localDescriptorSetCache.length=0},t.releaseDescriptorSetCache=function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))},t.destroy=function(){this._descriptorSetCache.forEach((function(e){e.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},e}();l.internal.Batcher2D=yX,U(uX.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(e){return{name:e,suggest:"please use meshBuffer.accessor."+e+" instead"}}))),V(uX.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),G(uX.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),V(yX.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),G(ez.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),V(ez.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),e("QuadRenderData",function(e){function t(t){var n;return n=e.call(this,t)||this,R(9006),n}return Z(t,e),t}(ez));var CX,AX,bX,TX,EX,wX,IX,PX,RX,DX=null,OX=-1,NX="BES bswy:->@123",BX=Object.create(null),MX=[],LX=3e3;function FX(){for(var e=!0,t=Date.now(),n=MX.length-1;n>=0;n--){var i=MX[n],r=i.fontFamilyName;if(t-i.startTime>LX)R(4933,r),i.onComplete(null,r),MX.splice(n,1);else{var o=i.refWidth,a="40px "+r;DX.font=a,o!==pF(DX,NX,a)?(MX.splice(n,1),i.onComplete(null,r)):e=!1}}e&&(clearInterval(OX),OX=-1)}function zX(e,t,n){var i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");return-1!==(n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(e);if(BX[i])n(null,i);else{if(!DX){var r=document.createElement("canvas");r.width=100,r.height=100,DX=r.getContext("2d")}var o=pF(DX,NX,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+e+'");',a.textContent=s+"}",document.body.appendChild(a);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===CX)if("FontFace"in window){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);CX=e?parseInt(e[1],10)>42:!t}else CX=!1;return CX}())!function(e,t,n){var i=new Promise((function(n,i){!function r(){Date.now()-e>=LX?i():document.fonts.load("40px "+t).then((function(e){e.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,o=new Promise((function(e,t){r=setTimeout(t,LX)}));Promise.race([o,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,t)}),(function(){R(4933,t),n(null,t)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};MX.push(u),-1===OX&&(OX=setInterval(FX,100))}BX[i]=a}}function VX(e,t,n,i){var r=new QL;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function GX(e){return"string"==typeof e||"number"==typeof e}HN.register({".font":zX,".eot":zX,".ttf":zX,".woff":zX,".svg":zX,".ttc":zX}),JN.register({".font":VX,".eot":VX,".ttf":VX,".woff":VX,".svg":VX,".ttc":VX}),l.UI={MeshBuffer:uX,spriteAssembler:rX,graphicsAssembler:rW,labelAssembler:Tq,RenderData:$F,MeshRenderData:ez};var UX,kX,HX,jX,WX,qX,XX,YX,KX,JX,QX,ZX,$X,eY,tY,nY,iY,rY,oY,aY,sY,cY,lY=Ac("cc.animation.HierarchyPath")((EX=function(){function e(e){se(this,"path",TX,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof nE?e.getChildByPath(this.path)||(R(3926,e.name,this.path),null):(R(3925),null)},e}(),TX=ce((bX=EX).prototype,"path",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),AX=bX))||AX,uY=Ac("cc.animation.ComponentPath")((RX=function(){function e(e){se(this,"component",PX,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof nE?e.getComponent(this.component)||(R(3928,e.name,this.component),null):(R(3927),null)},e}(),PX=ce((IX=RX).prototype,"component",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wX=IX))||wX,hY=Ac("cc.animation.UniformProxyFactory")((qX=function(){function e(e,t){se(this,"passIndex",HX,this),se(this,"uniformName",jX,this),se(this,"channelIndex",WX,this),this.passIndex=t||0,this.uniformName=e||""}return e.prototype.forTarget=function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');if(Ev.getTypeFromHandle(n)<pi.SAMPLER1D){var i=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,pi.FLOAT);if(!i)throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"');return function(e,t){for(var n,i=ae(e.shaderInfo.blocks);!(n=i()).done;)for(var r,o=ae(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===t)return a.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(i,e)}}:{set:function(e){t.setUniform(i,e)}}}var r=Ev.getBindingFromHandle(n),o=t.properties[this.uniformName],a=o&&o.value?o.value+"-texture":$p(o.type),s=yv.get(a);return s||(x("Illegal texture default value: "+a+"."),s=yv.get("default-texture")),{set:function(e){e||(e=s);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(r,n),e instanceof Vm&&t.bindSampler(r,l.game._gfxDevice.getSampler(e.getSamplerInfo())))}}},e}(),HX=ce((kX=qX).prototype,"passIndex",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jX=ce(kX.prototype,"uniformName",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),WX=ce(kX.prototype,"channelIndex",[nl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),UX=kX))||UX,_Y=Ac("cc.animation.MorphWeightValueProxy")((QX=function(){function e(){se(this,"subMeshIndex",KX,this),se(this,"shapeIndex",JX,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeight(n,t.subMeshIndex,t.shapeIndex)}}},e}(),KX=ce((YX=QX).prototype,"subMeshIndex",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JX=ce(YX.prototype,"shapeIndex",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XX=YX))||XX,fY=Ac("cc.animation.MorphWeightsValueProxy")((tY=function(){function e(){se(this,"subMeshIndex",eY,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}},e}(),eY=ce(($X=tY).prototype,"subMeshIndex",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZX=$X))||ZX,dY=Ac("cc.animation.MorphWeightsAllValueProxy")(nY=function(){function e(){}return e.prototype.forTarget=function(e){return{set:function(t){for(var n,i,r=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)e.setWeights(t,o)}}},e}())||nY;function pY(e,t,n,i){var r,o,a,s,c,l,u=new t,h=new t,_=new t,f=Ac(e)((l=function(){function e(e,n,i){se(this,"dataPoint",a,this),se(this,"inTangent",s,this),se(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=n||new t,this.outTangent=i||new t}var r=e.prototype;return r.lerp=function(e,t,r){var o=this.dataPoint,a=e.dataPoint;h=n(h,this.inTangent,r),_=n(_,e.outTangent,r);var s=t*t*t,c=t*t,l=s-2*c+t,f=-2*s+3*c,d=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,f),u=i(u,u,_,d)},r.getNoLerp=function(){return this.dataPoint},e}(),a=ce((o=l).prototype,"dataPoint",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=ce(o.prototype,"inTangent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=ce(o.prototype,"outTangent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=o))||r;if(t===Ln){var d=f.prototype.lerp;f.prototype.lerp=function(e,t,n){var i=d.call(this,e,t,n);return Ln.normalize(i,i),i}}return f}var mY,vY,gY,yY,xY,SY,CY,AY,bY,TY,EY,wY,IY,PY,RY,DY,OY,NY,BY,MY,LY,FY,zY,VY,GY,UY,kY,HY=pY("cc.CubicSplineVec2Value",Yn,Yn.multiplyScalar,Yn.scaleAndAdd),jY=pY("cc.CubicSplineVec3Value",Pn,Pn.multiplyScalar,Pn.scaleAndAdd),WY=pY("cc.CubicSplineVec4Value",Zn,Zn.multiplyScalar,Zn.scaleAndAdd),qY=pY("cc.CubicSplineQuatValue",Ln,Ln.multiplyScalar,Ln.scaleAndAdd),XY=Ac("cc.CubicSplineNumberValue")((cY=function(){function e(e,t,n){se(this,"dataPoint",oY,this),se(this,"inTangent",aY,this),se(this,"outTangent",sY,this),this.dataPoint=e,this.inTangent=t,this.outTangent=n}var t=e.prototype;return t.lerp=function(e,t,n){var i=this.dataPoint,r=e.dataPoint,o=t*t*t,a=t*t;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+t)+r*(-2*o+3*a)+e.inTangent*n*(o-a)},t.getNoLerp=function(){return this.dataPoint},e}(),oY=ce((rY=cY).prototype,"dataPoint",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aY=ce(rY.prototype,"inTangent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sY=ce(rY.prototype,"outTangent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iY=rY))||iY,YY=Symbol("CreateEval"),KY=Symbol("NormalizedFollow"),JY=Symbol("ConvertAsTrsPath"),QY=Symbol("TrackBinding"),ZY=Ac("cc.animation.TrackPath")((yY=function(){function e(){se(this,"_paths",gY,this)}var t=e.prototype;return t.toProperty=function(e){return this._paths.push(e),this},t.toElement=function(e){return this._paths.push(e),this},t.toHierarchy=function(e){return this._paths.push(new lY(e)),this},t.toComponent=function(e){var t=new uY("string"==typeof e?e:nt.getClassName(e));return this._paths.push(t),this},t.toCustomized=function(e){return this._paths.push(e),this},t.append=function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=(e=this._paths).concat.apply(e,n.map((function(e){return e._paths})));return this._paths=r,this},t.isPropertyAt=function(e){return"string"==typeof this._paths[e]},t.parsePropertyAt=function(e){return this._paths[e]},t.isElementAt=function(e){return"number"==typeof this._paths[e]},t.parseElementAt=function(e){return this._paths[e]},t.isHierarchyAt=function(e){return this._paths[e]instanceof lY},t.parseHierarchyAt=function(e){return this.isHierarchyAt(e),this._paths[e].path},t.isComponentAt=function(e){return this._paths[e]instanceof uY},t.parseComponentAt=function(e){return this.isComponentAt(e),this._paths[e].component},t.slice=function(t,n){var i=new e;return i._paths=this._paths.slice(t,n),i},t.trace=function(e,t,n){var i,r;return null!==(i=t)&&void 0!==i||(t=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[KY](e,t,n)},t[JY]=function(){for(var e,t=this._paths,n=t.length,i=0,r="";i<n;++i){var o=t[i];if(!(o instanceof lY))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(t[i]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[i];break;default:return null}return{node:r,property:e}},t[KY]=function(e,t,n){for(var i=this._paths,r=e,o=t;o<n;++o){var a=i[o];if(GX(a)){if(!(a in r))return R(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},J(e,[{key:"length",get:function(){return this._paths.length}}]),e}(),gY=ce((vY=yY).prototype,"_paths",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mY=vY))||mY,$Y=Ac("cc.animation.TrackBinding")(xY=Mc((bY=function(){function e(){se(this,"path",CY,this),se(this,"proxy",AY,this)}var t=e.prototype;return t.parseTrsPath=function(){return this.proxy?null:this.path[JY]()},t.createRuntimeBinding=function(e,t,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[KY](e,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(e){c.set(e)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return O(3921),null}var h=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),_=i[KY](e,0,o-1);return null===_?null:t&&_ instanceof nE&&function(e){return"position"===e||"rotation"===e||"scale"===e||"eulerAngles"===e}(h)?t.createPoseWriter(_,h,n):{setValue:function(e){_[h]=e},getValue:function(){return _[h]}}},t.isMaskedOff=function(e){var t=this.parseTrsPath();if(!t)return!1;for(var n=e.joints[Symbol.iterator](),i=n.next();!i.done;i=n.next()){var r=i.value;if(r.path===t.node)return!r.enabled}return!1},e}(),CY=ce((SY=bY).prototype,"path",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ZY}}),AY=ce(SY.prototype,"proxy",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),xY=SY))||xY)||xY,eK=Ac("cc.animation.Track")((IY=function(){function e(){se(this,"_binding",wY,this)}var t=e.prototype;return t.channels=function(){return[]},t.range=function(){for(var e,t={min:1/0,max:-1/0},n=ae(this.channels());!(e=n()).done;){var i=e.value;t.min=Math.min(t.min,i.curve.rangeMin),t.max=Math.max(t.max,i.curve.rangeMax)}return t},J(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:QY,get:function(){return this._binding}}]),e}(),wY=ce((EY=IY).prototype,"_binding",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $Y}}),TY=EY))||TY,tK=Ac("cc.animation.Channel")((OY=function(){function e(e){this.name="",se(this,"_curve",DY,this),this._curve=e}return J(e,[{key:"curve",get:function(){return this._curve}}]),e}(),DY=ce((RY=OY).prototype,"_curve",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),PY=RY))||PY,nK=Ac("cc.animation.SingleChannelTrack")((LY=function(e){function t(){var t;return se(t=e.call(this)||this,"_channel",MY,re(t)),t._channel=new tK(t.createCurve()),t}Z(t,e);var n=t.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[YY]=function(){var e=this._channel.curve;return new iK(e)},J(t,[{key:"channel",get:function(){return this._channel}}]),t}(eK),MY=ce((BY=LY).prototype,"_channel",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),NY=BY))||NY,iK=function(){function e(e){this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e)},e}(),rK=Ac("cc.animation.RealTrack")(FY=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.prototype.createCurve=function(){return new cf},t}(nK))||FY;function oK(e){return 0===e.keyFramesCount?void 0:e}var aK,sK,cK,lK,uK,hK,_K,fK,dK,pK,mK=["X","Y","Z","W"],vK=Ac("cc.animation.VectorTrack")((kY=function(e){function t(){var t;se(t=e.call(this)||this,"_channels",GY,re(t)),se(t,"_nComponents",UY,re(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new tK(new cf);i.name=mK[n],t._channels[n]=i}return t}Z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[YY]=function(){switch(this._nComponents){default:case 2:return new gK(oK(this._channels[0].curve),oK(this._channels[1].curve));case 3:return new yK(oK(this._channels[0].curve),oK(this._channels[1].curve),oK(this._channels[2].curve));case 4:return new xK(oK(this._channels[0].curve),oK(this._channels[1].curve),oK(this._channels[2].curve),oK(this._channels[3].curve))}},J(t,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}}]),t}(eK),GY=ce((VY=kY).prototype,"_channels",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),UY=ce(VY.prototype,"_nComponents",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),zY=VY))||zY,gK=function(){function e(e,t){this._result=new Yn,this._x=e,this._y=t}return e.prototype.evaluate=function(e,t){return this._x&&this._y||!t.getValue||Yn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result},e}(),yK=function(){function e(e,t,n){this._result=new Pn,this._x=e,this._y=t,this._z=n}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z||!t.getValue||Pn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result},e}(),xK=function(){function e(e,t,n,i){this._result=new Zn,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Zn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result},e}(),SK=Ac("cc.animation.QuatTrack")(aK=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.createCurve=function(){return new Yf},n[YY]=function(){return new CK(this.channels()[0].curve)},t}(nK))||aK,CK=function(){function e(e){this._result=new Ln,this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e,this._result),this._result},e}(),AK=["Red","Green","Blue","Alpha"],bK=Ac("cc.animation.ColorTrack")((uK=function(e){function t(){var t;se(t=e.call(this)||this,"_channels",lK,re(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new tK(new cf);i.name=AK[n],t._channels[n]=i}return t}Z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[YY]=function(){return new TK(oK(this._channels[0].curve),oK(this._channels[1].curve),oK(this._channels[2].curve),oK(this._channels[3].curve))},t}(eK),lK=ce((cK=uK).prototype,"_channels",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),sK=cK))||sK,TK=function(){function e(e,t,n,i){this._result=new wn,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||wn.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result},e}(),EK=["Width","Height"],wK=Ac("cc.animation.SizeTrack")((dK=function(e){function t(){var t;se(t=e.call(this)||this,"_channels",fK,re(t)),t._channels=new Array(2);for(var n=0;n<t._channels.length;++n){var i=new tK(new cf);i.name=EK[n],t._channels[n]=i}return t}Z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[YY]=function(){return new IK(oK(this._channels[0].curve),oK(this._channels[1].curve))},t}(eK),fK=ce((_K=dK).prototype,"_channels",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hK=_K))||hK,IK=function(){function e(e,t){this._result=new ti,this._width=e,this._height=t}return e.prototype.evaluate=function(e,t){if((!this._width||!this._height)&&t.getValue){var n=t.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result},e}(),PK=Ac("cc.animation.ObjectTrack")(pK=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.prototype.createCurve=function(){return new rd},t}(nK))||pK;e("animation",Object.freeze({__proto__:null,UniformProxyFactory:hY,MorphWeightValueProxy:_Y,MorphWeightsValueProxy:fY,MorphWeightsAllValueProxy:dY,Track:eK,TrackPath:ZY,RealTrack:rK,VectorTrack:vK,QuatTrack:SK,ColorTrack:bK,SizeTrack:wK,ObjectTrack:PK,isPropertyPath:GX,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:lY,ComponentPath:uY,CubicSplineVec2Value:HY,CubicSplineVec3Value:jY,CubicSplineVec4Value:WY,CubicSplineQuatValue:qY,CubicSplineNumberValue:XY}));var RK=e("RatioSampler",function(){function e(e){var t,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;for(var i=!0,r=1,o=e.length;r<o;r++)if(t=e[r]-e[r-1],1===r)n=t;else if(Math.abs(t-n)>1e-6){i=!1;break}this._findRatio=i?BK:lc}return e.prototype.sample=function(e){return this._findRatio(this.ratios,e)},e}());l.RatioSampler=RK;var DK=e("AnimCurve",function(){function e(t,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(t.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(t.easingMethods[a])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=HK(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}e.Bezier=function(e){return e};var t=e.prototype;return t.hasLerp=function(){return!!this._lerp},t.valueAt=function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array},t.valueBetween=function(e,t,n,i,r){if(this._lerp){var o=this.types?this.types[t]:this.type,a=r-n,s=(e-n)/a;if(o&&(s=NK(s,o)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],_=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,_,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var f=0;f<this._array.length;++f)this._array[f]=this._values[this._array.length*t+f];return this._array},t.empty=function(){return 0===this._values.length},t.constant=function(){return 1===this._values.length},e}());function OK(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function NK(e,t){if("string"==typeof t){var n=J_[t];n?e=n(e):O(3906,t)}else Array.isArray(t)&&(e=jf(t,e));return e}function BK(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var r=e[n];if(t>r)return n;var o=(t=(t-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}DK.Linear=null,l.AnimCurve=DK,e("EventInfo",function(){function e(){this.events=[]}return e.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},e}()),l.sampleAnimationCurve=OK;var MK,LK,FK,zK,VK,GK,UK,kK,HK=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return un;if("object"==typeof t&&t.constructor){if(t instanceof Ln)return n=new Ln,function(e,t,i){return Ln.slerp(n,e,t,i)};if(t instanceof ct)return function(e){var t=new e;return function(n,i,r){return e.lerp(t,n,i,r),t}}(t.constructor);if(t.constructor===Number)return un;if("function"==typeof t.lerp)return e}var n}}}(),jK=Symbol("BakeNodeCurves"),WK=function(){function e(){}return e.getOrExtract=function(t){var n=e.pool.get(t);if(!n||n.samples!==t.sample){n&&l.director.root.dataPoolManager.releaseAnimationClip(t);var i=Math.ceil(t.sample*t.duration)+1,r=t.sample;n=t[jK](0,r,i),e.pool.set(t,n)}return n},e.destroy=function(t){e.pool.delete(t)},e}();WK.pool=new Map;var qK=Ac("cc.animation.UntypedTrackChannel")((zK=function(e){function t(){var t;return se(t=e.call(this,new cf)||this,"property",FK,re(t)),t}return Z(t,e),t}(tK),FK=ce((LK=zK).prototype,"property",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),MK=LK))||MK,XK=Ac("cc.animation.UntypedTrack")((kK=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_channels",UK,re(t)),t}Z(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[YY]=function(e){var t=this;if(!e.getValue)throw new Error(L(3930));var n=function(e){var n;return null===(n=t._channels.find((function(t){return t.property===e})))||void 0===n?void 0:n.curve},i=e.getValue();switch(!0){default:throw new Error(L(3931));case i instanceof Yn:return new gK(n("x"),n("y"));case i instanceof Pn:return new yK(n("x"),n("y"),n("z"));case i instanceof Zn:return new xK(n("x"),n("y"),n("z"),n("w"));case i instanceof wn:return new TK(n("r"),n("g"),n("b"),n("a"));case i instanceof ti:return new IK(n("width"),n("height"))}},n.addChannel=function(e){var t=new qK;return t.property=e,this._channels.push(t),t},n.upgrade=function(e){var t=this,n=function(e,n){var i=t.channels().find((function(t){return t.property===e}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new vK;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new bK,h=u.channels(),_=h[0],f=h[1],d=h[2],p=h[3];return n("r",_),n("g",f),n("b",d),n("a",p),n("x",_),n("y",f),n("z",d),n("w",p),u;case"size":}return null},t}(eK),UK=ce((GK=kK).prototype,"_channels",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),VK=GK))||VK,YK=function(){function e(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}var t=e.prototype;return t.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},t.toTracks=function(){for(var e,t=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(e,t,n){for(var i,r=new ZY,o=ae(t);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof lY?r.toHierarchy(a.path):a instanceof uY?r.toComponent(a.component):r.toCustomized(a)}e.path=r,e.proxy=n},a=r.map((function(e){var n=new XK;return o(n,e.modifiers,e.valueAdapter),t.push(n),n})),s=function(){var i,r=e.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var _=new JK(s,l.length),f=function(e){o(e,r.modifiers,r.valueAdapter)},d=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(e){return"number"==typeof e})))return R(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return R(3933),"continue";var p=r.modifiers[0],m=a[r.commonTarget].addChannel(p).curve;d=m}!function(){if("number"==typeof u){if(!c.every((function(e){return"number"==typeof e})))return void R(3934);var e;if(d)e=d;else{var n=new rK;f(n),t.push(n),e=n.channel.curve}var i=h?uc.LINEAR:uc.CONSTANT;return e.assignSorted(l,c.map((function(e){return{value:e,interpolationMode:i}}))),void _.convert(e)}if("object"==typeof u)switch(!0){default:break;case KK(c,Yn):case KK(c,Pn):case KK(c,Zn):var r=u instanceof Yn?2:u instanceof Pn?3:4,o=new vK;f(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,p=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?uc.LINEAR:uc.CONSTANT,y=function(e){return{value:e,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(e){return y(e.w)}))),_.convert(v);case 3:m.assignSorted(l,c.map((function(e){return y(e.z)}))),_.convert(m);default:s.assignSorted(l,c.map((function(e){return y(e.x)}))),_.convert(s),p.assignSorted(l,c.map((function(e){return y(e.y)}))),_.convert(p)}return void t.push(o);case KK(c,Ln):var x=new SK;f(x);var S=h?Ff.SLERP:Ff.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(e){return{value:Ln.clone(e),interpolationMode:S}}))),_.convertQuatCurve(x.channel.curve),void t.push(x);case KK(c,wn):var C=new bK;f(C);var A=C.channels(),b=A[0].curve,T=A[1].curve,E=A[2].curve,w=A[3].curve,I=h?uc.LINEAR:uc.CONSTANT,P=function(e){return{value:e,interpolationMode:I}};return b.assignSorted(l,c.map((function(e){return P(e.r)}))),_.convert(b),T.assignSorted(l,c.map((function(e){return P(e.g)}))),_.convert(T),E.assignSorted(l,c.map((function(e){return P(e.b)}))),_.convert(E),w.assignSorted(l,c.map((function(e){return P(e.a)}))),_.convert(w),void t.push(C);case KK(c,ti):var D=new wK;f(D);var O=D.channels(),N=O[0].curve,B=O[1].curve,M=h?uc.LINEAR:uc.CONSTANT,L=function(e){return{value:e,interpolationMode:M}};return N.assignSorted(l,c.map((function(e){return L(e.width)}))),_.convert(N),B.assignSorted(l,c.map((function(e){return L(e.height)}))),_.convert(B),void t.push(D);case KK(c,XY):var F=new rK;f(F);var z=h?uc.CUBIC:uc.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:z}}))),void t.push(F);case KK(c,HY):case KK(c,jY):case KK(c,WY):var V=u instanceof HY?2:u instanceof jY?3:4,G=new vK;f(G),G.componentsCount=V;var U=G.channels(),k=U[0],H=U[1],j=U[2],W=U[3],q=h?uc.LINEAR:uc.CONSTANT,X=function(e,t,n){return{value:e,leftTangent:t,rightTangent:n,interpolationMode:q}};switch(V){case 4:W.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:j.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:k.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),H.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(G);case c.every((function(e){return e instanceof qY})):R(3935)}var Y=new PK;f(Y),Y.channel.curve.assignSorted(l,c),t.push(Y)}()},c=ae(i);!(e=c()).done;)s();return t},t._createPropertyCurves=function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new RK(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new DK(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))},J(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}}]),e}();function KK(e,t){return e.every((function(e){return e instanceof t}))}var JK=function(){function e(e,t){this._easingMethods=void 0;var n=e.easingMethods;Array.isArray(n)?0===n.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(t).fill(e.easingMethod):Array.from({length:t},(function(e,t){var i;return null!==(i=n[t])&&void 0!==i?i:null}))}var t=e.prototype;return t.convert=function(e){var t,n,i,r,o,a,s,c,l,u,h,_,f,d,p,m,v,g,y,x,S,C,A=this._easingMethods;if(A){var b=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(A)&&A.length;for(var T=b-1,E=0;E<T;++E){var w=A[E];w&&(Array.isArray(w)?(t=w,n=e.getKeyframeTime(E),i=e.getKeyframeValue(E),r=e.getKeyframeTime(E+1),o=e.getKeyframeValue(E+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,_=void 0,f=void 0,d=void 0,p=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,C=void 0,s=t[0],c=t[1],l=t[2],u=t[3],h=i.value,_=3*(r-n),f=3*(o.value-h),m=(1-l)*_,v=(1-u)*f,g=1/3,y=(p=c*f)/(d=s*_),x=Math.sqrt(d*d+p*p)*g,S=v/m,C=Math.sqrt(m*m+v*v)*g,i.interpolationMode=uc.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===_c.NONE?_c.RIGHT:a===_c.LEFT?_c.BOTH:a,i.rightTangent=y,i.rightTangentWeight=x,o.tangentWeightMode=function(e){return e===_c.NONE?_c.LEFT:e===_c.RIGHT?_c.BOTH:e}(o.tangentWeightMode),o.leftTangent=S,o.leftTangentWeight=C):QK(w,e,E))}}}},t.convertQuatCurve=function(e){var t=this._easingMethods;if(t){var n=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var i=n-1,r=0;r<i;++r){var o=t[r];o&&(Array.isArray(o)?e.getKeyframeValue(r).easingMethod=o.slice():ZK(o,e,r))}}}},J(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}}]),e}();function QK(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=IJ[e];r===K_.CONSTANT?i.interpolationMode=uc.CONSTANT:(i.interpolationMode=uc.LINEAR,i.easingMethod=r)}function ZK(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=IJ[e];i.easingMethod=r}var $K,eJ,tJ,nJ,iJ,rJ,oJ,aJ,sJ,cJ,lJ,uJ,hJ,_J,fJ,dJ,pJ,mJ,vJ,gJ,yJ,xJ,SJ,CJ,AJ,bJ,TJ,EJ,wJ,IJ={constant:K_.CONSTANT,linear:K_.LINEAR,quadIn:K_.QUAD_IN,quadOut:K_.QUAD_OUT,quadInOut:K_.QUAD_IN_OUT,quadOutIn:K_.QUAD_OUT_IN,cubicIn:K_.CUBIC_IN,cubicOut:K_.CUBIC_OUT,cubicInOut:K_.CUBIC_IN_OUT,cubicOutIn:K_.CUBIC_OUT_IN,quartIn:K_.QUART_IN,quartOut:K_.QUART_OUT,quartInOut:K_.QUART_IN_OUT,quartOutIn:K_.QUART_OUT_IN,quintIn:K_.QUINT_IN,quintOut:K_.QUINT_OUT,quintInOut:K_.QUINT_IN_OUT,quintOutIn:K_.QUINT_OUT_IN,sineIn:K_.SINE_IN,sineOut:K_.SINE_OUT,sineInOut:K_.SINE_IN_OUT,sineOutIn:K_.SINE_OUT_IN,expoIn:K_.EXPO_IN,expoOut:K_.EXPO_OUT,expoInOut:K_.EXPO_IN_OUT,expoOutIn:K_.EXPO_OUT_IN,circIn:K_.CIRC_IN,circOut:K_.CIRC_OUT,circInOut:K_.CIRC_IN_OUT,circOutIn:K_.CIRC_OUT_IN,elasticIn:K_.ELASTIC_IN,elasticOut:K_.ELASTIC_OUT,elasticInOut:K_.ELASTIC_IN_OUT,elasticOutIn:K_.ELASTIC_OUT_IN,backIn:K_.BACK_IN,backOut:K_.BACK_OUT,backInOut:K_.BACK_IN_OUT,backOutIn:K_.BACK_OUT_IN,bounceIn:K_.BOUNCE_IN,bounceOut:K_.BOUNCE_OUT,bounceInOut:K_.BOUNCE_IN_OUT,bounceOutIn:K_.BOUNCE_OUT_IN,smooth:K_.SMOOTH,fade:K_.FADE};function PJ(){throw new Error("split() only valid in Editor.")}Ac("cc.animation.ExoticAnimation")((tJ=function(){function e(){se(this,"_nodeAnimations",eJ,this)}var t=e.prototype;return t.createEvaluator=function(e){return new VJ(this._nodeAnimations,e)},t.addNodeAnimation=function(e){var t=new RJ(e);return this._nodeAnimations.push(t),t},t.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))},t.split=function(){return PJ()},t.toHashString=function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")},e}(),eJ=ce(($K=tJ).prototype,"_nodeAnimations",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$K));var RJ=Ac("cc.animation.ExoticNodeAnimation")((cJ=function(){function e(e){se(this,"_path",rJ,this),se(this,"_position",oJ,this),se(this,"_rotation",aJ,this),se(this,"_scale",sJ,this),this._path=e}var t=e.prototype;return t.createPosition=function(e,t){this._position=new LJ(e,new BJ(t))},t.createRotation=function(e,t){this._rotation=new LJ(e,new MJ(t))},t.createScale=function(e,t){this._scale=new LJ(e,new BJ(t))},t.createEvaluator=function(e){return new GJ(this._path,this._position,this._rotation,this._scale,e)},t.split=function(){return PJ()},t.toHashString=function(){var e,t,n,i,r,o;return this._path+"\n"+(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},J(e,[{key:"path",get:function(){return this._path}}]),e}(),rJ=ce((iJ=cJ).prototype,"_path",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),oJ=ce(iJ.prototype,"_position",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aJ=ce(iJ.prototype,"_rotation",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sJ=ce(iJ.prototype,"_scale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nJ=iJ))||nJ;function DJ(e){return e.toPrecision(2)}function OJ(e){return e.map(DJ).join(" ")}var NJ=Ac("cc.animation.ExoticVectorLikeTrackValues")((fJ=function(){function e(e){se(this,"_values",hJ,this),se(this,"_isQuantized",_J,this),this._values=e,this._isQuantized=!1}var t=e.prototype;return t.quantize=function(e){this._isQuantized,this._values=function(e,t){var n=kJ[t],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),o=Math.max(e,o)}));var a=o-r,s=n.from(e,(function(e){return(e-r)/a*i}));return new iQ(HJ(e),s,a,r)}(this._values,e),this._isQuantized=!0},t.toHashString=function(){var e=this._isQuantized,t=this._values;return e+" "+(e?t.toHashString():OJ(t))},J(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:HJ(this._values)}}]),e}(),hJ=ce((uJ=fJ).prototype,"_values",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_J=ce(uJ.prototype,"_isQuantized",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lJ=uJ))||lJ,BJ=Ac("cc.animation.ExoticVec3TrackValues")(dJ=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?aQ(n,e,t):Pn.fromArray(t,n,3*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(aQ(a,e,i),aQ(a,t,r)):(Pn.fromArray(i,a,3*e),Pn.fromArray(r,a,3*t)),Pn.lerp(o,i,r,n)},t}(NJ))||dJ,MJ=Ac("cc.animation.ExoticQuatTrackValues")(pJ=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?sQ(n,e,t):Ln.fromArray(t,n,4*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(sQ(a,e,i),sQ(a,t,r)):(Ln.fromArray(i,a,4*e),Ln.fromArray(r,a,4*t)),Ln.slerp(o,i,r,n)},t}(NJ))||pJ,LJ=Ac("cc.animation.ExoticTrack")((xJ=function(){function e(e,t){se(this,"times",gJ,this),se(this,"values",yJ,this),this.times=e,this.values=t}return e.prototype.toHashString=function(){var e=this.times,t=this.values;return"times: "+OJ(e)+"; values: "+t.toHashString()},e}(),gJ=ce((vJ=xJ).prototype,"times",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),yJ=ce(vJ.prototype,"values",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),mJ=vJ))||mJ;function FJ(e,t){e.length,e.length;var n=0,i=0,r=lc(e,t);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=e[o],c=e[a];i=(t-c)/(s-c)}return{index:n,ratio:i}}!function(){function e(){this._reset()}var t=e.prototype;t.transformTime=function(e){return e-this._timeOffset},t.calculate=function(e,t,n){this._reset();var i=e.length;if(i){var r=e[0],o=e[i-1],a=cn(t,r,o),s=cn(n,r,o);this._timeOffset=a;var c=function(e,t,n){var i=e.length;n>=t&&t>=e[0]&&e[i-1];var r=FJ(e,t),o=r.index,a=r.ratio,s=FJ(e,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(e,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,_=c.toRatio,f=!u,d=!_;l!==h||u!==_?(f||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=f?l:l+1,this.directKeyframesEnd=h+1,d||(this.postLerpIndex=h,this.postLerpRatio=_)):f?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},t._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},J(e,[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}}])}();var zJ,VJ=function(){function e(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map((function(e){return e.createEvaluator(t)}))}return e.prototype.evaluate=function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))},e}(),GJ=function(){function e(e,t,n,i,r){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=oQ(t.times,t.values,Pn,e,"position",r)),n&&(this._rotation=oQ(n.times,n.values,Ln,e,"rotation",r)),i&&(this._scale=oQ(i.times,i.values,Pn,e,"scale",r))}return e.prototype.evaluate=function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var n=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(i)}},e}(),UJ=function(){function e(e,t,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return e.prototype.evaluate=function(e){var t=this._times,n=this._values,i=this._resultValue;if(0===t.length)return i;var r=function(e,t,n){var i=e.length,r=e[0],o=e[i-1];if(t<r)n.just=!0,n.index=0;else if(t>o)n.just=!0,n.index=i-1;else{var a=lc(e,t);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=e[c],u=e[s],h=(t-e[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(t,e,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},e}(),kJ={uint8:Uint8Array,uint16:Uint16Array};function HJ(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return zJ.FLOAT_32;case 8:return zJ.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}(zJ||(zJ={}));var jJ,WJ,qJ,XJ,YJ,KJ,JJ,QJ,ZJ,$J,eQ,tQ,nQ,iQ=Ac("cc.animation.QuantizedFloatArray")((wJ=function(){function e(e,t,n,i){void 0===i&&(i=0),se(this,"originalPrecision",AJ,this),se(this,"min",bJ,this),se(this,"extent",TJ,this),se(this,"values",EJ,this),this.originalPrecision=e,this.values=t,this.extent=n,this.min=i}return e.prototype.toHashString=function(){var e=this.originalPrecision,t=this.min,n=this.extent,i=this.values;return e+" "+DJ(t)+" "+DJ(n)+" "+i.join(" ")},J(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),e}(),AJ=ce((CJ=wJ).prototype,"originalPrecision",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),bJ=ce(CJ.prototype,"min",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),TJ=ce(CJ.prototype,"extent",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),EJ=ce(CJ.prototype,"values",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),SJ=CJ))||SJ;function rQ(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function oQ(e,t,n,i,r,o){var a=new $Y;a.path=(new ZY).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new UJ(e,t,n)}:null}function aQ(e,t,n){Pn.set(n,rQ(e,3*t+0),rQ(e,3*t+1),rQ(e,3*t+2))}function sQ(e,t,n){Ln.set(n,rQ(e,4*t+0),rQ(e,4*t+1),rQ(e,4*t+2),rQ(e,4*t+3))}function cQ(){return l.director.getAnimationManager()}var lQ=Symbol("SearchForRootBonePath"),uQ=Symbol("ExoticAnimation"),hQ=e("AnimationClip",Ac("cc.AnimationClip")((nQ=tQ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"sample",qJ,re(t)),se(t,"speed",XJ,re(t)),se(t,"wrapMode",YJ,re(t)),se(t,"enableTrsBlending",KJ,re(t)),se(t,"_duration",JJ,re(t)),se(t,"_hash",QJ,re(t)),t.frameRate=0,se(t,"_tracks",ZJ,re(t)),se(t,"_exoticAnimation",$J,re(t)),t._legacyData=void 0,t._legacyDataDirty=!1,se(t,"_events",eQ,re(t)),t._runtimeEvents={ratios:[],eventGroups:[]},t}Z(t,e),t.createWithSpriteFrames=function(e,n){var i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;var r=1/i.sample,o=new PK;return o.path=(new ZY).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),i.addTrack(o),i};var n=t.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var e={min:1/0,max:-1/0},t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e},n.getTrack=function(e){return this._tracks[e]},n.addTrack=function(e){var t=this._tracks.length;return this._tracks.push(e),t},n.removeTrack=function(e){this._tracks.splice(e,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(e){return new yQ(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(e){var t=this,n=e.target;return this._createEvalWithBinder(n,(function(i){if(!e.mask||!i.isMaskedOff(e.mask)){var r=i.createRuntimeBinding(n,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}}),e.rootMotion)},n.destroy=function(){var t;return(null===(t=l.director.root)||void 0===t?void 0:t.dataPoolManager)&&l.director.root.dataPoolManager.releaseAnimationClip(this),WK.destroy(this),e.prototype.destroy.call(this)},n[jK]=function(e,t,n){for(var i=1/t,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new jn}))};var c=r.reduce((function(e,t){return e[t]=new dQ,e}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var _=l.substring(0,h),f=c[_];f&&(u.parent=f)}}for(var d=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var n=c[t.node];if(n)return gQ(n,t.property)}}),void 0),p=0;p<n;++p){var m=e+i*p;d.evaluate(m);for(var v=0;v<o;++v){var g=r[v];jn.copy(a[g].transforms[p],c[g].globalTransform)}for(var y=0;y<o;++y){var x=r[y];c[x].invalidate()}}return{samples:t,frames:n,joints:a}},n.upgradeUntypedTracks=function(e){for(var t=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof XK){var s=a.upgrade(e);s&&(t.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)tt.remove(i,n[l]);i.push.apply(i,t)},n[lQ]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(e,t,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(e,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(e){return 0===e.curve.keyFramesCount}))){var h=t(u[QY]);if(h){var _=u[YY](h);a.push({binding:h,trackEval:_})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(t)),new _Q(a,o,i)},n._createRootMotionEvaluation=function(e,t,n){if(e instanceof nE){var i=this._searchForRootBonePath();if(i){var r=e.getChildByPath(i);if(r){for(var o=new fQ,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[QY].parseTrsPath();if(h&&h.node===i){n.push(u);var _=gQ(o,h.property);if(_){var f=u[YY](_);a.push({binding:_,trackEval:f})}}}return new mQ(r,this._duration,o,a)}R(3924)}else R(3923)}else O(3920)},n._searchForRootBonePath=function(){var e=this._tracks.map((function(e){var t=e[QY].parseTrsPath();if(t){var n=t.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var n=e.length,i=e[t],r=!0,o=t+1;o<n;++o){var a=e[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var e=new YK(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e},n._fromLegacy=function(e){for(var t=e.toTracks(),n=t.length,i=0;i<n;++i)this.addTrack(t[i])},n._collectAnimatedJoints=function(){for(var e=new Set,t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i][QY].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)e.add(o[s]);return Array.from(e)},J(t,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var n="Exotic:"+(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=So(n,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var n=[],i=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),o=r.length,a=function(e){var o=r[e],a=o.frame/t._duration,s=n.findIndex((function(e){return e===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:uQ,get:function(){return this._exoticAnimation}},{key:uQ,set:function(e){this._exoticAnimation=e}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),t}(Iu),tQ.WrapMode=nc,qJ=ce((WJ=nQ).prototype,"sample",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),XJ=ce(WJ.prototype,"speed",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),YJ=ce(WJ.prototype,"wrapMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nc.Normal}}),KJ=ce(WJ.prototype,"enableTrsBlending",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),JJ=ce(WJ.prototype,"_duration",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QJ=ce(WJ.prototype,"_hash",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZJ=ce(WJ.prototype,"_tracks",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$J=ce(WJ.prototype,"_exoticAnimation",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eQ=ce(WJ.prototype,"_events",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jJ=WJ))||jJ);l.AnimationClip=hQ;var _Q=function(){function e(e,t,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=n}var t=e.prototype;return t.evaluate=function(e){for(var t=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=t.length,r=0;r<i;++r){var o=t[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}n&&n.evaluate(e)},t.evaluateRootMotion=function(e,t){var n=this._rootMotionEvaluation;n&&n.evaluate(e,t)},e}(),fQ=function(){function e(){this.position=new Pn,this.scale=new Pn(1,1,1),this.rotation=new Ln,this.eulerAngles=new Pn}return e.prototype.getTransform=function(e){jn.fromRTS(e,this.rotation,this.position,this.scale)},e}(),dQ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).parent=null,t._dirty=!0,t._transform=new jn,t}return Z(t,e),t.prototype.invalidate=function(){this._dirty=!0},J(t,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,jn.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&jn.multiply(e,this.parent.globalTransform,e)),this._transform}}]),t}(fQ),pQ=new jn,mQ=function(){function e(e,t,n,i){this._initialTransformCache=new jn,this._clipEndTransformCache=new jn,this._startTransformCache=new jn,this._endTransformCache=new jn,this._motionTransformCache=new jn,this._translationMotionCache=new Pn,this._rotationMotionCache=new Ln,this._scaleMotionCache=new Pn,this._rootBone=e,this._duration=t,this._boneTransform=n,this._trackEvalStatuses=i}var t=e.prototype;return t.evaluate=function(e,t){var n=this._calcMotionTransform(e,t,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;jn.toRTS(n,r,i,o),Pn.add(i,i,a.position),a.setPosition(i),Ln.multiply(r,r,a.rotation),a.setRotation(r),Pn.multiply(o,o,a.scale),a.setScale(o)},t._calcMotionTransform=function(e,t,n){var i=this._duration,r=i-e,o=this._evaluateAt(e,this._startTransformCache);if(t<r){var a=this._evaluateAt(e+t,this._endTransformCache);vQ(n,o,a)}else{jn.identity(n);var s=function(e,t){vQ(pQ,e,t),jn.multiply(n,n,pQ)},c=t-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),_=this._evaluateAt(i,this._clipEndTransformCache),f=this._evaluateAt(u,this._endTransformCache);s(o,_),vQ(pQ,h,_);for(var d=0;d<l;++d)jn.multiply(n,n,pQ);s(h,f)}return n},t._evaluateAt=function(e,t){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}return this._boneTransform.getTransform(t),t},e}();function vQ(e,t,n){jn.invert(e,t),jn.multiply(e,n,e)}function gQ(e,t){switch(t){default:return;case"position":return{setValue:function(t){Pn.copy(e.position,t)}};case"rotation":return{setValue:function(t){Ln.copy(e.rotation,t)}};case"scale":return{setValue:function(t){Pn.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){Pn.copy(e.eulerAngles,t)}}}}var yQ=function(){function e(e,t,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=n,this._wrapMode=i}var t=e.prototype;return t.setWrapMode=function(e){this._wrapMode=e},t.ignore=function(e,t){this._ignoreIndex=-1,this._sampled=!1;var n=SQ(e,this._ratios);n<0&&(n=~n-1,t<0&&(n+=1),this._ignoreIndex=n)},t.sample=function(e,t,n){var i=this._eventGroups.length,r=SQ(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=t);var o=this._wrapMode,a=xQ(n),s=xQ(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){t=l;do{if(c!==r){if(-1===t&&0===c&&r>0?((o&tc.PingPong)===tc.PingPong?t*=-1:c=i,s++):1===t&&c===i-1&&r<i-1&&((o&tc.PingPong)===tc.PingPong?t*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=t,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=t},t._doFire=function(e,t){t?cQ().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)},t._checkAndFire=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n=t[e],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},e}();function xQ(e){return e-(0|e)==0&&(e-=1),0|e}function SQ(e,t){return lc(t,e)}var CQ,AQ=function(){function e(){this._nodeBlendStates=new Map}var t=e.prototype;return t.createWriter=function(e,t,n,i){var r=this.ref(e,t);return new bQ(e,t,r,n,i)},t.destroyWriter=function(e){var t=e;this.deRef(t.node,t.property)},t.ref=function(e,t){var n=this._nodeBlendStates.get(e);return n||(n=this.createNodeBlendState(),this._nodeBlendStates.set(e,n)),n.refProperty(e,t)},t.deRef=function(e,t){var n=this._nodeBlendStates.get(e);n&&(n.deRefProperty(t),n.empty&&this._nodeBlendStates.delete(e))},t.apply=function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))},e}(),bQ=function(){function e(e,t,n,i,r){this._node=e,this._property=t,this._propertyBlendState=n,this._host=i,this._constants=r}var t=e.prototype;return t.getValue=function(){return this._node[this._property]},t.setValue=function(e){var t=this._propertyBlendState,n=this._host.weight;t.blend(e,n)},J(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),e}();!function(e){e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.EULER_ANGLES=8]="EULER_ANGLES"}(CQ||(CQ={}));var TQ=CQ.POSITION|CQ.ROTATION|CQ.SCALE|CQ.EULER_ANGLES,EQ=function(){function e(){this.refCount=0,this.accumulatedWeight=0,this.result=new Pn}var t=e.prototype;return t.blend=function(e,t){this.accumulatedWeight=BQ(this.result,this.result,this.accumulatedWeight,e,t)},t.reset=function(){this.accumulatedWeight=0,Pn.zero(this.result)},e}(),wQ=function(){function e(){this.refCount=0,this.accumulatedWeight=0,this.result=new Ln}var t=e.prototype;return t.blend=function(e,t){this.accumulatedWeight=MQ(this.result,this.result,this.accumulatedWeight,e,t)},t.reset=function(){this.accumulatedWeight=0,Ln.identity(this.result)},e}(),IQ=function(){function e(){this._transformApplyFlags=0,this._properties={}}var t=e.prototype;return t.refProperty=function(e,t){var n,i,r,o=this._properties;switch(t){default:case"position":case"scale":case"eulerAngles":r=null!==(n=o[t])&&void 0!==n?n:o[t]=this._createVec3BlendState(e[t]);break;case"rotation":r=null!==(i=o[t])&&void 0!==i?i:o[t]=this._createQuatBlendState(e.rotation)}return++r.refCount,r},t.deRefProperty=function(e){var t=this._properties,n=t[e];n&&(--n.refCount,n.refCount>0||delete t[e])},t.apply=function(e){var t,n,i,r=this._transformApplyFlags,o=this._properties,a=o.position,s=o.scale,c=o.rotation,l=o.eulerAngles;r&&(a&&r&CQ.POSITION&&(t=a.result),s&&r&CQ.SCALE&&(n=s.result),l&&r&CQ.EULER_ANGLES&&(i=l.result),c&&r&CQ.ROTATION&&(i=c.result),(i||t||n)&&e.setRTS(i,t,n),this._transformApplyFlags=0)},J(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}}]),e}(),PQ=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.apply=function(t){var n=this._properties,i=n.position,r=n.scale,o=n.rotation,a=n.eulerAngles;i&&i.accumulatedWeight&&(this._transformApplyFlags|=CQ.POSITION,i.accumulatedWeight<1&&i.blend(t.position,1-i.accumulatedWeight)),r&&r.accumulatedWeight&&(this._transformApplyFlags|=CQ.SCALE,r.accumulatedWeight<1&&r.blend(t.scale,1-r.accumulatedWeight)),a&&a.accumulatedWeight&&(this._transformApplyFlags|=CQ.EULER_ANGLES,a.accumulatedWeight<1&&a.blend(t.eulerAngles,1-a.accumulatedWeight)),o&&o.accumulatedWeight&&(this._transformApplyFlags|=CQ.ROTATION,o.accumulatedWeight<1&&o.blend(t.rotation,1-o.accumulatedWeight)),e.prototype.apply.call(this,t),null==i||i.reset(),null==r||r.reset(),null==o||o.reset(),null==a||a.reset()},n._createVec3BlendState=function(){return new EQ},n._createQuatBlendState=function(){return new wQ},t}(IQ),RQ=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.prototype.createNodeBlendState=function(){return new PQ},t}(AQ),DQ=function(){function e(e){this.refCount=0,this.result=new Pn,this._defaultValue=new Pn,this._clipBlendResult=new Pn,this._accumulatedWeight=0,Pn.copy(this._defaultValue,e),Pn.copy(this.result,e)}var t=e.prototype;return t.blend=function(e,t){this._accumulatedWeight=BQ(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,e,t)},t.commitLayerChange=function(e){var t=this.result,n=this._clipBlendResult,i=this._accumulatedWeight;i<1&&this.blend(this._defaultValue,1-i),Pn.lerp(t,t,n,e),Pn.zero(this._clipBlendResult),this._accumulatedWeight=0},t.reset=function(){Pn.copy(this.result,this._defaultValue)},e}(),OQ=function(){function e(e){this.refCount=0,this.result=new Ln,this._defaultValue=new Ln,this._clipBlendResult=new Ln,this._accumulatedWeight=0,Ln.copy(this._defaultValue,e),Ln.copy(this.result,e)}var t=e.prototype;return t.blend=function(e,t){this._accumulatedWeight=MQ(this._clipBlendResult,this._clipBlendResult,this._accumulatedWeight,e,t)},t.commitLayerChange=function(e){var t=this.result,n=this._clipBlendResult,i=this._accumulatedWeight;i<1&&this.blend(this._defaultValue,1-i),Ln.slerp(t,t,n,e),Ln.identity(this._clipBlendResult),this._accumulatedWeight=0},t.reset=function(){Ln.copy(this.result,this._defaultValue)},e}(),NQ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._layerMask=-1>>>0,t}Z(t,e);var n=t.prototype;return n.setLayerMask=function(e){this._layerMask&=~(1<<e)},n.commitLayerChanges=function(e,t){if(this._layerMask&1<<e){var n=this._properties,i=n.position,r=n.scale,o=n.rotation,a=n.eulerAngles;i&&i.commitLayerChange(t),r&&r.commitLayerChange(t),o&&o.commitLayerChange(t),a&&a.commitLayerChange(t)}},n.apply=function(t){this._transformApplyFlags=TQ,e.prototype.apply.call(this,t);var n=this._properties,i=n.position,r=n.scale,o=n.rotation,a=n.eulerAngles;null==i||i.reset(),null==r||r.reset(),null==o||o.reset(),null==a||a.reset()},n._createVec3BlendState=function(e){return new DQ(e)},n._createQuatBlendState=function(e){return new OQ(e)},t}(IQ);function BQ(e,t,n,i,r){var o=n+r;if(1!==r||n){if(o){var a=r/o;Pn.lerp(e,e,i,a)}}else Pn.copy(e,i);return o}function MQ(e,t,n,i,r){var o=n+r;if(1!==r||n){if(o){var a=r/o;Ln.slerp(e,t,i,a)}}else Ln.copy(e,i);return o}!function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;n.setMask=function(e,t){this._nodeBlendStates.forEach((function(n,i){t.has(i)&&n.setLayerMask(e)}))},n.commitLayerChanges=function(e,t){this._nodeBlendStates.forEach((function(n){n.commitLayerChanges(e,t)}))},n.createNodeBlendState=function(){return new NQ}}(AQ);var LQ,FQ,zQ,VQ=[],GQ=new Map;function UQ(e,t){for(var n=0,i=jn.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,VQ[n++]=e,e=e.parent}for(;n>0;){e=VQ[--n],VQ[n]=null;var r=e.node;jn.fromRTS(e.local,r.rotation,r.position,r.scale),i=jn.multiply(e.world,i,e.local)}return i}function kQ(e){for(var t=GQ.get(e.uuid)||null;t;)GQ.delete(t.node.uuid),t=t.parent}var HQ=e("AnimationManager",Ac((zQ=FQ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._anims=new le([]),t._crossFades=new le([]),t._delayEvents=[],t._blendStateBuffer=new RQ,t._sockets=[],t}Z(t,e);var n=t.prototype;return n.addCrossFade=function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)},n.removeCrossFade=function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):O(3907)},n.update=function(e){var t=this._delayEvents,n=this._crossFades,i=this._sockets,r=n.array;for(n.i=0;n.i<r.length;++n.i)r[n.i].update(e);var o=this._anims,a=o.array;for(o.i=0;o.i<a.length;++o.i){var s=a[o.i];s.isMotionless||s.update(e)}this._blendStateBuffer.apply();for(var c=l.director.getTotalFrames(),u=0,h=i.length;u<h;u++){var _=i[u],f=_.target,d=_.transform;f.matrix=UQ(d,c)}for(var p=0,m=t.length;p<m;p++){var v=t[p];v.fn.apply(v.thisArg,v.args)}t.length=0},n.destruct=function(){},n.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},n.removeAnimation=function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):O(3907)},n.pushDelayEvent=function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})},n.addSockets=function(e,t){for(var n=this,i=function(i){var r=t[i];if(n._sockets.find((function(e){return e.target===r.target})))return"continue";var o=e.getChildByPath(r.path),a=r.target&&o&&function(e,t){for(var n,i=null,r=0;e!==t;){var o=e.uuid;if(GQ.has(o)){i=GQ.get(o);break}i={node:e,local:new jn,world:new jn,stamp:-1,parent:null},GQ.set(o,i),VQ[r++]=i,e=e.parent,i=null}for(;r>0;)n=VQ[--r],VQ[r]=null,n.parent=i,i=n;return i}(o,e);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<t.length;++r)i(r)},n.removeSockets=function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){kQ(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},J(t,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(VO),FQ.ID="animation",LQ=zQ))||LQ);$O.on(ZO.EVENT_INIT,(function(){var e=new HQ;$O.registerSystem(HQ.ID,e,VO.Priority.HIGH)})),l.AnimationManager=HQ;var jQ,WQ=function(){function e(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var t=e.prototype;return t.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(L(3912)):(this._isPlaying=!0,this.onPlay())},t.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},t.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},t.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},t.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},t.update=function(){},t.onPlay=function(){},t.onPause=function(){},t.onResume=function(){},t.onStop=function(){},t.onError=function(){},J(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),qQ=function(){function e(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0},t.createPoseWriter=function(e,t,n){var i=this._pose.createWriter(e,t,this,n);return this._blendStateWriters.push(i),i},e}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(jQ||(jQ={})),st(jQ);var XQ=e("AnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=nc.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new cc,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=1,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=t,i._name=n||t&&t.name,i._playbackRange={min:0,max:t.duration},i._playbackDuration=t.duration,t.duration||A("Clip "+t.name+" has zero duration."),i}Z(t,e);var n=t.prototype;return n.initialize=function(e,t,n){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;var i=this._clip;if(this.duration=i.duration,this._invDuration=1/this.duration,this.speed=i.speed,this.wrapMode=i.wrapMode,this.frameRate=i.sample,this._playbackRange.min=0,this._playbackRange.max=i.duration,this._playbackDuration=i.duration,(this.wrapMode&tc.Loop)===tc.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var r,o,a,s=null!==(r=null!=t?t:null===(o=cQ())||void 0===o?void 0:o.blendState)&&void 0!==r?r:null;s&&(this._poseOutput=new qQ(s)),this._clipEval=i.createEvaluator({target:e,pose:null!==(a=this._poseOutput)&&void 0!==a?a:void 0,mask:n})}this._clipEventEval=i.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||cQ().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];cQ().pushDelayEvent(this._emit,this,t)},n.on=function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null},n.once=function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null},n.off=function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)},n.allowLastFrameEvent=function(e){this._allowLastFrame=e},n._setEventTarget=function(e){this._target=e},n.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0;var t,n=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(n.ratio,n.direction)},n.update=function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(jQ.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(jQ.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(jQ.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(jQ.PAUSE,this)},n._sampleCurves=function(e){var t=this._poseOutput,n=this._clipEval;t&&(t.weight=this.weight),n&&n.evaluate(e)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new cc(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(jQ.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(jQ.FINISHED,this))},n.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(e+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(jQ.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(e){var t=this.wrapMode,n=!1;return(t&tc.PingPong)===tc.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&tc.Reverse)===tc.Reverse&&(n=!n),n},n.getWrappedInfo=function(e,t){t=t||new cc;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(e-=n)>0?e/i:-e/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&tc.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=r,t.iterations=a,t},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)},n._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},n._onReplayOrResume=function(){cQ().addAnimation(this)},n._onPauseOrStop=function(){cQ().removeAnimation(this)},J(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&tc.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&tc.ShouldWrap,n=(this.wrapMode&tc.Reverse)===tc.Reverse;this._useSimpleProcess=e===1/0&&!t&&!n}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(WQ));l.AnimationState=XQ;var YQ,KQ,JQ,QQ,ZQ,$Q,eZ,tZ,nZ,iZ,rZ,oZ,aZ,sZ,cZ,lZ,uZ,hZ=function(e){function t(t){var n;return(n=e.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=t?t:cQ(),n}Z(t,e);var n=t.prototype;return n.update=function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);1===t.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){e.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){e.prototype.onPause.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){e.prototype.onResume.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){e.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(e){for(var t=this._managedStates,n=this._fadings,i=0;i<t.length;++i){var r=t[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=e;var l=0===c.easeDuration?1:ln(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var _=n[h];--_.target.reference,_.target.reference<=0&&(_.target.state&&_.target.state.stop(),_e(this._managedStates,_.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},t}(WQ),_Z=function(t){return e({Animation:t,AnimationComponent:t}),t}((YQ=Ac("cc.Animation"),KQ=Uc(),JQ=Tc(99),QQ=Fc(),ZQ=ol([hQ]),$Q=qc(),eZ=ol(hQ),tZ=qc(),nZ=qc(),iZ=ol([hQ]),YQ(rZ=KQ(rZ=JQ(rZ=Lc(rZ=QQ((uZ=lZ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"playOnLoad",aZ,re(t)),t._crossFade=new hZ,t._nameToState=we(!0),se(t,"_clips",sZ,re(t)),se(t,"_defaultClip",cZ,re(t)),t._hasBeenPlayed=!1,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=we(!0)},n.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},n.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&this.doPlayOrCrossFade(n,t)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getState=function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null},n.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},n.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},n.addClip=function(e,t){return fe(this._clips,e)||this._clips.push(e),this.createState(e,t)},n.removeClip=function(e,t){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===e){n=r;break}}if(e===this._defaultClip){if(!t)return void R(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void R(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]},n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return t===jQ.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return t===jQ.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),t===jQ.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(e,t){return new XQ(e,t)},n._doCreateState=function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(jQ.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(e,t){this._crossFade.play(),this._crossFade.crossFade(e,t)},n._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var n=this._nameToState[t];fZ(e,n.clip)&&(n.stop(),delete this._nameToState[t])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(jQ.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(jQ.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},J(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=ae(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=ae(e);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=e.find((function(e){return fZ(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return fZ(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}($l(Ku)),lZ.EventType=jQ,ce((oZ=uZ).prototype,"clips",[ZQ,$Q],Object.getOwnPropertyDescriptor(oZ.prototype,"clips"),oZ.prototype),ce(oZ.prototype,"defaultClip",[eZ,tZ],Object.getOwnPropertyDescriptor(oZ.prototype,"defaultClip"),oZ.prototype),aZ=ce(oZ.prototype,"playOnLoad",[Dc,nZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sZ=ce(oZ.prototype,"_clips",[iZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cZ=ce(oZ.prototype,"_defaultClip",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rZ=oZ))||rZ)||rZ)||rZ)||rZ)||rZ));function fZ(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}l.Animation=_Z,l.AnimationComponent=_Z,nt.setClassAlias(_Z,"cc.AnimationComponent");var dZ,pZ,mZ,vZ=new jn;l.easing=J_,function(e){e.PLAYED="play",e.PAUSED="pause",e.STOPPED="stop",e.SEEKED="seeked",e.ENDED="ended",e.INTERRUPTION_BEGIN="interruptionBegin",e.INTERRUPTION_END="interruptionEnd",e.USER_GESTURE="on_gesture"}(dZ||(dZ={})),function(e){e[e.DOM_AUDIO=0]="DOM_AUDIO",e[e.WEB_AUDIO=1]="WEB_AUDIO",e[e.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",e[e.NATIVE_AUDIO=3]="NATIVE_AUDIO",e[e.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(pZ||(pZ={})),function(e){e[e.INIT=0]="INIT",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.INTERRUPTED=4]="INTERRUPTED"}(mZ||(mZ={}));var gZ,yZ=0;function xZ(e,t){var n;t.invoking||(t.invoking=!0,(n=t.func).call.apply(n,[e].concat(t.args)).then((function(){t.invoking=!1,e._operationQueue.shift(),e._eventTarget.emit(t.id.toString());var n=e._operationQueue[0];n&&xZ(e,n)})).catch((function(){})))}function SZ(e,t,n){var i=n.value;n.value=function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return new Promise((function(t){var r=yZ++,o=e;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),t),xZ(o,o._operationQueue[0])}))}}function CZ(e){return new Promise((function(t){var n=e.play();return void 0===n?t():(n.then(t).catch((function(){var n=function(){e.play().catch((function(){})),t()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var AZ,bZ,TZ=function(){function e(e,t){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=e,e.volume=t}var t=e.prototype;return t.play=function(){var e=this;CZ(this._domAudio).then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e)})).catch((function(){}))},t.stop=function(){this._domAudio.pause()},J(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=e,e&&this._domAudio.addEventListener("ended",e)}}]),e}(),EZ=(ce((gZ=function(){function e(e){var t=this;this._domAudio=void 0,this._state=mZ.INIT,this._onEnded=void 0,this._eventTarget=new au,this._operationQueue=[],this._domAudio=e,hu.on("hide",this._onHide,this),hu.on("show",this._onShow,this),this._onEnded=function(){t.seek(0).catch((function(){})),t._state=mZ.INIT,t._eventTarget.emit(dZ.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var t=e.prototype;return t.destroy=function(){hu.off("hide",this._onHide,this),hu.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(t){n(new e(t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=document.createElement("audio"),r="canplaythrough";hu.os===iu.IOS?r="loadedmetadata":hu.browserType===eu.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),t(i)},c=function(){a(),n("load audio failure - "+e)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=e}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var t=new TZ(e,n);i(t)})).catch(r)}))},t._onHide=function(){var e=this;this._state===mZ.PLAYING&&this.pause().then((function(){e._state=mZ.INTERRUPTED,e._eventTarget.emit(dZ.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===mZ.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(dZ.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){return e=cn(e,0,this.duration),this._domAudio.currentTime=e,Promise.resolve()},t.play=function(){var e=this;return new Promise((function(t){CZ(e._domAudio).then((function(){e._state=mZ.PLAYING,t()})).catch((function(){}))}))},t.pause=function(){return this._domAudio.pause(),this._state=mZ.PAUSED,Promise.resolve()},t.stop=function(){var e=this;return new Promise((function(t){e._domAudio.pause(),e._domAudio.currentTime=0,e._state=mZ.STOPPED,t()}))},t.onInterruptionBegin=function(e){this._eventTarget.on(dZ.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(dZ.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(dZ.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(dZ.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(dZ.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(dZ.ENDED,e)},J(e,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return pZ.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(e){this._domAudio.loop=e}},{key:"volume",get:function(){return this._domAudio.volume},set:function(e){e=ln(e),this._domAudio.volume=e}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),e}()).prototype,"seek",[SZ],Object.getOwnPropertyDescriptor(gZ.prototype,"seek"),gZ.prototype),ce(gZ.prototype,"play",[SZ],Object.getOwnPropertyDescriptor(gZ.prototype,"play"),gZ.prototype),ce(gZ.prototype,"pause",[SZ],Object.getOwnPropertyDescriptor(gZ.prototype,"pause"),gZ.prototype),ce(gZ.prototype,"stop",[SZ],Object.getOwnPropertyDescriptor(gZ.prototype,"stop"),gZ.prototype),gZ),wZ=function(){function e(e){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=e,window.fastGetAudioTimer=function(){return this}.bind(this)}var t=e.prototype;return t.destroy=function(){this._nativeAudio=void 0},t._now=function(){return performance.now()/1e3},t._calculateCurrentTime=function(){var e=this._now()-this._startTime,t=this._startOffset+e;return t>=this.duration&&(this._startTime=this._now(),this._startOffset=0),t%this.duration},t.start=function(){this._isPaused=!1,this._startTime=this._now()},t.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},t.stop=function(){this._isPaused=!0,this._startOffset=0},t.seek=function(e){this._startTime=this._now(),this._startOffset=cn(e,0,this.duration)},J(e,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),e}(),IZ=new(function(){function e(){this._audioBufferDataMap={}}var t=e.prototype;return t.addCache=function(e,t){this._audioBufferDataMap[e]?console.warn("Audio buffer "+e+" has been cached"):this._audioBufferDataMap[e]={usedCount:1,audioBuffer:t}},t.retainCache=function(e){var t=this._audioBufferDataMap[e];t?t.usedCount++:console.warn("Audio buffer cache "+e+" has not been added.")},t.getCache=function(e){var t=this._audioBufferDataMap[e];return null==t?void 0:t.audioBuffer},t.tryReleasingCache=function(e){var t=this._audioBufferDataMap[e];t?--t.usedCount<=0&&delete this._audioBufferDataMap[e]:console.warn("Audio buffer cache "+e+" has not been added.")},e}()),PZ=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,RZ=function(){function e(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),window.fastGetCtxAgent=function(){return this}.bind(this),window.fastGetCtx=function(){return this._context}.bind(this),window.fastGetCtxState=function(){return this._context.state}.bind(this),window.fastRenewCtx=function(){this._context.close(),this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),this._context._fast="fast_"+Date.now(),this.runContext().then(function(){console.log("new context is go"),window.playMusicGame(),console.log("after context is go")}.bind(this))}.bind(this)}var t=e.prototype;return t.decodeAudioData=function(e){var t=this;return new Promise((function(n){var i=t._context.decodeAudioData(e,(function(e){n(e)}),(function(e){console.error("failed to load Web Audio",e)}));null==i||i.catch((function(){}))}))},t.runContext=function(){var e=this;return new Promise((function(t){var n=e._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(t).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else t();else t()}))},t.createBufferSource=function(e,t){var n=this._context.createBufferSource();return void 0!==e&&(n.buffer=e),void 0!==t&&(n.loop=t),n},t.createGain=function(e){void 0===e&&(e=1);var t=this._context.createGain();return this.setGainValue(t,e),t},t.setGainValue=function(e,t){if(e.gain.setTargetAtTime)try{e.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(n){e.gain.setTargetAtTime(t,this._context.currentTime,.01)}else e.gain.value=t},t.connectContext=function(e){this._context&&e.connect(this._context.destination)},J(e,[{key:"currentTime",get:function(){return this._context.currentTime}}]),e}();RZ.support=!!PZ,RZ.support&&(bZ=new RZ);var DZ,OZ,NZ,BZ,MZ,LZ=function(){function e(e,t,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=e.duration,this._url=n,this._bufferSourceNode=bZ.createBufferSource(e,!1);var i=bZ.createGain(t);this._bufferSourceNode.connect(i),bZ.connectContext(i)}var t=e.prototype;return t.play=function(){var e=this;this._bufferSourceNode.start(),bZ.runContext().then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e),e._currentTimer=window.setTimeout((function(){var t;IZ.tryReleasingCache(e._url),null===(t=e.onEnd)||void 0===t||t.call(e)}),1e3*e._duration)})).catch((function(){}))},t.stop=function(){clearTimeout(this._currentTimer),IZ.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},J(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb=e}}]),e}(),FZ=(ce((AZ=function(){function e(e,t){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=mZ.INIT,this._audioTimer=void 0,this._eventTarget=new au,this._operationQueue=[],this._audioBuffer=e,this._audioTimer=new wZ(e),this._gainNode=bZ.createGain(),bZ.connectContext(this._gainNode),this._src=t,hu.on("hide",this._onHide,this),hu.on("show",this._onShow,this),window.arrBGM.push(this)}var t=e.prototype;return t.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),IZ.tryReleasingCache(this._src),hu.off("hide",this._onHide,this),hu.off("show",this._onShow,this)},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(i){n(new e(i,t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=IZ.getCache(e);if(i)return IZ.retainCache(e),void t(i);var r=new XMLHttpRequest,o="load audio failed: "+e+", status: ";r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?bZ.decodeAudioData(r.response).then((function(n){IZ.addCache(e,n),t(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var r=new LZ(e,n,t);i(r)})).catch(r)}))},t._onHide=function(){var e=this;this._state===mZ.PLAYING&&this.pause().then((function(){e._state=mZ.INTERRUPTED,e._eventTarget.emit(dZ.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===mZ.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(dZ.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){var t=this;return new Promise((function(n){t._audioTimer.seek(e),t._state===mZ.PLAYING?t._doPlay().then(n).catch((function(){})):n()}))},t.play=function(){return this._doPlay()},t._doPlay=function(){var e=this;return new Promise((function(t){e._stopSourceNode(),e._sourceNode=bZ.createBufferSource(e._audioBuffer,e.loop),e._sourceNode.connect(e._gainNode),e._sourceNode.start(0,e._audioTimer.currentTime),bZ.runContext().then((function(){e._state=mZ.PLAYING,e._audioTimer.start(),window.clearTimeout(e._currentTimer),e._currentTimer=window.setTimeout((function t(){e.loop?e._currentTimer=window.setTimeout(t,1e3*e._audioBuffer.duration):(e._audioTimer.stop(),e._eventTarget.emit(dZ.ENDED),e._state=mZ.INIT)}),1e3*(e._audioBuffer.duration-e._audioTimer.currentTime)),t()})).catch((function(){}))}))},t._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(e){}},t.pause=function(){return this._state===mZ.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=mZ.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=mZ.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.onInterruptionBegin=function(e){this._eventTarget.on(dZ.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(dZ.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(dZ.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(dZ.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(dZ.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(dZ.ENDED,e)},J(e,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return pZ.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._sourceNode&&(this._sourceNode.loop=e)}},{key:"volume",get:function(){return this._volume},set:function(e){e=ln(e),this._volume=e,bZ.setGainValue(this._gainNode,e)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),e}()).prototype,"seek",[SZ],Object.getOwnPropertyDescriptor(AZ.prototype,"seek"),AZ.prototype),ce(AZ.prototype,"play",[SZ],Object.getOwnPropertyDescriptor(AZ.prototype,"play"),AZ.prototype),ce(AZ.prototype,"pause",[SZ],Object.getOwnPropertyDescriptor(AZ.prototype,"pause"),AZ.prototype),ce(AZ.prototype,"stop",[SZ],Object.getOwnPropertyDescriptor(AZ.prototype,"stop"),AZ.prototype),AZ),zZ=function(){function e(e){this._audio=void 0,this._audio=e}var t=e.prototype;return t.play=function(){this._audio.play()},t.stop=function(){this._audio.stop()},J(e,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(e){this._audio.onPlay=e}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(e){this._audio.onEnd=e}}]),e}(),VZ=function(){function e(e){this._player=void 0,this._player=e}e.load=function(t,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==pZ.DOM_AUDIO&&RZ.support?FZ.load(t).then((function(t){i(new e(t))})).catch((function(){})):(RZ.support||R(5201),EZ.load(t).then((function(t){i(new e(t))})).catch((function(){})))}))};var t=e.prototype;return t.destroy=function(){this._player.destroy()},e.loadNative=function(e,t){return(null==t?void 0:t.audioLoadMode)!==pZ.DOM_AUDIO&&RZ.support?FZ.loadNative(e):(RZ.support||R(5201),EZ.loadNative(e))},e.loadOneShotAudio=function(e,t,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==pZ.DOM_AUDIO&&RZ.support?FZ.loadOneShotAudio(e,t).then((function(e){i(new zZ(e))})).catch(r):(RZ.support||R(5201),EZ.loadOneShotAudio(e,t).then((function(e){i(new zZ(e))})).catch(r))}))},t.seek=function(e){return this._player.seek(e)},t.play=function(){return this._player.play()},t.pause=function(){return this._player.pause()},t.stop=function(){return this._player.stop()},t.onInterruptionBegin=function(e){this._player.onInterruptionBegin(e)},t.offInterruptionBegin=function(e){this._player.offInterruptionBegin(e)},t.onInterruptionEnd=function(e){this._player.onInterruptionEnd(e)},t.offInterruptionEnd=function(e){this._player.offInterruptionEnd(e)},t.onEnded=function(e){this._player.onEnded(e)},t.offEnded=function(e){this._player.offEnded(e)},J(e,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(e){this._player.loop=e}},{key:"volume",get:function(){return this._player.volume},set:function(e){this._player.volume=e}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),e}();VZ.maxAudioChannel=24;var GZ=e("AudioClip",Ac("cc.AudioClip")((MZ=BZ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_duration",NZ,re(t)),t._loadMode=pZ.UNKNOWN_AUDIO,t._meta=null,t._player=null,t}Z(t,e);var n=t.prototype;return n.destroy=function(){var t,n=e.prototype.destroy.call(this);return null===(t=this._player)||void 0===t||t.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(e){var t;null===(t=this._player)||void 0===t||t.seek(e).catch((function(){}))},n.setVolume=function(e){this._player&&(this._player.volume=e)},n.setLoop=function(e){this._player&&(this._player.loop=e)},n.play=function(){var e;null===(e=this._player)||void 0===e||e.play().catch((function(){}))},n.pause=function(){var e;null===(e=this._player)||void 0===e||e.pause().catch((function(){}))},n.stop=function(){var e;null===(e=this._player)||void 0===e||e.stop().catch((function(){}))},n.playOneShot=function(e){void 0===e&&(e=1),this._nativeAsset&&VZ.loadOneShotAudio(this._nativeAsset.url,e).then((function(e){e.play()})).catch((function(){}))},J(t,[{key:"_nativeAsset",get:function(){return this._meta},set:function(e){this._meta=e,e?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=pZ.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:mZ.INIT}}]),t}(Iu),BZ.AudioType=pZ,NZ=ce((OZ=MZ).prototype,"_duration",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ce(OZ.prototype,"_nativeDep",[sl],Object.getOwnPropertyDescriptor(OZ.prototype,"_nativeDep"),OZ.prototype),DZ=OZ))||DZ);function UZ(e,t,n){VZ.load(e,{audioLoadMode:t.audioLoadMode}).then((function(t){var i={player:t,url:e,duration:t.duration,type:t.type};n(null,i)})).catch((function(e){n(e)}))}function kZ(e,t,n,i){var r=new GZ;r._nativeUrl=e,r._nativeAsset=t,r._duration=t.duration,i(null,r)}l.AudioClip=GZ,HN.register({".mp3":UZ,".ogg":UZ,".wav":UZ,".m4a":UZ}),JN.register({".mp3":kZ,".ogg":kZ,".wav":kZ,".m4a":kZ});var HZ,jZ,WZ,qZ,XZ,YZ,KZ,JZ,QZ,ZZ,$Z,e$,t$,n$,i$,r$,o$,a$,s$,c$=new(function(){function e(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[],window.getAudioManager=this}var t=e.prototype;return t._findIndex=function(e,t){return e.findIndex((function(e){return e.audio===t}))},t._tryAddPlaying=function(e,t){var n=this._findIndex(e,t);return n>-1?(e[n].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)},t.addPlaying=function(e){if(e instanceof VZ){if(this._tryAddPlaying(this._audioPlayerInfoList,e))return}else this._tryAddPlaying(this._oneShotAudioInfoList,e)},t._tryRemovePlaying=function(e,t){var n=this._findIndex(e,t);return-1!==n&&(he(e,n),!0)},t.removePlaying=function(e){if(e instanceof VZ){if(this._tryRemovePlaying(this._audioPlayerInfoList,e))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,e)},t.discardOnePlayingIfNeeded=function(){var e;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<VZ.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})):this._audioPlayerInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})),e&&(e.audio.stop(),this.removePlaying(e.audio)))},e}());!function(e){e.STARTED="started",e.ENDED="ended"}(s$||(s$={}));var l$=function(t){return e({AudioSource:t,AudioSourceComponent:t}),t}((HZ=Ac("cc.AudioSource"),jZ=Uc(),WZ=Fc(),qZ=ol(GZ),XZ=ol(GZ),YZ=qc(),KZ=qc(),JZ=qc(),QZ=Xc(),ZZ=qc(),HZ($Z=jZ($Z=WZ((a$=o$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_clip",t$,re(t)),t._player=null,se(t,"_loop",n$,re(t)),se(t,"_playOnAwake",i$,re(t)),se(t,"_volume",r$,re(t)),t._cachedCurrentTime=0,t._operationsBeforeLoading=[],t._isLoaded=!1,t._lastSetClip=null,t}Z(t,e);var n=t.prototype;return n._syncPlayer=function(){var e=this,t=this._clip;this._isLoaded=!1,(this._lastSetClip!==t||window.wasIosDown)&&(t?t._nativeAsset?(this._lastSetClip=t,VZ.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((function(n){e._lastSetClip===t?(e._isLoaded=!0,e._player&&(c$.removePlaying(e._player),e._player.offEnded(),e._player.offInterruptionBegin(),e._player.offInterruptionEnd(),e._player.destroy()),e._player=n,n.onEnded((function(){c$.removePlaying(n),e.node.emit(s$.ENDED,e)})),n.onInterruptionBegin((function(){c$.removePlaying(n)})),n.onInterruptionEnd((function(){c$.addPlaying(n)})),e._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},n.onLoad=function(){window.arrCLIP.push(this),this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var e=this._getRootNode();(null==e?void 0:e._persistNode)||this.pause()},n.onDestroy=function(){var e;this.stop(),null===(e=this._player)||void 0===e||e.destroy(),this._player=null},n._getRootNode=function(){for(var e,t,n=this.node,i=null===(e=n)||void 0===e||null===(t=e.parent)||void 0===t?void 0:t.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var e,t,n=this;this._isLoaded?(c$.discardOnePlayingIfNeeded(),this.state===mZ.PLAYING&&(null===(t=this._player)||void 0===t||t.stop().catch((function(){}))),null===(e=this._player)||void 0===e||e.play().then((function(){c$.addPlaying(n._player),n.node.emit(s$.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.pause().then((function(){c$.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.stop().then((function(){c$.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(e,t){void 0===t&&(t=1),e._nativeAsset?VZ.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then((function(e){c$.discardOnePlayingIfNeeded(),e.onPlay=function(){c$.addPlaying(e)},e.onEnd=function(){c$.removePlaying(e)},e.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var e=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){e._player&&(e._player.loop=e._loop,e._player.volume=e._volume,e._operationsBeforeLoading.forEach((function(t){var n;null===(n=e[t])||void 0===n||n.call(e)})),e._operationsBeforeLoading.length=0)})).catch((function(){}))},J(t,[{key:"clip",get:function(){return this._clip},set:function(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._player&&(this._player.loop=e)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"volume",get:function(){return this._volume},set:function(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=cn(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(e){var t;Number.isNaN(e)?console.warn("illegal audio time!"):(e=cn(e,0,this.duration),this._cachedCurrentTime=e,null===(t=this._player)||void 0===t||t.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._clip)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this._player?this._player.duration:0}},{key:"state",get:function(){return this._player?this._player.state:mZ.INIT}},{key:"playing",get:function(){return this.state===t.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return VZ.maxAudioChannel}}]),t}(Ku),o$.AudioState=mZ,o$.EventType=s$,t$=ce((e$=a$).prototype,"_clip",[qZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),n$=ce(e$.prototype,"_loop",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),i$=ce(e$.prototype,"_playOnAwake",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),r$=ce(e$.prototype,"_volume",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ce(e$.prototype,"clip",[XZ,YZ],Object.getOwnPropertyDescriptor(e$.prototype,"clip"),e$.prototype),ce(e$.prototype,"loop",[KZ],Object.getOwnPropertyDescriptor(e$.prototype,"loop"),e$.prototype),ce(e$.prototype,"playOnAwake",[JZ],Object.getOwnPropertyDescriptor(e$.prototype,"playOnAwake"),e$.prototype),ce(e$.prototype,"volume",[QZ,ZZ],Object.getOwnPropertyDescriptor(e$.prototype,"volume"),e$.prototype),$Z=e$))||$Z)||$Z)||$Z));V(GZ,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:l$,targetName:"AudioSource"}]),U(GZ.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(e){return{name:e,suggest:"please use AudioSource.prototype."+e+" instead"}}))),l.AudioSourceComponent=l$,nt.setClassAlias(l$,"cc.AudioSourceComponent"),l.log=y,l.warn=x,l.error=S,l.assert=C,l._throw=T,l.logID=I,l.warnID=R,l.errorID=O,l.assertID=M,l.debug=W,l.path={join:pu,extname:mu,mainFileName:vu,basename:gu,dirname:yu,changeExtname:xu,changeBasename:Su,_normalize:Cu,stripSep:Au,get sep(){return bu()}};var u$=e("NodePool",function(){function e(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}var t=e.prototype;return t.size=function(){return this._pool.length},t.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},t.put=function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}},t.get=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},e}());l.NodePool=u$,l.renderer=ky;var h$,_$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&io){var n=this._buffers[t];n&&(e[t].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else e[t].type&ro&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},J(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(Ao);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(h$||(h$={}));var f$=function(){function e(){}return e.setInstance=function(t){e._instance=t},J(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function d$(e,t){switch(e){case fi.R8:return t.UNSIGNED_BYTE;case fi.R8SN:return t.BYTE;case fi.R8UI:return t.UNSIGNED_BYTE;case fi.R8I:return t.BYTE;case fi.R16F:return h$.HALF_FLOAT_OES;case fi.R16UI:return t.UNSIGNED_SHORT;case fi.R16I:return t.SHORT;case fi.R32F:return t.FLOAT;case fi.R32UI:return t.UNSIGNED_INT;case fi.R32I:return t.INT;case fi.RG8:return t.UNSIGNED_BYTE;case fi.RG8SN:return t.BYTE;case fi.RG8UI:return t.UNSIGNED_BYTE;case fi.RG8I:return t.BYTE;case fi.RG16F:return h$.HALF_FLOAT_OES;case fi.RG16UI:return t.UNSIGNED_SHORT;case fi.RG16I:return t.SHORT;case fi.RG32F:return t.FLOAT;case fi.RG32UI:return t.UNSIGNED_INT;case fi.RG32I:return t.INT;case fi.RGB8:case fi.SRGB8:return t.UNSIGNED_BYTE;case fi.RGB8SN:return t.BYTE;case fi.RGB8UI:return t.UNSIGNED_BYTE;case fi.RGB8I:return t.BYTE;case fi.RGB16F:return h$.HALF_FLOAT_OES;case fi.RGB16UI:return t.UNSIGNED_SHORT;case fi.RGB16I:return t.SHORT;case fi.RGB32F:return t.FLOAT;case fi.RGB32UI:return t.UNSIGNED_INT;case fi.RGB32I:return t.INT;case fi.BGRA8:case fi.RGBA8:case fi.SRGB8_A8:return t.UNSIGNED_BYTE;case fi.RGBA8SN:return t.BYTE;case fi.RGBA8UI:return t.UNSIGNED_BYTE;case fi.RGBA8I:return t.BYTE;case fi.RGBA16F:return h$.HALF_FLOAT_OES;case fi.RGBA16UI:return t.UNSIGNED_SHORT;case fi.RGBA16I:return t.SHORT;case fi.RGBA32F:return t.FLOAT;case fi.RGBA32UI:return t.UNSIGNED_INT;case fi.RGBA32I:return t.INT;case fi.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case fi.R11G11B10F:return t.FLOAT;case fi.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case fi.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case fi.RGB10A2:return t.UNSIGNED_BYTE;case fi.RGB10A2UI:return t.UNSIGNED_INT;case fi.RGB9E5:return t.UNSIGNED_BYTE;case fi.DEPTH:return t.UNSIGNED_INT;case fi.DEPTH_STENCIL:return h$.UNSIGNED_INT_24_8_WEBGL;case fi.BC1:case fi.BC1_SRGB:case fi.BC2:case fi.BC2_SRGB:case fi.BC3:case fi.BC3_SRGB:case fi.BC4:return t.UNSIGNED_BYTE;case fi.BC4_SNORM:return t.BYTE;case fi.BC5:return t.UNSIGNED_BYTE;case fi.BC5_SNORM:return t.BYTE;case fi.BC6H_SF16:case fi.BC6H_UF16:return t.FLOAT;case fi.BC7:case fi.BC7_SRGB:case fi.ETC_RGB8:case fi.ETC2_RGB8:case fi.ETC2_SRGB8:case fi.ETC2_RGB8_A1:case fi.ETC2_SRGB8_A1:case fi.EAC_R11:return t.UNSIGNED_BYTE;case fi.EAC_R11SN:return t.BYTE;case fi.EAC_RG11:return t.UNSIGNED_BYTE;case fi.EAC_RG11SN:return t.BYTE;case fi.PVRTC_RGB2:case fi.PVRTC_RGBA2:case fi.PVRTC_RGB4:case fi.PVRTC_RGBA4:case fi.PVRTC2_2BPP:case fi.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case fi.ASTC_RGBA_4X4:case fi.ASTC_RGBA_5X4:case fi.ASTC_RGBA_5X5:case fi.ASTC_RGBA_6X5:case fi.ASTC_RGBA_6X6:case fi.ASTC_RGBA_8X5:case fi.ASTC_RGBA_8X6:case fi.ASTC_RGBA_8X8:case fi.ASTC_RGBA_10X5:case fi.ASTC_RGBA_10X6:case fi.ASTC_RGBA_10X8:case fi.ASTC_RGBA_10X10:case fi.ASTC_RGBA_12X10:case fi.ASTC_RGBA_12X12:case fi.ASTC_SRGBA_4X4:case fi.ASTC_SRGBA_5X4:case fi.ASTC_SRGBA_5X5:case fi.ASTC_SRGBA_6X5:case fi.ASTC_SRGBA_6X6:case fi.ASTC_SRGBA_8X5:case fi.ASTC_SRGBA_8X6:case fi.ASTC_SRGBA_8X8:case fi.ASTC_SRGBA_10X5:case fi.ASTC_SRGBA_10X6:case fi.ASTC_SRGBA_10X8:case fi.ASTC_SRGBA_10X10:case fi.ASTC_SRGBA_12X10:case fi.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function p$(e,t){switch(e){case pi.BOOL:return t.BOOL;case pi.BOOL2:return t.BOOL_VEC2;case pi.BOOL3:return t.BOOL_VEC3;case pi.BOOL4:return t.BOOL_VEC4;case pi.INT:return t.INT;case pi.INT2:return t.INT_VEC2;case pi.INT3:return t.INT_VEC3;case pi.INT4:return t.INT_VEC4;case pi.UINT:return t.UNSIGNED_INT;case pi.FLOAT:return t.FLOAT;case pi.FLOAT2:return t.FLOAT_VEC2;case pi.FLOAT3:return t.FLOAT_VEC3;case pi.FLOAT4:return t.FLOAT_VEC4;case pi.MAT2:return t.FLOAT_MAT2;case pi.MAT3:return t.FLOAT_MAT3;case pi.MAT4:return t.FLOAT_MAT4;case pi.SAMPLER2D:return t.SAMPLER_2D;case pi.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),pi.UNKNOWN}}function m$(e){switch(e){case pi.BOOL:case pi.BOOL2:case pi.BOOL3:case pi.BOOL4:case pi.INT:case pi.INT2:case pi.INT3:case pi.INT4:case pi.UINT:return Int32Array;case pi.FLOAT:case pi.FLOAT2:case pi.FLOAT3:case pi.FLOAT4:case pi.MAT2:case pi.MAT3:case pi.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function v$(e,t){switch(e){case t.BOOL:return pi.BOOL;case t.BOOL_VEC2:return pi.BOOL2;case t.BOOL_VEC3:return pi.BOOL3;case t.BOOL_VEC4:return pi.BOOL4;case t.INT:return pi.INT;case t.INT_VEC2:return pi.INT2;case t.INT_VEC3:return pi.INT3;case t.INT_VEC4:return pi.INT4;case t.UNSIGNED_INT:return pi.UINT;case t.FLOAT:return pi.FLOAT;case t.FLOAT_VEC2:return pi.FLOAT2;case t.FLOAT_VEC3:return pi.FLOAT3;case t.FLOAT_VEC4:return pi.FLOAT4;case t.FLOAT_MAT2:return pi.MAT2;case t.FLOAT_MAT3:return pi.MAT3;case t.FLOAT_MAT4:return pi.MAT4;case t.SAMPLER_2D:return pi.SAMPLER2D;case t.SAMPLER_CUBE:return pi.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),pi.UNKNOWN}}function g$(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function y$(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}f$._instance=null;var x$,S$=[512,513,514,515,516,517,518,519],C$=[0,7680,7681,7682,7683,5386,34055,34056],A$=[32774,32778,32779,32775,32776],b$=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(x$||(x$={}));var T$=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},E$=function(e){function t(){var t;return(t=e.call(this,x$.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new ir,t.clearFlag=Ki.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return Z(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(T$),w$=function(e){function t(){var t;return(t=e.call(this,x$.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new eo,t}return Z(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},t}(T$),I$=function(e){function t(){var t;return(t=e.call(this,x$.DRAW)||this).drawInfo=new vr,t}return Z(t,e),t.prototype.clear=function(){},t}(T$),P$=function(e){function t(){var t;return(t=e.call(this,x$.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return Z(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(T$),R$=function(e){function t(){var t;return(t=e.call(this,x$.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return Z(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(T$),D$=function(){function e(){this.cmds=new Wl(1),this.beginRenderPassCmds=new Wl(1),this.bindStatesCmds=new Wl(1),this.drawCmds=new Wl(1),this.updateBufferCmds=new Wl(1),this.copyBufferToTextureCmds=new Wl(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function O$(e,t,n,i,r){if(t.usage&mi.UNIFORM)ArrayBuffer.isView(n)?t.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&mi.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),N$.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),N$.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r))}}var N$={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0},B$=new ir;function M$(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&(B$.x=i.x<<n.lodLevel,B$.y=i.y<<n.lodLevel,B$.width=i.width<<n.lodLevel,B$.height=i.height<<n.lodLevel),n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===B$.x&&c.viewport.top===B$.y&&c.viewport.width===B$.width&&c.viewport.height===B$.height||(s.viewport(B$.x,B$.y,B$.width,B$.height),c.viewport.left=B$.x,c.viewport.top=B$.y,c.viewport.width=B$.width,c.viewport.height=B$.height),c.scissorRect.x===B$.x&&c.scissorRect.y===B$.y&&c.scissorRect.width===B$.width&&c.scissorRect.height===B$.height||(s.scissor(B$.x,B$.y,B$.width,B$.height),c.scissorRect.x=B$.x,c.scissorRect.y=B$.y,c.scissorRect.width=B$.width,c.scissorRect.height=B$.height);var u=r.length;e.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var _=t.colorAttachments[h];if(_.format!==fi.UNKNOWN)switch(_.loadOp){case Bi.LOAD:break;case Bi.CLEAR:c.bs.targets[0].blendColorMask!==Oi.ALL&&s.colorMask(!0,!0,!0,!0);var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT;break;case Bi.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==fi.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Bi.LOAD:break;case Bi.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Bi.DISCARD:}if(no[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Bi.LOAD:break;case Bi.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Bi.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var d=c.bs.targets[0].blendColorMask;if(d!==Oi.ALL){var p=(d&Oi.R)!==Oi.NONE,m=(d&Oi.G)!==Oi.NONE,v=(d&Oi.B)!==Oi.NONE,g=(d&Oi.A)!==Oi.NONE;s.colorMask(p,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function L$(e,t,n,i,r,o){var a,s,c,l=e.gl,u=e.stateCache,h=t&&t.gpuShader,_=!1;if(t&&N$.gpuPipelineState!==t){if(N$.gpuPipelineState=t,N$.glPrimitive=t.glPrimitive,t.gpuShader){var f=t.gpuShader.glProgram;u.glProgram!==f&&(l.useProgram(f),u.glProgram=f,_=!0)}var d=t.rs;if(d){if(u.rs.cullMode!==d.cullMode){switch(d.cullMode){case ki.NONE:l.disable(l.CULL_FACE);break;case ki.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case ki.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=d.cullMode}var p=d.isFrontFaceCCW;u.rs.isFrontFaceCCW!==p&&(l.frontFace(p?l.CCW:l.CW),u.rs.isFrontFaceCCW=p),u.rs.depthBias===d.depthBias&&u.rs.depthBiasSlop===d.depthBiasSlop||(l.polygonOffset(d.depthBias,d.depthBiasSlop),u.rs.depthBias=d.depthBias,u.rs.depthBiasSlop=d.depthBiasSlop),u.rs.lineWidth!==d.lineWidth&&(l.lineWidth(d.lineWidth),u.rs.lineWidth=d.lineWidth)}var m=t.dss;m&&(u.dss.depthTest!==m.depthTest&&(m.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=m.depthTest),u.dss.depthWrite!==m.depthWrite&&(l.depthMask(m.depthWrite),u.dss.depthWrite=m.depthWrite),u.dss.depthFunc!==m.depthFunc&&(l.depthFunc(S$[m.depthFunc]),u.dss.depthFunc=m.depthFunc),u.dss.stencilTestFront===m.stencilTestFront&&u.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=m.stencilTestFront,u.dss.stencilTestBack=m.stencilTestBack),u.dss.stencilFuncFront===m.stencilFuncFront&&u.dss.stencilRefFront===m.stencilRefFront&&u.dss.stencilReadMaskFront===m.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,S$[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),u.dss.stencilFuncFront=m.stencilFuncFront,u.dss.stencilRefFront=m.stencilRefFront,u.dss.stencilReadMaskFront=m.stencilReadMaskFront),u.dss.stencilFailOpFront===m.stencilFailOpFront&&u.dss.stencilZFailOpFront===m.stencilZFailOpFront&&u.dss.stencilPassOpFront===m.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,C$[m.stencilFailOpFront],C$[m.stencilZFailOpFront],C$[m.stencilPassOpFront]),u.dss.stencilFailOpFront=m.stencilFailOpFront,u.dss.stencilZFailOpFront=m.stencilZFailOpFront,u.dss.stencilPassOpFront=m.stencilPassOpFront),u.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,m.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),u.dss.stencilFuncBack===m.stencilFuncBack&&u.dss.stencilRefBack===m.stencilRefBack&&u.dss.stencilReadMaskBack===m.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,S$[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),u.dss.stencilFuncBack=m.stencilFuncBack,u.dss.stencilRefBack=m.stencilRefBack,u.dss.stencilReadMaskBack=m.stencilReadMaskBack),u.dss.stencilFailOpBack===m.stencilFailOpBack&&u.dss.stencilZFailOpBack===m.stencilZFailOpBack&&u.dss.stencilPassOpBack===m.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,C$[m.stencilFailOpBack],C$[m.stencilZFailOpBack],C$[m.stencilPassOpBack]),u.dss.stencilFailOpBack=m.stencilFailOpBack,u.dss.stencilZFailOpBack=m.stencilZFailOpBack,u.dss.stencilPassOpBack=m.stencilPassOpBack),u.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,m.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var v=t.bs;if(v){u.bs.isA2C!==v.isA2C&&(v.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=v.isA2C),u.bs.blendColor.x===v.blendColor.x&&u.bs.blendColor.y===v.blendColor.y&&u.bs.blendColor.z===v.blendColor.z&&u.bs.blendColor.w===v.blendColor.w||(l.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),u.bs.blendColor.x=v.blendColor.x,u.bs.blendColor.y=v.blendColor.y,u.bs.blendColor.z=v.blendColor.z,u.bs.blendColor.w=v.blendColor.w);var g=v.targets[0],y=u.bs.targets[0];y.blend!==g.blend&&(g.blend?l.enable(l.BLEND):l.disable(l.BLEND),y.blend=g.blend),y.blendEq===g.blendEq&&y.blendAlphaEq===g.blendAlphaEq||(l.blendEquationSeparate(A$[g.blendEq],A$[g.blendAlphaEq]),y.blendEq=g.blendEq,y.blendAlphaEq=g.blendAlphaEq),y.blendSrc===g.blendSrc&&y.blendDst===g.blendDst&&y.blendSrcAlpha===g.blendSrcAlpha&&y.blendDstAlpha===g.blendDstAlpha||(l.blendFuncSeparate(b$[g.blendSrc],b$[g.blendDst],b$[g.blendSrcAlpha],b$[g.blendDstAlpha]),y.blendSrc=g.blendSrc,y.blendDst=g.blendDst,y.blendSrcAlpha=g.blendSrcAlpha,y.blendDstAlpha=g.blendDstAlpha),y.blendColorMask!==g.blendColorMask&&(l.colorMask((g.blendColorMask&Oi.R)!==Oi.NONE,(g.blendColorMask&Oi.G)!==Oi.NONE,(g.blendColorMask&Oi.B)!==Oi.NONE,(g.blendColorMask&Oi.A)!==Oi.NONE),y.blendColorMask=g.blendColorMask)}}if(t&&t.gpuPipelineLayout&&h){for(var x=h.glBlocks.length,C=t.gpuPipelineLayout.dynamicOffsetIndices,A=0;A<x;A++){var b=h.glBlocks[A],T=i[b.set],E=T&&T.descriptorIndices[b.binding],w=E>=0&&T.gpuDescriptors[E],I=null,P=0;if(w&&w.gpuBuffer){var R=w.gpuBuffer,D=C[b.set],O=D&&D[b.binding];O>=0&&(P=r[O]),"vf32"in R?I=R.vf32:(P+=R.offset,I=R.gpuBuffer.vf32),P>>=2}if(I)for(var N=b.glActiveUniforms.length,B=0;B<N;B++){var M=b.glActiveUniforms[B];switch(M.glType){case l.BOOL:case l.INT:for(var L=0;L<M.array.length;++L){var F=M.offset+P+L;if(I[F]!==M.array[L]){for(var z=L,V=F;z<M.array.length;++z,++V)M.array[z]=I[V];l.uniform1iv(M.glLoc,M.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var G=0;G<M.array.length;++G){var U=M.offset+P+G;if(I[U]!==M.array[G]){for(var k=G,H=U;k<M.array.length;++k,++H)M.array[k]=I[H];l.uniform2iv(M.glLoc,M.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var j=0;j<M.array.length;++j){var W=M.offset+P+j;if(I[W]!==M.array[j]){for(var q=j,X=W;q<M.array.length;++q,++X)M.array[q]=I[X];l.uniform3iv(M.glLoc,M.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<M.array.length;++Y){var K=M.offset+P+Y;if(I[K]!==M.array[Y]){for(var J=Y,Q=K;J<M.array.length;++J,++Q)M.array[J]=I[Q];l.uniform4iv(M.glLoc,M.array);break}}break;case l.FLOAT:for(var Z=0;Z<M.array.length;++Z){var $=M.offset+P+Z;if(I[$]!==M.array[Z]){for(var ee=Z,te=$;ee<M.array.length;++ee,++te)M.array[ee]=I[te];l.uniform1fv(M.glLoc,M.array);break}}break;case l.FLOAT_VEC2:for(var ne=0;ne<M.array.length;++ne){var ie=M.offset+P+ne;if(I[ie]!==M.array[ne]){for(var re=ne,oe=ie;re<M.array.length;++re,++oe)M.array[re]=I[oe];l.uniform2fv(M.glLoc,M.array);break}}break;case l.FLOAT_VEC3:for(var ae=0;ae<M.array.length;++ae){var se=M.offset+P+ae;if(I[se]!==M.array[ae]){for(var ce=ae,le=se;ce<M.array.length;++ce,++le)M.array[ce]=I[le];l.uniform3fv(M.glLoc,M.array);break}}break;case l.FLOAT_VEC4:for(var ue=0;ue<M.array.length;++ue){var he=M.offset+P+ue;if(I[he]!==M.array[ue]){for(var _e=ue,fe=he;_e<M.array.length;++_e,++fe)M.array[_e]=I[fe];l.uniform4fv(M.glLoc,M.array);break}}break;case l.FLOAT_MAT2:for(var de=0;de<M.array.length;++de){var pe=M.offset+P+de;if(I[pe]!==M.array[de]){for(var me=de,ve=pe;me<M.array.length;++me,++ve)M.array[me]=I[ve];l.uniformMatrix2fv(M.glLoc,!1,M.array);break}}break;case l.FLOAT_MAT3:for(var ge=0;ge<M.array.length;++ge){var ye=M.offset+P+ge;if(I[ye]!==M.array[ge]){for(var xe=ge,Se=ye;xe<M.array.length;++xe,++Se)M.array[xe]=I[Se];l.uniformMatrix3fv(M.glLoc,!1,M.array);break}}break;case l.FLOAT_MAT4:for(var Ce=0;Ce<M.array.length;++Ce){var Ae=M.offset+P+Ce;if(I[Ae]!==M.array[Ce]){for(var be=Ce,Te=Ae;be<M.array.length;++be,++Te)M.array[be]=I[Te];l.uniformMatrix4fv(M.glLoc,!1,M.array);break}}}}else S("Buffer binding '"+b.name+"' at set "+b.set+" binding "+b.binding+" is not bounded")}for(var Ee=h.glSamplerTextures.length,we=0;we<Ee;we++)for(var Ie=h.glSamplerTextures[we],Pe=i[Ie.set],Re=Pe&&Pe.descriptorIndices[Ie.binding],De=Re>=0&&Pe.gpuDescriptors[Re],Oe=Ie.units.length,Ne=0;Ne<Oe;Ne++){var Be=Ie.units[Ne];if(De&&De.gpuSampler){if(De.gpuTexture&&De.gpuTexture.size>0){var Me=De.gpuTexture,Le=u.glTexUnits[Be];Le.glTexture!==Me.glTexture&&(u.texUnit!==Be&&(l.activeTexture(l.TEXTURE0+Be),u.texUnit=Be),Me.glTexture?l.bindTexture(Me.glTarget,Me.glTexture):l.bindTexture(Me.glTarget,e.nullTex2D.gpuTexture.glTexture),Le.glTexture=Me.glTexture);var Fe=De.gpuSampler;Me.isPowerOf2?(a=Fe.glWrapS,s=Fe.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Me.isPowerOf2?Me.mipLevel<=1&&(Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Fe.glMinFilter:Fe.glMinFilter===l.LINEAR||Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Me.glWrapS!==a&&(u.texUnit!==Be&&(l.activeTexture(l.TEXTURE0+Be),u.texUnit=Be),l.texParameteri(Me.glTarget,l.TEXTURE_WRAP_S,a),Me.glWrapS=a),Me.glWrapT!==s&&(u.texUnit!==Be&&(l.activeTexture(l.TEXTURE0+Be),u.texUnit=Be),l.texParameteri(Me.glTarget,l.TEXTURE_WRAP_T,s),Me.glWrapT=s),Me.glMinFilter!==c&&(u.texUnit!==Be&&(l.activeTexture(l.TEXTURE0+Be),u.texUnit=Be),l.texParameteri(Me.glTarget,l.TEXTURE_MIN_FILTER,c),Me.glMinFilter=c),Me.glMagFilter!==Fe.glMagFilter&&(u.texUnit!==Be&&(l.activeTexture(l.TEXTURE0+Be),u.texUnit=Be),l.texParameteri(Me.glTarget,l.TEXTURE_MAG_FILTER,Fe.glMagFilter),Me.glMagFilter=Fe.glMagFilter)}De=Pe.gpuDescriptors[++Re]}else S("Sampler binding '"+Ie.name+"' at set "+Ie.set+" binding "+Ie.binding+" index "+Ne+" is not bounded")}}if(n&&h&&(_||N$.gpuInputAssembler!==n)){N$.gpuInputAssembler=n;var ze=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Ve=e.extensions.OES_vertex_array_object,Ge=n.glVAOs.get(h.glProgram);if(!Ge){var Ue;Ge=Ve.createVertexArrayOES(),n.glVAOs.set(h.glProgram,Ge),Ve.bindVertexArrayOES(Ge),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var ke=h.glInputs.length,He=0;He<ke;He++){var je=h.glInputs[He];Ue=null;for(var We=n.glAttribs.length,qe=0;qe<We;qe++){var Xe=n.glAttribs[qe];if(Xe.name===je.name){Ue=Xe;break}}if(Ue){u.glArrayBuffer!==Ue.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ue.glBuffer),u.glArrayBuffer=Ue.glBuffer);for(var Ye=0;Ye<Ue.componentCount;++Ye){var Ke=je.glLoc+Ye,Je=Ue.offset+Ue.size*Ye;l.enableVertexAttribArray(Ke),u.glCurrentAttribLocs[Ke]=!0,l.vertexAttribPointer(Ke,Ue.count,Ue.glType,Ue.isNormalized,Ue.stride,Je),ze&&ze.vertexAttribDivisorANGLE(Ke,Ue.isInstanced?1:0)}}}var Qe=n.gpuIndexBuffer;Qe&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Qe.glBuffer),Ve.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==Ge&&(Ve.bindVertexArrayOES(Ge),u.glVAO=Ge)}else{for(var Ze=0;Ze<e.capabilities.maxVertexAttributes;++Ze)u.glCurrentAttribLocs[Ze]=!1;for(var $e=h.glInputs.length,et=0;et<$e;et++){for(var tt=h.glInputs[et],nt=null,it=n.glAttribs.length,rt=0;rt<it;rt++){var ot=n.glAttribs[rt];if(ot.name===tt.name){nt=ot;break}}if(nt){u.glArrayBuffer!==nt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,nt.glBuffer),u.glArrayBuffer=nt.glBuffer);for(var at=0;at<nt.componentCount;++at){var st=tt.glLoc+at,ct=nt.offset+nt.size*at;!u.glEnabledAttribLocs[st]&&st>=0&&(l.enableVertexAttribArray(st),u.glEnabledAttribLocs[st]=!0),u.glCurrentAttribLocs[st]=!0,l.vertexAttribPointer(st,nt.count,nt.glType,nt.isNormalized,nt.stride,ct),ze&&ze.vertexAttribDivisorANGLE(st,nt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&u.glElementArrayBuffer!==lt.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,lt.glBuffer),u.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.capabilities.maxVertexAttributes;++ut)u.glEnabledAttribLocs[ut]!==u.glCurrentAttribLocs[ut]&&(l.disableVertexAttribArray(ut),u.glEnabledAttribLocs[ut]=!1)}}if(t&&t.dynamicStates.length)for(var ht=t.dynamicStates.length,_t=0;_t<ht;_t++)switch(t.dynamicStates[_t]){case Hi.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case Hi.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case Hi.BLEND_CONSTANTS:var ft=o.blendConstant;u.bs.blendColor.x===ft.x&&u.bs.blendColor.y===ft.y&&u.bs.blendColor.z===ft.z&&u.bs.blendColor.w===ft.w||(l.blendColor(ft.x,ft.y,ft.z,ft.w),u.bs.blendColor.copy(ft));break;case Hi.STENCIL_WRITE_MASK:var dt=o.stencilStatesFront,pt=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==dt.writeMask&&(l.stencilMaskSeparate(l.FRONT,dt.writeMask),u.dss.stencilWriteMaskFront=dt.writeMask),u.dss.stencilWriteMaskBack!==pt.writeMask&&(l.stencilMaskSeparate(l.BACK,pt.writeMask),u.dss.stencilWriteMaskBack=pt.writeMask);break;case Hi.STENCIL_COMPARE_MASK:var mt=o.stencilStatesFront,vt=o.stencilStatesBack;u.dss.stencilRefFront===mt.reference&&u.dss.stencilReadMaskFront===mt.compareMask||(l.stencilFuncSeparate(l.FRONT,S$[u.dss.stencilFuncFront],mt.reference,mt.compareMask),u.dss.stencilRefFront=mt.reference,u.dss.stencilReadMaskFront=mt.compareMask),u.dss.stencilRefBack===vt.reference&&u.dss.stencilReadMaskBack===vt.compareMask||(l.stencilFuncSeparate(l.BACK,S$[u.dss.stencilFuncBack],vt.reference,vt.compareMask),u.dss.stencilRefBack=vt.reference,u.dss.stencilReadMaskBack=vt.compareMask)}}function F$(e,t){var n=e.gl,i=e.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=N$.gpuInputAssembler,s=N$.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var _=0;_<l.drawCount;_++)l.instances[_]&&r?r.drawArraysInstancedANGLE(s,l.offsets[_],l.counts[_],l.instances[_]):n.drawArrays(s,l.offsets[_],l.counts[_])}else if(t.instanceCount&&r)if(c){if(t.indexCount>0){var f=t.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,t.indexCount,a.glIndexType,f,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstancedANGLE(s,t.firstVertex,t.vertexCount,t.instanceCount);else if(c){if(t.indexCount>0){var d=t.firstIndex*c.stride;n.drawElements(s,t.indexCount,a.glIndexType,d)}}else t.vertexCount>0&&n.drawArrays(s,t.firstVertex,t.vertexCount)}}var z$=new Array(x$.COUNT);function V$(e,t){z$.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=z$[i]++;switch(i){case x$.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];M$(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case x$.BIND_STATES:var a=t.bindStatesCmds.array[r];L$(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case x$.DRAW:F$(e,t.drawCmds.array[r].drawInfo);break;case x$.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];O$(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case x$.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];G$(e,c.buffers,c.gpuTexture,c.regions)}}}function G$(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=no[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];s=_.texExtent.width,c=_.texExtent.height;var f=t[a++];u?n.glInternalFmt===h$.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,n.glInternalFmt,s,c,0,f):r.compressedTexSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,f):r.texSubImage2D(r.TEXTURE_2D,_.texSubres.mipLevel,_.texOffset.x,_.texOffset.y,s,c,n.glFormat,n.glType,f)}break;case r.TEXTURE_CUBE_MAP:for(var d=0;d<i.length;d++){var p=i[d],m=p.texSubres.baseArrayLayer+p.texSubres.layerCount;for(l=p.texSubres.baseArrayLayer;l<m;++l){s=p.texExtent.width,c=p.texExtent.height;var v=t[a++];u?n.glInternalFmt===h$.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,p.texSubres.mipLevel,p.texOffset.x,p.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ci.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var U$=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=o(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),k$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&mi.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new U$,glTarget:0,glBuffer:null},this._usage&mi.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&yi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&mi.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),N$.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&mi.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),N$.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&mi.UNIFORM?(t.glTarget=n.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&mi.INDIRECT||t.usage&mi.TRANSFER_DST||t.usage&mi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(f$.instance,this._gpuBuffer),f$.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),N$.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),N$.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(f$.instance,this._gpuBuffer),f$.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&yi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&mi.VERTEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),N$.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&mi.INDEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),N$.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&mi.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&mi.INDIRECT||t.usage&mi.TRANSFER_DST||t.usage&mi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(f$.instance,this._gpuBuffer),f$.instance.memoryStatus.bufferSize-=t,f$.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&mi.INDIRECT?0:e.byteLength,O$(f$.instance,this._gpuBuffer,e,0,n))},J(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),t}(fo),H$=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Wl(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),j$=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new H$(E$,1),this.bindStatesCmdPool=new H$(w$,1),this.drawCmdPool=new H$(I$,1),this.updateBufferCmdPool=new H$(P$,1),this.copyBufferToTextureCmdPool=new H$(R$,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),W$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new D$,t._cmdAllocator=new j$,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new eo,t._isStateInvalied=!1,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=f$.instance.bindingMappings.blockOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(E$);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea.copy(n),a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(x$.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&ji.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&ji.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&ji.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&ji.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===Yi.PRIMARY&&this._isInRenderPass||this._type===Yi.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(I$);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(x$.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===Yi.PRIMARY&&!this._isInRenderPass||this._type===Yi.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(P$),a=0;e.usage&mi.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(x$.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===Yi.PRIMARY&&!this._isInRenderPass||this._type===Yi.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(R$);r&&(r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(x$.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var _=0;_<i.cmdPackage.copyBufferToTextureCmds.length;++_){var f=i.cmdPackage.copyBufferToTextureCmds.array[_];++f.refCount,this.cmdPackage.copyBufferToTextureCmds.push(f)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(w$);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(x$.BIND_STATES),this._isStateInvalied=!1)},t}(po),q$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=0,n=[],i=0;i<e.colorTextures.length;++i){var r=e.colorTextures[i];r&&(n.push(r.gpuTexture),t=r.lodLevel)}var o=null;e.depthStencilTexture&&(o=e.depthStencilTexture.gpuTexture,t=e.depthStencilTexture.lodLevel);var a=Number.MAX_SAFE_INTEGER,s=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:n,gpuDepthStencilTexture:o,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?a:this.gpuColorTextures[0].width},set width(e){a=e},get height(){return this.isOffscreen?s:this.gpuColorTextures[0].height},set height(e){s=e},lodLevel:t},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var s=t.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=no[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(f$.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=f$.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},J(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(go),X$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=d$(o.format,n),l=no[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:no[o.format].count,stride:s.stride,componentCount:y$(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(f$.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=f$.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.extensions.OES_vertex_array_object,o=e.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),o===i.value&&(r.bindVertexArrayOES(null),o=null),i=n.next();e.stateCache.glVAO=o,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},J(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(Co),Y$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&oo)for(var _=0;_<h.count;_++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},J(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(bo),K$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},J(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(To),J$=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],Q$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:J$[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},J(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Do),Z$=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){M$(f$.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;F$(f$.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=f$.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=f$.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&mi.INDIRECT?0:t.byteLength,O$(f$.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&G$(f$.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];V$(f$.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){L$(f$.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(W$),$$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=e.length,n=0;n<t;n++){var i=e[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Oo),e0=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},J(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(No),t0=[10497,33648,33071,33071],n0=function(e){function t(t,n){var i;(i=e.call(this,t,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===Ei.LINEAR||a===Ei.ANISOTROPIC?c===Ei.LINEAR||c===Ei.ANISOTROPIC?9987:c===Ei.POINT?9985:9729:c===Ei.LINEAR||c===Ei.ANISOTROPIC?9986:c===Ei.POINT?9984:9728,o=s===Ei.LINEAR||s===Ei.ANISOTROPIC?9729:9728;var l=t0[i._info.addressU],u=t0[i._info.addressV],h=t0[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return Z(t,e),J(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Bo),i0=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case Ni.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Ni.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}if(n.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));A("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var _=0;_<h;++_){var f=n.getActiveAttrib(t.glProgram,_);if(f){var d,p=f.name.indexOf("[");d=-1!==p?f.name.substr(0,p):f.name;var m=n.getAttribLocation(t.glProgram,d),v=v$(f.type,n),g=g$(f.type,n);t.glInputs[_]={binding:m,name:d,type:v,stride:g,count:f.size,size:g*f.size,glType:f.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var y=0;y<t.blocks.length;++y){var x=t.blocks[y],S={set:x.set,binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[]};t.glBlocks[y]=S;for(var C=0;C<x.members.length;++C){var b=x.members[C],T=p$(b.type,n),E=g$(T,n),w=E*b.count;S.glUniforms[C]={binding:-1,name:b.name,type:b.type,stride:E,count:b.count,size:w,offset:0,glType:T,glLoc:null,array:null}}}}for(var I=0;I<t.subpassInputs.length;++I){var P=t.subpassInputs[I];t.samplerTextures.push(new Tr(P.set,P.binding,P.name,pi.SAMPLER2D,P.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var R=0;R<t.samplerTextures.length;++R){var D=t.samplerTextures[R];t.glSamplerTextures[R]={set:D.set,binding:D.binding,name:D.name,type:D.type,count:D.count,units:[],glUnits:null,glType:p$(D.type,n),glLoc:null}}}for(var O=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),N=0;N<O;++N){var B=n.getActiveUniform(t.glProgram,N);if(B&&B.type!==n.SAMPLER_2D&&B.type!==n.SAMPLER_CUBE){var M=n.getUniformLocation(t.glProgram,B.name);if(e.extensions.isLocationActive(M)){var L,F=B.name.indexOf("[");L=-1!==F?B.name.substr(0,F):B.name;for(var z=0;z<t.glBlocks.length;z++)for(var V=t.glBlocks[z],G=0;G<V.glUniforms.length;G++){var U=V.glUniforms[G];if(U.name===L){U.glLoc=M,U.count=B.size,U.size=U.stride*U.count,U.array=new(m$(U.type))(U.size/4),V.glActiveUniforms.push(U);break}}}}}for(var k=0;k<t.glBlocks.length;k++)for(var H=t.glBlocks[k],j=0;j<H.glUniforms.length;j++){var W=H.glUniforms[j];W.offset=H.size/4,H.size+=W.size}for(var q=[],X=[],Y=e.bindingMappings,K=e.stateCache.texUnitCacheMap,J=0,Q=0;Q<t.blocks.length;++Q)t.blocks[Q].set===Y.flexibleSet&&J++;for(var Z=0,$=0;$<t.samplerTextures.length;++$){var ee=t.samplerTextures[$],te=n.getUniformLocation(t.glProgram,ee.name);if(e.extensions.isLocationActive(te)&&(q.push(t.glSamplerTextures[$]),X.push(te)),void 0===K[ee.name]){var ne=ee.binding+Y.samplerTextureOffsets[ee.set]+Z;ee.set===Y.flexibleSet&&(ne-=J),K[ee.name]=ne%e.capabilities.maxTextureUnits,Z+=ee.count-1}}if(q.length){for(var ie=[],re=0;re<q.length;++re){var oe=q[re],ae=K[oe.name];if(void 0!==ae){oe.glLoc=X[re];for(var se=0;se<oe.count;++se){for(;ie[ae];)ae=(ae+1)%e.capabilities.maxTextureUnits;oe.units.push(ae),ie[ae]=!0}}}for(var ce=0,le=0;le<q.length;++le){var ue=q[le];if(!e.extensions.isLocationActive(ue.glLoc)){ue.glLoc=X[le];for(var he=0;he<ue.count;++he){for(;ie[ce];)ce=(ce+1)%e.capabilities.maxTextureUnits;void 0===K[ue.name]&&(K[ue.name]=ce),ue.units.push(ce),ie[ce]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var _e=0;_e<q.length;_e++){var fe=q[_e];fe.glUnits=new Int32Array(fe.units),n.uniform1iv(fe.glLoc,fe.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var de=0;de<t.glBlocks.length;)t.glBlocks[de].glActiveUniforms.length?de++:(t.glBlocks[de]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=q}}(f$.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var n=e.gl;if(!e.extensions.destroyShadersImmediately)for(var i=0;i<t.gpuStages.length;i++){var r=t.gpuStages[i];r.glShader&&(n.detachShader(t.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}(f$.instance,this._gpuShader),this._gpuShader=null)},J(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(Mo),r0=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new ur,this.scissorRect=new ir(0,0,0,0),this.rs=new Eo,this.dss=new wo,this.bs=new Po,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),o0=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t._lodLevel=0,t}Z(t,e);var n=t.prototype;return n.initialize=function(e,t){var n=e,i=e;"texture"in e&&(n=i.texture.info,this._isTextureView=!0),this._info.copy(n),this._isPowerOf2=ao(this._info.width)&&ao(this._info.height),this._size=co(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,this._isTextureView?(this._viewInfo.copy(i),this._lodLevel=i.baseLevel,this._gpuTexture=i.texture._gpuTexture):(this._gpuTexture={type:n.type,format:n.format,usage:n.usage,width:n.width,height:n.height,depth:n.depth,size:this._size,arrayLayer:n.layerCount,mipLevel:n.levelCount,samples:n.samples,flags:n.flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},function(e,t){var n=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case fi.A8:return t.ALPHA;case fi.L8:return t.LUMINANCE;case fi.LA8:return t.LUMINANCE_ALPHA;case fi.RGB8:case fi.RGB16F:case fi.RGB32F:return t.RGB;case fi.BGRA8:case fi.RGBA8:case fi.SRGB8_A8:case fi.RGBA16F:case fi.RGBA32F:return t.RGBA;case fi.R5G6B5:return t.RGB;case fi.RGB5A1:case fi.RGBA4:return t.RGBA;case fi.DEPTH:return t.DEPTH_COMPONENT;case fi.DEPTH_STENCIL:return t.DEPTH_STENCIL;case fi.BC1:return h$.COMPRESSED_RGB_S3TC_DXT1_EXT;case fi.BC1_ALPHA:return h$.COMPRESSED_RGBA_S3TC_DXT1_EXT;case fi.BC1_SRGB:return h$.COMPRESSED_SRGB_S3TC_DXT1_EXT;case fi.BC1_SRGB_ALPHA:return h$.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case fi.BC2:return h$.COMPRESSED_RGBA_S3TC_DXT3_EXT;case fi.BC2_SRGB:return h$.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case fi.BC3:return h$.COMPRESSED_RGBA_S3TC_DXT5_EXT;case fi.BC3_SRGB:return h$.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case fi.ETC_RGB8:return h$.COMPRESSED_RGB_ETC1_WEBGL;case fi.ETC2_RGB8:return h$.COMPRESSED_RGB8_ETC2;case fi.ETC2_SRGB8:return h$.COMPRESSED_SRGB8_ETC2;case fi.ETC2_RGB8_A1:return h$.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fi.ETC2_SRGB8_A1:return h$.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case fi.ETC2_RGBA8:return h$.COMPRESSED_RGBA8_ETC2_EAC;case fi.ETC2_SRGB8_A8:return h$.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case fi.EAC_R11:return h$.COMPRESSED_R11_EAC;case fi.EAC_R11SN:return h$.COMPRESSED_SIGNED_R11_EAC;case fi.EAC_RG11:return h$.COMPRESSED_RG11_EAC;case fi.EAC_RG11SN:return h$.COMPRESSED_SIGNED_RG11_EAC;case fi.PVRTC_RGB2:return h$.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case fi.PVRTC_RGBA2:return h$.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case fi.PVRTC_RGB4:return h$.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case fi.PVRTC_RGBA4:return h$.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case fi.ASTC_RGBA_4X4:return h$.COMPRESSED_RGBA_ASTC_4x4_KHR;case fi.ASTC_RGBA_5X4:return h$.COMPRESSED_RGBA_ASTC_5x4_KHR;case fi.ASTC_RGBA_5X5:return h$.COMPRESSED_RGBA_ASTC_5x5_KHR;case fi.ASTC_RGBA_6X5:return h$.COMPRESSED_RGBA_ASTC_6x5_KHR;case fi.ASTC_RGBA_6X6:return h$.COMPRESSED_RGBA_ASTC_6x6_KHR;case fi.ASTC_RGBA_8X5:return h$.COMPRESSED_RGBA_ASTC_8x5_KHR;case fi.ASTC_RGBA_8X6:return h$.COMPRESSED_RGBA_ASTC_8x6_KHR;case fi.ASTC_RGBA_8X8:return h$.COMPRESSED_RGBA_ASTC_8x8_KHR;case fi.ASTC_RGBA_10X5:return h$.COMPRESSED_RGBA_ASTC_10x5_KHR;case fi.ASTC_RGBA_10X6:return h$.COMPRESSED_RGBA_ASTC_10x6_KHR;case fi.ASTC_RGBA_10X8:return h$.COMPRESSED_RGBA_ASTC_10x8_KHR;case fi.ASTC_RGBA_10X10:return h$.COMPRESSED_RGBA_ASTC_10x10_KHR;case fi.ASTC_RGBA_12X10:return h$.COMPRESSED_RGBA_ASTC_12x10_KHR;case fi.ASTC_RGBA_12X12:return h$.COMPRESSED_RGBA_ASTC_12x12_KHR;case fi.ASTC_SRGBA_4X4:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case fi.ASTC_SRGBA_5X4:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case fi.ASTC_SRGBA_5X5:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case fi.ASTC_SRGBA_6X5:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case fi.ASTC_SRGBA_6X6:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case fi.ASTC_SRGBA_8X5:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case fi.ASTC_SRGBA_8X6:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case fi.ASTC_SRGBA_8X8:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case fi.ASTC_SRGBA_10X5:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case fi.ASTC_SRGBA_10X6:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case fi.ASTC_SRGBA_10X8:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case fi.ASTC_SRGBA_10X10:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case fi.ASTC_SRGBA_12X10:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case fi.ASTC_SRGBA_12X12:return h$.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=d$(t.format,n);var i=t.width,r=t.height;switch(t.type){case xi.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&O(9100,o,e.capabilities.maxTextureSize),e.textureExclusive[t.format]||e.extensions.WEBGL_depth_texture||!no[t.format].hasDepth){if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),no[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=so(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}}else t.glInternalFmt=function(e,t){switch(e){case fi.R5G6B5:return t.RGB565;case fi.RGB5A1:return t.RGB5_A1;case fi.RGBA4:return t.RGBA4;case fi.RGBA16F:return h$.RGBA16F_EXT;case fi.RGBA32F:return h$.RGBA32F_EXT;case fi.SRGB8_A8:return h$.SRGB8_ALPHA8_EXT;case fi.DEPTH:return t.DEPTH_COMPONENT16;case fi.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r));break;case xi.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>e.capabilities.maxCubeMapTextureSize&&O(9100,h,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),no[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=so(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=xi.TEX2D,t.glTarget=n.TEXTURE_2D}}(f$.instance,this._gpuTexture),f$.instance.memoryStatus.textureSize+=this._size,this._viewInfo.texture=this,this._viewInfo.type=e.type,this._viewInfo.format=e.format,this._viewInfo.baseLevel=0,this._viewInfo.levelCount=e.levelCount,this._viewInfo.baseLayer=0,this._viewInfo.layerCount=e.layerCount)},n.destroy=function(){!this._isTextureView&&this._gpuTexture&&(function(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var o=0;o<i.length;o++)i[o].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(t.glTarget,null),i[o].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var a=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),a===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),t.glRenderbuffer=null}}(f$.instance,this._gpuTexture),f$.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,n){if(this._info.width!==e||this._info.height!==n){this._info.levelCount===t.getLevelCount(this._info.width,this._info.height)?this._info.levelCount=t.getLevelCount(e,n):this._info.levelCount>1&&(this._info.levelCount=Math.min(this._info.levelCount,t.getLevelCount(e,n)));var i=this._size;this._info.width=e,this._info.height=n,this._size=co(this._info.format,this.width,this.height,this.depth,this._info.levelCount)*this._info.layerCount,!this._isTextureView&&this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=n,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case xi.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&O(9100,o,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r);else if(t.glTexture){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),no[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=so(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case xi.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&O(9100,h,e.capabilities.maxTextureSize);var _=e.stateCache.glTexUnits[e.stateCache.texUnit];if(_.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),_.glTexture=t.glTexture),no[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var d=0;d<t.mipLevel;++d){var p=so(t.format,i,r,1),m=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,d,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=xi.TEX2D,t.glTarget=n.TEXTURE_2D}}}(f$.instance,this._gpuTexture),f$.instance.memoryStatus.textureSize-=i,f$.instance.memoryStatus.textureSize+=this._size)}},n.initAsSwapchainTexture=function(e){var t=new xr;t.format=e.format,t.usage=no[e.format].hasDepth?Si.DEPTH_STENCIL_ATTACHMENT:Si.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},J(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}},{key:"lodLevel",get:function(){return this._lodLevel}}]),t}(Lo),a0="webglcontextlost";function s0(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function c0(e){var t={EXT_texture_filter_anisotropic:s0(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:s0(e,"EXT_blend_minmax"),EXT_frag_depth:s0(e,"EXT_frag_depth"),EXT_shader_texture_lod:s0(e,"EXT_shader_texture_lod"),EXT_sRGB:s0(e,"EXT_sRGB"),OES_vertex_array_object:s0(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:s0(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:s0(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:s0(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:s0(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:s0(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:s0(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:s0(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:s0(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:s0(e,"WEBGL_draw_buffers"),WEBGL_lose_context:s0(e,"WEBGL_lose_context"),WEBGL_depth_texture:s0(e,"WEBGL_depth_texture"),OES_texture_half_float:s0(e,"OES_texture_half_float"),OES_texture_half_float_linear:s0(e,"OES_texture_half_float_linear"),OES_texture_float:s0(e,"OES_texture_float"),OES_texture_float_linear:s0(e,"OES_texture_float_linear"),OES_standard_derivatives:s0(e,"OES_standard_derivatives"),OES_element_index_uint:s0(e,"OES_element_index_uint"),ANGLE_instanced_arrays:s0(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:s0(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return hu.os===iu.IOS&&14===hu.osMainVersion&&hu.isBrowser||(t.WEBGL_compressed_texture_astc=s0(e,"WEBGL_compressed_texture_astc")),hu.os!==iu.ANDROID&&hu.os!==iu.IOS&&(t.WEBGL_multi_draw=s0(e,"WEBGL_multi_draw")),hu.browserType===eu.UC&&(t.ANGLE_instanced_arrays=null),hu.os===iu.IOS&&hu.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}var l0=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new r0,t.cmdAllocator=new j$,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t}Z(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(a0,this._onWebGLContextLost);var t=f$.instance.gl;this.stateCache.initialize(f$.instance.capabilities.maxTextureUnits,f$.instance.capabilities.maxVertexAttributes),this._extensions=c0(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=fi.RGBA8,i=fi.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=fi.DEPTH_STENCIL:r&&(i=fi.DEPTH),this._colorTexture=new o0,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new o0,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=f$.instance.createTexture(new xr(xi.TEX2D,Si.SAMPLED,fi.RGBA8,2,2,Ci.GEN_MIPMAP)),this.nullTexCube=f$.instance.createTexture(new xr(xi.CUBE,Si.SAMPLED,fi.RGBA8,2,2,Ci.GEN_MIPMAP,6));var a=new lr;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),f$.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,f$.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(a0,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(A("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){R(11e3),x(e)},J(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(vo),u0=e("WebGLDevice",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t._bindingMappings=null,t._textureExclusive=new Array(fi.COUNT),t}Z(t,e);var n=t.prototype;return n.initialize=function(e){f$.setInstance(this),this._gfxAPI=ui.WEBGL;var t=this._bindingMappingInfo=e.bindingMappingInfo,n=[],i=[],r=t.setIndices[0];n[r]=0,i[r]=0;for(var o=1;o<t.setIndices.length;++o){var a=t.setIndices[o],s=t.setIndices[o-1];n[a]=t.maxBlockCounts[s]+n[s],i[a]=t.maxSamplerTextureCounts[s]+i[s]}for(var c=0;c<t.setIndices.length;++c){var l=t.setIndices[c];i[l]-=t.maxBlockCounts[l]}this._bindingMappings={blockOffsets:n,samplerTextureOffsets:i,flexibleSet:t.setIndices[t.setIndices.length-1]};var u=this._context=function(e){var t=null;try{var n={alpha:lt.ENABLE_TRANSPARENT_CANVAS,antialias:lt.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",n)}catch(e){return null}return t}(mo.canvas);if(!u)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Kr(qi.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Yr(this._queue)),this._caps.maxVertexAttributes=u.getParameter(u.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=u.getParameter(u.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=u.getParameter(u.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=u.getParameter(u.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=u.getParameter(u.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=u.getParameter(u.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=u.getParameter(u.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var h=u.getSupportedExtensions(),_="";if(h)for(var f,d=ae(h);!(f=d()).done;)_+=f.value+" ";var p=c0(u);p.WEBGL_debug_renderer_info?(this._renderer=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=u.getParameter(p.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=u.getParameter(u.RENDERER),this._vendor=u.getParameter(u.VENDOR));var m=u.getParameter(u.VERSION);this._features.fill(!1),this.initFormatFeatures(p),p.EXT_blend_minmax&&(this._features[_i.BLEND_MINMAX]=!0),p.OES_element_index_uint&&(this._features[_i.ELEMENT_INDEX_UINT]=!0),p.ANGLE_instanced_arrays&&(this._features[_i.INSTANCED_ARRAYS]=!0),p.WEBGL_draw_buffers&&(this._features[_i.MULTIPLE_RENDER_TARGETS]=!0);var v="";return this.getFormatFeatures(fi.ETC_RGB8)&&(v+="etc1 "),this.getFormatFeatures(fi.ETC2_RGB8)&&(v+="etc2 "),this.getFormatFeatures(fi.BC1)&&(v+="dxt "),this.getFormatFeatures(fi.PVRTC_RGB2)&&(v+="pvrtc "),this.getFormatFeatures(fi.ASTC_RGBA_4X4)&&(v+="astc "),A("WebGL device initialized."),A("RENDERER: "+this._renderer),A("VENDOR: "+this._vendor),A("VERSION: "+m),A("COMPRESSED_FORMAT: "+v),A("EXTENSIONS: "+_),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.initFormatFeatures=function(e){this._formatFeatures.fill(Ai.NONE),this._textureExclusive.fill(!0);var t=Ai.RENDER_TARGET|Ai.SAMPLED_TEXTURE|Ai.LINEAR_FILTER;this._formatFeatures[fi.RGB8]=t,this._formatFeatures[fi.R5G6B5]=t,this._textureExclusive[fi.R5G6B5]=!1,this._formatFeatures[fi.RGBA8]=t,this._formatFeatures[fi.RGBA4]=t,this._textureExclusive[fi.RGBA4]=!1,this._formatFeatures[fi.RGB5A1]=t,this._textureExclusive[fi.RGB5A1]=!1,this._formatFeatures[fi.DEPTH]=Ai.RENDER_TARGET,this._textureExclusive[fi.DEPTH]=!1,this._formatFeatures[fi.DEPTH_STENCIL]=Ai.RENDER_TARGET,this._textureExclusive[fi.DEPTH_STENCIL]=!1,this._formatFeatures[fi.R8I]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RG8I]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RGB8I]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RGBA8I]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.R8UI]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RG8UI]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RGB8UI]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RGBA8UI]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.R8I]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RG8I]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RGB8I]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RGBA8I]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.R8UI]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RG8UI]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RGB8UI]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RGBA8UI]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.R32F]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RG32F]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RGB32F]|=Ai.VERTEX_ATTRIBUTE,this._formatFeatures[fi.RGBA32F]|=Ai.VERTEX_ATTRIBUTE,e.EXT_sRGB&&(this._formatFeatures[fi.SRGB8]=t,this._formatFeatures[fi.SRGB8_A8]=t,this._textureExclusive[fi.SRGB8_A8]=!1),e.WEBGL_depth_texture&&(this._formatFeatures[fi.DEPTH]|=t,this._formatFeatures[fi.DEPTH_STENCIL]|=t),e.WEBGL_color_buffer_float&&(this._formatFeatures[fi.RGB32F]|=Ai.RENDER_TARGET,this._formatFeatures[fi.RGBA32F]|=Ai.RENDER_TARGET,this._textureExclusive[fi.RGB32F]=!1,this._textureExclusive[fi.RGBA32F]=!1),e.EXT_color_buffer_half_float&&(this._formatFeatures[fi.RGB16F]|=Ai.RENDER_TARGET,this._formatFeatures[fi.RGBA16F]|=Ai.RENDER_TARGET,this._textureExclusive[fi.RGB16F]=!1,this._textureExclusive[fi.RGBA16F]=!1),e.OES_texture_float&&(this._formatFeatures[fi.RGB32F]|=Ai.RENDER_TARGET|Ai.SAMPLED_TEXTURE,this._formatFeatures[fi.RGBA32F]|=Ai.RENDER_TARGET|Ai.SAMPLED_TEXTURE),e.OES_texture_half_float&&(this._formatFeatures[fi.RGB16F]|=Ai.RENDER_TARGET|Ai.SAMPLED_TEXTURE,this._formatFeatures[fi.RGBA16F]|=Ai.RENDER_TARGET|Ai.SAMPLED_TEXTURE),e.OES_texture_float_linear&&(this._formatFeatures[fi.RGB32F]|=Ai.LINEAR_FILTER,this._formatFeatures[fi.RGBA32F]|=Ai.LINEAR_FILTER),e.OES_texture_half_float_linear&&(this._formatFeatures[fi.RGB16F]|=Ai.LINEAR_FILTER,this._formatFeatures[fi.RGBA16F]|=Ai.LINEAR_FILTER);var n=Ai.SAMPLED_TEXTURE|Ai.LINEAR_FILTER;e.WEBGL_compressed_texture_etc1&&(this._formatFeatures[fi.ETC_RGB8]=n),e.WEBGL_compressed_texture_etc&&(this._formatFeatures[fi.ETC2_RGB8]=n,this._formatFeatures[fi.ETC2_RGBA8]=n,this._formatFeatures[fi.ETC2_SRGB8]=n,this._formatFeatures[fi.ETC2_SRGB8_A8]=n,this._formatFeatures[fi.ETC2_RGB8_A1]=n,this._formatFeatures[fi.ETC2_SRGB8_A1]=n),e.WEBGL_compressed_texture_s3tc&&(this._formatFeatures[fi.BC1]=n,this._formatFeatures[fi.BC1_ALPHA]=n,this._formatFeatures[fi.BC1_SRGB]=n,this._formatFeatures[fi.BC1_SRGB_ALPHA]=n,this._formatFeatures[fi.BC2]=n,this._formatFeatures[fi.BC2_SRGB]=n,this._formatFeatures[fi.BC3]=n,this._formatFeatures[fi.BC3_SRGB]=n),e.WEBGL_compressed_texture_pvrtc&&(this._formatFeatures[fi.PVRTC_RGB2]|=n,this._formatFeatures[fi.PVRTC_RGBA2]|=n,this._formatFeatures[fi.PVRTC_RGB4]|=n,this._formatFeatures[fi.PVRTC_RGBA4]|=n),e.WEBGL_compressed_texture_astc&&(this._formatFeatures[fi.ASTC_RGBA_4X4]|=n,this._formatFeatures[fi.ASTC_RGBA_5X4]|=n,this._formatFeatures[fi.ASTC_RGBA_5X5]|=n,this._formatFeatures[fi.ASTC_RGBA_6X5]|=n,this._formatFeatures[fi.ASTC_RGBA_6X6]|=n,this._formatFeatures[fi.ASTC_RGBA_8X5]|=n,this._formatFeatures[fi.ASTC_RGBA_8X6]|=n,this._formatFeatures[fi.ASTC_RGBA_8X8]|=n,this._formatFeatures[fi.ASTC_RGBA_10X5]|=n,this._formatFeatures[fi.ASTC_RGBA_10X6]|=n,this._formatFeatures[fi.ASTC_RGBA_10X8]|=n,this._formatFeatures[fi.ASTC_RGBA_10X10]|=n,this._formatFeatures[fi.ASTC_RGBA_12X10]|=n,this._formatFeatures[fi.ASTC_RGBA_12X12]|=n,this._formatFeatures[fi.ASTC_SRGBA_4X4]|=n,this._formatFeatures[fi.ASTC_SRGBA_5X4]|=n,this._formatFeatures[fi.ASTC_SRGBA_5X5]|=n,this._formatFeatures[fi.ASTC_SRGBA_6X5]|=n,this._formatFeatures[fi.ASTC_SRGBA_6X6]|=n,this._formatFeatures[fi.ASTC_SRGBA_8X5]|=n,this._formatFeatures[fi.ASTC_SRGBA_8X6]|=n,this._formatFeatures[fi.ASTC_SRGBA_8X8]|=n,this._formatFeatures[fi.ASTC_SRGBA_10X5]|=n,this._formatFeatures[fi.ASTC_SRGBA_10X6]|=n,this._formatFeatures[fi.ASTC_SRGBA_10X8]|=n,this._formatFeatures[fi.ASTC_SRGBA_10X10]|=n,this._formatFeatures[fi.ASTC_SRGBA_12X10]|=n,this._formatFeatures[fi.ASTC_SRGBA_12X12]|=n)},n.createCommandBuffer=function(e){var t=new(e.type===Yi.PRIMARY?Z$:W$);return t.initialize(e),t},n.createSwapchain=function(e){var t=new l0;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new k$;return t.initialize(e),t},n.createTexture=function(e){var t=new o0;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new _$;return t.initialize(e),t},n.createShader=function(e){var t=new i0;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new X$;return t.initialize(e),t},n.createRenderPass=function(e){var t=new e0;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new q$;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new Y$;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new K$;return t.initialize(e),t},n.createPipelineState=function(e){var t=new Q$;return t.initialize(e),t},n.createQueue=function(e){var t=new $$;return t.initialize(e),t},n.getSampler=function(e){var t=Bo.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new n0(e,t)),this._samplers.get(t)},n.getGeneralBarrier=function(e){var t=Fo.computeHash(e);return this._generalBarrierss.has(t)||this._generalBarrierss.set(t,new Fo(e,t)),this._generalBarrierss.get(t)},n.getTextureBarrier=function(e){var t=zo.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new zo(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){G$(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var _=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,_.texSubres.mipLevel),s=_.texOffset.x,c=_.texOffset.y,l=_.texExtent.width,u=_.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],_=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<_;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&Ci.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},J(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}},{key:"textureExclusive",get:function(){return this._textureExclusive}},{key:"bindingMappings",get:function(){return this._bindingMappings}}]),t}(mo));function h0(e,t,n,i){var r=(i.x-n.x)*(e.y-n.y)-(i.y-n.y)*(e.x-n.x),o=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),a=(i.y-n.y)*(t.x-e.x)-(i.x-n.x)*(t.y-e.y);if(0!==a){var s=r/a,c=o/a;if(s>=0&&s<=1&&c>=0&&c<=1)return!0}return!1}l.WebGLDevice=u0;var _0=new Yn,f0=new Yn,d0=new Yn,p0=new Yn;function m0(e,t,n){for(var i=n.length,r=0;r<i;++r)if(h0(e,t,n[r],n[(r+1)%i]))return!0;return!1}function v0(e,t){for(var n=!1,i=e.x,r=e.y,o=t.length,a=0,s=o-1;a<o;s=a++){var c=t[a].x,l=t[a].y,u=t[s].x,h=t[s].y;l>r!=h>r&&i<(u-c)*(r-l)/(h-l)+c&&(n=!n)}return n}function g0(e,t,n,i){var r,o=n.x-t.x,a=n.y-t.y,s=o*o+a*a,c=((e.x-t.x)*o+(e.y-t.y)*a)/s;return r=i?s?c<0?t:c>1?n:_0.set(t.x+c*o,t.y+c*a):t:_0.set(t.x+c*o,t.y+c*a),o=e.x-r.x,a=e.y-r.y,Math.sqrt(o*o+a*a)}var y0=e("Intersection2D",(function(){}));y0.lineLine=h0,y0.lineRect=function(e,t,n){var i=_0.set(n.x,n.y),r=f0.set(n.x,n.yMax),o=d0.set(n.xMax,n.yMax),a=p0.set(n.xMax,n.y);return!!(h0(e,t,i,r)||h0(e,t,r,o)||h0(e,t,o,a)||h0(e,t,a,i))},y0.linePolygon=m0,y0.rectRect=function(e,t){var n=e.x,i=e.y,r=e.x+e.width,o=e.y+e.height,a=t.x,s=t.y,c=t.x+t.width,l=t.y+t.height;return n<=c&&r>=a&&i<=l&&o>=s},y0.rectPolygon=function(e,t){var n=_0.set(e.x,e.y),i=f0.set(e.x,e.yMax),r=d0.set(e.xMax,e.yMax),o=p0.set(e.xMax,e.y);if(m0(n,i,t))return!0;if(m0(i,r,t))return!0;if(m0(r,o,t))return!0;if(m0(o,n,t))return!0;for(var a=0,s=t.length;a<s;++a)if(e.contains(t[a]))return!0;return!!(v0(n,t)||v0(i,t)||v0(r,t)||v0(o,t))},y0.rectCircle=function(e,t,n){var i=t.x,r=t.y,o=e.x,a=e.y,s=e.width,c=e.height,l=i,u=r;i<o?l=o:i>o+s&&(l=o+s),r<a?u=a:r>a+c&&(u=a+c);var h=i-l,_=r-u;return Math.sqrt(h*h+_*_)<=n},y0.polygonPolygon=function(e,t){var n,i;for(n=0,i=e.length;n<i;++n)if(m0(e[n],e[(n+1)%i],t))return!0;for(n=0,i=t.length;n<i;++n)if(v0(t[n],e))return!0;for(n=0,i=e.length;n<i;++n)if(v0(e[n],t))return!0;return!1},y0.circleCircle=function(e,t,n,i){return Yn.distance(e,n)<t+i},y0.polygonCircle=function(e,t,n){var i=t;if(v0(i,e))return!0;for(var r=0,o=e.length;r<o;r++)if(g0(i,0===r?e[e.length-1]:e[r-1],e[r],!0)<n)return!0;return!1},y0.pointInPolygon=v0,y0.pointLineDistance=g0;var x0,S0,C0,A0,b0=rt({GRAVITY:0,RADIUS:1}),T0=rt({FREE:0,RELATIVE:1,GROUPED:2}),E0=new Yn(0,0),w0=new Yn,I0=new Yn,P0=new Yn,R0=new Yn,D0=OF(RF),O0=function(){this.pos=new Yn(0,0),this.startPos=new Yn(0,0),this.color=new wn(0,0,0,255),this.deltaColor={r:0,g:0,b:0,a:255},this.size=0,this.deltaSize=0,this.rotation=0,this.deltaRotation=0,this.timeToLive=0,this.drawPos=new Yn(0,0),this.aspectRatio=1,this.dir=new Yn(0,0),this.radialAccel=0,this.tangentialAccel=0,this.angle=0,this.degreesPerSecond=0,this.radius=0,this.deltaRadius=0},N0=new(function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.prototype.get=function(){return this._get()||new O0},t}(et))((function(e){e.pos.set(E0),e.startPos.set(E0),e.color._val=4278190080,e.deltaColor.r=e.deltaColor.g=e.deltaColor.b=0,e.deltaColor.a=255,e.size=0,e.deltaSize=0,e.rotation=0,e.deltaRotation=0,e.timeToLive=0,e.drawPos.set(E0),e.aspectRatio=1,e.dir.set(E0),e.radialAccel=0,e.tangentialAccel=0,e.angle=0,e.degreesPerSecond=0,e.radius=0,e.deltaRadius=0}),1024),B0=function(){function e(e){this.particles=[],this.active=!1,this.uvFilled=0,this.finished=!1,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this._worldRotation=0,this.sys=e,this.particles=[],this.active=!1,this.readyToPlay=!0,this.finished=!1,this.elapsed=0,this.emitCounter=0,this.uvFilled=0,this._worldRotation=0}var t=e.prototype;return t.stop=function(){this.active=!1,this.readyToPlay=!1,this.elapsed=this.sys.duration,this.emitCounter=0},t.reset=function(){this.active=!0,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this.finished=!1;for(var e=this.particles,t=0;t<e.length;++t)N0.put(e[t]);e.length=0},t.emitParticle=function(e){var t=this.sys,n=N0.get();this.particles.push(n),n.timeToLive=t.life+t.lifeVar*(Math.random()-.5)*2;var i=n.timeToLive=Math.max(0,n.timeToLive);n.pos.x=t.sourcePos.x+t.posVar.x*(Math.random()-.5)*2,n.pos.y=t.sourcePos.y+t.posVar.y*(Math.random()-.5)*2;var r,o,a,s,c=t.startColor,l=t.startColorVar,u=t.endColor,h=t.endColorVar;n.color.r=r=St(c.r+l.r*(Math.random()-.5)*2,0,255),n.color.g=o=St(c.g+l.g*(Math.random()-.5)*2,0,255),n.color.b=a=St(c.b+l.b*(Math.random()-.5)*2,0,255),n.color.a=s=St(c.a+l.a*(Math.random()-.5)*2,0,255),n.deltaColor.r=(St(u.r+h.r*(Math.random()-.5)*2,0,255)-r)/i,n.deltaColor.g=(St(u.g+h.g*(Math.random()-.5)*2,0,255)-o)/i,n.deltaColor.b=(St(u.b+h.b*(Math.random()-.5)*2,0,255)-a)/i,n.deltaColor.a=(St(u.a+h.a*(Math.random()-.5)*2,0,255)-s)/i;var _=t.startSize+t.startSizeVar*(Math.random()-.5)*2;if(_=Math.max(0,_),n.size=_,-1===t.endSize)n.deltaSize=0;else{var f=t.endSize+t.endSizeVar*(Math.random()-.5)*2;f=Math.max(0,f),n.deltaSize=(f-_)/i}var d=t.startSpin+t.startSpinVar*(Math.random()-.5)*2,p=t.endSpin+t.endSpinVar*(Math.random()-.5)*2;n.rotation=d,n.deltaRotation=(p-d)/i,n.startPos.x=e.x,n.startPos.y=e.y,n.aspectRatio=t.aspectRatio||1;var m=Ct(t.angle+this._worldRotation+t.angleVar*(Math.random()-.5)*2);if(t.emitterMode===b0.GRAVITY){var v=t.speed+t.speedVar*(Math.random()-.5)*2;n.dir.x=Math.cos(m),n.dir.y=Math.sin(m),n.dir.multiplyScalar(v),n.radialAccel=t.radialAccel+t.radialAccelVar*(Math.random()-.5)*2,n.tangentialAccel=t.tangentialAccel+t.tangentialAccelVar*(Math.random()-.5)*2,t.rotationIsDir&&(n.rotation=-At(Math.atan2(n.dir.y,n.dir.x)))}else{var g=t.startRadius+t.startRadiusVar*(Math.random()-.5)*2,y=t.endRadius+t.endRadiusVar*(Math.random()-.5)*2;n.radius=g,n.deltaRadius=-1===t.endRadius?0:(y-g)/i,n.angle=m,n.degreesPerSecond=Ct(t.rotatePerS+t.rotatePerSVar*(Math.random()-.5)*2)}},t.updateUVs=function(e){var t=this.renderData;if(t&&this.sys._renderSpriteFrame){for(var n=t.vData,i=this.sys._renderSpriteFrame.uv,r=e?0:this.uvFilled,o=this.particles.length,a=r;a<o;a++){var s=a*D0*4;n[s+3]=i[0],n[s+4]=i[1],n[s+12]=i[2],n[s+13]=i[3],n[s+21]=i[4],n[s+22]=i[5],n[s+30]=i[6],n[s+31]=i[7]}this.uvFilled=o}},t.updateParticleBuffer=function(e,t,n,i){var r=n.vData,o=t.x,a=t.y,s=e.size,c=s,l=e.aspectRatio;l>1?c=s/l:s=c*l;var u=s/2,h=c/2;if(e.rotation){var _=-u,f=-h,d=u,p=h,m=-Ct(e.rotation),v=Math.cos(m),g=Math.sin(m);r[i]=_*v-f*g+o,r[i+1]=_*g+f*v+a,r[i+2]=0,r[i+9]=d*v-f*g+o,r[i+10]=d*g+f*v+a,r[i+11]=0,r[i+18]=_*v-p*g+o,r[i+19]=_*g+p*v+a,r[i+20]=0,r[i+27]=d*v-p*g+o,r[i+28]=d*g+p*v+a,r[i+29]=0}else r[i]=o-u,r[i+1]=a-h,r[i+2]=0,r[i+9]=o+u,r[i+10]=a-h,r[i+11]=0,r[i+18]=o-u,r[i+19]=a+h,r[i+20]=0,r[i+27]=o+u,r[i+28]=a+h,r[i+29]=0;wn.toArray(r,e.color,i+5),wn.toArray(r,e.color,i+14),wn.toArray(r,e.color,i+23),wn.toArray(r,e.color,i+32)},t.step=function(e){var t=this.sys.assembler,n=this.sys,i=n.node,r=this.particles;if(e=e>t.maxParticleDeltaTime?t.maxParticleDeltaTime:e,i.updateWorldTransform(),n.positionType===T0.FREE){this._worldRotation=function(e){for(var t=0,n=e;n;)t+=n.eulerAngles.z,n=n.parent;return t}(i);var o=i.worldMatrix;w0.x=o.m12,w0.y=o.m13}else n.positionType===T0.RELATIVE?(this._worldRotation=i.eulerAngles.z,w0.x=i.position.x,w0.y=i.position.y):this._worldRotation=0;if(this.active&&n.emissionRate){var a=1/n.emissionRate;for(r.length<n.totalParticles&&(this.emitCounter+=e);r.length<n.totalParticles&&this.emitCounter>a;)this.emitParticle(w0),this.emitCounter-=a;this.elapsed+=e,-1!==n.duration&&n.duration<this.elapsed&&n.stopSystem()}var s=this.renderData,c=r.length;s.reset(),this.requestData(4*c,6*c),c>this.uvFilled&&this.updateUVs();for(var l=0;l<r.length;){I0.x=I0.y=P0.x=P0.y=R0.x=R0.y=0;var u=r[l];if(u.timeToLive-=e,u.timeToLive>0){if(n.emitterMode===b0.GRAVITY){var h=R0,_=I0,f=P0;(u.pos.x||u.pos.y)&&(_.set(u.pos),_.normalize()),f.set(_),_.multiplyScalar(u.radialAccel);var d=f.x;f.x=-f.y,f.y=d,f.multiplyScalar(u.tangentialAccel),h.set(_),h.add(f),h.add(n.gravity),h.multiplyScalar(e),u.dir.add(h),h.set(u.dir),h.multiplyScalar(e),u.pos.add(h)}else u.angle+=u.degreesPerSecond*e,u.radius+=u.deltaRadius*e,u.pos.x=-Math.cos(u.angle)*u.radius,u.pos.y=-Math.sin(u.angle)*u.radius;u.color.r+=u.deltaColor.r*e,u.color.g+=u.deltaColor.g*e,u.color.b+=u.deltaColor.b*e,u.color.a+=u.deltaColor.a*e,u.size+=u.deltaSize*e,u.size<0&&(u.size=0),u.rotation+=u.deltaRotation*e;var p=I0;p.set(u.pos),n.positionType!==T0.GROUPED&&p.add(u.startPos);var m=D0*l*4;this.updateParticleBuffer(u,p,s,m),++l}else{var v=r[l];l!==r.length-1&&(r[l]=r[r.length-1]),N0.put(v),r.length--,s.resize(s.vertexCount-4,s.indexCount-6)}}0!==r.length||this.active||this.readyToPlay||(this.finished=!0,n._finishedSimulation())},t.requestData=function(e,t){var n=this.renderData.indexCount;this.renderData.request(e,t);for(var i=this.renderData.indexCount/6,r=this.renderData.iData,o=n;o<i;o++){var a=4*o;r[n++]=a,r[n++]=a+1,r[n++]=a+2,r[n++]=a+1,r[n++]=a+3,r[n++]=a+2}},e}(),M0=e("ParticleAsset",Ac("cc.ParticleAsset")((A0=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"spriteFrame",C0,re(t)),t}return Z(t,e),t}(Iu),C0=ce((S0=A0).prototype,"spriteFrame",[Dc,kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x0=S0))||x0);l.ParticleAsset=M0;
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
var L0={};(function(){function e(e){throw e}var t=void 0,n=!0,i=this;function r(e,n){var r,o=e.split("."),a=i;!(o[0]in a)&&a.execScript&&a.execScript("var "+o[0]);for(;o.length&&(r=o.shift());)o.length||n===t?a=a[r]?a[r]:a[r]={}:a[r]=n}var o="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;function a(e){if("string"==typeof e){var t,n,i=e.split("");for(t=0,n=i.length;t<n;t++)i[t]=(255&i[t].charCodeAt(0))>>>0;e=i}for(var r,o=1,a=0,s=e.length,c=0;0<s;){s-=r=1024<s?1024:s;do{a+=o+=e[c++]}while(--r);o%=65521,a%=65521}return(a<<16|o)>>>0}function s(t,n){this.index="number"==typeof n?n:0,this.i=0,this.buffer=t instanceof(o?Uint8Array:Array)?t:new(o?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&e(Error("invalid index")),this.buffer.length<=this.index&&this.f()}s.prototype.f=function(){var e,t=this.buffer,n=t.length,i=new(o?Uint8Array:Array)(n<<1);if(o)i.set(t);else for(e=0;e<n;++e)i[e]=t[e];return this.buffer=i},s.prototype.d=function(e,t,n){var i,r=this.buffer,o=this.index,a=this.i,s=r[o];if(n&&1<t&&(e=8<t?(f[255&e]<<24|f[e>>>8&255]<<16|f[e>>>16&255]<<8|f[e>>>24&255])>>32-t:f[e]>>8-t),8>t+a)s=s<<t|e,a+=t;else for(i=0;i<t;++i)s=s<<1|e>>t-i-1&1,8==++a&&(a=0,r[o++]=f[s],s=0,o===r.length&&(r=this.f()));r[o]=s,this.buffer=r,this.i=a,this.index=o},s.prototype.finish=function(){var e,t=this.buffer,n=this.index;return 0<this.i&&(t[n]<<=8-this.i,t[n]=f[t[n]],n++),o?e=t.subarray(0,n):(t.length=n,e=t),e};var c,l=new(o?Uint8Array:Array)(256);for(c=0;256>c;++c){for(var u=_=c,h=7,_=_>>>1;_;_>>>=1)u<<=1,u|=1&_,--h;l[c]=(u<<h&255)>>>0}var f=l;function d(e){this.buffer=new(o?Uint16Array:Array)(2*e),this.length=0}function p(e){var t,n,i,r,a,s,c,l,u,h=e.length,_=0,f=Number.POSITIVE_INFINITY;for(l=0;l<h;++l)e[l]>_&&(_=e[l]),e[l]<f&&(f=e[l]);for(t=1<<_,n=new(o?Uint32Array:Array)(t),i=1,r=0,a=2;i<=_;){for(l=0;l<h;++l)if(e[l]===i){for(s=0,c=r,u=0;u<i;++u)s=s<<1|1&c,c>>=1;for(u=s;u<t;u+=a)n[u]=i<<16|l;++r}++i,r<<=1,a<<=1}return[n,_,f]}function m(e,t){this.h=g,this.w=0,this.input=e,this.b=0,t&&(t.lazy&&(this.w=t.lazy),"number"==typeof t.compressionType&&(this.h=t.compressionType),t.outputBuffer&&(this.a=o&&t.outputBuffer instanceof Array?new Uint8Array(t.outputBuffer):t.outputBuffer),"number"==typeof t.outputIndex&&(this.b=t.outputIndex)),this.a||(this.a=new(o?Uint8Array:Array)(32768))}d.prototype.getParent=function(e){return 2*((e-2)/4|0)},d.prototype.push=function(e,t){var n,i,r,o=this.buffer;for(n=this.length,o[this.length++]=t,o[this.length++]=e;0<n&&(i=this.getParent(n),o[n]>o[i]);)r=o[n],o[n]=o[i],o[i]=r,r=o[n+1],o[n+1]=o[i+1],o[i+1]=r,n=i;return this.length},d.prototype.pop=function(){var e,t,n,i,r,o=this.buffer;for(t=o[0],e=o[1],this.length-=2,o[0]=o[this.length],o[1]=o[this.length+1],r=0;!((i=2*r+2)>=this.length)&&(i+2<this.length&&o[i+2]>o[i]&&(i+=2),o[i]>o[r]);)n=o[r],o[r]=o[i],o[i]=n,n=o[r+1],o[r+1]=o[i+1],o[i+1]=n,r=i;return{index:e,value:t,length:this.length}};var v,g=2,y={NONE:0,r:1,j:g,N:3},x=[];for(v=0;288>v;v++)switch(n){case 143>=v:x.push([v+48,8]);break;case 255>=v:x.push([v-144+400,9]);break;case 279>=v:x.push([v-256+0,7]);break;case 287>=v:x.push([v-280+192,8]);break;default:e("invalid literal: "+v)}function S(e,t){this.length=e,this.G=t}function C(){var t=A;switch(n){case 3===t:return[257,t-3,0];case 4===t:return[258,t-4,0];case 5===t:return[259,t-5,0];case 6===t:return[260,t-6,0];case 7===t:return[261,t-7,0];case 8===t:return[262,t-8,0];case 9===t:return[263,t-9,0];case 10===t:return[264,t-10,0];case 12>=t:return[265,t-11,1];case 14>=t:return[266,t-13,1];case 16>=t:return[267,t-15,1];case 18>=t:return[268,t-17,1];case 22>=t:return[269,t-19,2];case 26>=t:return[270,t-23,2];case 30>=t:return[271,t-27,2];case 34>=t:return[272,t-31,2];case 42>=t:return[273,t-35,3];case 50>=t:return[274,t-43,3];case 58>=t:return[275,t-51,3];case 66>=t:return[276,t-59,3];case 82>=t:return[277,t-67,4];case 98>=t:return[278,t-83,4];case 114>=t:return[279,t-99,4];case 130>=t:return[280,t-115,4];case 162>=t:return[281,t-131,5];case 194>=t:return[282,t-163,5];case 226>=t:return[283,t-195,5];case 257>=t:return[284,t-227,5];case 258===t:return[285,t-258,0];default:e("invalid length: "+t)}}m.prototype.n=function(){var i,r,a,c,l=this.input;switch(this.h){case 0:for(a=0,c=l.length;a<c;){var u,h,_,f=r=o?l.subarray(a,a+65535):l.slice(a,a+65535),d=(a+=r.length)===c,p=t,m=t,v=this.a,y=this.b;if(o){for(v=new Uint8Array(this.a.buffer);v.length<=y+f.length+5;)v=new Uint8Array(v.length<<1);v.set(this.a)}if(u=d?1:0,v[y++]=0|u,_=65536+~(h=f.length)&65535,v[y++]=255&h,v[y++]=h>>>8&255,v[y++]=255&_,v[y++]=_>>>8&255,o)v.set(f,y),y+=f.length,v=v.subarray(0,y);else{for(p=0,m=f.length;p<m;++p)v[y++]=f[p];v.length=y}this.b=y,this.a=v}break;case 1:var S=new s(new Uint8Array(this.a.buffer),this.b);S.d(1,1,n),S.d(1,2,n);var C,A,b,T=w(this,l);for(C=0,A=T.length;C<A;C++)if(b=T[C],s.prototype.d.apply(S,x[b]),256<b)S.d(T[++C],T[++C],n),S.d(T[++C],5),S.d(T[++C],T[++C],n);else if(256===b)break;this.a=S.finish(),this.b=this.a.length;break;case g:var E,R,D,O,N,B,M,L,F,z,V,G,U,k,H,j=new s(new Uint8Array(this.a),this.b),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],q=Array(19);for(E=g,j.d(1,1,n),j.d(E,2,n),R=w(this,l),M=P(B=I(this.L,15)),F=P(L=I(this.K,7)),D=286;257<D&&0===B[D-1];D--);for(O=30;1<O&&0===L[O-1];O--);var X,Y,K,J,Q,Z,$=D,ee=O,te=new(o?Uint32Array:Array)($+ee),ne=new(o?Uint32Array:Array)(316),ie=new(o?Uint8Array:Array)(19);for(X=Y=0;X<$;X++)te[Y++]=B[X];for(X=0;X<ee;X++)te[Y++]=L[X];if(!o)for(X=0,J=ie.length;X<J;++X)ie[X]=0;for(X=Q=0,J=te.length;X<J;X+=Y){for(Y=1;X+Y<J&&te[X+Y]===te[X];++Y);if(K=Y,0===te[X])if(3>K)for(;0<K--;)ne[Q++]=0,ie[0]++;else for(;0<K;)(Z=138>K?K:138)>K-3&&Z<K&&(Z=K-3),10>=Z?(ne[Q++]=17,ne[Q++]=Z-3,ie[17]++):(ne[Q++]=18,ne[Q++]=Z-11,ie[18]++),K-=Z;else if(ne[Q++]=te[X],ie[te[X]]++,3>--K)for(;0<K--;)ne[Q++]=te[X],ie[te[X]]++;else for(;0<K;)(Z=6>K?K:6)>K-3&&Z<K&&(Z=K-3),ne[Q++]=16,ne[Q++]=Z-3,ie[16]++,K-=Z}for(i=o?ne.subarray(0,Q):ne.slice(0,Q),z=I(ie,7),k=0;19>k;k++)q[k]=z[W[k]];for(N=19;4<N&&0===q[N-1];N--);for(V=P(z),j.d(D-257,5,n),j.d(O-1,5,n),j.d(N-4,4,n),k=0;k<N;k++)j.d(q[k],3,n);for(k=0,H=i.length;k<H;k++)if(G=i[k],j.d(V[G],z[G],n),16<=G){switch(k++,G){case 16:U=2;break;case 17:U=3;break;case 18:U=7;break;default:e("invalid code: "+G)}j.d(i[k],U,n)}var re,oe,ae,se,ce,le,ue,he,_e=[M,B],fe=[F,L];for(ce=_e[0],le=_e[1],ue=fe[0],he=fe[1],re=0,oe=R.length;re<oe;++re)if(ae=R[re],j.d(ce[ae],le[ae],n),256<ae)j.d(R[++re],R[++re],n),se=R[++re],j.d(ue[se],he[se],n),j.d(R[++re],R[++re],n);else if(256===ae)break;this.a=j.finish(),this.b=this.a.length;break;default:e("invalid compression type")}return this.a};var A,b,T=[];for(A=3;258>=A;A++)b=C(),T[A]=b[2]<<24|b[1]<<16|b[0];var E=o?new Uint32Array(T):T;function w(i,r){function a(t,i){var r,o,a,s,c=t.G,l=[],u=0;switch(r=E[t.length],l[u++]=65535&r,l[u++]=r>>16&255,l[u++]=r>>24,n){case 1===c:o=[0,c-1,0];break;case 2===c:o=[1,c-2,0];break;case 3===c:o=[2,c-3,0];break;case 4===c:o=[3,c-4,0];break;case 6>=c:o=[4,c-5,1];break;case 8>=c:o=[5,c-7,1];break;case 12>=c:o=[6,c-9,2];break;case 16>=c:o=[7,c-13,2];break;case 24>=c:o=[8,c-17,3];break;case 32>=c:o=[9,c-25,3];break;case 48>=c:o=[10,c-33,4];break;case 64>=c:o=[11,c-49,4];break;case 96>=c:o=[12,c-65,5];break;case 128>=c:o=[13,c-97,5];break;case 192>=c:o=[14,c-129,6];break;case 256>=c:o=[15,c-193,6];break;case 384>=c:o=[16,c-257,7];break;case 512>=c:o=[17,c-385,7];break;case 768>=c:o=[18,c-513,8];break;case 1024>=c:o=[19,c-769,8];break;case 1536>=c:o=[20,c-1025,9];break;case 2048>=c:o=[21,c-1537,9];break;case 3072>=c:o=[22,c-2049,10];break;case 4096>=c:o=[23,c-3073,10];break;case 6144>=c:o=[24,c-4097,11];break;case 8192>=c:o=[25,c-6145,11];break;case 12288>=c:o=[26,c-8193,12];break;case 16384>=c:o=[27,c-12289,12];break;case 24576>=c:o=[28,c-16385,13];break;case 32768>=c:o=[29,c-24577,13];break;default:e("invalid distance")}for(r=o,l[u++]=r[0],l[u++]=r[1],l[u++]=r[2],a=0,s=l.length;a<s;++a)v[g++]=l[a];x[l[0]]++,C[l[3]]++,y=t.length+i-1,d=null}var s,c,l,u,h,_,f,d,p,m={},v=o?new Uint16Array(2*r.length):[],g=0,y=0,x=new(o?Uint32Array:Array)(286),C=new(o?Uint32Array:Array)(30),A=i.w;if(!o){for(l=0;285>=l;)x[l++]=0;for(l=0;29>=l;)C[l++]=0}for(x[256]=1,s=0,c=r.length;s<c;++s){for(l=h=0,u=3;l<u&&s+l!==c;++l)h=h<<8|r[s+l];if(m[h]===t&&(m[h]=[]),_=m[h],!(0<y--)){for(;0<_.length&&32768<s-_[0];)_.shift();if(s+3>=c){for(d&&a(d,-1),l=0,u=c-s;l<u;++l)p=r[s+l],v[g++]=p,++x[p];break}if(0<_.length){var b=t,T=t,w=0,I=t,P=t,R=t,D=r.length,O=(P=0,_.length);e:for(;P<O;P++){if(b=_[O-P-1],I=3,3<w){for(R=w;3<R;R--)if(r[b+R-1]!==r[s+R-1])continue e;I=w}for(;258>I&&s+I<D&&r[b+I]===r[s+I];)++I;if(I>w&&(T=b,w=I),258===I)break}f=new S(w,s-T),d?d.length<f.length?(p=r[s-1],v[g++]=p,++x[p],a(f,0)):a(d,-1):f.length<A?d=f:a(f,0)}else d?a(d,-1):(p=r[s],v[g++]=p,++x[p])}_.push(s)}return v[g++]=256,x[256]++,i.L=x,i.K=C,o?v.subarray(0,g):v}function I(e,t){function n(e){var t=A[e][b[e]];t===g?(n(e+1),n(e+1)):--S[t],++b[e]}var i,r,a,s,c,l=e.length,u=new d(572),h=new(o?Uint8Array:Array)(l);if(!o)for(s=0;s<l;s++)h[s]=0;for(s=0;s<l;++s)0<e[s]&&u.push(s,e[s]);if(i=Array(u.length/2),r=new(o?Uint32Array:Array)(u.length/2),1===i.length)return h[u.pop().index]=1,h;for(s=0,c=u.length/2;s<c;++s)i[s]=u.pop(),r[s]=i[s].value;var _,f,p,m,v,g=r.length,y=new(o?Uint16Array:Array)(t),x=new(o?Uint8Array:Array)(t),S=new(o?Uint8Array:Array)(g),C=Array(t),A=Array(t),b=Array(t),T=(1<<t)-g,E=1<<t-1;for(y[t-1]=g,f=0;f<t;++f)T<E?x[f]=0:(x[f]=1,T-=E),T<<=1,y[t-2-f]=(y[t-1-f]/2|0)+g;for(y[0]=x[0],C[0]=Array(y[0]),A[0]=Array(y[0]),f=1;f<t;++f)y[f]>2*y[f-1]+x[f]&&(y[f]=2*y[f-1]+x[f]),C[f]=Array(y[f]),A[f]=Array(y[f]);for(_=0;_<g;++_)S[_]=t;for(p=0;p<y[t-1];++p)C[t-1][p]=r[p],A[t-1][p]=p;for(_=0;_<t;++_)b[_]=0;for(1===x[t-1]&&(--S[0],++b[t-1]),f=t-2;0<=f;--f){for(m=_=0,v=b[f+1],p=0;p<y[f];p++)(m=C[f+1][v]+C[f+1][v+1])>r[_]?(C[f][p]=m,A[f][p]=g,v+=2):(C[f][p]=r[_],A[f][p]=_,++_);b[f]=0,1===x[f]&&n(f)}for(a=S,s=0,c=i.length;s<c;++s)h[i[s].index]=a[s];return h}function P(t){var n,i,r,a,s=new(o?Uint16Array:Array)(t.length),c=[],l=[],u=0;for(n=0,i=t.length;n<i;n++)c[t[n]]=1+(0|c[t[n]]);for(n=1,i=16;n<=i;n++)l[n]=u,(u+=0|c[n])>1<<n&&e("overcommitted"),u<<=1;for(65536>u&&e("undercommitted"),n=0,i=t.length;n<i;n++)for(u=l[t[n]],l[t[n]]+=1,r=s[n]=0,a=t[n];r<a;r++)s[n]=s[n]<<1|1&u,u>>>=1;return s}function R(e,t){this.input=e,this.a=new(o?Uint8Array:Array)(32768),this.h=D.j;var n,i={};for(n in!t&&(t={})||"number"!=typeof t.compressionType||(this.h=t.compressionType),t)i[n]=t[n];i.outputBuffer=this.a,this.z=new m(this.input,i)}var D=y;function O(t,n){switch(this.k=[],this.l=32768,this.e=this.g=this.c=this.q=0,this.input=o?new Uint8Array(t):t,this.s=!1,this.m=B,this.B=!1,!n&&(n={})||(n.index&&(this.c=n.index),n.bufferSize&&(this.l=n.bufferSize),n.bufferType&&(this.m=n.bufferType),n.resize&&(this.B=n.resize)),this.m){case N:this.b=32768,this.a=new(o?Uint8Array:Array)(32768+this.l+258);break;case B:this.b=0,this.a=new(o?Uint8Array:Array)(this.l),this.f=this.J,this.t=this.H,this.o=this.I;break;default:e(Error("invalid inflate mode"))}}R.prototype.n=function(){var t,n,i,r,s,c,l,u=0;switch(l=this.a,t=ue){case ue:n=Math.LOG2E*Math.log(32768)-8;break;default:e(Error("invalid compression method"))}switch(i=n<<4|t,l[u++]=i,t){case ue:switch(this.h){case D.NONE:s=0;break;case D.r:s=1;break;case D.j:s=2;break;default:e(Error("unsupported compression type"))}break;default:e(Error("invalid compression method"))}return r=s<<6|0,l[u++]=r|31-(256*i+r)%31,c=a(this.input),this.z.b=u,u=(l=this.z.n()).length,o&&((l=new Uint8Array(l.buffer)).length<=u+4&&(this.a=new Uint8Array(l.length+4),this.a.set(l),l=this.a),l=l.subarray(0,u+4)),l[u++]=c>>24&255,l[u++]=c>>16&255,l[u++]=c>>8&255,l[u++]=255&c,l},r("Zlib.Deflate",R),r("Zlib.Deflate.compress",(function(e,t){return new R(e,t).n()})),r("Zlib.Deflate.CompressionType",D),r("Zlib.Deflate.CompressionType.NONE",D.NONE),r("Zlib.Deflate.CompressionType.FIXED",D.r),r("Zlib.Deflate.CompressionType.DYNAMIC",D.j);var N=0,B=1,M={D:N,C:B};O.prototype.p=function(){for(;!this.s;){var i=ee(this,3);switch(1&i&&(this.s=n),i>>>=1){case 0:var r=this.input,a=this.c,s=this.a,c=this.b,l=t,u=t,h=t,_=s.length,f=t;switch(this.e=this.g=0,(l=r[a++])===t&&e(Error("invalid uncompressed block header: LEN (first byte)")),u=l,(l=r[a++])===t&&e(Error("invalid uncompressed block header: LEN (second byte)")),u|=l<<8,(l=r[a++])===t&&e(Error("invalid uncompressed block header: NLEN (first byte)")),h=l,(l=r[a++])===t&&e(Error("invalid uncompressed block header: NLEN (second byte)")),u===~(h|=l<<8)&&e(Error("invalid uncompressed block header: length verify")),a+u>r.length&&e(Error("input buffer is broken")),this.m){case N:for(;c+u>s.length;){if(u-=f=_-c,o)s.set(r.subarray(a,a+f),c),c+=f,a+=f;else for(;f--;)s[c++]=r[a++];this.b=c,s=this.f(),c=this.b}break;case B:for(;c+u>s.length;)s=this.f({v:2});break;default:e(Error("invalid inflate mode"))}if(o)s.set(r.subarray(a,a+u),c),c+=u,a+=u;else for(;u--;)s[c++]=r[a++];this.c=a,this.b=c,this.a=s;break;case 1:this.o(Q,$);break;case 2:ne(this);break;default:e(Error("unknown BTYPE: "+i))}}return this.t()};var L,F,z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],V=o?new Uint16Array(z):z,G=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],U=o?new Uint16Array(G):G,k=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],H=o?new Uint8Array(k):k,j=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],W=o?new Uint16Array(j):j,q=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],X=o?new Uint8Array(q):q,Y=new(o?Uint8Array:Array)(288);for(L=0,F=Y.length;L<F;++L)Y[L]=143>=L?8:255>=L?9:279>=L?7:8;var K,J,Q=p(Y),Z=new(o?Uint8Array:Array)(30);for(K=0,J=Z.length;K<J;++K)Z[K]=5;var $=p(Z);function ee(n,i){for(var r,o=n.g,a=n.e,s=n.input,c=n.c;a<i;)(r=s[c++])===t&&e(Error("input buffer is broken")),o|=r<<a,a+=8;return r=o&(1<<i)-1,n.g=o>>>i,n.e=a-i,n.c=c,r}function te(n,i){for(var r,o,a,s=n.g,c=n.e,l=n.input,u=n.c,h=i[0],_=i[1];c<_;)(r=l[u++])===t&&e(Error("input buffer is broken")),s|=r<<c,c+=8;return a=(o=h[s&(1<<_)-1])>>>16,n.g=s>>a,n.e=c-a,n.c=u,65535&o}function ne(e){function t(e,t,n){var i,r,o,a;for(a=0;a<e;)switch(i=te(this,t)){case 16:for(o=3+ee(this,2);o--;)n[a++]=r;break;case 17:for(o=3+ee(this,3);o--;)n[a++]=0;r=0;break;case 18:for(o=11+ee(this,7);o--;)n[a++]=0;r=0;break;default:r=n[a++]=i}return n}var n,i,r,a,s=ee(e,5)+257,c=ee(e,5)+1,l=ee(e,4)+4,u=new(o?Uint8Array:Array)(V.length);for(a=0;a<l;++a)u[V[a]]=ee(e,3);n=p(u),i=new(o?Uint8Array:Array)(s),r=new(o?Uint8Array:Array)(c),e.o(p(t.call(e,s,n,i)),p(t.call(e,c,n,r)))}function ie(t,n){var i,r;switch(this.input=t,this.c=0,!n&&(n={})||(n.index&&(this.c=n.index),n.verify&&(this.M=n.verify)),i=t[this.c++],r=t[this.c++],15&i){case ue:this.method=ue;break;default:e(Error("unsupported compression method"))}0!=((i<<8)+r)%31&&e(Error("invalid fcheck flag:"+((i<<8)+r)%31)),32&r&&e(Error("fdict flag is not supported")),this.A=new O(t,{index:this.c,bufferSize:n.bufferSize,bufferType:n.bufferType,resize:n.resize})}O.prototype.o=function(e,t){var n=this.a,i=this.b;this.u=e;for(var r,o,a,s,c=n.length-258;256!==(r=te(this,e));)if(256>r)i>=c&&(this.b=i,n=this.f(),i=this.b),n[i++]=r;else for(s=U[o=r-257],0<H[o]&&(s+=ee(this,H[o])),r=te(this,t),a=W[r],0<X[r]&&(a+=ee(this,X[r])),i>=c&&(this.b=i,n=this.f(),i=this.b);s--;)n[i]=n[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},O.prototype.I=function(e,t){var n=this.a,i=this.b;this.u=e;for(var r,o,a,s,c=n.length;256!==(r=te(this,e));)if(256>r)i>=c&&(c=(n=this.f()).length),n[i++]=r;else for(s=U[o=r-257],0<H[o]&&(s+=ee(this,H[o])),r=te(this,t),a=W[r],0<X[r]&&(a+=ee(this,X[r])),i+s>c&&(c=(n=this.f()).length);s--;)n[i]=n[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},O.prototype.f=function(){var e,t,n=new(o?Uint8Array:Array)(this.b-32768),i=this.b-32768,r=this.a;if(o)n.set(r.subarray(32768,n.length));else for(e=0,t=n.length;e<t;++e)n[e]=r[e+32768];if(this.k.push(n),this.q+=n.length,o)r.set(r.subarray(i,i+32768));else for(e=0;32768>e;++e)r[e]=r[i+e];return this.b=32768,r},O.prototype.J=function(e){var t,n,i,r=this.input.length/this.c+1|0,a=this.input,s=this.a;return e&&("number"==typeof e.v&&(r=e.v),"number"==typeof e.F&&(r+=e.F)),n=2>r?(i=(a.length-this.c)/this.u[2]/2*258|0)<s.length?s.length+i:s.length<<1:s.length*r,o?(t=new Uint8Array(n)).set(s):t=s,this.a=t},O.prototype.t=function(){var e,t,n,i,r,a=0,s=this.a,c=this.k,l=new(o?Uint8Array:Array)(this.q+(this.b-32768));if(0===c.length)return o?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(t=0,n=c.length;t<n;++t)for(i=0,r=(e=c[t]).length;i<r;++i)l[a++]=e[i];for(t=32768,n=this.b;t<n;++t)l[a++]=s[t];return this.k=[],this.buffer=l},O.prototype.H=function(){var e,t=this.b;return o?this.B?(e=new Uint8Array(t)).set(this.a.subarray(0,t)):e=this.a.subarray(0,t):(this.a.length>t&&(this.a.length=t),e=this.a),this.buffer=e},ie.prototype.p=function(){var t,n=this.input;return t=this.A.p(),this.c=this.A.c,this.M&&(n[this.c++]<<24|n[this.c++]<<16|n[this.c++]<<8|n[this.c++])>>>0!==a(t)&&e(Error("invalid adler-32 checksum")),t},r("Zlib.Inflate",ie),r("Zlib.Inflate.BufferType",M),M.ADAPTIVE=M.C,M.BLOCK=M.D,r("Zlib.Inflate.prototype.decompress",ie.prototype.p);var re,oe,ae=new(o?Uint8Array:Array)(288);for(re=0,oe=ae.length;re<oe;++re)ae[re]=143>=re?8:255>=re?9:279>=re?7:8;p(ae);var se,ce,le=new(o?Uint8Array:Array)(30);for(se=0,ce=le.length;se<ce;++se)le[se]=5;p(le);var ue=8}).call(L0);var F0=L0.Zlib;F0.Deflate=F0.Deflate,F0.Deflate.compress=F0.Deflate.compress,F0.Inflate=F0.Inflate,F0.Inflate.BufferType=F0.Inflate.BufferType,F0.Inflate.prototype.decompress=F0.Inflate.prototype.decompress;for(var z0=function(){function e(e){var t,n=this;this.pos=8,this.palette=[],this.imgData=[],this.text={},this.width=0,this.height=0,this.bits=0,this.colorType=0,this.compressionMethod=0,this.filterMethod=0,this.interlaceMethod=0,this.colors=0,this.hasAlphaChannel=!1,this.pixelBitlength=0,this.data=e,this.transparency={indexed:[],rgb:0,grayscale:0};for(var i=0,r=0,o=0;;){o=this.readUInt32();var a=function(){var e=[];for(i=0;i<4;++i)e.push(String.fromCharCode(n.data[n.pos++]));return e}.call(this).join("");switch(a){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(o);break;case"fcTL":t&&this.animation.frames.push(t),this.pos+=4,t={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()};var s=this.readUInt16(),c=this.readUInt16()||100;t.delay=1e3*s/c,t.disposeOp=this.data[this.pos++],t.blendOp=this.data[this.pos++],t.data=[];break;case"IDAT":case"fdAT":for("fdAT"===a&&(this.pos+=4,o-=4),e=(null!=t?t.data:void 0)||this.imgData,i=0;o>=0?i<o:i>o;o>=0?++i:--i)e.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:this.transparency.indexed=this.read(o);var l=255-this.transparency.indexed.length;if(l>0)for(r=0;l>=0?r<l:r>l;l>=0?++r:--r)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(o)[0];break;case 2:this.transparency.rgb=this.read(o)}break;case"tEXt":var u=this.read(o),h=u.indexOf(0),_=String.fromCharCode.apply(String,u.slice(0,h));this.text[_]=String.fromCharCode.apply(String,u.slice(h+1));break;case"IEND":t&&this.animation.frames.push(t),this.colors=function(){switch(n.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this);var f=this.colorType;this.hasAlphaChannel=4===f||6===f;var d=this.colors+(this.hasAlphaChannel?1:0);return this.pixelBitlength=this.bits*d,this.colorSpace=function(){switch(n.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData instanceof Uint8Array||(this.imgData=new Uint8Array(this.imgData)));default:this.pos+=o}if(this.pos+=4,this.pos>this.data.length)throw new Error(L(6017))}}var t=e.prototype;return t.read=function(e){var t=0,n=[];for(t=0;e>=0?t<e:t>e;e>=0?++t:--t)n.push(this.data[this.pos++]);return n},t.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},t.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},t.decodePixels=function(e){if(null==e&&(e=this.imgData),0===e.length)return new Uint8Array(0);e=new F0.Inflate(e,{index:0,verify:!1}).decompress();for(var t=this.pixelBitlength/8,n=t*this.width,i=new Uint8Array(n*this.height),r=e.length,o=0,a=0,s=0,c=0,l=0,u=0,h=0,_=0,f=0,d=0,p=0,m=0,v=0,g=0,y=0,x=0,S=0,C=0,A=0;a<r;){switch(e[a++]){case 0:for(u=h=0;h<n;u=h+=1)i[s++]=e[a++];break;case 1:for(u=_=0;_<n;u=_+=1)c=e[a++],m=u<t?0:i[s-t],i[s++]=(c+m)%256;break;case 2:for(u=f=0;f<n;u=f+=1)c=e[a++],l=(u-u%t)/t,C=o&&i[(o-1)*n+l*t+u%t],i[s++]=(C+c)%256;break;case 3:for(u=d=0;d<n;u=d+=1)c=e[a++],l=(u-u%t)/t,m=u<t?0:i[s-t],C=o&&i[(o-1)*n+l*t+u%t],i[s++]=(c+Math.floor((m+C)/2))%256;break;case 4:for(u=p=0;p<n;u=p+=1)c=e[a++],l=(u-u%t)/t,m=u<t?0:i[s-t],0===o?C=A=0:(C=i[(o-1)*n+l*t+u%t],A=l&&i[(o-1)*n+(l-1)*t+u%t]),v=m+C-A,g=Math.abs(v-m),x=Math.abs(v-C),S=Math.abs(v-A),y=g<=x&&g<=S?m:x<=S?C:A,i[s++]=(c+y)%256;break;default:throw new Error(L(6018,e[a-1]))}o++}return i},t.copyToImageData=function(e,t){var n,i=this.hasAlphaChannel,r=this.colors;this.palette.length&&(n=null!=this._decodedPalette?this._decodedPalette:this._decodedPalette=this.decodePalette(),r=4,i=!0);var o=e.data||e,a=o.length,s=n||t,c=0,l=0,u=0,h=0;if(1===r)for(;c<a;)u=n?4*t[c/4]:l,h=s[u++],o[c++]=h,o[c++]=h,o[c++]=h,o[c++]=i?s[u++]:255,l=u;else for(;c<a;)u=n?4*t[c/4]:l,o[c++]=s[u++],o[c++]=s[u++],o[c++]=s[u++],o[c++]=i?s[u++]:255,l=u},t.decodePalette=function(){for(var e=this.palette,t=this.transparency.indexed||[],n=new Uint8Array((t.length||0)+e.length),i=0,r=0,o=0,a=0,s=0,c=e.length;s<c;a=s+=3)n[i++]=e[a],n[i++]=e[a+1],n[i++]=e[a+2],o=t[r++],n[i++]=null!=o?o:255;return n},t.render=function(e){e.width=this.width,e.height=this.height;var t=e.getContext("2d"),n=t.createImageData(this.width,this.height);return this.copyToImageData(n,this.decodePixels(null)),t.putImageData(n,0,0)},e}(),V0=function(){function e(){this._littleEndian=!1,this._tiffData=[],this._fileDirectories=[]}var t=e.prototype;return t.getUint8=function(e){return this._tiffData[e]},t.getUint16=function(e){return this._littleEndian?this._tiffData[e+1]<<8|this._tiffData[e]:this._tiffData[e]<<8|this._tiffData[e+1]},t.getUint32=function(e){var t=this._tiffData;return this._littleEndian?t[e+3]<<24|t[e+2]<<16|t[e+1]<<8|t[e]:t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3]},t.checkLittleEndian=function(){var e=this.getUint16(0);if(18761===e)this._littleEndian=!0;else{if(19789!==e)throw console.log(e),TypeError(L(6019));this._littleEndian=!1}return this._littleEndian},t.hasTowel=function(){if(42!==this.getUint16(2))throw RangeError(L(6020));return!0},t.getFieldTypeName=function(e){return e in U0?U0[e]:null},t.getFieldTagName=function(e){return e in G0?G0[e]:(I(6021,e),"Tag"+e)},t.getFieldTypeLength=function(e){return-1!==["BYTE","ASCII","SBYTE","UNDEFINED"].indexOf(e)?1:-1!==["SHORT","SSHORT"].indexOf(e)?2:-1!==["LONG","SLONG","FLOAT"].indexOf(e)?4:-1!==["RATIONAL","SRATIONAL","DOUBLE"].indexOf(e)?8:0},t.getFieldValues=function(e,t,n,i){var r=[],o=this.getFieldTypeLength(t);if(o*n<=4)!1===this._littleEndian?r.push(i>>>8*(4-o)):r.push(i);else for(var a=0;a<n;a++){var s=o*a;o>=8?-1!==["RATIONAL","SRATIONAL"].indexOf(t)?(r.push(this.getUint32(i+s)),r.push(this.getUint32(i+s+4))):I(8e3):r.push(this.getBytes(o,i+s))}return"ASCII"===t&&r.forEach((function(e,t,n){n[t]=String.fromCharCode(e)})),r},t.getBytes=function(e,t){if(e<=0)I(8001);else{if(e<=1)return this.getUint8(t);if(e<=2)return this.getUint16(t);if(e<=3)return this.getUint32(t)>>>8;if(e<=4)return this.getUint32(t);I(8002)}return 0},t.getBits=function(e,t,n){n=n||0;var i=t+Math.floor(n/8),r=n+e,o=32-e,a=0,s=0;return r<=0?I(6023):r<=8?(a=24+n,s=this.getUint8(i)):r<=16?(a=16+n,s=this.getUint16(i)):r<=32?(a=n,s=this.getUint32(i)):I(6022),{bits:s<<a>>>o,byteOffset:i+Math.floor(r/8),bitOffset:r%8}},t.parseFileDirectory=function(e){var t=this.getUint16(e),n=[],i=0,r=0;for(i=e+2,r=0;r<t;i+=12,r++){var o=this.getUint16(i),a=this.getUint16(i+2),s=this.getUint32(i+4),c=this.getUint32(i+8),l=this.getFieldTagName(o),u=this.getFieldTypeName(a),h=this.getFieldValues(l,u,s,c);n[l]={type:u,values:h}}this._fileDirectories.push(n);var _=this.getUint32(i);0!==_&&this.parseFileDirectory(_)},t.clampColorSample=function(e,t){var n=Math.pow(2,8-t);return Math.floor(e*n+(n-1))},t.parseTIFF=function(e,t){var n=this;if(t=t||document.createElement("canvas"),this._tiffData=e,this._canvas=t,this.checkLittleEndian(),this.hasTowel()){var i=this.getUint32(4);this._fileDirectories.length=0,this.parseFileDirectory(i);var r=this._fileDirectories[0],o=r.ImageWidth.values[0],a=r.ImageLength.values[0];this._canvas.width=o,this._canvas.height=a;var s=[],c=r.Compression?r.Compression.values[0]:1,l=r.SamplesPerPixel.values[0],u=[],h=0,_=!1;r.BitsPerSample.values.forEach((function(e,t){u[t]={bitsPerSample:e,hasBytesPerSample:!1,bytesPerSample:void 0},e%8==0&&(u[t].hasBytesPerSample=!0,u[t].bytesPerSample=e/8),h+=e}),this);var f=0;h%8==0&&(_=!0,f=h/8);var d,p=r.StripOffsets.values,m=p.length;if(r.StripByteCounts)d=r.StripByteCounts.values;else{if(I(8003),1!==m)throw Error(L(6024));d=[Math.ceil(o*a*h/8)]}for(var v=1,g=1,y=0;y<m;y++){var x=p[y];s[y]=[];for(var S=d[y],C=0,A=0,b=1,T=!0,E=[],w=0,P=0,R=0;C<S;C+=b)switch(c){case 1:E=[];for(var D=0;D<l;D++){var O=u[D];if(!O.hasBytesPerSample){var N=this.getBits(O.bitsPerSample,x+C,A);throw E.push(N.bits),C=N.byteOffset-x,A=N.bitOffset,RangeError(L(6025))}var B=O.bytesPerSample*D;E.push(this.getBytes(O.bytesPerSample,x+C+B))}if(s[y].push(E),!_)throw b=0,RangeError(L(6026));b=f;break;case 2:case 3:case 4:case 5:case 6:case 7:break;case 32773:if(T){T=!1;var M=this.getUint8(x+C);M>=0&&M<=127?v=M+1:M>=-127&&M<=-1?g=1-M:T=!0}else{for(var F=this.getUint8(x+C),z=0;z<g;z++){var V=u[P];if(!V.hasBytesPerSample)throw RangeError(L(6025));R=R<<8*w|F,++w===V.bytesPerSample&&(E.push(R),R=w=0,P++),P===l&&(s[y].push(E),E=[],P=0)}0==--v&&(T=!0)}b=1}}if(t.getContext){var G=this._canvas.getContext("2d");G.fillStyle="rgba(255, 255, 255, 0)";var U=r.RowsPerStrip?r.RowsPerStrip.values[0]:a,k=s.length,H=a%U,j=0===H?U:H,W=U,q=0,X=r.PhotometricInterpretation.values[0],Y=[],K=0;r.ExtraSamples&&(K=(Y=r.ExtraSamples.values).length);var J=[],Q=0;r.ColorMap&&(J=r.ColorMap.values,Q=Math.pow(2,u[0].bitsPerSample));for(var Z=0;Z<k;Z++){Z+1===k&&(W=j);for(var $=s[Z].length,ee=q*Z,te=0,ne=0;te<W&&ne<$;te++)for(var ie=0;ie<o;ie++,ne++){var re=s[Z][ne],oe=0,ae=0,se=0,ce=1;if(K>0)for(var le=0;le<K;le++)if(1===Y[le]||2===Y[le]){ce=re[3+le]/256;break}!function(){switch(X){case 0:var e=0;u[0].hasBytesPerSample&&(e=Math.pow(16,2*u[0].bytesPerSample)),re.forEach((function(t,n,i){i[n]=e-t}));case 1:oe=ae=se=n.clampColorSample(re[0],u[0].bitsPerSample);break;case 2:oe=n.clampColorSample(re[0],u[0].bitsPerSample),ae=n.clampColorSample(re[1],u[1].bitsPerSample),se=n.clampColorSample(re[2],u[2].bitsPerSample);break;case 3:if(void 0===J)throw Error(L(6027));var t=re[0];oe=n.clampColorSample(J[t],16),ae=n.clampColorSample(J[Q+t],16),se=n.clampColorSample(J[2*Q+t],16);break;default:throw RangeError(L(6028,X))}}(),G.fillStyle="rgba("+oe+", "+ae+", "+se+", "+ce+")",G.fillRect(ie,ee+te,1,1)}q=W}}return this._canvas}},e}(),G0={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop"},U0={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"},k0=new Array(123),H0=0;H0<123;++H0)k0[H0]=64;for(var j0=0;j0<64;++j0)k0["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(j0)]=j0;var W0={name:"Jacob__Codec__Base64",decode:function(e){var t,n,i,r,o,a,s=[],c=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");c<e.length;)t=k0[e.charCodeAt(c++)]<<2|(r=k0[e.charCodeAt(c++)])>>4,n=(15&r)<<4|(o=k0[e.charCodeAt(c++)])>>2,i=(3&o)<<6|(a=k0[e.charCodeAt(c++)]),s.push(String.fromCharCode(t)),64!==o&&s.push(String.fromCharCode(n)),64!==a&&s.push(String.fromCharCode(i));return s.join("")},decodeAsArray:function(e,t){var n,i,r,o=this.decode(e),a=[];for(n=0,r=o.length/t;n<r;n++)for(a[n]=0,i=t-1;i>=0;--i)a[n]+=o.charCodeAt(n*t+i)<<8*i;return a}},q0=function(e){this.data=e,this.debug=!1,this.gpflags=void 0,this.files=0,this.unzipped=[],this.buf32k=new Array(32768),this.bIdx=0,this.modeZIP=!1,this.bytepos=0,this.bb=1,this.bits=0,this.nameBuf=[],this.fileout=void 0,this.literalTree=new Array(q0.LITERALS),this.distanceTree=new Array(32),this.treepos=0,this.Places=null,this.len=0,this.fpos=new Array(17),this.fpos[0]=0,this.flens=void 0,this.fmax=void 0};q0.gunzip=function(e){return e.constructor===Array||e.constructor,new q0(e).gunzip()[0][0]},q0.HufNode=function(){this.b0=0,this.b1=0,this.jump=null,this.jumppos=-1},q0.LITERALS=288,q0.NAMEMAX=256,q0.bitReverse=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243,11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251,7,135,71,199,39,167,103,231,23,151,87,215,55,183,119,247,15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255],q0.cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],q0.cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],q0.cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],q0.cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],q0.border=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],q0.prototype.gunzip=function(){return this.outputArr=[],this.nextFile(),this.unzipped},q0.prototype.readByte=function(){return this.bits+=8,this.bytepos<this.data.length?this.data.charCodeAt(this.bytepos++):-1},q0.prototype.byteAlign=function(){this.bb=1},q0.prototype.readBit=function(){var e;return this.bits++,e=1&this.bb,this.bb>>=1,0===this.bb&&(this.bb=this.readByte(),e=1&this.bb,this.bb=this.bb>>1|128),e},q0.prototype.readBits=function(e){for(var t=0,n=e;n--;)t=t<<1|this.readBit();return e&&(t=q0.bitReverse[t]>>8-e),t},q0.prototype.flushBuffer=function(){this.bIdx=0},q0.prototype.addBuffer=function(e){this.buf32k[this.bIdx++]=e,this.outputArr.push(String.fromCharCode(e)),32768===this.bIdx&&(this.bIdx=0)},q0.prototype.IsPat=function(){for(;;){if(this.fpos[this.len]>=this.fmax)return-1;if(this.flens[this.fpos[this.len]]===this.len)return this.fpos[this.len]++;this.fpos[this.len]++}},q0.prototype.Rec=function(){var e,t=this.Places[this.treepos];if(17===this.len)return-1;if(this.treepos++,this.len++,(e=this.IsPat())>=0)t.b0=e;else if(t.b0=32768,this.Rec())return-1;if((e=this.IsPat())>=0)t.b1=e,t.jump=null;else if(t.b1=32768,t.jump=this.Places[this.treepos],t.jumppos=this.treepos,this.Rec())return-1;return this.len--,0},q0.prototype.CreateTree=function(e,t,n){var i;for(this.Places=e,this.treepos=0,this.flens=n,this.fmax=t,i=0;i<17;i++)this.fpos[i]=0;return this.len=0,this.Rec()?-1:0},q0.prototype.DecodeValue=function(e){for(var t,n,i=0,r=e[i];;)if(this.readBit()){if(!(32768&r.b1))return r.b1;for(r=r.jump,t=e.length,n=0;n<t;n++)if(e[n]===r){i=n;break}}else{if(!(32768&r.b0))return r.b0;r=e[++i]}return-1},q0.prototype.DeflateLoop=function(){var e,t,n;do{var i,r;if(e=this.readBit(),0===(t=this.readBits(2)))for(this.byteAlign(),i=this.readByte(),i|=this.readByte()<<8,r=this.readByte(),65535&(i^~(r|=this.readByte()<<8))&&document.write("BlockLen checksum mismatch\n");i--;)o=this.readByte(),this.addBuffer(o);else if(1===t)for(;;)if((a=q0.bitReverse[this.readBits(7)]>>1)>23?(a=a<<1|this.readBit())>199?a=(a-=128)<<1|this.readBit():(a-=48)>143&&(a+=136):a+=256,a<256)this.addBuffer(a);else{if(256===a)break;for(a-=257,d=this.readBits(q0.cplext[a])+q0.cplens[a],a=q0.bitReverse[this.readBits(5)]>>3,q0.cpdext[a]>8?(p=this.readBits(8),p|=this.readBits(q0.cpdext[a]-8)<<8):p=this.readBits(q0.cpdext[a]),p+=q0.cpdist[a],a=0;a<d;a++){var o=this.buf32k[this.bIdx-p&32767];this.addBuffer(o)}}else if(2===t){var a,s,c,l,u,h=new Array(320);for(c=257+this.readBits(5),l=1+this.readBits(5),u=4+this.readBits(4),a=0;a<19;a++)h[a]=0;for(a=0;a<u;a++)h[q0.border[a]]=this.readBits(3);for(d=this.distanceTree.length,n=0;n<d;n++)this.distanceTree[n]=new q0.HufNode;if(this.CreateTree(this.distanceTree,19,h,0))return this.flushBuffer(),1;for(s=c+l,n=0;n<s;)if((a=this.DecodeValue(this.distanceTree))<16)h[n++]=a;else if(16===a){var _;if(n+(a=3+this.readBits(2))>s)return this.flushBuffer(),1;for(_=n?h[n-1]:0;a--;)h[n++]=_}else{if(n+(a=17===a?3+this.readBits(3):11+this.readBits(7))>s)return this.flushBuffer(),1;for(;a--;)h[n++]=0}for(d=this.literalTree.length,n=0;n<d;n++)this.literalTree[n]=new q0.HufNode;if(this.CreateTree(this.literalTree,c,h,0))return this.flushBuffer(),1;for(d=this.literalTree.length,n=0;n<d;n++)this.distanceTree[n]=new q0.HufNode;var f=new Array;for(n=c;n<h.length;n++)f[n-c]=h[n];if(this.CreateTree(this.distanceTree,l,f,0))return this.flushBuffer(),1;for(;;)if((a=this.DecodeValue(this.literalTree))>=256){var d,p;if(0==(a-=256))break;for(a--,d=this.readBits(q0.cplext[a])+q0.cplens[a],a=this.DecodeValue(this.distanceTree),q0.cpdext[a]>8?(p=this.readBits(8),p|=this.readBits(q0.cpdext[a]-8)<<8):p=this.readBits(q0.cpdext[a]),p+=q0.cpdist[a];d--;)o=this.buf32k[this.bIdx-p&32767],this.addBuffer(o)}else this.addBuffer(a)}}while(!e);return this.flushBuffer(),this.byteAlign(),0},q0.prototype.unzipFile=function(e){var t;for(this.gunzip(),t=0;t<this.unzipped.length;t++)if(this.unzipped[t][1]===e)return this.unzipped[t][0]},q0.prototype.nextFile=function(){this.outputArr=[],this.modeZIP=!1;var e=[];if(e[0]=this.readByte(),e[1]=this.readByte(),120===e[0]&&218===e[1]&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),"geonext.gxt"],this.files++),31===e[0]&&139===e[1]&&(this.skipdir(),this.unzipped[this.files]=[this.outputArr.join(""),"file"],this.files++),80===e[0]&&75===e[1]&&(this.modeZIP=!0,e[2]=this.readByte(),e[3]=this.readByte(),3===e[2]&&4===e[3])){e[0]=this.readByte(),e[1]=this.readByte(),this.gpflags=this.readByte(),this.gpflags|=this.readByte()<<8;var t=this.readByte();t|=this.readByte()<<8,this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte();var n=this.readByte();n|=this.readByte()<<8;var i=this.readByte();for(i|=this.readByte()<<8,o=0,this.nameBuf=[];n--;){var r=this.readByte();"/"===r|":"===r?o=0:o<q0.NAMEMAX-1&&(this.nameBuf[o++]=String.fromCharCode(r))}this.fileout||(this.fileout=this.nameBuf);for(var o=0;o<i;)r=this.readByte(),o++;8===t&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),this.nameBuf.join("")],this.files++),this.skipdir()}},q0.prototype.skipdir=function(){var e,t,n=[];if(8&this.gpflags&&(n[0]=this.readByte(),n[1]=this.readByte(),n[2]=this.readByte(),n[3]=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte()),this.modeZIP&&this.nextFile(),n[0]=this.readByte(),8!==n[0])return 0;if(this.gpflags=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),4&this.gpflags)for(n[0]=this.readByte(),n[2]=this.readByte(),this.len=n[0]+256*n[1],e=0;e<this.len;e++)this.readByte();if(8&this.gpflags)for(e=0,this.nameBuf=[];t=this.readByte();)"7"!==t&&":"!==t||(e=0),e<q0.NAMEMAX-1&&(this.nameBuf[e++]=t);if(16&this.gpflags)for(;t=this.readByte(););2&this.gpflags&&(this.readByte(),this.readByte()),this.DeflateLoop(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.modeZIP&&this.nextFile()};var X0,Y0,K0,J0,Q0,Z0,$0,e1,t1,n1,i1,r1,o1,a1,s1,c1,l1,u1,h1,_1,f1,d1,p1,m1,v1,g1,y1,x1,S1,C1,A1,b1,T1,E1,w1,I1,P1,R1,D1,O1,N1,B1,M1,L1,F1,z1,V1,G1,U1,k1,H1,j1,W1,q1,X1,Y1,K1,J1,Q1,Z1,$1,e2,t2,n2,i2,r2,o2,a2,s2,c2,l2,u2,h2,_2,f2,d2,p2,m2,v2,g2,y2,x2,S2,C2,A2,b2,T2,E2,w2,I2,P2,R2,D2,O2,N2,B2,M2,L2,F2,z2,V2,G2,U2,k2={name:"Jacob__Codec"};function H2(e){var t=e.parent,n=e.getComponent(r4);return t&&n?H2(t):e.getComponentsInChildren(r4)}k2.Base64=W0,k2.GZip=q0,k2.unzip=function(){return k2.GZip.gunzip.apply(k2.GZip,arguments)},k2.unzipBase64=function(){var e=k2.Base64.decode.apply(k2.Base64,arguments);try{return k2.GZip.gunzip.call(k2.GZip,e)}catch(t){return e.slice(7)}},k2.unzipBase64AsArray=function(e,t){t=t||1;var n,i,r,o=this.unzipBase64(e),a=[];for(n=0,r=o.length/t;n<r;n++)for(a[n]=0,i=t-1;i>=0;--i)a[n]+=o.charCodeAt(n*t+i)<<8*i;return a},k2.unzipAsArray=function(e,t){t=t||1;var n,i,r,o=this.unzip(e),a=[];for(n=0,r=o.length/t;n<r;n++)for(a[n]=0,i=t-1;i>=0;--i)a[n]+=o.charCodeAt(n*t+i)<<8*i;return a},function(e){e[e.JPG=0]="JPG",e[e.PNG=1]="PNG",e[e.TIFF=2]="TIFF",e[e.WEBP=3]="WEBP",e[e.PVR=4]="PVR",e[e.ETC=5]="ETC",e[e.S3TC=6]="S3TC",e[e.ATITC=7]="ATITC",e[e.TGA=8]="TGA",e[e.RAWDATA=9]="RAWDATA",e[e.UNKNOWN=10]="UNKNOWN"}(U2||(U2={}));var j2,W2,q2,X2,Y2,K2,J2,Q2,Z2,$2,e4,t4,n4,i4,r4=e("ParticleSystem2D",(X0=Ac("cc.ParticleSystem2D"),Y0=Fc(),K0=Zc(),J0=qc(),Q0=ol(M0),Z0=Zc(),$0=qc(),e1=ol(BL),t1=qc(),n1=qc(),i1=qc(),r1=qc(),o1=qc(),a1=qc(),s1=qc(),c1=qc(),l1=Hc(),u1=qc(),h1=qc(),_1=qc(),f1=qc(),d1=qc(),p1=qc(),m1=qc(),v1=qc(),g1=qc(),y1=qc(),x1=qc(),S1=qc(),C1=qc(),A1=ol(T0),b1=qc(),T1=Zc(),E1=qc(),w1=ol(b0),I1=qc(),P1=qc(),R1=qc(),D1=qc(),O1=qc(),N1=qc(),B1=qc(),M1=qc(),L1=qc(),F1=qc(),z1=qc(),V1=qc(),G1=qc(),U1=qc(),k1=qc(),H1=Zc(),j1=qc(),W1=Zc(),q1=qc(),X1=Oc("preview"),X0(Y1=Y0(Y1=zc(Y1=Lc((G2=V2=function(e){function t(){var t;return se(t=e.call(this)||this,"duration",J1,re(t)),se(t,"emissionRate",Q1,re(t)),se(t,"life",Z1,re(t)),se(t,"lifeVar",$1,re(t)),se(t,"angle",e2,re(t)),se(t,"angleVar",t2,re(t)),se(t,"startSize",n2,re(t)),se(t,"startSizeVar",i2,re(t)),se(t,"endSize",r2,re(t)),se(t,"endSizeVar",o2,re(t)),se(t,"startSpin",a2,re(t)),se(t,"startSpinVar",s2,re(t)),se(t,"endSpin",c2,re(t)),se(t,"endSpinVar",l2,re(t)),se(t,"sourcePos",u2,re(t)),se(t,"posVar",h2,re(t)),se(t,"emitterMode",_2,re(t)),se(t,"gravity",f2,re(t)),se(t,"speed",d2,re(t)),se(t,"speedVar",p2,re(t)),se(t,"tangentialAccel",m2,re(t)),se(t,"tangentialAccelVar",v2,re(t)),se(t,"radialAccel",g2,re(t)),se(t,"radialAccelVar",y2,re(t)),se(t,"rotationIsDir",x2,re(t)),se(t,"startRadius",S2,re(t)),se(t,"startRadiusVar",C2,re(t)),se(t,"endRadius",A2,re(t)),se(t,"endRadiusVar",b2,re(t)),se(t,"rotatePerS",T2,re(t)),se(t,"rotatePerSVar",E2,re(t)),t.aspectRatio=1,se(t,"playOnLoad",w2,re(t)),se(t,"autoRemoveOnFinish",I2,re(t)),se(t,"_preview",P2,re(t)),se(t,"_custom",R2,re(t)),se(t,"_file",D2,re(t)),se(t,"_spriteFrame",O2,re(t)),se(t,"_totalParticles",N2,re(t)),se(t,"_startColor",B2,re(t)),se(t,"_startColorVar",M2,re(t)),se(t,"_endColor",L2,re(t)),se(t,"_endColorVar",F2,re(t)),se(t,"_positionType",z2,re(t)),t._stopped=!0,t.initProperties(),t}Z(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this._updateMaterial()},n.onDestroy=function(){e.prototype.onDestroy.call(this),this.autoRemoveOnFinish&&(this.autoRemoveOnFinish=!1),this._simulator.uvFilled=0,this._simulator.renderData&&this._assembler&&this._assembler.removeData(this._simulator.renderData)},n.initProperties=function(){this._previewTimer=null,this._focused=!1,this.aspectRatio=1,this._simulator=new B0(this)},n.onFocusInEditor=function(){this._focused=!0;for(var e=H2(this.node),t=0;t<e.length;++t)e[t]._startPreview()},n.onLostFocusInEditor=function(){this._focused=!1;for(var e=H2(this.node),t=0;t<e.length;++t)e[t]._stopPreview()},n._startPreview=function(){this._preview&&this.resetSystem()},n._stopPreview=function(){this._preview&&(this.resetSystem(),this.stopSystem()),this._previewTimer&&clearInterval(this._previewTimer)},n.__preload=function(){e.prototype.__preload.call(this),this._custom&&this.spriteFrame&&!this._renderSpriteFrame?this._applySpriteFrame():this._file&&(this._custom?!this._getTexture()&&this._applyFile():this._applyFile()),this.playOnLoad&&this.resetSystem()},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._assembler&&this._assembler.createData&&(this._simulator.renderData=this._assembler.createData(this))},n.lateUpdate=function(e){this._simulator.finished||this._simulator.step(e)},n.addParticle=function(){},n.stopSystem=function(){this._stopped=!0,this._simulator.stop()},n.resetSystem=function(){this._stopped=!1,this._simulator.reset(),this._renderFlag=this._canRender()},n.isFull=function(){return this.particleCount>=this.totalParticles},n._applyFile=function(){var e=this._file;if(e){if(!e)return void O(6029);if(!this.isValid)return;this._plistFile=e.nativeUrl,this._custom||(this._spriteFrame!==e.spriteFrame&&(this.spriteFrame=e.spriteFrame),this._initWithDictionary(e._nativeAsset)),this._spriteFrame?!this._renderSpriteFrame&&this._spriteFrame&&this._applySpriteFrame():e.spriteFrame?this.spriteFrame=e.spriteFrame:this._custom&&this._initTextureWithDictionary(e._nativeAsset)}},n._initTextureWithDictionary=function(e){var t,n=this;if(e.spriteFrameUuid){var i=e.spriteFrameUuid;hB.loadAny(i,(function(t,i){t?(e.spriteFrameUuid=void 0,n._initTextureWithDictionary(e),S(t)):n.spriteFrame=i}))}else{var r=Su(this._plistFile,e.textureFileName||"");if(e.textureFileName)hB.loadRemote(r,(function(t,i){t?(e.textureFileName=void 0,n._initTextureWithDictionary(e),S(t)):n.spriteFrame=i?BL.createWithImage(i):BL.createWithImage(yv.get("white-texture"))}));else if(e.textureImageData){var o=e.textureImageData;if(!(o&&o.length>0))return!1;var a=hB.assets.get(r);if(!a){var s=k2.unzipBase64AsArray(o,1);if(!s)return R(6030,this._file.name),!1;var c=(t=s).length>8&&137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]&&13===t[4]&&10===t[5]&&26===t[6]&&10===t[7]?U2.PNG:t.length>2&&(73===t[0]&&73===t[1]||77===t[0]&&77===t[1]||255===t[0]&&216===t[1])?U2.TIFF:U2.UNKNOWN;if(c!==U2.TIFF&&c!==U2.PNG)return R(6031,this._file.name),!1;var l=document.createElement("canvas");c===U2.PNG?new z0(s).render(l):(this._tiffReader||(this._tiffReader=new V0),this._tiffReader.parseTIFF(s,l)),a=new Um(l),hB.assets.add(r,a)}a||R(6032,this._file.name),this.spriteFrame=a?BL.createWithImage(a):BL.createWithImage(yv.get("white-texture"))}}return!0},n._initWithDictionary=function(e){this.totalParticles=parseInt(e.maxParticles||0),this.life=parseFloat(e.particleLifespan||0),this.lifeVar=parseFloat(e.particleLifespanVariance||0);var t=e.emissionRate;this.emissionRate=t||Math.min(this.totalParticles/this.life,Number.MAX_VALUE),this.duration=parseFloat(e.duration||0),this._srcBlendFactor=parseInt(e.blendFuncSource||Ri.SRC_ALPHA),this._dstBlendFactor=parseInt(e.blendFuncDestination||Ri.ONE_MINUS_SRC_ALPHA);var n=this._startColor;n.r=255*parseFloat(e.startColorRed||0),n.g=255*parseFloat(e.startColorGreen||0),n.b=255*parseFloat(e.startColorBlue||0),n.a=255*parseFloat(e.startColorAlpha||0);var i=this._startColorVar;i.r=255*parseFloat(e.startColorVarianceRed||0),i.g=255*parseFloat(e.startColorVarianceGreen||0),i.b=255*parseFloat(e.startColorVarianceBlue||0),i.a=255*parseFloat(e.startColorVarianceAlpha||0);var r=this._endColor;r.r=255*parseFloat(e.finishColorRed||0),r.g=255*parseFloat(e.finishColorGreen||0),r.b=255*parseFloat(e.finishColorBlue||0),r.a=255*parseFloat(e.finishColorAlpha||0);var o=this._endColorVar;if(o.r=255*parseFloat(e.finishColorVarianceRed||0),o.g=255*parseFloat(e.finishColorVarianceGreen||0),o.b=255*parseFloat(e.finishColorVarianceBlue||0),o.a=255*parseFloat(e.finishColorVarianceAlpha||0),this.startSize=parseFloat(e.startParticleSize||0),this.startSizeVar=parseFloat(e.startParticleSizeVariance||0),this.endSize=parseFloat(e.finishParticleSize||0),this.endSizeVar=parseFloat(e.finishParticleSizeVariance||0),this.positionType=parseFloat(void 0!==e.positionType?e.positionType:T0.FREE),this.sourcePos.set(0,0),this.posVar.set(parseFloat(e.sourcePositionVariancex||0),parseFloat(e.sourcePositionVariancey||0)),this.angle=parseFloat(e.angle||0),this.angleVar=parseFloat(e.angleVariance||0),this.startSpin=parseFloat(e.rotationStart||0),this.startSpinVar=parseFloat(e.rotationStartVariance||0),this.endSpin=parseFloat(e.rotationEnd||0),this.endSpinVar=parseFloat(e.rotationEndVariance||0),this.emitterMode=parseInt(e.emitterType||b0.GRAVITY),this.emitterMode===b0.GRAVITY){this.gravity.set(parseFloat(e.gravityx||0),parseFloat(e.gravityy||0)),this.speed=parseFloat(e.speed||0),this.speedVar=parseFloat(e.speedVariance||0),this.radialAccel=parseFloat(e.radialAcceleration||0),this.radialAccelVar=parseFloat(e.radialAccelVariance||0),this.tangentialAccel=parseFloat(e.tangentialAcceleration||0),this.tangentialAccelVar=parseFloat(e.tangentialAccelVariance||0);var a=e.rotationIsDir||"";null!==a?(a=a.toString().toLowerCase(),this.rotationIsDir="true"===a||"1"===a):this.rotationIsDir=!1}else{if(this.emitterMode!==b0.RADIUS)return R(6009),!1;this.startRadius=parseFloat(e.maxRadius||0),this.startRadiusVar=parseFloat(e.maxRadiusVariance||0),this.endRadius=parseFloat(e.minRadius||0),this.endRadiusVar=parseFloat(e.minRadiusVariance||0),this.rotatePerS=parseFloat(e.rotatePerSecond||0),this.rotatePerSVar=parseFloat(e.rotatePerSecondVariance||0)}return this._initTextureWithDictionary(e),!0},n._syncAspect=function(){if(this._renderSpriteFrame){var e=this._renderSpriteFrame.rect;this.aspectRatio=e.width/e.height}},n._applySpriteFrame=function(){this._renderSpriteFrame=this._renderSpriteFrame||this._spriteFrame,this._renderSpriteFrame?this._renderSpriteFrame.texture&&(this._simulator.updateUVs(!0),this._syncAspect(),this._updateMaterial(),this._stopped=!1,this._renderFlag=this._canRender()):this.resetSystem()},n._getTexture=function(){return this._renderSpriteFrame&&this._renderSpriteFrame.texture},n._updateMaterial=function(){var e=this.getMaterialInstance(0);e&&e.recompileShaders({USE_LOCAL:this._positionType!==T0.FREE})},n._finishedSimulation=function(){this.resetSystem(),this.stopSystem(),this._renderFlag=this._canRender(),this.autoRemoveOnFinish&&this._stopped&&this.node.destroy()},n._canRender=function(){return e.prototype._canRender.call(this)&&!this._stopped&&null!==this._renderSpriteFrame},n._render=function(e){this._positionType===T0.RELATIVE?e.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node.parent):this.positionType===T0.GROUPED?e.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,this.node):e.commitComp(this,this._simulator.renderData,this._renderSpriteFrame,this._assembler,null)},J(t,[{key:"custom",get:function(){return this._custom},set:function(e){this._custom!==e&&(this._custom=e,this._applyFile())}},{key:"file",get:function(){return this._file},set:function(e){this._file!==e&&(this._file=e,e?this._applyFile():this.custom=!0)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._renderSpriteFrame!==e&&(this._renderSpriteFrame=e,e&&!e._uuid||(this._spriteFrame=e),this._applySpriteFrame())}},{key:"particleCount",get:function(){return this._simulator.particles.length}},{key:"totalParticles",get:function(){return this._totalParticles},set:function(e){this._totalParticles!==e&&(this._totalParticles=e)}},{key:"startColor",get:function(){return this._startColor},set:function(e){this._startColor.r=e.r,this._startColor.g=e.g,this._startColor.b=e.b,this._startColor.a=e.a}},{key:"startColorVar",get:function(){return this._startColorVar},set:function(e){this._startColorVar.r=e.r,this._startColorVar.g=e.g,this._startColorVar.b=e.b,this._startColorVar.a=e.a}},{key:"color",get:function(){return this._color},set:function(){}},{key:"endColor",get:function(){return this._endColor},set:function(e){this._endColor.r=e.r,this._endColor.g=e.g,this._endColor.b=e.b,this._endColor.a=e.a}},{key:"endColorVar",get:function(){return this._endColorVar},set:function(e){this._endColorVar.r=e.r,this._endColorVar.g=e.g,this._endColorVar.b=e.b,this._endColorVar.a=e.a}},{key:"positionType",get:function(){return this._positionType},set:function(e){this._positionType=e,this._updateMaterial()}},{key:"preview",get:function(){return this._preview},set:function(e){e?this._startPreview():this._stopPreview(),this._preview=e}},{key:"stopped",get:function(){return this._stopped}},{key:"active",get:function(){return this._simulator.active}},{key:"assembler",get:function(){return this._assembler}}]),t}(YV),V2.EmitterMode=b0,V2.PositionType=T0,V2.DURATION_INFINITY=-1,V2.START_SIZE_EQUAL_TO_END_SIZE=-1,V2.START_RADIUS_EQUAL_TO_END_RADIUS=-1,ce((K1=G2).prototype,"custom",[kc,K0,J0],Object.getOwnPropertyDescriptor(K1.prototype,"custom"),K1.prototype),ce(K1.prototype,"file",[Q0,Z0,$0],Object.getOwnPropertyDescriptor(K1.prototype,"file"),K1.prototype),ce(K1.prototype,"spriteFrame",[e1,t1],Object.getOwnPropertyDescriptor(K1.prototype,"spriteFrame"),K1.prototype),ce(K1.prototype,"totalParticles",[kc,n1],Object.getOwnPropertyDescriptor(K1.prototype,"totalParticles"),K1.prototype),J1=ce(K1.prototype,"duration",[Dc,kc,i1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Q1=ce(K1.prototype,"emissionRate",[Dc,kc,r1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Z1=ce(K1.prototype,"life",[Dc,kc,o1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$1=ce(K1.prototype,"lifeVar",[Dc,kc,a1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ce(K1.prototype,"startColor",[kc,s1],Object.getOwnPropertyDescriptor(K1.prototype,"startColor"),K1.prototype),ce(K1.prototype,"startColorVar",[kc,c1],Object.getOwnPropertyDescriptor(K1.prototype,"startColorVar"),K1.prototype),ce(K1.prototype,"color",[l1],Object.getOwnPropertyDescriptor(K1.prototype,"color"),K1.prototype),ce(K1.prototype,"endColor",[kc,u1],Object.getOwnPropertyDescriptor(K1.prototype,"endColor"),K1.prototype),ce(K1.prototype,"endColorVar",[kc,h1],Object.getOwnPropertyDescriptor(K1.prototype,"endColorVar"),K1.prototype),e2=ce(K1.prototype,"angle",[Dc,kc,_1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),t2=ce(K1.prototype,"angleVar",[Dc,kc,f1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),n2=ce(K1.prototype,"startSize",[Dc,kc,d1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),i2=ce(K1.prototype,"startSizeVar",[Dc,kc,p1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),r2=ce(K1.prototype,"endSize",[Dc,kc,m1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),o2=ce(K1.prototype,"endSizeVar",[Dc,kc,v1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a2=ce(K1.prototype,"startSpin",[Dc,kc,g1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),s2=ce(K1.prototype,"startSpinVar",[Dc,kc,y1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c2=ce(K1.prototype,"endSpin",[Dc,kc,x1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),l2=ce(K1.prototype,"endSpinVar",[Dc,kc,S1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),u2=ce(K1.prototype,"sourcePos",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yn.ZERO.clone()}}),h2=ce(K1.prototype,"posVar",[Dc,kc,C1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yn.ZERO.clone()}}),ce(K1.prototype,"positionType",[A1,b1],Object.getOwnPropertyDescriptor(K1.prototype,"positionType"),K1.prototype),ce(K1.prototype,"preview",[kc,T1,E1],Object.getOwnPropertyDescriptor(K1.prototype,"preview"),K1.prototype),_2=ce(K1.prototype,"emitterMode",[Dc,kc,w1,I1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return b0.GRAVITY}}),f2=ce(K1.prototype,"gravity",[Dc,kc,P1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yn.ZERO.clone()}}),d2=ce(K1.prototype,"speed",[Dc,kc,R1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 180}}),p2=ce(K1.prototype,"speedVar",[Dc,kc,D1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),m2=ce(K1.prototype,"tangentialAccel",[Dc,kc,O1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 80}}),v2=ce(K1.prototype,"tangentialAccelVar",[Dc,kc,N1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),g2=ce(K1.prototype,"radialAccel",[Dc,kc,B1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),y2=ce(K1.prototype,"radialAccelVar",[Dc,kc,M1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),x2=ce(K1.prototype,"rotationIsDir",[Dc,kc,L1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),S2=ce(K1.prototype,"startRadius",[Dc,kc,F1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C2=ce(K1.prototype,"startRadiusVar",[Dc,kc,z1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A2=ce(K1.prototype,"endRadius",[Dc,kc,V1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b2=ce(K1.prototype,"endRadiusVar",[Dc,kc,G1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T2=ce(K1.prototype,"rotatePerS",[Dc,kc,U1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),E2=ce(K1.prototype,"rotatePerSVar",[Dc,kc,k1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),w2=ce(K1.prototype,"playOnLoad",[Dc,kc,H1,j1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),I2=ce(K1.prototype,"autoRemoveOnFinish",[Dc,kc,W1,q1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),P2=ce(K1.prototype,"_preview",[X1],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),R2=ce(K1.prototype,"_custom",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),D2=ce(K1.prototype,"_file",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),O2=ce(K1.prototype,"_spriteFrame",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),N2=ce(K1.prototype,"_totalParticles",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 150}}),B2=ce(K1.prototype,"_startColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(255,255,255,255)}}),M2=ce(K1.prototype,"_startColorVar",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(0,0,0,0)}}),L2=ce(K1.prototype,"_endColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(255,255,255,0)}}),F2=ce(K1.prototype,"_endColorVar",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(0,0,0,0)}}),z2=ce(K1.prototype,"_positionType",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return T0.FREE}}),Y1=K1))||Y1)||Y1)||Y1)||Y1)),o4=function(){function e(e,t){this.point=new Yn,this.dir=new Yn,this.distance=0,this.time=0,e&&this.point.set(e),t&&this.dir.set(t)}var t=e.prototype;return t.setPoint=function(e,t){this.point.x=e,this.point.y=t},t.setDir=function(e,t){this.dir.x=e,this.dir.y=t},e}(),a4=e("MotionStreak",(j2=Ac("cc.MotionStreak"),W2=Fc(),q2=Uc(),X2=ol(uv),j2(Y2=Lc(Y2=zc(Y2=W2(Y2=q2((i4=n4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_preview",J2,re(t)),se(t,"_fadeTime",Q2,re(t)),se(t,"_minSeg",Z2,re(t)),se(t,"_stroke",$2,re(t)),se(t,"_texture",e4,re(t)),se(t,"_fastMode",t4,re(t)),t._points=[],t}Z(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this.reset()},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n.onFocusInEditor=function(){this._preview&&this.reset()},n.onLostFocusInEditor=function(){this._preview&&this.reset()},n.reset=function(){this._points.length=0,this._renderData&&this._renderData.clear()},n.lateUpdate=function(e){this._assembler&&this._assembler.update(this,e)},n._render=function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)},J(t,[{key:"preview",get:function(){return this._preview},set:function(e){this._preview=e,this.reset()}},{key:"fadeTime",get:function(){return this._fadeTime},set:function(e){this._fadeTime=e,this.reset()}},{key:"minSeg",get:function(){return this._minSeg},set:function(e){this._minSeg=e}},{key:"stroke",get:function(){return this._stroke},set:function(e){this._stroke=e}},{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e)}},{key:"fastMode",get:function(){return this._fastMode},set:function(e){this._fastMode=e}},{key:"points",get:function(){return this._points}}]),t}(YV),n4.Point=o4,ce((K2=i4).prototype,"preview",[kc],Object.getOwnPropertyDescriptor(K2.prototype,"preview"),K2.prototype),ce(K2.prototype,"fadeTime",[kc],Object.getOwnPropertyDescriptor(K2.prototype,"fadeTime"),K2.prototype),ce(K2.prototype,"minSeg",[kc],Object.getOwnPropertyDescriptor(K2.prototype,"minSeg"),K2.prototype),ce(K2.prototype,"stroke",[kc],Object.getOwnPropertyDescriptor(K2.prototype,"stroke"),K2.prototype),ce(K2.prototype,"texture",[X2],Object.getOwnPropertyDescriptor(K2.prototype,"texture"),K2.prototype),ce(K2.prototype,"fastMode",[kc],Object.getOwnPropertyDescriptor(K2.prototype,"fastMode"),K2.prototype),J2=ce(K2.prototype,"_preview",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Q2=ce(K2.prototype,"_fadeTime",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Z2=ce(K2.prototype,"_minSeg",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$2=ce(K2.prototype,"_stroke",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),e4=ce(K2.prototype,"_texture",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),t4=ce(K2.prototype,"_fastMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Y2=K2))||Y2)||Y2)||Y2)||Y2)||Y2)),s4=(new Yn,new Yn),c4=new Yn;function l4(e,t){return e.x=-t.y,e.y=t.x,e}var u4={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.resize(16,42),t},update:function(e,t){var n,i=e.stroke/2,r=e.node.worldMatrix,o=r.m12,a=r.m13,s=e.points;if(s.length>1){var c=s[0],l=c.point.x-o,u=c.point.y-a;l*l+u*u<e.minSeg&&(n=c)}n||(n=new a4.Point,s.unshift(n)),n.setPoint(o,a),n.time=e.fadeTime+t;var h,_=0;if(!(s.length<2)){var f=e.renderData;this.updateRenderDataCache(e,f);var d=e.color,p=d.r,m=d.g,v=d.b,g=d.a,y=s[1];y.distance=Yn.subtract(c4,n.point,y.point).length(),c4.normalize(),y.setDir(c4.x,c4.y),n.setDir(c4.x,c4.y),f.dataLength=2*s.length;for(var x=f.data,S=e.fadeTime,C=!1,A=s.length-1;A>=0;A--){var b=s[A],T=b.point,E=b.dir;if(b.time-=t,b.time<0)s.splice(A,1);else{var w=b.time/S,I=s[A-1];if(!C){if(!I){s.splice(A,1);continue}T.x=I.point.x-E.x*w,T.y=I.point.y-E.y*w}C=!0,l4(s4,E);var P=(w*g<<24>>>0)+(v<<16)+(m<<8)+p,R=_;x[R].x=T.x+s4.x*i,x[R].y=T.y+s4.y*i,x[R].u=1,x[R].v=w,x[R].color._val=P,x[R+=1].x=T.x-s4.x*i,x[R].y=T.y-s4.y*i,x[R].u=0,x[R].v=w,x[R].color._val=P,_+=2}}h=_<=2?0:3*(_-2),f.resize(_,h)}},updateRenderDataCache:function(e,t){t.passDirty&&t.updatePass(e),t.nodeDirty&&t.updateNode(e),t.textureDirty&&e.texture&&(t.updateTexture(e.texture),t.material=e.getRenderMaterial(0)),t.hashDirty&&t.updateHash()},updateRenderData:function(){},updateColor:function(){},fillBuffers:function(e){for(var t=e.renderData,n=t.chunk,i=t.data,r=t.vertexCount,o=t.indexCount,a=n.vb,s=0,c=0;c<r;c++){var l=i[c];a[s++]=l.x,a[s++]=l.y,a[s++]=l.z,a[s++]=l.u,a[s++]=l.v,wn.toArray(a,l.color,s),s+=4}for(var u=n.bufferId,h=n.vertexOffset,_=n.vertexAccessor.getMeshBuffer(n.bufferId),f=n.vertexAccessor.getIndexBuffer(u),d=_.indexOffset,p=0,m=o;p<m;p+=2){var v=h+p;f[d++]=v,f[d++]=v+2,f[d++]=v+1,f[d++]=v+1,f[d++]=v+2,f[d++]=v+3}_.indexOffset+=t.indexCount,_.setDirty()}},h4=e("MotionStreakAssemblerManager",{getAssembler:function(){return u4}});a4.Assembler=h4;var _4,f4,d4={maxParticleDeltaTime:0,createData:function(){return ez.add()},removeData:function(e){ez.remove(e)},updateRenderData:function(){},fillBuffers:function(){}},p4=e("ParticleSystem2DAssembler",{getAssembler:function(){return d4.maxParticleDeltaTime||(d4.maxParticleDeltaTime=l.game.frameTime/1e3*2),d4}});r4.Assembler=p4,"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var m4,v4=function(e,t){return function(e,t){!function(e){function t(e){if(!e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];throw ne(Error,n)}}function n(e,t){return void 0!==e?e:t}var i=1e37,r=1e-5,o=r*r,a=3.14159265359,s=2,c=8,l=.1,u=2,h=.008,_=2/180*a,f=2*h,d=8,p=32,m=1,v=.2,g=8/180*a,y=2,x=y*y,S=.5*a,C=S*S,A=.2,b=.75,T=-1,E=2147483647,w=.75,I=1,P=.25,R=.5,D=2,O=D*D,N=256,B=2.5,M=.5,L=.01,F=2/180*a;function z(){return null}function V(){}function G(){}var U=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.major=0,this.minor=0,this.revision=0,this.major=e,this.minor=t,this.revision=n}return e.prototype.toString=function(){return this.major+"."+this.minor+"."+this.revision},e}(),k=new U(2,3,2),H="master",j="fbf51801d80fc389d43dc46524520e89043b6faf";function W(e){return parseInt(e,10)}function q(e){return Math.abs(parseInt(e,10))}function X(e,t){for(var n=new Array(e),i=0;i<e;++i)n[i]=t(i);return n}function Y(e){for(var t=new Array(e),n=0;n<e;++n)t[n]=null;return t}function K(e,t){void 0===t&&(t=0);for(var n=new Array(e),i=0;i<e;++i)n[i]=t;return n}var Q=a/180,$=180/a,ee=2*a,te=Math.abs;function ie(e,t){return e<t?e:t}function re(e,t){return e>t?e:t}function oe(e,t,n){return e<t?t:e>n?n:e}function se(e,t){var n=e[0];e[0]=t[0],t[0]=n}var ce=isFinite;function le(e){return e*e}function ue(e){return 1/Math.sqrt(e)}var he=Math.sqrt,_e=Math.pow;function fe(e){return e*Q}function de(e){return e*$}var pe=Math.cos,me=Math.sin,ve=Math.acos,ge=Math.asin,ye=Math.atan2;function xe(e){return e|=e>>1&2147483647,e|=e>>2&1073741823,e|=e>>4&268435455,1+((e|=e>>8&16777215)|e>>16&65535)}function Se(e){return e>0&&0==(e&e-1)}function Ce(){return 2*Math.random()-1}function Ae(e,t){return(t-e)*Math.random()+e}var be=function(){function e(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(t[0]instanceof Float32Array){if(2!==t[0].length)throw new Error;this.data=t[0]}else{var i="number"==typeof t[0]?t[0]:0,r="number"==typeof t[1]?t[1]:0;this.data=new Float32Array([i,r])}}var t=e.prototype;return t.Clone=function(){return new e(this.x,this.y)},t.SetZero=function(){return this.x=0,this.y=0,this},t.Set=function(e,t){return this.x=e,this.y=t,this},t.Copy=function(e){return this.x=e.x,this.y=e.y,this},t.SelfAdd=function(e){return this.x+=e.x,this.y+=e.y,this},t.SelfAddXY=function(e,t){return this.x+=e,this.y+=t,this},t.SelfSub=function(e){return this.x-=e.x,this.y-=e.y,this},t.SelfSubXY=function(e,t){return this.x-=e,this.y-=t,this},t.SelfMul=function(e){return this.x*=e,this.y*=e,this},t.SelfMulAdd=function(e,t){return this.x+=e*t.x,this.y+=e*t.y,this},t.SelfMulSub=function(e,t){return this.x-=e*t.x,this.y-=e*t.y,this},t.Dot=function(e){return this.x*e.x+this.y*e.y},t.Cross=function(e){return this.x*e.y-this.y*e.x},t.Length=function(){var e=this.x,t=this.y;return Math.sqrt(e*e+t*t)},t.LengthSquared=function(){var e=this.x,t=this.y;return e*e+t*t},t.Normalize=function(){var e=this.Length();if(e>=r){var t=1/e;this.x*=t,this.y*=t}return e},t.SelfNormalize=function(){var e=this.Length();if(e>=r){var t=1/e;this.x*=t,this.y*=t}return this},t.SelfRotate=function(e){var t=Math.cos(e),n=Math.sin(e),i=this.x;return this.x=t*i-n*this.y,this.y=n*i+t*this.y,this},t.SelfRotateCosSin=function(e,t){var n=this.x;return this.x=e*n-t*this.y,this.y=t*n+e*this.y,this},t.IsValid=function(){return isFinite(this.x)&&isFinite(this.y)},t.SelfCrossVS=function(e){var t=this.x;return this.x=e*this.y,this.y=-e*t,this},t.SelfCrossSV=function(e){var t=this.x;return this.x=-e*this.y,this.y=e*t,this},t.SelfMinV=function(e){return this.x=ie(this.x,e.x),this.y=ie(this.y,e.y),this},t.SelfMaxV=function(e){return this.x=re(this.x,e.x),this.y=re(this.y,e.y),this},t.SelfAbs=function(){return this.x=te(this.x),this.y=te(this.y),this},t.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this},t.SelfSkew=function(){var e=this.x;return this.x=-this.y,this.y=e,this},e.MakeArray=function(t){return X(t,(function(){return new e}))},e.AbsV=function(e,t){return t.x=te(e.x),t.y=te(e.y),t},e.MinV=function(e,t,n){return n.x=ie(e.x,t.x),n.y=ie(e.y,t.y),n},e.MaxV=function(e,t,n){return n.x=re(e.x,t.x),n.y=re(e.y,t.y),n},e.ClampV=function(e,t,n,i){return i.x=oe(e.x,t.x,n.x),i.y=oe(e.y,t.y,n.y),i},e.RotateV=function(e,t,n){var i=e.x,r=e.y,o=Math.cos(t),a=Math.sin(t);return n.x=o*i-a*r,n.y=a*i+o*r,n},e.DotVV=function(e,t){return e.x*t.x+e.y*t.y},e.CrossVV=function(e,t){return e.x*t.y-e.y*t.x},e.CrossVS=function(e,t,n){var i=e.x;return n.x=t*e.y,n.y=-t*i,n},e.CrossVOne=function(e,t){var n=e.x;return t.x=e.y,t.y=-n,t},e.CrossSV=function(e,t,n){var i=t.x;return n.x=-e*t.y,n.y=e*i,n},e.CrossOneV=function(e,t){var n=e.x;return t.x=-e.y,t.y=n,t},e.AddVV=function(e,t,n){return n.x=e.x+t.x,n.y=e.y+t.y,n},e.SubVV=function(e,t,n){return n.x=e.x-t.x,n.y=e.y-t.y,n},e.MulSV=function(e,t,n){return n.x=t.x*e,n.y=t.y*e,n},e.MulVS=function(e,t,n){return n.x=e.x*t,n.y=e.y*t,n},e.AddVMulSV=function(e,t,n,i){return i.x=e.x+t*n.x,i.y=e.y+t*n.y,i},e.SubVMulSV=function(e,t,n,i){return i.x=e.x-t*n.x,i.y=e.y-t*n.y,i},e.AddVCrossSV=function(e,t,n,i){var r=n.x;return i.x=e.x-t*n.y,i.y=e.y+t*r,i},e.MidVV=function(e,t,n){return n.x=.5*(e.x+t.x),n.y=.5*(e.y+t.y),n},e.ExtVV=function(e,t,n){return n.x=.5*(t.x-e.x),n.y=.5*(t.y-e.y),n},e.IsEqualToV=function(e,t){return e.x===t.x&&e.y===t.y},e.DistanceVV=function(e,t){var n=e.x-t.x,i=e.y-t.y;return Math.sqrt(n*n+i*i)},e.DistanceSquaredVV=function(e,t){var n=e.x-t.x,i=e.y-t.y;return n*n+i*i},e.NegV=function(e,t){return t.x=-e.x,t.y=-e.y,t},J(e,[{key:"x",get:function(){return this.data[0]},set:function(e){this.data[0]=e}},{key:"y",get:function(){return this.data[1]},set:function(e){this.data[1]=e}}]),e}();be.ZERO=new be(0,0),be.UNITX=new be(1,0),be.UNITY=new be(0,1),be.s_t0=new be,be.s_t1=new be,be.s_t2=new be,be.s_t3=new be;var Te=new be(0,0),Ee=function(){function e(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(t[0]instanceof Float32Array){if(3!==t[0].length)throw new Error;this.data=t[0]}else{var i="number"==typeof t[0]?t[0]:0,r="number"==typeof t[1]?t[1]:0,o="number"==typeof t[2]?t[2]:0;this.data=new Float32Array([i,r,o])}}var t=e.prototype;return t.Clone=function(){return new e(this.x,this.y,this.z)},t.SetZero=function(){return this.x=0,this.y=0,this.z=0,this},t.SetXYZ=function(e,t,n){return this.x=e,this.y=t,this.z=n,this},t.Copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},t.SelfNeg=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},t.SelfAdd=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},t.SelfAddXYZ=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},t.SelfSub=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},t.SelfSubXYZ=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},t.SelfMul=function(e){return this.x*=e,this.y*=e,this.z*=e,this},e.DotV3V3=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},e.CrossV3V3=function(e,t,n){var i=e.x,r=e.y,o=e.z,a=t.x,s=t.y,c=t.z;return n.x=r*c-o*s,n.y=o*a-i*c,n.z=i*s-r*a,n},J(e,[{key:"x",get:function(){return this.data[0]},set:function(e){this.data[0]=e}},{key:"y",get:function(){return this.data[1]},set:function(e){this.data[1]=e}},{key:"z",get:function(){return this.data[2]},set:function(e){this.data[2]=e}}]),e}();Ee.ZERO=new Ee(0,0,0),Ee.s_t0=new Ee;var we=function(){function e(){this.data=new Float32Array([1,0,0,1]),this.ex=new be(this.data.subarray(0,2)),this.ey=new be(this.data.subarray(2,4))}var t=e.prototype;return t.Clone=function(){return(new e).Copy(this)},e.FromVV=function(t,n){return(new e).SetVV(t,n)},e.FromSSSS=function(t,n,i,r){return(new e).SetSSSS(t,n,i,r)},e.FromAngle=function(t){return(new e).SetAngle(t)},t.SetSSSS=function(e,t,n,i){return this.ex.Set(e,n),this.ey.Set(t,i),this},t.SetVV=function(e,t){return this.ex.Copy(e),this.ey.Copy(t),this},t.SetAngle=function(e){var t=Math.cos(e),n=Math.sin(e);return this.ex.Set(t,n),this.ey.Set(-n,t),this},t.Copy=function(e){return this.ex.Copy(e.ex),this.ey.Copy(e.ey),this},t.SetIdentity=function(){return this.ex.Set(1,0),this.ey.Set(0,1),this},t.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this},t.GetAngle=function(){return Math.atan2(this.ex.y,this.ex.x)},t.GetInverse=function(e){var t=this.ex.x,n=this.ey.x,i=this.ex.y,r=this.ey.y,o=t*r-n*i;return 0!==o&&(o=1/o),e.ex.x=o*r,e.ey.x=-o*n,e.ex.y=-o*i,e.ey.y=o*t,e},t.Solve=function(e,t,n){var i=this.ex.x,r=this.ey.x,o=this.ex.y,a=this.ey.y,s=i*a-r*o;return 0!==s&&(s=1/s),n.x=s*(a*e-r*t),n.y=s*(i*t-o*e),n},t.SelfAbs=function(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this},t.SelfInv=function(){return this.GetInverse(this),this},t.SelfAddM=function(e){return this.ex.SelfAdd(e.ex),this.ey.SelfAdd(e.ey),this},t.SelfSubM=function(e){return this.ex.SelfSub(e.ex),this.ey.SelfSub(e.ey),this},e.AbsM=function(e,t){var n=e.ex,i=e.ey;return t.ex.x=te(n.x),t.ex.y=te(n.y),t.ey.x=te(i.x),t.ey.y=te(i.y),t},e.MulMV=function(e,t,n){var i=e.ex,r=e.ey,o=t.x,a=t.y;return n.x=i.x*o+r.x*a,n.y=i.y*o+r.y*a,n},e.MulTMV=function(e,t,n){var i=e.ex,r=e.ey,o=t.x,a=t.y;return n.x=i.x*o+i.y*a,n.y=r.x*o+r.y*a,n},e.AddMM=function(e,t,n){var i=e.ex,r=e.ey,o=t.ex,a=t.ey;return n.ex.x=i.x+o.x,n.ex.y=i.y+o.y,n.ey.x=r.x+a.x,n.ey.y=r.y+a.y,n},e.MulMM=function(e,t,n){var i=e.ex.x,r=e.ex.y,o=e.ey.x,a=e.ey.y,s=t.ex.x,c=t.ex.y,l=t.ey.x,u=t.ey.y;return n.ex.x=i*s+o*c,n.ex.y=r*s+a*c,n.ey.x=i*l+o*u,n.ey.y=r*l+a*u,n},e.MulTMM=function(e,t,n){var i=e.ex.x,r=e.ex.y,o=e.ey.x,a=e.ey.y,s=t.ex.x,c=t.ex.y,l=t.ey.x,u=t.ey.y;return n.ex.x=i*s+r*c,n.ex.y=o*s+a*c,n.ey.x=i*l+r*u,n.ey.y=o*l+a*u,n},e}();we.IDENTITY=new we;var Ie=function(){function e(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new Ee(this.data.subarray(0,3)),this.ey=new Ee(this.data.subarray(3,6)),this.ez=new Ee(this.data.subarray(6,9))}var t=e.prototype;return t.Clone=function(){return(new e).Copy(this)},t.SetVVV=function(e,t,n){return this.ex.Copy(e),this.ey.Copy(t),this.ez.Copy(n),this},t.Copy=function(e){return this.ex.Copy(e.ex),this.ey.Copy(e.ey),this.ez.Copy(e.ez),this},t.SetIdentity=function(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this},t.SetZero=function(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this},t.SelfAddM=function(e){return this.ex.SelfAdd(e.ex),this.ey.SelfAdd(e.ey),this.ez.SelfAdd(e.ez),this},t.Solve33=function(e,t,n,i){var r=this.ex.x,o=this.ex.y,a=this.ex.z,s=this.ey.x,c=this.ey.y,l=this.ey.z,u=this.ez.x,h=this.ez.y,_=this.ez.z,f=r*(c*_-l*h)+o*(l*u-s*_)+a*(s*h-c*u);return 0!==f&&(f=1/f),i.x=f*(e*(c*_-l*h)+t*(l*u-s*_)+n*(s*h-c*u)),i.y=f*(r*(t*_-n*h)+o*(n*u-e*_)+a*(e*h-t*u)),i.z=f*(r*(c*n-l*t)+o*(l*e-s*n)+a*(s*t-c*e)),i},t.Solve22=function(e,t,n){var i=this.ex.x,r=this.ey.x,o=this.ex.y,a=this.ey.y,s=i*a-r*o;return 0!==s&&(s=1/s),n.x=s*(a*e-r*t),n.y=s*(i*t-o*e),n},t.GetInverse22=function(e){var t=this.ex.x,n=this.ey.x,i=this.ex.y,r=this.ey.y,o=t*r-n*i;0!==o&&(o=1/o),e.ex.x=o*r,e.ey.x=-o*n,e.ex.z=0,e.ex.y=-o*i,e.ey.y=o*t,e.ey.z=0,e.ez.x=0,e.ez.y=0,e.ez.z=0},t.GetSymInverse33=function(e){var t=Ee.DotV3V3(this.ex,Ee.CrossV3V3(this.ey,this.ez,Ee.s_t0));0!==t&&(t=1/t);var n=this.ex.x,i=this.ey.x,r=this.ez.x,o=this.ey.y,a=this.ez.y,s=this.ez.z;e.ex.x=t*(o*s-a*a),e.ex.y=t*(r*a-i*s),e.ex.z=t*(i*a-r*o),e.ey.x=e.ex.y,e.ey.y=t*(n*s-r*r),e.ey.z=t*(r*i-n*a),e.ez.x=e.ex.z,e.ez.y=e.ey.z,e.ez.z=t*(n*o-i*i)},e.MulM33V3=function(e,t,n){var i=t.x,r=t.y,o=t.z;return n.x=e.ex.x*i+e.ey.x*r+e.ez.x*o,n.y=e.ex.y*i+e.ey.y*r+e.ez.y*o,n.z=e.ex.z*i+e.ey.z*r+e.ez.z*o,n},e.MulM33XYZ=function(e,t,n,i,r){return r.x=e.ex.x*t+e.ey.x*n+e.ez.x*i,r.y=e.ex.y*t+e.ey.y*n+e.ez.y*i,r.z=e.ex.z*t+e.ey.z*n+e.ez.z*i,r},e.MulM33V2=function(e,t,n){var i=t.x,r=t.y;return n.x=e.ex.x*i+e.ey.x*r,n.y=e.ex.y*i+e.ey.y*r,n},e.MulM33XY=function(e,t,n,i){return i.x=e.ex.x*t+e.ey.x*n,i.y=e.ex.y*t+e.ey.y*n,i},e}();Ie.IDENTITY=new Ie;var Pe=function(){function e(e){void 0===e&&(e=0),this.s=0,this.c=1,e&&(this.s=Math.sin(e),this.c=Math.cos(e))}var t=e.prototype;return t.Clone=function(){return(new e).Copy(this)},t.Copy=function(e){return this.s=e.s,this.c=e.c,this},t.SetAngle=function(e){return this.s=Math.sin(e),this.c=Math.cos(e),this},t.SetIdentity=function(){return this.s=0,this.c=1,this},t.GetAngle=function(){return Math.atan2(this.s,this.c)},t.GetXAxis=function(e){return e.x=this.c,e.y=this.s,e},t.GetYAxis=function(e){return e.x=-this.s,e.y=this.c,e},e.MulRR=function(e,t,n){var i=e.c,r=e.s,o=t.c,a=t.s;return n.s=r*o+i*a,n.c=i*o-r*a,n},e.MulTRR=function(e,t,n){var i=e.c,r=e.s,o=t.c,a=t.s;return n.s=i*a-r*o,n.c=i*o+r*a,n},e.MulRV=function(e,t,n){var i=e.c,r=e.s,o=t.x,a=t.y;return n.x=i*o-r*a,n.y=r*o+i*a,n},e.MulTRV=function(e,t,n){var i=e.c,r=e.s,o=t.x,a=t.y;return n.x=i*o+r*a,n.y=-r*o+i*a,n},e}();Pe.IDENTITY=new Pe;var Re=function(){function e(){this.p=new be,this.q=new Pe}var t=e.prototype;return t.Clone=function(){return(new e).Copy(this)},t.Copy=function(e){return this.p.Copy(e.p),this.q.Copy(e.q),this},t.SetIdentity=function(){return this.p.SetZero(),this.q.SetIdentity(),this},t.SetPositionRotation=function(e,t){return this.p.Copy(e),this.q.Copy(t),this},t.SetPositionAngle=function(e,t){return this.p.Copy(e),this.q.SetAngle(t),this},t.SetPosition=function(e){return this.p.Copy(e),this},t.SetPositionXY=function(e,t){return this.p.Set(e,t),this},t.SetRotation=function(e){return this.q.Copy(e),this},t.SetRotationAngle=function(e){return this.q.SetAngle(e),this},t.GetPosition=function(){return this.p},t.GetRotation=function(){return this.q},t.GetRotationAngle=function(){return this.q.GetAngle()},t.GetAngle=function(){return this.q.GetAngle()},e.MulXV=function(e,t,n){var i=e.q.c,r=e.q.s,o=t.x,a=t.y;return n.x=i*o-r*a+e.p.x,n.y=r*o+i*a+e.p.y,n},e.MulTXV=function(e,t,n){var i=e.q.c,r=e.q.s,o=t.x-e.p.x,a=t.y-e.p.y;return n.x=i*o+r*a,n.y=-r*o+i*a,n},e.MulXX=function(e,t,n){return Pe.MulRR(e.q,t.q,n.q),be.AddVV(Pe.MulRV(e.q,t.p,n.p),e.p,n.p),n},e.MulTXX=function(e,t,n){return Pe.MulTRR(e.q,t.q,n.q),Pe.MulTRV(e.q,be.SubVV(t.p,e.p,n.p),n.p),n},e}();Re.IDENTITY=new Re;var De,Oe=function(){function e(){this.localCenter=new be,this.c0=new be,this.c=new be,this.a0=0,this.a=0,this.alpha0=0}var t=e.prototype;return t.Clone=function(){return(new e).Copy(this)},t.Copy=function(e){return this.localCenter.Copy(e.localCenter),this.c0.Copy(e.c0),this.c.Copy(e.c),this.a0=e.a0,this.a=e.a,this.alpha0=e.alpha0,this},t.GetTransform=function(e,t){var n=1-t;e.p.x=n*this.c0.x+t*this.c.x,e.p.y=n*this.c0.y+t*this.c.y;var i=n*this.a0+t*this.a;return e.q.SetAngle(i),e.p.SelfSub(Pe.MulRV(e.q,this.localCenter,be.s_t0)),e},t.Advance=function(e){var t=(e-this.alpha0)/(1-this.alpha0),n=1-t;this.c0.x=n*this.c0.x+t*this.c.x,this.c0.y=n*this.c0.y+t*this.c.y,this.a0=n*this.a0+t*this.a,this.alpha0=e},t.Normalize=function(){var e=ee*Math.floor(this.a0/ee);this.a0-=e,this.a-=e},e}(),Ne=function(){function e(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(t[0]instanceof Float32Array){if(4!==t[0].length)throw new Error;this.data=t[0]}else{var i="number"==typeof t[0]?t[0]:.5,r="number"==typeof t[1]?t[1]:.5,o="number"==typeof t[2]?t[2]:.5,a="number"==typeof t[3]?t[3]:1;this.data=new Float32Array([i,r,o,a])}}var t=e.prototype;return t.Clone=function(){return(new e).Copy(this)},t.Copy=function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this},t.IsEqual=function(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a},t.IsZero=function(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a},t.Set=function(e,t,n,i){void 0===i&&(i=this.a),this.SetRGBA(e,t,n,i)},t.SetByteRGB=function(e,t,n){return this.r=e/255,this.g=t/255,this.b=n/255,this},t.SetByteRGBA=function(e,t,n,i){return this.r=e/255,this.g=t/255,this.b=n/255,this.a=i/255,this},t.SetRGB=function(e,t,n){return this.r=e,this.g=t,this.b=n,this},t.SetRGBA=function(e,t,n,i){return this.r=e,this.g=t,this.b=n,this.a=i,this},t.SelfAdd=function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this},t.Add=function(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,t.a=this.a+e.a,t},t.SelfSub=function(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this},t.Sub=function(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,t},t.SelfMul=function(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this},t.Mul=function(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,t},t.Mix=function(t,n){e.MixColors(this,t,n)},e.MixColors=function(e,t,n){var i=n*(t.r-e.r),r=n*(t.g-e.g),o=n*(t.b-e.b),a=n*(t.a-e.a);e.r+=i,e.g+=r,e.b+=o,e.a+=a,t.r-=i,t.g-=r,t.b-=o,t.a-=a},t.MakeStyleString=function(t){return void 0===t&&(t=this.a),e.MakeStyleString(this.r,this.g,this.b,t)},e.MakeStyleString=function(e,t,n,i){return void 0===i&&(i=1),e*=255,t*=255,n*=255,i<1?"rgba("+e+","+t+","+n+","+i+")":"rgb("+e+","+t+","+n+")"},J(e,[{key:"r",get:function(){return this.data[0]},set:function(e){this.data[0]=e}},{key:"g",get:function(){return this.data[1]},set:function(e){this.data[1]=e}},{key:"b",get:function(){return this.data[2]},set:function(e){this.data[2]=e}},{key:"a",get:function(){return this.data[3]},set:function(e){this.data[3]=e}}]),e}();Ne.ZERO=new Ne(0,0,0,0),Ne.RED=new Ne(1,0,0),Ne.GREEN=new Ne(0,1,0),Ne.BLUE=new Ne(0,0,1),(De=e.b2DrawFlags||(e.b2DrawFlags={}))[De.e_none=0]="e_none",De[De.e_shapeBit=1]="e_shapeBit",De[De.e_jointBit=2]="e_jointBit",De[De.e_aabbBit=4]="e_aabbBit",De[De.e_pairBit=8]="e_pairBit",De[De.e_centerOfMassBit=16]="e_centerOfMassBit",De[De.e_particleBit=32]="e_particleBit",De[De.e_controllerBit=64]="e_controllerBit",De[De.e_all=63]="e_all";var Be=function(){function e(){this.m_drawFlags=0}var t=e.prototype;return t.SetFlags=function(e){this.m_drawFlags=e},t.GetFlags=function(){return this.m_drawFlags},t.AppendFlags=function(e){this.m_drawFlags|=e},t.ClearFlags=function(e){this.m_drawFlags&=~e},e}(),Me=function(){function e(){this.m_start=Date.now()}var t=e.prototype;return t.Reset=function(){return this.m_start=Date.now(),this},t.GetMilliseconds=function(){return Date.now()-this.m_start},e}(),Le=function(){function e(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}var t=e.prototype;return t.GetCount=function(){return this.m_count},t.GetMinCount=function(){return this.m_min_count},t.GetMaxCount=function(){return this.m_max_count},t.ResetCount=function(){var e=this.m_count;return this.m_count=0,e},t.ResetMinCount=function(){this.m_min_count=0},t.ResetMaxCount=function(){this.m_max_count=0},t.Increment=function(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)},t.Decrement=function(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)},e}(),Fe=function(){function e(e){this.m_stack=[],this.m_count=0,this.m_stack=X(e,(function(){return null})),this.m_count=0}var t=e.prototype;return t.Reset=function(){return this.m_count=0,this},t.Push=function(e){this.m_stack[this.m_count]=e,this.m_count++},t.Pop=function(){this.m_count--;var e=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,null===e)throw new Error;return e},t.GetCount=function(){return this.m_count},e}(),ze=function(){},Ve=function(){},Ge=function(){function e(){this.m_buffer=be.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}var t=e.prototype;return t.Copy=function(e){return e.m_vertices===e.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(e.m_buffer[0]),this.m_buffer[1].Copy(e.m_buffer[1])):this.m_vertices=e.m_vertices,this.m_count=e.m_count,this.m_radius=e.m_radius,this},t.Reset=function(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this},t.SetShape=function(e,t){e.SetupDistanceProxy(this,t)},t.SetVerticesRadius=function(e,t,n){this.m_vertices=e,this.m_count=t,this.m_radius=n},t.GetSupport=function(e){for(var t=0,n=be.DotVV(this.m_vertices[0],e),i=1;i<this.m_count;++i){var r=be.DotVV(this.m_vertices[i],e);r>n&&(t=i,n=r)}return t},t.GetSupportVertex=function(e){for(var t=0,n=be.DotVV(this.m_vertices[0],e),i=1;i<this.m_count;++i){var r=be.DotVV(this.m_vertices[i],e);r>n&&(t=i,n=r)}return this.m_vertices[t]},t.GetVertexCount=function(){return this.m_count},t.GetVertex=function(e){return this.m_vertices[e]},e}(),Ue=function(){function e(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}return e.prototype.Reset=function(){return this.metric=0,this.count=0,this},e}(),ke=function(){function e(){this.proxyA=new Ge,this.proxyB=new Ge,this.transformA=new Re,this.transformB=new Re,this.useRadii=!1}return e.prototype.Reset=function(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this},e}(),He=function(){function e(){this.pointA=new be,this.pointB=new be,this.distance=0,this.iterations=0}return e.prototype.Reset=function(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this},e}(),je=function(){this.proxyA=new Ge,this.proxyB=new Ge,this.transformA=new Re,this.transformB=new Re,this.translationB=new be},We=function(){this.point=new be,this.normal=new be,this.lambda=0,this.iterations=0};function qe(){e.b2_gjkCalls=0,e.b2_gjkIters=0,e.b2_gjkMaxIters=0}e.b2_gjkCalls=0,e.b2_gjkIters=0,e.b2_gjkMaxIters=0;var Xe=function(){function e(){this.wA=new be,this.wB=new be,this.w=new be,this.a=0,this.indexA=0,this.indexB=0}return e.prototype.Copy=function(e){return this.wA.Copy(e.wA),this.wB.Copy(e.wB),this.w.Copy(e.w),this.a=e.a,this.indexA=e.indexA,this.indexB=e.indexB,this},e}(),Ye=function(){function e(){this.m_v1=new Xe,this.m_v2=new Xe,this.m_v3=new Xe,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}var t=e.prototype;return t.ReadCache=function(e,t,n,i,o){this.m_count=e.count;for(var a=this.m_vertices,s=0;s<this.m_count;++s){var c=a[s];c.indexA=e.indexA[s],c.indexB=e.indexB[s];var l=t.GetVertex(c.indexA),u=i.GetVertex(c.indexB);Re.MulXV(n,l,c.wA),Re.MulXV(o,u,c.wB),be.SubVV(c.wB,c.wA,c.w),c.a=0}if(this.m_count>1){var h=e.metric,_=this.GetMetric();(_<.5*h||2*h<_||_<r)&&(this.m_count=0)}if(0===this.m_count){var f=a[0];f.indexA=0,f.indexB=0;var d=t.GetVertex(0),p=i.GetVertex(0);Re.MulXV(n,d,f.wA),Re.MulXV(o,p,f.wB),be.SubVV(f.wB,f.wA,f.w),f.a=1,this.m_count=1}},t.WriteCache=function(e){e.metric=this.GetMetric(),e.count=this.m_count;for(var t=this.m_vertices,n=0;n<this.m_count;++n)e.indexA[n]=t[n].indexA,e.indexB[n]=t[n].indexB},t.GetSearchDirection=function(e){switch(this.m_count){case 1:return be.NegV(this.m_v1.w,e);case 2:var t=be.SubVV(this.m_v2.w,this.m_v1.w,e);return be.CrossVV(t,be.NegV(this.m_v1.w,be.s_t0))>0?be.CrossOneV(t,e):be.CrossVOne(t,e);default:return e.SetZero()}},t.GetClosestPoint=function(e){switch(this.m_count){case 0:return e.SetZero();case 1:return e.Copy(this.m_v1.w);case 2:return e.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return e.SetZero()}},t.GetWitnessPoints=function(e,t){switch(this.m_count){case 0:break;case 1:e.Copy(this.m_v1.wA),t.Copy(this.m_v1.wB);break;case 2:e.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,e.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,t.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,t.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:t.x=e.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,t.y=e.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}},t.GetMetric=function(){switch(this.m_count){case 0:case 1:return 0;case 2:return be.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return be.CrossVV(be.SubVV(this.m_v2.w,this.m_v1.w,be.s_t0),be.SubVV(this.m_v3.w,this.m_v1.w,be.s_t1));default:return 0}},t.Solve2=function(){var t=this.m_v1.w,n=this.m_v2.w,i=be.SubVV(n,t,e.s_e12),r=-be.DotVV(t,i);if(r<=0)return this.m_v1.a=1,void(this.m_count=1);var o=be.DotVV(n,i);if(o<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);var a=1/(o+r);this.m_v1.a=o*a,this.m_v2.a=r*a,this.m_count=2},t.Solve3=function(){var t=this.m_v1.w,n=this.m_v2.w,i=this.m_v3.w,r=be.SubVV(n,t,e.s_e12),o=be.DotVV(t,r),a=be.DotVV(n,r),s=-o,c=be.SubVV(i,t,e.s_e13),l=be.DotVV(t,c),u=be.DotVV(i,c),h=-l,_=be.SubVV(i,n,e.s_e23),f=be.DotVV(n,_),d=be.DotVV(i,_),p=-f,m=be.CrossVV(r,c),v=m*be.CrossVV(n,i),g=m*be.CrossVV(i,t),y=m*be.CrossVV(t,n);if(s<=0&&h<=0)return this.m_v1.a=1,void(this.m_count=1);if(a>0&&s>0&&y<=0){var x=1/(a+s);return this.m_v1.a=a*x,this.m_v2.a=s*x,void(this.m_count=2)}if(u>0&&h>0&&g<=0){var S=1/(u+h);return this.m_v1.a=u*S,this.m_v3.a=h*S,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(a<=0&&p<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(u<=0&&d<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(d>0&&p>0&&v<=0){var C=1/(d+p);return this.m_v2.a=d*C,this.m_v3.a=p*C,this.m_count=2,void this.m_v1.Copy(this.m_v3)}var A=1/(v+g+y);this.m_v1.a=v*A,this.m_v2.a=g*A,this.m_v3.a=y*A,this.m_count=3},e}();Ye.s_e12=new be,Ye.s_e13=new be,Ye.s_e23=new be;var Ke=new Ye,Je=[0,0,0],Qe=[0,0,0],Ze=new be,$e=new be,et=new be,tt=new be,nt=new be;function it(t,n,i){++e.b2_gjkCalls;var a=i.proxyA,s=i.proxyB,c=i.transformA,l=i.transformB,u=Ke;u.ReadCache(n,a,c,s,l);for(var h=u.m_vertices,_=20,f=Je,d=Qe,p=0,m=0;m<_;){p=u.m_count;for(var v=0;v<p;++v)f[v]=h[v].indexA,d[v]=h[v].indexB;switch(u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3()}if(3===u.m_count)break;var g=u.GetSearchDirection($e);if(g.LengthSquared()<o)break;var y=h[u.m_count];y.indexA=a.GetSupport(Pe.MulTRV(c.q,be.NegV(g,be.s_t0),tt)),Re.MulXV(c,a.GetVertex(y.indexA),y.wA),y.indexB=s.GetSupport(Pe.MulTRV(l.q,g,nt)),Re.MulXV(l,s.GetVertex(y.indexB),y.wB),be.SubVV(y.wB,y.wA,y.w),++m,++e.b2_gjkIters;for(var x=!1,S=0;S<p;++S)if(y.indexA===f[S]&&y.indexB===d[S]){x=!0;break}if(x)break;++u.m_count}if(e.b2_gjkMaxIters=re(e.b2_gjkMaxIters,m),u.GetWitnessPoints(t.pointA,t.pointB),t.distance=be.DistanceVV(t.pointA,t.pointB),t.iterations=m,u.WriteCache(n),i.useRadii){var C=a.m_radius,A=s.m_radius;if(t.distance>C+A&&t.distance>r){t.distance-=C+A;var b=be.SubVV(t.pointB,t.pointA,et);b.Normalize(),t.pointA.SelfMulAdd(C,b),t.pointB.SelfMulSub(A,b)}else{var T=be.MidVV(t.pointA,t.pointB,Ze);t.pointA.Copy(T),t.pointB.Copy(T),t.distance=0}}}var rt,ot=new be,at=new Ye,st=new be,ct=new be,lt=new be,ut=new be,ht=new be,_t=new be;function ft(e,t){e.iterations=0,e.lambda=1,e.normal.SetZero(),e.point.SetZero();var n=t.proxyA,i=t.proxyB,r=re(n.m_radius,f)+re(i.m_radius,f),o=t.transformA,a=t.transformB,s=t.translationB,c=ot.Set(0,0),l=0,u=at;u.m_count=0;for(var _=u.m_vertices,d=n.GetSupport(Pe.MulTRV(o.q,be.NegV(s,be.s_t1),be.s_t0)),p=Re.MulXV(o,n.GetVertex(d),st),m=i.GetSupport(Pe.MulTRV(a.q,s,be.s_t0)),v=Re.MulXV(a,i.GetVertex(m),ct),g=be.SubVV(p,v,lt),y=re(f,r-f),x=.5*h,S=20,C=0;C<S&&te(g.Length()-y)>x;){e.iterations+=1,d=n.GetSupport(Pe.MulTRV(o.q,be.NegV(g,be.s_t1),be.s_t0)),p=Re.MulXV(o,n.GetVertex(d),st),m=i.GetSupport(Pe.MulTRV(a.q,g,be.s_t0)),v=Re.MulXV(a,i.GetVertex(m),ct);var A=be.SubVV(p,v,ut);g.Normalize();var b=be.DotVV(g,A),T=be.DotVV(g,s);if(b-y>l*T){if(T<=0)return!1;if((l=(b-y)/T)>1)return!1;c.Copy(g).SelfNeg(),u.m_count=0}var E=_[u.m_count];switch(E.indexA=m,E.wA.Copy(v).SelfMulAdd(l,s),E.indexB=d,E.wB.Copy(p),E.w.Copy(E.wB).SelfSub(E.wA),E.a=1,u.m_count+=1,u.m_count){case 1:break;case 2:u.Solve2();break;case 3:u.Solve3()}if(3===u.m_count)return!1;u.GetClosestPoint(g),++C}var w=ht,I=_t;return u.GetWitnessPoints(w,I),g.LengthSquared()>0&&(c.Copy(g).SelfNeg(),c.Normalize()),e.normal.Copy(c),e.lambda=l,e.iterations=C,!0}(rt=e.b2ContactFeatureType||(e.b2ContactFeatureType={}))[rt.e_vertex=0]="e_vertex",rt[rt.e_face=1]="e_face";var dt,pt=function(){function e(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}return J(e,[{key:"key",get:function(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key},set:function(e){this._key=e,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}},{key:"indexA",get:function(){return this._indexA},set:function(e){this._indexA=e,this._key_invalid=!0}},{key:"indexB",get:function(){return this._indexB},set:function(e){this._indexB=e,this._key_invalid=!0}},{key:"typeA",get:function(){return this._typeA},set:function(e){this._typeA=e,this._key_invalid=!0}},{key:"typeB",get:function(){return this._typeB},set:function(e){this._typeB=e,this._key_invalid=!0}}]),e}(),mt=function(){function e(){this.cf=new pt}var t=e.prototype;return t.Copy=function(e){return this.key=e.key,this},t.Clone=function(){return(new e).Copy(this)},J(e,[{key:"key",get:function(){return this.cf.key},set:function(e){this.cf.key=e}}]),e}(),vt=function(){function e(){this.localPoint=new be,this.normalImpulse=0,this.tangentImpulse=0,this.id=new mt}e.MakeArray=function(t){return X(t,(function(){return new e}))};var t=e.prototype;return t.Reset=function(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0},t.Copy=function(e){return this.localPoint.Copy(e.localPoint),this.normalImpulse=e.normalImpulse,this.tangentImpulse=e.tangentImpulse,this.id.Copy(e.id),this},e}();(dt=e.b2ManifoldType||(e.b2ManifoldType={}))[dt.e_unknown=-1]="e_unknown",dt[dt.e_circles=0]="e_circles",dt[dt.e_faceA=1]="e_faceA",dt[dt.e_faceB=2]="e_faceB";var gt,yt=function(){function t(){this.points=vt.MakeArray(s),this.localNormal=new be,this.localPoint=new be,this.type=e.b2ManifoldType.e_unknown,this.pointCount=0}var n=t.prototype;return n.Reset=function(){for(var t=0;t<s;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=e.b2ManifoldType.e_unknown,this.pointCount=0},n.Copy=function(e){this.pointCount=e.pointCount;for(var t=0;t<s;++t)this.points[t].Copy(e.points[t]);return this.localNormal.Copy(e.localNormal),this.localPoint.Copy(e.localPoint),this.type=e.type,this},n.Clone=function(){return(new t).Copy(this)},t}(),xt=function(){function t(){this.normal=new be,this.points=be.MakeArray(s),this.separations=K(s)}return t.prototype.Initialize=function(n,i,r,a,s){if(0!==n.pointCount)switch(n.type){case e.b2ManifoldType.e_circles:this.normal.Set(1,0);var c=Re.MulXV(i,n.localPoint,t.Initialize_s_pointA),l=Re.MulXV(a,n.points[0].localPoint,t.Initialize_s_pointB);be.DistanceSquaredVV(c,l)>o&&be.SubVV(l,c,this.normal).SelfNormalize();var u=be.AddVMulSV(c,r,this.normal,t.Initialize_s_cA),h=be.SubVMulSV(l,s,this.normal,t.Initialize_s_cB);be.MidVV(u,h,this.points[0]),this.separations[0]=be.DotVV(be.SubVV(h,u,be.s_t0),this.normal);break;case e.b2ManifoldType.e_faceA:Pe.MulRV(i.q,n.localNormal,this.normal);for(var _=Re.MulXV(i,n.localPoint,t.Initialize_s_planePoint),f=0;f<n.pointCount;++f){var d=Re.MulXV(a,n.points[f].localPoint,t.Initialize_s_clipPoint),p=r-be.DotVV(be.SubVV(d,_,be.s_t0),this.normal),m=be.AddVMulSV(d,p,this.normal,t.Initialize_s_cA),v=be.SubVMulSV(d,s,this.normal,t.Initialize_s_cB);be.MidVV(m,v,this.points[f]),this.separations[f]=be.DotVV(be.SubVV(v,m,be.s_t0),this.normal)}break;case e.b2ManifoldType.e_faceB:Pe.MulRV(a.q,n.localNormal,this.normal);for(var g=Re.MulXV(a,n.localPoint,t.Initialize_s_planePoint),y=0;y<n.pointCount;++y){var x=Re.MulXV(i,n.points[y].localPoint,t.Initialize_s_clipPoint),S=s-be.DotVV(be.SubVV(x,g,be.s_t0),this.normal),C=be.AddVMulSV(x,S,this.normal,t.Initialize_s_cB),A=be.SubVMulSV(x,r,this.normal,t.Initialize_s_cA);be.MidVV(A,C,this.points[y]),this.separations[y]=be.DotVV(be.SubVV(A,C,be.s_t0),this.normal)}this.normal.SelfNeg()}},t}();function St(t,n,i,r){var o;for(o=0;o<i.pointCount;++o){var a=i.points[o].id.key;t[o]=e.b2PointState.b2_removeState;for(var c=0,l=r.pointCount;c<l;++c)if(r.points[c].id.key===a){t[o]=e.b2PointState.b2_persistState;break}}for(;o<s;++o)t[o]=e.b2PointState.b2_nullState;for(o=0;o<r.pointCount;++o){var u=r.points[o].id.key;n[o]=e.b2PointState.b2_addState;for(var h=0,_=i.pointCount;h<_;++h)if(i.points[h].id.key===u){n[o]=e.b2PointState.b2_persistState;break}}for(;o<s;++o)n[o]=e.b2PointState.b2_nullState}xt.Initialize_s_pointA=new be,xt.Initialize_s_pointB=new be,xt.Initialize_s_cA=new be,xt.Initialize_s_cB=new be,xt.Initialize_s_planePoint=new be,xt.Initialize_s_clipPoint=new be,(gt=e.b2PointState||(e.b2PointState={}))[gt.b2_nullState=0]="b2_nullState",gt[gt.b2_addState=1]="b2_addState",gt[gt.b2_persistState=2]="b2_persistState",gt[gt.b2_removeState=3]="b2_removeState";var Ct=function(){function e(){this.v=new be,this.id=new mt}return e.MakeArray=function(t){return X(t,(function(){return new e}))},e.prototype.Copy=function(e){return this.v.Copy(e.v),this.id.Copy(e.id),this},e}(),At=function(){function e(){this.p1=new be,this.p2=new be,this.maxFraction=1}return e.prototype.Copy=function(e){return this.p1.Copy(e.p1),this.p2.Copy(e.p2),this.maxFraction=e.maxFraction,this},e}(),bt=function(){function e(){this.normal=new be,this.fraction=0}return e.prototype.Copy=function(e){return this.normal.Copy(e.normal),this.fraction=e.fraction,this},e}(),Tt=function(){function e(){this.lowerBound=new be,this.upperBound=new be,this.m_cache_center=new be,this.m_cache_extent=new be}var t=e.prototype;return t.Copy=function(e){return this.lowerBound.Copy(e.lowerBound),this.upperBound.Copy(e.upperBound),this},t.IsValid=function(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)},t.GetCenter=function(){return be.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)},t.GetExtents=function(){return be.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)},t.GetPerimeter=function(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))},t.Combine1=function(e){return this.lowerBound.x=ie(this.lowerBound.x,e.lowerBound.x),this.lowerBound.y=ie(this.lowerBound.y,e.lowerBound.y),this.upperBound.x=re(this.upperBound.x,e.upperBound.x),this.upperBound.y=re(this.upperBound.y,e.upperBound.y),this},t.Combine2=function(e,t){return this.lowerBound.x=ie(e.lowerBound.x,t.lowerBound.x),this.lowerBound.y=ie(e.lowerBound.y,t.lowerBound.y),this.upperBound.x=re(e.upperBound.x,t.upperBound.x),this.upperBound.y=re(e.upperBound.y,t.upperBound.y),this},e.Combine=function(e,t,n){return n.Combine2(e,t),n},t.Contains=function(e){return!(this.lowerBound.x<=e.lowerBound.x||this.lowerBound.y<=e.lowerBound.y||e.upperBound.x<=this.upperBound.x||e.upperBound.y<=this.upperBound.y)},t.RayCast=function(e,t){var n=-i,o=i,a=t.p1.x,s=t.p1.y,c=t.p2.x-t.p1.x,l=t.p2.y-t.p1.y,u=te(c),h=te(l),_=e.normal;if(u<r){if(a<this.lowerBound.x||this.upperBound.x<a)return!1}else{var f=1/c,d=(this.lowerBound.x-a)*f,p=(this.upperBound.x-a)*f,m=-1;if(d>p){var v=d;d=p,p=v,m=1}if(d>n&&(_.x=m,_.y=0,n=d),n>(o=ie(o,p)))return!1}if(h<r){if(s<this.lowerBound.y||this.upperBound.y<s)return!1}else{var g=1/l,y=(this.lowerBound.y-s)*g,x=(this.upperBound.y-s)*g,S=-1;if(y>x){var C=y;y=x,x=C,S=1}if(y>n&&(_.x=0,_.y=S,n=y),n>(o=ie(o,x)))return!1}return!(n<0||t.maxFraction<n||(e.fraction=n,0))},t.TestContain=function(e){return!(e.x<this.lowerBound.x||this.upperBound.x<e.x||e.y<this.lowerBound.y||this.upperBound.y<e.y)},t.TestOverlap=function(e){return!(this.upperBound.x<e.lowerBound.x||this.upperBound.y<e.lowerBound.y||e.upperBound.x<this.lowerBound.x||e.upperBound.y<this.lowerBound.y)},e}();function Et(e,t){return!(e.upperBound.x<t.lowerBound.x||e.upperBound.y<t.lowerBound.y||t.upperBound.x<e.lowerBound.x||t.upperBound.y<e.lowerBound.y)}function wt(t,n,i,r,o){var a=0,s=n[0],c=n[1],l=be.DotVV(i,s.v)-r,u=be.DotVV(i,c.v)-r;if(l<=0&&t[a++].Copy(s),u<=0&&t[a++].Copy(c),l*u<0){var h=l/(l-u),_=t[a].v;_.x=s.v.x+h*(c.v.x-s.v.x),_.y=s.v.y+h*(c.v.y-s.v.y);var f=t[a].id;f.cf.indexA=o,f.cf.indexB=s.id.cf.indexB,f.cf.typeA=e.b2ContactFeatureType.e_vertex,f.cf.typeB=e.b2ContactFeatureType.e_face,++a}return a}var It=new ke,Pt=new Ue,Rt=new He;function Dt(e,t,n,i,o,a){var s=It.Reset();s.proxyA.SetShape(e,t),s.proxyB.SetShape(n,i),s.transformA.Copy(o),s.transformB.Copy(a),s.useRadii=!0;var c=Pt.Reset();c.count=0;var l=Rt.Reset();return it(l,c,s),l.distance<10*r}function Ot(e){if(null===e)throw new Error;return e}var Nt=function(){function e(e){void 0===e&&(e=0),this.m_id=0,this.aabb=new Tt,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=e}var t=e.prototype;return t.Reset=function(){this._userData=null},t.IsLeaf=function(){return null===this.child1},J(e,[{key:"userData",get:function(){if(null===this._userData)throw new Error;return this._userData},set:function(e){if(null!==this._userData)throw new Error;this._userData=e}}]),e}(),Bt=function(){function e(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new Fe(256)}var t=e.prototype;return t.Query=function(e,t){var n=this.m_stack.Reset();for(n.Push(this.m_root);n.GetCount()>0;){var i=n.Pop();if(null!==i&&i.aabb.TestOverlap(e))if(i.IsLeaf()){if(!t(i))return}else n.Push(i.child1),n.Push(i.child2)}},t.QueryPoint=function(e,t){var n=this.m_stack.Reset();for(n.Push(this.m_root);n.GetCount()>0;){var i=n.Pop();if(null!==i&&i.aabb.TestContain(e))if(i.IsLeaf()){if(!t(i))return}else n.Push(i.child1),n.Push(i.child2)}},t.RayCast=function(t,n){var i=t.p1,r=t.p2,o=be.SubVV(r,i,e.s_r);o.Normalize();var a=be.CrossOneV(o,e.s_v),s=be.AbsV(a,e.s_abs_v),c=t.maxFraction,l=e.s_segmentAABB,u=i.x+c*(r.x-i.x),h=i.y+c*(r.y-i.y);l.lowerBound.x=ie(i.x,u),l.lowerBound.y=ie(i.y,h),l.upperBound.x=re(i.x,u),l.upperBound.y=re(i.y,h);var _=this.m_stack.Reset();for(_.Push(this.m_root);_.GetCount()>0;){var f=_.Pop();if(null!==f&&Et(f.aabb,l)){var d=f.aabb.GetCenter(),p=f.aabb.GetExtents();if(!(te(be.DotVV(a,be.SubVV(i,d,be.s_t0)))-be.DotVV(s,p)>0))if(f.IsLeaf()){var m=e.s_subInput;m.p1.Copy(t.p1),m.p2.Copy(t.p2),m.maxFraction=c;var v=n(m,f);if(0===v)return;v>0&&(c=v,u=i.x+c*(r.x-i.x),h=i.y+c*(r.y-i.y),l.lowerBound.x=ie(i.x,u),l.lowerBound.y=ie(i.y,h),l.upperBound.x=re(i.x,u),l.upperBound.y=re(i.y,h))}else _.Push(f.child1),_.Push(f.child2)}}},t.AllocateNode=function(){if(null!==this.m_freeList){var t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t}return new Nt(e.s_node_id++)},t.FreeNode=function(e){e.parent=this.m_freeList,e.child1=null,e.child2=null,e.height=-1,e.Reset(),this.m_freeList=e},t.CreateProxy=function(e,t){var n=this.AllocateNode(),i=l,r=l;return n.aabb.lowerBound.x=e.lowerBound.x-i,n.aabb.lowerBound.y=e.lowerBound.y-r,n.aabb.upperBound.x=e.upperBound.x+i,n.aabb.upperBound.y=e.upperBound.y+r,n.userData=t,n.height=0,this.InsertLeaf(n),n},t.DestroyProxy=function(e){this.RemoveLeaf(e),this.FreeNode(e)},t.MoveProxy=function(e,t,n){if(e.aabb.Contains(t))return!1;this.RemoveLeaf(e);var i=l,r=l;e.aabb.lowerBound.x=t.lowerBound.x-i,e.aabb.lowerBound.y=t.lowerBound.y-r,e.aabb.upperBound.x=t.upperBound.x+i,e.aabb.upperBound.y=t.upperBound.y+r;var o=u*n.x,a=u*n.y;return o<0?e.aabb.lowerBound.x+=o:e.aabb.upperBound.x+=o,a<0?e.aabb.lowerBound.y+=a:e.aabb.upperBound.y+=a,this.InsertLeaf(e),!0},t.InsertLeaf=function(t){if(++this.m_insertionCount,null===this.m_root)return this.m_root=t,void(this.m_root.parent=null);for(var n=t.aabb,i=this.m_root;!i.IsLeaf();){var r=Ot(i.child1),o=Ot(i.child2),a=i.aabb.GetPerimeter(),s=e.s_combinedAABB;s.Combine2(i.aabb,n);var c=s.GetPerimeter(),l=2*c,u=2*(c-a),h=void 0,_=e.s_aabb,f=void 0;r.IsLeaf()?(_.Combine2(n,r.aabb),h=_.GetPerimeter()+u):(_.Combine2(n,r.aabb),f=r.aabb.GetPerimeter(),h=_.GetPerimeter()-f+u);var d=void 0;if(o.IsLeaf()?(_.Combine2(n,o.aabb),d=_.GetPerimeter()+u):(_.Combine2(n,o.aabb),f=o.aabb.GetPerimeter(),d=_.GetPerimeter()-f+u),l<h&&l<d)break;i=h<d?r:o}var p=i.parent,m=this.AllocateNode();m.parent=p,m.aabb.Combine2(n,i.aabb),m.height=i.height+1,null!==p?(p.child1===i?p.child1=m:p.child2=m,m.child1=i,m.child2=t,i.parent=m,t.parent=m):(m.child1=i,m.child2=t,i.parent=m,t.parent=m,this.m_root=m);for(var v=t.parent;null!==v;){var g=Ot((v=this.Balance(v)).child1),y=Ot(v.child2);v.height=1+re(g.height,y.height),v.aabb.Combine2(g.aabb,y.aabb),v=v.parent}},t.RemoveLeaf=function(e){if(e!==this.m_root){var t=Ot(e.parent),n=t&&t.parent,i=Ot(t.child1===e?t.child2:t.child1);if(null!==n){n.child1===t?n.child1=i:n.child2=i,i.parent=n,this.FreeNode(t);for(var r=n;null!==r;){var o=Ot((r=this.Balance(r)).child1),a=Ot(r.child2);r.aabb.Combine2(o.aabb,a.aabb),r.height=1+re(o.height,a.height),r=r.parent}}else this.m_root=i,i.parent=null,this.FreeNode(t)}else this.m_root=null},t.Balance=function(e){if(e.IsLeaf()||e.height<2)return e;var t=Ot(e.child1),n=Ot(e.child2),i=n.height-t.height;if(i>1){var r=Ot(n.child1),o=Ot(n.child2);return n.child1=e,n.parent=e.parent,e.parent=n,null!==n.parent?n.parent.child1===e?n.parent.child1=n:n.parent.child2=n:this.m_root=n,r.height>o.height?(n.child2=r,e.child2=o,o.parent=e,e.aabb.Combine2(t.aabb,o.aabb),n.aabb.Combine2(e.aabb,r.aabb),e.height=1+re(t.height,o.height),n.height=1+re(e.height,r.height)):(n.child2=o,e.child2=r,r.parent=e,e.aabb.Combine2(t.aabb,r.aabb),n.aabb.Combine2(e.aabb,o.aabb),e.height=1+re(t.height,r.height),n.height=1+re(e.height,o.height)),n}if(i<-1){var a=Ot(t.child1),s=Ot(t.child2);return t.child1=e,t.parent=e.parent,e.parent=t,null!==t.parent?t.parent.child1===e?t.parent.child1=t:t.parent.child2=t:this.m_root=t,a.height>s.height?(t.child2=a,e.child1=s,s.parent=e,e.aabb.Combine2(n.aabb,s.aabb),t.aabb.Combine2(e.aabb,a.aabb),e.height=1+re(n.height,s.height),t.height=1+re(e.height,a.height)):(t.child2=s,e.child1=a,a.parent=e,e.aabb.Combine2(n.aabb,a.aabb),t.aabb.Combine2(e.aabb,s.aabb),e.height=1+re(n.height,a.height),t.height=1+re(e.height,s.height)),t}return e},t.GetHeight=function(){return null===this.m_root?0:this.m_root.height},e.GetAreaNode=function(t){if(null===t)return 0;if(t.IsLeaf())return 0;var n=t.aabb.GetPerimeter();return(n+=e.GetAreaNode(t.child1))+e.GetAreaNode(t.child2)},t.GetAreaRatio=function(){if(null===this.m_root)return 0;var t=this.m_root.aabb.GetPerimeter();return e.GetAreaNode(this.m_root)/t},e.ComputeHeightNode=function(t){return null===t||t.IsLeaf()?0:1+re(e.ComputeHeightNode(t.child1),e.ComputeHeightNode(t.child2))},t.ComputeHeight=function(){return e.ComputeHeightNode(this.m_root)},t.ValidateStructure=function(e){if(null!==e&&(this.m_root,!e.IsLeaf())){var t=Ot(e.child1),n=Ot(e.child2);this.ValidateStructure(t),this.ValidateStructure(n)}},t.ValidateMetrics=function(t){if(null!==t&&!t.IsLeaf()){var n=Ot(t.child1),i=Ot(t.child2);e.s_aabb.Combine2(n.aabb,i.aabb),this.ValidateMetrics(n),this.ValidateMetrics(i)}},t.Validate=function(){},e.GetMaxBalanceNode=function(e,t){if(null===e)return t;if(e.height<=1)return t;var n=Ot(e.child1),i=Ot(e.child2);return re(t,te(i.height-n.height))},t.GetMaxBalance=function(){return e.GetMaxBalanceNode(this.m_root,0)},t.RebuildBottomUp=function(){this.Validate()},e.ShiftOriginNode=function(t,n){if(null!==t&&!(t.height<=1)){var i=t.child1,r=t.child2;e.ShiftOriginNode(i,n),e.ShiftOriginNode(r,n),t.aabb.lowerBound.SelfSub(n),t.aabb.upperBound.SelfSub(n)}},t.ShiftOrigin=function(t){e.ShiftOriginNode(this.m_root,t)},e}();function Mt(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function Lt(e,t){return e<t}function Ft(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=e.length-t),void 0===i&&(i=Lt);for(var r=t,o=[],a=0;;){for(;r+1<n;n++){var s=e[r+Math.floor(Math.random()*(n-r))];o[a++]=n;for(var c=r-1;;){for(;i(e[++c],s););for(;i(s,e[--n]););if(c>=n)break;Mt(e,c,n)}}if(0===a)break;r=n,n=o[--a]}return e}Bt.s_r=new be,Bt.s_v=new be,Bt.s_abs_v=new be,Bt.s_segmentAABB=new Tt,Bt.s_subInput=new At,Bt.s_combinedAABB=new Tt,Bt.s_aabb=new Tt,Bt.s_node_id=0;var zt=function(e,t){this.proxyA=e,this.proxyB=t},Vt=function(){function e(){this.m_tree=new Bt,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}var t=e.prototype;return t.CreateProxy=function(e,t){var n=this.m_tree.CreateProxy(e,t);return++this.m_proxyCount,this.BufferMove(n),n},t.DestroyProxy=function(e){this.UnBufferMove(e),--this.m_proxyCount,this.m_tree.DestroyProxy(e)},t.MoveProxy=function(e,t,n){this.m_tree.MoveProxy(e,t,n)&&this.BufferMove(e)},t.TouchProxy=function(e){this.BufferMove(e)},t.GetProxyCount=function(){return this.m_proxyCount},t.UpdatePairs=function(e){var t=this;this.m_pairCount=0;for(var n=function(e){var n=t.m_moveBuffer[e];if(null===n)return"continue";var i=n.aabb;t.m_tree.Query(i,(function(e){if(e.m_id===n.m_id)return!0;var i,r;if(e.m_id<n.m_id?(i=e,r=n):(i=n,r=e),t.m_pairCount===t.m_pairBuffer.length)t.m_pairBuffer[t.m_pairCount]=new zt(i,r);else{var o=t.m_pairBuffer[t.m_pairCount];o.proxyA=i,o.proxyB=r}return++t.m_pairCount,!0}))},i=0;i<this.m_moveCount;++i)n(i);this.m_moveCount=0,Ft(this.m_pairBuffer,0,this.m_pairCount,Gt);for(var r=0;r<this.m_pairCount;){var o=this.m_pairBuffer[r];for(e(o.proxyA.userData,o.proxyB.userData),++r;r<this.m_pairCount;){var a=this.m_pairBuffer[r];if(a.proxyA.m_id!==o.proxyA.m_id||a.proxyB.m_id!==o.proxyB.m_id)break;++r}}},t.Query=function(e,t){this.m_tree.Query(e,t)},t.QueryPoint=function(e,t){this.m_tree.QueryPoint(e,t)},t.RayCast=function(e,t){this.m_tree.RayCast(e,t)},t.GetTreeHeight=function(){return this.m_tree.GetHeight()},t.GetTreeBalance=function(){return this.m_tree.GetMaxBalance()},t.GetTreeQuality=function(){return this.m_tree.GetAreaRatio()},t.ShiftOrigin=function(e){this.m_tree.ShiftOrigin(e)},t.BufferMove=function(e){this.m_moveBuffer[this.m_moveCount]=e,++this.m_moveCount},t.UnBufferMove=function(e){var t=this.m_moveBuffer.indexOf(e);this.m_moveBuffer[t]=null},e}();function Gt(e,t){return e.proxyA.m_id<t.proxyA.m_id||e.proxyA.m_id===t.proxyA.m_id&&e.proxyB.m_id<t.proxyB.m_id}function Ut(){e.b2_toiTime=0,e.b2_toiMaxTime=0,e.b2_toiCalls=0,e.b2_toiIters=0,e.b2_toiMaxIters=0,e.b2_toiRootIters=0,e.b2_toiMaxRootIters=0}e.b2_toiTime=0,e.b2_toiMaxTime=0,e.b2_toiCalls=0,e.b2_toiIters=0,e.b2_toiMaxIters=0,e.b2_toiRootIters=0,e.b2_toiMaxRootIters=0;var kt,Ht=new Re,jt=new Re,Wt=new be,qt=new be,Xt=new be,Yt=new be,Kt=new be,Jt=function(){this.proxyA=new Ge,this.proxyB=new Ge,this.sweepA=new Oe,this.sweepB=new Oe,this.tMax=0};(kt=e.b2TOIOutputState||(e.b2TOIOutputState={}))[kt.e_unknown=0]="e_unknown",kt[kt.e_failed=1]="e_failed",kt[kt.e_overlapped=2]="e_overlapped",kt[kt.e_touching=3]="e_touching",kt[kt.e_separated=4]="e_separated";var Qt,Zt=function(){this.state=e.b2TOIOutputState.e_unknown,this.t=0};(Qt=e.b2SeparationFunctionType||(e.b2SeparationFunctionType={}))[Qt.e_unknown=-1]="e_unknown",Qt[Qt.e_points=0]="e_points",Qt[Qt.e_faceA=1]="e_faceA",Qt[Qt.e_faceB=2]="e_faceB";var $t=function(){function t(){this.m_sweepA=new Oe,this.m_sweepB=new Oe,this.m_type=e.b2SeparationFunctionType.e_unknown,this.m_localPoint=new be,this.m_axis=new be}var n=t.prototype;return n.Initialize=function(t,n,i,r,o,a){this.m_proxyA=n,this.m_proxyB=r;var s=t.count;this.m_sweepA.Copy(i),this.m_sweepB.Copy(o);var c=Ht,l=jt;if(this.m_sweepA.GetTransform(c,a),this.m_sweepB.GetTransform(l,a),1===s){this.m_type=e.b2SeparationFunctionType.e_points;var u=this.m_proxyA.GetVertex(t.indexA[0]),h=this.m_proxyB.GetVertex(t.indexB[0]),_=Re.MulXV(c,u,Wt),f=Re.MulXV(l,h,qt);be.SubVV(f,_,this.m_axis);var d=this.m_axis.Normalize();return this.m_localPoint.SetZero(),d}if(t.indexA[0]===t.indexA[1]){this.m_type=e.b2SeparationFunctionType.e_faceB;var p=this.m_proxyB.GetVertex(t.indexB[0]),m=this.m_proxyB.GetVertex(t.indexB[1]);be.CrossVOne(be.SubVV(m,p,be.s_t0),this.m_axis).SelfNormalize();var v=Pe.MulRV(l.q,this.m_axis,Xt);be.MidVV(p,m,this.m_localPoint);var g=Re.MulXV(l,this.m_localPoint,qt),y=this.m_proxyA.GetVertex(t.indexA[0]),x=Re.MulXV(c,y,Wt),S=be.DotVV(be.SubVV(x,g,be.s_t0),v);return S<0&&(this.m_axis.SelfNeg(),S=-S),S}this.m_type=e.b2SeparationFunctionType.e_faceA;var C=this.m_proxyA.GetVertex(t.indexA[0]),A=this.m_proxyA.GetVertex(t.indexA[1]);be.CrossVOne(be.SubVV(A,C,be.s_t0),this.m_axis).SelfNormalize();var b=Pe.MulRV(c.q,this.m_axis,Xt);be.MidVV(C,A,this.m_localPoint);var T=Re.MulXV(c,this.m_localPoint,Wt),E=this.m_proxyB.GetVertex(t.indexB[0]),w=Re.MulXV(l,E,qt),I=be.DotVV(be.SubVV(w,T,be.s_t0),b);return I<0&&(this.m_axis.SelfNeg(),I=-I),I},n.FindMinSeparation=function(t,n,i){var r=Ht,o=jt;switch(this.m_sweepA.GetTransform(r,i),this.m_sweepB.GetTransform(o,i),this.m_type){case e.b2SeparationFunctionType.e_points:var a=Pe.MulTRV(r.q,this.m_axis,Yt),s=Pe.MulTRV(o.q,be.NegV(this.m_axis,be.s_t0),Kt);t[0]=this.m_proxyA.GetSupport(a),n[0]=this.m_proxyB.GetSupport(s);var c=this.m_proxyA.GetVertex(t[0]),l=this.m_proxyB.GetVertex(n[0]),u=Re.MulXV(r,c,Wt),h=Re.MulXV(o,l,qt);return be.DotVV(be.SubVV(h,u,be.s_t0),this.m_axis);case e.b2SeparationFunctionType.e_faceA:var _=Pe.MulRV(r.q,this.m_axis,Xt),f=Re.MulXV(r,this.m_localPoint,Wt),d=Pe.MulTRV(o.q,be.NegV(_,be.s_t0),Kt);t[0]=-1,n[0]=this.m_proxyB.GetSupport(d);var p=this.m_proxyB.GetVertex(n[0]),m=Re.MulXV(o,p,qt);return be.DotVV(be.SubVV(m,f,be.s_t0),_);case e.b2SeparationFunctionType.e_faceB:var v=Pe.MulRV(o.q,this.m_axis,Xt),g=Re.MulXV(o,this.m_localPoint,qt),y=Pe.MulTRV(r.q,be.NegV(v,be.s_t0),Yt);n[0]=-1,t[0]=this.m_proxyA.GetSupport(y);var x=this.m_proxyA.GetVertex(t[0]),S=Re.MulXV(r,x,Wt);return be.DotVV(be.SubVV(S,g,be.s_t0),v);default:return t[0]=-1,n[0]=-1,0}},n.Evaluate=function(t,n,i){var r=Ht,o=jt;switch(this.m_sweepA.GetTransform(r,i),this.m_sweepB.GetTransform(o,i),this.m_type){case e.b2SeparationFunctionType.e_points:var a=this.m_proxyA.GetVertex(t),s=this.m_proxyB.GetVertex(n),c=Re.MulXV(r,a,Wt),l=Re.MulXV(o,s,qt);return be.DotVV(be.SubVV(l,c,be.s_t0),this.m_axis);case e.b2SeparationFunctionType.e_faceA:var u=Pe.MulRV(r.q,this.m_axis,Xt),h=Re.MulXV(r,this.m_localPoint,Wt),_=this.m_proxyB.GetVertex(n),f=Re.MulXV(o,_,qt);return be.DotVV(be.SubVV(f,h,be.s_t0),u);case e.b2SeparationFunctionType.e_faceB:var d=Pe.MulRV(o.q,this.m_axis,Xt),p=Re.MulXV(o,this.m_localPoint,qt),m=this.m_proxyA.GetVertex(t),v=Re.MulXV(r,m,Wt);return be.DotVV(be.SubVV(v,p,be.s_t0),d);default:return 0}},t}(),en=new Me,tn=new Ue,nn=new ke,rn=new He,on=new $t,an=[0],sn=[0],cn=new Oe,ln=new Oe;function un(t,n){var i=en.Reset();++e.b2_toiCalls,t.state=e.b2TOIOutputState.e_unknown,t.t=n.tMax;var r=n.proxyA,o=n.proxyB,a=re(c,re(r.m_count,o.m_count)),s=cn.Copy(n.sweepA),l=ln.Copy(n.sweepB);s.Normalize(),l.Normalize();var u=n.tMax,_=r.m_radius+o.m_radius,f=re(h,_-3*h),d=.25*h,p=0,m=20,v=0,g=tn;g.count=0;var y=nn;for(y.proxyA.Copy(n.proxyA),y.proxyB.Copy(n.proxyB),y.useRadii=!1;;){var x=Ht,S=jt;s.GetTransform(x,p),l.GetTransform(S,p),y.transformA.Copy(x),y.transformB.Copy(S);var C=rn;if(it(C,g,y),C.distance<=0){t.state=e.b2TOIOutputState.e_overlapped,t.t=0;break}if(C.distance<f+d){t.state=e.b2TOIOutputState.e_touching,t.t=p;break}var A=on;A.Initialize(g,r,s,o,l,p);for(var b=!1,T=u,E=0;;){var w=an,I=sn,P=A.FindMinSeparation(w,I,T);if(P>f+d){t.state=e.b2TOIOutputState.e_separated,t.t=u,b=!0;break}if(P>f-d){p=T;break}var R=A.Evaluate(w[0],I[0],p);if(R<f-d){t.state=e.b2TOIOutputState.e_failed,t.t=p,b=!0;break}if(R<=f+d){t.state=e.b2TOIOutputState.e_touching,t.t=p,b=!0;break}for(var D=0,O=p,N=T;;){var B=0;B=1&D?O+(f-R)*(N-O)/(P-R):.5*(O+N),++D,++e.b2_toiRootIters;var M=A.Evaluate(w[0],I[0],B);if(te(M-f)<d){T=B;break}if(M>f?(O=B,R=M):(N=B,P=M),50===D)break}if(e.b2_toiMaxRootIters=re(e.b2_toiMaxRootIters,D),++E===a)break}if(++v,++e.b2_toiIters,b)break;if(v===m){t.state=e.b2TOIOutputState.e_failed,t.t=p;break}}e.b2_toiMaxIters=re(e.b2_toiMaxIters,v);var L=i.GetMilliseconds();e.b2_toiMaxTime=re(e.b2_toiMaxTime,L),e.b2_toiTime+=L}var hn=new be,_n=new be;function fn(t,n,i,r,o){t.pointCount=0;var a=Re.MulXV(i,n.m_p,hn),s=Re.MulXV(o,r.m_p,_n),c=be.DistanceSquaredVV(a,s),l=n.m_radius+r.m_radius;c>l*l||(t.type=e.b2ManifoldType.e_circles,t.localPoint.Copy(n.m_p),t.localNormal.SetZero(),t.pointCount=1,t.points[0].localPoint.Copy(r.m_p),t.points[0].id.key=0)}var dn=new be,pn=new be,mn=new be;function vn(t,n,o,a,s){t.pointCount=0;for(var c=Re.MulXV(s,a.m_p,dn),l=Re.MulTXV(o,c,pn),u=0,h=-i,_=n.m_radius+a.m_radius,f=n.m_count,d=n.m_vertices,p=n.m_normals,m=0;m<f;++m){var v=be.DotVV(p[m],be.SubVV(l,d[m],be.s_t0));if(v>_)return;v>h&&(h=v,u=m)}var g=u,y=(g+1)%f,x=d[g],S=d[y];if(h<r)return t.pointCount=1,t.type=e.b2ManifoldType.e_faceA,t.localNormal.Copy(p[u]),be.MidVV(x,S,t.localPoint),t.points[0].localPoint.Copy(a.m_p),void(t.points[0].id.key=0);var C=be.DotVV(be.SubVV(l,x,be.s_t0),be.SubVV(S,x,be.s_t1)),A=be.DotVV(be.SubVV(l,S,be.s_t0),be.SubVV(x,S,be.s_t1));if(C<=0){if(be.DistanceSquaredVV(l,x)>_*_)return;t.pointCount=1,t.type=e.b2ManifoldType.e_faceA,be.SubVV(l,x,t.localNormal).SelfNormalize(),t.localPoint.Copy(x),t.points[0].localPoint.Copy(a.m_p),t.points[0].id.key=0}else if(A<=0){if(be.DistanceSquaredVV(l,S)>_*_)return;t.pointCount=1,t.type=e.b2ManifoldType.e_faceA,be.SubVV(l,S,t.localNormal).SelfNormalize(),t.localPoint.Copy(S),t.points[0].localPoint.Copy(a.m_p),t.points[0].id.key=0}else{var b=be.MidVV(x,S,mn);if(be.DotVV(be.SubVV(l,b,be.s_t1),p[g])>_)return;t.pointCount=1,t.type=e.b2ManifoldType.e_faceA,t.localNormal.Copy(p[g]).SelfNormalize(),t.localPoint.Copy(b),t.points[0].localPoint.Copy(a.m_p),t.points[0].id.key=0}}var gn=new be,yn=new be,xn=new be,Sn=new be;function Cn(e,t,n,r,o){for(var a=e.m_vertices,s=e.m_normals,c=r.m_count,l=r.m_vertices,u=Pe.MulRV(t.q,s[n],gn),h=Pe.MulTRV(o.q,u,yn),_=0,f=i,d=0;d<c;++d){var p=be.DotVV(l[d],h);p<f&&(f=p,_=d)}var m=Re.MulXV(t,a[n],xn),v=Re.MulXV(o,l[_],Sn);return be.DotVV(be.SubVV(v,m,be.s_t0),u)}var An=new be,bn=new be;function Tn(e,t,n,r,o){for(var a=t.m_count,s=t.m_normals,c=be.SubVV(Re.MulXV(o,r.m_centroid,be.s_t0),Re.MulXV(n,t.m_centroid,be.s_t1),An),l=Pe.MulTRV(n.q,c,bn),u=0,h=-i,_=0;_<a;++_){var f=be.DotVV(s[_],l);f>h&&(h=f,u=_)}var d=Cn(t,n,u,r,o),p=(u+a-1)%a,m=Cn(t,n,p,r,o),v=(u+1)%a,g=Cn(t,n,v,r,o),y=0,x=0,S=0;if(m>d&&m>g)S=-1,y=p,x=m;else{if(!(g>d))return e[0]=u,d;S=1,y=v,x=g}for(;(d=Cn(t,n,u=-1===S?(y+a-1)%a:(y+1)%a,r,o))>x;)y=u,x=d;return e[0]=y,x}var En=new be;function wn(t,n,r,o,a,s){for(var c=n.m_normals,l=a.m_count,u=a.m_vertices,h=a.m_normals,_=Pe.MulTRV(s.q,Pe.MulRV(r.q,c[o],be.s_t0),En),f=0,d=i,p=0;p<l;++p){var m=be.DotVV(_,h[p]);m<d&&(d=m,f=p)}var v=f,g=(v+1)%l,y=t[0];Re.MulXV(s,u[v],y.v);var x=y.id.cf;x.indexA=o,x.indexB=v,x.typeA=e.b2ContactFeatureType.e_face,x.typeB=e.b2ContactFeatureType.e_vertex;var S=t[1];Re.MulXV(s,u[g],S.v);var C=S.id.cf;C.indexA=o,C.indexB=g,C.typeA=e.b2ContactFeatureType.e_face,C.typeB=e.b2ContactFeatureType.e_vertex}var In=Ct.MakeArray(2),Pn=Ct.MakeArray(2),Rn=Ct.MakeArray(2),Dn=[0],On=[0],Nn=new be,Bn=new be,Mn=new be,Ln=new be,Fn=new be,zn=new be,Vn=new be,Gn=new be;function Un(t,n,i,r,o){t.pointCount=0;var a=n.m_radius+r.m_radius,c=Dn;c[0]=0;var l=Tn(c,n,i,r,o);if(!(l>a)){var u=On;u[0]=0;var h=Tn(u,r,o,n,i);if(!(h>a)){var _,f,d,p,m=0,v=0;h>.98*l+.001?(_=r,f=n,d=o,p=i,m=u[0],t.type=e.b2ManifoldType.e_faceB,v=1):(_=n,f=r,d=i,p=o,m=c[0],t.type=e.b2ManifoldType.e_faceA,v=0);var g=In;wn(g,_,d,m,f,p);var y=_.m_count,x=_.m_vertices,S=m,C=(m+1)%y,A=x[S],b=x[C],T=be.SubVV(b,A,Nn);T.Normalize();var E=be.CrossVOne(T,Bn),w=be.MidVV(A,b,Mn),I=Pe.MulRV(d.q,T,Fn),P=be.CrossVOne(I,Ln),R=Re.MulXV(d,A,Vn),D=Re.MulXV(d,b,Gn),O=be.DotVV(P,R),N=-be.DotVV(I,R)+a,B=be.DotVV(I,D)+a,M=Pn,L=Rn;if(!(wt(M,g,be.NegV(I,zn),N,S)<2||wt(L,M,I,B,C)<2)){t.localNormal.Copy(E),t.localPoint.Copy(w);for(var F=0,z=0;z<s;++z){var V=L[z];if(be.DotVV(P,V.v)-O<=a){var G=t.points[F];if(Re.MulTXV(p,V.v,G.localPoint),G.id.Copy(V.id),v){var U=G.id.cf;G.id.cf.indexA=U.indexB,G.id.cf.indexB=U.indexA,G.id.cf.typeA=U.typeB,G.id.cf.typeB=U.typeA}++F}}t.pointCount=F}}}}var kn,Hn=new be,jn=new be,Wn=new be,qn=new be,Xn=new be,Yn=new be,Kn=new be,Jn=new mt;function Qn(t,n,i,r,o){t.pointCount=0;var a=Re.MulTXV(i,Re.MulXV(o,r.m_p,be.s_t0),Hn),s=n.m_vertex1,c=n.m_vertex2,l=be.SubVV(c,s,jn),u=be.DotVV(l,be.SubVV(c,a,be.s_t0)),h=be.DotVV(l,be.SubVV(a,s,be.s_t0)),_=n.m_radius+r.m_radius,f=Jn;if(f.cf.indexB=0,f.cf.typeB=e.b2ContactFeatureType.e_vertex,h<=0){var d=s,p=be.SubVV(a,d,Wn);if(be.DotVV(p,p)>_*_)return;if(n.m_hasVertex0){var m=n.m_vertex0,v=s,g=be.SubVV(v,m,qn);if(be.DotVV(g,be.SubVV(v,a,be.s_t0))>0)return}return f.cf.indexA=0,f.cf.typeA=e.b2ContactFeatureType.e_vertex,t.pointCount=1,t.type=e.b2ManifoldType.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(d),t.points[0].id.Copy(f),void t.points[0].localPoint.Copy(r.m_p)}if(u<=0){var y=c,x=be.SubVV(a,y,Wn);if(be.DotVV(x,x)>_*_)return;if(n.m_hasVertex3){var S=n.m_vertex3,C=c,A=be.SubVV(S,C,Xn);if(be.DotVV(A,be.SubVV(a,C,be.s_t0))>0)return}return f.cf.indexA=1,f.cf.typeA=e.b2ContactFeatureType.e_vertex,t.pointCount=1,t.type=e.b2ManifoldType.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(y),t.points[0].id.Copy(f),void t.points[0].localPoint.Copy(r.m_p)}var b=be.DotVV(l,l),T=Yn;T.x=1/b*(u*s.x+h*c.x),T.y=1/b*(u*s.y+h*c.y);var E=be.SubVV(a,T,Wn);if(!(be.DotVV(E,E)>_*_)){var w=Kn.Set(-l.y,l.x);be.DotVV(w,be.SubVV(a,s,be.s_t0))<0&&w.Set(-w.x,-w.y),w.Normalize(),f.cf.indexA=0,f.cf.typeA=e.b2ContactFeatureType.e_face,t.pointCount=1,t.type=e.b2ManifoldType.e_faceA,t.localNormal.Copy(w),t.localPoint.Copy(s),t.points[0].id.Copy(f),t.points[0].localPoint.Copy(r.m_p)}}!function(e){e[e.e_unknown=0]="e_unknown",e[e.e_edgeA=1]="e_edgeA",e[e.e_edgeB=2]="e_edgeB"}(kn||(kn={}));var Zn,$n=function(){this.type=kn.e_unknown,this.index=0,this.separation=0},ei=function(){this.vertices=[],this.normals=[],this.count=0},ti=function(){this.i1=0,this.i2=0,this.v1=new be,this.v2=new be,this.normal=new be,this.sideNormal1=new be,this.sideOffset1=0,this.sideNormal2=new be,this.sideOffset2=0};!function(e){e[e.e_isolated=0]="e_isolated",e[e.e_concave=1]="e_concave",e[e.e_convex=2]="e_convex"}(Zn||(Zn={}));var ni=function(){function t(){this.m_polygonB=new ei,this.m_xf=new Re,this.m_centroidB=new be,this.m_v0=new be,this.m_v1=new be,this.m_v2=new be,this.m_v3=new be,this.m_normal0=new be,this.m_normal1=new be,this.m_normal2=new be,this.m_normal=new be,this.m_type1=Zn.e_isolated,this.m_type2=Zn.e_isolated,this.m_lowerLimit=new be,this.m_upperLimit=new be,this.m_radius=0,this.m_front=!1}var n=t.prototype;return n.Collide=function(n,i,r,o,a){Re.MulTXX(r,a,this.m_xf),Re.MulXV(this.m_xf,o.m_centroid,this.m_centroidB),this.m_v0.Copy(i.m_vertex0),this.m_v1.Copy(i.m_vertex1),this.m_v2.Copy(i.m_vertex2),this.m_v3.Copy(i.m_vertex3);var c=i.m_hasVertex0,l=i.m_hasVertex3,u=be.SubVV(this.m_v2,this.m_v1,t.s_edge1);u.Normalize(),this.m_normal1.Set(u.y,-u.x);var h=be.DotVV(this.m_normal1,be.SubVV(this.m_centroidB,this.m_v1,be.s_t0)),_=0,f=0,d=!1,p=!1;if(c){var m=be.SubVV(this.m_v1,this.m_v0,t.s_edge0);m.Normalize(),this.m_normal0.Set(m.y,-m.x),d=be.CrossVV(m,u)>=0,_=be.DotVV(this.m_normal0,be.SubVV(this.m_centroidB,this.m_v0,be.s_t0))}if(l){var v=be.SubVV(this.m_v3,this.m_v2,t.s_edge2);v.Normalize(),this.m_normal2.Set(v.y,-v.x),p=be.CrossVV(u,v)>0,f=be.DotVV(this.m_normal2,be.SubVV(this.m_centroidB,this.m_v2,be.s_t0))}c&&l?d&&p?(this.m_front=_>=0||h>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):d?(this.m_front=_>=0||h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):p?(this.m_front=f>=0||_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=_>=0&&h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):c?d?(this.m_front=_>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):l?p?(this.m_front=h>=0||f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0&&f>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=o.m_count;for(var g=0;g<o.m_count;++g)this.m_polygonB.vertices.length<=g&&this.m_polygonB.vertices.push(new be),this.m_polygonB.normals.length<=g&&this.m_polygonB.normals.push(new be),Re.MulXV(this.m_xf,o.m_vertices[g],this.m_polygonB.vertices[g]),Pe.MulRV(this.m_xf.q,o.m_normals[g],this.m_polygonB.normals[g]);this.m_radius=o.m_radius+i.m_radius,n.pointCount=0;var y=this.ComputeEdgeSeparation(t.s_edgeAxis);if(y.type!==kn.e_unknown&&!(y.separation>this.m_radius)){var x=this.ComputePolygonSeparation(t.s_polygonAxis);if(!(x.type!==kn.e_unknown&&x.separation>this.m_radius)){var S,C=.98,A=.001;S=x.type===kn.e_unknown?y:x.separation>C*y.separation+A?x:y;var b=t.s_ie,T=t.s_rf;if(S.type===kn.e_edgeA){n.type=e.b2ManifoldType.e_faceA;for(var E=0,w=be.DotVV(this.m_normal,this.m_polygonB.normals[0]),I=1;I<this.m_polygonB.count;++I){var P=be.DotVV(this.m_normal,this.m_polygonB.normals[I]);P<w&&(w=P,E=I)}var R=E,D=(R+1)%this.m_polygonB.count,O=b[0];O.v.Copy(this.m_polygonB.vertices[R]),O.id.cf.indexA=0,O.id.cf.indexB=R,O.id.cf.typeA=e.b2ContactFeatureType.e_face,O.id.cf.typeB=e.b2ContactFeatureType.e_vertex;var N=b[1];N.v.Copy(this.m_polygonB.vertices[D]),N.id.cf.indexA=0,N.id.cf.indexB=D,N.id.cf.typeA=e.b2ContactFeatureType.e_face,N.id.cf.typeB=e.b2ContactFeatureType.e_vertex,this.m_front?(T.i1=0,T.i2=1,T.v1.Copy(this.m_v1),T.v2.Copy(this.m_v2),T.normal.Copy(this.m_normal1)):(T.i1=1,T.i2=0,T.v1.Copy(this.m_v2),T.v2.Copy(this.m_v1),T.normal.Copy(this.m_normal1).SelfNeg())}else{n.type=e.b2ManifoldType.e_faceB;var B=b[0];B.v.Copy(this.m_v1),B.id.cf.indexA=0,B.id.cf.indexB=S.index,B.id.cf.typeA=e.b2ContactFeatureType.e_vertex,B.id.cf.typeB=e.b2ContactFeatureType.e_face;var M=b[1];M.v.Copy(this.m_v2),M.id.cf.indexA=0,M.id.cf.indexB=S.index,M.id.cf.typeA=e.b2ContactFeatureType.e_vertex,M.id.cf.typeB=e.b2ContactFeatureType.e_face,T.i1=S.index,T.i2=(T.i1+1)%this.m_polygonB.count,T.v1.Copy(this.m_polygonB.vertices[T.i1]),T.v2.Copy(this.m_polygonB.vertices[T.i2]),T.normal.Copy(this.m_polygonB.normals[T.i1])}T.sideNormal1.Set(T.normal.y,-T.normal.x),T.sideNormal2.Copy(T.sideNormal1).SelfNeg(),T.sideOffset1=be.DotVV(T.sideNormal1,T.v1),T.sideOffset2=be.DotVV(T.sideNormal2,T.v2);var L=t.s_clipPoints1,F=t.s_clipPoints2;if(!(wt(L,b,T.sideNormal1,T.sideOffset1,T.i1)<s||wt(F,L,T.sideNormal2,T.sideOffset2,T.i2)<s)){S.type===kn.e_edgeA?(n.localNormal.Copy(T.normal),n.localPoint.Copy(T.v1)):(n.localNormal.Copy(o.m_normals[T.i1]),n.localPoint.Copy(o.m_vertices[T.i1]));for(var z=0,V=0;V<s;++V)if(be.DotVV(T.normal,be.SubVV(F[V].v,T.v1,be.s_t0))<=this.m_radius){var G=n.points[z];S.type===kn.e_edgeA?(Re.MulTXV(this.m_xf,F[V].v,G.localPoint),G.id.Copy(F[V].id)):(G.localPoint.Copy(F[V].v),G.id.cf.typeA=F[V].id.cf.typeB,G.id.cf.typeB=F[V].id.cf.typeA,G.id.cf.indexA=F[V].id.cf.indexB,G.id.cf.indexB=F[V].id.cf.indexA),++z}n.pointCount=z}}}},n.ComputeEdgeSeparation=function(e){var t=e;t.type=kn.e_edgeA,t.index=this.m_front?0:1,t.separation=i;for(var n=0;n<this.m_polygonB.count;++n){var r=be.DotVV(this.m_normal,be.SubVV(this.m_polygonB.vertices[n],this.m_v1,be.s_t0));r<t.separation&&(t.separation=r)}return t},n.ComputePolygonSeparation=function(e){var n=e;n.type=kn.e_unknown,n.index=-1,n.separation=-i;for(var r=t.s_perp.Set(-this.m_normal.y,this.m_normal.x),o=0;o<this.m_polygonB.count;++o){var a=be.NegV(this.m_polygonB.normals[o],t.s_n),s=ie(be.DotVV(a,be.SubVV(this.m_polygonB.vertices[o],this.m_v1,be.s_t0)),be.DotVV(a,be.SubVV(this.m_polygonB.vertices[o],this.m_v2,be.s_t0)));if(s>this.m_radius)return n.type=kn.e_edgeB,n.index=o,n.separation=s,n;if(be.DotVV(a,r)>=0){if(be.DotVV(be.SubVV(a,this.m_upperLimit,be.s_t0),this.m_normal)<-_)continue}else if(be.DotVV(be.SubVV(a,this.m_lowerLimit,be.s_t0),this.m_normal)<-_)continue;s>n.separation&&(n.type=kn.e_edgeB,n.index=o,n.separation=s)}return n},t}();ni.s_edge1=new be,ni.s_edge0=new be,ni.s_edge2=new be,ni.s_ie=Ct.MakeArray(2),ni.s_rf=new ti,ni.s_clipPoints1=Ct.MakeArray(2),ni.s_clipPoints2=Ct.MakeArray(2),ni.s_edgeAxis=new $n,ni.s_polygonAxis=new $n,ni.s_n=new be,ni.s_perp=new be;var ii=new ni;function ri(e,t,n,i,r){ii.Collide(e,t,n,i,r)}var oi,ai=function(){this.mass=0,this.center=new be(0,0),this.I=0};(oi=e.b2ShapeType||(e.b2ShapeType={}))[oi.e_unknown=-1]="e_unknown",oi[oi.e_circleShape=0]="e_circleShape",oi[oi.e_edgeShape=1]="e_edgeShape",oi[oi.e_polygonShape=2]="e_polygonShape",oi[oi.e_chainShape=3]="e_chainShape",oi[oi.e_shapeTypeCount=4]="e_shapeTypeCount";var si=function(){function t(t,n){this.m_type=e.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=t,this.m_radius=n}var n=t.prototype;return n.Copy=function(e){return this.m_radius=e.m_radius,this},n.GetType=function(){return this.m_type},t}(),ci=function(t){function n(n){var i;return void 0===n&&(n=0),(i=t.call(this,e.b2ShapeType.e_circleShape,n)||this).m_p=new be,i}Z(n,t);var i=n.prototype;return i.Set=function(e,t){return void 0===t&&(t=this.m_radius),this.m_p.Copy(e),this.m_radius=t,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(e){return t.prototype.Copy.call(this,e),this.m_p.Copy(e.m_p),this},i.GetChildCount=function(){return 1},i.TestPoint=function(e,t){var i=Re.MulXV(e,this.m_p,n.TestPoint_s_center),r=be.SubVV(t,i,n.TestPoint_s_d);return be.DotVV(r,r)<=le(this.m_radius)},i.ComputeDistance=function(e,t,i){var r=Re.MulXV(e,this.m_p,n.ComputeDistance_s_center);return be.SubVV(t,r,i),i.Normalize()-this.m_radius},i.RayCast=function(e,t,i){var o=Re.MulXV(i,this.m_p,n.RayCast_s_position),a=be.SubVV(t.p1,o,n.RayCast_s_s),s=be.DotVV(a,a)-le(this.m_radius),c=be.SubVV(t.p2,t.p1,n.RayCast_s_r),l=be.DotVV(a,c),u=be.DotVV(c,c),h=l*l-u*s;if(h<0||u<r)return!1;var _=-(l+he(h));return 0<=_&&_<=t.maxFraction*u&&(_/=u,e.fraction=_,be.AddVMulSV(a,_,c,e.normal).SelfNormalize(),!0)},i.ComputeAABB=function(e,t){var i=Re.MulXV(t,this.m_p,n.ComputeAABB_s_p);e.lowerBound.Set(i.x-this.m_radius,i.y-this.m_radius),e.upperBound.Set(i.x+this.m_radius,i.y+this.m_radius)},i.ComputeMass=function(e,t){var n=le(this.m_radius);e.mass=t*a*n,e.center.Copy(this.m_p),e.I=e.mass*(.5*n+be.DotVV(this.m_p,this.m_p))},i.SetupDistanceProxy=function(e){e.m_vertices=e.m_buffer,e.m_vertices[0].Copy(this.m_p),e.m_count=1,e.m_radius=this.m_radius},i.ComputeSubmergedArea=function(e,t,n,i){var o=Re.MulXV(n,this.m_p,new be),s=-(be.DotVV(e,o)-t);if(s<-this.m_radius+r)return 0;if(s>this.m_radius)return i.Copy(o),a*this.m_radius*this.m_radius;var c=this.m_radius*this.m_radius,l=s*s,u=c*(ge(s/this.m_radius)+a/2)+s*he(c-l),h=-2/3*_e(c-l,1.5)/u;return i.x=o.x+e.x*h,i.y=o.y+e.y*h,u},i.Dump=function(e){e("    const shape: b2CircleShape = new b2CircleShape();\n"),e("    shape.m_radius = %.15f;\n",this.m_radius),e("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)},n}(si);ci.TestPoint_s_center=new be,ci.TestPoint_s_d=new be,ci.ComputeDistance_s_center=new be,ci.RayCast_s_position=new be,ci.RayCast_s_s=new be,ci.RayCast_s_r=new be,ci.ComputeAABB_s_p=new be;var li=function(t){function n(){var n;return(n=t.call(this,e.b2ShapeType.e_polygonShape,f)||this).m_centroid=new be(0,0),n.m_vertices=[],n.m_normals=[],n.m_count=0,n}Z(n,t);var o=n.prototype;return o.Clone=function(){return(new n).Copy(this)},o.Copy=function(e){t.prototype.Copy.call(this,e),this.m_centroid.Copy(e.m_centroid),this.m_count=e.m_count,this.m_vertices=be.MakeArray(this.m_count),this.m_normals=be.MakeArray(this.m_count);for(var n=0;n<this.m_count;++n)this.m_vertices[n].Copy(e.m_vertices[n]),this.m_normals[n].Copy(e.m_normals[n]);return this},o.GetChildCount=function(){return 1},o.Set=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if("number"==typeof t[0][0]){var i=t[0];if(i.length%2!=0)throw new Error;return this._Set((function(e){return{x:i[2*e],y:i[2*e+1]}}),i.length/2)}var r=t[0],o=t[1]||r.length;return this._Set((function(e){return r[e]}),o)},o._Set=function(e,t){if(t<3)return this.SetAsBox(1,1);for(var i=t,r=[],o=0;o<i;++o){for(var a=e(o),s=!0,c=0;c<r.length;++c)if(be.DistanceSquaredVV(a,r[c])<.25*h*h){s=!1;break}s&&r.push(a)}if((i=r.length)<3)return this.SetAsBox(1,1);for(var l=0,u=r[0].x,_=1;_<i;++_){var f=r[_].x;(f>u||f===u&&r[_].y<r[l].y)&&(l=_,u=f)}for(var d=[],p=0,m=l;;){d[p]=m;for(var v=0,g=1;g<i;++g)if(v!==m){var y=be.SubVV(r[v],r[d[p]],n.Set_s_r),x=be.SubVV(r[g],r[d[p]],n.Set_s_v),S=be.CrossVV(y,x);S<0&&(v=g),0===S&&x.LengthSquared()>y.LengthSquared()&&(v=g)}else v=g;if(++p,m=v,v===l)break}this.m_count=p,this.m_vertices=be.MakeArray(this.m_count),this.m_normals=be.MakeArray(this.m_count);for(var C=0;C<p;++C)this.m_vertices[C].Copy(r[d[C]]);for(var A=0;A<p;++A){var b=this.m_vertices[A],T=this.m_vertices[(A+1)%p],E=be.SubVV(T,b,be.s_t0);be.CrossVOne(E,this.m_normals[A]).SelfNormalize()}return n.ComputeCentroid(this.m_vertices,p,this.m_centroid),this},o.SetAsBox=function(e,t,n,i){if(void 0===i&&(i=0),this.m_count=4,this.m_vertices=be.MakeArray(this.m_count),this.m_normals=be.MakeArray(this.m_count),this.m_vertices[0].Set(-e,-t),this.m_vertices[1].Set(e,-t),this.m_vertices[2].Set(e,t),this.m_vertices[3].Set(-e,t),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),n){this.m_centroid.Copy(n);var r=new Re;r.SetPosition(n),r.SetRotationAngle(i);for(var o=0;o<this.m_count;++o)Re.MulXV(r,this.m_vertices[o],this.m_vertices[o]),Pe.MulRV(r.q,this.m_normals[o],this.m_normals[o])}return this},o.TestPoint=function(e,t){for(var i=Re.MulTXV(e,t,n.TestPoint_s_pLocal),r=0;r<this.m_count;++r)if(be.DotVV(this.m_normals[r],be.SubVV(i,this.m_vertices[r],be.s_t0))>0)return!1;return!0},o.ComputeDistance=function(e,t,r){for(var o=Re.MulTXV(e,t,n.ComputeDistance_s_pLocal),a=-i,s=n.ComputeDistance_s_normalForMaxDistance.Copy(o),c=0;c<this.m_count;++c){var l=be.DotVV(this.m_normals[c],be.SubVV(o,this.m_vertices[c],be.s_t0));l>a&&(a=l,s.Copy(this.m_normals[c]))}if(a>0){for(var u=n.ComputeDistance_s_minDistance.Copy(s),h=a*a,_=0;_<this.m_count;++_){var f=be.SubVV(o,this.m_vertices[_],n.ComputeDistance_s_distance),d=f.LengthSquared();h>d&&(u.Copy(f),h=d)}return Pe.MulRV(e.q,u,r),r.Normalize(),Math.sqrt(h)}return Pe.MulRV(e.q,s,r),a},o.RayCast=function(e,t,i){for(var r=Re.MulTXV(i,t.p1,n.RayCast_s_p1),o=Re.MulTXV(i,t.p2,n.RayCast_s_p2),a=be.SubVV(o,r,n.RayCast_s_d),s=0,c=t.maxFraction,l=-1,u=0;u<this.m_count;++u){var h=be.DotVV(this.m_normals[u],be.SubVV(this.m_vertices[u],r,be.s_t0)),_=be.DotVV(this.m_normals[u],a);if(0===_){if(h<0)return!1}else _<0&&h<s*_?(s=h/_,l=u):_>0&&h<c*_&&(c=h/_);if(c<s)return!1}return l>=0&&(e.fraction=s,Pe.MulRV(i.q,this.m_normals[l],e.normal),!0)},o.ComputeAABB=function(e,t){for(var i=Re.MulXV(t,this.m_vertices[0],e.lowerBound),r=e.upperBound.Copy(i),o=0;o<this.m_count;++o){var a=Re.MulXV(t,this.m_vertices[o],n.ComputeAABB_s_v);be.MinV(a,i,i),be.MaxV(a,r,r)}var s=this.m_radius;i.SelfSubXY(s,s),r.SelfAddXY(s,s)},o.ComputeMass=function(e,t){for(var i=n.ComputeMass_s_center.SetZero(),r=0,o=0,a=n.ComputeMass_s_s.SetZero(),s=0;s<this.m_count;++s)a.SelfAdd(this.m_vertices[s]);a.SelfMul(1/this.m_count);for(var c=1/3,l=0;l<this.m_count;++l){var u=be.SubVV(this.m_vertices[l],a,n.ComputeMass_s_e1),h=be.SubVV(this.m_vertices[(l+1)%this.m_count],a,n.ComputeMass_s_e2),_=be.CrossVV(u,h),f=.5*_;r+=f,i.SelfAdd(be.MulSV(f*c,be.AddVV(u,h,be.s_t0),be.s_t1));var d=u.x,p=u.y,m=h.x,v=h.y;o+=.25*c*_*(d*d+m*d+m*m+p*p+v*p+v*v)}e.mass=t*r,i.SelfMul(1/r),be.AddVV(i,a,e.center),e.I=t*o,e.I+=e.mass*(be.DotVV(e.center,e.center)-be.DotVV(i,i))},o.Validate=function(){for(var e=0;e<this.m_count;++e)for(var t=e,i=(e+1)%this.m_count,r=this.m_vertices[t],o=be.SubVV(this.m_vertices[i],r,n.Validate_s_e),a=0;a<this.m_count;++a)if(a!==t&&a!==i){var s=be.SubVV(this.m_vertices[a],r,n.Validate_s_v);if(be.CrossVV(o,s)<0)return!1}return!0},o.SetupDistanceProxy=function(e){e.m_vertices=this.m_vertices,e.m_count=this.m_count,e.m_radius=this.m_radius},o.ComputeSubmergedArea=function(e,t,i,o){for(var a=Pe.MulTRV(i.q,e,n.ComputeSubmergedArea_s_normalL),s=t-be.DotVV(e,i.p),c=[],l=0,u=-1,h=-1,_=!1,f=0;f<this.m_count;++f){c[f]=be.DotVV(a,this.m_vertices[f])-s;var d=c[f]<-r;f>0&&(d?_||(u=f-1,l++):_&&(h=f-1,l++)),_=d}switch(l){case 0:if(_){var p=n.ComputeSubmergedArea_s_md;return this.ComputeMass(p,1),Re.MulXV(i,p.center,o),p.mass}return 0;case 1:-1===u?u=this.m_count-1:h=this.m_count-1}for(var m,v=(u+1)%this.m_count,g=(h+1)%this.m_count,y=(0-c[u])/(c[v]-c[u]),x=(0-c[h])/(c[g]-c[h]),S=n.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[u].x*(1-y)+this.m_vertices[v].x*y,this.m_vertices[u].y*(1-y)+this.m_vertices[v].y*y),C=n.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[h].x*(1-x)+this.m_vertices[g].x*x,this.m_vertices[h].y*(1-x)+this.m_vertices[g].y*x),A=0,b=n.ComputeSubmergedArea_s_center.SetZero(),T=this.m_vertices[v],E=v;E!==g;){m=(E=(E+1)%this.m_count)===g?C:this.m_vertices[E];var w=.5*((T.x-S.x)*(m.y-S.y)-(T.y-S.y)*(m.x-S.x));A+=w,b.x+=w*(S.x+T.x+m.x)/3,b.y+=w*(S.y+T.y+m.y)/3,T=m}return b.SelfMul(1/A),Re.MulXV(i,b,o),A},o.Dump=function(e){e("    const shape: b2PolygonShape = new b2PolygonShape();\n"),e("    const vs: b2Vec2[] = [];\n");for(var t=0;t<this.m_count;++t)e("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",t,this.m_vertices[t].x,this.m_vertices[t].y);e("    shape.Set(vs, %d);\n",this.m_count)},n.ComputeCentroid=function(e,t,i){var r=i;r.SetZero();for(var o=0,a=n.ComputeCentroid_s_pRef.SetZero(),s=1/3,c=0;c<t;++c){var l=a,u=e[c],h=e[(c+1)%t],_=be.SubVV(u,l,n.ComputeCentroid_s_e1),f=be.SubVV(h,l,n.ComputeCentroid_s_e2),d=.5*be.CrossVV(_,f);o+=d,r.x+=d*s*(l.x+u.x+h.x),r.y+=d*s*(l.y+u.y+h.y)}return r.SelfMul(1/o),r},n}(si);li.Set_s_r=new be,li.Set_s_v=new be,li.TestPoint_s_pLocal=new be,li.ComputeDistance_s_pLocal=new be,li.ComputeDistance_s_normalForMaxDistance=new be,li.ComputeDistance_s_minDistance=new be,li.ComputeDistance_s_distance=new be,li.RayCast_s_p1=new be,li.RayCast_s_p2=new be,li.RayCast_s_d=new be,li.ComputeAABB_s_v=new be,li.ComputeMass_s_center=new be,li.ComputeMass_s_s=new be,li.ComputeMass_s_e1=new be,li.ComputeMass_s_e2=new be,li.Validate_s_e=new be,li.Validate_s_v=new be,li.ComputeSubmergedArea_s_normalL=new be,li.ComputeSubmergedArea_s_md=new ai,li.ComputeSubmergedArea_s_intoVec=new be,li.ComputeSubmergedArea_s_outoVec=new be,li.ComputeSubmergedArea_s_center=new be,li.ComputeCentroid_s_pRef=new be,li.ComputeCentroid_s_e1=new be,li.ComputeCentroid_s_e2=new be;var ui=function(t){function n(){var n;return(n=t.call(this,e.b2ShapeType.e_edgeShape,f)||this).m_vertex1=new be,n.m_vertex2=new be,n.m_vertex0=new be,n.m_vertex3=new be,n.m_hasVertex0=!1,n.m_hasVertex3=!1,n}Z(n,t);var i=n.prototype;return i.Set=function(e,t){return this.m_vertex1.Copy(e),this.m_vertex2.Copy(t),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(e){return t.prototype.Copy.call(this,e),this.m_vertex1.Copy(e.m_vertex1),this.m_vertex2.Copy(e.m_vertex2),this.m_vertex0.Copy(e.m_vertex0),this.m_vertex3.Copy(e.m_vertex3),this.m_hasVertex0=e.m_hasVertex0,this.m_hasVertex3=e.m_hasVertex3,this},i.GetChildCount=function(){return 1},i.TestPoint=function(){return!1},i.ComputeDistance=function(e,t,i){var r=Re.MulXV(e,this.m_vertex1,n.ComputeDistance_s_v1),o=Re.MulXV(e,this.m_vertex2,n.ComputeDistance_s_v2),a=be.SubVV(t,r,n.ComputeDistance_s_d),s=be.SubVV(o,r,n.ComputeDistance_s_s),c=be.DotVV(a,s);if(c>0){var l=be.DotVV(s,s);c>l?be.SubVV(t,o,a):a.SelfMulSub(c/l,s)}return i.Copy(a),i.Normalize()},i.RayCast=function(e,t,i){var r=Re.MulTXV(i,t.p1,n.RayCast_s_p1),o=Re.MulTXV(i,t.p2,n.RayCast_s_p2),a=be.SubVV(o,r,n.RayCast_s_d),s=this.m_vertex1,c=this.m_vertex2,l=be.SubVV(c,s,n.RayCast_s_e),u=e.normal.Set(l.y,-l.x).SelfNormalize(),h=be.DotVV(u,be.SubVV(s,r,be.s_t0)),_=be.DotVV(u,a);if(0===_)return!1;var f=h/_;if(f<0||t.maxFraction<f)return!1;var d=be.AddVMulSV(r,f,a,n.RayCast_s_q),p=be.SubVV(c,s,n.RayCast_s_r),m=be.DotVV(p,p);if(0===m)return!1;var v=be.DotVV(be.SubVV(d,s,be.s_t0),p)/m;return!(v<0||1<v||(e.fraction=f,Pe.MulRV(i.q,e.normal,e.normal),h>0&&e.normal.SelfNeg(),0))},i.ComputeAABB=function(e,t){var i=Re.MulXV(t,this.m_vertex1,n.ComputeAABB_s_v1),r=Re.MulXV(t,this.m_vertex2,n.ComputeAABB_s_v2);be.MinV(i,r,e.lowerBound),be.MaxV(i,r,e.upperBound);var o=this.m_radius;e.lowerBound.SelfSubXY(o,o),e.upperBound.SelfAddXY(o,o)},i.ComputeMass=function(e){e.mass=0,be.MidVV(this.m_vertex1,this.m_vertex2,e.center),e.I=0},i.SetupDistanceProxy=function(e){e.m_vertices=e.m_buffer,e.m_vertices[0].Copy(this.m_vertex1),e.m_vertices[1].Copy(this.m_vertex2),e.m_count=2,e.m_radius=this.m_radius},i.ComputeSubmergedArea=function(e,t,n,i){return i.SetZero(),0},i.Dump=function(e){e("    const shape: b2EdgeShape = new b2EdgeShape();\n"),e("    shape.m_radius = %.15f;\n",this.m_radius),e("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),e("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),e("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),e("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),e("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),e("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)},n}(si);ui.ComputeDistance_s_v1=new be,ui.ComputeDistance_s_v2=new be,ui.ComputeDistance_s_d=new be,ui.ComputeDistance_s_s=new be,ui.RayCast_s_p1=new be,ui.RayCast_s_p2=new be,ui.RayCast_s_d=new be,ui.RayCast_s_e=new be,ui.RayCast_s_q=new be,ui.RayCast_s_r=new be,ui.ComputeAABB_s_v1=new be,ui.ComputeAABB_s_v2=new be;var hi=function(t){function n(){var n;return(n=t.call(this,e.b2ShapeType.e_chainShape,f)||this).m_vertices=[],n.m_count=0,n.m_prevVertex=new be,n.m_nextVertex=new be,n.m_hasPrevVertex=!1,n.m_hasNextVertex=!1,n}Z(n,t);var i=n.prototype;return i.CreateLoop=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if("number"==typeof t[0][0]){var i=t[0];if(i.length%2!=0)throw new Error;return this._CreateLoop((function(e){return{x:i[2*e],y:i[2*e+1]}}),i.length/2)}var r=t[0],o=t[1]||r.length;return this._CreateLoop((function(e){return r[e]}),o)},i._CreateLoop=function(e,t){if(t<3)return this;this.m_count=t+1,this.m_vertices=be.MakeArray(this.m_count);for(var n=0;n<t;++n)this.m_vertices[n].Copy(e(n));return this.m_vertices[t].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this},i.CreateChain=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if("number"==typeof t[0][0]){var i=t[0];if(i.length%2!=0)throw new Error;return this._CreateChain((function(e){return{x:i[2*e],y:i[2*e+1]}}),i.length/2)}var r=t[0],o=t[1]||r.length;return this._CreateChain((function(e){return r[e]}),o)},i._CreateChain=function(e,t){this.m_count=t,this.m_vertices=be.MakeArray(t);for(var n=0;n<t;++n)this.m_vertices[n].Copy(e(n));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this},i.SetPrevVertex=function(e){return this.m_prevVertex.Copy(e),this.m_hasPrevVertex=!0,this},i.SetNextVertex=function(e){return this.m_nextVertex.Copy(e),this.m_hasNextVertex=!0,this},i.Clone=function(){return(new n).Copy(this)},i.Copy=function(e){return t.prototype.Copy.call(this,e),this._CreateChain((function(t){return e.m_vertices[t]}),e.m_count),this.m_prevVertex.Copy(e.m_prevVertex),this.m_nextVertex.Copy(e.m_nextVertex),this.m_hasPrevVertex=e.m_hasPrevVertex,this.m_hasNextVertex=e.m_hasNextVertex,this},i.GetChildCount=function(){return this.m_count-1},i.GetChildEdge=function(e,t){e.m_radius=this.m_radius,e.m_vertex1.Copy(this.m_vertices[t]),e.m_vertex2.Copy(this.m_vertices[t+1]),t>0?(e.m_vertex0.Copy(this.m_vertices[t-1]),e.m_hasVertex0=!0):(e.m_vertex0.Copy(this.m_prevVertex),e.m_hasVertex0=this.m_hasPrevVertex),t<this.m_count-2?(e.m_vertex3.Copy(this.m_vertices[t+2]),e.m_hasVertex3=!0):(e.m_vertex3.Copy(this.m_nextVertex),e.m_hasVertex3=this.m_hasNextVertex)},i.TestPoint=function(){return!1},i.ComputeDistance=function(e,t,i,r){var o=n.ComputeDistance_s_edgeShape;return this.GetChildEdge(o,r),o.ComputeDistance(e,t,i,0)},i.RayCast=function(e,t,i,r){var o=n.RayCast_s_edgeShape;return o.m_vertex1.Copy(this.m_vertices[r]),o.m_vertex2.Copy(this.m_vertices[(r+1)%this.m_count]),o.RayCast(e,t,i,0)},i.ComputeAABB=function(e,t,i){var r=this.m_vertices[i],o=this.m_vertices[(i+1)%this.m_count],a=Re.MulXV(t,r,n.ComputeAABB_s_v1),s=Re.MulXV(t,o,n.ComputeAABB_s_v2);be.MinV(a,s,e.lowerBound),be.MaxV(a,s,e.upperBound)},i.ComputeMass=function(e){e.mass=0,e.center.SetZero(),e.I=0},i.SetupDistanceProxy=function(e,t){e.m_vertices=e.m_buffer,e.m_vertices[0].Copy(this.m_vertices[t]),t+1<this.m_count?e.m_vertices[1].Copy(this.m_vertices[t+1]):e.m_vertices[1].Copy(this.m_vertices[0]),e.m_count=2,e.m_radius=this.m_radius},i.ComputeSubmergedArea=function(e,t,n,i){return i.SetZero(),0},i.Dump=function(e){e("    const shape: b2ChainShape = new b2ChainShape();\n"),e("    const vs: b2Vec2[] = [];\n");for(var t=0;t<this.m_count;++t)e("    vs[%d] = new bVec2(%.15f, %.15f);\n",t,this.m_vertices[t].x,this.m_vertices[t].y);e("    shape.CreateChain(vs, %d);\n",this.m_count),e("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),e("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),e("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),e("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")},n}(si);hi.ComputeDistance_s_edgeShape=new ui,hi.RayCast_s_edgeShape=new ui,hi.ComputeAABB_s_v1=new be,hi.ComputeAABB_s_v2=new be;var _i=function(){function e(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}var t=e.prototype;return t.Clone=function(){return(new e).Copy(this)},t.Copy=function(e){return this.categoryBits=e.categoryBits,this.maskBits=e.maskBits,this.groupIndex=e.groupIndex||0,this},e}();_i.DEFAULT=new _i;var fi=function(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new _i},di=function(){function e(e,t){this.aabb=new Tt,this.childIndex=0,this.fixture=e,this.childIndex=t,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),t),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}var t=e.prototype;return t.Reset=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)},t.Touch=function(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)},t.Synchronize=function(t,n,i){if(t===n)this.fixture.m_shape.ComputeAABB(this.aabb,t,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i);else{var r=e.Synchronize_s_aabb1,o=e.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(r,t,this.childIndex),this.fixture.m_shape.ComputeAABB(o,n,this.childIndex),this.aabb.Combine2(r,o),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i)}},e}();di.Synchronize_s_aabb1=new Tt,di.Synchronize_s_aabb2=new Tt;var pi,mi=function(){function e(e,t){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new _i,this.m_isSensor=!1,this.m_userData=null,this.m_body=e,this.m_shape=t.shape.Clone(),this.m_userData=n(t.userData,null),this.m_friction=n(t.friction,.2),this.m_restitution=n(t.restitution,0),this.m_filter.Copy(n(t.filter,_i.DEFAULT)),this.m_isSensor=n(t.isSensor,!1),this.m_density=n(t.density,0)}var t=e.prototype;return t.Reset=function(){},t.GetType=function(){return this.m_shape.GetType()},t.GetShape=function(){return this.m_shape},t.SetSensor=function(e){e!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=e)},t.IsSensor=function(){return this.m_isSensor},t.SetFilterData=function(e){this.m_filter.Copy(e),this.Refilter()},t.GetFilterData=function(){return this.m_filter},t.Refilter=function(){for(var e=this.m_body.GetContactList();e;){var t=e.contact,n=t.GetFixtureA(),i=t.GetFixtureB();n!==this&&i!==this||t.FlagForFiltering(),e=e.next}this.TouchProxies()},t.GetBody=function(){return this.m_body},t.GetNext=function(){return this.m_next},t.GetUserData=function(){return this.m_userData},t.SetUserData=function(e){this.m_userData=e},t.TestPoint=function(e){return this.m_shape.TestPoint(this.m_body.GetTransform(),e)},t.ComputeDistance=function(e,t,n){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),e,t,n)},t.RayCast=function(e,t,n){return this.m_shape.RayCast(e,t,this.m_body.GetTransform(),n)},t.GetMassData=function(e){return void 0===e&&(e=new ai),this.m_shape.ComputeMass(e,this.m_density),e},t.SetDensity=function(e){this.m_density=e},t.GetDensity=function(){return this.m_density},t.GetFriction=function(){return this.m_friction},t.SetFriction=function(e){this.m_friction=e},t.GetRestitution=function(){return this.m_restitution},t.SetRestitution=function(e){this.m_restitution=e},t.GetAABB=function(e){return this.m_proxies[e].aabb},t.Dump=function(e,t){e("    const fd: b2FixtureDef = new b2FixtureDef();\n"),e("    fd.friction = %.15f;\n",this.m_friction),e("    fd.restitution = %.15f;\n",this.m_restitution),e("    fd.density = %.15f;\n",this.m_density),e("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),e("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),e("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),e("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(e),e("\n"),e("    fd.shape = shape;\n"),e("\n"),e("    bodies[%d].CreateFixture(fd);\n",t)},t.CreateProxies=function(){if(0!==this.m_proxies.length)throw new Error;for(var e=0;e<this.m_shape.GetChildCount();++e)this.m_proxies[e]=new di(this,e)},t.DestroyProxies=function(){for(var e,t=ae(this.m_proxies);!(e=t()).done;)e.value.Reset();this.m_proxies.length=0},t.TouchProxies=function(){for(var e,t=ae(this.m_proxies);!(e=t()).done;)e.value.Touch()},t.SynchronizeProxies=function(e,t,n){for(var i,r=ae(this.m_proxies);!(i=r()).done;)i.value.Synchronize(e,t,n)},J(e,[{key:"m_proxyCount",get:function(){return this.m_proxies.length}}]),e}();(pi=e.b2BodyType||(e.b2BodyType={}))[pi.b2_unknown=-1]="b2_unknown",pi[pi.b2_staticBody=0]="b2_staticBody",pi[pi.b2_kinematicBody=1]="b2_kinematicBody",pi[pi.b2_dynamicBody=2]="b2_dynamicBody";var vi,gi,yi=function(){this.type=e.b2BodyType.b2_staticBody,this.position=new be(0,0),this.angle=0,this.linearVelocity=new be(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1},xi=function(){function t(t,i){this.m_type=e.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new Re,this.m_xf0=new Re,this.m_sweep=new Oe,this.m_linearVelocity=new be,this.m_angularVelocity=0,this.m_force=new be,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=n(t.bullet,!1),this.m_fixedRotationFlag=n(t.fixedRotation,!1),this.m_autoSleepFlag=n(t.allowSleep,!0),this.m_awakeFlag=n(t.awake,!0),this.m_activeFlag=n(t.active,!0),this.m_world=i,this.m_xf.p.Copy(n(t.position,be.ZERO)),this.m_xf.q.SetAngle(n(t.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(n(t.linearVelocity,be.ZERO)),this.m_angularVelocity=n(t.angularVelocity,0),this.m_linearDamping=n(t.linearDamping,0),this.m_angularDamping=n(t.angularDamping,0),this.m_gravityScale=n(t.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=n(t.type,e.b2BodyType.b2_staticBody),t.type===e.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}var i=t.prototype;return i.CreateFixture=function(e,t){return void 0===t&&(t=0),e instanceof si?this.CreateFixtureShapeDensity(e,t):this.CreateFixtureDef(e)},i.CreateFixtureDef=function(e){if(this.m_world.IsLocked())throw new Error;var t=new mi(this,e);return this.m_activeFlag&&t.CreateProxies(),t.m_next=this.m_fixtureList,this.m_fixtureList=t,++this.m_fixtureCount,t.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,t},i.CreateFixtureShapeDensity=function(e,n){void 0===n&&(n=0);var i=t.CreateFixtureShapeDensity_s_def;return i.shape=e,i.density=n,this.CreateFixtureDef(i)},i.DestroyFixture=function(e){if(this.m_world.IsLocked())throw new Error;for(var t=this.m_fixtureList,n=null;null!==t;){if(t===e){n?n.m_next=e.m_next:this.m_fixtureList=e.m_next;break}n=t,t=t.m_next}for(var i=this.m_contactList;i;){var r=i.contact;i=i.next;var o=r.GetFixtureA(),a=r.GetFixtureB();e!==o&&e!==a||this.m_world.m_contactManager.Destroy(r)}this.m_activeFlag&&e.DestroyProxies(),e.m_next=null,e.Reset(),--this.m_fixtureCount,this.ResetMassData()},i.SetTransformVec=function(e,t){this.SetTransformXY(e.x,e.y,t)},i.SetTransformXY=function(e,t,n){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(n),this.m_xf.p.Set(e,t),this.m_xf0.Copy(this.m_xf),Re.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=n,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=n;for(var i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(this.m_xf,this.m_xf,be.ZERO);this.m_world.m_contactManager.FindNewContacts()},i.SetTransform=function(e){this.SetTransformVec(e.p,e.GetAngle())},i.GetTransform=function(){return this.m_xf},i.GetPosition=function(){return this.m_xf.p},i.SetPosition=function(e){this.SetTransformVec(e,this.GetAngle())},i.SetPositionXY=function(e,t){this.SetTransformXY(e,t,this.GetAngle())},i.GetAngle=function(){return this.m_sweep.a},i.SetAngle=function(e){this.SetTransformVec(this.GetPosition(),e)},i.GetWorldCenter=function(){return this.m_sweep.c},i.GetLocalCenter=function(){return this.m_sweep.localCenter},i.SetLinearVelocity=function(t){this.m_type!==e.b2BodyType.b2_staticBody&&(be.DotVV(t,t)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(t))},i.GetLinearVelocity=function(){return this.m_linearVelocity},i.SetAngularVelocity=function(t){this.m_type!==e.b2BodyType.b2_staticBody&&(t*t>0&&this.SetAwake(!0),this.m_angularVelocity=t)},i.GetAngularVelocity=function(){return this.m_angularVelocity},i.GetDefinition=function(e){return e.type=this.GetType(),e.allowSleep=this.m_autoSleepFlag,e.angle=this.GetAngle(),e.angularDamping=this.m_angularDamping,e.gravityScale=this.m_gravityScale,e.angularVelocity=this.m_angularVelocity,e.fixedRotation=this.m_fixedRotationFlag,e.bullet=this.m_bulletFlag,e.awake=this.m_awakeFlag,e.linearDamping=this.m_linearDamping,e.linearVelocity.Copy(this.GetLinearVelocity()),e.position.Copy(this.GetPosition()),e.userData=this.GetUserData(),e},i.ApplyForce=function(t,n,i){void 0===i&&(i=!0),this.m_type===e.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(n.x-this.m_sweep.c.x)*t.y-(n.y-this.m_sweep.c.y)*t.x))},i.ApplyForceToCenter=function(t,n){void 0===n&&(n=!0),this.m_type===e.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y))},i.ApplyTorque=function(t,n){void 0===n&&(n=!0),this.m_type===e.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))},i.ApplyLinearImpulse=function(t,n,i){void 0===i&&(i=!0),this.m_type===e.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((n.x-this.m_sweep.c.x)*t.y-(n.y-this.m_sweep.c.y)*t.x)))},i.ApplyLinearImpulseToCenter=function(t,n){void 0===n&&(n=!0),this.m_type===e.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y))},i.ApplyAngularImpulse=function(t,n){void 0===n&&(n=!0),this.m_type===e.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))},i.GetMass=function(){return this.m_mass},i.GetInertia=function(){return this.m_I+this.m_mass*be.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)},i.GetMassData=function(e){return e.mass=this.m_mass,e.I=this.m_I+this.m_mass*be.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),e.center.Copy(this.m_sweep.localCenter),e},i.SetMassData=function(n){if(this.m_world.IsLocked())throw new Error;if(this.m_type===e.b2BodyType.b2_dynamicBody){this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=n.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,n.I>0&&!this.m_fixedRotationFlag&&(this.m_I=n.I-this.m_mass*be.DotVV(n.center,n.center),this.m_invI=1/this.m_I);var i=t.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(n.center),Re.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),be.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,be.SubVV(this.m_sweep.c,i,be.s_t0),this.m_linearVelocity)}},i.ResetMassData=function(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===e.b2BodyType.b2_staticBody||this.m_type===e.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);for(var n=t.ResetMassData_s_localCenter.SetZero(),i=this.m_fixtureList;i;i=i.m_next)if(0!==i.m_density){var r=i.GetMassData(t.ResetMassData_s_massData);this.m_mass+=r.mass,n.x+=r.center.x*r.mass,n.y+=r.center.y*r.mass,this.m_I+=r.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,n.x*=this.m_invMass,n.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*be.DotVV(n,n),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);var o=t.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(n),Re.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),be.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,be.SubVV(this.m_sweep.c,o,be.s_t0),this.m_linearVelocity)},i.GetWorldPoint=function(e,t){return Re.MulXV(this.m_xf,e,t)},i.GetWorldVector=function(e,t){return Pe.MulRV(this.m_xf.q,e,t)},i.GetLocalPoint=function(e,t){return Re.MulTXV(this.m_xf,e,t)},i.GetLocalVector=function(e,t){return Pe.MulTRV(this.m_xf.q,e,t)},i.GetLinearVelocityFromWorldPoint=function(e,t){return be.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,be.SubVV(e,this.m_sweep.c,be.s_t0),t)},i.GetLinearVelocityFromLocalPoint=function(e,t){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(e,t),t)},i.GetLinearDamping=function(){return this.m_linearDamping},i.SetLinearDamping=function(e){this.m_linearDamping=e},i.GetAngularDamping=function(){return this.m_angularDamping},i.SetAngularDamping=function(e){this.m_angularDamping=e},i.GetGravityScale=function(){return this.m_gravityScale},i.SetGravityScale=function(e){this.m_gravityScale=e},i.SetType=function(t){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==t){this.m_type=t,this.ResetMassData(),this.m_type===e.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;for(var n=this.m_contactList;n;){var i=n;n=n.next,this.m_world.m_contactManager.Destroy(i.contact)}this.m_contactList=null;for(var r=this.m_fixtureList;r;r=r.m_next)r.TouchProxies()}},i.GetType=function(){return this.m_type},i.SetBullet=function(e){this.m_bulletFlag=e},i.IsBullet=function(){return this.m_bulletFlag},i.SetSleepingAllowed=function(e){this.m_autoSleepFlag=e,e||this.SetAwake(!0)},i.IsSleepingAllowed=function(){return this.m_autoSleepFlag},i.SetAwake=function(e){e?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},i.IsAwake=function(){return this.m_awakeFlag},i.SetActive=function(e){if(this.m_world.IsLocked())throw new Error;if(e!==this.IsActive())if(this.m_activeFlag=e,e)for(var t=this.m_fixtureList;t;t=t.m_next)t.CreateProxies();else{for(var n=this.m_fixtureList;n;n=n.m_next)n.DestroyProxies();for(var i=this.m_contactList;i;){var r=i;i=i.next,this.m_world.m_contactManager.Destroy(r.contact)}this.m_contactList=null}},i.IsActive=function(){return this.m_activeFlag},i.SetFixedRotation=function(e){this.m_fixedRotationFlag!==e&&(this.m_fixedRotationFlag=e,this.m_angularVelocity=0,this.ResetMassData())},i.IsFixedRotation=function(){return this.m_fixedRotationFlag},i.GetFixtureList=function(){return this.m_fixtureList},i.GetJointList=function(){return this.m_jointList},i.GetContactList=function(){return this.m_contactList},i.GetNext=function(){return this.m_next},i.GetUserData=function(){return this.m_userData},i.SetUserData=function(e){this.m_userData=e},i.GetWorld=function(){return this.m_world},i.Dump=function(t){var n=this.m_islandIndex;t("{\n"),t("  const bd: b2BodyDef = new b2BodyDef();\n");var i="";switch(this.m_type){case e.b2BodyType.b2_staticBody:i="b2BodyType.b2_staticBody";break;case e.b2BodyType.b2_kinematicBody:i="b2BodyType.b2_kinematicBody";break;case e.b2BodyType.b2_dynamicBody:i="b2BodyType.b2_dynamicBody"}t("  bd.type = %s;\n",i),t("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),t("  bd.angle = %.15f;\n",this.m_sweep.a),t("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),t("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),t("  bd.linearDamping = %.15f;\n",this.m_linearDamping),t("  bd.angularDamping = %.15f;\n",this.m_angularDamping),t("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),t("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),t("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),t("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),t("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),t("  bd.gravityScale = %.15f;\n",this.m_gravityScale),t("\n"),t("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),t("\n");for(var r=this.m_fixtureList;r;r=r.m_next)t("  {\n"),r.Dump(t,n),t("  }\n");t("}\n")},i.SynchronizeFixtures=function(){var e=t.SynchronizeFixtures_s_xf1;e.q.SetAngle(this.m_sweep.a0),Pe.MulRV(e.q,this.m_sweep.localCenter,e.p),be.SubVV(this.m_sweep.c0,e.p,e.p);for(var n=be.SubVV(this.m_sweep.c,this.m_sweep.c0,t.SynchronizeFixtures_s_displacement),i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(e,this.m_xf,n)},i.SynchronizeTransform=function(){this.m_xf.q.SetAngle(this.m_sweep.a),Pe.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),be.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},i.ShouldCollide=function(t){return(this.m_type!==e.b2BodyType.b2_staticBody||t.m_type!==e.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(t)},i.ShouldCollideConnected=function(e){for(var t=this.m_jointList;t;t=t.next)if(t.other===e&&!t.joint.m_collideConnected)return!1;return!0},i.Advance=function(e){this.m_sweep.Advance(e),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),Pe.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),be.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)},i.GetControllerList=function(){return this.m_controllerList},i.GetControllerCount=function(){return this.m_controllerCount},t}();xi.CreateFixtureShapeDensity_s_def=new fi,xi.SetMassData_s_oldCenter=new be,xi.ResetMassData_s_localCenter=new be,xi.ResetMassData_s_oldCenter=new be,xi.ResetMassData_s_massData=new ai,xi.SynchronizeFixtures_s_xf1=new Re,xi.SynchronizeFixtures_s_displacement=new be,(gi=e.b2JointType||(e.b2JointType={}))[gi.e_unknownJoint=0]="e_unknownJoint",gi[gi.e_revoluteJoint=1]="e_revoluteJoint",gi[gi.e_prismaticJoint=2]="e_prismaticJoint",gi[gi.e_distanceJoint=3]="e_distanceJoint",gi[gi.e_pulleyJoint=4]="e_pulleyJoint",gi[gi.e_mouseJoint=5]="e_mouseJoint",gi[gi.e_gearJoint=6]="e_gearJoint",gi[gi.e_wheelJoint=7]="e_wheelJoint",gi[gi.e_weldJoint=8]="e_weldJoint",gi[gi.e_frictionJoint=9]="e_frictionJoint",gi[gi.e_ropeJoint=10]="e_ropeJoint",gi[gi.e_motorJoint=11]="e_motorJoint",gi[gi.e_areaJoint=12]="e_areaJoint",(vi=e.b2LimitState||(e.b2LimitState={}))[vi.e_inactiveLimit=0]="e_inactiveLimit",vi[vi.e_atLowerLimit=1]="e_atLowerLimit",vi[vi.e_atUpperLimit=2]="e_atUpperLimit",vi[vi.e_equalLimits=3]="e_equalLimits";var Si=function(){function e(){this.linear=new be,this.angularA=0,this.angularB=0}var t=e.prototype;return t.SetZero=function(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this},t.Set=function(e,t,n){return this.linear.Copy(e),this.angularA=t,this.angularB=n,this},e}(),Ci=function(){function e(e){this._other=null,this.prev=null,this.next=null,this.joint=e}return e.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},J(e,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(e){if(null!==this._other)throw new Error;this._other=e}}]),e}(),Ai=function(t){this.type=e.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=t},bi=function(){function t(t){this.m_type=e.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new Ci(this),this.m_edgeB=new Ci(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=t.type,this.m_edgeA.other=t.bodyB,this.m_edgeB.other=t.bodyA,this.m_bodyA=t.bodyA,this.m_bodyB=t.bodyB,this.m_collideConnected=n(t.collideConnected,!1),this.m_userData=n(t.userData,null)}var i=t.prototype;return i.GetType=function(){return this.m_type},i.GetBodyA=function(){return this.m_bodyA},i.GetBodyB=function(){return this.m_bodyB},i.GetNext=function(){return this.m_next},i.GetUserData=function(){return this.m_userData},i.SetUserData=function(e){this.m_userData=e},i.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},i.GetCollideConnected=function(){return this.m_collideConnected},i.Dump=function(e){e("// Dump is not supported for this joint type.\n")},i.ShiftOrigin=function(){},t}(),Ti=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_distanceJoint)||this).localAnchorA=new be,n.localAnchorB=new be,n.length=1,n.frequencyHz=0,n.dampingRatio=0,n}return Z(n,t),n.prototype.Initialize=function(e,t,n,i){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.length=be.DistanceVV(n,i),this.frequencyHz=0,this.dampingRatio=0},n}(Ai),Ei=function(e){function t(t){var i;return(i=e.call(this,t)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_bias=0,i.m_localAnchorA=new be,i.m_localAnchorB=new be,i.m_gamma=0,i.m_impulse=0,i.m_length=0,i.m_indexA=0,i.m_indexB=0,i.m_u=new be,i.m_rA=new be,i.m_rB=new be,i.m_localCenterA=new be,i.m_localCenterB=new be,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=0,i.m_qA=new Pe,i.m_qB=new Pe,i.m_lalcA=new be,i.m_lalcB=new be,i.m_frequencyHz=n(t.frequencyHz,0),i.m_dampingRatio=n(t.dampingRatio,0),i.m_localAnchorA.Copy(t.localAnchorA),i.m_localAnchorB.Copy(t.localAnchorB),i.m_length=t.length,i}Z(t,e);var i=t.prototype;return i.GetAnchorA=function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)},i.GetAnchorB=function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)},i.GetReactionForce=function(e,t){return t.x=e*this.m_impulse*this.m_u.x,t.y=e*this.m_impulse*this.m_u.y,t},i.GetReactionTorque=function(){return 0},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.SetLength=function(e){this.m_length=e},i.Length=function(){return this.m_length},i.SetFrequency=function(e){this.m_frequencyHz=e},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(e){this.m_dampingRatio=e},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(e){var t=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;e("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",n),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.length = %.15f;\n",this.m_length),e("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),e("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,s=e.positions[this.m_indexB].c,c=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v,u=e.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(i),f=this.m_qB.SetAngle(c);be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Pe.MulRV(_,this.m_lalcA,this.m_rA),be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Pe.MulRV(f,this.m_lalcB,this.m_rB),this.m_u.x=s.x+this.m_rB.x-n.x-this.m_rA.x,this.m_u.y=s.y+this.m_rB.y-n.y-this.m_rA.y;var d=this.m_u.Length();d>h?this.m_u.SelfMul(1/d):this.m_u.SetZero();var p=be.CrossVV(this.m_rA,this.m_u),m=be.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*p*p+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,this.m_frequencyHz>0){var g=d-this.m_length,y=2*a*this.m_frequencyHz,x=2*this.m_mass*this.m_dampingRatio*y,S=this.m_mass*y*y,C=e.step.dt;this.m_gamma=C*(x+C*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=g*C*S*this.m_gamma,v+=this.m_gamma,this.m_mass=0!==v?1/v:0}else this.m_gamma=0,this.m_bias=0;if(e.step.warmStarting){this.m_impulse*=e.step.dtRatio;var A=be.MulSV(this.m_impulse,this.m_u,t.InitVelocityConstraints_s_P);r.SelfMulSub(this.m_invMassA,A),o-=this.m_invIA*be.CrossVV(this.m_rA,A),l.SelfMulAdd(this.m_invMassB,A),u+=this.m_invIB*be.CrossVV(this.m_rB,A)}else this.m_impulse=0;e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=u},i.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,r=e.velocities[this.m_indexB].v,o=e.velocities[this.m_indexB].w,a=be.AddVCrossSV(n,i,this.m_rA,t.SolveVelocityConstraints_s_vpA),s=be.AddVCrossSV(r,o,this.m_rB,t.SolveVelocityConstraints_s_vpB),c=be.DotVV(this.m_u,be.SubVV(s,a,be.s_t0)),l=-this.m_mass*(c+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=l;var u=be.MulSV(l,this.m_u,t.SolveVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,u),i-=this.m_invIA*be.CrossVV(this.m_rA,u),r.SelfMulAdd(this.m_invMassB,u),o+=this.m_invIB*be.CrossVV(this.m_rB,u),e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(e){if(this.m_frequencyHz>0)return!0;var n=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,r=e.positions[this.m_indexB].c,o=e.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o),c=Pe.MulRV(a,this.m_lalcA,this.m_rA),l=Pe.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_u;u.x=r.x+l.x-n.x-c.x,u.y=r.y+l.y-n.y-c.y;var _=this.m_u.Normalize()-this.m_length;_=oe(_,-v,v);var f=-this.m_mass*_,d=be.MulSV(f,u,t.SolvePositionConstraints_s_P);return n.SelfMulSub(this.m_invMassA,d),i-=this.m_invIA*be.CrossVV(c,d),r.SelfMulAdd(this.m_invMassB,d),o+=this.m_invIB*be.CrossVV(l,d),e.positions[this.m_indexA].a=i,e.positions[this.m_indexB].a=o,te(_)<h},t}(bi);Ei.InitVelocityConstraints_s_P=new be,Ei.SolveVelocityConstraints_s_vpA=new be,Ei.SolveVelocityConstraints_s_vpB=new be,Ei.SolveVelocityConstraints_s_P=new be,Ei.SolvePositionConstraints_s_P=new be;var wi=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_areaJoint)||this).bodies=[],n.frequencyHz=0,n.dampingRatio=0,n}return Z(n,t),n.prototype.AddBody=function(e){this.bodies.push(e),1===this.bodies.length?this.bodyA=e:2===this.bodies.length&&(this.bodyB=e)},n}(Ai),Ii=function(e){function t(t){var i;(i=e.call(this,t)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_impulse=0,i.m_targetArea=0,i.m_delta=new be,i.m_bodies=t.bodies,i.m_frequencyHz=n(t.frequencyHz,0),i.m_dampingRatio=n(t.dampingRatio,0),i.m_targetLengths=K(t.bodies.length),i.m_normals=be.MakeArray(t.bodies.length),i.m_joints=[],i.m_deltas=be.MakeArray(t.bodies.length);var r=new Ti;r.frequencyHz=i.m_frequencyHz,r.dampingRatio=i.m_dampingRatio,i.m_targetArea=0;for(var o=0;o<i.m_bodies.length;++o){var a=i.m_bodies[o],s=i.m_bodies[(o+1)%i.m_bodies.length],c=a.GetWorldCenter(),l=s.GetWorldCenter();i.m_targetLengths[o]=be.DistanceVV(c,l),i.m_targetArea+=be.CrossVV(c,l),r.Initialize(a,s,c,l),i.m_joints[o]=a.GetWorld().CreateJoint(r)}return i.m_targetArea*=.5,i}Z(t,e);var i=t.prototype;return i.GetAnchorA=function(e){return e},i.GetAnchorB=function(e){return e},i.GetReactionForce=function(e,t){return t},i.GetReactionTorque=function(){return 0},i.SetFrequency=function(e){this.m_frequencyHz=e;for(var t=0;t<this.m_joints.length;++t)this.m_joints[t].SetFrequency(e)},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(e){this.m_dampingRatio=e;for(var t=0;t<this.m_joints.length;++t)this.m_joints[t].SetDampingRatio(e)},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(e){e("Area joint dumping is not supported.\n")},i.InitVelocityConstraints=function(e){for(var t=0;t<this.m_bodies.length;++t){var n=this.m_bodies[(t+this.m_bodies.length-1)%this.m_bodies.length],i=this.m_bodies[(t+1)%this.m_bodies.length],r=e.positions[n.m_islandIndex].c,o=e.positions[i.m_islandIndex].c,a=this.m_deltas[t];be.SubVV(o,r,a)}if(e.step.warmStarting){this.m_impulse*=e.step.dtRatio;for(var s=0;s<this.m_bodies.length;++s){var c=this.m_bodies[s],l=e.velocities[c.m_islandIndex].v,u=this.m_deltas[s];l.x+=c.m_invMass*u.y*.5*this.m_impulse,l.y+=c.m_invMass*-u.x*.5*this.m_impulse}}else this.m_impulse=0},i.SolveVelocityConstraints=function(e){for(var t=0,n=0,i=0;i<this.m_bodies.length;++i){var r=this.m_bodies[i],o=e.velocities[r.m_islandIndex].v,a=this.m_deltas[i];t+=a.LengthSquared()/r.GetMass(),n+=be.CrossVV(o,a)}var s=-2*n/t;this.m_impulse+=s;for(var c=0;c<this.m_bodies.length;++c){var l=this.m_bodies[c],u=e.velocities[l.m_islandIndex].v,h=this.m_deltas[c];u.x+=l.m_invMass*h.y*.5*s,u.y+=l.m_invMass*-h.x*.5*s}},i.SolvePositionConstraints=function(e){for(var t=0,n=0,i=0;i<this.m_bodies.length;++i){var o=this.m_bodies[i],a=this.m_bodies[(i+1)%this.m_bodies.length],s=e.positions[o.m_islandIndex].c,c=e.positions[a.m_islandIndex].c,l=be.SubVV(c,s,this.m_delta),u=l.Length();u<r&&(u=1),this.m_normals[i].x=l.y/u,this.m_normals[i].y=-l.x/u,t+=u,n+=be.CrossVV(s,c)}n*=.5;for(var _=.5*(this.m_targetArea-n)/t,f=!0,d=0;d<this.m_bodies.length;++d){var p=this.m_bodies[d],m=e.positions[p.m_islandIndex].c,g=(d+1)%this.m_bodies.length,y=be.AddVV(this.m_normals[d],this.m_normals[g],this.m_delta);y.SelfMul(_);var x=y.LengthSquared();x>le(v)&&y.SelfMul(v/he(x)),x>le(h)&&(f=!1),m.x+=y.x,m.y+=y.y}return f},t}(bi),Pi=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_frictionJoint)||this).localAnchorA=new be,n.localAnchorB=new be,n.maxForce=0,n.maxTorque=0,n}return Z(n,t),n.prototype.Initialize=function(e,t,n){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB)},n}(Ai),Ri=function(e){function t(t){var i;return(i=e.call(this,t)||this).m_localAnchorA=new be,i.m_localAnchorB=new be,i.m_linearImpulse=new be,i.m_angularImpulse=0,i.m_maxForce=0,i.m_maxTorque=0,i.m_indexA=0,i.m_indexB=0,i.m_rA=new be,i.m_rB=new be,i.m_localCenterA=new be,i.m_localCenterB=new be,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_linearMass=new we,i.m_angularMass=0,i.m_qA=new Pe,i.m_qB=new Pe,i.m_lalcA=new be,i.m_lalcB=new be,i.m_K=new we,i.m_localAnchorA.Copy(t.localAnchorA),i.m_localAnchorB.Copy(t.localAnchorB),i.m_linearImpulse.SetZero(),i.m_maxForce=n(t.maxForce,0),i.m_maxTorque=n(t.maxTorque,0),i.m_linearMass.SetZero(),i}Z(t,e);var i=t.prototype;return i.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var t=e.positions[this.m_indexA].a,n=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,r=e.positions[this.m_indexB].a,o=e.velocities[this.m_indexB].v,a=e.velocities[this.m_indexB].w,s=this.m_qA.SetAngle(t),c=this.m_qB.SetAngle(r);be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var l=Pe.MulRV(s,this.m_lalcA,this.m_rA);be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var u=Pe.MulRV(c,this.m_lalcB,this.m_rB),h=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,d=this.m_invIB,p=this.m_K;if(p.ex.x=h+_+f*l.y*l.y+d*u.y*u.y,p.ex.y=-f*l.x*l.y-d*u.x*u.y,p.ey.x=p.ex.y,p.ey.y=h+_+f*l.x*l.x+d*u.x*u.x,p.GetInverse(this.m_linearMass),this.m_angularMass=f+d,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),e.step.warmStarting){this.m_linearImpulse.SelfMul(e.step.dtRatio),this.m_angularImpulse*=e.step.dtRatio;var m=this.m_linearImpulse;n.SelfMulSub(h,m),i-=f*(be.CrossVV(this.m_rA,m)+this.m_angularImpulse),o.SelfMulAdd(_,m),a+=d*(be.CrossVV(this.m_rB,m)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=a},i.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,r=e.velocities[this.m_indexB].v,o=e.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,u=e.step.dt,h=o-i,_=-this.m_angularMass*h,f=this.m_angularImpulse,d=u*this.m_maxTorque;this.m_angularImpulse=oe(this.m_angularImpulse+_,-d,d),i-=c*(_=this.m_angularImpulse-f),o+=l*_;var p=be.SubVV(be.AddVCrossSV(r,o,this.m_rB,be.s_t0),be.AddVCrossSV(n,i,this.m_rA,be.s_t1),t.SolveVelocityConstraints_s_Cdot_v2),m=we.MulMV(this.m_linearMass,p,t.SolveVelocityConstraints_s_impulseV).SelfNeg(),v=t.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(m);var g=u*this.m_maxForce;this.m_linearImpulse.LengthSquared()>g*g&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(g)),be.SubVV(this.m_linearImpulse,v,m),n.SelfMulSub(a,m),i-=c*be.CrossVV(this.m_rA,m),r.SelfMulAdd(s,m),o+=l*be.CrossVV(this.m_rB,m),e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(){return!0},i.GetAnchorA=function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)},i.GetAnchorB=function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)},i.GetReactionForce=function(e,t){return t.x=e*this.m_linearImpulse.x,t.y=e*this.m_linearImpulse.y,t},i.GetReactionTorque=function(e){return e*this.m_angularImpulse},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.SetMaxForce=function(e){this.m_maxForce=e},i.GetMaxForce=function(){return this.m_maxForce},i.SetMaxTorque=function(e){this.m_maxTorque=e},i.GetMaxTorque=function(){return this.m_maxTorque},i.Dump=function(e){var t=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;e("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",n),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.maxForce = %.15f;\n",this.m_maxForce),e("  jd.maxTorque = %.15f;\n",this.m_maxTorque),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},t}(bi);Ri.SolveVelocityConstraints_s_Cdot_v2=new be,Ri.SolveVelocityConstraints_s_impulseV=new be,Ri.SolveVelocityConstraints_s_oldImpulseV=new be;var Di=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_gearJoint)||this).ratio=1,n}return Z(n,t),n}(Ai),Oi=function(t){function i(i){var r,o,a;(r=t.call(this,i)||this).m_typeA=e.b2JointType.e_unknownJoint,r.m_typeB=e.b2JointType.e_unknownJoint,r.m_localAnchorA=new be,r.m_localAnchorB=new be,r.m_localAnchorC=new be,r.m_localAnchorD=new be,r.m_localAxisC=new be,r.m_localAxisD=new be,r.m_referenceAngleA=0,r.m_referenceAngleB=0,r.m_constant=0,r.m_ratio=0,r.m_impulse=0,r.m_indexA=0,r.m_indexB=0,r.m_indexC=0,r.m_indexD=0,r.m_lcA=new be,r.m_lcB=new be,r.m_lcC=new be,r.m_lcD=new be,r.m_mA=0,r.m_mB=0,r.m_mC=0,r.m_mD=0,r.m_iA=0,r.m_iB=0,r.m_iC=0,r.m_iD=0,r.m_JvAC=new be,r.m_JvBD=new be,r.m_JwA=0,r.m_JwB=0,r.m_JwC=0,r.m_JwD=0,r.m_mass=0,r.m_qA=new Pe,r.m_qB=new Pe,r.m_qC=new Pe,r.m_qD=new Pe,r.m_lalcA=new be,r.m_lalcB=new be,r.m_lalcC=new be,r.m_lalcD=new be,r.m_joint1=i.joint1,r.m_joint2=i.joint2,r.m_typeA=r.m_joint1.GetType(),r.m_typeB=r.m_joint2.GetType(),r.m_bodyC=r.m_joint1.GetBodyA(),r.m_bodyA=r.m_joint1.GetBodyB();var s=r.m_bodyA.m_xf,c=r.m_bodyA.m_sweep.a,l=r.m_bodyC.m_xf,u=r.m_bodyC.m_sweep.a;if(r.m_typeA===e.b2JointType.e_revoluteJoint){var h=i.joint1;r.m_localAnchorC.Copy(h.m_localAnchorA),r.m_localAnchorA.Copy(h.m_localAnchorB),r.m_referenceAngleA=h.m_referenceAngle,r.m_localAxisC.SetZero(),o=c-u-r.m_referenceAngleA}else{var _=i.joint1;r.m_localAnchorC.Copy(_.m_localAnchorA),r.m_localAnchorA.Copy(_.m_localAnchorB),r.m_referenceAngleA=_.m_referenceAngle,r.m_localAxisC.Copy(_.m_localXAxisA);var f=r.m_localAnchorC,d=Pe.MulTRV(l.q,be.AddVV(Pe.MulRV(s.q,r.m_localAnchorA,be.s_t0),be.SubVV(s.p,l.p,be.s_t1),be.s_t0),be.s_t0);o=be.DotVV(be.SubVV(d,f,be.s_t0),r.m_localAxisC)}r.m_bodyD=r.m_joint2.GetBodyA(),r.m_bodyB=r.m_joint2.GetBodyB();var p=r.m_bodyB.m_xf,m=r.m_bodyB.m_sweep.a,v=r.m_bodyD.m_xf,g=r.m_bodyD.m_sweep.a;if(r.m_typeB===e.b2JointType.e_revoluteJoint){var y=i.joint2;r.m_localAnchorD.Copy(y.m_localAnchorA),r.m_localAnchorB.Copy(y.m_localAnchorB),r.m_referenceAngleB=y.m_referenceAngle,r.m_localAxisD.SetZero(),a=m-g-r.m_referenceAngleB}else{var x=i.joint2;r.m_localAnchorD.Copy(x.m_localAnchorA),r.m_localAnchorB.Copy(x.m_localAnchorB),r.m_referenceAngleB=x.m_referenceAngle,r.m_localAxisD.Copy(x.m_localXAxisA);var S=r.m_localAnchorD,C=Pe.MulTRV(v.q,be.AddVV(Pe.MulRV(p.q,r.m_localAnchorB,be.s_t0),be.SubVV(p.p,v.p,be.s_t1),be.s_t0),be.s_t0);a=be.DotVV(be.SubVV(C,S,be.s_t0),r.m_localAxisD)}return r.m_ratio=n(i.ratio,1),r.m_constant=o+r.m_ratio*a,r.m_impulse=0,r}Z(i,t);var r=i.prototype;return r.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;var n=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,a=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,c=t.velocities[this.m_indexB].w,l=t.positions[this.m_indexC].a,u=t.velocities[this.m_indexC].v,h=t.velocities[this.m_indexC].w,_=t.positions[this.m_indexD].a,f=t.velocities[this.m_indexD].v,d=t.velocities[this.m_indexD].w,p=this.m_qA.SetAngle(n),m=this.m_qB.SetAngle(a),v=this.m_qC.SetAngle(l),g=this.m_qD.SetAngle(_);if(this.m_mass=0,this.m_typeA===e.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{var y=Pe.MulRV(v,this.m_localAxisC,i.InitVelocityConstraints_s_u);be.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);var x=Pe.MulRV(v,this.m_lalcC,i.InitVelocityConstraints_s_rC);be.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);var S=Pe.MulRV(p,this.m_lalcA,i.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(y),this.m_JwC=be.CrossVV(x,y),this.m_JwA=be.CrossVV(S,y),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===e.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{var C=Pe.MulRV(g,this.m_localAxisD,i.InitVelocityConstraints_s_u);be.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);var A=Pe.MulRV(g,this.m_lalcD,i.InitVelocityConstraints_s_rD);be.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);var b=Pe.MulRV(m,this.m_lalcB,i.InitVelocityConstraints_s_rB);be.MulSV(this.m_ratio,C,this.m_JvBD),this.m_JwD=this.m_ratio*be.CrossVV(A,C),this.m_JwB=this.m_ratio*be.CrossVV(b,C),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,t.step.warmStarting?(r.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),o+=this.m_iA*this.m_impulse*this.m_JwA,s.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),c+=this.m_iB*this.m_impulse*this.m_JwB,u.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),h-=this.m_iC*this.m_impulse*this.m_JwC,f.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),d-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=c,t.velocities[this.m_indexC].w=h,t.velocities[this.m_indexD].w=d},r.SolveVelocityConstraints=function(e){var t=e.velocities[this.m_indexA].v,n=e.velocities[this.m_indexA].w,i=e.velocities[this.m_indexB].v,r=e.velocities[this.m_indexB].w,o=e.velocities[this.m_indexC].v,a=e.velocities[this.m_indexC].w,s=e.velocities[this.m_indexD].v,c=e.velocities[this.m_indexD].w,l=be.DotVV(this.m_JvAC,be.SubVV(t,o,be.s_t0))+be.DotVV(this.m_JvBD,be.SubVV(i,s,be.s_t0));l+=this.m_JwA*n-this.m_JwC*a+(this.m_JwB*r-this.m_JwD*c);var u=-this.m_mass*l;this.m_impulse+=u,t.SelfMulAdd(this.m_mA*u,this.m_JvAC),n+=this.m_iA*u*this.m_JwA,i.SelfMulAdd(this.m_mB*u,this.m_JvBD),r+=this.m_iB*u*this.m_JwB,o.SelfMulSub(this.m_mC*u,this.m_JvAC),a-=this.m_iC*u*this.m_JwC,s.SelfMulSub(this.m_mD*u,this.m_JvBD),c-=this.m_iD*u*this.m_JwD,e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=r,e.velocities[this.m_indexC].w=a,e.velocities[this.m_indexD].w=c},r.SolvePositionConstraints=function(t){var n,r,o,a,s,c,l=t.positions[this.m_indexA].c,u=t.positions[this.m_indexA].a,_=t.positions[this.m_indexB].c,f=t.positions[this.m_indexB].a,d=t.positions[this.m_indexC].c,p=t.positions[this.m_indexC].a,m=t.positions[this.m_indexD].c,v=t.positions[this.m_indexD].a,g=this.m_qA.SetAngle(u),y=this.m_qB.SetAngle(f),x=this.m_qC.SetAngle(p),S=this.m_qD.SetAngle(v),C=0,A=this.m_JvAC,b=this.m_JvBD,T=0;if(this.m_typeA===e.b2JointType.e_revoluteJoint)A.SetZero(),o=1,s=1,T+=this.m_iA+this.m_iC,n=u-p-this.m_referenceAngleA;else{var E=Pe.MulRV(x,this.m_localAxisC,i.SolvePositionConstraints_s_u),w=Pe.MulRV(x,this.m_lalcC,i.SolvePositionConstraints_s_rC),I=Pe.MulRV(g,this.m_lalcA,i.SolvePositionConstraints_s_rA);A.Copy(E),s=be.CrossVV(w,E),o=be.CrossVV(I,E),T+=this.m_mC+this.m_mA+this.m_iC*s*s+this.m_iA*o*o;var P=this.m_lalcC,R=Pe.MulTRV(x,be.AddVV(I,be.SubVV(l,d,be.s_t0),be.s_t0),be.s_t0);n=be.DotVV(be.SubVV(R,P,be.s_t0),this.m_localAxisC)}if(this.m_typeB===e.b2JointType.e_revoluteJoint)b.SetZero(),a=this.m_ratio,c=this.m_ratio,T+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),r=f-v-this.m_referenceAngleB;else{var D=Pe.MulRV(S,this.m_localAxisD,i.SolvePositionConstraints_s_u),O=Pe.MulRV(S,this.m_lalcD,i.SolvePositionConstraints_s_rD),N=Pe.MulRV(y,this.m_lalcB,i.SolvePositionConstraints_s_rB);be.MulSV(this.m_ratio,D,b),c=this.m_ratio*be.CrossVV(O,D),a=this.m_ratio*be.CrossVV(N,D),T+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*c*c+this.m_iB*a*a;var B=this.m_lalcD,M=Pe.MulTRV(S,be.AddVV(N,be.SubVV(_,m,be.s_t0),be.s_t0),be.s_t0);r=be.DotVV(be.SubVV(M,B,be.s_t0),this.m_localAxisD)}var L=n+this.m_ratio*r-this.m_constant,F=0;return T>0&&(F=-L/T),l.SelfMulAdd(this.m_mA*F,A),u+=this.m_iA*F*o,_.SelfMulAdd(this.m_mB*F,b),f+=this.m_iB*F*a,d.SelfMulSub(this.m_mC*F,A),p-=this.m_iC*F*s,m.SelfMulSub(this.m_mD*F,b),v-=this.m_iD*F*c,t.positions[this.m_indexA].a=u,t.positions[this.m_indexB].a=f,t.positions[this.m_indexC].a=p,t.positions[this.m_indexD].a=v,C<h},r.GetAnchorA=function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)},r.GetAnchorB=function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)},r.GetReactionForce=function(e,t){return be.MulSV(e*this.m_impulse,this.m_JvAC,t)},r.GetReactionTorque=function(e){return e*this.m_impulse*this.m_JwA},r.GetJoint1=function(){return this.m_joint1},r.GetJoint2=function(){return this.m_joint2},r.GetRatio=function(){return this.m_ratio},r.SetRatio=function(e){this.m_ratio=e},r.Dump=function(e){var t=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex,i=this.m_joint1.m_index,r=this.m_joint2.m_index;e("  const jd: b2GearJointDef = new b2GearJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",n),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.joint1 = joints[%d];\n",i),e("  jd.joint2 = joints[%d];\n",r),e("  jd.ratio = %.15f;\n",this.m_ratio),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Oi.InitVelocityConstraints_s_u=new be,Oi.InitVelocityConstraints_s_rA=new be,Oi.InitVelocityConstraints_s_rB=new be,Oi.InitVelocityConstraints_s_rC=new be,Oi.InitVelocityConstraints_s_rD=new be,Oi.SolvePositionConstraints_s_u=new be,Oi.SolvePositionConstraints_s_rA=new be,Oi.SolvePositionConstraints_s_rB=new be,Oi.SolvePositionConstraints_s_rC=new be,Oi.SolvePositionConstraints_s_rD=new be;var Ni=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_motorJoint)||this).linearOffset=new be(0,0),n.angularOffset=0,n.maxForce=1,n.maxTorque=1,n.correctionFactor=.3,n}return Z(n,t),n.prototype.Initialize=function(e,t){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);var n=this.bodyA.GetAngle(),i=this.bodyB.GetAngle();this.angularOffset=i-n},n}(Ai),Bi=function(e){function t(t){var i;return(i=e.call(this,t)||this).m_linearOffset=new be,i.m_angularOffset=0,i.m_linearImpulse=new be,i.m_angularImpulse=0,i.m_maxForce=0,i.m_maxTorque=0,i.m_correctionFactor=.3,i.m_indexA=0,i.m_indexB=0,i.m_rA=new be,i.m_rB=new be,i.m_localCenterA=new be,i.m_localCenterB=new be,i.m_linearError=new be,i.m_angularError=0,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_linearMass=new we,i.m_angularMass=0,i.m_qA=new Pe,i.m_qB=new Pe,i.m_K=new we,i.m_linearOffset.Copy(n(t.linearOffset,be.ZERO)),i.m_linearImpulse.SetZero(),i.m_maxForce=n(t.maxForce,0),i.m_maxTorque=n(t.maxTorque,0),i.m_correctionFactor=n(t.correctionFactor,.3),i}Z(t,e);var i=t.prototype;return i.GetAnchorA=function(e){var t=this.m_bodyA.GetPosition();return e.x=t.x,e.y=t.y,e},i.GetAnchorB=function(e){var t=this.m_bodyB.GetPosition();return e.x=t.x,e.y=t.y,e},i.GetReactionForce=function(e,t){return be.MulSV(e,this.m_linearImpulse,t)},i.GetReactionTorque=function(e){return e*this.m_angularImpulse},i.SetLinearOffset=function(e){be.IsEqualToV(e,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(e))},i.GetLinearOffset=function(){return this.m_linearOffset},i.SetAngularOffset=function(e){e!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=e)},i.GetAngularOffset=function(){return this.m_angularOffset},i.SetMaxForce=function(e){this.m_maxForce=e},i.GetMaxForce=function(){return this.m_maxForce},i.SetMaxTorque=function(e){this.m_maxTorque=e},i.GetMaxTorque=function(){return this.m_maxTorque},i.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var t=e.positions[this.m_indexA].c,n=e.positions[this.m_indexA].a,i=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,o=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,s=e.velocities[this.m_indexB].v,c=e.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a),h=Pe.MulRV(l,be.SubVV(this.m_linearOffset,this.m_localCenterA,be.s_t0),this.m_rA),_=Pe.MulRV(u,be.NegV(this.m_localCenterB,be.s_t0),this.m_rB),f=this.m_invMassA,d=this.m_invMassB,p=this.m_invIA,m=this.m_invIB,v=this.m_K;if(v.ex.x=f+d+p*h.y*h.y+m*_.y*_.y,v.ex.y=-p*h.x*h.y-m*_.x*_.y,v.ey.x=v.ex.y,v.ey.y=f+d+p*h.x*h.x+m*_.x*_.x,v.GetInverse(this.m_linearMass),this.m_angularMass=p+m,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),be.SubVV(be.AddVV(o,_,be.s_t0),be.AddVV(t,h,be.s_t1),this.m_linearError),this.m_angularError=a-n-this.m_angularOffset,e.step.warmStarting){this.m_linearImpulse.SelfMul(e.step.dtRatio),this.m_angularImpulse*=e.step.dtRatio;var g=this.m_linearImpulse;i.SelfMulSub(f,g),r-=p*(be.CrossVV(h,g)+this.m_angularImpulse),s.SelfMulAdd(d,g),c+=m*(be.CrossVV(_,g)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=c},i.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,r=e.velocities[this.m_indexB].v,o=e.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB,u=e.step.dt,h=e.step.inv_dt,_=o-i+h*this.m_correctionFactor*this.m_angularError,f=-this.m_angularMass*_,d=this.m_angularImpulse,p=u*this.m_maxTorque;this.m_angularImpulse=oe(this.m_angularImpulse+f,-p,p),i-=c*(f=this.m_angularImpulse-d),o+=l*f;var m=this.m_rA,v=this.m_rB,g=be.AddVV(be.SubVV(be.AddVV(r,be.CrossSV(o,v,be.s_t0),be.s_t0),be.AddVV(n,be.CrossSV(i,m,be.s_t1),be.s_t1),be.s_t2),be.MulSV(h*this.m_correctionFactor,this.m_linearError,be.s_t3),t.SolveVelocityConstraints_s_Cdot_v2),y=we.MulMV(this.m_linearMass,g,t.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),x=t.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(y);var S=u*this.m_maxForce;this.m_linearImpulse.LengthSquared()>S*S&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(S)),be.SubVV(this.m_linearImpulse,x,y),n.SelfMulSub(a,y),i-=c*be.CrossVV(m,y),r.SelfMulAdd(s,y),o+=l*be.CrossVV(v,y),e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(){return!0},i.Dump=function(e){var t=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;e("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",n),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),e("  jd.angularOffset = %.15f;\n",this.m_angularOffset),e("  jd.maxForce = %.15f;\n",this.m_maxForce),e("  jd.maxTorque = %.15f;\n",this.m_maxTorque),e("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},t}(bi);Bi.SolveVelocityConstraints_s_Cdot_v2=new be,Bi.SolveVelocityConstraints_s_impulse_v2=new be,Bi.SolveVelocityConstraints_s_oldImpulse_v2=new be;var Mi=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_mouseJoint)||this).target=new be,n.maxForce=0,n.frequencyHz=5,n.dampingRatio=.7,n}return Z(n,t),n}(Ai),Li=function(e){function t(t){var i;return(i=e.call(this,t)||this).m_localAnchorB=new be,i.m_targetA=new be,i.m_frequencyHz=0,i.m_dampingRatio=0,i.m_beta=0,i.m_impulse=new be,i.m_maxForce=0,i.m_gamma=0,i.m_indexA=0,i.m_indexB=0,i.m_rB=new be,i.m_localCenterB=new be,i.m_invMassB=0,i.m_invIB=0,i.m_mass=new we,i.m_C=new be,i.m_qB=new Pe,i.m_lalcB=new be,i.m_K=new we,i.m_targetA.Copy(n(t.target,be.ZERO)),Re.MulTXV(i.m_bodyB.GetTransform(),i.m_targetA,i.m_localAnchorB),i.m_maxForce=n(t.maxForce,0),i.m_impulse.SetZero(),i.m_frequencyHz=n(t.frequencyHz,0),i.m_dampingRatio=n(t.dampingRatio,0),i.m_beta=0,i.m_gamma=0,i}Z(t,e);var i=t.prototype;return i.SetTarget=function(e){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(e)},i.GetTarget=function(){return this.m_targetA},i.SetMaxForce=function(e){this.m_maxForce=e},i.GetMaxForce=function(){return this.m_maxForce},i.SetFrequency=function(e){this.m_frequencyHz=e},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(e){this.m_dampingRatio=e},i.GetDampingRatio=function(){return this.m_dampingRatio},i.InitVelocityConstraints=function(e){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;var t=e.positions[this.m_indexB].c,n=e.positions[this.m_indexB].a,i=e.velocities[this.m_indexB].v,r=e.velocities[this.m_indexB].w,o=this.m_qB.SetAngle(n),s=this.m_bodyB.GetMass(),c=2*a*this.m_frequencyHz,l=2*s*this.m_dampingRatio*c,u=s*c*c,h=e.step.dt;this.m_gamma=h*(l+h*u),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=h*u*this.m_gamma,be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Pe.MulRV(o,this.m_lalcB,this.m_rB);var _=this.m_K;_.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,_.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,_.ey.x=_.ex.y,_.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,_.GetInverse(this.m_mass),this.m_C.x=t.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=t.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),r*=.98,e.step.warmStarting?(this.m_impulse.SelfMul(e.step.dtRatio),i.x+=this.m_invMassB*this.m_impulse.x,i.y+=this.m_invMassB*this.m_impulse.y,r+=this.m_invIB*be.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),e.velocities[this.m_indexB].w=r},i.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexB].v,i=e.velocities[this.m_indexB].w,r=be.AddVCrossSV(n,i,this.m_rB,t.SolveVelocityConstraints_s_Cdot),o=we.MulMV(this.m_mass,be.AddVV(r,be.AddVV(this.m_C,be.MulSV(this.m_gamma,this.m_impulse,be.s_t0),be.s_t0),be.s_t0).SelfNeg(),t.SolveVelocityConstraints_s_impulse),a=t.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(o);var s=e.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>s*s&&this.m_impulse.SelfMul(s/this.m_impulse.Length()),be.SubVV(this.m_impulse,a,o),n.SelfMulAdd(this.m_invMassB,o),i+=this.m_invIB*be.CrossVV(this.m_rB,o),e.velocities[this.m_indexB].w=i},i.SolvePositionConstraints=function(){return!0},i.GetAnchorA=function(e){return e.x=this.m_targetA.x,e.y=this.m_targetA.y,e},i.GetAnchorB=function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)},i.GetReactionForce=function(e,t){return be.MulSV(e,this.m_impulse,t)},i.GetReactionTorque=function(){return 0},i.Dump=function(e){e("Mouse joint dumping is not supported.\n")},i.ShiftOrigin=function(e){this.m_targetA.SelfSub(e)},t}(bi);Li.SolveVelocityConstraints_s_Cdot=new be,Li.SolveVelocityConstraints_s_impulse=new be,Li.SolveVelocityConstraints_s_oldImpulse=new be;var Fi=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_prismaticJoint)||this).localAnchorA=new be,n.localAnchorB=new be,n.localAxisA=new be(1,0),n.referenceAngle=0,n.enableLimit=!1,n.lowerTranslation=0,n.upperTranslation=0,n.enableMotor=!1,n.maxMotorForce=0,n.motorSpeed=0,n}return Z(n,t),n.prototype.Initialize=function(e,t,n,i){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.bodyA.GetLocalVector(i,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ai),zi=function(t){function i(i){var r;return(r=t.call(this,i)||this).m_localAnchorA=new be,r.m_localAnchorB=new be,r.m_localXAxisA=new be,r.m_localYAxisA=new be,r.m_referenceAngle=0,r.m_impulse=new Ee(0,0,0),r.m_motorImpulse=0,r.m_lowerTranslation=0,r.m_upperTranslation=0,r.m_maxMotorForce=0,r.m_motorSpeed=0,r.m_enableLimit=!1,r.m_enableMotor=!1,r.m_limitState=e.b2LimitState.e_inactiveLimit,r.m_indexA=0,r.m_indexB=0,r.m_localCenterA=new be,r.m_localCenterB=new be,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_axis=new be(0,0),r.m_perp=new be(0,0),r.m_s1=0,r.m_s2=0,r.m_a1=0,r.m_a2=0,r.m_K=new Ie,r.m_K3=new Ie,r.m_K2=new we,r.m_motorMass=0,r.m_qA=new Pe,r.m_qB=new Pe,r.m_lalcA=new be,r.m_lalcB=new be,r.m_rA=new be,r.m_rB=new be,r.m_localAnchorA.Copy(n(i.localAnchorA,be.ZERO)),r.m_localAnchorB.Copy(n(i.localAnchorB,be.ZERO)),r.m_localXAxisA.Copy(n(i.localAxisA,new be(1,0))).SelfNormalize(),be.CrossOneV(r.m_localXAxisA,r.m_localYAxisA),r.m_referenceAngle=n(i.referenceAngle,0),r.m_lowerTranslation=n(i.lowerTranslation,0),r.m_upperTranslation=n(i.upperTranslation,0),r.m_maxMotorForce=n(i.maxMotorForce,0),r.m_motorSpeed=n(i.motorSpeed,0),r.m_enableLimit=n(i.enableLimit,!1),r.m_enableMotor=n(i.enableMotor,!1),r}Z(i,t);var r=i.prototype;return r.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].c,r=t.positions[this.m_indexA].a,o=t.velocities[this.m_indexA].v,a=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].c,c=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v,u=t.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(r),f=this.m_qB.SetAngle(c);be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var d=Pe.MulRV(_,this.m_lalcA,this.m_rA);be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var p=Pe.MulRV(f,this.m_lalcB,this.m_rB),m=be.AddVV(be.SubVV(s,n,be.s_t0),be.SubVV(p,d,be.s_t1),i.InitVelocityConstraints_s_d),v=this.m_invMassA,g=this.m_invMassB,y=this.m_invIA,x=this.m_invIB;if(Pe.MulRV(_,this.m_localXAxisA,this.m_axis),this.m_a1=be.CrossVV(be.AddVV(m,d,be.s_t0),this.m_axis),this.m_a2=be.CrossVV(p,this.m_axis),this.m_motorMass=v+g+y*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),Pe.MulRV(_,this.m_localYAxisA,this.m_perp),this.m_s1=be.CrossVV(be.AddVV(m,d,be.s_t0),this.m_perp),this.m_s2=be.CrossVV(p,this.m_perp),this.m_K.ex.x=v+g+y*this.m_s1*this.m_s1+x*this.m_s2*this.m_s2,this.m_K.ex.y=y*this.m_s1+x*this.m_s2,this.m_K.ex.z=y*this.m_s1*this.m_a1+x*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=y+x,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=y*this.m_a1+x*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=v+g+y*this.m_a1*this.m_a1+x*this.m_a2*this.m_a2,this.m_enableLimit){var S=be.DotVV(this.m_axis,m);te(this.m_upperTranslation-this.m_lowerTranslation)<2*h?this.m_limitState=e.b2LimitState.e_equalLimits:S<=this.m_lowerTranslation?this.m_limitState!==e.b2LimitState.e_atLowerLimit&&(this.m_limitState=e.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):S>=this.m_upperTranslation?this.m_limitState!==e.b2LimitState.e_atUpperLimit&&(this.m_limitState=e.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=e.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=e.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;var C=be.AddVV(be.MulSV(this.m_impulse.x,this.m_perp,be.s_t0),be.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,be.s_t1),i.InitVelocityConstraints_s_P),A=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,b=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;o.SelfMulSub(v,C),a-=y*A,l.SelfMulAdd(g,C),u+=x*b}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=a,t.velocities[this.m_indexB].w=u},r.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,a=t.velocities[this.m_indexB].w,s=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,u=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==e.b2LimitState.e_equalLimits){var h=be.DotVV(this.m_axis,be.SubVV(o,n,be.s_t0))+this.m_a2*a-this.m_a1*r,_=this.m_motorMass*(this.m_motorSpeed-h),f=this.m_motorImpulse,d=t.step.dt*this.m_maxMotorForce;this.m_motorImpulse=oe(this.m_motorImpulse+_,-d,d),_=this.m_motorImpulse-f;var p=be.MulSV(_,this.m_axis,i.SolveVelocityConstraints_s_P),m=_*this.m_a1,v=_*this.m_a2;n.SelfMulSub(s,p),r-=l*m,o.SelfMulAdd(c,p),a+=u*v}var g=be.DotVV(this.m_perp,be.SubVV(o,n,be.s_t0))+this.m_s2*a-this.m_s1*r,y=a-r;if(this.m_enableLimit&&this.m_limitState!==e.b2LimitState.e_inactiveLimit){var x=be.DotVV(this.m_axis,be.SubVV(o,n,be.s_t0))+this.m_a2*a-this.m_a1*r,S=i.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),C=this.m_K.Solve33(-g,-y,-x,i.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(C),this.m_limitState===e.b2LimitState.e_atLowerLimit?this.m_impulse.z=re(this.m_impulse.z,0):this.m_limitState===e.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=ie(this.m_impulse.z,0));var A=-g-(this.m_impulse.z-S.z)*this.m_K.ez.x,b=-y-(this.m_impulse.z-S.z)*this.m_K.ez.y,T=this.m_K.Solve22(A,b,i.SolveVelocityConstraints_s_f2r);T.x+=S.x,T.y+=S.y,this.m_impulse.x=T.x,this.m_impulse.y=T.y,C.x=this.m_impulse.x-S.x,C.y=this.m_impulse.y-S.y,C.z=this.m_impulse.z-S.z;var E=be.AddVV(be.MulSV(C.x,this.m_perp,be.s_t0),be.MulSV(C.z,this.m_axis,be.s_t1),i.SolveVelocityConstraints_s_P),w=C.x*this.m_s1+C.y+C.z*this.m_a1,I=C.x*this.m_s2+C.y+C.z*this.m_a2;n.SelfMulSub(s,E),r-=l*w,o.SelfMulAdd(c,E),a+=u*I}else{var P=this.m_K.Solve22(-g,-y,i.SolveVelocityConstraints_s_df2);this.m_impulse.x+=P.x,this.m_impulse.y+=P.y;var R=be.MulSV(P.x,this.m_perp,i.SolveVelocityConstraints_s_P),D=P.x*this.m_s1+P.y,O=P.x*this.m_s2+P.y;n.SelfMulSub(s,R),r-=l*D,o.SelfMulAdd(c,R),a+=u*O}t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=a},r.SolvePositionConstraints=function(e){var t=e.positions[this.m_indexA].c,n=e.positions[this.m_indexA].a,r=e.positions[this.m_indexB].c,o=e.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o),c=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,f=this.m_invIB,d=Pe.MulRV(a,this.m_lalcA,this.m_rA),p=Pe.MulRV(s,this.m_lalcB,this.m_rB),m=be.SubVV(be.AddVV(r,p,be.s_t0),be.AddVV(t,d,be.s_t1),i.SolvePositionConstraints_s_d),g=Pe.MulRV(a,this.m_localXAxisA,this.m_axis),y=be.CrossVV(be.AddVV(m,d,be.s_t0),g),x=be.CrossVV(p,g),S=Pe.MulRV(a,this.m_localYAxisA,this.m_perp),C=be.CrossVV(be.AddVV(m,d,be.s_t0),S),A=be.CrossVV(p,S),b=i.SolvePositionConstraints_s_impulse,T=be.DotVV(S,m),E=o-n-this.m_referenceAngle,w=te(T),I=te(E),P=!1,R=0;if(this.m_enableLimit){var D=be.DotVV(g,m);te(this.m_upperTranslation-this.m_lowerTranslation)<2*h?(R=oe(D,-v,v),w=re(w,te(D)),P=!0):D<=this.m_lowerTranslation?(R=oe(D-this.m_lowerTranslation+h,-v,0),w=re(w,this.m_lowerTranslation-D),P=!0):D>=this.m_upperTranslation&&(R=oe(D-this.m_upperTranslation-h,0,v),w=re(w,D-this.m_upperTranslation),P=!0)}if(P){var O=c+l+u*C*C+f*A*A,N=u*C+f*A,B=u*C*y+f*A*x,M=u+f;0===M&&(M=1);var L=u*y+f*x,F=c+l+u*y*y+f*x*x,z=this.m_K3;z.ex.SetXYZ(O,N,B),z.ey.SetXYZ(N,M,L),z.ez.SetXYZ(B,L,F),b=z.Solve33(-T,-E,-R,b)}else{var V=c+l+u*C*C+f*A*A,G=u*C+f*A,U=u+f;0===U&&(U=1);var k=this.m_K2;k.ex.Set(V,G),k.ey.Set(G,U);var H=k.Solve(-T,-E,i.SolvePositionConstraints_s_impulse1);b.x=H.x,b.y=H.y,b.z=0}var j=be.AddVV(be.MulSV(b.x,S,be.s_t0),be.MulSV(b.z,g,be.s_t1),i.SolvePositionConstraints_s_P),W=b.x*C+b.y+b.z*y,q=b.x*A+b.y+b.z*x;return t.SelfMulSub(c,j),n-=u*W,r.SelfMulAdd(l,j),o+=f*q,e.positions[this.m_indexA].a=n,e.positions[this.m_indexB].a=o,w<=h&&I<=_},r.GetAnchorA=function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)},r.GetAnchorB=function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)},r.GetReactionForce=function(e,t){return t.x=e*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),t.y=e*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),t},r.GetReactionTorque=function(e){return e*this.m_impulse.y},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.GetLocalAxisA=function(){return this.m_localXAxisA},r.GetReferenceAngle=function(){return this.m_referenceAngle},r.GetJointTranslation=function(){var e=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,i.GetJointTranslation_s_pA),t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,i.GetJointTranslation_s_pB),n=be.SubVV(t,e,i.GetJointTranslation_s_d),r=this.m_bodyA.GetWorldVector(this.m_localXAxisA,i.GetJointTranslation_s_axis);return be.DotVV(n,r)},r.GetJointSpeed=function(){var e=this.m_bodyA,t=this.m_bodyB;be.SubVV(this.m_localAnchorA,e.m_sweep.localCenter,this.m_lalcA);var n=Pe.MulRV(e.m_xf.q,this.m_lalcA,this.m_rA);be.SubVV(this.m_localAnchorB,t.m_sweep.localCenter,this.m_lalcB);var i=Pe.MulRV(t.m_xf.q,this.m_lalcB,this.m_rB),r=be.AddVV(e.m_sweep.c,n,be.s_t0),o=be.AddVV(t.m_sweep.c,i,be.s_t1),a=be.SubVV(o,r,be.s_t2),s=e.GetWorldVector(this.m_localXAxisA,this.m_axis),c=e.m_linearVelocity,l=t.m_linearVelocity,u=e.m_angularVelocity,h=t.m_angularVelocity;return be.DotVV(a,be.CrossSV(u,s,be.s_t0))+be.DotVV(s,be.SubVV(be.AddVCrossSV(l,h,i,be.s_t0),be.AddVCrossSV(c,u,n,be.s_t1),be.s_t0))},r.IsLimitEnabled=function(){return this.m_enableLimit},r.EnableLimit=function(e){e!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=e,this.m_impulse.z=0)},r.GetLowerLimit=function(){return this.m_lowerTranslation},r.GetUpperLimit=function(){return this.m_upperTranslation},r.SetLimits=function(e,t){e===this.m_lowerTranslation&&t===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=e,this.m_upperTranslation=t,this.m_impulse.z=0)},r.IsMotorEnabled=function(){return this.m_enableMotor},r.EnableMotor=function(e){e!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=e)},r.SetMotorSpeed=function(e){e!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=e)},r.GetMotorSpeed=function(){return this.m_motorSpeed},r.SetMaxMotorForce=function(e){e!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=e)},r.GetMaxMotorForce=function(){return this.m_maxMotorForce},r.GetMotorForce=function(e){return e*this.m_motorImpulse},r.Dump=function(e){var t=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;e("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",n),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),e("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),e("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),e("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),e("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),e("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),e("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),e("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);zi.InitVelocityConstraints_s_d=new be,zi.InitVelocityConstraints_s_P=new be,zi.SolveVelocityConstraints_s_P=new be,zi.SolveVelocityConstraints_s_f2r=new be,zi.SolveVelocityConstraints_s_f1=new Ee,zi.SolveVelocityConstraints_s_df3=new Ee,zi.SolveVelocityConstraints_s_df2=new be,zi.SolvePositionConstraints_s_d=new be,zi.SolvePositionConstraints_s_impulse=new Ee,zi.SolvePositionConstraints_s_impulse1=new be,zi.SolvePositionConstraints_s_P=new be,zi.GetJointTranslation_s_pA=new be,zi.GetJointTranslation_s_pB=new be,zi.GetJointTranslation_s_d=new be,zi.GetJointTranslation_s_axis=new be;var Vi=2,Gi=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_pulleyJoint)||this).groundAnchorA=new be(-1,1),n.groundAnchorB=new be(1,1),n.localAnchorA=new be(-1,0),n.localAnchorB=new be(1,0),n.lengthA=0,n.lengthB=0,n.ratio=1,n.collideConnected=!0,n}return Z(n,t),n.prototype.Initialize=function(e,t,n,i,r,o,a){this.bodyA=e,this.bodyB=t,this.groundAnchorA.Copy(n),this.groundAnchorB.Copy(i),this.bodyA.GetLocalPoint(r,this.localAnchorA),this.bodyB.GetLocalPoint(o,this.localAnchorB),this.lengthA=be.DistanceVV(r,n),this.lengthB=be.DistanceVV(o,i),this.ratio=a},n}(Ai),Ui=function(e){function t(t){var i;return(i=e.call(this,t)||this).m_groundAnchorA=new be,i.m_groundAnchorB=new be,i.m_lengthA=0,i.m_lengthB=0,i.m_localAnchorA=new be,i.m_localAnchorB=new be,i.m_constant=0,i.m_ratio=0,i.m_impulse=0,i.m_indexA=0,i.m_indexB=0,i.m_uA=new be,i.m_uB=new be,i.m_rA=new be,i.m_rB=new be,i.m_localCenterA=new be,i.m_localCenterB=new be,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=0,i.m_qA=new Pe,i.m_qB=new Pe,i.m_lalcA=new be,i.m_lalcB=new be,i.m_groundAnchorA.Copy(n(t.groundAnchorA,new be(-1,1))),i.m_groundAnchorB.Copy(n(t.groundAnchorB,new be(1,0))),i.m_localAnchorA.Copy(n(t.localAnchorA,new be(-1,0))),i.m_localAnchorB.Copy(n(t.localAnchorB,new be(1,0))),i.m_lengthA=n(t.lengthA,0),i.m_lengthB=n(t.lengthB,0),i.m_ratio=n(t.ratio,1),i.m_constant=n(t.lengthA,0)+i.m_ratio*n(t.lengthB,0),i.m_impulse=0,i}Z(t,e);var i=t.prototype;return i.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,r=e.velocities[this.m_indexA].v,o=e.velocities[this.m_indexA].w,a=e.positions[this.m_indexB].c,s=e.positions[this.m_indexB].a,c=e.velocities[this.m_indexB].v,l=e.velocities[this.m_indexB].w,u=this.m_qA.SetAngle(i),_=this.m_qB.SetAngle(s);be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Pe.MulRV(u,this.m_lalcA,this.m_rA),be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Pe.MulRV(_,this.m_lalcB,this.m_rB),this.m_uA.Copy(n).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(a).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);var f=this.m_uA.Length(),d=this.m_uB.Length();f>10*h?this.m_uA.SelfMul(1/f):this.m_uA.SetZero(),d>10*h?this.m_uB.SelfMul(1/d):this.m_uB.SetZero();var p=be.CrossVV(this.m_rA,this.m_uA),m=be.CrossVV(this.m_rB,this.m_uB),v=this.m_invMassA+this.m_invIA*p*p,g=this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=v+this.m_ratio*this.m_ratio*g,this.m_mass>0&&(this.m_mass=1/this.m_mass),e.step.warmStarting){this.m_impulse*=e.step.dtRatio;var y=be.MulSV(-this.m_impulse,this.m_uA,t.InitVelocityConstraints_s_PA),x=be.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,t.InitVelocityConstraints_s_PB);r.SelfMulAdd(this.m_invMassA,y),o+=this.m_invIA*be.CrossVV(this.m_rA,y),c.SelfMulAdd(this.m_invMassB,x),l+=this.m_invIB*be.CrossVV(this.m_rB,x)}else this.m_impulse=0;e.velocities[this.m_indexA].w=o,e.velocities[this.m_indexB].w=l},i.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,r=e.velocities[this.m_indexB].v,o=e.velocities[this.m_indexB].w,a=be.AddVCrossSV(n,i,this.m_rA,t.SolveVelocityConstraints_s_vpA),s=be.AddVCrossSV(r,o,this.m_rB,t.SolveVelocityConstraints_s_vpB),c=-be.DotVV(this.m_uA,a)-this.m_ratio*be.DotVV(this.m_uB,s),l=-this.m_mass*c;this.m_impulse+=l;var u=be.MulSV(-l,this.m_uA,t.SolveVelocityConstraints_s_PA),h=be.MulSV(-this.m_ratio*l,this.m_uB,t.SolveVelocityConstraints_s_PB);n.SelfMulAdd(this.m_invMassA,u),i+=this.m_invIA*be.CrossVV(this.m_rA,u),r.SelfMulAdd(this.m_invMassB,h),o+=this.m_invIB*be.CrossVV(this.m_rB,h),e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(e){var n=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,r=e.positions[this.m_indexB].c,o=e.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o);be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=Pe.MulRV(a,this.m_lalcA,this.m_rA);be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=Pe.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_uA.Copy(n).SelfAdd(c).SelfSub(this.m_groundAnchorA),_=this.m_uB.Copy(r).SelfAdd(l).SelfSub(this.m_groundAnchorB),f=u.Length(),d=_.Length();f>10*h?u.SelfMul(1/f):u.SetZero(),d>10*h?_.SelfMul(1/d):_.SetZero();var p=be.CrossVV(c,u),m=be.CrossVV(l,_),v=this.m_invMassA+this.m_invIA*p*p,g=this.m_invMassB+this.m_invIB*m*m,y=v+this.m_ratio*this.m_ratio*g;y>0&&(y=1/y);var x=this.m_constant-f-this.m_ratio*d,S=te(x),C=-y*x,A=be.MulSV(-C,u,t.SolvePositionConstraints_s_PA),b=be.MulSV(-this.m_ratio*C,_,t.SolvePositionConstraints_s_PB);return n.SelfMulAdd(this.m_invMassA,A),i+=this.m_invIA*be.CrossVV(c,A),r.SelfMulAdd(this.m_invMassB,b),o+=this.m_invIB*be.CrossVV(l,b),e.positions[this.m_indexA].a=i,e.positions[this.m_indexB].a=o,S<h},i.GetAnchorA=function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)},i.GetAnchorB=function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)},i.GetReactionForce=function(e,t){return t.x=e*this.m_impulse*this.m_uB.x,t.y=e*this.m_impulse*this.m_uB.y,t},i.GetReactionTorque=function(){return 0},i.GetGroundAnchorA=function(){return this.m_groundAnchorA},i.GetGroundAnchorB=function(){return this.m_groundAnchorB},i.GetLengthA=function(){return this.m_lengthA},i.GetLengthB=function(){return this.m_lengthB},i.GetRatio=function(){return this.m_ratio},i.GetCurrentLengthA=function(){var e=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t.GetCurrentLengthA_s_p),n=this.m_groundAnchorA;return be.DistanceVV(e,n)},i.GetCurrentLengthB=function(){var e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t.GetCurrentLengthB_s_p),n=this.m_groundAnchorB;return be.DistanceVV(e,n)},i.Dump=function(e){var t=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;e("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",n),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),e("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.lengthA = %.15f;\n",this.m_lengthA),e("  jd.lengthB = %.15f;\n",this.m_lengthB),e("  jd.ratio = %.15f;\n",this.m_ratio),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i.ShiftOrigin=function(e){this.m_groundAnchorA.SelfSub(e),this.m_groundAnchorB.SelfSub(e)},t}(bi);Ui.InitVelocityConstraints_s_PA=new be,Ui.InitVelocityConstraints_s_PB=new be,Ui.SolveVelocityConstraints_s_vpA=new be,Ui.SolveVelocityConstraints_s_vpB=new be,Ui.SolveVelocityConstraints_s_PA=new be,Ui.SolveVelocityConstraints_s_PB=new be,Ui.SolvePositionConstraints_s_PA=new be,Ui.SolvePositionConstraints_s_PB=new be,Ui.GetCurrentLengthA_s_p=new be,Ui.GetCurrentLengthB_s_p=new be;var ki=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_revoluteJoint)||this).localAnchorA=new be(0,0),n.localAnchorB=new be(0,0),n.referenceAngle=0,n.enableLimit=!1,n.lowerAngle=0,n.upperAngle=0,n.enableMotor=!1,n.motorSpeed=0,n.maxMotorTorque=0,n}return Z(n,t),n.prototype.Initialize=function(e,t,n){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ai),Hi=function(t){function i(i){var r;return(r=t.call(this,i)||this).m_localAnchorA=new be,r.m_localAnchorB=new be,r.m_impulse=new Ee,r.m_motorImpulse=0,r.m_enableMotor=!1,r.m_maxMotorTorque=0,r.m_motorSpeed=0,r.m_enableLimit=!1,r.m_referenceAngle=0,r.m_lowerAngle=0,r.m_upperAngle=0,r.m_indexA=0,r.m_indexB=0,r.m_rA=new be,r.m_rB=new be,r.m_localCenterA=new be,r.m_localCenterB=new be,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_mass=new Ie,r.m_motorMass=0,r.m_limitState=e.b2LimitState.e_inactiveLimit,r.m_qA=new Pe,r.m_qB=new Pe,r.m_lalcA=new be,r.m_lalcB=new be,r.m_K=new we,r.m_localAnchorA.Copy(n(i.localAnchorA,be.ZERO)),r.m_localAnchorB.Copy(n(i.localAnchorB,be.ZERO)),r.m_referenceAngle=n(i.referenceAngle,0),r.m_impulse.SetZero(),r.m_motorImpulse=0,r.m_lowerAngle=n(i.lowerAngle,0),r.m_upperAngle=n(i.upperAngle,0),r.m_maxMotorTorque=n(i.maxMotorTorque,0),r.m_motorSpeed=n(i.motorSpeed,0),r.m_enableLimit=n(i.enableLimit,!1),r.m_enableMotor=n(i.enableMotor,!1),r.m_limitState=e.b2LimitState.e_inactiveLimit,r}Z(i,t);var r=i.prototype;return r.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].a,r=t.velocities[this.m_indexA].v,o=t.velocities[this.m_indexA].w,a=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v,c=t.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a);be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Pe.MulRV(l,this.m_lalcA,this.m_rA),be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Pe.MulRV(u,this.m_lalcB,this.m_rB);var h=this.m_invMassA,f=this.m_invMassB,d=this.m_invIA,p=this.m_invIB,m=d+p===0;if(this.m_mass.ex.x=h+f+this.m_rA.y*this.m_rA.y*d+this.m_rB.y*this.m_rB.y*p,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*d-this.m_rB.y*this.m_rB.x*p,this.m_mass.ez.x=-this.m_rA.y*d-this.m_rB.y*p,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=h+f+this.m_rA.x*this.m_rA.x*d+this.m_rB.x*this.m_rB.x*p,this.m_mass.ez.y=this.m_rA.x*d+this.m_rB.x*p,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=d+p,this.m_motorMass=d+p,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!m||(this.m_motorImpulse=0),this.m_enableLimit&&!m){var v=a-n-this.m_referenceAngle;te(this.m_upperAngle-this.m_lowerAngle)<2*_?this.m_limitState=e.b2LimitState.e_equalLimits:v<=this.m_lowerAngle?(this.m_limitState!==e.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=e.b2LimitState.e_atLowerLimit):v>=this.m_upperAngle?(this.m_limitState!==e.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=e.b2LimitState.e_atUpperLimit):(this.m_limitState=e.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=e.b2LimitState.e_inactiveLimit;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio;var g=i.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);r.SelfMulSub(h,g),o-=d*(be.CrossVV(this.m_rA,g)+this.m_motorImpulse+this.m_impulse.z),s.SelfMulAdd(f,g),c+=p*(be.CrossVV(this.m_rB,g)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=c},r.SolveVelocityConstraints=function(t){var n=t.velocities[this.m_indexA].v,r=t.velocities[this.m_indexA].w,o=t.velocities[this.m_indexB].v,a=t.velocities[this.m_indexB].w,s=this.m_invMassA,c=this.m_invMassB,l=this.m_invIA,u=this.m_invIB,h=l+u===0;if(this.m_enableMotor&&this.m_limitState!==e.b2LimitState.e_equalLimits&&!h){var _=a-r-this.m_motorSpeed,f=-this.m_motorMass*_,d=this.m_motorImpulse,p=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=oe(this.m_motorImpulse+f,-p,p),r-=l*(f=this.m_motorImpulse-d),a+=u*f}if(this.m_enableLimit&&this.m_limitState!==e.b2LimitState.e_inactiveLimit&&!h){var m=be.SubVV(be.AddVCrossSV(o,a,this.m_rB,be.s_t0),be.AddVCrossSV(n,r,this.m_rA,be.s_t1),i.SolveVelocityConstraints_s_Cdot1),v=a-r,g=this.m_mass.Solve33(m.x,m.y,v,i.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===e.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(g);else if(this.m_limitState===e.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+g.z<0){var y=-m.x+this.m_impulse.z*this.m_mass.ez.x,x=-m.y+this.m_impulse.z*this.m_mass.ez.y,S=this.m_mass.Solve22(y,x,i.SolveVelocityConstraints_s_reduced_v2);g.x=S.x,g.y=S.y,g.z=-this.m_impulse.z,this.m_impulse.x+=S.x,this.m_impulse.y+=S.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(g);else if(this.m_limitState===e.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+g.z>0){var C=-m.x+this.m_impulse.z*this.m_mass.ez.x,A=-m.y+this.m_impulse.z*this.m_mass.ez.y,b=this.m_mass.Solve22(C,A,i.SolveVelocityConstraints_s_reduced_v2);g.x=b.x,g.y=b.y,g.z=-this.m_impulse.z,this.m_impulse.x+=b.x,this.m_impulse.y+=b.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(g);var T=i.SolveVelocityConstraints_s_P.Set(g.x,g.y);n.SelfMulSub(s,T),r-=l*(be.CrossVV(this.m_rA,T)+g.z),o.SelfMulAdd(c,T),a+=u*(be.CrossVV(this.m_rB,T)+g.z)}else{var E=be.SubVV(be.AddVCrossSV(o,a,this.m_rB,be.s_t0),be.AddVCrossSV(n,r,this.m_rA,be.s_t1),i.SolveVelocityConstraints_s_Cdot_v2),w=this.m_mass.Solve22(-E.x,-E.y,i.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=w.x,this.m_impulse.y+=w.y,n.SelfMulSub(s,w),r-=l*be.CrossVV(this.m_rA,w),o.SelfMulAdd(c,w),a+=u*be.CrossVV(this.m_rB,w)}t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=a},r.SolvePositionConstraints=function(t){var n=t.positions[this.m_indexA].c,r=t.positions[this.m_indexA].a,o=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,s=this.m_qA.SetAngle(r),c=this.m_qB.SetAngle(a),l=0,u=0,f=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==e.b2LimitState.e_inactiveLimit&&!f){var d=a-r-this.m_referenceAngle,p=0;if(this.m_limitState===e.b2LimitState.e_equalLimits){var m=oe(d-this.m_lowerAngle,-g,g);p=-this.m_motorMass*m,l=te(m)}else if(this.m_limitState===e.b2LimitState.e_atLowerLimit){var v=d-this.m_lowerAngle;l=-v,v=oe(v+_,-g,0),p=-this.m_motorMass*v}else if(this.m_limitState===e.b2LimitState.e_atUpperLimit){var y=d-this.m_upperAngle;l=y,y=oe(y-_,0,g),p=-this.m_motorMass*y}r-=this.m_invIA*p,a+=this.m_invIB*p}s.SetAngle(r),c.SetAngle(a),be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var x=Pe.MulRV(s,this.m_lalcA,this.m_rA);be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var S=Pe.MulRV(c,this.m_lalcB,this.m_rB),C=be.SubVV(be.AddVV(o,S,be.s_t0),be.AddVV(n,x,be.s_t1),i.SolvePositionConstraints_s_C_v2);u=C.Length();var A=this.m_invMassA,b=this.m_invMassB,T=this.m_invIA,E=this.m_invIB,w=this.m_K;w.ex.x=A+b+T*x.y*x.y+E*S.y*S.y,w.ex.y=-T*x.x*x.y-E*S.x*S.y,w.ey.x=w.ex.y,w.ey.y=A+b+T*x.x*x.x+E*S.x*S.x;var I=w.Solve(C.x,C.y,i.SolvePositionConstraints_s_impulse).SelfNeg();return n.SelfMulSub(A,I),r-=T*be.CrossVV(x,I),o.SelfMulAdd(b,I),a+=E*be.CrossVV(S,I),t.positions[this.m_indexA].a=r,t.positions[this.m_indexB].a=a,u<=h&&l<=_},r.GetAnchorA=function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)},r.GetAnchorB=function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)},r.GetReactionForce=function(e,t){return t.x=e*this.m_impulse.x,t.y=e*this.m_impulse.y,t},r.GetReactionTorque=function(e){return e*this.m_impulse.z},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.GetReferenceAngle=function(){return this.m_referenceAngle},r.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},r.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},r.IsMotorEnabled=function(){return this.m_enableMotor},r.EnableMotor=function(e){e!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=e)},r.GetMotorTorque=function(e){return e*this.m_motorImpulse},r.GetMotorSpeed=function(){return this.m_motorSpeed},r.SetMaxMotorTorque=function(e){e!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=e)},r.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},r.IsLimitEnabled=function(){return this.m_enableLimit},r.EnableLimit=function(e){e!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=e,this.m_impulse.z=0)},r.GetLowerLimit=function(){return this.m_lowerAngle},r.GetUpperLimit=function(){return this.m_upperAngle},r.SetLimits=function(e,t){e===this.m_lowerAngle&&t===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=e,this.m_upperAngle=t)},r.SetMotorSpeed=function(e){e!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=e)},r.Dump=function(e){var t=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;e("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",n),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),e("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),e("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),e("  jd.upperAngle = %.15f;\n",this.m_upperAngle),e("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),e("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),e("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Hi.InitVelocityConstraints_s_P=new be,Hi.SolveVelocityConstraints_s_P=new be,Hi.SolveVelocityConstraints_s_Cdot_v2=new be,Hi.SolveVelocityConstraints_s_Cdot1=new be,Hi.SolveVelocityConstraints_s_impulse_v3=new Ee,Hi.SolveVelocityConstraints_s_reduced_v2=new be,Hi.SolveVelocityConstraints_s_impulse_v2=new be,Hi.SolvePositionConstraints_s_C_v2=new be,Hi.SolvePositionConstraints_s_impulse=new be;var ji=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_ropeJoint)||this).localAnchorA=new be(-1,0),n.localAnchorB=new be(1,0),n.maxLength=0,n}return Z(n,t),n}(Ai),Wi=function(t){function i(i){var r;return(r=t.call(this,i)||this).m_localAnchorA=new be,r.m_localAnchorB=new be,r.m_maxLength=0,r.m_length=0,r.m_impulse=0,r.m_indexA=0,r.m_indexB=0,r.m_u=new be,r.m_rA=new be,r.m_rB=new be,r.m_localCenterA=new be,r.m_localCenterB=new be,r.m_invMassA=0,r.m_invMassB=0,r.m_invIA=0,r.m_invIB=0,r.m_mass=0,r.m_state=e.b2LimitState.e_inactiveLimit,r.m_qA=new Pe,r.m_qB=new Pe,r.m_lalcA=new be,r.m_lalcB=new be,r.m_localAnchorA.Copy(n(i.localAnchorA,new be(-1,0))),r.m_localAnchorB.Copy(n(i.localAnchorB,new be(1,0))),r.m_maxLength=n(i.maxLength,0),r}Z(i,t);var r=i.prototype;return r.InitVelocityConstraints=function(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=t.positions[this.m_indexA].c,r=t.positions[this.m_indexA].a,o=t.velocities[this.m_indexA].v,a=t.velocities[this.m_indexA].w,s=t.positions[this.m_indexB].c,c=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v,u=t.velocities[this.m_indexB].w,_=this.m_qA.SetAngle(r),f=this.m_qB.SetAngle(c);be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Pe.MulRV(_,this.m_lalcA,this.m_rA),be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Pe.MulRV(f,this.m_lalcB,this.m_rB),this.m_u.Copy(s).SelfAdd(this.m_rB).SelfSub(n).SelfSub(this.m_rA),this.m_length=this.m_u.Length();var d=this.m_length-this.m_maxLength;if(this.m_state=d>0?e.b2LimitState.e_atUpperLimit:e.b2LimitState.e_inactiveLimit,!(this.m_length>h))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);var p=be.CrossVV(this.m_rA,this.m_u),m=be.CrossVV(this.m_rB,this.m_u),v=this.m_invMassA+this.m_invIA*p*p+this.m_invMassB+this.m_invIB*m*m;if(this.m_mass=0!==v?1/v:0,t.step.warmStarting){this.m_impulse*=t.step.dtRatio;var g=be.MulSV(this.m_impulse,this.m_u,i.InitVelocityConstraints_s_P);o.SelfMulSub(this.m_invMassA,g),a-=this.m_invIA*be.CrossVV(this.m_rA,g),l.SelfMulAdd(this.m_invMassB,g),u+=this.m_invIB*be.CrossVV(this.m_rB,g)}else this.m_impulse=0;t.velocities[this.m_indexA].w=a,t.velocities[this.m_indexB].w=u},r.SolveVelocityConstraints=function(e){var t=e.velocities[this.m_indexA].v,n=e.velocities[this.m_indexA].w,r=e.velocities[this.m_indexB].v,o=e.velocities[this.m_indexB].w,a=be.AddVCrossSV(t,n,this.m_rA,i.SolveVelocityConstraints_s_vpA),s=be.AddVCrossSV(r,o,this.m_rB,i.SolveVelocityConstraints_s_vpB),c=this.m_length-this.m_maxLength,l=be.DotVV(this.m_u,be.SubVV(s,a,be.s_t0));c<0&&(l+=e.step.inv_dt*c);var u=-this.m_mass*l,h=this.m_impulse;this.m_impulse=ie(0,this.m_impulse+u),u=this.m_impulse-h;var _=be.MulSV(u,this.m_u,i.SolveVelocityConstraints_s_P);t.SelfMulSub(this.m_invMassA,_),n-=this.m_invIA*be.CrossVV(this.m_rA,_),r.SelfMulAdd(this.m_invMassB,_),o+=this.m_invIB*be.CrossVV(this.m_rB,_),e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=o},r.SolvePositionConstraints=function(e){var t=e.positions[this.m_indexA].c,n=e.positions[this.m_indexA].a,r=e.positions[this.m_indexB].c,o=e.positions[this.m_indexB].a,a=this.m_qA.SetAngle(n),s=this.m_qB.SetAngle(o);be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=Pe.MulRV(a,this.m_lalcA,this.m_rA);be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l=Pe.MulRV(s,this.m_lalcB,this.m_rB),u=this.m_u.Copy(r).SelfAdd(l).SelfSub(t).SelfSub(c),_=u.Normalize(),f=_-this.m_maxLength;f=oe(f,0,v);var d=-this.m_mass*f,p=be.MulSV(d,u,i.SolvePositionConstraints_s_P);return t.SelfMulSub(this.m_invMassA,p),n-=this.m_invIA*be.CrossVV(c,p),r.SelfMulAdd(this.m_invMassB,p),o+=this.m_invIB*be.CrossVV(l,p),e.positions[this.m_indexA].a=n,e.positions[this.m_indexB].a=o,_-this.m_maxLength<h},r.GetAnchorA=function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)},r.GetAnchorB=function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)},r.GetReactionForce=function(e,t){return be.MulSV(e*this.m_impulse,this.m_u,t)},r.GetReactionTorque=function(){return 0},r.GetLocalAnchorA=function(){return this.m_localAnchorA},r.GetLocalAnchorB=function(){return this.m_localAnchorB},r.SetMaxLength=function(e){this.m_maxLength=e},r.GetMaxLength=function(){return this.m_maxLength},r.GetLimitState=function(){return this.m_state},r.Dump=function(e){var t=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;e("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",n),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.maxLength = %.15f;\n",this.m_maxLength),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},i}(bi);Wi.InitVelocityConstraints_s_P=new be,Wi.SolveVelocityConstraints_s_vpA=new be,Wi.SolveVelocityConstraints_s_vpB=new be,Wi.SolveVelocityConstraints_s_P=new be,Wi.SolvePositionConstraints_s_P=new be;var qi=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_weldJoint)||this).localAnchorA=new be,n.localAnchorB=new be,n.referenceAngle=0,n.frequencyHz=0,n.dampingRatio=0,n}return Z(n,t),n.prototype.Initialize=function(e,t,n){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},n}(Ai),Xi=function(e){function t(t){var i;return(i=e.call(this,t)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_bias=0,i.m_localAnchorA=new be,i.m_localAnchorB=new be,i.m_referenceAngle=0,i.m_gamma=0,i.m_impulse=new Ee(0,0,0),i.m_indexA=0,i.m_indexB=0,i.m_rA=new be,i.m_rB=new be,i.m_localCenterA=new be,i.m_localCenterB=new be,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_mass=new Ie,i.m_qA=new Pe,i.m_qB=new Pe,i.m_lalcA=new be,i.m_lalcB=new be,i.m_K=new Ie,i.m_frequencyHz=n(t.frequencyHz,0),i.m_dampingRatio=n(t.dampingRatio,0),i.m_localAnchorA.Copy(n(t.localAnchorA,be.ZERO)),i.m_localAnchorB.Copy(n(t.localAnchorB,be.ZERO)),i.m_referenceAngle=n(t.referenceAngle,0),i.m_impulse.SetZero(),i}Z(t,e);var i=t.prototype;return i.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=e.positions[this.m_indexA].a,i=e.velocities[this.m_indexA].v,r=e.velocities[this.m_indexA].w,o=e.positions[this.m_indexB].a,s=e.velocities[this.m_indexB].v,c=e.velocities[this.m_indexB].w,l=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(o);be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Pe.MulRV(l,this.m_lalcA,this.m_rA),be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Pe.MulRV(u,this.m_lalcB,this.m_rB);var h=this.m_invMassA,_=this.m_invMassB,f=this.m_invIA,d=this.m_invIB,p=this.m_K;if(p.ex.x=h+_+this.m_rA.y*this.m_rA.y*f+this.m_rB.y*this.m_rB.y*d,p.ey.x=-this.m_rA.y*this.m_rA.x*f-this.m_rB.y*this.m_rB.x*d,p.ez.x=-this.m_rA.y*f-this.m_rB.y*d,p.ex.y=p.ey.x,p.ey.y=h+_+this.m_rA.x*this.m_rA.x*f+this.m_rB.x*this.m_rB.x*d,p.ez.y=this.m_rA.x*f+this.m_rB.x*d,p.ex.z=p.ez.x,p.ey.z=p.ez.y,p.ez.z=f+d,this.m_frequencyHz>0){p.GetInverse22(this.m_mass);var m=f+d,v=m>0?1/m:0,g=o-n-this.m_referenceAngle,y=2*a*this.m_frequencyHz,x=2*v*this.m_dampingRatio*y,S=v*y*y,C=e.step.dt;this.m_gamma=C*(x+C*S),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=g*C*S*this.m_gamma,m+=this.m_gamma,this.m_mass.ez.z=0!==m?1/m:0}else p.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio);var A=t.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(h,A),r-=f*(be.CrossVV(this.m_rA,A)+this.m_impulse.z),s.SelfMulAdd(_,A),c+=d*(be.CrossVV(this.m_rB,A)+this.m_impulse.z)}else this.m_impulse.SetZero();e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=c},i.SolveVelocityConstraints=function(e){var n=e.velocities[this.m_indexA].v,i=e.velocities[this.m_indexA].w,r=e.velocities[this.m_indexB].v,o=e.velocities[this.m_indexB].w,a=this.m_invMassA,s=this.m_invMassB,c=this.m_invIA,l=this.m_invIB;if(this.m_frequencyHz>0){var u=o-i,h=-this.m_mass.ez.z*(u+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=h,i-=c*h,o+=l*h;var _=be.SubVV(be.AddVCrossSV(r,o,this.m_rB,be.s_t0),be.AddVCrossSV(n,i,this.m_rA,be.s_t1),t.SolveVelocityConstraints_s_Cdot1),f=Ie.MulM33XY(this.m_mass,_.x,_.y,t.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=f.x,this.m_impulse.y+=f.y;var d=f;n.SelfMulSub(a,d),i-=c*be.CrossVV(this.m_rA,d),r.SelfMulAdd(s,d),o+=l*be.CrossVV(this.m_rB,d)}else{var p=be.SubVV(be.AddVCrossSV(r,o,this.m_rB,be.s_t0),be.AddVCrossSV(n,i,this.m_rA,be.s_t1),t.SolveVelocityConstraints_s_Cdot1),m=o-i,v=Ie.MulM33XYZ(this.m_mass,p.x,p.y,m,t.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(v);var g=t.SolveVelocityConstraints_s_P.Set(v.x,v.y);n.SelfMulSub(a,g),i-=c*(be.CrossVV(this.m_rA,g)+v.z),r.SelfMulAdd(s,g),o+=l*(be.CrossVV(this.m_rB,g)+v.z)}e.velocities[this.m_indexA].w=i,e.velocities[this.m_indexB].w=o},i.SolvePositionConstraints=function(e){var n=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,r=e.positions[this.m_indexB].c,o=e.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o),c=this.m_invMassA,l=this.m_invMassB,u=this.m_invIA,f=this.m_invIB;be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var d=Pe.MulRV(a,this.m_lalcA,this.m_rA);be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var p,m,v=Pe.MulRV(s,this.m_lalcB,this.m_rB),g=this.m_K;if(g.ex.x=c+l+d.y*d.y*u+v.y*v.y*f,g.ey.x=-d.y*d.x*u-v.y*v.x*f,g.ez.x=-d.y*u-v.y*f,g.ex.y=g.ey.x,g.ey.y=c+l+d.x*d.x*u+v.x*v.x*f,g.ez.y=d.x*u+v.x*f,g.ex.z=g.ez.x,g.ey.z=g.ez.y,g.ez.z=u+f,this.m_frequencyHz>0){var y=be.SubVV(be.AddVV(r,v,be.s_t0),be.AddVV(n,d,be.s_t1),t.SolvePositionConstraints_s_C1);p=y.Length(),m=0;var x=g.Solve22(y.x,y.y,t.SolvePositionConstraints_s_P).SelfNeg();n.SelfMulSub(c,x),i-=u*be.CrossVV(d,x),r.SelfMulAdd(l,x),o+=f*be.CrossVV(v,x)}else{var S=be.SubVV(be.AddVV(r,v,be.s_t0),be.AddVV(n,d,be.s_t1),t.SolvePositionConstraints_s_C1),C=o-i-this.m_referenceAngle;p=S.Length(),m=te(C);var A=g.Solve33(S.x,S.y,C,t.SolvePositionConstraints_s_impulse).SelfNeg(),b=t.SolvePositionConstraints_s_P.Set(A.x,A.y);n.SelfMulSub(c,b),i-=u*(be.CrossVV(this.m_rA,b)+A.z),r.SelfMulAdd(l,b),o+=f*(be.CrossVV(this.m_rB,b)+A.z)}return e.positions[this.m_indexA].a=i,e.positions[this.m_indexB].a=o,p<=h&&m<=_},i.GetAnchorA=function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)},i.GetAnchorB=function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)},i.GetReactionForce=function(e,t){return t.x=e*this.m_impulse.x,t.y=e*this.m_impulse.y,t},i.GetReactionTorque=function(e){return e*this.m_impulse.z},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.GetReferenceAngle=function(){return this.m_referenceAngle},i.SetFrequency=function(e){this.m_frequencyHz=e},i.GetFrequency=function(){return this.m_frequencyHz},i.SetDampingRatio=function(e){this.m_dampingRatio=e},i.GetDampingRatio=function(){return this.m_dampingRatio},i.Dump=function(e){var t=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;e("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",n),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),e("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),e("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},t}(bi);Xi.InitVelocityConstraints_s_P=new be,Xi.SolveVelocityConstraints_s_Cdot1=new be,Xi.SolveVelocityConstraints_s_impulse1=new be,Xi.SolveVelocityConstraints_s_impulse=new Ee,Xi.SolveVelocityConstraints_s_P=new be,Xi.SolvePositionConstraints_s_C1=new be,Xi.SolvePositionConstraints_s_P=new be,Xi.SolvePositionConstraints_s_impulse=new Ee;var Yi=function(t){function n(){var n;return(n=t.call(this,e.b2JointType.e_wheelJoint)||this).localAnchorA=new be(0,0),n.localAnchorB=new be(0,0),n.localAxisA=new be(1,0),n.enableMotor=!1,n.maxMotorTorque=0,n.motorSpeed=0,n.frequencyHz=2,n.dampingRatio=.7,n}return Z(n,t),n.prototype.Initialize=function(e,t,n,i){this.bodyA=e,this.bodyB=t,this.bodyA.GetLocalPoint(n,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.bodyA.GetLocalVector(i,this.localAxisA)},n}(Ai),Ki=function(e){function t(t){var i;return(i=e.call(this,t)||this).m_frequencyHz=0,i.m_dampingRatio=0,i.m_localAnchorA=new be,i.m_localAnchorB=new be,i.m_localXAxisA=new be,i.m_localYAxisA=new be,i.m_impulse=0,i.m_motorImpulse=0,i.m_springImpulse=0,i.m_maxMotorTorque=0,i.m_motorSpeed=0,i.m_enableMotor=!1,i.m_indexA=0,i.m_indexB=0,i.m_localCenterA=new be,i.m_localCenterB=new be,i.m_invMassA=0,i.m_invMassB=0,i.m_invIA=0,i.m_invIB=0,i.m_ax=new be,i.m_ay=new be,i.m_sAx=0,i.m_sBx=0,i.m_sAy=0,i.m_sBy=0,i.m_mass=0,i.m_motorMass=0,i.m_springMass=0,i.m_bias=0,i.m_gamma=0,i.m_qA=new Pe,i.m_qB=new Pe,i.m_lalcA=new be,i.m_lalcB=new be,i.m_rA=new be,i.m_rB=new be,i.m_frequencyHz=n(t.frequencyHz,2),i.m_dampingRatio=n(t.dampingRatio,.7),i.m_localAnchorA.Copy(n(t.localAnchorA,be.ZERO)),i.m_localAnchorB.Copy(n(t.localAnchorB,be.ZERO)),i.m_localXAxisA.Copy(n(t.localAxisA,be.UNITX)),be.CrossOneV(i.m_localXAxisA,i.m_localYAxisA),i.m_maxMotorTorque=n(t.maxMotorTorque,0),i.m_motorSpeed=n(t.motorSpeed,0),i.m_enableMotor=n(t.enableMotor,!1),i.m_ax.SetZero(),i.m_ay.SetZero(),i}Z(t,e);var i=t.prototype;return i.GetMotorSpeed=function(){return this.m_motorSpeed},i.GetMaxMotorTorque=function(){return this.m_maxMotorTorque},i.SetSpringFrequencyHz=function(e){this.m_frequencyHz=e},i.GetSpringFrequencyHz=function(){return this.m_frequencyHz},i.SetSpringDampingRatio=function(e){this.m_dampingRatio=e},i.GetSpringDampingRatio=function(){return this.m_dampingRatio},i.InitVelocityConstraints=function(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;var n=this.m_invMassA,i=this.m_invMassB,r=this.m_invIA,o=this.m_invIB,s=e.positions[this.m_indexA].c,c=e.positions[this.m_indexA].a,l=e.velocities[this.m_indexA].v,u=e.velocities[this.m_indexA].w,h=e.positions[this.m_indexB].c,_=e.positions[this.m_indexB].a,f=e.velocities[this.m_indexB].v,d=e.velocities[this.m_indexB].w,p=this.m_qA.SetAngle(c),m=this.m_qB.SetAngle(_);be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var v=Pe.MulRV(p,this.m_lalcA,this.m_rA);be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var g=Pe.MulRV(m,this.m_lalcB,this.m_rB),y=be.SubVV(be.AddVV(h,g,be.s_t0),be.AddVV(s,v,be.s_t1),t.InitVelocityConstraints_s_d);if(Pe.MulRV(p,this.m_localYAxisA,this.m_ay),this.m_sAy=be.CrossVV(be.AddVV(y,v,be.s_t0),this.m_ay),this.m_sBy=be.CrossVV(g,this.m_ay),this.m_mass=n+i+r*this.m_sAy*this.m_sAy+o*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){Pe.MulRV(p,this.m_localXAxisA,this.m_ax),this.m_sAx=be.CrossVV(be.AddVV(y,v,be.s_t0),this.m_ax),this.m_sBx=be.CrossVV(g,this.m_ax);var x=n+i+r*this.m_sAx*this.m_sAx+o*this.m_sBx*this.m_sBx;if(x>0){this.m_springMass=1/x;var S=be.DotVV(y,this.m_ax),C=2*a*this.m_frequencyHz,A=2*this.m_springMass*this.m_dampingRatio*C,b=this.m_springMass*C*C,T=e.step.dt;this.m_gamma=T*(A+T*b),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=S*T*b*this.m_gamma,this.m_springMass=x+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=r+o,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),e.step.warmStarting){this.m_impulse*=e.step.dtRatio,this.m_springImpulse*=e.step.dtRatio,this.m_motorImpulse*=e.step.dtRatio;var E=be.AddVV(be.MulSV(this.m_impulse,this.m_ay,be.s_t0),be.MulSV(this.m_springImpulse,this.m_ax,be.s_t1),t.InitVelocityConstraints_s_P),w=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,I=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;l.SelfMulSub(this.m_invMassA,E),u-=this.m_invIA*w,f.SelfMulAdd(this.m_invMassB,E),d+=this.m_invIB*I}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;e.velocities[this.m_indexA].w=u,e.velocities[this.m_indexB].w=d},i.SolveVelocityConstraints=function(e){var n=this.m_invMassA,i=this.m_invMassB,r=this.m_invIA,o=this.m_invIB,a=e.velocities[this.m_indexA].v,s=e.velocities[this.m_indexA].w,c=e.velocities[this.m_indexB].v,l=e.velocities[this.m_indexB].w,u=be.DotVV(this.m_ax,be.SubVV(c,a,be.s_t0))+this.m_sBx*l-this.m_sAx*s,h=-this.m_springMass*(u+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=h;var _=be.MulSV(h,this.m_ax,t.SolveVelocityConstraints_s_P),f=h*this.m_sAx,d=h*this.m_sBx;a.SelfMulSub(n,_),s-=r*f,c.SelfMulAdd(i,_);var p=(l+=o*d)-s-this.m_motorSpeed,m=-this.m_motorMass*p,v=this.m_motorImpulse,g=e.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=oe(this.m_motorImpulse+m,-g,g),s-=r*(m=this.m_motorImpulse-v),l+=o*m;var y=be.DotVV(this.m_ay,be.SubVV(c,a,be.s_t0))+this.m_sBy*l-this.m_sAy*s,x=-this.m_mass*y;this.m_impulse+=x;var S=be.MulSV(x,this.m_ay,t.SolveVelocityConstraints_s_P),C=x*this.m_sAy,A=x*this.m_sBy;a.SelfMulSub(n,S),s-=r*C,c.SelfMulAdd(i,S),l+=o*A,e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=l},i.SolvePositionConstraints=function(e){var n=e.positions[this.m_indexA].c,i=e.positions[this.m_indexA].a,r=e.positions[this.m_indexB].c,o=e.positions[this.m_indexB].a,a=this.m_qA.SetAngle(i),s=this.m_qB.SetAngle(o);be.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);var c=Pe.MulRV(a,this.m_lalcA,this.m_rA);be.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);var l,u=Pe.MulRV(s,this.m_lalcB,this.m_rB),_=be.AddVV(be.SubVV(r,n,be.s_t0),be.SubVV(u,c,be.s_t1),t.SolvePositionConstraints_s_d),f=Pe.MulRV(a,this.m_localYAxisA,this.m_ay),d=be.CrossVV(be.AddVV(_,c,be.s_t0),f),p=be.CrossVV(u,f),m=be.DotVV(_,this.m_ay),v=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;l=0!==v?-m/v:0;var g=be.MulSV(l,f,t.SolvePositionConstraints_s_P),y=l*d,x=l*p;return n.SelfMulSub(this.m_invMassA,g),i-=this.m_invIA*y,r.SelfMulAdd(this.m_invMassB,g),o+=this.m_invIB*x,e.positions[this.m_indexA].a=i,e.positions[this.m_indexB].a=o,te(m)<=h},i.GetDefinition=function(e){return e},i.GetAnchorA=function(e){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,e)},i.GetAnchorB=function(e){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,e)},i.GetReactionForce=function(e,t){return t.x=e*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),t.y=e*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),t},i.GetReactionTorque=function(e){return e*this.m_motorImpulse},i.GetLocalAnchorA=function(){return this.m_localAnchorA},i.GetLocalAnchorB=function(){return this.m_localAnchorB},i.GetLocalAxisA=function(){return this.m_localXAxisA},i.GetJointTranslation=function(){return this.GetPrismaticJointTranslation()},i.GetJointLinearSpeed=function(){return this.GetPrismaticJointSpeed()},i.GetJointAngle=function(){return this.GetRevoluteJointAngle()},i.GetJointAngularSpeed=function(){return this.GetRevoluteJointSpeed()},i.GetPrismaticJointTranslation=function(){var e=this.m_bodyA,t=this.m_bodyB,n=e.GetWorldPoint(this.m_localAnchorA,new be),i=t.GetWorldPoint(this.m_localAnchorB,new be),r=be.SubVV(i,n,new be),o=e.GetWorldVector(this.m_localXAxisA,new be);return be.DotVV(r,o)},i.GetPrismaticJointSpeed=function(){var e=this.m_bodyA,t=this.m_bodyB;be.SubVV(this.m_localAnchorA,e.m_sweep.localCenter,this.m_lalcA);var n=Pe.MulRV(e.m_xf.q,this.m_lalcA,this.m_rA);be.SubVV(this.m_localAnchorB,t.m_sweep.localCenter,this.m_lalcB);var i=Pe.MulRV(t.m_xf.q,this.m_lalcB,this.m_rB),r=be.AddVV(e.m_sweep.c,n,be.s_t0),o=be.AddVV(t.m_sweep.c,i,be.s_t1),a=be.SubVV(o,r,be.s_t2),s=e.GetWorldVector(this.m_localXAxisA,new be),c=e.m_linearVelocity,l=t.m_linearVelocity,u=e.m_angularVelocity,h=t.m_angularVelocity;return be.DotVV(a,be.CrossSV(u,s,be.s_t0))+be.DotVV(s,be.SubVV(be.AddVCrossSV(l,h,i,be.s_t0),be.AddVCrossSV(c,u,n,be.s_t1),be.s_t0))},i.GetRevoluteJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a},i.GetRevoluteJointSpeed=function(){var e=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-e},i.IsMotorEnabled=function(){return this.m_enableMotor},i.EnableMotor=function(e){e!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=e)},i.SetMotorSpeed=function(e){e!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=e)},i.SetMaxMotorTorque=function(e){e!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=e)},i.GetMotorTorque=function(e){return e*this.m_motorImpulse},i.Dump=function(e){var t=this.m_bodyA.m_islandIndex,n=this.m_bodyB.m_islandIndex;e("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),e("  jd.bodyA = bodies[%d];\n",t),e("  jd.bodyB = bodies[%d];\n",n),e("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),e("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),e("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),e("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),e("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),e("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),e("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),e("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),e("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),e("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)},t}(bi);function Ji(e,t){return he(e*t)}function Qi(e,t){return e>t?e:t}Ki.InitVelocityConstraints_s_d=new be,Ki.InitVelocityConstraints_s_P=new be,Ki.SolveVelocityConstraints_s_P=new be,Ki.SolvePositionConstraints_s_d=new be,Ki.SolvePositionConstraints_s_P=new be;var Zi=function(){function e(e){this._other=null,this.prev=null,this.next=null,this.contact=e}return e.prototype.Reset=function(){this._other=null,this.prev=null,this.next=null},J(e,[{key:"other",get:function(){if(null===this._other)throw new Error;return this._other},set:function(e){if(null!==this._other)throw new Error;this._other=e}}]),e}(),$i=function(){function e(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new Zi(this),this.m_nodeB=new Zi(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new yt,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new yt}var t=e.prototype;return t.GetManifold=function(){return this.m_manifold},t.GetWorldManifold=function(e){var t=this.m_fixtureA.GetBody(),n=this.m_fixtureB.GetBody(),i=this.GetShapeA(),r=this.GetShapeB();e.Initialize(this.m_manifold,t.GetTransform(),i.m_radius,n.GetTransform(),r.m_radius)},t.IsTouching=function(){return this.m_touchingFlag},t.SetEnabled=function(e){this.m_enabledFlag=e},t.IsEnabled=function(){return this.m_enabledFlag},t.GetNext=function(){return this.m_next},t.GetFixtureA=function(){return this.m_fixtureA},t.GetChildIndexA=function(){return this.m_indexA},t.GetShapeA=function(){return this.m_fixtureA.GetShape()},t.GetFixtureB=function(){return this.m_fixtureB},t.GetChildIndexB=function(){return this.m_indexB},t.GetShapeB=function(){return this.m_fixtureB.GetShape()},t.FlagForFiltering=function(){this.m_filterFlag=!0},t.SetFriction=function(e){this.m_friction=e},t.GetFriction=function(){return this.m_friction},t.ResetFriction=function(){this.m_friction=Ji(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)},t.SetRestitution=function(e){this.m_restitution=e},t.GetRestitution=function(){return this.m_restitution},t.ResetRestitution=function(){this.m_restitution=Qi(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},t.SetTangentSpeed=function(e){this.m_tangentSpeed=e},t.GetTangentSpeed=function(){return this.m_tangentSpeed},t.Reset=function(e,t,n,i){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=e,this.m_fixtureB=n,this.m_indexA=t,this.m_indexB=i,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=Ji(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Qi(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)},t.Update=function(e){var t=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=t,this.m_enabledFlag=!0;var n=!1,i=this.m_touchingFlag,r=this.m_fixtureA.IsSensor(),o=this.m_fixtureB.IsSensor(),a=r||o,s=this.m_fixtureA.GetBody(),c=this.m_fixtureB.GetBody(),l=s.GetTransform(),u=c.GetTransform();if(a){var h=this.GetShapeA(),_=this.GetShapeB();n=Dt(h,this.m_indexA,_,this.m_indexB,l,u),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,l,u),n=this.m_manifold.pointCount>0;for(var f=0;f<this.m_manifold.pointCount;++f){var d=this.m_manifold.points[f];d.normalImpulse=0,d.tangentImpulse=0;for(var p=d.id,m=0;m<this.m_oldManifold.pointCount;++m){var v=this.m_oldManifold.points[m];if(v.id.key===p.key){d.normalImpulse=v.normalImpulse,d.tangentImpulse=v.tangentImpulse;break}}}n!==i&&(s.SetAwake(!0),c.SetAwake(!0))}this.m_touchingFlag=n,!i&&n&&e&&e.BeginContact(this),i&&!n&&e&&e.EndContact(this),!a&&n&&e&&e.PreSolve(this,this.m_oldManifold)},t.ComputeTOI=function(t,n){var i=e.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.m_indexA),i.proxyB.SetShape(this.GetShapeB(),this.m_indexB),i.sweepA.Copy(t),i.sweepB.Copy(n),i.tMax=h;var r=e.ComputeTOI_s_output;return un(r,i),r.t},e}();$i.ComputeTOI_s_input=new Jt,$i.ComputeTOI_s_output=new Zt;var er=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.Create=function(){return new t},t.Destroy=function(){},t.prototype.Evaluate=function(e,t,n){fn(e,this.GetShapeA(),t,this.GetShapeB(),n)},t}($i),tr=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.Create=function(){return new t},t.Destroy=function(){},t.prototype.Evaluate=function(e,t,n){Un(e,this.GetShapeA(),t,this.GetShapeB(),n)},t}($i),nr=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.Create=function(){return new t},t.Destroy=function(){},t.prototype.Evaluate=function(e,t,n){vn(e,this.GetShapeA(),t,this.GetShapeB(),n)},t}($i),ir=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.Create=function(){return new t},t.Destroy=function(){},t.prototype.Evaluate=function(e,t,n){Qn(e,this.GetShapeA(),t,this.GetShapeB(),n)},t}($i),rr=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.Create=function(){return new t},t.Destroy=function(){},t.prototype.Evaluate=function(e,t,n){ri(e,this.GetShapeA(),t,this.GetShapeB(),n)},t}($i),or=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.Create=function(){return new t},t.Destroy=function(){},t.prototype.Evaluate=function(e,n,i){var r=t.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),Qn(e,r,n,this.GetShapeB(),i)},t}($i);or.Evaluate_s_edge=new ui;var ar=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t.Create=function(){return new t},t.Destroy=function(){},t.prototype.Evaluate=function(e,n,i){var r=t.Evaluate_s_edge;this.GetShapeA().GetChildEdge(r,this.m_indexA),ri(e,r,n,this.GetShapeB(),i)},t}($i);ar.Evaluate_s_edge=new ui;var sr=function(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1},cr=function(){function t(){this.m_registers=[],this.InitializeRegisters()}var n=t.prototype;return n.AddType=function(e,t,n,i){var r=[];function o(){return r.pop()||e()}function a(e){r.push(e)}this.m_registers[n][i].pool=r,this.m_registers[n][i].createFcn=o,this.m_registers[n][i].destroyFcn=a,this.m_registers[n][i].primary=!0,n!==i&&(this.m_registers[i][n].pool=r,this.m_registers[i][n].createFcn=o,this.m_registers[i][n].destroyFcn=a,this.m_registers[i][n].primary=!1)},n.InitializeRegisters=function(){for(var t=0;t<e.b2ShapeType.e_shapeTypeCount;t++){this.m_registers[t]=[];for(var n=0;n<e.b2ShapeType.e_shapeTypeCount;n++)this.m_registers[t][n]=new sr}this.AddType(er.Create,er.Destroy,e.b2ShapeType.e_circleShape,e.b2ShapeType.e_circleShape),this.AddType(nr.Create,nr.Destroy,e.b2ShapeType.e_polygonShape,e.b2ShapeType.e_circleShape),this.AddType(tr.Create,tr.Destroy,e.b2ShapeType.e_polygonShape,e.b2ShapeType.e_polygonShape),this.AddType(ir.Create,ir.Destroy,e.b2ShapeType.e_edgeShape,e.b2ShapeType.e_circleShape),this.AddType(rr.Create,rr.Destroy,e.b2ShapeType.e_edgeShape,e.b2ShapeType.e_polygonShape),this.AddType(or.Create,or.Destroy,e.b2ShapeType.e_chainShape,e.b2ShapeType.e_circleShape),this.AddType(ar.Create,ar.Destroy,e.b2ShapeType.e_chainShape,e.b2ShapeType.e_polygonShape)},n.Create=function(e,t,n,i){var r=e.GetType(),o=n.GetType(),a=this.m_registers[r][o];if(a.createFcn){var s=a.createFcn();return a.primary?s.Reset(e,t,n,i):s.Reset(n,i,e,t),s}return null},n.Destroy=function(e){var t=e.m_fixtureA.GetType(),n=e.m_fixtureB.GetType(),i=this.m_registers[t][n];i.destroyFcn&&i.destroyFcn(e)},t}(),lr=function(){function e(){}var t=e.prototype;return t.SayGoodbyeJoint=function(){},t.SayGoodbyeFixture=function(){},t.SayGoodbyeParticleGroup=function(){},t.SayGoodbyeParticle=function(){},e}(),ur=function(){function t(){}var n=t.prototype;return n.ShouldCollide=function(t,n){var i=t.GetBody(),r=n.GetBody();if(r.GetType()===e.b2BodyType.b2_staticBody&&i.GetType()===e.b2BodyType.b2_staticBody)return!1;if(!r.ShouldCollideConnected(i))return!1;var o=t.GetFilterData(),a=n.GetFilterData();return o.groupIndex===a.groupIndex&&0!==o.groupIndex?o.groupIndex>0:0!=(o.maskBits&a.categoryBits)&&0!=(o.categoryBits&a.maskBits)},n.ShouldCollideFixtureParticle=function(){return!0},n.ShouldCollideParticleParticle=function(){return!0},t}();ur.b2_defaultFilter=new ur;var hr=function(){this.normalImpulses=K(s),this.tangentImpulses=K(s),this.count=0},_r=function(){function e(){}var t=e.prototype;return t.BeginContact=function(){},t.EndContact=function(){},t.BeginContactFixtureParticle=function(){},t.EndContactFixtureParticle=function(){},t.BeginContactParticleParticle=function(){},t.EndContactParticleParticle=function(){},t.PreSolve=function(){},t.PostSolve=function(){},e}();_r.b2_defaultListener=new _r;var fr=function(){function e(){}var t=e.prototype;return t.ReportFixture=function(){return!0},t.ReportParticle=function(){return!1},t.ShouldQueryParticleSystem=function(){return!0},e}(),dr=function(){function e(){}var t=e.prototype;return t.ReportFixture=function(e,t,n,i){return i},t.ReportParticle=function(){return 0},t.ShouldQueryParticleSystem=function(){return!0},e}(),pr=function(){function t(){this.m_broadPhase=new Vt,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=ur.b2_defaultFilter,this.m_contactListener=_r.b2_defaultListener,this.m_contactFactory=new cr}var n=t.prototype;return n.AddPair=function(e,t){var n=e.fixture,i=t.fixture,r=e.childIndex,o=t.childIndex,a=n.GetBody(),s=i.GetBody();if(a!==s){for(var c=s.GetContactList();c;){if(c.other===a){var l=c.contact.GetFixtureA(),u=c.contact.GetFixtureB(),h=c.contact.GetChildIndexA(),_=c.contact.GetChildIndexB();if(l===n&&u===i&&h===r&&_===o)return;if(l===i&&u===n&&h===o&&_===r)return}c=c.next}if(!this.m_contactFilter||this.m_contactFilter.ShouldCollide(n,i)){var f=this.m_contactFactory.Create(n,r,i,o);null!==f&&(n=f.GetFixtureA(),i=f.GetFixtureB(),r=f.GetChildIndexA(),o=f.GetChildIndexB(),a=n.m_body,s=i.m_body,f.m_prev=null,f.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=f),this.m_contactList=f,f.m_nodeA.other=s,f.m_nodeA.prev=null,f.m_nodeA.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=f.m_nodeA),a.m_contactList=f.m_nodeA,f.m_nodeB.other=a,f.m_nodeB.prev=null,f.m_nodeB.next=s.m_contactList,null!==s.m_contactList&&(s.m_contactList.prev=f.m_nodeB),s.m_contactList=f.m_nodeB,n.IsSensor()||i.IsSensor()||(a.SetAwake(!0),s.SetAwake(!0)),++this.m_contactCount)}}},n.FindNewContacts=function(){var e=this;this.m_broadPhase.UpdatePairs((function(t,n){e.AddPair(t,n)}))},n.Destroy=function(e){var t=e.GetFixtureA(),n=e.GetFixtureB(),i=t.GetBody(),r=n.GetBody();this.m_contactListener&&e.IsTouching()&&this.m_contactListener.EndContact(e),e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),e===this.m_contactList&&(this.m_contactList=e.m_next),e.m_nodeA.prev&&(e.m_nodeA.prev.next=e.m_nodeA.next),e.m_nodeA.next&&(e.m_nodeA.next.prev=e.m_nodeA.prev),e.m_nodeA===i.m_contactList&&(i.m_contactList=e.m_nodeA.next),e.m_nodeB.prev&&(e.m_nodeB.prev.next=e.m_nodeB.next),e.m_nodeB.next&&(e.m_nodeB.next.prev=e.m_nodeB.prev),e.m_nodeB===r.m_contactList&&(r.m_contactList=e.m_nodeB.next),e.m_manifold.pointCount>0&&!t.IsSensor()&&!n.IsSensor()&&(t.GetBody().SetAwake(!0),n.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(e),--this.m_contactCount},n.Collide=function(){for(var t=this.m_contactList;t;){var n=t.GetFixtureA(),i=t.GetFixtureB(),r=t.GetChildIndexA(),o=t.GetChildIndexB(),a=n.GetBody(),s=i.GetBody();if(t.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(n,i)){var c=t;t=c.m_next,this.Destroy(c);continue}t.m_filterFlag=!1}var l=a.IsAwake()&&a.m_type!==e.b2BodyType.b2_staticBody,u=s.IsAwake()&&s.m_type!==e.b2BodyType.b2_staticBody;if(l||u){var h=n.m_proxies[r].treeNode,_=i.m_proxies[o].treeNode;if(Et(h.aabb,_.aabb))t.Update(this.m_contactListener),t=t.m_next;else{var f=t;t=f.m_next,this.Destroy(f)}}else t=t.m_next}},t}(),mr=function(){function e(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}return e.prototype.Reset=function(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this},e}(),vr=function(){function e(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}return e.prototype.Copy=function(e){return this.dt=e.dt,this.inv_dt=e.inv_dt,this.dtRatio=e.dtRatio,this.positionIterations=e.positionIterations,this.velocityIterations=e.velocityIterations,this.particleIterations=e.particleIterations,this.warmStarting=e.warmStarting,this},e}(),gr=function(){function e(){this.c=new be,this.a=0}return e.MakeArray=function(t){return X(t,(function(){return new e}))},e}(),yr=function(){function e(){this.v=new be,this.w=0}return e.MakeArray=function(t){return X(t,(function(){return new e}))},e}(),xr=function(){this.step=new vr},Sr=!1,Cr=function(){function e(){this.rA=new be,this.rB=new be,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}return e.MakeArray=function(t){return X(t,(function(){return new e}))},e}(),Ar=function(){function e(){this.points=Cr.MakeArray(s),this.normal=new be,this.tangent=new be,this.normalMass=new we,this.K=new we,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}return e.MakeArray=function(t){return X(t,(function(){return new e}))},e}(),br=function(){function t(){this.localPoints=be.MakeArray(s),this.localNormal=new be,this.localPoint=new be,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new be,this.localCenterB=new be,this.invIA=0,this.invIB=0,this.type=e.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}return t.MakeArray=function(e){return X(e,(function(){return new t}))},t}(),Tr=function(){this.step=new vr,this.count=0},Er=function(){function t(){this.normal=new be,this.point=new be,this.separation=0}return t.prototype.Initialize=function(n,i,r,o){var a=t.Initialize_s_pointA,s=t.Initialize_s_pointB,c=t.Initialize_s_planePoint,l=t.Initialize_s_clipPoint;switch(n.type){case e.b2ManifoldType.e_circles:Re.MulXV(i,n.localPoint,a),Re.MulXV(r,n.localPoints[0],s),be.SubVV(s,a,this.normal).SelfNormalize(),be.MidVV(a,s,this.point),this.separation=be.DotVV(be.SubVV(s,a,be.s_t0),this.normal)-n.radiusA-n.radiusB;break;case e.b2ManifoldType.e_faceA:Pe.MulRV(i.q,n.localNormal,this.normal),Re.MulXV(i,n.localPoint,c),Re.MulXV(r,n.localPoints[o],l),this.separation=be.DotVV(be.SubVV(l,c,be.s_t0),this.normal)-n.radiusA-n.radiusB,this.point.Copy(l);break;case e.b2ManifoldType.e_faceB:Pe.MulRV(r.q,n.localNormal,this.normal),Re.MulXV(r,n.localPoint,c),Re.MulXV(i,n.localPoints[o],l),this.separation=be.DotVV(be.SubVV(l,c,be.s_t0),this.normal)-n.radiusA-n.radiusB,this.point.Copy(l),this.normal.SelfNeg()}},t}();Er.Initialize_s_pointA=new be,Er.Initialize_s_pointB=new be,Er.Initialize_s_planePoint=new be,Er.Initialize_s_clipPoint=new be;var wr=function(){function e(){this.m_step=new vr,this.m_positionConstraints=br.MakeArray(1024),this.m_velocityConstraints=Ar.MakeArray(1024),this.m_count=0}var t=e.prototype;return t.Initialize=function(e){if(this.m_step.Copy(e.step),this.m_count=e.count,this.m_positionConstraints.length<this.m_count)for(var t=re(2*this.m_positionConstraints.length,this.m_count);this.m_positionConstraints.length<t;)this.m_positionConstraints[this.m_positionConstraints.length]=new br;if(this.m_velocityConstraints.length<this.m_count)for(var n=re(2*this.m_velocityConstraints.length,this.m_count);this.m_velocityConstraints.length<n;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new Ar;this.m_positions=e.positions,this.m_velocities=e.velocities,this.m_contacts=e.contacts;for(var i=0;i<this.m_count;++i){var r=this.m_contacts[i],o=r.m_fixtureA,a=r.m_fixtureB,s=o.GetShape(),c=a.GetShape(),l=s.m_radius,u=c.m_radius,h=o.GetBody(),_=a.GetBody(),f=r.GetManifold(),d=f.pointCount,p=this.m_velocityConstraints[i];p.friction=r.m_friction,p.restitution=r.m_restitution,p.tangentSpeed=r.m_tangentSpeed,p.indexA=h.m_islandIndex,p.indexB=_.m_islandIndex,p.invMassA=h.m_invMass,p.invMassB=_.m_invMass,p.invIA=h.m_invI,p.invIB=_.m_invI,p.contactIndex=i,p.pointCount=d,p.K.SetZero(),p.normalMass.SetZero();var m=this.m_positionConstraints[i];m.indexA=h.m_islandIndex,m.indexB=_.m_islandIndex,m.invMassA=h.m_invMass,m.invMassB=_.m_invMass,m.localCenterA.Copy(h.m_sweep.localCenter),m.localCenterB.Copy(_.m_sweep.localCenter),m.invIA=h.m_invI,m.invIB=_.m_invI,m.localNormal.Copy(f.localNormal),m.localPoint.Copy(f.localPoint),m.pointCount=d,m.radiusA=l,m.radiusB=u,m.type=f.type;for(var v=0;v<d;++v){var g=f.points[v],y=p.points[v];this.m_step.warmStarting?(y.normalImpulse=this.m_step.dtRatio*g.normalImpulse,y.tangentImpulse=this.m_step.dtRatio*g.tangentImpulse):(y.normalImpulse=0,y.tangentImpulse=0),y.rA.SetZero(),y.rB.SetZero(),y.normalMass=0,y.tangentMass=0,y.velocityBias=0,m.localPoints[v].Copy(g.localPoint)}}return this},t.InitializeVelocityConstraints=function(){for(var t=e.InitializeVelocityConstraints_s_xfA,n=e.InitializeVelocityConstraints_s_xfB,i=e.InitializeVelocityConstraints_s_worldManifold,r=1e3,o=0;o<this.m_count;++o){var a=this.m_velocityConstraints[o],s=this.m_positionConstraints[o],c=s.radiusA,l=s.radiusB,u=this.m_contacts[a.contactIndex].GetManifold(),h=a.indexA,_=a.indexB,f=a.invMassA,d=a.invMassB,p=a.invIA,v=a.invIB,g=s.localCenterA,y=s.localCenterB,x=this.m_positions[h].c,S=this.m_positions[h].a,C=this.m_velocities[h].v,A=this.m_velocities[h].w,b=this.m_positions[_].c,T=this.m_positions[_].a,E=this.m_velocities[_].v,w=this.m_velocities[_].w;t.q.SetAngle(S),n.q.SetAngle(T),be.SubVV(x,Pe.MulRV(t.q,g,be.s_t0),t.p),be.SubVV(b,Pe.MulRV(n.q,y,be.s_t0),n.p),i.Initialize(u,t,c,n,l),a.normal.Copy(i.normal),be.CrossVOne(a.normal,a.tangent);for(var I=a.pointCount,P=0;P<I;++P){var R=a.points[P];be.SubVV(i.points[P],x,R.rA),be.SubVV(i.points[P],b,R.rB);var D=be.CrossVV(R.rA,a.normal),O=be.CrossVV(R.rB,a.normal),N=f+d+p*D*D+v*O*O;R.normalMass=N>0?1/N:0;var B=a.tangent,M=be.CrossVV(R.rA,B),L=be.CrossVV(R.rB,B),F=f+d+p*M*M+v*L*L;R.tangentMass=F>0?1/F:0,R.velocityBias=0;var z=be.DotVV(a.normal,be.SubVV(be.AddVCrossSV(E,w,R.rB,be.s_t0),be.AddVCrossSV(C,A,R.rA,be.s_t1),be.s_t0));z<-m&&(R.velocityBias+=-a.restitution*z)}if(2===a.pointCount&&Sr){var V=a.points[0],G=a.points[1],U=be.CrossVV(V.rA,a.normal),k=be.CrossVV(V.rB,a.normal),H=be.CrossVV(G.rA,a.normal),j=be.CrossVV(G.rB,a.normal),W=f+d+p*U*U+v*k*k,q=f+d+p*H*H+v*j*j,X=f+d+p*U*H+v*k*j;W*W<r*(W*q-X*X)?(a.K.ex.Set(W,X),a.K.ey.Set(X,q),a.K.GetInverse(a.normalMass)):a.pointCount=1}}},t.WarmStart=function(){for(var t=e.WarmStart_s_P,n=0;n<this.m_count;++n){for(var i=this.m_velocityConstraints[n],r=i.indexA,o=i.indexB,a=i.invMassA,s=i.invIA,c=i.invMassB,l=i.invIB,u=i.pointCount,h=this.m_velocities[r].v,_=this.m_velocities[r].w,f=this.m_velocities[o].v,d=this.m_velocities[o].w,p=i.normal,m=i.tangent,v=0;v<u;++v){var g=i.points[v];be.AddVV(be.MulSV(g.normalImpulse,p,be.s_t0),be.MulSV(g.tangentImpulse,m,be.s_t1),t),_-=s*be.CrossVV(g.rA,t),h.SelfMulSub(a,t),d+=l*be.CrossVV(g.rB,t),f.SelfMulAdd(c,t)}this.m_velocities[r].w=_,this.m_velocities[o].w=d}},t.SolveVelocityConstraints=function(){for(var t=e.SolveVelocityConstraints_s_dv,n=e.SolveVelocityConstraints_s_dv1,i=e.SolveVelocityConstraints_s_dv2,r=e.SolveVelocityConstraints_s_P,o=e.SolveVelocityConstraints_s_a,a=e.SolveVelocityConstraints_s_b,s=e.SolveVelocityConstraints_s_x,c=e.SolveVelocityConstraints_s_d,l=e.SolveVelocityConstraints_s_P1,u=e.SolveVelocityConstraints_s_P2,h=e.SolveVelocityConstraints_s_P1P2,_=0;_<this.m_count;++_){for(var f=this.m_velocityConstraints[_],d=f.indexA,p=f.indexB,m=f.invMassA,v=f.invIA,g=f.invMassB,y=f.invIB,x=f.pointCount,S=this.m_velocities[d].v,C=this.m_velocities[d].w,A=this.m_velocities[p].v,b=this.m_velocities[p].w,T=f.normal,E=f.tangent,w=f.friction,I=0;I<x;++I){var P=f.points[I];be.SubVV(be.AddVCrossSV(A,b,P.rB,be.s_t0),be.AddVCrossSV(S,C,P.rA,be.s_t1),t);var R=be.DotVV(t,E)-f.tangentSpeed,D=P.tangentMass*-R,O=w*P.normalImpulse,N=oe(P.tangentImpulse+D,-O,O);D=N-P.tangentImpulse,P.tangentImpulse=N,be.MulSV(D,E,r),S.SelfMulSub(m,r),C-=v*be.CrossVV(P.rA,r),A.SelfMulAdd(g,r),b+=y*be.CrossVV(P.rB,r)}if(1===f.pointCount||!1===Sr)for(var B=0;B<x;++B){var M=f.points[B];be.SubVV(be.AddVCrossSV(A,b,M.rB,be.s_t0),be.AddVCrossSV(S,C,M.rA,be.s_t1),t);var L=be.DotVV(t,T),F=-M.normalMass*(L-M.velocityBias),z=re(M.normalImpulse+F,0);F=z-M.normalImpulse,M.normalImpulse=z,be.MulSV(F,T,r),S.SelfMulSub(m,r),C-=v*be.CrossVV(M.rA,r),A.SelfMulAdd(g,r),b+=y*be.CrossVV(M.rB,r)}else{var V=f.points[0],G=f.points[1];o.Set(V.normalImpulse,G.normalImpulse),be.SubVV(be.AddVCrossSV(A,b,V.rB,be.s_t0),be.AddVCrossSV(S,C,V.rA,be.s_t1),n),be.SubVV(be.AddVCrossSV(A,b,G.rB,be.s_t0),be.AddVCrossSV(S,C,G.rA,be.s_t1),i);var U=be.DotVV(n,T),k=be.DotVV(i,T);for(a.x=U-V.velocityBias,a.y=k-G.velocityBias,a.SelfSub(we.MulMV(f.K,o,be.s_t0));;){if(we.MulMV(f.normalMass,a,s).SelfNeg(),s.x>=0&&s.y>=0){be.SubVV(s,o,c),be.MulSV(c.x,T,l),be.MulSV(c.y,T,u),be.AddVV(l,u,h),S.SelfMulSub(m,h),C-=v*(be.CrossVV(V.rA,l)+be.CrossVV(G.rA,u)),A.SelfMulAdd(g,h),b+=y*(be.CrossVV(V.rB,l)+be.CrossVV(G.rB,u)),V.normalImpulse=s.x,G.normalImpulse=s.y;break}if(s.x=-V.normalMass*a.x,s.y=0,U=0,k=f.K.ex.y*s.x+a.y,s.x>=0&&k>=0){be.SubVV(s,o,c),be.MulSV(c.x,T,l),be.MulSV(c.y,T,u),be.AddVV(l,u,h),S.SelfMulSub(m,h),C-=v*(be.CrossVV(V.rA,l)+be.CrossVV(G.rA,u)),A.SelfMulAdd(g,h),b+=y*(be.CrossVV(V.rB,l)+be.CrossVV(G.rB,u)),V.normalImpulse=s.x,G.normalImpulse=s.y;break}if(s.x=0,s.y=-G.normalMass*a.y,U=f.K.ey.x*s.y+a.x,k=0,s.y>=0&&U>=0){be.SubVV(s,o,c),be.MulSV(c.x,T,l),be.MulSV(c.y,T,u),be.AddVV(l,u,h),S.SelfMulSub(m,h),C-=v*(be.CrossVV(V.rA,l)+be.CrossVV(G.rA,u)),A.SelfMulAdd(g,h),b+=y*(be.CrossVV(V.rB,l)+be.CrossVV(G.rB,u)),V.normalImpulse=s.x,G.normalImpulse=s.y;break}if(s.x=0,s.y=0,U=a.x,k=a.y,U>=0&&k>=0){be.SubVV(s,o,c),be.MulSV(c.x,T,l),be.MulSV(c.y,T,u),be.AddVV(l,u,h),S.SelfMulSub(m,h),C-=v*(be.CrossVV(V.rA,l)+be.CrossVV(G.rA,u)),A.SelfMulAdd(g,h),b+=y*(be.CrossVV(V.rB,l)+be.CrossVV(G.rB,u)),V.normalImpulse=s.x,G.normalImpulse=s.y;break}break}}this.m_velocities[d].w=C,this.m_velocities[p].w=b}},t.StoreImpulses=function(){for(var e=0;e<this.m_count;++e)for(var t=this.m_velocityConstraints[e],n=this.m_contacts[t.contactIndex].GetManifold(),i=0;i<t.pointCount;++i)n.points[i].normalImpulse=t.points[i].normalImpulse,n.points[i].tangentImpulse=t.points[i].tangentImpulse},t.SolvePositionConstraints=function(){for(var t=e.SolvePositionConstraints_s_xfA,n=e.SolvePositionConstraints_s_xfB,i=e.SolvePositionConstraints_s_psm,r=e.SolvePositionConstraints_s_rA,o=e.SolvePositionConstraints_s_rB,a=e.SolvePositionConstraints_s_P,s=0,c=0;c<this.m_count;++c){for(var l=this.m_positionConstraints[c],u=l.indexA,_=l.indexB,f=l.localCenterA,d=l.invMassA,p=l.invIA,m=l.localCenterB,g=l.invMassB,y=l.invIB,x=l.pointCount,S=this.m_positions[u].c,C=this.m_positions[u].a,b=this.m_positions[_].c,T=this.m_positions[_].a,E=0;E<x;++E){t.q.SetAngle(C),n.q.SetAngle(T),be.SubVV(S,Pe.MulRV(t.q,f,be.s_t0),t.p),be.SubVV(b,Pe.MulRV(n.q,m,be.s_t0),n.p),i.Initialize(l,t,n,E);var w=i.normal,I=i.point,P=i.separation;be.SubVV(I,S,r),be.SubVV(I,b,o),s=ie(s,P);var R=oe(A*(P+h),-v,0),D=be.CrossVV(r,w),O=be.CrossVV(o,w),N=d+g+p*D*D+y*O*O,B=N>0?-R/N:0;be.MulSV(B,w,a),S.SelfMulSub(d,a),C-=p*be.CrossVV(r,a),b.SelfMulAdd(g,a),T+=y*be.CrossVV(o,a)}this.m_positions[u].a=C,this.m_positions[_].a=T}return s>-3*h},t.SolveTOIPositionConstraints=function(t,n){for(var i=e.SolveTOIPositionConstraints_s_xfA,r=e.SolveTOIPositionConstraints_s_xfB,o=e.SolveTOIPositionConstraints_s_psm,a=e.SolveTOIPositionConstraints_s_rA,s=e.SolveTOIPositionConstraints_s_rB,c=e.SolveTOIPositionConstraints_s_P,l=0,u=0;u<this.m_count;++u){var _=this.m_positionConstraints[u],f=_.indexA,d=_.indexB,p=_.localCenterA,m=_.localCenterB,g=_.pointCount,y=0,x=0;f!==t&&f!==n||(y=_.invMassA,x=_.invIA);var S=0,C=0;d!==t&&d!==n||(S=_.invMassB,C=_.invIB);for(var A=this.m_positions[f].c,T=this.m_positions[f].a,E=this.m_positions[d].c,w=this.m_positions[d].a,I=0;I<g;++I){i.q.SetAngle(T),r.q.SetAngle(w),be.SubVV(A,Pe.MulRV(i.q,p,be.s_t0),i.p),be.SubVV(E,Pe.MulRV(r.q,m,be.s_t0),r.p),o.Initialize(_,i,r,I);var P=o.normal,R=o.point,D=o.separation;be.SubVV(R,A,a),be.SubVV(R,E,s),l=ie(l,D);var O=oe(b*(D+h),-v,0),N=be.CrossVV(a,P),B=be.CrossVV(s,P),M=y+S+x*N*N+C*B*B,L=M>0?-O/M:0;be.MulSV(L,P,c),A.SelfMulSub(y,c),T-=x*be.CrossVV(a,c),E.SelfMulAdd(S,c),w+=C*be.CrossVV(s,c)}this.m_positions[f].a=T,this.m_positions[d].a=w}return l>=-1.5*h},e}();wr.InitializeVelocityConstraints_s_xfA=new Re,wr.InitializeVelocityConstraints_s_xfB=new Re,wr.InitializeVelocityConstraints_s_worldManifold=new xt,wr.WarmStart_s_P=new be,wr.SolveVelocityConstraints_s_dv=new be,wr.SolveVelocityConstraints_s_dv1=new be,wr.SolveVelocityConstraints_s_dv2=new be,wr.SolveVelocityConstraints_s_P=new be,wr.SolveVelocityConstraints_s_a=new be,wr.SolveVelocityConstraints_s_b=new be,wr.SolveVelocityConstraints_s_x=new be,wr.SolveVelocityConstraints_s_d=new be,wr.SolveVelocityConstraints_s_P1=new be,wr.SolveVelocityConstraints_s_P2=new be,wr.SolveVelocityConstraints_s_P1P2=new be,wr.SolvePositionConstraints_s_xfA=new Re,wr.SolvePositionConstraints_s_xfB=new Re,wr.SolvePositionConstraints_s_psm=new Er,wr.SolvePositionConstraints_s_rA=new be,wr.SolvePositionConstraints_s_rB=new be,wr.SolvePositionConstraints_s_P=new be,wr.SolveTOIPositionConstraints_s_xfA=new Re,wr.SolveTOIPositionConstraints_s_xfB=new Re,wr.SolveTOIPositionConstraints_s_psm=new Er,wr.SolveTOIPositionConstraints_s_rA=new be,wr.SolveTOIPositionConstraints_s_rB=new be,wr.SolveTOIPositionConstraints_s_P=new be;var Ir,Pr=function(){function t(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=gr.MakeArray(1024),this.m_velocities=yr.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}var n=t.prototype;return n.Initialize=function(e,t,n,i){if(this.m_bodyCapacity=e,this.m_contactCapacity=t,this.m_jointCapacity=n,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=i,this.m_positions.length<e)for(var r=re(2*this.m_positions.length,e);this.m_positions.length<r;)this.m_positions[this.m_positions.length]=new gr;if(this.m_velocities.length<e)for(var o=re(2*this.m_velocities.length,e);this.m_velocities.length<o;)this.m_velocities[this.m_velocities.length]=new yr},n.Clear=function(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0},n.AddBody=function(e){e.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=e},n.AddContact=function(e){this.m_contacts[this.m_contactCount++]=e},n.AddJoint=function(e){this.m_joints[this.m_jointCount++]=e},n.Solve=function(n,r,o,a){for(var s=t.s_timer.Reset(),c=r.dt,l=0;l<this.m_bodyCount;++l){var u=this.m_bodies[l];this.m_positions[l].c.Copy(u.m_sweep.c);var h=u.m_sweep.a,_=this.m_velocities[l].v.Copy(u.m_linearVelocity),f=u.m_angularVelocity;u.m_sweep.c0.Copy(u.m_sweep.c),u.m_sweep.a0=u.m_sweep.a,u.m_type===e.b2BodyType.b2_dynamicBody&&(_.x+=c*(u.m_gravityScale*o.x+u.m_invMass*u.m_force.x),_.y+=c*(u.m_gravityScale*o.y+u.m_invMass*u.m_force.y),f+=c*u.m_invI*u.m_torque,_.SelfMul(1/(1+c*u.m_linearDamping)),f*=1/(1+c*u.m_angularDamping)),this.m_positions[l].a=h,this.m_velocities[l].w=f}s.Reset();var d=t.s_solverData;d.step.Copy(r),d.positions=this.m_positions,d.velocities=this.m_velocities;var p=t.s_contactSolverDef;p.step.Copy(r),p.contacts=this.m_contacts,p.count=this.m_contactCount,p.positions=this.m_positions,p.velocities=this.m_velocities;var m=t.s_contactSolver.Initialize(p);m.InitializeVelocityConstraints(),r.warmStarting&&m.WarmStart();for(var v=0;v<this.m_jointCount;++v)this.m_joints[v].InitVelocityConstraints(d);n.solveInit=s.GetMilliseconds(),s.Reset();for(var g=0;g<r.velocityIterations;++g){for(var A=0;A<this.m_jointCount;++A)this.m_joints[A].SolveVelocityConstraints(d);m.SolveVelocityConstraints()}m.StoreImpulses(),n.solveVelocity=s.GetMilliseconds();for(var b=0;b<this.m_bodyCount;++b){var T=this.m_positions[b].c,E=this.m_positions[b].a,w=this.m_velocities[b].v,I=this.m_velocities[b].w,P=be.MulSV(c,w,t.s_translation);if(be.DotVV(P,P)>x){var R=y/P.Length();w.SelfMul(R)}var D=c*I;D*D>C&&(I*=S/te(D)),T.x+=c*w.x,T.y+=c*w.y,E+=c*I,this.m_positions[b].a=E,this.m_velocities[b].w=I}s.Reset();for(var O=!1,N=0;N<r.positionIterations;++N){for(var B=m.SolvePositionConstraints(),z=!0,V=0;V<this.m_jointCount;++V){var G=this.m_joints[V].SolvePositionConstraints(d);z=z&&G}if(B&&z){O=!0;break}}for(var U=0;U<this.m_bodyCount;++U){var k=this.m_bodies[U];k.m_sweep.c.Copy(this.m_positions[U].c),k.m_sweep.a=this.m_positions[U].a,k.m_linearVelocity.Copy(this.m_velocities[U].v),k.m_angularVelocity=this.m_velocities[U].w,k.SynchronizeTransform()}if(n.solvePosition=s.GetMilliseconds(),this.Report(m.m_velocityConstraints),a){for(var H=i,j=L*L,W=F*F,q=0;q<this.m_bodyCount;++q){var X=this.m_bodies[q];X.GetType()!==e.b2BodyType.b2_staticBody&&(!X.m_autoSleepFlag||X.m_angularVelocity*X.m_angularVelocity>W||be.DotVV(X.m_linearVelocity,X.m_linearVelocity)>j?(X.m_sleepTime=0,H=0):(X.m_sleepTime+=c,H=ie(H,X.m_sleepTime)))}if(H>=M&&O)for(var Y=0;Y<this.m_bodyCount;++Y)this.m_bodies[Y].SetAwake(!1)}},n.SolveTOI=function(e,n,i){for(var r=0;r<this.m_bodyCount;++r){var o=this.m_bodies[r];this.m_positions[r].c.Copy(o.m_sweep.c),this.m_positions[r].a=o.m_sweep.a,this.m_velocities[r].v.Copy(o.m_linearVelocity),this.m_velocities[r].w=o.m_angularVelocity}var a=t.s_contactSolverDef;a.contacts=this.m_contacts,a.count=this.m_contactCount,a.step.Copy(e),a.positions=this.m_positions,a.velocities=this.m_velocities;for(var s=t.s_contactSolver.Initialize(a),c=0;c<e.positionIterations&&!s.SolveTOIPositionConstraints(n,i);++c);this.m_bodies[n].m_sweep.c0.Copy(this.m_positions[n].c),this.m_bodies[n].m_sweep.a0=this.m_positions[n].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,s.InitializeVelocityConstraints();for(var l=0;l<e.velocityIterations;++l)s.SolveVelocityConstraints();for(var u=e.dt,h=0;h<this.m_bodyCount;++h){var _=this.m_positions[h].c,f=this.m_positions[h].a,d=this.m_velocities[h].v,p=this.m_velocities[h].w,m=be.MulSV(u,d,t.s_translation);if(be.DotVV(m,m)>x){var v=y/m.Length();d.SelfMul(v)}var g=u*p;g*g>C&&(p*=S/te(g)),_.SelfMulAdd(u,d),f+=u*p,this.m_positions[h].a=f,this.m_velocities[h].w=p;var A=this.m_bodies[h];A.m_sweep.c.Copy(_),A.m_sweep.a=f,A.m_linearVelocity.Copy(d),A.m_angularVelocity=p,A.SynchronizeTransform()}this.Report(s.m_velocityConstraints)},n.Report=function(e){if(null!==this.m_listener)for(var n=0;n<this.m_contactCount;++n){var i=this.m_contacts[n];if(i){var r=e[n],o=t.s_impulse;o.count=r.pointCount;for(var a=0;a<r.pointCount;++a)o.normalImpulses[a]=r.points[a].normalImpulse,o.tangentImpulses[a]=r.points[a].tangentImpulse;this.m_listener.PostSolve(i,o)}}},t}();Pr.s_timer=new Me,Pr.s_solverData=new xr,Pr.s_contactSolverDef=new Tr,Pr.s_contactSolver=new wr,Pr.s_translation=new be,Pr.s_impulse=new hr,(Ir=e.b2ParticleFlag||(e.b2ParticleFlag={}))[Ir.b2_waterParticle=0]="b2_waterParticle",Ir[Ir.b2_zombieParticle=2]="b2_zombieParticle",Ir[Ir.b2_wallParticle=4]="b2_wallParticle",Ir[Ir.b2_springParticle=8]="b2_springParticle",Ir[Ir.b2_elasticParticle=16]="b2_elasticParticle",Ir[Ir.b2_viscousParticle=32]="b2_viscousParticle",Ir[Ir.b2_powderParticle=64]="b2_powderParticle",Ir[Ir.b2_tensileParticle=128]="b2_tensileParticle",Ir[Ir.b2_colorMixingParticle=256]="b2_colorMixingParticle",Ir[Ir.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",Ir[Ir.b2_barrierParticle=1024]="b2_barrierParticle",Ir[Ir.b2_staticPressureParticle=2048]="b2_staticPressureParticle",Ir[Ir.b2_reactiveParticle=4096]="b2_reactiveParticle",Ir[Ir.b2_repulsiveParticle=8192]="b2_repulsiveParticle",Ir[Ir.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",Ir[Ir.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",Ir[Ir.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",Ir[Ir.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle";var Rr=function(){this.flags=0,this.position=new be,this.velocity=new be,this.color=new Ne(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null};function Dr(e,t,n){var i=8,r=.01;return oe(Math.ceil(Math.sqrt(e/(r*t))*n),1,i)}var Or,Nr=function(){function e(){this.m_index=T}var t=e.prototype;return t.GetIndex=function(){return this.m_index},t.SetIndex=function(e){this.m_index=e},e}();(Or=e.b2ParticleGroupFlag||(e.b2ParticleGroupFlag={}))[Or.b2_solidParticleGroup=1]="b2_solidParticleGroup",Or[Or.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",Or[Or.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",Or[Or.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",Or[Or.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",Or[Or.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask";var Br=function(){this.flags=0,this.groupFlags=0,this.position=new be,this.angle=0,this.linearVelocity=new be,this.angularVelocity=0,this.color=new Ne,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null},Mr=function(){function t(e){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new be,this.m_linearVelocity=new be,this.m_angularVelocity=0,this.m_transform=new Re,this.m_userData=null,this.m_system=e}var n=t.prototype;return n.GetNext=function(){return this.m_next},n.GetParticleSystem=function(){return this.m_system},n.GetParticleCount=function(){return this.m_lastIndex-this.m_firstIndex},n.GetBufferIndex=function(){return this.m_firstIndex},n.ContainsParticle=function(e){return this.m_firstIndex<=e&&e<this.m_lastIndex},n.GetAllParticleFlags=function(){if(!this.m_system.m_flagsBuffer.data)throw new Error;for(var e=0,t=this.m_firstIndex;t<this.m_lastIndex;t++)e|=this.m_system.m_flagsBuffer.data[t];return e},n.GetGroupFlags=function(){return this.m_groupFlags},n.SetGroupFlags=function(t){t|=this.m_groupFlags&e.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,t)},n.GetMass=function(){return this.UpdateStatistics(),this.m_mass},n.GetInertia=function(){return this.UpdateStatistics(),this.m_inertia},n.GetCenter=function(){return this.UpdateStatistics(),this.m_center},n.GetLinearVelocity=function(){return this.UpdateStatistics(),this.m_linearVelocity},n.GetAngularVelocity=function(){return this.UpdateStatistics(),this.m_angularVelocity},n.GetTransform=function(){return this.m_transform},n.GetPosition=function(){return this.m_transform.p},n.GetAngle=function(){return this.m_transform.q.GetAngle()},n.GetLinearVelocityFromWorldPoint=function(e,n){var i=t.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),be.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,be.SubVV(e,this.m_center,i),n)},n.GetUserData=function(){return this.m_userData},n.SetUserData=function(e){this.m_userData=e},n.ApplyForce=function(e){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,e)},n.ApplyLinearImpulse=function(e){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,e)},n.DestroyParticles=function(e){if(this.m_system.m_world.IsLocked())throw new Error;for(var t=this.m_firstIndex;t<this.m_lastIndex;t++)this.m_system.DestroyParticle(t,e)},n.UpdateStatistics=function(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;var e=new be,t=new be;if(this.m_timestamp!==this.m_system.m_timestamp){var n=this.m_system.GetParticleMass();this.m_mass=n*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(var i=this.m_firstIndex;i<this.m_lastIndex;i++)this.m_center.SelfMulAdd(n,this.m_system.m_positionBuffer.data[i]),this.m_linearVelocity.SelfMulAdd(n,this.m_system.m_velocityBuffer.data[i]);if(this.m_mass>0){var r=1/this.m_mass;this.m_center.SelfMul(r),this.m_linearVelocity.SelfMul(r)}this.m_inertia=0,this.m_angularVelocity=0;for(var o=this.m_firstIndex;o<this.m_lastIndex;o++)be.SubVV(this.m_system.m_positionBuffer.data[o],this.m_center,e),be.SubVV(this.m_system.m_velocityBuffer.data[o],this.m_linearVelocity,t),this.m_inertia+=n*be.DotVV(e,e),this.m_angularVelocity+=n*be.CrossVV(e,t);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}},t}();Mr.GetLinearVelocityFromWorldPoint_s_t0=new be;var Lr=function(){function e(e){this.m_buffer=[],this.m_front=0,this.m_back=0,this.m_buffer.fill(null,0,e)}var t=e.prototype;return t.Push=function(e){if(this.m_back>=this.m_capacity){for(var t=this.m_front;t<this.m_back;t++)this.m_buffer[t-this.m_front]=this.m_buffer[t];this.m_back-=this.m_front,this.m_front=0}this.m_buffer[this.m_back]=e,this.m_back++},t.Pop=function(){this.m_buffer[this.m_front]=null,this.m_front++},t.Empty=function(){return this.m_front===this.m_back},t.Front=function(){var e=this.m_buffer[this.m_front];if(!e)throw new Error;return e},J(e,[{key:"m_capacity",get:function(){return this.m_buffer.length}}]),e}(),Fr=function(){function e(e){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=X(e,(function(){return new zr})),this.m_generatorCapacity=e}var t=e.prototype;return t.AddGenerator=function(e,t,n){var i=this.m_generatorBuffer[this.m_generatorCount++];i.center.Copy(e),i.tag=t,i.necessary=n},t.Generate=function(e,t){for(var n=1/e,r=new be(+i,+i),o=new be(-i,-i),a=0,s=0;s<this.m_generatorCount;s++){var c=this.m_generatorBuffer[s];c.necessary&&(be.MinV(r,c.center,r),be.MaxV(o,c.center,o),++a)}if(0===a)return this.m_countX=0,void(this.m_countY=0);r.x-=t,r.y-=t,o.x+=t,o.y+=t,this.m_countX=1+Math.floor(n*(o.x-r.x)),this.m_countY=1+Math.floor(n*(o.y-r.y)),this.m_diagram=[];for(var l=new Lr(4*this.m_countX*this.m_countY),u=0;u<this.m_generatorCount;u++){var h=this.m_generatorBuffer[u];h.center.SelfSub(r).SelfMul(n);var _=Math.floor(h.center.x),f=Math.floor(h.center.y);_>=0&&f>=0&&_<this.m_countX&&f<this.m_countY&&l.Push(new Vr(_,f,_+f*this.m_countX,h))}for(;!l.Empty();){var d=l.Front(),p=d.m_x,m=d.m_y,v=d.m_i,g=d.m_generator;l.Pop(),this.m_diagram[v]||(this.m_diagram[v]=g,p>0&&l.Push(new Vr(p-1,m,v-1,g)),m>0&&l.Push(new Vr(p,m-1,v-this.m_countX,g)),p<this.m_countX-1&&l.Push(new Vr(p+1,m,v+1,g)),m<this.m_countY-1&&l.Push(new Vr(p,m+1,v+this.m_countX,g)))}for(var y=0;y<this.m_countY;y++)for(var x=0;x<this.m_countX-1;x++){var S=x+y*this.m_countX,C=this.m_diagram[S],A=this.m_diagram[S+1];C!==A&&(l.Push(new Vr(x,y,S,A)),l.Push(new Vr(x+1,y,S+1,C)))}for(var b=0;b<this.m_countY-1;b++)for(var T=0;T<this.m_countX;T++){var E=T+b*this.m_countX,w=this.m_diagram[E],I=this.m_diagram[E+this.m_countX];w!==I&&(l.Push(new Vr(T,b,E,I)),l.Push(new Vr(T,b+1,E+this.m_countX,w)))}for(;!l.Empty();){var P=l.Front(),R=P.m_x,D=P.m_y,O=P.m_i,N=P.m_generator;l.Pop();var B=this.m_diagram[O],M=N;if(B!==M){var L=B.center.x-R,F=B.center.y-D,z=M.center.x-R,V=M.center.y-D;L*L+F*F>z*z+V*V&&(this.m_diagram[O]=M,R>0&&l.Push(new Vr(R-1,D,O-1,M)),D>0&&l.Push(new Vr(R,D-1,O-this.m_countX,M)),R<this.m_countX-1&&l.Push(new Vr(R+1,D,O+1,M)),D<this.m_countY-1&&l.Push(new Vr(R,D+1,O+this.m_countX,M)))}}},t.GetNodes=function(e){for(var t=0;t<this.m_countY-1;t++)for(var n=0;n<this.m_countX-1;n++){var i=n+t*this.m_countX,r=this.m_diagram[i],o=this.m_diagram[i+1],a=this.m_diagram[i+this.m_countX],s=this.m_diagram[i+1+this.m_countX];o!==a&&(r!==o&&r!==a&&(r.necessary||o.necessary||a.necessary)&&e(r.tag,o.tag,a.tag),s!==o&&s!==a&&(r.necessary||o.necessary||a.necessary)&&e(o.tag,s.tag,a.tag))}},e}(),zr=function(){this.center=new be,this.tag=0,this.necessary=!1},Vr=function(e,t,n,i){this.m_x=e,this.m_y=t,this.m_i=n,this.m_generator=i};function Gr(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function Ur(e,t){return e<t}function kr(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=e.length-t),void 0===i&&(i=Ur);for(var r=t,o=[],a=0;;){for(;r+1<n;n++){var s=e[r+Math.floor(Math.random()*(n-r))];o[a++]=n;for(var c=r-1;;){for(;i(e[++c],s););for(;i(s,e[--n]););if(c>=n)break;Gr(e,c,n)}}if(0===a)break;r=n,n=o[--a]}return e}function Hr(e,t,n,i){return void 0===t&&(t=0),void 0===n&&(n=e.length-t),void 0===i&&(i=Ur),kr(e,t,n,i)}function jr(e,t,n){void 0===n&&(n=e.length);for(var i=0,r=0;r<n;++r)t(e[r])||(r!==i?Gr(e,i++,r):++i);return i}function Wr(e,t,n,i,r){for(var o=n-t;o>0;){var a=Math.floor(o/2),s=t+a;r(e[s],i)?(t=++s,o-=a+1):o=a}return t}function qr(e,t,n,i,r){for(var o=n-t;o>0;){var a=Math.floor(o/2),s=t+a;r(i,e[s])?o=a:(t=++s,o-=a+1)}return t}function Xr(e,t,n,i){for(var r=n;t!==r;)Gr(e,t++,r++),r===i?r=n:t===n&&(n=r)}function Yr(e,t,n,i){if(t===n)return n;for(var r=t;++t!==n;)i(e[r],e[t])||Gr(e,++r,t);return++r}var Kr=function(){function e(e){this.data=[],this.count=0,this.capacity=0,this.allocator=e}var t=e.prototype;return t.Append=function(){return this.count>=this.capacity&&this.Grow(),this.count++},t.Reserve=function(e){if(!(this.capacity>=e)){for(var t=this.capacity;t<e;++t)this.data[t]=this.allocator();this.capacity=e}},t.Grow=function(){var e=this.capacity?2*this.capacity:N;this.Reserve(e)},t.Free=function(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)},t.Shorten=function(){},t.Data=function(){return this.data},t.GetCount=function(){return this.count},t.SetCount=function(e){this.count=e},t.GetCapacity=function(){return this.capacity},t.RemoveIf=function(e){this.count=jr(this.data,e,this.count)},t.Unique=function(e){this.count=Yr(this.data,0,this.count,e)},e}(),Jr=function(e){function t(t){var n;return(n=e.call(this)||this).m_system=t,n}Z(t,e);var n=t.prototype;return n.ShouldQueryParticleSystem=function(){return!1},n.ReportFixture=function(e){if(e.IsSensor())return!0;for(var t=e.GetShape().GetChildCount(),n=0;n<t;n++)for(var i=e.GetAABB(n),r=this.m_system.GetInsideBoundsEnumerator(i),o=void 0;(o=r.GetNext())>=0;)this.ReportFixtureAndParticle(e,n,o);return!0},n.ReportParticle=function(){return!1},n.ReportFixtureAndParticle=function(){},t}(fr),Qr=function(){function e(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new be,this.flags=0}var t=e.prototype;return t.SetIndices=function(e,t){this.indexA=e,this.indexB=t},t.SetWeight=function(e){this.weight=e},t.SetNormal=function(e){this.normal.Copy(e)},t.SetFlags=function(e){this.flags=e},t.GetIndexA=function(){return this.indexA},t.GetIndexB=function(){return this.indexB},t.GetWeight=function(){return this.weight},t.GetNormal=function(){return this.normal},t.GetFlags=function(){return this.flags},t.IsEqual=function(e){return this.indexA===e.indexA&&this.indexB===e.indexB&&this.flags===e.flags&&this.weight===e.weight&&this.normal.x===e.normal.x&&this.normal.y===e.normal.y},t.IsNotEqual=function(e){return!this.IsEqual(e)},t.ApproximatelyEqual=function(e){var t=.01,n=1e-4;return this.indexA===e.indexA&&this.indexB===e.indexB&&this.flags===e.flags&&te(this.weight-e.weight)<t&&be.DistanceSquaredVV(this.normal,e.normal)<n},e}(),Zr=function(){this.index=0,this.weight=0,this.normal=new be,this.mass=0},$r=function(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0},eo=function(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new be(0,0),this.pb=new be(0,0),this.pc=new be(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0},to=function(){function e(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}var t=e.prototype;return t.Copy=function(e){return this.strictContactCheck=e.strictContactCheck,this.density=e.density,this.gravityScale=e.gravityScale,this.radius=e.radius,this.maxCount=e.maxCount,this.pressureStrength=e.pressureStrength,this.dampingStrength=e.dampingStrength,this.elasticStrength=e.elasticStrength,this.springStrength=e.springStrength,this.viscousStrength=e.viscousStrength,this.surfaceTensionPressureStrength=e.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=e.surfaceTensionNormalStrength,this.repulsiveStrength=e.repulsiveStrength,this.powderStrength=e.powderStrength,this.ejectionStrength=e.ejectionStrength,this.staticPressureStrength=e.staticPressureStrength,this.staticPressureRelaxation=e.staticPressureRelaxation,this.staticPressureIterations=e.staticPressureIterations,this.colorMixingStrength=e.colorMixingStrength,this.destroyByAge=e.destroyByAge,this.lifetimeGranularity=e.lifetimeGranularity,this},t.Clone=function(){return(new e).Copy(this)},e}(),no=function(){function t(e,t){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new io,this.m_flagsBuffer=new io,this.m_positionBuffer=new io,this.m_velocityBuffer=new io,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new io,this.m_groupBuffer=[],this.m_userDataBuffer=new io,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new io,this.m_bodyContactCountBuffer=new io,this.m_consecutiveContactStepsBuffer=new io,this.m_stuckParticleBuffer=new Kr((function(){return 0})),this.m_proxyBuffer=new Kr((function(){return new ro})),this.m_contactBuffer=new Kr((function(){return new Qr})),this.m_bodyContactBuffer=new Kr((function(){return new Zr})),this.m_pairBuffer=new Kr((function(){return new $r})),this.m_triadBuffer=new Kr((function(){return new eo})),this.m_expirationTimeBuffer=new io,this.m_indexByExpirationTimeBuffer=new io,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new to,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(e.strictContactCheck),this.SetDensity(e.density),this.SetGravityScale(e.gravityScale),this.SetRadius(e.radius),this.SetMaxParticleCount(e.maxCount),this.m_def=e.Clone(),this.m_world=t,this.SetDestructionByAge(this.m_def.destroyByAge)}t.computeTag=function(e,n){return(n+t.yOffset>>>0<<t.yShift)+(t.xScale*e+t.xOffset>>>0)>>>0},t.computeRelativeTag=function(e,n,i){return e+(i<<t.yShift)+(n<<t.xShift)>>>0};var r=t.prototype;return r.Drop=function(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)},r.CreateParticle=function(e){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){var t=this.m_count?2*this.m_count:N;this.ReallocateInternalAllocatedBuffers(t)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return T;this.DestroyOldestParticle(0,!1),this.SolveZombie()}var i=this.m_count++;this.m_flagsBuffer.data[i]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[i]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[i]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[i]=0),this.m_positionBuffer.data[i]=(this.m_positionBuffer.data[i]||new be).Copy(n(e.position,be.ZERO)),this.m_velocityBuffer.data[i]=(this.m_velocityBuffer.data[i]||new be).Copy(n(e.velocity,be.ZERO)),this.m_weightBuffer[i]=0,this.m_forceBuffer[i]=(this.m_forceBuffer[i]||new be).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[i]=0),this.m_depthBuffer&&(this.m_depthBuffer[i]=0);var r=(new Ne).Copy(n(e.color,Ne.ZERO));!this.m_colorBuffer.data&&r.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[i]=(this.m_colorBuffer.data[i]||new Ne).Copy(r)),(this.m_userDataBuffer.data||e.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[i]=e.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[i]=null);var o=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],a=n(e.lifetime,0),s=a>0;(this.m_expirationTimeBuffer.data||s)&&(this.SetParticleLifetime(i,s?a:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[i]=i),o.index=i;var c=n(e.group,null);return this.m_groupBuffer[i]=c,c&&(c.m_firstIndex<c.m_lastIndex?(this.RotateBuffer(c.m_firstIndex,c.m_lastIndex,i),c.m_lastIndex=i+1):(c.m_firstIndex=i,c.m_lastIndex=i+1)),this.SetParticleFlags(i,n(e.flags,0)),i},r.GetParticleHandleFromIndex=function(e){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);var t=this.m_handleIndexBuffer.data[e];return t||((t=new Nr).SetIndex(e),this.m_handleIndexBuffer.data[e]=t,t)},r.DestroyParticle=function(t,n){void 0===n&&(n=!1);var i=e.b2ParticleFlag.b2_zombieParticle;n&&(i|=e.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(t,this.m_flagsBuffer.data[t]|i)},r.DestroyOldestParticle=function(e,t){void 0===t&&(t=!1);var n=this.GetParticleCount(),i=this.m_indexByExpirationTimeBuffer.data[n-(e+1)],r=this.m_indexByExpirationTimeBuffer.data[e];this.DestroyParticle(this.m_expirationTimeBuffer.data[i]>0?i:r,t)},r.DestroyParticlesInShape=function(e,n,i){void 0===i&&(i=!1);var r=t.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;var o=new fo(this,e,n,i),a=r;return e.ComputeAABB(a,n,0),this.m_world.QueryAABB(o,a),o.Destroyed()},r.CreateParticleGroup=function(e){var i=t.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;var r=i;r.SetPositionAngle(n(e.position,be.ZERO),n(e.angle,0));var o=this.m_count;if(e.shape&&this.CreateParticlesWithShapeForGroup(e.shape,e,r),e.shapes&&this.CreateParticlesWithShapesForGroup(e.shapes,n(e.shapeCount,e.shapes.length),e,r),e.positionData)for(var a=n(e.particleCount,e.positionData.length),s=0;s<a;s++){var c=e.positionData[s];this.CreateParticleForGroup(e,r,c)}var l=this.m_count,u=new Mr(this);u.m_firstIndex=o,u.m_lastIndex=l,u.m_strength=n(e.strength,1),u.m_userData=e.userData,u.m_transform.Copy(r),u.m_prev=null,u.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=u),this.m_groupList=u,++this.m_groupCount;for(var h=o;h<l;h++)this.m_groupBuffer[h]=u;this.SetGroupFlags(u,n(e.groupFlags,0));var _=new _o;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(o,l,_),e.group&&(this.JoinParticleGroups(e.group,u),u=e.group),u},r.JoinParticleGroups=function(e,t){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,this.m_count),this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,t.m_firstIndex);var n=new po(t.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(e.m_firstIndex,t.m_lastIndex,n);for(var i=t.m_firstIndex;i<t.m_lastIndex;i++)this.m_groupBuffer[i]=e;var r=e.m_groupFlags|t.m_groupFlags;this.SetGroupFlags(e,r),e.m_lastIndex=t.m_lastIndex,t.m_firstIndex=t.m_lastIndex,this.DestroyParticleGroup(t)},r.SplitParticleGroup=function(e){this.UpdateContacts(!0);var n=X(e.GetParticleCount(),(function(){return new ao}));t.InitializeParticleLists(e,n),this.MergeParticleListsInContact(e,n);var i=t.FindLongestParticleList(e,n);this.MergeZombieParticleListNodes(e,n,i),this.CreateParticleGroupsFromParticleList(e,n,i),this.UpdatePairsAndTriadsWithParticleList(e,n)},r.GetParticleGroupList=function(){return this.m_groupList},r.GetParticleGroupCount=function(){return this.m_groupCount},r.GetParticleCount=function(){return this.m_count},r.GetMaxParticleCount=function(){return this.m_def.maxCount},r.SetMaxParticleCount=function(e){this.m_def.maxCount=e},r.GetAllParticleFlags=function(){return this.m_allParticleFlags},r.GetAllGroupFlags=function(){return this.m_allGroupFlags},r.SetPaused=function(e){this.m_paused=e},r.GetPaused=function(){return this.m_paused},r.SetDensity=function(e){this.m_def.density=e,this.m_inverseDensity=1/this.m_def.density},r.GetDensity=function(){return this.m_def.density},r.SetGravityScale=function(e){this.m_def.gravityScale=e},r.GetGravityScale=function(){return this.m_def.gravityScale},r.SetDamping=function(e){this.m_def.dampingStrength=e},r.GetDamping=function(){return this.m_def.dampingStrength},r.SetStaticPressureIterations=function(e){this.m_def.staticPressureIterations=e},r.GetStaticPressureIterations=function(){return this.m_def.staticPressureIterations},r.SetRadius=function(e){this.m_particleDiameter=2*e,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter},r.GetRadius=function(){return this.m_particleDiameter/2},r.GetPositionBuffer=function(){return this.m_positionBuffer.data},r.GetVelocityBuffer=function(){return this.m_velocityBuffer.data},r.GetColorBuffer=function(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data},r.GetGroupBuffer=function(){return this.m_groupBuffer},r.GetWeightBuffer=function(){return this.m_weightBuffer},r.GetUserDataBuffer=function(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data},r.GetFlagsBuffer=function(){return this.m_flagsBuffer.data},r.SetParticleFlags=function(t,n){this.m_flagsBuffer.data[t]&~n&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&n&&(n&e.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),n&e.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=n),this.m_flagsBuffer.data[t]=n},r.GetParticleFlags=function(e){return this.m_flagsBuffer.data[e]},r.SetFlagsBuffer=function(e){this.SetUserOverridableBuffer(this.m_flagsBuffer,e)},r.SetPositionBuffer=function(e){if(e instanceof Float32Array){if(e.length%2!=0)throw new Error;for(var t=e.length/2,n=new Array(t),i=0;i<t;++i)n[i]=new be(e.subarray(2*i,2*i+2));e=n}this.SetUserOverridableBuffer(this.m_positionBuffer,e)},r.SetVelocityBuffer=function(e){if(e instanceof Float32Array){if(e.length%2!=0)throw new Error;for(var t=e.length/2,n=new Array(t),i=0;i<t;++i)n[i]=new be(e.subarray(2*i,2*i+2));e=n}this.SetUserOverridableBuffer(this.m_velocityBuffer,e)},r.SetColorBuffer=function(e){if(e instanceof Float32Array){if(e.length%4!=0)throw new Error;for(var t=e.length/4,n=new Array(t),i=0;i<t;++i)n[i]=new Ne(e.subarray(4*i,4*i+4));e=n}this.SetUserOverridableBuffer(this.m_colorBuffer,e)},r.SetUserDataBuffer=function(e){this.SetUserOverridableBuffer(this.m_userDataBuffer,e)},r.GetContacts=function(){return this.m_contactBuffer.data},r.GetContactCount=function(){return this.m_contactBuffer.count},r.GetBodyContacts=function(){return this.m_bodyContactBuffer.data},r.GetBodyContactCount=function(){return this.m_bodyContactBuffer.count},r.GetPairs=function(){return this.m_pairBuffer.data},r.GetPairCount=function(){return this.m_pairBuffer.count},r.GetTriads=function(){return this.m_triadBuffer.data},r.GetTriadCount=function(){return this.m_triadBuffer.count},r.SetStuckThreshold=function(e){this.m_stuckThreshold=e,e>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))},r.GetStuckCandidates=function(){return this.m_stuckParticleBuffer.Data()},r.GetStuckCandidateCount=function(){return this.m_stuckParticleBuffer.GetCount()},r.ComputeCollisionEnergy=function(){for(var e=t.ComputeCollisionEnergy_s_v,n=this.m_velocityBuffer.data,i=0,r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB,c=o.normal,l=be.SubVV(n[s],n[a],e),u=be.DotVV(l,c);u<0&&(i+=u*u)}return.5*this.GetParticleMass()*i},r.SetStrictContactCheck=function(e){this.m_def.strictContactCheck=e},r.GetStrictContactCheck=function(){return this.m_def.strictContactCheck},r.SetParticleLifetime=function(e,t){var n=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),n)for(var i=this.GetParticleCount(),r=0;r<i;++r)this.m_indexByExpirationTimeBuffer.data[r]=r;var o=t/this.m_def.lifetimeGranularity,a=o>0?this.GetQuantizedTimeElapsed()+o:o;a!==this.m_expirationTimeBuffer.data[e]&&(this.m_expirationTimeBuffer.data[e]=a,this.m_expirationTimeBufferRequiresSorting=!0)},r.GetParticleLifetime=function(e){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[e])},r.SetDestructionByAge=function(e){e&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=e},r.GetDestructionByAge=function(){return this.m_def.destroyByAge},r.GetExpirationTimeBuffer=function(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data},r.ExpirationTimeToLifetime=function(e){return(e>0?e-this.GetQuantizedTimeElapsed():e)*this.m_def.lifetimeGranularity},r.GetIndexByExpirationTimeBuffer=function(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data},r.ParticleApplyLinearImpulse=function(e,t){this.ApplyLinearImpulse(e,e+1,t)},r.ApplyLinearImpulse=function(e,t,n){for(var i=this.m_velocityBuffer.data,r=(t-e)*this.GetParticleMass(),o=(new be).Copy(n).SelfMul(1/r),a=e;a<t;a++)i[a].SelfAdd(o)},t.IsSignificantForce=function(e){return 0!==e.x||0!==e.y},r.ParticleApplyForce=function(e,n){t.IsSignificantForce(n)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[e])&&(this.PrepareForceBuffer(),this.m_forceBuffer[e].SelfAdd(n))},r.ApplyForce=function(e,n,i){var r=(new be).Copy(i).SelfMul(1/(n-e));if(t.IsSignificantForce(r)){this.PrepareForceBuffer();for(var o=e;o<n;o++)this.m_forceBuffer[o].SelfAdd(r)}},r.GetNext=function(){return this.m_next},r.QueryAABB=function(e,n){if(0!==this.m_proxyBuffer.count)for(var i=0,r=this.m_proxyBuffer.count,o=Wr(this.m_proxyBuffer.data,i,r,t.computeTag(this.m_inverseDiameter*n.lowerBound.x,this.m_inverseDiameter*n.lowerBound.y),ro.CompareProxyTag),a=qr(this.m_proxyBuffer.data,o,r,t.computeTag(this.m_inverseDiameter*n.upperBound.x,this.m_inverseDiameter*n.upperBound.y),ro.CompareTagProxy),s=this.m_positionBuffer.data,c=o;c<a;++c){var l=this.m_proxyBuffer.data[c].index,u=s[l];if(n.lowerBound.x<u.x&&u.x<n.upperBound.x&&n.lowerBound.y<u.y&&u.y<n.upperBound.y&&!e.ReportParticle(this,l))break}},r.QueryShapeAABB=function(e,n,i,r){void 0===r&&(r=0);var o=t.QueryShapeAABB_s_aabb;n.ComputeAABB(o,i,r),this.QueryAABB(e,o)},r.QueryPointAABB=function(e,n,i){void 0===i&&(i=h);var r=t.QueryPointAABB_s_aabb;r.lowerBound.Set(n.x-i,n.y-i),r.upperBound.Set(n.x+i,n.y+i),this.QueryAABB(e,r)},r.RayCast=function(e,n,i){var r=t.RayCast_s_aabb,o=t.RayCast_s_p,a=t.RayCast_s_v,s=t.RayCast_s_n,c=t.RayCast_s_point;if(0!==this.m_proxyBuffer.count){var l=this.m_positionBuffer.data,u=r;be.MinV(n,i,u.lowerBound),be.MaxV(n,i,u.upperBound);for(var h,_=1,f=be.SubVV(i,n,a),d=be.DotVV(f,f),p=this.GetInsideBoundsEnumerator(u);(h=p.GetNext())>=0;){var m=be.SubVV(n,l[h],o),v=be.DotVV(m,f),g=v*v-d*(be.DotVV(m,m)-this.m_squaredDiameter);if(g>=0){var y=he(g),x=(-v-y)/d;if(x>_)continue;if(x<0&&((x=(-v+y)/d)<0||x>_))continue;var S=be.AddVMulSV(m,x,f,s);if(S.Normalize(),(_=ie(_,e.ReportParticle(this,h,be.AddVMulSV(n,x,f,c),S,x)))<=0)break}}}},r.ComputeAABB=function(e){var t=this.GetParticleCount();e.lowerBound.x=+i,e.lowerBound.y=+i,e.upperBound.x=-i,e.upperBound.y=-i;for(var n=this.m_positionBuffer.data,r=0;r<t;r++){var o=n[r];be.MinV(e.lowerBound,o,e.lowerBound),be.MaxV(e.upperBound,o,e.upperBound)}e.lowerBound.x-=this.m_particleDiameter,e.lowerBound.y-=this.m_particleDiameter,e.upperBound.x+=this.m_particleDiameter,e.upperBound.y+=this.m_particleDiameter},r.FreeBuffer=function(e){null!==e&&(e.length=0)},r.FreeUserOverridableBuffer=function(e){0===e.userSuppliedCapacity&&this.FreeBuffer(e.data,this.m_internalAllocatedCapacity)},r.ReallocateBuffer3=function(e,t,n){if(n<=t)throw new Error;var i=e?e.slice():[];return i.length=n,i},r.ReallocateBuffer5=function(e,t,n,i,r){if(i<=n)throw new Error;if(t&&!(i<=t))throw new Error;return r&&!e||t||(e=this.ReallocateBuffer3(e,n,i)),e},r.ReallocateBuffer4=function(e,t,n,i){return this.ReallocateBuffer5(e.data,e.userSuppliedCapacity,t,n,i)},r.RequestBuffer=function(e){return e||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(N),(e=[]).length=this.m_internalAllocatedCapacity),e},r.ReallocateHandleBuffers=function(e){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,e,!0)},r.ReallocateInternalAllocatedBuffers=function(e){function t(e,t){return t&&e>t?t:e}if(e=t(e,this.m_def.maxCount),e=t(e,this.m_flagsBuffer.userSuppliedCapacity),e=t(e,this.m_positionBuffer.userSuppliedCapacity),e=t(e,this.m_velocityBuffer.userSuppliedCapacity),e=t(e,this.m_colorBuffer.userSuppliedCapacity),e=t(e,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<e){this.ReallocateHandleBuffers(e),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,e,!1);var n=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,e,n),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,e,n),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,e,n),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,e,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,e,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,e,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,e,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,e,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,e,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,e,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,e,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,e,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,e,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,e,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,e,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,e,!1),this.m_internalAllocatedCapacity=e}},r.CreateParticleForGroup=function(e,t,i){var r=new Rr;r.flags=n(e.flags,0),Re.MulXV(t,i,r.position),be.AddVV(n(e.linearVelocity,be.ZERO),be.CrossSV(n(e.angularVelocity,0),be.SubVV(r.position,n(e.position,be.ZERO),be.s_t0),be.s_t0),r.velocity),r.color.Copy(n(e.color,Ne.ZERO)),r.lifetime=n(e.lifetime,0),r.userData=e.userData,this.CreateParticle(r)},r.CreateParticlesStrokeShapeForGroup=function(i,r,o){var a=t.CreateParticlesStrokeShapeForGroup_s_edge,s=t.CreateParticlesStrokeShapeForGroup_s_d,c=t.CreateParticlesStrokeShapeForGroup_s_p,l=n(r.stride,0);0===l&&(l=this.GetParticleStride());for(var u=0,h=i.GetChildCount(),_=0;_<h;_++){var f=null;i.GetType()===e.b2ShapeType.e_edgeShape?f=i:(f=a,i.GetChildEdge(f,_));for(var d=be.SubVV(f.m_vertex2,f.m_vertex1,s),p=d.Length();u<p;){var m=be.AddVMulSV(f.m_vertex1,u/p,d,c);this.CreateParticleForGroup(r,o,m),u+=l}u-=p}},r.CreateParticlesFillShapeForGroup=function(e,i,r){var o=t.CreateParticlesFillShapeForGroup_s_aabb,a=t.CreateParticlesFillShapeForGroup_s_p,s=n(i.stride,0);0===s&&(s=this.GetParticleStride());var c=Re.IDENTITY,l=o;e.ComputeAABB(l,c,0);for(var u=Math.floor(l.lowerBound.y/s)*s;u<l.upperBound.y;u+=s)for(var h=Math.floor(l.lowerBound.x/s)*s;h<l.upperBound.x;h+=s){var _=a.Set(h,u);e.TestPoint(c,_)&&this.CreateParticleForGroup(i,r,_)}},r.CreateParticlesWithShapeForGroup=function(t,n,i){switch(t.GetType()){case e.b2ShapeType.e_edgeShape:case e.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(t,n,i);break;case e.b2ShapeType.e_polygonShape:case e.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(t,n,i)}},r.CreateParticlesWithShapesForGroup=function(e,t,n,i){var r=new mo(e,t);this.CreateParticlesFillShapeForGroup(r,n,i)},r.CloneParticle=function(e,t){var n=new Rr;n.flags=this.m_flagsBuffer.data[e],n.position.Copy(this.m_positionBuffer.data[e]),n.velocity.Copy(this.m_velocityBuffer.data[e]),this.m_colorBuffer.data&&n.color.Copy(this.m_colorBuffer.data[e]),this.m_userDataBuffer.data&&(n.userData=this.m_userDataBuffer.data[e]),n.group=t;var i=this.CreateParticle(n);if(this.m_handleIndexBuffer.data){var r=this.m_handleIndexBuffer.data[e];r&&r.SetIndex(i),this.m_handleIndexBuffer.data[i]=r,this.m_handleIndexBuffer.data[e]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[i]=this.m_lastBodyContactStepBuffer.data[e]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[i]=this.m_bodyContactCountBuffer.data[e]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[i]=this.m_consecutiveContactStepsBuffer.data[e]),this.m_hasForce&&this.m_forceBuffer[i].Copy(this.m_forceBuffer[e]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[i]=this.m_staticPressureBuffer[e]),this.m_depthBuffer&&(this.m_depthBuffer[i]=this.m_depthBuffer[e]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[i]=this.m_expirationTimeBuffer.data[e]),i},r.DestroyParticlesInGroup=function(e,t){void 0===t&&(t=!1);for(var n=e.m_firstIndex;n<e.m_lastIndex;n++)this.DestroyParticle(n,t)},r.DestroyParticleGroup=function(e){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(e),this.SetGroupFlags(e,0);for(var t=e.m_firstIndex;t<e.m_lastIndex;t++)this.m_groupBuffer[t]=null;e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),e===this.m_groupList&&(this.m_groupList=e.m_next),--this.m_groupCount},t.ParticleCanBeConnected=function(t,n){return 0!=(t&(e.b2ParticleFlag.b2_wallParticle|e.b2ParticleFlag.b2_springParticle|e.b2ParticleFlag.b2_elasticParticle))||null!==n&&0!=(n.GetGroupFlags()&e.b2ParticleGroupFlag.b2_rigidParticleGroup)},r.UpdatePairsAndTriads=function(n,i,r){for(var o=t.UpdatePairsAndTriads_s_dab,a=t.UpdatePairsAndTriads_s_dbc,s=t.UpdatePairsAndTriads_s_dca,c=this.m_positionBuffer.data,l=0,u=n;u<i;u++)l|=this.m_flagsBuffer.data[u];if(l&t.k_pairFlags)for(var h=0;h<this.m_contactBuffer.count;h++){var _=this.m_contactBuffer.data[h],f=_.indexA,d=_.indexB,p=this.m_flagsBuffer.data[f],m=this.m_flagsBuffer.data[d],v=this.m_groupBuffer[f],g=this.m_groupBuffer[d];if(f>=n&&f<i&&d>=n&&d<i&&!((p|m)&e.b2ParticleFlag.b2_zombieParticle)&&(p|m)&t.k_pairFlags&&(r.IsNecessary(f)||r.IsNecessary(d))&&t.ParticleCanBeConnected(p,v)&&t.ParticleCanBeConnected(m,g)&&r.ShouldCreatePair(f,d)){var y=this.m_pairBuffer.data[this.m_pairBuffer.Append()];y.indexA=f,y.indexB=d,y.flags=_.flags,y.strength=ie(v?v.m_strength:1,g?g.m_strength:1),y.distance=be.DistanceVV(c[f],c[d])}Hr(this.m_pairBuffer.data,0,this.m_pairBuffer.count,t.ComparePairIndices),this.m_pairBuffer.Unique(t.MatchPairIndices)}if(l&t.k_triadFlags){for(var x=new Fr(i-n),S=n;S<i;S++){var C=this.m_flagsBuffer.data[S],A=this.m_groupBuffer[S];C&e.b2ParticleFlag.b2_zombieParticle||!t.ParticleCanBeConnected(C,A)||x.AddGenerator(c[S],S,r.IsNecessary(S))}var b=this.GetParticleStride();x.Generate(b/2,2*b);var T=this,E=function(e,n,i){var l=T.m_flagsBuffer.data[e],u=T.m_flagsBuffer.data[n],h=T.m_flagsBuffer.data[i];if((l|u|h)&t.k_triadFlags&&r.ShouldCreateTriad(e,n,i)){var _=c[e],f=c[n],d=c[i],p=be.SubVV(_,f,o),m=be.SubVV(f,d,a),v=be.SubVV(d,_,s),g=O*T.m_squaredDiameter;if(be.DotVV(p,p)>g||be.DotVV(m,m)>g||be.DotVV(v,v)>g)return;var y=T.m_groupBuffer[e],x=T.m_groupBuffer[n],S=T.m_groupBuffer[i],C=T.m_triadBuffer.data[T.m_triadBuffer.Append()];C.indexA=e,C.indexB=n,C.indexC=i,C.flags=l|u|h,C.strength=ie(ie(y?y.m_strength:1,x?x.m_strength:1),S?S.m_strength:1);var A=(_.x+f.x+d.x)/3,b=(_.y+f.y+d.y)/3;C.pa.x=_.x-A,C.pa.y=_.y-b,C.pb.x=f.x-A,C.pb.y=f.y-b,C.pc.x=d.x-A,C.pc.y=d.y-b,C.ka=-be.DotVV(v,p),C.kb=-be.DotVV(p,m),C.kc=-be.DotVV(m,v),C.s=be.CrossVV(_,f)+be.CrossVV(f,d)+be.CrossVV(d,_)}};x.GetNodes(E),Hr(this.m_triadBuffer.data,0,this.m_triadBuffer.count,t.CompareTriadIndices),this.m_triadBuffer.Unique(t.MatchTriadIndices)}},r.UpdatePairsAndTriadsWithReactiveParticles=function(){var t=new vo(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,t);for(var n=0;n<this.m_count;n++)this.m_flagsBuffer.data[n]&=~e.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~e.b2ParticleFlag.b2_reactiveParticle},t.ComparePairIndices=function(e,t){var n=e.indexA-t.indexA;return 0!==n?n<0:e.indexB<t.indexB},t.MatchPairIndices=function(e,t){return e.indexA===t.indexA&&e.indexB===t.indexB},t.CompareTriadIndices=function(e,t){var n=e.indexA-t.indexA;if(0!==n)return n<0;var i=e.indexB-t.indexB;return 0!==i?i<0:e.indexC<t.indexC},t.MatchTriadIndices=function(e,t){return e.indexA===t.indexA&&e.indexB===t.indexB&&e.indexC===t.indexC},t.InitializeParticleLists=function(e,t){for(var n=e.GetBufferIndex(),i=e.GetParticleCount(),r=0;r<i;r++){var o=t[r];o.list=o,o.next=null,o.count=1,o.index=r+n}},r.MergeParticleListsInContact=function(e,n){for(var i=e.GetBufferIndex(),r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB;if(e.ContainsParticle(a)&&e.ContainsParticle(s)){var c=n[a-i].list,l=n[s-i].list;if(c!==l){if(c.count<l.count){var u=c;c=l,l=u}t.MergeParticleLists(c,l)}}}},t.MergeParticleLists=function(e,t){for(var n=t;;){n.list=e;var i=n.next;if(!i){n.next=e.next;break}n=i}e.next=t,e.count+=t.count,t.count=0},t.FindLongestParticleList=function(e,t){for(var n=e.GetParticleCount(),i=t[0],r=0;r<n;r++){var o=t[r];i.count<o.count&&(i=o)}return i},r.MergeZombieParticleListNodes=function(n,i,r){for(var o=n.GetParticleCount(),a=0;a<o;a++){var s=i[a];s!==r&&this.m_flagsBuffer.data[s.index]&e.b2ParticleFlag.b2_zombieParticle&&t.MergeParticleListAndNode(r,s)}},t.MergeParticleListAndNode=function(e,t){t.list=e,t.next=e.next,e.next=t,e.count++,t.count=0},r.CreateParticleGroupsFromParticleList=function(t,n,i){var r=t.GetParticleCount(),o=new Br;o.groupFlags=t.GetGroupFlags(),o.userData=t.GetUserData();for(var a=0;a<r;a++){var s=n[a];if(s.count&&s!==i)for(var c=this.CreateParticleGroup(o),l=s;l;l=l.next){var u=l.index,h=this.CloneParticle(u,c);this.m_flagsBuffer.data[u]|=e.b2ParticleFlag.b2_zombieParticle,l.index=h}}},r.UpdatePairsAndTriadsWithParticleList=function(e,t){for(var n=e.GetBufferIndex(),i=0;i<this.m_pairBuffer.count;i++){var r=this.m_pairBuffer.data[i],o=r.indexA,a=r.indexB;e.ContainsParticle(o)&&(r.indexA=t[o-n].index),e.ContainsParticle(a)&&(r.indexB=t[a-n].index)}for(var s=0;s<this.m_triadBuffer.count;s++){var c=this.m_triadBuffer.data[s],l=c.indexA,u=c.indexB,h=c.indexC;e.ContainsParticle(l)&&(c.indexA=t[l-n].index),e.ContainsParticle(u)&&(c.indexB=t[u-n].index),e.ContainsParticle(h)&&(c.indexC=t[h-n].index)}},r.ComputeDepth=function(){for(var t=[],n=0,r=0;r<this.m_contactBuffer.count;r++){var o=this.m_contactBuffer.data[r],a=o.indexA,s=o.indexB,c=this.m_groupBuffer[a],l=this.m_groupBuffer[s];c&&c===l&&c.m_groupFlags&e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(t[n++]=o)}for(var u=[],h=0,_=this.m_groupList;_;_=_.GetNext())if(_.m_groupFlags&e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){u[h++]=_,this.SetGroupFlags(_,_.m_groupFlags&~e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(var f=_.m_firstIndex;f<_.m_lastIndex;f++)this.m_accumulationBuffer[f]=0}for(var d=0;d<n;d++){var p=t[d],m=p.indexA,v=p.indexB,g=p.weight;this.m_accumulationBuffer[m]+=g,this.m_accumulationBuffer[v]+=g}for(var y=0;y<h;y++)for(var x=u[y],S=x.m_firstIndex;S<x.m_lastIndex;S++){var C=this.m_accumulationBuffer[S];this.m_depthBuffer[S]=C<.8?0:i}for(var A=he(this.m_count)>>0,b=0;b<A;b++){for(var T=!1,E=0;E<n;E++){var w=t[E],I=w.indexA,P=w.indexB,R=1-w.weight,D=this.m_depthBuffer[I],O=this.m_depthBuffer[P],N=O+R,B=D+R;D>N&&(this.m_depthBuffer[I]=N,T=!0),O>B&&(this.m_depthBuffer[P]=B,T=!0)}if(!T)break}for(var M=0;M<h;M++)for(var L=u[M],F=L.m_firstIndex;F<L.m_lastIndex;F++)this.m_depthBuffer[F]<i?this.m_depthBuffer[F]*=this.m_particleDiameter:this.m_depthBuffer[F]=0},r.GetInsideBoundsEnumerator=function(e){var n=t.computeTag(this.m_inverseDiameter*e.lowerBound.x-1,this.m_inverseDiameter*e.lowerBound.y-1),i=t.computeTag(this.m_inverseDiameter*e.upperBound.x+1,this.m_inverseDiameter*e.upperBound.y+1),r=0,o=this.m_proxyBuffer.count,a=Wr(this.m_proxyBuffer.data,r,o,n,ro.CompareProxyTag),s=qr(this.m_proxyBuffer.data,r,o,i,ro.CompareTagProxy);return new oo(this,n,i,a,s)},r.UpdateAllParticleFlags=function(){this.m_allParticleFlags=0;for(var e=0;e<this.m_count;e++)this.m_allParticleFlags|=this.m_flagsBuffer.data[e];this.m_needsUpdateAllParticleFlags=!1},r.UpdateAllGroupFlags=function(){this.m_allGroupFlags=0;for(var e=this.m_groupList;e;e=e.GetNext())this.m_allGroupFlags|=e.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1},r.AddContact=function(e,n){var i=this.m_flagsBuffer.data,r=this.m_positionBuffer.data,o=be.SubVV(r[n],r[e],t.AddContact_s_d),a=be.DotVV(o,o);if(0<a&&a<this.m_squaredDiameter){var s=ue(a),c=this.m_contactBuffer.data[this.m_contactBuffer.Append()];c.indexA=e,c.indexB=n,c.flags=i[e]|i[n],c.weight=1-a*s*this.m_inverseDiameter,c.normal.x=s*o.x,c.normal.y=s*o.y}},r.FindContacts_Reference=function(){var e=0,n=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(var i=e,r=e;i<n;i++){for(var o=t.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,0),a=i+1;a<n&&!(o<this.m_proxyBuffer.data[a].tag);a++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[a].index,this.m_contactBuffer);for(var s=t.computeRelativeTag(this.m_proxyBuffer.data[i].tag,-1,1);r<n&&!(s<=this.m_proxyBuffer.data[r].tag);r++);for(var c=t.computeRelativeTag(this.m_proxyBuffer.data[i].tag,1,1),l=r;l<n&&!(c<this.m_proxyBuffer.data[l].tag);l++)this.AddContact(this.m_proxyBuffer.data[i].index,this.m_proxyBuffer.data[l].index,this.m_contactBuffer)}},r.FindContacts=function(e){this.FindContacts_Reference(e)},r.UpdateProxies_Reference=function(){for(var e=this.m_positionBuffer.data,n=this.m_inverseDiameter,i=0;i<this.m_proxyBuffer.count;++i){var r=this.m_proxyBuffer.data[i],o=e[r.index];r.tag=t.computeTag(n*o.x,n*o.y)}},r.UpdateProxies=function(e){this.UpdateProxies_Reference(e)},r.SortProxies=function(){kr(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,ro.CompareProxyProxy)},r.FilterContacts=function(){var t=this.GetParticleContactFilter();if(null!==t){var n=this,i=function(i){return 0!=(i.flags&e.b2ParticleFlag.b2_particleContactFilterParticle)&&!t.ShouldCollideParticleParticle(n,i.indexA,i.indexB)};this.m_contactBuffer.RemoveIf(i)}},r.NotifyContactListenerPreContact=function(e){if(null!==this.GetParticleContactListener())throw e.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error},r.NotifyContactListenerPostContact=function(){var e=this.GetParticleContactListener();if(null!==e){for(var t=0;t<this.m_contactBuffer.count;++t){var n=this.m_contactBuffer.data[t];e.BeginContactParticleParticle(this,n)}throw new Error}},t.b2ParticleContactIsZombie=function(t){return(t.flags&e.b2ParticleFlag.b2_zombieParticle)===e.b2ParticleFlag.b2_zombieParticle},r.UpdateContacts=function(e){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);var n=new ho;this.NotifyContactListenerPreContact(n),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(n),e&&this.m_contactBuffer.RemoveIf(t.b2ParticleContactIsZombie)},r.NotifyBodyContactListenerPreContact=function(e){if(null!==this.GetFixtureContactListener())throw e.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error},r.NotifyBodyContactListenerPostContact=function(){var e=this.GetFixtureContactListener();if(null!==e){for(var t=0;t<this.m_bodyContactBuffer.count;t++){var n=this.m_bodyContactBuffer.data[t];e.BeginContactFixtureParticle(this,n)}throw new Error}},r.UpdateBodyContacts=function(){var e=t.UpdateBodyContacts_s_aabb,n=new lo;if(this.NotifyBodyContactListenerPreContact(n),this.m_stuckThreshold>0)for(var i=this.GetParticleCount(),r=0;r<i;r++)this.m_bodyContactCountBuffer.data[r]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[r]+1&&(this.m_consecutiveContactStepsBuffer.data[r]=0);this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);var o=e;this.ComputeAABB(o),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new go(this));var a=this.UpdateBodyContacts_callback;a.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(a,o),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(n)},r.Solve=function(n){var i=t.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(n),this.m_allParticleFlags&e.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<n.particleIterations;this.m_iterationIndex++){++this.m_timestamp;var r=i.Copy(n);r.dt/=n.particleIterations,r.inv_dt*=n.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&e.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&e.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(r),this.m_allGroupFlags&e.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(r),this.SolvePressure(r),this.SolveDamping(r),this.m_allParticleFlags&t.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&e.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_springParticle&&this.SolveSpring(r),this.LimitVelocity(r),this.m_allGroupFlags&e.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&e.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(r),this.SolveCollision(r),this.m_allGroupFlags&e.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(r),this.m_allParticleFlags&e.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(var o=0;o<this.m_count;o++)this.m_positionBuffer.data[o].SelfMulAdd(r.dt,this.m_velocityBuffer.data[o])}},r.SolveCollision=function(e){var n=t.SolveCollision_s_aabb,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=n;a.lowerBound.x=+i,a.lowerBound.y=+i,a.upperBound.x=-i,a.upperBound.y=-i;for(var s=0;s<this.m_count;s++){var c=o[s],l=r[s],u=l.x+e.dt*c.x,h=l.y+e.dt*c.y;a.lowerBound.x=ie(a.lowerBound.x,ie(l.x,u)),a.lowerBound.y=ie(a.lowerBound.y,ie(l.y,h)),a.upperBound.x=re(a.upperBound.x,re(l.x,u)),a.upperBound.y=re(a.upperBound.y,re(l.y,h))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new yo(this,e));var _=this.SolveCollision_callback;_.m_step=e,this.m_world.QueryAABB(_,a)},r.LimitVelocity=function(e){for(var t=this.m_velocityBuffer.data,n=this.GetCriticalVelocitySquared(e),i=0;i<this.m_count;i++){var r=t[i],o=be.DotVV(r,r);o>n&&r.SelfMul(he(n/o))}},r.SolveGravity=function(e){for(var n=t.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,r=be.MulSV(e.dt*this.m_def.gravityScale,this.m_world.GetGravity(),n),o=0;o<this.m_count;o++)i[o].SelfAdd(r)},r.SolveBarrier=function(n){for(var i=t.SolveBarrier_s_aabb,r=t.SolveBarrier_s_va,o=t.SolveBarrier_s_vb,a=t.SolveBarrier_s_pba,s=t.SolveBarrier_s_vba,c=t.SolveBarrier_s_vc,l=t.SolveBarrier_s_pca,u=t.SolveBarrier_s_vca,h=t.SolveBarrier_s_qba,_=t.SolveBarrier_s_qca,f=t.SolveBarrier_s_dv,d=t.SolveBarrier_s_f,p=this.m_positionBuffer.data,m=this.m_velocityBuffer.data,v=0;v<this.m_count;v++)0!=(this.m_flagsBuffer.data[v]&t.k_barrierWallFlags)&&m[v].SetZero();for(var g=B*n.dt,y=this.GetParticleMass(),x=0;x<this.m_pairBuffer.count;x++){var S=this.m_pairBuffer.data[x];if(S.flags&e.b2ParticleFlag.b2_barrierParticle){var C=S.indexA,A=S.indexB,b=p[C],T=p[A],E=i;be.MinV(b,T,E.lowerBound),be.MaxV(b,T,E.upperBound);for(var w=this.m_groupBuffer[C],I=this.m_groupBuffer[A],P=this.GetLinearVelocity(w,C,b,r),R=this.GetLinearVelocity(I,A,T,o),D=be.SubVV(T,b,a),O=be.SubVV(R,P,s),N=this.GetInsideBoundsEnumerator(E),M=void 0;(M=N.GetNext())>=0;){var L=p[M],F=this.m_groupBuffer[M];if(w!==F&&I!==F){var z=this.GetLinearVelocity(F,M,L,c),V=be.SubVV(L,b,l),G=be.SubVV(z,P,u),U=be.CrossVV(O,G),k=be.CrossVV(D,G)-be.CrossVV(V,O),H=be.CrossVV(D,V),j=void 0,W=void 0,q=h,X=_;if(0===U){if(0===k)continue;if(!((W=-H/k)>=0&&W<g))continue;if(be.AddVMulSV(D,W,O,q),be.AddVMulSV(V,W,G,X),!((j=be.DotVV(q,X)/be.DotVV(q,q))>=0&&j<=1))continue}else{var Y=k*k-4*H*U;if(Y<0)continue;var K=he(Y),J=(-k-K)/(2*U),Q=(-k+K)/(2*U);if(J>Q){var Z=J;J=Q,Q=Z}if(W=J,be.AddVMulSV(D,W,O,q),be.AddVMulSV(V,W,G,X),j=be.DotVV(q,X)/be.DotVV(q,q),!(W>=0&&W<g&&j>=0&&j<=1)){if(!((W=Q)>=0&&W<g))continue;if(be.AddVMulSV(D,W,O,q),be.AddVMulSV(V,W,G,X),!((j=be.DotVV(q,X)/be.DotVV(q,q))>=0&&j<=1))continue}}var $=f;$.x=P.x+j*O.x-z.x,$.y=P.y+j*O.y-z.y;var ee=be.MulSV(y,$,d);if(F&&this.IsRigidGroup(F)){var te=F.GetMass(),ne=F.GetInertia();te>0&&F.m_linearVelocity.SelfMulAdd(1/te,ee),ne>0&&(F.m_angularVelocity+=be.CrossVV(be.SubVV(L,F.GetCenter(),be.s_t0),ee)/ne)}else m[M].SelfAdd($);this.ParticleApplyForce(M,ee.SelfMul(-n.inv_dt))}}}}},r.SolveStaticPressure=function(t){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);for(var n=this.GetCriticalPressure(t),i=this.m_def.staticPressureStrength*n,r=P*n,o=this.m_def.staticPressureRelaxation,a=0;a<this.m_def.staticPressureIterations;a++){for(var s=0;s<this.m_count;s++)this.m_accumulationBuffer[s]=0;for(var c=0;c<this.m_contactBuffer.count;c++){var l=this.m_contactBuffer.data[c];if(l.flags&e.b2ParticleFlag.b2_staticPressureParticle){var u=l.indexA,h=l.indexB,_=l.weight;this.m_accumulationBuffer[u]+=_*this.m_staticPressureBuffer[h],this.m_accumulationBuffer[h]+=_*this.m_staticPressureBuffer[u]}}for(var f=0;f<this.m_count;f++){var d=this.m_weightBuffer[f];if(this.m_flagsBuffer.data[f]&e.b2ParticleFlag.b2_staticPressureParticle){var p=(this.m_accumulationBuffer[f]+i*(d-I))/(d+o);this.m_staticPressureBuffer[f]=oe(p,0,r)}else this.m_staticPressureBuffer[f]=0}}},r.ComputeWeight=function(){for(var e=0;e<this.m_count;e++)this.m_weightBuffer[e]=0;for(var t=0;t<this.m_bodyContactBuffer.count;t++){var n=this.m_bodyContactBuffer.data[t],i=n.index,r=n.weight;this.m_weightBuffer[i]+=r}for(var o=0;o<this.m_contactBuffer.count;o++){var a=this.m_contactBuffer.data[o],s=a.indexA,c=a.indexB,l=a.weight;this.m_weightBuffer[s]+=l,this.m_weightBuffer[c]+=l}},r.SolvePressure=function(n){for(var i=t.SolvePressure_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.GetCriticalPressure(n),s=this.m_def.pressureStrength*a,c=P*a,l=0;l<this.m_count;l++){var u=s*re(0,this.m_weightBuffer[l]-I);this.m_accumulationBuffer[l]=ie(u,c)}if(this.m_allParticleFlags&t.k_noPressureFlags)for(var h=0;h<this.m_count;h++)this.m_flagsBuffer.data[h]&t.k_noPressureFlags&&(this.m_accumulationBuffer[h]=0);if(this.m_allParticleFlags&e.b2ParticleFlag.b2_staticPressureParticle)for(var _=0;_<this.m_count;_++)this.m_flagsBuffer.data[_]&e.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[_]+=this.m_staticPressureBuffer[_]);for(var f=n.dt/(this.m_def.density*this.m_particleDiameter),d=this.GetParticleInvMass(),p=0;p<this.m_bodyContactBuffer.count;p++){var m=this.m_bodyContactBuffer.data[p],v=m.index,g=m.body,y=m.weight,x=m.mass,S=m.normal,C=r[v],A=this.m_accumulationBuffer[v]+s*y,b=be.MulSV(f*y*x*A,S,i);o[v].SelfMulSub(d,b),g.ApplyLinearImpulse(b,C,!0)}for(var T=0;T<this.m_contactBuffer.count;T++){var E=this.m_contactBuffer.data[T],w=E.indexA,R=E.indexB,D=E.weight,O=E.normal,N=this.m_accumulationBuffer[w]+this.m_accumulationBuffer[R],B=be.MulSV(f*D*N,O,i);o[w].SelfSub(B),o[R].SelfAdd(B)}},r.SolveDamping=function(e){for(var n=t.SolveDamping_s_v,i=t.SolveDamping_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.dampingStrength,s=1/this.GetCriticalVelocity(e),c=this.GetParticleInvMass(),l=0;l<this.m_bodyContactBuffer.count;l++){var u=this.m_bodyContactBuffer.data[l],h=u.index,_=u.body,f=u.weight,d=u.mass,p=u.normal,m=r[h],v=be.SubVV(_.GetLinearVelocityFromWorldPoint(m,be.s_t0),o[h],n),g=be.DotVV(v,p);if(g<0){var y=re(a*f,ie(-s*g,.5)),x=be.MulSV(y*d*g,p,i);o[h].SelfMulAdd(c,x),_.ApplyLinearImpulse(x.SelfNeg(),m,!0)}}for(var S=0;S<this.m_contactBuffer.count;S++){var C=this.m_contactBuffer.data[S],A=C.indexA,b=C.indexB,T=C.weight,E=C.normal,w=be.SubVV(o[b],o[A],n),I=be.DotVV(w,E);if(I<0){var P=re(a*T,ie(-s*I,.5)),R=be.MulSV(P*I,E,i);o[A].SelfAdd(R),o[b].SelfSub(R)}}},r.SolveRigidDamping=function(){for(var e=t.SolveRigidDamping_s_t0,n=t.SolveRigidDamping_s_t1,i=t.SolveRigidDamping_s_p,r=t.SolveRigidDamping_s_v,o=[0],a=[0],s=[0],c=[0],l=[0],u=[0],h=this.m_positionBuffer.data,_=this.m_def.dampingStrength,f=0;f<this.m_bodyContactBuffer.count;f++){var d=this.m_bodyContactBuffer.data[f],p=d.index,m=this.m_groupBuffer[p];if(m&&this.IsRigidGroup(m)){var v=d.body,g=d.normal,y=d.weight,x=h[p],S=be.SubVV(v.GetLinearVelocityFromWorldPoint(x,e),m.GetLinearVelocityFromWorldPoint(x,n),r),C=be.DotVV(S,g);if(C<0){this.InitDampingParameterWithRigidGroupOrParticle(o,a,s,!0,m,p,x,g),this.InitDampingParameter(c,l,u,v.GetMass(),v.GetInertia()-v.GetMass()*v.GetLocalCenter().LengthSquared(),v.GetWorldCenter(),x,g);var A=_*ie(y,1)*this.ComputeDampingImpulse(o[0],a[0],s[0],c[0],l[0],u[0],C);this.ApplyDamping(o[0],a[0],s[0],!0,m,p,A,g),v.ApplyLinearImpulse(be.MulSV(-A,g,be.s_t0),x,!0)}}}for(var b=0;b<this.m_contactBuffer.count;b++){var T=this.m_contactBuffer.data[b],E=T.indexA,w=T.indexB,I=T.normal,P=T.weight,R=this.m_groupBuffer[E],D=this.m_groupBuffer[w],O=this.IsRigidGroup(R),N=this.IsRigidGroup(D);if(R!==D&&(O||N)){var B=be.MidVV(h[E],h[w],i),M=be.SubVV(this.GetLinearVelocity(D,w,B,e),this.GetLinearVelocity(R,E,B,n),r),L=be.DotVV(M,I);if(L<0){this.InitDampingParameterWithRigidGroupOrParticle(o,a,s,O,R,E,B,I),this.InitDampingParameterWithRigidGroupOrParticle(c,l,u,N,D,w,B,I);var F=_*P*this.ComputeDampingImpulse(o[0],a[0],s[0],c[0],l[0],u[0],L);this.ApplyDamping(o[0],a[0],s[0],O,R,E,F,I),this.ApplyDamping(c[0],l[0],u[0],N,D,w,-F,I)}}}},r.SolveExtraDamping=function(){for(var e=t.SolveExtraDamping_s_v,n=t.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,r=this.m_positionBuffer.data,o=this.GetParticleInvMass(),a=0;a<this.m_bodyContactBuffer.count;a++){var s=this.m_bodyContactBuffer.data[a],c=s.index;if(this.m_flagsBuffer.data[c]&t.k_extraDampingFlags){var l=s.body,u=s.mass,h=s.normal,_=r[c],f=be.SubVV(l.GetLinearVelocityFromWorldPoint(_,be.s_t0),i[c],e),d=be.DotVV(f,h);if(d<0){var p=be.MulSV(.5*u*d,h,n);i[c].SelfMulAdd(o,p),l.ApplyLinearImpulse(p.SelfNeg(),_,!0)}}}},r.SolveWall=function(){for(var t=this.m_velocityBuffer.data,n=0;n<this.m_count;n++)this.m_flagsBuffer.data[n]&e.b2ParticleFlag.b2_wallParticle&&t[n].SetZero()},r.SolveRigid=function(n){for(var i=t.SolveRigid_s_position,r=t.SolveRigid_s_rotation,o=t.SolveRigid_s_transform,a=t.SolveRigid_s_velocityTransform,s=this.m_positionBuffer.data,c=this.m_velocityBuffer.data,l=this.m_groupList;l;l=l.GetNext())if(l.m_groupFlags&e.b2ParticleGroupFlag.b2_rigidParticleGroup){l.UpdateStatistics();var u=r;u.SetAngle(n.dt*l.m_angularVelocity);var h=be.AddVV(l.m_center,be.SubVV(be.MulSV(n.dt,l.m_linearVelocity,be.s_t0),Pe.MulRV(u,l.m_center,be.s_t1),be.s_t0),i),_=o;_.SetPositionRotation(h,u),Re.MulXX(_,l.m_transform,l.m_transform);var f=a;f.p.x=n.inv_dt*_.p.x,f.p.y=n.inv_dt*_.p.y,f.q.s=n.inv_dt*_.q.s,f.q.c=n.inv_dt*(_.q.c-1);for(var d=l.m_firstIndex;d<l.m_lastIndex;d++)Re.MulXV(f,s[d],c[d])}},r.SolveElastic=function(n){for(var i=t.SolveElastic_s_pa,r=t.SolveElastic_s_pb,o=t.SolveElastic_s_pc,a=t.SolveElastic_s_r,s=t.SolveElastic_s_t0,c=this.m_positionBuffer.data,l=this.m_velocityBuffer.data,u=n.inv_dt*this.m_def.elasticStrength,h=0;h<this.m_triadBuffer.count;h++){var _=this.m_triadBuffer.data[h];if(_.flags&e.b2ParticleFlag.b2_elasticParticle){var f=_.indexA,d=_.indexB,p=_.indexC,m=_.pa,v=_.pb,g=_.pc,y=i.Copy(c[f]),x=r.Copy(c[d]),S=o.Copy(c[p]),C=l[f],A=l[d],b=l[p];y.SelfMulAdd(n.dt,C),x.SelfMulAdd(n.dt,A),S.SelfMulAdd(n.dt,b);var T=(y.x+x.x+S.x)/3,E=(y.y+x.y+S.y)/3;y.x-=T,y.y-=E,x.x-=T,x.y-=E,S.x-=T,S.y-=E;var w=a;w.s=be.CrossVV(m,y)+be.CrossVV(v,x)+be.CrossVV(g,S),w.c=be.DotVV(m,y)+be.DotVV(v,x)+be.DotVV(g,S);var I=ue(w.s*w.s+w.c*w.c);isFinite(I)||(I=198177537e11),w.s*=I,w.c*=I;var P=u*_.strength;Pe.MulRV(w,m,s),be.SubVV(s,y,s),be.MulSV(P,s,s),C.SelfAdd(s),Pe.MulRV(w,v,s),be.SubVV(s,x,s),be.MulSV(P,s,s),A.SelfAdd(s),Pe.MulRV(w,g,s),be.SubVV(s,S,s),be.MulSV(P,s,s),b.SelfAdd(s)}}},r.SolveSpring=function(n){for(var i=t.SolveSpring_s_pa,r=t.SolveSpring_s_pb,o=t.SolveSpring_s_d,a=t.SolveSpring_s_f,s=this.m_positionBuffer.data,c=this.m_velocityBuffer.data,l=n.inv_dt*this.m_def.springStrength,u=0;u<this.m_pairBuffer.count;u++){var h=this.m_pairBuffer.data[u];if(h.flags&e.b2ParticleFlag.b2_springParticle){var _=h.indexA,f=h.indexB,d=i.Copy(s[_]),p=r.Copy(s[f]),m=c[_],v=c[f];d.SelfMulAdd(n.dt,m),p.SelfMulAdd(n.dt,v);var g=be.SubVV(p,d,o),y=h.distance,x=g.Length(),S=l*h.strength,C=be.MulSV(S*(y-x)/x,g,a);m.SelfSub(C),v.SelfAdd(C)}}},r.SolveTensile=function(n){for(var i=t.SolveTensile_s_weightedNormal,r=t.SolveTensile_s_s,o=t.SolveTensile_s_f,a=this.m_velocityBuffer.data,s=0;s<this.m_count;s++)this.m_accumulation2Buffer[s]=new be,this.m_accumulation2Buffer[s].SetZero();for(var c=0;c<this.m_contactBuffer.count;c++){var l=this.m_contactBuffer.data[c];if(l.flags&e.b2ParticleFlag.b2_tensileParticle){var u=l.indexA,h=l.indexB,_=l.weight,f=l.normal,d=be.MulSV((1-_)*_,f,i);this.m_accumulation2Buffer[u].SelfSub(d),this.m_accumulation2Buffer[h].SelfAdd(d)}}for(var p=this.GetCriticalVelocity(n),m=this.m_def.surfaceTensionPressureStrength*p,v=this.m_def.surfaceTensionNormalStrength*p,g=R*p,y=0;y<this.m_contactBuffer.count;y++){var x=this.m_contactBuffer.data[y];if(x.flags&e.b2ParticleFlag.b2_tensileParticle){var S=x.indexA,C=x.indexB,A=x.weight,b=x.normal,T=this.m_weightBuffer[S]+this.m_weightBuffer[C],E=be.SubVV(this.m_accumulation2Buffer[C],this.m_accumulation2Buffer[S],r),w=ie(m*(T-2)+v*be.DotVV(E,b),g)*A,I=be.MulSV(w,b,o);a[S].SelfSub(I),a[C].SelfAdd(I)}}},r.SolveViscous=function(){for(var n=t.SolveViscous_s_v,i=t.SolveViscous_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.viscousStrength,s=this.GetParticleInvMass(),c=0;c<this.m_bodyContactBuffer.count;c++){var l=this.m_bodyContactBuffer.data[c],u=l.index;if(this.m_flagsBuffer.data[u]&e.b2ParticleFlag.b2_viscousParticle){var h=l.body,_=l.weight,f=l.mass,d=r[u],p=be.SubVV(h.GetLinearVelocityFromWorldPoint(d,be.s_t0),o[u],n),m=be.MulSV(a*f*_,p,i);o[u].SelfMulAdd(s,m),h.ApplyLinearImpulse(m.SelfNeg(),d,!0)}}for(var v=0;v<this.m_contactBuffer.count;v++){var g=this.m_contactBuffer.data[v];if(g.flags&e.b2ParticleFlag.b2_viscousParticle){var y=g.indexA,x=g.indexB,S=g.weight,C=be.SubVV(o[x],o[y],n),A=be.MulSV(a*S,C,i);o[y].SelfAdd(A),o[x].SelfSub(A)}}},r.SolveRepulsive=function(n){for(var i=t.SolveRepulsive_s_f,r=this.m_velocityBuffer.data,o=this.m_def.repulsiveStrength*this.GetCriticalVelocity(n),a=0;a<this.m_contactBuffer.count;a++){var s=this.m_contactBuffer.data[a];if(s.flags&e.b2ParticleFlag.b2_repulsiveParticle){var c=s.indexA,l=s.indexB;if(this.m_groupBuffer[c]!==this.m_groupBuffer[l]){var u=s.weight,h=s.normal,_=be.MulSV(o*u,h,i);r[c].SelfSub(_),r[l].SelfAdd(_)}}}},r.SolvePowder=function(n){for(var i=t.SolvePowder_s_f,r=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,a=this.m_def.powderStrength*this.GetCriticalVelocity(n),s=1-w,c=this.GetParticleInvMass(),l=0;l<this.m_bodyContactBuffer.count;l++){var u=this.m_bodyContactBuffer.data[l],h=u.index;if(this.m_flagsBuffer.data[h]&e.b2ParticleFlag.b2_powderParticle){var _=u.weight;if(_>s){var f=u.body,d=u.mass,p=r[h],m=u.normal,v=be.MulSV(a*d*(_-s),m,i);o[h].SelfMulSub(c,v),f.ApplyLinearImpulse(v,p,!0)}}}for(var g=0;g<this.m_contactBuffer.count;g++){var y=this.m_contactBuffer.data[g];if(y.flags&e.b2ParticleFlag.b2_powderParticle){var x=y.weight;if(x>s){var S=y.indexA,C=y.indexB,A=y.normal,b=be.MulSV(a*(x-s),A,i);o[S].SelfSub(b),o[C].SelfAdd(b)}}}},r.SolveSolid=function(e){var n=t.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);for(var r=e.inv_dt*this.m_def.ejectionStrength,o=0;o<this.m_contactBuffer.count;o++){var a=this.m_contactBuffer.data[o],s=a.indexA,c=a.indexB;if(this.m_groupBuffer[s]!==this.m_groupBuffer[c]){var l=a.weight,u=a.normal,h=this.m_depthBuffer[s]+this.m_depthBuffer[c],_=be.MulSV(r*h*l,u,n);i[s].SelfSub(_),i[c].SelfAdd(_)}}},r.SolveForce=function(e){for(var t=this.m_velocityBuffer.data,n=e.dt*this.GetParticleInvMass(),i=0;i<this.m_count;i++)t[i].SelfMulAdd(n,this.m_forceBuffer[i]);this.m_hasForce=!1},r.SolveColorMixing=function(){var t=.5*this.m_def.colorMixingStrength;if(t)for(var n=0;n<this.m_contactBuffer.count;n++){var i=this.m_contactBuffer.data[n],r=i.indexA,o=i.indexB;if(this.m_flagsBuffer.data[r]&this.m_flagsBuffer.data[o]&e.b2ParticleFlag.b2_colorMixingParticle){var a=this.m_colorBuffer.data[r],s=this.m_colorBuffer.data[o];Ne.MixColors(a,s,t)}}},r.SolveZombie=function(){for(var t=0,n=[],i=0;i<this.m_count;i++)n[i]=T;for(var r=0,o=0;o<this.m_count;o++){var a=this.m_flagsBuffer.data[o];if(a&e.b2ParticleFlag.b2_zombieParticle){var s=this.m_world.m_destructionListener;if(a&e.b2ParticleFlag.b2_destructionListenerParticle&&s&&s.SayGoodbyeParticle(this,o),this.m_handleIndexBuffer.data){var c=this.m_handleIndexBuffer.data[o];c&&(c.SetIndex(T),this.m_handleIndexBuffer.data[o]=null)}n[o]=T}else{if(n[o]=t,o!==t){if(this.m_handleIndexBuffer.data){var l=this.m_handleIndexBuffer.data[o];l&&l.SetIndex(t),this.m_handleIndexBuffer.data[t]=l}this.m_flagsBuffer.data[t]=this.m_flagsBuffer.data[o],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[t]=this.m_lastBodyContactStepBuffer.data[o]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[t]=this.m_bodyContactCountBuffer.data[o]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[t]=this.m_consecutiveContactStepsBuffer.data[o]),this.m_positionBuffer.data[t].Copy(this.m_positionBuffer.data[o]),this.m_velocityBuffer.data[t].Copy(this.m_velocityBuffer.data[o]),this.m_groupBuffer[t]=this.m_groupBuffer[o],this.m_hasForce&&this.m_forceBuffer[t].Copy(this.m_forceBuffer[o]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[t]=this.m_staticPressureBuffer[o]),this.m_depthBuffer&&(this.m_depthBuffer[t]=this.m_depthBuffer[o]),this.m_colorBuffer.data&&this.m_colorBuffer.data[t].Copy(this.m_colorBuffer.data[o]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[t]=this.m_userDataBuffer.data[o]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[t]=this.m_expirationTimeBuffer.data[o])}t++,r|=a}}for(var u={IsProxyInvalid:function(e){return e.index<0},IsContactInvalid:function(e){return e.indexA<0||e.indexB<0},IsBodyContactInvalid:function(e){return e.index<0},IsPairInvalid:function(e){return e.indexA<0||e.indexB<0},IsTriadInvalid:function(e){return e.indexA<0||e.indexB<0||e.indexC<0}},h=0;h<this.m_proxyBuffer.count;h++){var _=this.m_proxyBuffer.data[h];_.index=n[_.index]}this.m_proxyBuffer.RemoveIf(u.IsProxyInvalid);for(var f=0;f<this.m_contactBuffer.count;f++){var d=this.m_contactBuffer.data[f];d.indexA=n[d.indexA],d.indexB=n[d.indexB]}this.m_contactBuffer.RemoveIf(u.IsContactInvalid);for(var p=0;p<this.m_bodyContactBuffer.count;p++){var m=this.m_bodyContactBuffer.data[p];m.index=n[m.index]}this.m_bodyContactBuffer.RemoveIf(u.IsBodyContactInvalid);for(var v=0;v<this.m_pairBuffer.count;v++){var g=this.m_pairBuffer.data[v];g.indexA=n[g.indexA],g.indexB=n[g.indexB]}this.m_pairBuffer.RemoveIf(u.IsPairInvalid);for(var y=0;y<this.m_triadBuffer.count;y++){var x=this.m_triadBuffer.data[y];x.indexA=n[x.indexA],x.indexB=n[x.indexB],x.indexC=n[x.indexC]}if(this.m_triadBuffer.RemoveIf(u.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data)for(var S=0,C=0;C<this.m_count;C++){var A=n[this.m_indexByExpirationTimeBuffer.data[C]];A!==T&&(this.m_indexByExpirationTimeBuffer.data[S++]=A)}for(var b=this.m_groupList;b;b=b.GetNext()){for(var E=t,w=0,I=!1,P=b.m_firstIndex;P<b.m_lastIndex;P++){var R=n[P];R>=0?(E=ie(E,R),w=re(w,R+1)):I=!0}E<w?(b.m_firstIndex=E,b.m_lastIndex=w,I&&b.m_groupFlags&e.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(b,b.m_groupFlags|e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(b.m_firstIndex=0,b.m_lastIndex=0,b.m_groupFlags&e.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(b,b.m_groupFlags|e.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=t,this.m_allParticleFlags=r,this.m_needsUpdateAllParticleFlags=!1;for(var D=this.m_groupList;D;){var O=D.GetNext();D.m_groupFlags&e.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(D),D=O}},r.SolveLifetimes=function(e){this.m_timeElapsed=this.LifetimeToExpirationTime(e.dt);var t=this.GetQuantizedTimeElapsed(),n=this.m_expirationTimeBuffer.data,i=this.m_indexByExpirationTimeBuffer.data,r=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(kr(i,0,r,(function(e,t){var i=n[e],r=n[t],o=i<=0;return o===r<=0?i>r:o})),this.m_expirationTimeBufferRequiresSorting=!1);for(var o=r-1;o>=0;--o){var a=i[o],s=n[a];if(t<s||s<=0)break;this.DestroyParticle(a)}},r.RotateBuffer=function(e,t,n){if(e!==t&&t!==n){if(Xr(this.m_flagsBuffer.data,e,t,n),this.m_lastBodyContactStepBuffer.data&&Xr(this.m_lastBodyContactStepBuffer.data,e,t,n),this.m_bodyContactCountBuffer.data&&Xr(this.m_bodyContactCountBuffer.data,e,t,n),this.m_consecutiveContactStepsBuffer.data&&Xr(this.m_consecutiveContactStepsBuffer.data,e,t,n),Xr(this.m_positionBuffer.data,e,t,n),Xr(this.m_velocityBuffer.data,e,t,n),Xr(this.m_groupBuffer,e,t,n),this.m_hasForce&&Xr(this.m_forceBuffer,e,t,n),this.m_staticPressureBuffer&&Xr(this.m_staticPressureBuffer,e,t,n),this.m_depthBuffer&&Xr(this.m_depthBuffer,e,t,n),this.m_colorBuffer.data&&Xr(this.m_colorBuffer.data,e,t,n),this.m_userDataBuffer.data&&Xr(this.m_userDataBuffer.data,e,t,n),this.m_handleIndexBuffer.data){Xr(this.m_handleIndexBuffer.data,e,t,n);for(var i=e;i<n;++i){var r=this.m_handleIndexBuffer.data[i];r&&r.SetIndex(y(r.GetIndex()))}}if(this.m_expirationTimeBuffer.data){Xr(this.m_expirationTimeBuffer.data,e,t,n);for(var o=this.GetParticleCount(),a=this.m_indexByExpirationTimeBuffer.data,s=0;s<o;++s)a[s]=y(a[s])}for(var c=0;c<this.m_proxyBuffer.count;c++){var l=this.m_proxyBuffer.data[c];l.index=y(l.index)}for(var u=0;u<this.m_contactBuffer.count;u++){var h=this.m_contactBuffer.data[u];h.indexA=y(h.indexA),h.indexB=y(h.indexB)}for(var _=0;_<this.m_bodyContactBuffer.count;_++){var f=this.m_bodyContactBuffer.data[_];f.index=y(f.index)}for(var d=0;d<this.m_pairBuffer.count;d++){var p=this.m_pairBuffer.data[d];p.indexA=y(p.indexA),p.indexB=y(p.indexB)}for(var m=0;m<this.m_triadBuffer.count;m++){var v=this.m_triadBuffer.data[m];v.indexA=y(v.indexA),v.indexB=y(v.indexB),v.indexC=y(v.indexC)}for(var g=this.m_groupList;g;g=g.GetNext())g.m_firstIndex=y(g.m_firstIndex),g.m_lastIndex=y(g.m_lastIndex-1)+1}function y(i){return i<e?i:i<t?i+n-t:i<n?i+e-t:i}},r.GetCriticalVelocity=function(e){return this.m_particleDiameter*e.inv_dt},r.GetCriticalVelocitySquared=function(e){var t=this.GetCriticalVelocity(e);return t*t},r.GetCriticalPressure=function(e){return this.m_def.density*this.GetCriticalVelocitySquared(e)},r.GetParticleStride=function(){return w*this.m_particleDiameter},r.GetParticleMass=function(){var e=this.GetParticleStride();return this.m_def.density*e*e},r.GetParticleInvMass=function(){var e=this.m_inverseDiameter*(1/w);return this.m_inverseDensity*e*e},r.GetFixtureContactFilter=function(){return this.m_allParticleFlags&e.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},r.GetParticleContactFilter=function(){return this.m_allParticleFlags&e.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null},r.GetFixtureContactListener=function(){return this.m_allParticleFlags&e.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},r.GetParticleContactListener=function(){return this.m_allParticleFlags&e.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null},r.SetUserOverridableBuffer=function(e,t){e.data=t,e.userSuppliedCapacity=t.length},r.SetGroupFlags=function(t,n){var i=t.m_groupFlags;(i^n)&e.b2ParticleGroupFlag.b2_solidParticleGroup&&(n|=e.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),i&~n&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&n&&(n&e.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=n),t.m_groupFlags=n},t.BodyContactCompare=function(e,t){return e.index===t.index?e.weight>t.weight:e.index<t.index},r.RemoveSpuriousBodyContacts=function(){kr(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,t.BodyContactCompare);var e=t.RemoveSpuriousBodyContacts_s_n,n=t.RemoveSpuriousBodyContacts_s_pos,i=t.RemoveSpuriousBodyContacts_s_normal,r=3,o=this,a=-1,s=0,c=function(t){if(t.index!==a&&(s=0,a=t.index),s++>r)return!0;var c=e.Copy(t.normal);c.SelfMul(o.m_particleDiameter*(1-t.weight));var l=be.AddVV(o.m_positionBuffer.data[t.index],c,n);if(!t.fixture.TestPoint(l)){for(var u=t.fixture.GetShape().GetChildCount(),_=0;_<u;_++){var f=i;if(t.fixture.ComputeDistance(l,f,_)<h)return!1}return!0}return!1};this.m_bodyContactBuffer.count=jr(this.m_bodyContactBuffer.data,c,this.m_bodyContactBuffer.count)},r.DetectStuckParticle=function(e){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[e],2===this.m_bodyContactCountBuffer.data[e]&&(++this.m_consecutiveContactStepsBuffer.data[e],this.m_consecutiveContactStepsBuffer.data[e]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=e)),this.m_lastBodyContactStepBuffer.data[e]=this.m_timestamp)},r.ValidateParticleIndex=function(e){return e>=0&&e<this.GetParticleCount()&&e!==T},r.GetQuantizedTimeElapsed=function(){return Math.floor(this.m_timeElapsed/4294967296)},r.LifetimeToExpirationTime=function(e){return this.m_timeElapsed+Math.floor(e/this.m_def.lifetimeGranularity*4294967296)},r.ForceCanBeApplied=function(t){return!(t&e.b2ParticleFlag.b2_wallParticle)},r.PrepareForceBuffer=function(){if(!this.m_hasForce){for(var e=0;e<this.m_count;e++)this.m_forceBuffer[e].SetZero();this.m_hasForce=!0}},r.IsRigidGroup=function(t){return null!==t&&0!=(t.m_groupFlags&e.b2ParticleGroupFlag.b2_rigidParticleGroup)},r.GetLinearVelocity=function(e,t,n,i){return e&&this.IsRigidGroup(e)?e.GetLinearVelocityFromWorldPoint(n,i):i.Copy(this.m_velocityBuffer.data[t])},r.InitDampingParameter=function(e,t,n,i,r,o,a,s){e[0]=i>0?1/i:0,t[0]=r>0?1/r:0,n[0]=be.CrossVV(be.SubVV(a,o,be.s_t0),s)},r.InitDampingParameterWithRigidGroupOrParticle=function(t,n,i,r,o,a,s,c){if(o&&r)this.InitDampingParameter(t,n,i,o.GetMass(),o.GetInertia(),o.GetCenter(),s,c);else{var l=this.m_flagsBuffer.data[a];this.InitDampingParameter(t,n,i,l&e.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,s,s,c)}},r.ComputeDampingImpulse=function(e,t,n,i,r,o,a){var s=e+t*n*n+i+r*o*o;return s>0?a/s:0},r.ApplyDamping=function(e,t,n,i,r,o,a,s){r&&i?(r.m_linearVelocity.SelfMulAdd(a*e,s),r.m_angularVelocity+=a*n*t):this.m_velocityBuffer.data[o].SelfMulAdd(a*e,s)},t}();no.xTruncBits=12,no.yTruncBits=12,no.tagBits=32,no.yOffset=1<<no.yTruncBits-1,no.yShift=no.tagBits-no.yTruncBits,no.xShift=no.tagBits-no.yTruncBits-no.xTruncBits,no.xScale=1<<no.xShift,no.xOffset=no.xScale*(1<<no.xTruncBits-1),no.yMask=(1<<no.yTruncBits)-1<<no.yShift,no.xMask=~no.yMask,no.DestroyParticlesInShape_s_aabb=new Tt,no.CreateParticleGroup_s_transform=new Re,no.ComputeCollisionEnergy_s_v=new be,no.QueryShapeAABB_s_aabb=new Tt,no.QueryPointAABB_s_aabb=new Tt,no.RayCast_s_aabb=new Tt,no.RayCast_s_p=new be,no.RayCast_s_v=new be,no.RayCast_s_n=new be,no.RayCast_s_point=new be,no.k_pairFlags=e.b2ParticleFlag.b2_springParticle,no.k_triadFlags=e.b2ParticleFlag.b2_elasticParticle,no.k_noPressureFlags=e.b2ParticleFlag.b2_powderParticle|e.b2ParticleFlag.b2_tensileParticle,no.k_extraDampingFlags=e.b2ParticleFlag.b2_staticPressureParticle,no.k_barrierWallFlags=e.b2ParticleFlag.b2_barrierParticle|e.b2ParticleFlag.b2_wallParticle,no.CreateParticlesStrokeShapeForGroup_s_edge=new ui,no.CreateParticlesStrokeShapeForGroup_s_d=new be,no.CreateParticlesStrokeShapeForGroup_s_p=new be,no.CreateParticlesFillShapeForGroup_s_aabb=new Tt,no.CreateParticlesFillShapeForGroup_s_p=new be,no.UpdatePairsAndTriads_s_dab=new be,no.UpdatePairsAndTriads_s_dbc=new be,no.UpdatePairsAndTriads_s_dca=new be,no.AddContact_s_d=new be,no.UpdateBodyContacts_s_aabb=new Tt,no.Solve_s_subStep=new vr,no.SolveCollision_s_aabb=new Tt,no.SolveGravity_s_gravity=new be,no.SolveBarrier_s_aabb=new Tt,no.SolveBarrier_s_va=new be,no.SolveBarrier_s_vb=new be,no.SolveBarrier_s_pba=new be,no.SolveBarrier_s_vba=new be,no.SolveBarrier_s_vc=new be,no.SolveBarrier_s_pca=new be,no.SolveBarrier_s_vca=new be,no.SolveBarrier_s_qba=new be,no.SolveBarrier_s_qca=new be,no.SolveBarrier_s_dv=new be,no.SolveBarrier_s_f=new be,no.SolvePressure_s_f=new be,no.SolveDamping_s_v=new be,no.SolveDamping_s_f=new be,no.SolveRigidDamping_s_t0=new be,no.SolveRigidDamping_s_t1=new be,no.SolveRigidDamping_s_p=new be,no.SolveRigidDamping_s_v=new be,no.SolveExtraDamping_s_v=new be,no.SolveExtraDamping_s_f=new be,no.SolveRigid_s_position=new be,no.SolveRigid_s_rotation=new Pe,no.SolveRigid_s_transform=new Re,no.SolveRigid_s_velocityTransform=new Re,no.SolveElastic_s_pa=new be,no.SolveElastic_s_pb=new be,no.SolveElastic_s_pc=new be,no.SolveElastic_s_r=new Pe,no.SolveElastic_s_t0=new be,no.SolveSpring_s_pa=new be,no.SolveSpring_s_pb=new be,no.SolveSpring_s_d=new be,no.SolveSpring_s_f=new be,no.SolveTensile_s_weightedNormal=new be,no.SolveTensile_s_s=new be,no.SolveTensile_s_f=new be,no.SolveViscous_s_v=new be,no.SolveViscous_s_f=new be,no.SolveRepulsive_s_f=new be,no.SolvePowder_s_f=new be,no.SolveSolid_s_f=new be,no.RemoveSpuriousBodyContacts_s_n=new be,no.RemoveSpuriousBodyContacts_s_pos=new be,no.RemoveSpuriousBodyContacts_s_normal=new be;var io=function(){function e(){this._data=null,this.userSuppliedCapacity=0}return J(e,[{key:"data",get:function(){return this._data},set:function(e){this._data=e}}]),e}(),ro=function(){function e(){this.index=T,this.tag=0}return e.CompareProxyProxy=function(e,t){return e.tag<t.tag},e.CompareTagProxy=function(e,t){return e<t.tag},e.CompareProxyTag=function(e,t){return e.tag<t},e}(),oo=function(){function e(e,t,n,i,r){this.m_system=e,this.m_xLower=(t&no.xMask)>>>0,this.m_xUpper=(n&no.xMask)>>>0,this.m_yLower=(t&no.yMask)>>>0,this.m_yUpper=(n&no.yMask)>>>0,this.m_first=i,this.m_last=r}return e.prototype.GetNext=function(){for(;this.m_first<this.m_last;){var e=(this.m_system.m_proxyBuffer.data[this.m_first].tag&no.xMask)>>>0;if(e>=this.m_xLower&&e<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return T},e}(),ao=function(){this.next=null,this.count=0,this.index=0},so=function(){function e(){}var t=e.prototype;return t.Allocate=function(e,t){return t},t.Clear=function(){},t.GetCount=function(){return 0},t.Invalidate=function(){},t.GetValidBuffer=function(){return[]},t.GetBuffer=function(){return[]},t.SetCount=function(){},e}(),co=function(e,t){this.second=T,this.first=e,this.second=t},lo=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.Initialize=function(){},n.Find=function(){return T},t}(so),uo=function(e,t){this.first=T,this.second=T,this.first=e,this.second=t},ho=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.Initialize=function(){},n.Find=function(){return T},t}(so),_o=function(){function e(){}var t=e.prototype;return t.IsNecessary=function(){return!0},t.ShouldCreatePair=function(){return!0},t.ShouldCreateTriad=function(){return!0},e}(),fo=function(e){function t(t,n,i,r){var o;return(o=e.call(this)||this).m_callDestructionListener=!1,o.m_destroyed=0,o.m_system=t,o.m_shape=n,o.m_xf=i,o.m_callDestructionListener=r,o.m_destroyed=0,o}Z(t,e);var n=t.prototype;return n.ReportFixture=function(){return!1},n.ReportParticle=function(e,t){return e===this.m_system&&(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[t])&&(this.m_system.DestroyParticle(t,this.m_callDestructionListener),this.m_destroyed++),!0)},n.Destroyed=function(){return this.m_destroyed},t}(fr),po=function(e){function t(t){var n;return(n=e.call(this)||this).m_threshold=0,n.m_threshold=t,n}Z(t,e);var n=t.prototype;return n.ShouldCreatePair=function(e,t){return e<this.m_threshold&&this.m_threshold<=t||t<this.m_threshold&&this.m_threshold<=e},n.ShouldCreateTriad=function(e,t,n){return(e<this.m_threshold||t<this.m_threshold||n<this.m_threshold)&&(this.m_threshold<=e||this.m_threshold<=t||this.m_threshold<=n)},t}(_o),mo=function(t){function n(n,i){var r;return void 0===i&&(i=n.length),(r=t.call(this,e.b2ShapeType.e_unknown,0)||this).m_shapeCount=0,r.m_shapes=n,r.m_shapeCount=i,r}Z(n,t);var r=n.prototype;return r.Clone=function(){throw new Error},r.GetChildCount=function(){return 1},r.TestPoint=function(e,t){for(var n=0;n<this.m_shapeCount;n++)if(this.m_shapes[n].TestPoint(e,t))return!0;return!1},r.ComputeDistance=function(){return 0},r.RayCast=function(){return!1},r.ComputeAABB=function(e,t){var n=new Tt;e.lowerBound.x=+i,e.lowerBound.y=+i,e.upperBound.x=-i,e.upperBound.y=-i;for(var r=0;r<this.m_shapeCount;r++)for(var o=this.m_shapes[r].GetChildCount(),a=0;a<o;a++){var s=n;this.m_shapes[r].ComputeAABB(s,t,a),e.Combine1(s)}},r.ComputeMass=function(){},r.SetupDistanceProxy=function(){},r.ComputeSubmergedArea=function(){return 0},r.Dump=function(){},n}(si),vo=function(t){function n(e){var n;return(n=t.call(this)||this).m_flagsBuffer=e,n}return Z(n,t),n.prototype.IsNecessary=function(t){return 0!=(this.m_flagsBuffer.data[t]&e.b2ParticleFlag.b2_reactiveParticle)},n}(_o),go=function(t){function n(e,n){var i;return void 0===n&&(n=null),(i=t.call(this,e)||this).m_contactFilter=null,i.m_contactFilter=n,i}Z(n,t);var i=n.prototype;return i.ShouldCollideFixtureParticle=function(t,n,i){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[i]&e.b2ParticleFlag.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(t,this.m_system,i)},i.ReportFixtureAndParticle=function(t,i,r){var o=n.ReportFixtureAndParticle_s_n,a=n.ReportFixtureAndParticle_s_rp,s=this.m_system.m_positionBuffer.data[r],c=o,l=t.ComputeDistance(s,c,i);if(l<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(t,this.m_system,r)){var u=t.GetBody(),h=u.GetWorldCenter(),_=u.GetMass(),f=u.GetInertia()-_*u.GetLocalCenter().LengthSquared(),d=_>0?1/_:0,p=f>0?1/f:0,m=this.m_system.m_flagsBuffer.data[r]&e.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),v=be.SubVV(s,h,a),g=be.CrossVV(v,c),y=m+d+p*g*g,x=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];x.index=r,x.body=u,x.fixture=t,x.weight=1-l*this.m_system.m_inverseDiameter,x.normal.Copy(c.SelfNeg()),x.mass=y>0?1/y:0,this.m_system.DetectStuckParticle(r)}},n}(Jr);go.ReportFixtureAndParticle_s_n=new be,go.ReportFixtureAndParticle_s_rp=new be;var yo=function(t){function n(e,n){var i;return(i=t.call(this,e)||this).m_step=n,i}Z(n,t);var i=n.prototype;return i.ReportFixtureAndParticle=function(t,i,r){var o=n.ReportFixtureAndParticle_s_p1,a=n.ReportFixtureAndParticle_s_output,s=n.ReportFixtureAndParticle_s_input,c=n.ReportFixtureAndParticle_s_p,l=n.ReportFixtureAndParticle_s_v,u=n.ReportFixtureAndParticle_s_f,_=t.GetBody(),f=this.m_system.m_positionBuffer.data[r],d=this.m_system.m_velocityBuffer.data[r],p=a,m=s;if(0===this.m_system.m_iterationIndex){var v=Re.MulTXV(_.m_xf0,f,o);t.GetShape().GetType()===e.b2ShapeType.e_circleShape&&(v.SelfSub(_.GetLocalCenter()),Pe.MulRV(_.m_xf0.q,v,v),Pe.MulTRV(_.m_xf.q,v,v),v.SelfAdd(_.GetLocalCenter())),Re.MulXV(_.m_xf,v,m.p1)}else m.p1.Copy(f);if(be.AddVMulSV(f,this.m_step.dt,d,m.p2),m.maxFraction=1,t.RayCast(p,m,i)){var g=p.normal,y=c;y.x=(1-p.fraction)*m.p1.x+p.fraction*m.p2.x+h*g.x,y.y=(1-p.fraction)*m.p1.y+p.fraction*m.p2.y+h*g.y;var x=l;x.x=this.m_step.inv_dt*(y.x-f.x),x.y=this.m_step.inv_dt*(y.y-f.y),this.m_system.m_velocityBuffer.data[r].Copy(x);var S=u;S.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(d.x-x.x),S.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(d.y-x.y),this.m_system.ParticleApplyForce(r,S)}},i.ReportParticle=function(){return!1},n}(Jr);yo.ReportFixtureAndParticle_s_p1=new be,yo.ReportFixtureAndParticle_s_output=new bt,yo.ReportFixtureAndParticle_s_input=new At,yo.ReportFixtureAndParticle_s_p=new be,yo.ReportFixtureAndParticle_s_v=new be,yo.ReportFixtureAndParticle_s_f=new be;var xo=function(){function t(e){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new pr,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new be,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new mr,this.m_island=new Pr,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(e)}var n=t.prototype;return n.SetDestructionListener=function(e){this.m_destructionListener=e},n.SetContactFilter=function(e){this.m_contactManager.m_contactFilter=e},n.SetContactListener=function(e){this.m_contactManager.m_contactListener=e},n.SetDebugDraw=function(e){this.m_debugDraw=e},n.CreateBody=function(e){if(void 0===e&&(e={}),this.IsLocked())throw new Error;var t=new xi(e,this);return t.m_prev=null,t.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=t),this.m_bodyList=t,++this.m_bodyCount,t},n.DestroyBody=function(e){if(this.IsLocked())throw new Error;for(var t=e.m_jointList;t;){var n=t;t=t.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(n.joint),this.DestroyJoint(n.joint),e.m_jointList=t}e.m_jointList=null;for(var i=e.m_controllerList;i;){var r=i;i=i.nextController,r.controller.RemoveBody(e)}for(var o=e.m_contactList;o;){var a=o;o=o.next,this.m_contactManager.Destroy(a.contact)}e.m_contactList=null;for(var s=e.m_fixtureList;s;){var c=s;s=s.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(c),c.DestroyProxies(),c.Reset(),e.m_fixtureList=s,e.m_fixtureCount-=1}e.m_fixtureList=null,e.m_fixtureCount=0,e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),e===this.m_bodyList&&(this.m_bodyList=e.m_next),--this.m_bodyCount},t._Joint_Create=function(t){switch(t.type){case e.b2JointType.e_distanceJoint:return new Ei(t);case e.b2JointType.e_mouseJoint:return new Li(t);case e.b2JointType.e_prismaticJoint:return new zi(t);case e.b2JointType.e_revoluteJoint:return new Hi(t);case e.b2JointType.e_pulleyJoint:return new Ui(t);case e.b2JointType.e_gearJoint:return new Oi(t);case e.b2JointType.e_wheelJoint:return new Ki(t);case e.b2JointType.e_weldJoint:return new Xi(t);case e.b2JointType.e_frictionJoint:return new Ri(t);case e.b2JointType.e_ropeJoint:return new Wi(t);case e.b2JointType.e_motorJoint:return new Bi(t);case e.b2JointType.e_areaJoint:return new Ii(t)}throw new Error},t._Joint_Destroy=function(){},n.CreateJoint=function(e){if(this.IsLocked())throw new Error;var n=t._Joint_Create(e);n.m_prev=null,n.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=n),this.m_jointList=n,++this.m_jointCount,n.m_edgeA.prev=null,n.m_edgeA.next=n.m_bodyA.m_jointList,n.m_bodyA.m_jointList&&(n.m_bodyA.m_jointList.prev=n.m_edgeA),n.m_bodyA.m_jointList=n.m_edgeA,n.m_edgeB.prev=null,n.m_edgeB.next=n.m_bodyB.m_jointList,n.m_bodyB.m_jointList&&(n.m_bodyB.m_jointList.prev=n.m_edgeB),n.m_bodyB.m_jointList=n.m_edgeB;var i=n.m_bodyA,r=n.m_bodyB;if(!n.m_collideConnected)for(var o=r.GetContactList();o;)o.other===i&&o.contact.FlagForFiltering(),o=o.next;return n},n.DestroyJoint=function(e){if(this.IsLocked())throw new Error;e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),e===this.m_jointList&&(this.m_jointList=e.m_next);var n=e.m_bodyA,i=e.m_bodyB,r=e.m_collideConnected;if(n.SetAwake(!0),i.SetAwake(!0),e.m_edgeA.prev&&(e.m_edgeA.prev.next=e.m_edgeA.next),e.m_edgeA.next&&(e.m_edgeA.next.prev=e.m_edgeA.prev),e.m_edgeA===n.m_jointList&&(n.m_jointList=e.m_edgeA.next),e.m_edgeA.Reset(),e.m_edgeB.prev&&(e.m_edgeB.prev.next=e.m_edgeB.next),e.m_edgeB.next&&(e.m_edgeB.next.prev=e.m_edgeB.prev),e.m_edgeB===i.m_jointList&&(i.m_jointList=e.m_edgeB.next),e.m_edgeB.Reset(),t._Joint_Destroy(e),--this.m_jointCount,!r)for(var o=i.GetContactList();o;)o.other===n&&o.contact.FlagForFiltering(),o=o.next},n.CreateParticleSystem=function(e){if(this.IsLocked())throw new Error;var t=new no(e,this);return t.m_prev=null,t.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=t),this.m_particleSystemList=t,t},n.DestroyParticleSystem=function(e){if(this.IsLocked())throw new Error;e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),e===this.m_particleSystemList&&(this.m_particleSystemList=e.m_next)},n.CalculateReasonableParticleIterations=function(e){if(null===this.m_particleSystemList)return 1;function t(e){for(var t=i,n=e.GetParticleSystemList();null!==n;n=n.m_next)t=ie(t,n.GetRadius());return t}return Dr(this.m_gravity.Length(),t(this),e)},n.Step=function(e,n,i,r){void 0===r&&(r=this.CalculateReasonableParticleIterations(e));var o=t.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;var a=t.Step_s_step;a.dt=e,a.velocityIterations=n,a.positionIterations=i,a.particleIterations=r,a.inv_dt=e>0?1/e:0,a.dtRatio=this.m_inv_dt0*e,a.warmStarting=this.m_warmStarting;var s=t.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=s.GetMilliseconds(),this.m_stepComplete&&a.dt>0){for(var c=t.Step_s_timer.Reset(),l=this.m_particleSystemList;l;l=l.m_next)l.Solve(a);this.Solve(a),this.m_profile.solve=c.GetMilliseconds()}if(this.m_continuousPhysics&&a.dt>0){var u=t.Step_s_timer.Reset();this.SolveTOI(a),this.m_profile.solveTOI=u.GetMilliseconds()}a.dt>0&&(this.m_inv_dt0=a.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=o.GetMilliseconds()},n.ClearForces=function(){for(var e=this.m_bodyList;e;e=e.m_next)e.m_force.SetZero(),e.m_torque=0},n.DrawParticleSystem=function(e){if(null!==this.m_debugDraw){var t=e.GetParticleCount();if(t){var n=e.GetRadius(),i=e.GetPositionBuffer();if(e.m_colorBuffer.data){var r=e.GetColorBuffer();this.m_debugDraw.DrawParticles(i,n,r,t)}else this.m_debugDraw.DrawParticles(i,n,null,t)}}},n.DrawDebugData=function(){if(null!==this.m_debugDraw){var n=this.m_debugDraw.GetFlags(),i=t.DrawDebugData_s_color.SetRGB(0,0,0);if(n&e.b2DrawFlags.e_shapeBit)for(var r=this.m_bodyList;r;r=r.m_next){var o=r.m_xf;this.m_debugDraw.PushTransform(o);for(var a=r.GetFixtureList();a;a=a.m_next)r.IsActive()?r.GetType()===e.b2BodyType.b2_staticBody?(i.SetRGB(.5,.9,.5),this.DrawShape(a,i)):r.GetType()===e.b2BodyType.b2_kinematicBody?(i.SetRGB(.5,.5,.9),this.DrawShape(a,i)):r.IsAwake()?(i.SetRGB(.9,.7,.7),this.DrawShape(a,i)):(i.SetRGB(.6,.6,.6),this.DrawShape(a,i)):(i.SetRGB(.5,.5,.3),this.DrawShape(a,i));this.m_debugDraw.PopTransform(o)}if(n&e.b2DrawFlags.e_particleBit)for(var s=this.m_particleSystemList;s;s=s.m_next)this.DrawParticleSystem(s);if(n&e.b2DrawFlags.e_jointBit)for(var c=this.m_jointList;c;c=c.m_next)this.DrawJoint(c);if(n&e.b2DrawFlags.e_aabbBit){i.SetRGB(.9,.3,.9);for(var l=t.DrawDebugData_s_vs,u=this.m_bodyList;u;u=u.m_next)if(u.IsActive())for(var h=u.GetFixtureList();h;h=h.m_next)for(var _=0;_<h.m_proxyCount;++_){var f=h.m_proxies[_].treeNode.aabb;l[0].Set(f.lowerBound.x,f.lowerBound.y),l[1].Set(f.upperBound.x,f.lowerBound.y),l[2].Set(f.upperBound.x,f.upperBound.y),l[3].Set(f.lowerBound.x,f.upperBound.y),this.m_debugDraw.DrawPolygon(l,4,i)}}if(n&e.b2DrawFlags.e_centerOfMassBit)for(var d=this.m_bodyList;d;d=d.m_next){var p=t.DrawDebugData_s_xf;p.q.Copy(d.m_xf.q),p.p.Copy(d.GetWorldCenter()),this.m_debugDraw.DrawTransform(p)}if(n&e.b2DrawFlags.e_controllerBit)for(var m=this.m_controllerList;m;m=m.m_next)m.Draw(this.m_debugDraw)}},n.QueryAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryAABB=function(e,t,n){if(this.m_contactManager.m_broadPhase.Query(t,(function(t){var i=t.userData.fixture;return e?e.ReportFixture(i):!n||n(i)})),e instanceof fr)for(var i=this.m_particleSystemList;i;i=i.m_next)e.ShouldQueryParticleSystem(i)&&i.QueryAABB(e,t)},n.QueryAllAABB=function(e,t){return void 0===t&&(t=[]),this.QueryAABB(e,(function(e){return t.push(e),!0})),t},n.QueryPointAABB=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryPointAABB(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryPointAABB(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryPointAABB=function(e,t,n){if(this.m_contactManager.m_broadPhase.QueryPoint(t,(function(t){var i=t.userData.fixture;return e?e.ReportFixture(i):!n||n(i)})),e instanceof fr)for(var i=this.m_particleSystemList;i;i=i.m_next)e.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(e,t)},n.QueryAllPointAABB=function(e,t){return void 0===t&&(t=[]),this.QueryPointAABB(e,(function(e){return t.push(e),!0})),t},n.QueryFixtureShape=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryFixtureShape(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3]):this._QueryFixtureShape(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2],arguments.length<=3?void 0:arguments[3])},n._QueryFixtureShape=function(e,n,i,r,o){var a=t.QueryFixtureShape_s_aabb;if(n.ComputeAABB(a,r,i),this.m_contactManager.m_broadPhase.Query(a,(function(t){var a=t.userData,s=a.fixture;if(Dt(n,i,s.GetShape(),a.childIndex,r,s.GetBody().GetTransform())){if(e)return e.ReportFixture(s);if(o)return o(s)}return!0})),e instanceof fr)for(var s=this.m_particleSystemList;s;s=s.m_next)e.ShouldQueryParticleSystem(s)&&s.QueryAABB(e,a)},n.QueryAllFixtureShape=function(e,t,n,i){return void 0===i&&(i=[]),this.QueryFixtureShape(e,t,n,(function(e){return i.push(e),!0})),i},n.QueryFixturePoint=function(){(arguments.length<=0?void 0:arguments[0])instanceof fr?this._QueryFixturePoint(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1]):this._QueryFixturePoint(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1])},n._QueryFixturePoint=function(e,t,n){if(this.m_contactManager.m_broadPhase.QueryPoint(t,(function(i){var r=i.userData.fixture;if(r.TestPoint(t)){if(e)return e.ReportFixture(r);if(n)return n(r)}return!0})),e)for(var i=this.m_particleSystemList;i;i=i.m_next)e.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(e,t)},n.QueryAllFixturePoint=function(e,t){return void 0===t&&(t=[]),this.QueryFixturePoint(e,(function(e){return t.push(e),!0})),t},n.RayCast=function(){(arguments.length<=0?void 0:arguments[0])instanceof dr?this._RayCast(arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2]):this._RayCast(null,arguments.length<=0?void 0:arguments[0],arguments.length<=1?void 0:arguments[1],arguments.length<=2?void 0:arguments[2])},n._RayCast=function(e,n,i,r){var o=t.RayCast_s_input;if(o.maxFraction=1,o.p1.Copy(n),o.p2.Copy(i),this.m_contactManager.m_broadPhase.RayCast(o,(function(o,a){var s=a.userData,c=s.fixture,l=s.childIndex,u=t.RayCast_s_output;if(c.RayCast(u,o,l)){var h=u.fraction,_=t.RayCast_s_point;if(_.Set((1-h)*n.x+h*i.x,(1-h)*n.y+h*i.y),e)return e.ReportFixture(c,_,u.normal,h);if(r)return r(c,_,u.normal,h)}return o.maxFraction})),e)for(var a=this.m_particleSystemList;a;a=a.m_next)e.ShouldQueryParticleSystem(a)&&a.RayCast(e,n,i)},n.RayCastOne=function(e,t){var n=null,i=1;return this.RayCast(e,t,(function(e,t,r,o){return o<i&&(i=o,n=e),i})),n},n.RayCastAll=function(e,t,n){return void 0===n&&(n=[]),this.RayCast(e,t,(function(e){return n.push(e),1})),n},n.GetBodyList=function(){return this.m_bodyList},n.GetJointList=function(){return this.m_jointList},n.GetParticleSystemList=function(){return this.m_particleSystemList},n.GetContactList=function(){return this.m_contactManager.m_contactList},n.SetAllowSleeping=function(e){if(e!==this.m_allowSleep&&(this.m_allowSleep=e,!this.m_allowSleep))for(var t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)},n.GetAllowSleeping=function(){return this.m_allowSleep},n.SetWarmStarting=function(e){this.m_warmStarting=e},n.GetWarmStarting=function(){return this.m_warmStarting},n.SetContinuousPhysics=function(e){this.m_continuousPhysics=e},n.GetContinuousPhysics=function(){return this.m_continuousPhysics},n.SetSubStepping=function(e){this.m_subStepping=e},n.GetSubStepping=function(){return this.m_subStepping},n.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},n.GetBodyCount=function(){return this.m_bodyCount},n.GetJointCount=function(){return this.m_jointCount},n.GetContactCount=function(){return this.m_contactManager.m_contactCount},n.GetTreeHeight=function(){return this.m_contactManager.m_broadPhase.GetTreeHeight()},n.GetTreeBalance=function(){return this.m_contactManager.m_broadPhase.GetTreeBalance()},n.GetTreeQuality=function(){return this.m_contactManager.m_broadPhase.GetTreeQuality()},n.SetGravity=function(e,t){if(void 0===t&&(t=!0),!be.IsEqualToV(this.m_gravity,e)&&(this.m_gravity.Copy(e),t))for(var n=this.m_bodyList;n;n=n.m_next)n.SetAwake(!0)},n.GetGravity=function(){return this.m_gravity},n.IsLocked=function(){return this.m_locked},n.SetAutoClearForces=function(e){this.m_clearForces=e},n.GetAutoClearForces=function(){return this.m_clearForces},n.ShiftOrigin=function(e){if(this.IsLocked())throw new Error;for(var t=this.m_bodyList;t;t=t.m_next)t.m_xf.p.SelfSub(e),t.m_sweep.c0.SelfSub(e),t.m_sweep.c.SelfSub(e);for(var n=this.m_jointList;n;n=n.m_next)n.ShiftOrigin(e);this.m_contactManager.m_broadPhase.ShiftOrigin(e)},n.GetContactManager=function(){return this.m_contactManager},n.GetProfile=function(){return this.m_profile},n.Dump=function(t){if(!this.m_locked){t("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),t("this.m_world.SetGravity(g);\n"),t("const bodies: b2Body[] = [];\n"),t("const joints: b2Joint[] = [];\n");for(var n=0,i=this.m_bodyList;i;i=i.m_next)i.m_islandIndex=n,i.Dump(t),++n;n=0;for(var r=this.m_jointList;r;r=r.m_next)r.m_index=n,++n;for(var o=this.m_jointList;o;o=o.m_next)o.m_type!==e.b2JointType.e_gearJoint&&(t("{\n"),o.Dump(t),t("}\n"));for(var a=this.m_jointList;a;a=a.m_next)a.m_type===e.b2JointType.e_gearJoint&&(t("{\n"),a.Dump(t),t("}\n"))}},n.DrawJoint=function(n){if(null!==this.m_debugDraw){var i=n.GetBodyA(),r=n.GetBodyB(),o=i.m_xf,a=r.m_xf,s=o.p,c=a.p,l=n.GetAnchorA(t.DrawJoint_s_p1),u=n.GetAnchorB(t.DrawJoint_s_p2),h=t.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(n.m_type){case e.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(l,u,h);break;case e.b2JointType.e_pulleyJoint:var _=n,f=_.GetGroundAnchorA(),d=_.GetGroundAnchorB();this.m_debugDraw.DrawSegment(f,l,h),this.m_debugDraw.DrawSegment(d,u,h),this.m_debugDraw.DrawSegment(f,d,h);break;case e.b2JointType.e_mouseJoint:var p=t.DrawJoint_s_c;p.Set(0,1,0),this.m_debugDraw.DrawPoint(l,4,p),this.m_debugDraw.DrawPoint(u,4,p),p.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(l,u,p);break;default:this.m_debugDraw.DrawSegment(s,l,h),this.m_debugDraw.DrawSegment(l,u,h),this.m_debugDraw.DrawSegment(c,u,h)}}},n.DrawShape=function(n,i){if(null!==this.m_debugDraw){var r=n.GetShape();switch(r.m_type){case e.b2ShapeType.e_circleShape:var o=r,a=o.m_p,s=o.m_radius,c=be.UNITX;this.m_debugDraw.DrawSolidCircle(a,s,c,i);break;case e.b2ShapeType.e_edgeShape:var l=r,u=l.m_vertex1,h=l.m_vertex2;this.m_debugDraw.DrawSegment(u,h,i);break;case e.b2ShapeType.e_chainShape:var _=r,f=_.m_count,d=_.m_vertices,p=t.DrawShape_s_ghostColor.SetRGBA(.75*i.r,.75*i.g,.75*i.b,i.a),m=d[0];if(this.m_debugDraw.DrawPoint(m,4,i),_.m_hasPrevVertex){var v=_.m_prevVertex;this.m_debugDraw.DrawSegment(v,m,p),this.m_debugDraw.DrawCircle(v,.1,p)}for(var g=1;g<f;++g){var y=d[g];this.m_debugDraw.DrawSegment(m,y,i),this.m_debugDraw.DrawPoint(y,4,i),m=y}if(_.m_hasNextVertex){var x=_.m_nextVertex;this.m_debugDraw.DrawSegment(x,m,p),this.m_debugDraw.DrawCircle(x,.1,p)}break;case e.b2ShapeType.e_polygonShape:var S=r,C=S.m_count,A=S.m_vertices;this.m_debugDraw.DrawSolidPolygon(A,C,i)}}},n.Solve=function(t){for(var n=this.m_bodyList;n;n=n.m_next)n.m_xf0.Copy(n.m_xf);for(var i=this.m_controllerList;i;i=i.m_next)i.Step(t);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;var r=this.m_island;r.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(var o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1;for(var a=this.m_contactManager.m_contactList;a;a=a.m_next)a.m_islandFlag=!1;for(var s=this.m_jointList;s;s=s.m_next)s.m_islandFlag=!1;for(var c=this.s_stack,l=this.m_bodyList;l;l=l.m_next)if(!l.m_islandFlag&&l.IsAwake()&&l.IsActive()&&l.GetType()!==e.b2BodyType.b2_staticBody){r.Clear();var u=0;for(c[u++]=l,l.m_islandFlag=!0;u>0;){var h=c[--u];if(!h)throw new Error;if(r.AddBody(h),h.m_awakeFlag=!0,h.GetType()!==e.b2BodyType.b2_staticBody){for(var _=h.m_contactList;_;_=_.next){var f=_.contact;if(!f.m_islandFlag&&f.IsEnabled()&&f.IsTouching()){var d=f.m_fixtureA.m_isSensor,p=f.m_fixtureB.m_isSensor;if(!d&&!p){r.AddContact(f),f.m_islandFlag=!0;var m=_.other;m.m_islandFlag||(c[u++]=m,m.m_islandFlag=!0)}}}for(var v=h.m_jointList;v;v=v.next)if(!v.joint.m_islandFlag){var g=v.other;g.IsActive()&&(r.AddJoint(v.joint),v.joint.m_islandFlag=!0,g.m_islandFlag||(c[u++]=g,g.m_islandFlag=!0))}}}var y=new mr;r.Solve(y,t,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=y.solveInit,this.m_profile.solveVelocity+=y.solveVelocity,this.m_profile.solvePosition+=y.solvePosition;for(var x=0;x<r.m_bodyCount;++x){var S=r.m_bodies[x];S.GetType()===e.b2BodyType.b2_staticBody&&(S.m_islandFlag=!1)}}for(var C=0;C<c.length&&c[C];++C)c[C]=null;for(var A=new Me,b=this.m_bodyList;b;b=b.m_next)b.m_islandFlag&&b.GetType()!==e.b2BodyType.b2_staticBody&&b.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=A.GetMilliseconds()},n.SolveTOI=function(n){var i=this.m_island;if(i.Initialize(2*p,p,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(var o=this.m_bodyList;o;o=o.m_next)o.m_islandFlag=!1,o.m_sweep.alpha0=0;for(var a=this.m_contactManager.m_contactList;a;a=a.m_next)a.m_toiFlag=!1,a.m_islandFlag=!1,a.m_toiCount=0,a.m_toi=1}for(;;){for(var s=null,c=1,l=this.m_contactManager.m_contactList;l;l=l.m_next)if(l.IsEnabled()&&!(l.m_toiCount>d)){var u=1;if(l.m_toiFlag)u=l.m_toi;else{var h=l.GetFixtureA(),_=l.GetFixtureB();if(h.IsSensor()||_.IsSensor())continue;var f=h.GetBody(),m=_.GetBody(),v=f.m_type,g=m.m_type,y=f.IsAwake()&&v!==e.b2BodyType.b2_staticBody,x=m.IsAwake()&&g!==e.b2BodyType.b2_staticBody;if(!y&&!x)continue;var S=f.IsBullet()||v!==e.b2BodyType.b2_dynamicBody,C=m.IsBullet()||g!==e.b2BodyType.b2_dynamicBody;if(!S&&!C)continue;var A=f.m_sweep.alpha0;f.m_sweep.alpha0<m.m_sweep.alpha0?(A=m.m_sweep.alpha0,f.m_sweep.Advance(A)):m.m_sweep.alpha0<f.m_sweep.alpha0&&(A=f.m_sweep.alpha0,m.m_sweep.Advance(A));var b=l.GetChildIndexA(),T=l.GetChildIndexB(),E=t.SolveTOI_s_toi_input;E.proxyA.SetShape(h.GetShape(),b),E.proxyB.SetShape(_.GetShape(),T),E.sweepA.Copy(f.m_sweep),E.sweepB.Copy(m.m_sweep),E.tMax=1;var w=t.SolveTOI_s_toi_output;un(w,E);var I=w.t;u=w.state===e.b2TOIOutputState.e_touching?ie(A+(1-A)*I,1):1,l.m_toi=u,l.m_toiFlag=!0}u<c&&(s=l,c=u)}if(null===s||1-10*r<c){this.m_stepComplete=!0;break}var P=s.GetFixtureA(),R=s.GetFixtureB(),D=P.GetBody(),O=R.GetBody(),N=t.SolveTOI_s_backup1.Copy(D.m_sweep),B=t.SolveTOI_s_backup2.Copy(O.m_sweep);if(D.Advance(c),O.Advance(c),s.Update(this.m_contactManager.m_contactListener),s.m_toiFlag=!1,++s.m_toiCount,s.IsEnabled()&&s.IsTouching()){D.SetAwake(!0),O.SetAwake(!0),i.Clear(),i.AddBody(D),i.AddBody(O),i.AddContact(s),D.m_islandFlag=!0,O.m_islandFlag=!0,s.m_islandFlag=!0;for(var M=0;M<2;++M){var L=0===M?D:O;if(L.m_type===e.b2BodyType.b2_dynamicBody)for(var F=L.m_contactList;F&&i.m_bodyCount!==i.m_bodyCapacity&&i.m_contactCount!==i.m_contactCapacity;F=F.next){var z=F.contact;if(!z.m_islandFlag){var V=F.other;if(V.m_type!==e.b2BodyType.b2_dynamicBody||L.IsBullet()||V.IsBullet()){var G=z.m_fixtureA.m_isSensor,U=z.m_fixtureB.m_isSensor;if(!G&&!U){var k=t.SolveTOI_s_backup.Copy(V.m_sweep);V.m_islandFlag||V.Advance(c),z.Update(this.m_contactManager.m_contactListener),z.IsEnabled()&&z.IsTouching()?(z.m_islandFlag=!0,i.AddContact(z),V.m_islandFlag||(V.m_islandFlag=!0,V.m_type!==e.b2BodyType.b2_staticBody&&V.SetAwake(!0),i.AddBody(V))):(V.m_sweep.Copy(k),V.SynchronizeTransform())}}}}}var H=t.SolveTOI_s_subStep;H.dt=(1-c)*n.dt,H.inv_dt=1/H.dt,H.dtRatio=1,H.positionIterations=20,H.velocityIterations=n.velocityIterations,H.particleIterations=n.particleIterations,H.warmStarting=!1,i.SolveTOI(H,D.m_islandIndex,O.m_islandIndex);for(var j=0;j<i.m_bodyCount;++j){var W=i.m_bodies[j];if(W.m_islandFlag=!1,W.m_type===e.b2BodyType.b2_dynamicBody){W.SynchronizeFixtures();for(var q=W.m_contactList;q;q=q.next)q.contact.m_toiFlag=!1,q.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}else s.SetEnabled(!1),D.m_sweep.Copy(N),O.m_sweep.Copy(B),D.SynchronizeTransform(),O.SynchronizeTransform()}},n.AddController=function(e){return e.m_next=this.m_controllerList,e.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=e),this.m_controllerList=e,++this.m_controllerCount,e},n.RemoveController=function(e){return e.m_prev&&(e.m_prev.m_next=e.m_next),e.m_next&&(e.m_next.m_prev=e.m_prev),this.m_controllerList===e&&(this.m_controllerList=e.m_next),--this.m_controllerCount,e.m_prev=null,e.m_next=null,e},t}();xo.Step_s_step=new vr,xo.Step_s_stepTimer=new Me,xo.Step_s_timer=new Me,xo.DrawDebugData_s_color=new Ne(0,0,0),xo.DrawDebugData_s_vs=be.MakeArray(4),xo.DrawDebugData_s_xf=new Re,xo.QueryFixtureShape_s_aabb=new Tt,xo.RayCast_s_input=new At,xo.RayCast_s_output=new bt,xo.RayCast_s_point=new be,xo.DrawJoint_s_p1=new be,xo.DrawJoint_s_p2=new be,xo.DrawJoint_s_color=new Ne(.5,.8,.8),xo.DrawJoint_s_c=new Ne,xo.DrawShape_s_ghostColor=new Ne,xo.SolveTOI_s_subStep=new vr,xo.SolveTOI_s_backup=new Oe,xo.SolveTOI_s_backup1=new Oe,xo.SolveTOI_s_backup2=new Oe,xo.SolveTOI_s_toi_input=new Jt,xo.SolveTOI_s_toi_output=new Zt;var So=function(e,t){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=e,this.body=t},Co=function(){function e(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}var t=e.prototype;return t.GetNext=function(){return this.m_next},t.GetPrev=function(){return this.m_prev},t.GetBodyList=function(){return this.m_bodyList},t.AddBody=function(e){var t=new So(this,e);t.nextBody=this.m_bodyList,t.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=t),this.m_bodyList=t,++this.m_bodyCount,t.nextController=e.m_controllerList,t.prevController=null,e.m_controllerList&&(e.m_controllerList.prevController=t),e.m_controllerList=t,++e.m_controllerCount},t.RemoveBody=function(e){if(this.m_bodyCount<=0)throw new Error;for(var t=this.m_bodyList;t&&t.body!==e;)t=t.nextBody;if(null===t)throw new Error;t.prevBody&&(t.prevBody.nextBody=t.nextBody),t.nextBody&&(t.nextBody.prevBody=t.prevBody),this.m_bodyList===t&&(this.m_bodyList=t.nextBody),--this.m_bodyCount,t.nextController&&(t.nextController.prevController=t.prevController),t.prevController&&(t.prevController.nextController=t.nextController),e.m_controllerList===t&&(e.m_controllerList=t.nextController),--e.m_controllerCount},t.Clear=function(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0},e}(),Ao=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).normal=new be(0,1),t.offset=0,t.density=0,t.velocity=new be(0,0),t.linearDrag=0,t.angularDrag=0,t.useDensity=!1,t.useWorldGravity=!0,t.gravity=new be(0,0),t}Z(t,e);var n=t.prototype;return n.Step=function(){if(this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(var e=this.m_bodyList;e;e=e.nextBody){var t=e.body;if(t.IsAwake()){for(var n=new be,i=new be,o=0,a=0,s=t.GetFixtureList();s;s=s.m_next){var c=new be,l=s.GetShape().ComputeSubmergedArea(this.normal,this.offset,t.GetTransform(),c);o+=l,n.x+=l*c.x,n.y+=l*c.y;var u=0;a+=l*(u=this.useDensity?s.GetDensity():1),i.x+=l*c.x*u,i.y+=l*c.y*u}if(n.x/=o,n.y/=o,i.x/=a,i.y/=a,!(o<r)){var h=this.gravity.Clone().SelfNeg();h.SelfMul(this.density*o),t.ApplyForce(h,i);var _=t.GetLinearVelocityFromWorldPoint(n,new be);_.SelfSub(this.velocity),_.SelfMul(-this.linearDrag*o),t.ApplyForce(_,n),t.ApplyTorque(-t.GetInertia()/t.GetMass()*o*t.GetAngularVelocity()*this.angularDrag)}}}}},n.Draw=function(e){var t=100,n=new be,i=new be;n.x=this.normal.x*this.offset+this.normal.y*t,n.y=this.normal.y*this.offset-this.normal.x*t,i.x=this.normal.x*this.offset-this.normal.y*t,i.y=this.normal.y*this.offset+this.normal.x*t;var r=new Ne(0,0,.8);e.DrawSegment(n,i,r)},t}(Co),bo=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).A=new be(0,0),t}Z(t,e);var n=t.prototype;return n.Step=function(e){for(var n=be.MulSV(e.dt,this.A,t.Step_s_dtA),i=this.m_bodyList;i;i=i.nextBody){var r=i.body;r.IsAwake()&&r.SetLinearVelocity(be.AddVV(r.GetLinearVelocity(),n,be.s_t0))}},n.Draw=function(){},t}(Co);bo.Step_s_dtA=new be;var To=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).F=new be(0,0),t}Z(t,e);var n=t.prototype;return n.Step=function(){for(var e=this.m_bodyList;e;e=e.nextBody){var t=e.body;t.IsAwake()&&t.ApplyForce(this.F,t.GetWorldCenter())}},n.Draw=function(){},t}(Co),Eo=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).G=1,t.invSqr=!0,t}Z(t,e);var n=t.prototype;return n.Step=function(){if(this.invSqr)for(var e=this.m_bodyList;e;e=e.nextBody)for(var n=e.body,i=n.GetWorldCenter(),o=n.GetMass(),a=this.m_bodyList;a&&a!==e;a=a.nextBody){var s=a.body,c=s.GetWorldCenter(),l=s.GetMass(),u=c.x-i.x,h=c.y-i.y,_=u*u+h*h;if(!(_<r)){var f=t.Step_s_f.Set(u,h);f.SelfMul(this.G/_/he(_)*o*l),n.IsAwake()&&n.ApplyForce(f,i),s.IsAwake()&&s.ApplyForce(f.SelfMul(-1),c)}}else for(var d=this.m_bodyList;d;d=d.nextBody)for(var p=d.body,m=p.GetWorldCenter(),v=p.GetMass(),g=this.m_bodyList;g&&g!==d;g=g.nextBody){var y=g.body,x=y.GetWorldCenter(),S=y.GetMass(),C=x.x-m.x,A=x.y-m.y,b=C*C+A*A;if(!(b<r)){var T=t.Step_s_f.Set(C,A);T.SelfMul(this.G/b*v*S),p.IsAwake()&&p.ApplyForce(T,m),y.IsAwake()&&y.ApplyForce(T.SelfMul(-1),x)}}},n.Draw=function(){},t}(Co);Eo.Step_s_f=new be;var wo=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).T=new we,t.maxTimestep=0,t}Z(t,e);var n=t.prototype;return n.Step=function(e){var n=e.dt;if(!(n<=r)){n>this.maxTimestep&&this.maxTimestep>0&&(n=this.maxTimestep);for(var i=this.m_bodyList;i;i=i.nextBody){var o=i.body;if(o.IsAwake()){var a=o.GetWorldVector(we.MulMV(this.T,o.GetLocalVector(o.GetLinearVelocity(),be.s_t0),be.s_t1),t.Step_s_damping);o.SetLinearVelocity(be.AddVV(o.GetLinearVelocity(),be.MulSV(n,a,be.s_t0),be.s_t1))}}}},n.Draw=function(){},n.SetAxisAligned=function(e,t){this.T.ex.x=-e,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-t,this.maxTimestep=e>0||t>0?1/re(e,t):0},t}(Co);wo.Step_s_damping=new be;var Io=function(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new be(0,0),this.damping=.1,this.k2=.9,this.k3=.1},Po=function(){function e(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new be,this.m_damping=0,this.m_k2=1,this.m_k3=.1}var t=e.prototype;return t.GetVertexCount=function(){return this.m_count},t.GetVertices=function(){return this.m_ps},t.Initialize=function(e){this.m_count=e.count,this.m_ps=be.MakeArray(this.m_count),this.m_p0s=be.MakeArray(this.m_count),this.m_vs=be.MakeArray(this.m_count),this.m_ims=K(this.m_count);for(var t=0;t<this.m_count;++t){this.m_ps[t].Copy(e.vertices[t]),this.m_p0s[t].Copy(e.vertices[t]),this.m_vs[t].SetZero();var n=e.masses[t];this.m_ims[t]=n>0?1/n:0}var i=this.m_count-1,r=this.m_count-2;this.m_Ls=K(i),this.m_as=K(r);for(var o=0;o<i;++o){var a=this.m_ps[o],s=this.m_ps[o+1];this.m_Ls[o]=be.DistanceVV(a,s)}for(var c=0;c<r;++c){var l=this.m_ps[c],u=this.m_ps[c+1],h=this.m_ps[c+2],_=be.SubVV(u,l,be.s_t0),f=be.SubVV(h,u,be.s_t1),d=be.CrossVV(_,f),p=be.DotVV(_,f);this.m_as[c]=ye(d,p)}this.m_gravity.Copy(e.gravity),this.m_damping=e.damping,this.m_k2=e.k2,this.m_k3=e.k3},t.Step=function(e,t){if(0!==e){for(var n=Math.exp(-e*this.m_damping),i=0;i<this.m_count;++i)this.m_p0s[i].Copy(this.m_ps[i]),this.m_ims[i]>0&&this.m_vs[i].SelfMulAdd(e,this.m_gravity),this.m_vs[i].SelfMul(n),this.m_ps[i].SelfMulAdd(e,this.m_vs[i]);for(var r=0;r<t;++r)this.SolveC2(),this.SolveC3(),this.SolveC2();for(var o=1/e,a=0;a<this.m_count;++a)be.MulSV(o,be.SubVV(this.m_ps[a],this.m_p0s[a],be.s_t0),this.m_vs[a])}},t.SolveC2=function(){for(var t=this.m_count-1,n=0;n<t;++n){var i=this.m_ps[n],r=this.m_ps[n+1],o=be.SubVV(r,i,e.s_d),a=o.Normalize(),s=this.m_ims[n],c=this.m_ims[n+1];if(s+c!==0){var l=s/(s+c),u=c/(s+c);i.SelfMulSub(this.m_k2*l*(this.m_Ls[n]-a),o),r.SelfMulAdd(this.m_k2*u*(this.m_Ls[n]-a),o)}}},t.SetAngle=function(e){for(var t=this.m_count-2,n=0;n<t;++n)this.m_as[n]=e},t.SolveC3=function(){for(var t=this.m_count-2,n=0;n<t;++n){var i=this.m_ps[n],r=this.m_ps[n+1],o=this.m_ps[n+2],s=this.m_ims[n],c=this.m_ims[n+1],l=this.m_ims[n+2],u=be.SubVV(r,i,e.s_d1),h=be.SubVV(o,r,e.s_d2),_=u.LengthSquared(),f=h.LengthSquared();if(_*f!=0){var d=be.CrossVV(u,h),p=be.DotVV(u,h),m=ye(d,p),v=be.MulSV(-1/_,u.SelfSkew(),e.s_Jd1),g=be.MulSV(1/f,h.SelfSkew(),e.s_Jd2),y=be.NegV(v,e.s_J1),x=be.SubVV(v,g,e.s_J2),S=g,C=s*be.DotVV(y,y)+c*be.DotVV(x,x)+l*be.DotVV(S,S);if(0!==C){C=1/C;for(var A=m-this.m_as[n];A>a;)A=(m-=2*a)-this.m_as[n];for(;A<-a;)A=(m+=2*a)-this.m_as[n];var b=-this.m_k3*C*A;i.SelfMulAdd(s*b,y),r.SelfMulAdd(c*b,x),o.SelfMulAdd(l*b,S)}}}},t.Draw=function(e){for(var t=new Ne(.4,.5,.7),n=0;n<this.m_count-1;++n)e.DrawSegment(this.m_ps[n],this.m_ps[n+1],t)},e}();Po.s_d=new be,Po.s_d1=new be,Po.s_d2=new be,Po.s_Jd1=new be,Po.s_Jd2=new be,Po.s_J1=new be,Po.s_J2=new be,e.b2AABB=Tt,e.b2Abs=te,e.b2Acos=ve,e.b2Alloc=z,e.b2AreaJoint=Ii,e.b2AreaJointDef=wi,e.b2Asin=ge,e.b2Assert=t,e.b2Atan2=ye,e.b2BlockAllocator=ze,e.b2Body=xi,e.b2BodyDef=yi,e.b2BroadPhase=Vt,e.b2BuoyancyController=Ao,e.b2CalculateParticleIterations=Dr,e.b2ChainAndCircleContact=or,e.b2ChainAndPolygonContact=ar,e.b2ChainShape=hi,e.b2CircleContact=er,e.b2CircleShape=ci,e.b2Clamp=oe,e.b2ClipSegmentToLine=wt,e.b2ClipVertex=Ct,e.b2CollideCircles=fn,e.b2CollideEdgeAndCircle=Qn,e.b2CollideEdgeAndPolygon=ri,e.b2CollidePolygonAndCircle=vn,e.b2CollidePolygons=Un,e.b2Color=Ne,e.b2ConstantAccelController=bo,e.b2ConstantForceController=To,e.b2Contact=$i,e.b2ContactEdge=Zi,e.b2ContactFactory=cr,e.b2ContactFeature=pt,e.b2ContactFilter=ur,e.b2ContactID=mt,e.b2ContactImpulse=hr,e.b2ContactListener=_r,e.b2ContactManager=pr,e.b2ContactPositionConstraint=br,e.b2ContactRegister=sr,e.b2ContactSolver=wr,e.b2ContactSolverDef=Tr,e.b2ContactVelocityConstraint=Ar,e.b2Controller=Co,e.b2ControllerEdge=So,e.b2Cos=pe,e.b2Counter=Le,e.b2DegToRad=fe,e.b2DestructionListener=lr,e.b2Distance=it,e.b2DistanceInput=ke,e.b2DistanceJoint=Ei,e.b2DistanceJointDef=Ti,e.b2DistanceOutput=He,e.b2DistanceProxy=Ge,e.b2Draw=Be,e.b2DynamicTree=Bt,e.b2EdgeAndCircleContact=ir,e.b2EdgeAndPolygonContact=rr,e.b2EdgeShape=ui,e.b2Filter=_i,e.b2Fixture=mi,e.b2FixtureDef=fi,e.b2FixtureParticleQueryCallback=Jr,e.b2FixtureProxy=di,e.b2Free=V,e.b2FrictionJoint=Ri,e.b2FrictionJointDef=Pi,e.b2GearJoint=Oi,e.b2GearJointDef=Di,e.b2GetPointStates=St,e.b2GravityController=Eo,e.b2GrowableBuffer=Kr,e.b2GrowableStack=Fe,e.b2InvSqrt=ue,e.b2IsPowerOfTwo=Se,e.b2IsValid=ce,e.b2Island=Pr,e.b2Jacobian=Si,e.b2Joint=bi,e.b2JointDef=Ai,e.b2JointEdge=Ci,e.b2Log=G,e.b2MakeArray=X,e.b2MakeNullArray=Y,e.b2MakeNumberArray=K,e.b2Manifold=yt,e.b2ManifoldPoint=vt,e.b2MassData=ai,e.b2Mat22=we,e.b2Mat33=Ie,e.b2Max=re,e.b2Maybe=n,e.b2Min=ie,e.b2MixFriction=Ji,e.b2MixRestitution=Qi,e.b2MotorJoint=Bi,e.b2MotorJointDef=Ni,e.b2MouseJoint=Li,e.b2MouseJointDef=Mi,e.b2NextPowerOfTwo=xe,e.b2Pair=zt,e.b2PairLessThan=Gt,e.b2ParseInt=W,e.b2ParseUInt=q,e.b2ParticleBodyContact=Zr,e.b2ParticleContact=Qr,e.b2ParticleDef=Rr,e.b2ParticleGroup=Mr,e.b2ParticleGroupDef=Br,e.b2ParticleHandle=Nr,e.b2ParticlePair=$r,e.b2ParticlePairSet=ho,e.b2ParticleSystem=no,e.b2ParticleSystemDef=to,e.b2ParticleSystem_CompositeShape=mo,e.b2ParticleSystem_ConnectionFilter=_o,e.b2ParticleSystem_DestroyParticlesInShapeCallback=fo,e.b2ParticleSystem_FixedSetAllocator=so,e.b2ParticleSystem_FixtureParticle=co,e.b2ParticleSystem_FixtureParticleSet=lo,e.b2ParticleSystem_InsideBoundsEnumerator=oo,e.b2ParticleSystem_JoinParticleGroupsFilter=po,e.b2ParticleSystem_ParticleListNode=ao,e.b2ParticleSystem_ParticlePair=uo,e.b2ParticleSystem_Proxy=ro,e.b2ParticleSystem_ReactiveFilter=vo,e.b2ParticleSystem_SolveCollisionCallback=yo,e.b2ParticleSystem_UpdateBodyContactsCallback=go,e.b2ParticleSystem_UserOverridableBuffer=io,e.b2ParticleTriad=eo,e.b2PolygonAndCircleContact=nr,e.b2PolygonContact=tr,e.b2PolygonShape=li,e.b2Position=gr,e.b2PositionSolverManifold=Er,e.b2Pow=_e,e.b2PrismaticJoint=zi,e.b2PrismaticJointDef=Fi,e.b2Profile=mr,e.b2PulleyJoint=Ui,e.b2PulleyJointDef=Gi,e.b2QueryCallback=fr,e.b2RadToDeg=de,e.b2Random=Ce,e.b2RandomRange=Ae,e.b2RayCastCallback=dr,e.b2RayCastInput=At,e.b2RayCastOutput=bt,e.b2RevoluteJoint=Hi,e.b2RevoluteJointDef=ki,e.b2Rope=Po,e.b2RopeDef=Io,e.b2RopeJoint=Wi,e.b2RopeJointDef=ji,e.b2Rot=Pe,e.b2SeparationFunction=$t,e.b2Shape=si,e.b2ShapeCast=ft,e.b2ShapeCastInput=je,e.b2ShapeCastOutput=We,e.b2Simplex=Ye,e.b2SimplexCache=Ue,e.b2SimplexVertex=Xe,e.b2Sin=me,e.b2SolverData=xr,e.b2Sq=le,e.b2Sqrt=he,e.b2StackAllocator=Ve,e.b2Swap=se,e.b2Sweep=Oe,e.b2TOIInput=Jt,e.b2TOIOutput=Zt,e.b2TensorDampingController=wo,e.b2TestOverlapAABB=Et,e.b2TestOverlapShape=Dt,e.b2TimeOfImpact=un,e.b2TimeStep=vr,e.b2Timer=Me,e.b2Transform=Re,e.b2TreeNode=Nt,e.b2Vec2=be,e.b2Vec2_zero=Te,e.b2Vec3=Ee,e.b2Velocity=yr,e.b2VelocityConstraintPoint=Cr,e.b2Version=U,e.b2WeldJoint=Xi,e.b2WeldJointDef=qi,e.b2WheelJoint=Ki,e.b2WheelJointDef=Yi,e.b2World=xo,e.b2WorldManifold=xt,e.b2_180_over_pi=$,e.b2_aabbExtension=l,e.b2_aabbMultiplier=u,e.b2_angularSleepTolerance=F,e.b2_angularSlop=_,e.b2_barrierCollisionTime=B,e.b2_baumgarte=A,e.b2_branch=H,e.b2_commit=j,e.b2_epsilon=r,e.b2_epsilon_sq=o,e.b2_gjk_reset=qe,e.b2_invalidParticleIndex=T,e.b2_linearSleepTolerance=L,e.b2_linearSlop=h,e.b2_maxAngularCorrection=g,e.b2_maxFloat=i,e.b2_maxLinearCorrection=v,e.b2_maxManifoldPoints=s,e.b2_maxParticleForce=R,e.b2_maxParticleIndex=E,e.b2_maxParticlePressure=P,e.b2_maxPolygonVertices=c,e.b2_maxRotation=S,e.b2_maxRotationSquared=C,e.b2_maxSubSteps=d,e.b2_maxTOIContacts=p,e.b2_maxTranslation=y,e.b2_maxTranslationSquared=x,e.b2_maxTriadDistance=D,e.b2_maxTriadDistanceSquared=O,e.b2_minParticleSystemBufferCapacity=N,e.b2_minParticleWeight=I,e.b2_minPulleyLength=Vi,e.b2_particleStride=w,e.b2_pi=a,e.b2_pi_over_180=Q,e.b2_polygonRadius=f,e.b2_timeToSleep=M,e.b2_toiBaumgarte=b,e.b2_toi_reset=Ut,e.b2_two_pi=ee,e.b2_velocityThreshold=m,e.b2_version=k,e.g_blockSolve=Sr,Object.defineProperty(e,"__esModule",{value:!0})}(t)}(t={exports:{}},t.exports),t.exports}();(m4=v4)&&m4.__esModule&&Object.prototype.hasOwnProperty.call(m4,"default")&&m4.default;var g4={};for(var y4 in v4)-1===y4.indexOf("b2_")&&(g4[y4.replace("b2","")]=v4[y4]);var x4,S4,C4,A4,b4,T4=g4;!function(e){e[e.Static=0]="Static",e[e.Kinematic=1]="Kinematic",e[e.Dynamic=2]="Dynamic",e[e.Animated=3]="Animated"}(x4||(x4=e("ERigidBody2DType",{}))),rt(x4),function(e){e[e.None=0]="None",e[e.BOX=1]="BOX",e[e.CIRCLE=2]="CIRCLE",e[e.POLYGON=3]="POLYGON"}(S4||(S4=e("ECollider2DType",{}))),rt(S4),function(e){e[e.None=0]="None",e[e.DISTANCE=1]="DISTANCE",e[e.SPRING=2]="SPRING",e[e.WHEEL=3]="WHEEL",e[e.MOUSE=4]="MOUSE",e[e.FIXED=5]="FIXED",e[e.SLIDER=6]="SLIDER",e[e.RELATIVE=7]="RELATIVE",e[e.HINGE=8]="HINGE"}(C4||(C4=e("EJoint2DType",{}))),rt(C4),function(e){e[e.DEFAULT=1]="DEFAULT"}(A4||(A4=e("PhysicsGroup",{}))),rt(A4),function(e){e[e.Closest=0]="Closest",e[e.Any=1]="Any",e[e.AllClosest=2]="AllClosest",e[e.All=3]="All"}(b4||(b4=e("ERaycast2DType",{})));var E4,w4=e("Contact2DType",{None:"none-contact",BEGIN_CONTACT:"begin-contact",END_CONTACT:"end-contact",PRE_SOLVE:"pre-solve",POST_SOLVE:"post-solve"});!function(e){e[e.None=0]="None",e[e.Shape=1]="Shape",e[e.Joint=2]="Joint",e[e.Aabb=4]="Aabb",e[e.Pair=8]="Pair",e[e.CenterOfMass=16]="CenterOfMass",e[e.Particle=32]="Particle",e[e.Controller=64]="Controller",e[e.All=63]="All"}(E4||(E4=e("EPhysics2DDrawFlags",{})));var I4=e("PHYSICS_2D_PTM_RATIO",32),P4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._contactFixtures=[],t._BeginContact=null,t._EndContact=null,t._PreSolve=null,t._PostSolve=null,t}Z(t,e);var n=t.prototype;return n.setBeginContact=function(e){this._BeginContact=e},n.setEndContact=function(e){this._EndContact=e},n.setPreSolve=function(e){this._PreSolve=e},n.setPostSolve=function(e){this._PostSolve=e},n.BeginContact=function(e){if(this._BeginContact){var t=e.GetFixtureA(),n=e.GetFixtureB(),i=this._contactFixtures;e._shouldReport=!1,-1===i.indexOf(t)&&-1===i.indexOf(n)||(e._shouldReport=!0,this._BeginContact(e))}},n.EndContact=function(e){this._EndContact&&e._shouldReport&&(e._shouldReport=!1,this._EndContact(e))},n.PreSolve=function(e,t){this._PreSolve&&e._shouldReport&&this._PreSolve(e,t)},n.PostSolve=function(e,t){this._PostSolve&&e._shouldReport&&this._PostSolve(e,t)},n.registerContactFixture=function(e){this._contactFixtures.push(e)},n.unregisterContactFixture=function(e){_e(this._contactFixtures,e)},t}(T4.ContactListener),R4=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._point=new T4.Vec2,t._isPoint=!1,t._fixtures=[],t}Z(t,e);var n=t.prototype;return n.init=function(e){e?(this._isPoint=!0,this._point.x=e.x,this._point.y=e.y):this._isPoint=!1,this._fixtures.length=0},n.ReportFixture=function(e){return this._isPoint?e.TestPoint(this._point)&&this._fixtures.push(e):this._fixtures.push(e),!0},n.getFixture=function(){return this._fixtures[0]},n.getFixtures=function(){return this._fixtures},t}(T4.QueryCallback);function D4(e,t){var n=t.length;return t[e<0?n- -e%n:e%n]}function O4(e,t,n){for(var i=[];t<e;)t+=n.length;for(;e<=t;++e)i.push(D4(e,n));return i}function N4(e){U4(e);for(var t,n,i,r,o,a,s=[],c=new Yn,l=new Yn,u=0,h=0,_=0;_<e.length;++_)if(M4(_,e)){n=i=1e8;for(var f=0;f<e.length;++f)F4(D4(_-1,e),D4(_,e),D4(f,e))&&V4(D4(_-1,e),D4(_,e),D4(f-1,e))&&(r=H4(D4(_-1,e),D4(_,e),D4(f,e),D4(f-1,e)),L4(D4(_+1,e),D4(_,e),r)&&(t=G4(D4(_,e),r))<n&&(n=t,c=r,u=f)),F4(D4(_+1,e),D4(_,e),D4(f+1,e))&&V4(D4(_+1,e),D4(_,e),D4(f,e))&&(r=H4(D4(_+1,e),D4(_,e),D4(f,e),D4(f+1,e)),F4(D4(_-1,e),D4(_,e),r)&&(t=G4(D4(_,e),r))<i&&(i=t,h=f,l=r));if(u==(h+1)%e.length){var d=c.add(l).multiplyScalar(.5);(o=O4(_,h,e)).push(d),(a=O4(u,_,e)).push(d)}else{for(var p=0,m=u;h<u;)h+=e.length;for(var v=u;v<=h;++v)if(B4(_,v,e)){var g=1/(G4(D4(_,e),D4(v,e))+1);M4(v,e)?V4(D4(v-1,e),D4(v,e),D4(_,e))&&z4(D4(v+1,e),D4(v,e),D4(_,e))?g+=3:g+=2:g+=1,g>p&&(m=v,p=g)}o=O4(_,m,e),a=O4(m,_,e)}return(s=s.concat(N4(o))).concat(N4(a))}s.push(e);for(var y=s.length-1;y>=0;y--)0==s[y].length&&s.splice(y,0);return s}function B4(e,t,n){if(M4(e,n)){if(z4(D4(e,n),D4(e-1,n),D4(t,n))&&V4(D4(e,n),D4(e+1,n),D4(t,n)))return!1}else if(V4(D4(e,n),D4(e+1,n),D4(t,n))||z4(D4(e,n),D4(e-1,n),D4(t,n)))return!1;if(M4(t,n)){if(z4(D4(t,n),D4(t-1,n),D4(e,n))&&V4(D4(t,n),D4(t+1,n),D4(e,n)))return!1}else if(V4(D4(t,n),D4(t+1,n),D4(e,n))||z4(D4(t,n),D4(t-1,n),D4(e,n)))return!1;for(var i=0;i<n.length;++i)if((i+1)%n.length!=e&&i!=e&&(i+1)%n.length!=t&&i!=t){var r=new Yn;if(j4(D4(e,n),D4(t,n),D4(i,n),D4(i+1,n),r))return!1}return!0}function M4(e,t){return L4(e,t)}function L4(e,t,n){if(void 0===n){var i=e,r=t;e=D4(i-1,r),t=D4(i,r),n=D4(i+1,r)}return W4(e,t,n)<0}function F4(e,t,n){return W4(e,t,n)>0}function z4(e,t,n){return W4(e,t,n)>=0}function V4(e,t,n){return W4(e,t,n)<=0}function G4(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i}function U4(e){k4(e)||e.reverse()}function k4(e){return e.length<3||function(e){var t,n=0;for(t=0;t<e.length;t++){var i=(t+1)%e.length;n+=e[t].x*e[i].y,n-=e[t].y*e[i].x}return n/2}(e)>0}function H4(e,t,n,i){var r,o=new Yn,a=t.y-e.y,s=e.x-t.x,c=a*e.x+s*e.y,l=i.y-n.y,u=n.x-i.x,h=l*n.x+u*n.y,_=a*u-l*s;return r=_,0,Math.abs(r-0)<=1e-6||(o.x=(u*c-s*h)/_,o.y=(a*h-l*c)/_),o}function j4(e,t,n,i,r){if(e==n||e==i||t==n||t==i)return!1;var o=e.x,a=e.y,s=t.x,c=t.y,l=n.x,u=n.y,h=i.x,_=i.y;if(Math.max(o,s)<Math.min(l,h)||Math.max(l,h)<Math.min(o,s))return!1;if(Math.max(a,c)<Math.min(u,_)||Math.max(u,_)<Math.min(a,c))return!1;var f=(h-l)*(a-u)-(_-u)*(o-l),d=(s-o)*(a-u)-(c-a)*(o-l),p=(_-u)*(s-o)-(h-l)*(c-a);return!(Math.abs(p)<1e-6)&&(d/=p,(f/=p)>0&&f<1&&d>0&&d<1&&(r.x=o+f*(s-o),r.y=a+f*(c-a),!0))}function W4(e,t,n){return e.x*(t.y-n.y)+t.x*(n.y-e.y)+n.x*(e.y-t.y)}var q4=Object.freeze({__proto__:null,ConvexPartition:N4,ForceCounterClockWise:U4,IsCounterClockWise:k4}),X4=function(){return 0},Y4={impl:null,rigidBody:null,isAwake:!1,isSleeping:!1,initialize:X4,setType:X4,setLinearDamping:X4,setAngularDamping:X4,setGravityScale:X4,setFixedRotation:X4,setAllowSleep:X4,isActive:X4,setActive:X4,wakeUp:X4,sleep:X4,getMass:X4,getInertia:X4,getLinearVelocity:X4,setLinearVelocity:X4,getLinearVelocityFromWorldPoint:X4,getAngularVelocity:X4,setAngularVelocity:X4,getLocalVector:X4,getWorldVector:X4,getLocalPoint:X4,getWorldPoint:X4,getLocalCenter:X4,getWorldCenter:X4,applyForce:X4,applyForceToCenter:X4,applyTorque:X4,applyLinearImpulse:X4,applyLinearImpulseToCenter:X4,applyAngularImpulse:X4,onEnable:X4,onDisable:X4,onDestroy:X4},K4={INITED:!1};var J4,Q4,Z4,$4,e3,t3,n3={INITED:!1},i3={impl:null,initialize:X4,setDampingRatio:X4,setFrequency:X4,setMaxForce:X4,setTarget:X4,setDistance:X4,setAngularOffset:X4,setCorrectionFactor:X4,setLinearOffset:X4,setMaxLength:X4,setMaxTorque:X4,setLowerLimit:X4,setUpperLimit:X4,setMaxMotorForce:X4,setMaxMotorTorque:X4,setMotorSpeed:X4,enableLimit:X4,enableMotor:X4,setLowerAngle:X4,setUpperAngle:X4};!function(e){e[e.DYNAMIC=1]="DYNAMIC",e[e.STATIC=2]="STATIC",e[e.KINEMATIC=4]="KINEMATIC"}(J4||(J4={})),rt(J4),function(e){e[e.X_AXIS=0]="X_AXIS",e[e.Y_AXIS=1]="Y_AXIS",e[e.Z_AXIS=2]="Z_AXIS"}(Q4||(Q4={})),rt(Q4),function(e){e[e.VERTEX=1]="VERTEX",e[e.LINE=2]="LINE",e[e.TRIANGLE=3]="TRIANGLE",e[e.TETRAHEDRON=4]="TETRAHEDRON"}(Z4||(Z4={})),rt(Z4),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CAPSULE=2]="CAPSULE",e[e.CYLINDER=3]="CYLINDER",e[e.CONE=4]="CONE",e[e.MESH=5]="MESH",e[e.PLANE=6]="PLANE",e[e.SIMPLEX=7]="SIMPLEX",e[e.TERRAIN=8]="TERRAIN"}($4||($4={})),rt($4),function(e){e[e.POINT_TO_POINT=0]="POINT_TO_POINT",e[e.HINGE=1]="HINGE",e[e.CONE_TWIST=2]="CONE_TWIST"}(e3||(e3={})),rt(e3),function(e){e[e.DEFAULT=1]="DEFAULT"}(t3||(t3={})),rt(t3);var r3=function(e){if(1===e){for(var t=this,n=function(e){var n="_"+(1<<e);t[n]=0,t.updateArray=[],Object.defineProperty(t,1<<e,{get:function(){return this[n]},set:function(t){this[n]!==t&&(this[n]=t,this.updateArray.indexOf(e)<0&&this.updateArray.push(e))}})},i=0;i<32;i++)n(i);this._1=t3.DEFAULT}else{for(var r=0;r<32;r++)this[""+(1<<r)]=0;this[1]=t3.DEFAULT}},o3=null;l.internal.PhysicsGroup2D=A4;var a3,s3,c3,l3,u3,h3,_3,f3,d3,p3,m3,v3,g3,y3,x3,S3,C3,A3,b3,T3=e("PhysicsSystem2D",function(e){function t(){var t;(t=e.call(this)||this).velocityIterations=10,t.positionIterations=10,t.physicsWorld=void 0,t.collisionMatrix=new r3,t._enable=!0,t._allowSleep=!0,t._maxSubSteps=1,t._fixedTimeStep=1/60,t._autoSimulation=!0,t._accumulator=0,t._steping=!1,t._gravity=new Yn(0,-10*I4),t._delayEvents=[];var n=QO.config?QO.config.physics:null;if(n){if(Yn.copy(t._gravity,n.gravity),t._gravity.multiplyScalar(I4),t._allowSleep=n.allowSleep,t._fixedTimeStep=n.fixedTimeStep,t._maxSubSteps=n.maxSubSteps,t._autoSimulation=n.autoSimulation,n.collisionMatrix)for(var i in n.collisionMatrix){var r=parseInt(i),o=1<<parseInt(i);t.collisionMatrix[""+o]=n.collisionMatrix[r]}if(n.collisionGroups){var a=n.collisionGroups;a instanceof Array&&(a.forEach((function(e){A4[e.name]=1<<e.index})),rt.update(A4))}}return t.physicsWorld=new _4.PhysicsWorld,t.gravity=t._gravity,t.allowSleep=t._allowSleep,t}Z(t,e);var n=t.prototype;return n.postUpdate=function(e){if(this._enable&&this._autoSimulation){$O.emit(ZO.EVENT_BEFORE_PHYSICS),this._steping=!0;var t=this._fixedTimeStep,n=this.velocityIterations,i=this.positionIterations;this._accumulator+=e;for(var r=0;r++<this._maxSubSteps&&this._accumulator>t;)this.physicsWorld.step(t,n,i),this._accumulator-=t;for(var o=this._delayEvents,a=0,s=o.length;a<s;a++){var c=o[a];c.func.call(c.target)}o.length=0,this.physicsWorld.syncPhysicsToScene(),this.debugDrawFlags&&this.physicsWorld.drawDebug(),this._steping=!1,$O.emit(ZO.EVENT_AFTER_PHYSICS)}},n._callAfterStep=function(e,t){this._steping?this._delayEvents.push({target:e,func:t}):t.call(e)},n.resetAccumulator=function(e){void 0===e&&(e=0),this._accumulator=e},n.step=function(e){this.physicsWorld.step(e,this.velocityIterations,this.positionIterations)},n.raycast=function(e,t,n,i){return void 0===n&&(n=b4.Closest),void 0===i&&(i=4294967295),this.physicsWorld.raycast(e,t,n,i)},n.testPoint=function(e){return this.physicsWorld.testPoint(e)},n.testAABB=function(e){return this.physicsWorld.testAABB(e)},J(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.physicsWorld.setAllowSleep(e)}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity.set(e),this.physicsWorld.setGravity(new Yn(e.x/I4,e.y/I4))}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(e){this._maxSubSteps=e}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(e){this._fixedTimeStep=e}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(e){this._autoSimulation=e}},{key:"debugDrawFlags",get:function(){return this.physicsWorld.debugDrawFlags},set:function(e){this.physicsWorld.debugDrawFlags=e}},{key:"stepping",get:function(){return this._steping}}],[{key:"PHYSICS_NONE",get:function(){return!f4}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===f4}},{key:"PHYSICS_BOX2D",get:function(){return"box2d"===f4}},{key:"PhysicsGroup",get:function(){return A4}},{key:"instance",get:function(){return o3||(o3=new t),o3}}]),t}($l(VO)));T3.ID="PHYSICS_2D",$O.once(ZO.EVENT_INIT,(function(){T3.PHYSICS_NONE||$O.registerSystem(T3.ID,T3.instance,VO.Priority.LOW)})),function(e){e[e.Circles=0]="Circles",e[e.FaceA=1]="FaceA",e[e.FaceB=2]="FaceB"}(a3||(a3=e("Physics2DManifoldType",{})));var E3,w3,I3,P3,R3,D3,O3,N3,B3,M3,L3,F3,z3,V3,G3,U3,k3,H3,j3,W3,q3,X3,Y3,K3,J3,Q3,Z3,$3,e5,t5,n5,i5,r5,o5,a5,s5,c5,l5,u5,h5,_5,f5,d5,p5,m5,v5,g5,y5,x5,S5,C5,A5,b5,T5,E5,w5,I5,P5,R5,D5,O5,N5,B5,M5,L5,F5,z5,V5,G5,U5,k5,H5,j5,W5,q5,X5,Y5,K5,J5,Q5,Z5,$5,e6,t6,n6,i6,r6,o6,a6,s6,c6,l6,u6=wc,h6=ol,_6=Fc,f6=e("RigidBody2D",(s3=Ac("cc.RigidBody2D"),c3=_6(),l3=h6(t3),u3=h6(x4),s3(h3=c3((ce((_3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"enabledContactListener",f3,re(t)),se(t,"bullet",d3,re(t)),se(t,"awakeOnLoad",p3,re(t)),t._body=null,se(t,"_group",m3,re(t)),se(t,"_type",v3,re(t)),se(t,"_allowSleep",g3,re(t)),se(t,"_gravityScale",y3,re(t)),se(t,"_linearDamping",x3,re(t)),se(t,"_angularDamping",S3,re(t)),se(t,"_linearVelocity",C3,re(t)),se(t,"_angularVelocity",A3,re(t)),se(t,"_fixedRotation",b3,re(t)),t}Z(t,e);var n=t.prototype;return n.isAwake=function(){return!!this._body&&this._body.isAwake},n.wakeUp=function(){this._body&&this._body.wakeUp()},n.sleep=function(){this._body&&this._body.sleep()},n.getMass=function(){return this._body?this._body.getMass():0},n.applyForce=function(e,t,n){this._body&&this._body.applyForce(e,t,n)},n.applyForceToCenter=function(e,t){this._body&&this._body.applyForceToCenter(e,t)},n.applyTorque=function(e,t){this._body&&this._body.applyTorque(e,t)},n.applyLinearImpulse=function(e,t,n){this._body&&this._body.applyLinearImpulse(e,t,n)},n.applyLinearImpulseToCenter=function(e,t){this._body&&this._body.applyLinearImpulseToCenter(e,t)},n.applyAngularImpulse=function(e,t){this._body&&this._body.applyAngularImpulse(e,t)},n.getLinearVelocityFromWorldPoint=function(e,t){return this._body?this._body.getLinearVelocityFromWorldPoint(e,t):t},n.getLocalVector=function(e,t){return this._body?this._body.getLocalVector(e,t):t},n.getWorldVector=function(e,t){return this._body?this._body.getWorldVector(e,t):t},n.getLocalPoint=function(e,t){return this._body?this._body.getLocalPoint(e,t):t},n.getWorldPoint=function(e,t){return this._body?this._body.getWorldPoint(e,t):t},n.getLocalCenter=function(e){return this._body?this._body.getLocalCenter(e):e},n.getWorldCenter=function(e){return this._body?this._body.getWorldCenter(e):e},n.getInertia=function(){return this._body&&this._body.getInertia(),0},n.onLoad=function(){this._body=l._global.CC_PHYSICS_2D_BUILTIN?Y4:new _4.RigidBody,this._body.initialize(this)},n.onEnable=function(){this._body&&this._body.onEnable()},n.onDisable=function(){this._body&&this._body.onDisable()},n.onDestroy=function(){this._body&&this._body.onDestroy()},J(t,[{key:"group",get:function(){return this._group},set:function(e){this._group=e}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._body&&(e===x4.Animated?this._body.setType(x4.Kinematic):this._body.setType(e))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._body&&this._body.setAllowSleep(e)}},{key:"gravityScale",get:function(){return this._gravityScale},set:function(e){this._gravityScale=e,this._body&&this._body.setGravityScale(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body&&this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body&&this._body.setAngularDamping(e)}},{key:"linearVelocity",get:function(){return this._body&&this._body.getLinearVelocity(this._linearVelocity),this._linearVelocity},set:function(e){this._linearVelocity=e,this._body&&this._body.setLinearVelocity(e)}},{key:"angularVelocity",get:function(){return this._body&&(this._angularVelocity=this._body.getAngularVelocity()),this._angularVelocity},set:function(e){this._angularVelocity=e,this._body&&this._body.setAngularVelocity(e)}},{key:"fixedRotation",get:function(){return this._fixedRotation},set:function(e){this._fixedRotation=e,this._body&&this._body.setFixedRotation(e)}},{key:"impl",get:function(){return this._body}}]),t}(Ku)).prototype,"group",[l3],Object.getOwnPropertyDescriptor(_3.prototype,"group"),_3.prototype),f3=ce(_3.prototype,"enabledContactListener",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),d3=ce(_3.prototype,"bullet",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ce(_3.prototype,"type",[u3],Object.getOwnPropertyDescriptor(_3.prototype,"type"),_3.prototype),ce(_3.prototype,"allowSleep",[u6],Object.getOwnPropertyDescriptor(_3.prototype,"allowSleep"),_3.prototype),ce(_3.prototype,"gravityScale",[u6],Object.getOwnPropertyDescriptor(_3.prototype,"gravityScale"),_3.prototype),ce(_3.prototype,"linearDamping",[u6],Object.getOwnPropertyDescriptor(_3.prototype,"linearDamping"),_3.prototype),ce(_3.prototype,"angularDamping",[u6],Object.getOwnPropertyDescriptor(_3.prototype,"angularDamping"),_3.prototype),ce(_3.prototype,"linearVelocity",[u6],Object.getOwnPropertyDescriptor(_3.prototype,"linearVelocity"),_3.prototype),ce(_3.prototype,"angularVelocity",[u6],Object.getOwnPropertyDescriptor(_3.prototype,"angularVelocity"),_3.prototype),ce(_3.prototype,"fixedRotation",[u6],Object.getOwnPropertyDescriptor(_3.prototype,"fixedRotation"),_3.prototype),p3=ce(_3.prototype,"awakeOnLoad",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),m3=ce(_3.prototype,"_group",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return t3.DEFAULT}}),v3=ce(_3.prototype,"_type",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return x4.Dynamic}}),g3=ce(_3.prototype,"_allowSleep",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),y3=ce(_3.prototype,"_gravityScale",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),x3=ce(_3.prototype,"_linearDamping",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S3=ce(_3.prototype,"_angularDamping",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),C3=ce(_3.prototype,"_linearVelocity",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn}}),A3=ce(_3.prototype,"_angularVelocity",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),b3=ce(_3.prototype,"_fixedRotation",[u6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),h3=_3))||h3)||h3)),d6=e("Collider2D",(E3=Ac("cc.Collider2D"),w3=ol(t3),E3((z3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"editing",R3,re(t)),se(t,"tag",D3,re(t)),t.TYPE=S4.None,t._shape=null,t._body=null,se(t,"_group",O3,re(t)),se(t,"_density",N3,re(t)),se(t,"_sensor",B3,re(t)),se(t,"_friction",M3,re(t)),se(t,"_restitution",L3,re(t)),se(t,"_offset",F3,re(t)),t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this._shape=function(e){return K4.INITED||(K4.INITED=!0,K4[S4.BOX]=function(){return new _4.BoxShape},K4[S4.CIRCLE]=function(){return new _4.CircleShape},K4[S4.POLYGON]=function(){return new _4.PolygonShape}),K4[e]()}(this.TYPE),this._shape.initialize(this),this._shape.onLoad&&this._shape.onLoad(),this._body=this.getComponent(f6)},n.onEnable=function(){this._shape&&this._shape.onEnable()},n.onDisable=function(){this._shape&&this._shape.onDisable&&this._shape.onDisable()},n.onDestroy=function(){this._shape&&this._shape.onDestroy&&this._shape.onDestroy()},n.apply=function(){this._shape&&this._shape.apply&&this._shape.apply()},J(t,[{key:"group",get:function(){return this._group},set:function(e){this._group=e,this._shape&&this._shape.onGroupChanged&&this._shape.onGroupChanged()}},{key:"density",get:function(){return this._density},set:function(e){this._density=e}},{key:"sensor",get:function(){return this._sensor},set:function(e){this._sensor=e}},{key:"friction",get:function(){return this._friction},set:function(e){this._friction=e}},{key:"restitution",get:function(){return this._restitution},set:function(e){this._restitution=e}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e}},{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._shape}},{key:"worldAABB",get:function(){return this._shape?this._shape.worldAABB:new ii}}]),t}($l(Ku)),R3=ce((P3=z3).prototype,"editing",[kc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),D3=ce(P3.prototype,"tag",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ce(P3.prototype,"group",[w3],Object.getOwnPropertyDescriptor(P3.prototype,"group"),P3.prototype),ce(P3.prototype,"density",[wc],Object.getOwnPropertyDescriptor(P3.prototype,"density"),P3.prototype),ce(P3.prototype,"sensor",[wc],Object.getOwnPropertyDescriptor(P3.prototype,"sensor"),P3.prototype),ce(P3.prototype,"friction",[wc],Object.getOwnPropertyDescriptor(P3.prototype,"friction"),P3.prototype),ce(P3.prototype,"restitution",[wc],Object.getOwnPropertyDescriptor(P3.prototype,"restitution"),P3.prototype),ce(P3.prototype,"offset",[wc],Object.getOwnPropertyDescriptor(P3.prototype,"offset"),P3.prototype),O3=ce(P3.prototype,"_group",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return t3.DEFAULT}}),N3=ce(P3.prototype,"_density",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),B3=ce(P3.prototype,"_sensor",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),M3=ce(P3.prototype,"_friction",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.2}}),L3=ce(P3.prototype,"_restitution",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),F3=ce(P3.prototype,"_offset",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn}}),I3=P3))||I3)),p6=(e("BoxCollider2D",Ac("cc.BoxCollider2D")(V3=Fc()((k3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_size",U3,re(t)),t.TYPE=S4.BOX,t}return Z(t,e),J(t,[{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),t}(d6),U3=ce((G3=k3).prototype,"_size",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(1,1)}}),ce(G3.prototype,"size",[wc],Object.getOwnPropertyDescriptor(G3.prototype,"size"),G3.prototype),V3=G3))||V3)||V3),e("CircleCollider2D",Ac("cc.CircleCollider2D")(H3=Fc()((q3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_radius",W3,re(t)),t.TYPE=S4.CIRCLE,t}return Z(t,e),J(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e<0?0:e}},{key:"worldPosition",get:function(){return this._shape?this._shape.worldPosition:new Yn}},{key:"worldRadius",get:function(){return this._shape?this._shape.worldRadius:0}}]),t}(d6),W3=ce((j3=q3).prototype,"_radius",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ce(j3.prototype,"radius",[wc],Object.getOwnPropertyDescriptor(j3.prototype,"radius"),j3.prototype),H3=j3))||H3)||H3),e("PolygonCollider2D",(X3=Ac("cc.PolygonCollider2D"),Y3=Fc(),K3=wc({serializable:!1,displayOrder:0}),J3=wc({type:Yn}),X3(Q3=Y3((t5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"threshold",$3,re(t)),se(t,"_points",e5,re(t)),t.TYPE=S4.POLYGON,t}return Z(t,e),J(t,[{key:"points",get:function(){return this._points},set:function(e){this._points=e}},{key:"worldPoints",get:function(){return this._shape?this._shape.worldPoints:[]}}]),t}(d6),$3=ce((Z3=t5).prototype,"threshold",[K3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),e5=ce(Z3.prototype,"_points",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new Yn(-1,-1),new Yn(1,-1),new Yn(1,1),new Yn(-1,1)]}}),ce(Z3.prototype,"points",[J3],Object.getOwnPropertyDescriptor(Z3.prototype,"points"),Z3.prototype),Q3=Z3))||Q3)||Q3)),e("Joint2D",(n5=Ac("cc.Joint2D"),i5=ol(f6),n5((u5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"anchor",a5,re(t)),se(t,"connectedAnchor",s5,re(t)),se(t,"collideConnected",c5,re(t)),se(t,"connectedBody",l5,re(t)),t._body=null,t._joint=null,t.TYPE=C4.None,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this._joint=function(e){return function(){if(!n3.INITED){n3.INITED=!0;var e=l._global.CC_PHYSICS_2D_BUILTIN;n3[C4.SPRING]=function(){return e?i3:new _4.SpringJoint},n3[C4.DISTANCE]=function(){return e?i3:new _4.DistanceJoint},n3[C4.FIXED]=function(){return e?i3:new _4.FixedJoint},n3[C4.MOUSE]=function(){return e?i3:new _4.MouseJoint},n3[C4.RELATIVE]=function(){return e?i3:new _4.RelativeJoint},n3[C4.SLIDER]=function(){return e?i3:new _4.SliderJoint},n3[C4.WHEEL]=function(){return e?i3:new _4.WheelJoint},n3[C4.HINGE]=function(){return e?i3:new _4.HingeJoint}}}(),n3[e]()}(this.TYPE),this._joint.initialize(this),this._body=this.getComponent(f6)},n.onEnable=function(){this._joint&&this._joint.onEnable&&this._joint.onEnable()},n.onDisable=function(){this._joint&&this._joint.onDisable&&this._joint.onDisable()},n.start=function(){this._joint&&this._joint.start&&this._joint.start()},n.onDestroy=function(){this._joint&&this._joint.onDestroy&&this._joint.onDestroy()},J(t,[{key:"body",get:function(){return this._body}},{key:"impl",get:function(){return this._joint}}]),t}(Ku),a5=ce((o5=u5).prototype,"anchor",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn}}),s5=ce(o5.prototype,"connectedAnchor",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn}}),c5=ce(o5.prototype,"collideConnected",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),l5=ce(o5.prototype,"connectedBody",[i5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),r5=o5))||r5))),m6=(e("DistanceJoint2D",Ac("cc.DistanceJoint2D")(h5=Fc()((ce((_5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).TYPE=C4.DISTANCE,se(t,"_maxLength",f5,re(t)),se(t,"_autoCalcDistance",d5,re(t)),t}return Z(t,e),J(t,[{key:"maxLength",get:function(){return this._autoCalcDistance&&this.connectedBody?Pn.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._maxLength},set:function(e){this._maxLength=e,this._joint&&this._joint.setMaxLength(e)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(e){this._autoCalcDistance=e}}]),t}(p6)).prototype,"maxLength",[wc],Object.getOwnPropertyDescriptor(_5.prototype,"maxLength"),_5.prototype),ce(_5.prototype,"autoCalcDistance",[wc],Object.getOwnPropertyDescriptor(_5.prototype,"autoCalcDistance"),_5.prototype),f5=ce(_5.prototype,"_maxLength",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),d5=ce(_5.prototype,"_autoCalcDistance",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),h5=_5))||h5)||h5),e("SpringJoint2D",Ac("cc.SpringJoint2D")(p5=Fc()((ce((m5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).TYPE=C4.SPRING,se(t,"_frequency",v5,re(t)),se(t,"_dampingRatio",g5,re(t)),se(t,"_distance",y5,re(t)),se(t,"_autoCalcDistance",x5,re(t)),t}return Z(t,e),J(t,[{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}},{key:"distance",get:function(){return this._autoCalcDistance&&this.connectedBody?Pn.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._distance},set:function(e){this._distance=e,this._joint&&this._joint.setDistance(e)}},{key:"autoCalcDistance",get:function(){return this._autoCalcDistance},set:function(e){this._autoCalcDistance=e}}]),t}(p6)).prototype,"frequency",[wc],Object.getOwnPropertyDescriptor(m5.prototype,"frequency"),m5.prototype),ce(m5.prototype,"dampingRatio",[wc],Object.getOwnPropertyDescriptor(m5.prototype,"dampingRatio"),m5.prototype),ce(m5.prototype,"distance",[wc],Object.getOwnPropertyDescriptor(m5.prototype,"distance"),m5.prototype),ce(m5.prototype,"autoCalcDistance",[wc],Object.getOwnPropertyDescriptor(m5.prototype,"autoCalcDistance"),m5.prototype),v5=ce(m5.prototype,"_frequency",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),g5=ce(m5.prototype,"_dampingRatio",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),y5=ce(m5.prototype,"_distance",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),x5=ce(m5.prototype,"_autoCalcDistance",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),p5=m5))||p5)||p5),e("MouseJoint2D",Ac("cc.MouseJoint2D")(S5=Fc()((ce((C5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).TYPE=C4.MOUSE,se(t,"_maxForce",A5,re(t)),se(t,"_dampingRatio",b5,re(t)),se(t,"_frequency",T5,re(t)),t._target=new Yn,t}return Z(t,e),t.prototype.update=function(e){this._joint.update(e)},J(t,[{key:"target",get:function(){return this._target},set:function(e){this._target=e,this._joint&&this._joint.setTarget(e)}},{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}},{key:"maxForce",get:function(){return this._maxForce},set:function(e){this._maxForce=e,this._joint&&this._joint.setMaxForce(e)}}]),t}(p6)).prototype,"frequency",[wc],Object.getOwnPropertyDescriptor(C5.prototype,"frequency"),C5.prototype),ce(C5.prototype,"dampingRatio",[wc],Object.getOwnPropertyDescriptor(C5.prototype,"dampingRatio"),C5.prototype),ce(C5.prototype,"maxForce",[wc],Object.getOwnPropertyDescriptor(C5.prototype,"maxForce"),C5.prototype),A5=ce(C5.prototype,"_maxForce",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),b5=ce(C5.prototype,"_dampingRatio",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),T5=ce(C5.prototype,"_frequency",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),S5=C5))||S5)||S5),new Pn),v6=new Pn,g6=(e("RelativeJoint2D",Ac("cc.RelativeJoint2D")(E5=Fc()((ce((w5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).TYPE=C4.RELATIVE,se(t,"_maxForce",I5,re(t)),se(t,"_maxTorque",P5,re(t)),se(t,"_correctionFactor",R5,re(t)),se(t,"_angularOffset",D5,re(t)),se(t,"_linearOffset",O5,re(t)),se(t,"_autoCalcOffset",N5,re(t)),t}return Z(t,e),J(t,[{key:"maxForce",get:function(){return this._maxForce},set:function(e){this._maxForce=e,this._joint&&this._joint.setMaxForce(e)}},{key:"maxTorque",get:function(){return this._maxTorque},set:function(e){this._maxTorque=e,this._joint&&this._joint.setMaxTorque(e)}},{key:"correctionFactor",get:function(){return this._correctionFactor},set:function(e){this._correctionFactor=e,this._joint&&this._joint.setCorrectionFactor(e)}},{key:"linearOffset",get:function(){return this._autoCalcOffset&&this.connectedBody?Yn.subtract(this._linearOffset,this.connectedBody.node.worldPosition,this.node.worldPosition):this._linearOffset},set:function(e){this._linearOffset.set(e),this._joint&&this._joint.setLinearOffset(e)}},{key:"angularOffset",get:function(){return this._autoCalcOffset&&this.connectedBody&&(Ln.toEuler(m6,this.node.worldRotation),Ln.toEuler(v6,this.connectedBody.node.worldRotation),this._angularOffset=v6.z-m6.z),this._angularOffset},set:function(e){this._angularOffset=e,this._joint&&this._joint.setAngularOffset(e)}},{key:"autoCalcOffset",get:function(){return this._autoCalcOffset},set:function(e){this._autoCalcOffset=e}}]),t}(p6)).prototype,"maxForce",[wc],Object.getOwnPropertyDescriptor(w5.prototype,"maxForce"),w5.prototype),ce(w5.prototype,"maxTorque",[wc],Object.getOwnPropertyDescriptor(w5.prototype,"maxTorque"),w5.prototype),ce(w5.prototype,"correctionFactor",[wc],Object.getOwnPropertyDescriptor(w5.prototype,"correctionFactor"),w5.prototype),ce(w5.prototype,"linearOffset",[wc],Object.getOwnPropertyDescriptor(w5.prototype,"linearOffset"),w5.prototype),ce(w5.prototype,"angularOffset",[wc],Object.getOwnPropertyDescriptor(w5.prototype,"angularOffset"),w5.prototype),ce(w5.prototype,"autoCalcOffset",[wc],Object.getOwnPropertyDescriptor(w5.prototype,"autoCalcOffset"),w5.prototype),I5=ce(w5.prototype,"_maxForce",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),P5=ce(w5.prototype,"_maxTorque",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),R5=ce(w5.prototype,"_correctionFactor",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),D5=ce(w5.prototype,"_angularOffset",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),O5=ce(w5.prototype,"_linearOffset",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Yn}}),N5=ce(w5.prototype,"_autoCalcOffset",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),E5=w5))||E5)||E5),new Yn),y6=(e("SliderJoint2D",Ac("cc.SliderJoint2D")(B5=Fc()((ce((M5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).TYPE=C4.SLIDER,se(t,"_angle",L5,re(t)),se(t,"_autoCalcAngle",F5,re(t)),se(t,"_enableMotor",z5,re(t)),se(t,"_maxMotorForce",V5,re(t)),se(t,"_motorSpeed",G5,re(t)),se(t,"_enableLimit",U5,re(t)),se(t,"_lowerLimit",k5,re(t)),se(t,"_upperLimit",H5,re(t)),t}return Z(t,e),J(t,[{key:"angle",get:function(){return this._autoCalcAngle&&this.connectedBody&&(Yn.subtract(g6,this.connectedBody.node.worldPosition,this.node.worldPosition),this._angle=_n(Math.atan2(g6.y,g6.x))),this._angle},set:function(e){this._angle=e}},{key:"autoCalcAngle",get:function(){return this._autoCalcAngle},set:function(e){this._autoCalcAngle=e}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(e){this._enableMotor=e}},{key:"maxMotorForce",get:function(){return this._maxMotorForce},set:function(e){this._maxMotorForce=e,this._joint&&this._joint.setMaxMotorForce(e)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(e){this._motorSpeed=e,this._joint&&this._joint.setMotorSpeed(e)}},{key:"enableLimit",get:function(){return this._enableLimit},set:function(e){this._enableLimit=e}},{key:"lowerLimit",get:function(){return this._lowerLimit},set:function(e){this._lowerLimit=e,this._joint&&this._joint.setLowerLimit(e)}},{key:"upperLimit",get:function(){return this._upperLimit},set:function(e){this._upperLimit=e,this._joint&&this._joint.setUpperLimit(e)}}]),t}(p6)).prototype,"angle",[wc],Object.getOwnPropertyDescriptor(M5.prototype,"angle"),M5.prototype),ce(M5.prototype,"autoCalcAngle",[wc],Object.getOwnPropertyDescriptor(M5.prototype,"autoCalcAngle"),M5.prototype),ce(M5.prototype,"enableMotor",[wc],Object.getOwnPropertyDescriptor(M5.prototype,"enableMotor"),M5.prototype),ce(M5.prototype,"maxMotorForce",[wc],Object.getOwnPropertyDescriptor(M5.prototype,"maxMotorForce"),M5.prototype),ce(M5.prototype,"motorSpeed",[wc],Object.getOwnPropertyDescriptor(M5.prototype,"motorSpeed"),M5.prototype),ce(M5.prototype,"enableLimit",[wc],Object.getOwnPropertyDescriptor(M5.prototype,"enableLimit"),M5.prototype),ce(M5.prototype,"lowerLimit",[wc],Object.getOwnPropertyDescriptor(M5.prototype,"lowerLimit"),M5.prototype),ce(M5.prototype,"upperLimit",[wc],Object.getOwnPropertyDescriptor(M5.prototype,"upperLimit"),M5.prototype),L5=ce(M5.prototype,"_angle",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),F5=ce(M5.prototype,"_autoCalcAngle",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),z5=ce(M5.prototype,"_enableMotor",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),V5=ce(M5.prototype,"_maxMotorForce",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),G5=ce(M5.prototype,"_motorSpeed",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),U5=ce(M5.prototype,"_enableLimit",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k5=ce(M5.prototype,"_lowerLimit",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),H5=ce(M5.prototype,"_upperLimit",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),B5=M5))||B5)||B5),e("FixedJoint2D",Ac("cc.FixedJoint2D")(j5=Fc()((ce((W5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).TYPE=C4.FIXED,se(t,"_frequency",q5,re(t)),se(t,"_dampingRatio",X5,re(t)),t}return Z(t,e),J(t,[{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}}]),t}(p6)).prototype,"frequency",[wc],Object.getOwnPropertyDescriptor(W5.prototype,"frequency"),W5.prototype),ce(W5.prototype,"dampingRatio",[wc],Object.getOwnPropertyDescriptor(W5.prototype,"dampingRatio"),W5.prototype),q5=ce(W5.prototype,"_frequency",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),X5=ce(W5.prototype,"_dampingRatio",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),j5=W5))||j5)||j5),e("WheelJoint2D",Ac("cc.WheelJoint2D")(Y5=Fc()((ce((K5=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).TYPE=C4.WHEEL,se(t,"_angle",J5,re(t)),se(t,"_enableMotor",Q5,re(t)),se(t,"_maxMotorTorque",Z5,re(t)),se(t,"_motorSpeed",$5,re(t)),se(t,"_frequency",e6,re(t)),se(t,"_dampingRatio",t6,re(t)),t}return Z(t,e),J(t,[{key:"angle",get:function(){return this._angle},set:function(e){this._angle=e}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(e){this._enableMotor=e,this._joint&&this._joint.enableMotor(e)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(e){this._maxMotorTorque=e,this._joint&&this._joint.setMaxMotorTorque(e)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(e){this._motorSpeed=e,this._joint&&this._joint.setMotorSpeed(e)}},{key:"frequency",get:function(){return this._frequency},set:function(e){this._frequency=e,this._joint&&this._joint.setFrequency(e)}},{key:"dampingRatio",get:function(){return this._dampingRatio},set:function(e){this._dampingRatio=e,this._joint&&this._joint.setDampingRatio(e)}}]),t}(p6)).prototype,"angle",[wc],Object.getOwnPropertyDescriptor(K5.prototype,"angle"),K5.prototype),ce(K5.prototype,"enableMotor",[wc],Object.getOwnPropertyDescriptor(K5.prototype,"enableMotor"),K5.prototype),ce(K5.prototype,"maxMotorTorque",[wc],Object.getOwnPropertyDescriptor(K5.prototype,"maxMotorTorque"),K5.prototype),ce(K5.prototype,"motorSpeed",[wc],Object.getOwnPropertyDescriptor(K5.prototype,"motorSpeed"),K5.prototype),ce(K5.prototype,"frequency",[wc],Object.getOwnPropertyDescriptor(K5.prototype,"frequency"),K5.prototype),ce(K5.prototype,"dampingRatio",[wc],Object.getOwnPropertyDescriptor(K5.prototype,"dampingRatio"),K5.prototype),J5=ce(K5.prototype,"_angle",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),Q5=ce(K5.prototype,"_enableMotor",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Z5=ce(K5.prototype,"_maxMotorTorque",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),$5=ce(K5.prototype,"_motorSpeed",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),e6=ce(K5.prototype,"_frequency",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),t6=ce(K5.prototype,"_dampingRatio",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),Y5=K5))||Y5)||Y5),e("HingeJoint2D",Ac("cc.HingeJoint2D")(n6=Fc()((ce((i6=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).TYPE=C4.HINGE,se(t,"_enableLimit",r6,re(t)),se(t,"_lowerAngle",o6,re(t)),se(t,"_upperAngle",a6,re(t)),se(t,"_enableMotor",s6,re(t)),se(t,"_maxMotorTorque",c6,re(t)),se(t,"_motorSpeed",l6,re(t)),t}return Z(t,e),J(t,[{key:"enableLimit",get:function(){return this._enableLimit},set:function(e){this._enableLimit=e}},{key:"lowerAngle",get:function(){return this._lowerAngle},set:function(e){this._lowerAngle=e,this._joint&&this._joint.setLowerAngle(e)}},{key:"upperAngle",get:function(){return this._upperAngle},set:function(e){this._upperAngle=e,this._joint&&this._joint.setUpperAngle(e)}},{key:"enableMotor",get:function(){return this._enableMotor},set:function(e){this._enableMotor=e,this._joint&&this._joint.enableMotor(e)}},{key:"maxMotorTorque",get:function(){return this._maxMotorTorque},set:function(e){this._maxMotorTorque=e,this._joint&&this._joint.setMaxMotorTorque(e)}},{key:"motorSpeed",get:function(){return this._motorSpeed},set:function(e){this._motorSpeed=e,this._joint&&this._joint.setMotorSpeed(e)}}]),t}(p6)).prototype,"enableLimit",[wc],Object.getOwnPropertyDescriptor(i6.prototype,"enableLimit"),i6.prototype),ce(i6.prototype,"lowerAngle",[wc],Object.getOwnPropertyDescriptor(i6.prototype,"lowerAngle"),i6.prototype),ce(i6.prototype,"upperAngle",[wc],Object.getOwnPropertyDescriptor(i6.prototype,"upperAngle"),i6.prototype),ce(i6.prototype,"enableMotor",[wc],Object.getOwnPropertyDescriptor(i6.prototype,"enableMotor"),i6.prototype),ce(i6.prototype,"maxMotorTorque",[wc],Object.getOwnPropertyDescriptor(i6.prototype,"maxMotorTorque"),i6.prototype),ce(i6.prototype,"motorSpeed",[wc],Object.getOwnPropertyDescriptor(i6.prototype,"motorSpeed"),i6.prototype),r6=ce(i6.prototype,"_enableLimit",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),o6=ce(i6.prototype,"_lowerAngle",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),a6=ce(i6.prototype,"_upperAngle",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),s6=ce(i6.prototype,"_enableMotor",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),c6=ce(i6.prototype,"_maxMotorTorque",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),l6=ce(i6.prototype,"_motorSpeed",[wc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),n6=i6))||n6)||n6),e("Physics2DUtils",{PolygonSeparator:q4}),function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._type=b4.Closest,t._fixtures=[],t._points=[],t._normals=[],t._fractions=[],t._mask=4294967295,t}Z(t,e);var n=t.prototype;return n.init=function(e,t){this._type=e,this._mask=t,this._fixtures.length=0,this._points.length=0,this._normals.length=0,this._fractions.length=0},n.ReportFixture=function(e,t,n,i){return 0==(e.GetFilterData().categoryBits&this._mask)?0:this._type===b4.Closest?(this._fixtures[0]=e,this._points[0]=t,this._normals[0]=n,this._fractions[0]=i,i):(this._fixtures.push(e),this._points.push(new Yn(t.x,t.y)),this._normals.push(new Yn(n.x,n.y)),this._fractions.push(i),this._type===b4.Any?0:this._type>=b4.All?1:i)},n.getFixtures=function(){return this._fixtures},n.getPoints=function(){return this._points},n.getNormals=function(){return this._normals},n.getFractions=function(){return this._fractions},t}(T4.RayCastCallback)),x6=[],S6=[new Yn,new Yn],C6=new T4.WorldManifold,A6={points:[],separations:[],normal:new Yn},b6=function(){this.localPoint=new Yn,this.normalImpulse=0,this.tangentImpulse=0},T6=[new b6,new b6],E6={type:0,localPoint:new Yn,localNormal:new Yn,points:[]},w6={normalImpulses:[],tangentImpulses:[]},I6=function(){function e(){this.colliderA=null,this.colliderB=null,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=null}e.get=function(t){var n=x6.pop();return n||(n=new e),n.init(t),n},e.put=function(e){var t=e.m_userData;t&&(x6.push(t),t.reset())};var t=e.prototype;return t._setImpulse=function(e){this._impulse=e},t.init=function(e){this.colliderA=e.m_fixtureA.m_userData.collider,this.colliderB=e.m_fixtureB.m_userData.collider,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=e,e.m_userData=this},t.reset=function(){this.setTangentSpeed(0),this.resetFriction(),this.resetRestitution(),this.colliderA=null,this.colliderB=null,this.disabled=!1,this._impulse=null,this._b2contact.m_userData=null,this._b2contact=null},t.getWorldManifold=function(){var e=A6.points,t=A6.separations,n=A6.normal;this._b2contact.GetWorldManifold(C6);var i=C6.points,r=C6.separations,o=this._b2contact.GetManifold().pointCount;e.length=t.length=o;for(var a=0;a<o;a++){var s=S6[a];s.x=i[a].x*I4,s.y=i[a].y*I4,e[a]=s,t[a]=r[a]*I4}return n.x=C6.normal.x,n.y=C6.normal.y,this._inverted&&(n.x*=-1,n.y*=-1),A6},t.getManifold=function(){for(var e=E6.points,t=E6.localNormal,n=E6.localPoint,i=this._b2contact.GetManifold(),r=i.points,o=e.length=i.pointCount,a=0;a<o;a++){var s=T6[a],c=r[a];s.localPoint.x=c.localPoint.x*I4,s.localPoint.y=c.localPoint.y*I4,s.normalImpulse=c.normalImpulse*I4,s.tangentImpulse=c.tangentImpulse,e[a]=s}return n.x=i.localPoint.x*I4,n.y=i.localPoint.y*I4,t.x=i.localNormal.x,t.y=i.localNormal.y,E6.type=i.type,this._inverted&&(t.x*=-1,t.y*=-1),E6},t.getImpulse=function(){var e=this._impulse;if(!e)return null;for(var t=w6.normalImpulses,n=w6.tangentImpulses,i=e.count,r=0;r<i;r++)t[r]=e.normalImpulses[r]*I4,n[r]=e.tangentImpulses[r];return n.length=t.length=i,w6},t.emit=function(e){var t=this.colliderA,n=this.colliderB,i=t.body,r=n.body;i.enabledContactListener&&(null==t||t.emit(e,t,n,this)),r.enabledContactListener&&(null==n||n.emit(e,n,t,this)),(i.enabledContactListener||r.enabledContactListener)&&T3.instance.emit(e,t,n,this),(this.disabled||this.disabledOnce)&&(this.setEnabled(!1),this.disabledOnce=!1)},t.setEnabled=function(e){this._b2contact.SetEnabled(e)},t.isTouching=function(){return this._b2contact.IsTouching()},t.setTangentSpeed=function(e){this._b2contact.SetTangentSpeed(e)},t.getTangentSpeed=function(){return this._b2contact.GetTangentSpeed()},t.setFriction=function(e){this._b2contact.SetFriction(e)},t.getFriction=function(){return this._b2contact.GetFriction()},t.resetFriction=function(){return this._b2contact.ResetFriction()},t.setRestitution=function(e){this._b2contact.SetRestitution(e)},t.getRestitution=function(){return this._b2contact.GetRestitution()},t.resetRestitution=function(){return this._b2contact.ResetRestitution()},e}(),P6=new T4.Vec2,R6=new wn,D6=wn.GREEN,O6=wn.RED,N6=function(e){function t(t){var n;return(n=e.call(this)||this)._drawer=null,n._xf=new T4.Transform,n._dxf=new T4.Transform,n._drawer=t,n}Z(t,e);var n=t.prototype;return n._DrawPolygon=function(e,t){for(var n=this._drawer,i=0;i<t;i++){T4.Transform.MulXV(this._xf,e[i],P6);var r=P6.x*I4,o=P6.y*I4;0===i?n.moveTo(r,o):n.lineTo(r,o)}n.close()},n.DrawPolygon=function(e,t,n){this._applyStrokeColor(n),this._DrawPolygon(e,t),this._drawer.stroke()},n.DrawSolidPolygon=function(e,t,n){this._applyFillColor(n),this._DrawPolygon(e,t),this._drawer.fill(),this._drawer.stroke()},n._DrawCircle=function(e,t){var n=this._xf.p;this._drawer.circle((e.x+n.x)*I4,(e.y+n.y)*I4,t*I4)},n.DrawCircle=function(e,t,n){this._applyStrokeColor(n),this._DrawCircle(e,t),this._drawer.stroke()},n.DrawSolidCircle=function(e,t,n,i){this._applyFillColor(i),this._DrawCircle(e,t),this._drawer.fill()},n.DrawSegment=function(e,t,n){var i=this._drawer;if(e.x===t.x&&e.y===t.y)return this._applyFillColor(n),this._DrawCircle(e,2/I4),void i.fill();this._applyStrokeColor(n),T4.Transform.MulXV(this._xf,e,P6),i.moveTo(P6.x*I4,P6.y*I4),T4.Transform.MulXV(this._xf,t,P6),i.lineTo(P6.x*I4,P6.y*I4),i.stroke()},n.DrawTransform=function(e){var t=this._drawer;t.strokeColor=O6,P6.x=P6.y=0,T4.Transform.MulXV(e,P6,P6),t.moveTo(P6.x*I4,P6.y*I4),P6.x=1,P6.y=0,T4.Transform.MulXV(e,P6,P6),t.lineTo(P6.x*I4,P6.y*I4),t.stroke(),t.strokeColor=D6,P6.x=P6.y=0,T4.Transform.MulXV(e,P6,P6),t.moveTo(P6.x*I4,P6.y*I4),P6.x=0,P6.y=1,T4.Transform.MulXV(e,P6,P6),t.lineTo(P6.x*I4,P6.y*I4),t.stroke()},n.DrawPoint=function(){},n.DrawParticles=function(){},n._applyStrokeColor=function(e){this._drawer.strokeColor=R6.set(255*e.r,255*e.g,255*e.b,150)},n._applyFillColor=function(e){this._drawer.fillColor=R6.set(255*e.r,255*e.g,255*e.b,150)},n.PushTransform=function(e){this._xf=e},n.PopTransform=function(){this._xf=this._dxf},t}(T4.Draw),B6=new Pn,M6=new Yn,L6=new Yn,F6=new T4.BodyDef,z6=new T4.AABB,V6=[],G6=function(){function e(){this._world=void 0,this._bodies=[],this._animatedBodies=[],this._rotationAxis=new Pn,this._contactListener=void 0,this._aabbQueryCallback=void 0,this._raycastQueryCallback=void 0,this._debugGraphics=null,this._b2DebugDrawer=null,this._debugDrawFlags=0,this._world=new T4.World(new T4.Vec2(0,-10));var e=new P4;e.setBeginContact(this._onBeginContact),e.setEndContact(this._onEndContact),e.setPreSolve(this._onPreSolve),e.setPostSolve(this._onPostSolve),this._world.SetContactListener(e),this._contactListener=e,this._aabbQueryCallback=new R4,this._raycastQueryCallback=new y6}var t=e.prototype;return t._checkDebugDrawValid=function(){if(!this._debugGraphics||!this._debugGraphics.isValid){var e=OR("Canvas");if(!e){var t=$O.getScene();if(!t)return;(e=new nE("Canvas")).addComponent(RH),e.parent=t}var n=new nE("PHYSICS_2D_DEBUG_DRAW");n.hideFlags|=fl.Flags.DontSave,n.parent=e,n.worldPosition=Pn.ZERO,n.layer=Cd.Enum.UI_2D,this._debugGraphics=n.addComponent(cU),this._debugGraphics.lineWidth=2;var i=new N6(this._debugGraphics);this._b2DebugDrawer=i,this._world.SetDebugDraw(i)}var r=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(r.children.length-1),this._b2DebugDrawer&&this._b2DebugDrawer.SetFlags(this.debugDrawFlags)},t.setGravity=function(e){this._world.SetGravity(e)},t.setAllowSleep=function(){this._world.SetAllowSleeping(!0)},t.step=function(e,t,n){void 0===t&&(t=10),void 0===n&&(n=10);for(var i=this._animatedBodies,r=0,o=i.length;r<o;r++)i[r].animate(e);this._world.Step(e,t,n)},t.raycast=function(e,t,n,i){if(e.equals(t))return[];n=n||b4.Closest,M6.x=e.x/I4,M6.y=e.y/I4,L6.x=t.x/I4,L6.y=t.y/I4;var r=this._raycastQueryCallback;r.init(n,i),this._world.RayCast(r,M6,L6);var o=r.getFixtures();if(o.length>0){for(var a=r.getPoints(),s=r.getNormals(),c=r.getFractions(),l=[],u=0,h=o.length;u<h;u++){var _=o[u],f=_.m_userData,d=f.collider;if(n===b4.AllClosest){for(var p=void 0,m=0;m<l.length;m++)l[m].collider===d&&(p=l[m]);if(p){c[u]<p.fraction&&(p.fixtureIndex=f.getFixtureIndex(_),p.point.x=a[u].x*I4,p.point.y=a[u].y*I4,p.normal.x=s[u].x,p.normal.y=s[u].y,p.fraction=c[u]);continue}}l.push({collider:d,fixtureIndex:f.getFixtureIndex(_),point:new Yn(a[u].x*I4,a[u].y*I4),normal:new Yn(s[u].x,s[u].y),fraction:c[u]})}return l}return[]},t.syncPhysicsToScene=function(){for(var e=this._bodies,t=0,n=e.length;t<n;t++){var i=e[t],r=i.rigidBody;if(r.type!==x4.Animated){var o=r.node,a=i.impl,s=a.GetPosition();B6.x=s.x*I4,B6.y=s.y*I4,B6.z=0,o.worldPosition=B6;var c=_n(a.GetAngle());o.setWorldRotationFromEuler(0,0,c)}else i.resetVelocity()}},t.syncSceneToPhysics=function(){for(var e=this._bodies,t=0;t<e.length;t++)e[t].syncRotationToPhysics(),e[t].syncPositionToPhysics()},t.addBody=function(e){if(!this._bodies.includes(e)){var t=F6,n=e.rigidBody;t.allowSleep=n.allowSleep,t.gravityScale=n.gravityScale,t.linearDamping=n.linearDamping,t.angularDamping=n.angularDamping,t.fixedRotation=n.fixedRotation,t.bullet=n.bullet;var i=n.node,r=i.worldPosition;t.position.Set(r.x/I4,r.y/I4),B6.z=Ln.getAxisAngle(this._rotationAxis,i.worldRotation),this._rotationAxis.z<0&&(B6.z=2*Math.PI-B6.z),t.angle=B6.z,t.awake=n.awakeOnLoad,n.type===x4.Animated?(t.type=x4.Kinematic,this._animatedBodies.push(e),e._animatedPos.set(t.position.x,t.position.y),e._animatedAngle=t.angle):t.type=n.type;var o=n,a=o._linearVelocity;t.linearVelocity.Set(a.x,a.y),t.angularVelocity=hn(o._angularVelocity);var s=this._world.CreateBody(t);s.m_userData=e,e._imp=s,this._bodies.push(e)}},t.removeBody=function(e){this._bodies.includes(e)&&(e.impl&&(e.impl.m_userData=null,this._world.DestroyBody(e.impl),e._imp=null),tt.remove(this._bodies,e),e.rigidBody.type===x4.Animated&&tt.remove(this._animatedBodies,e))},t.registerContactFixture=function(e){this._contactListener.registerContactFixture(e)},t.unregisterContactFixture=function(e){this._contactListener.unregisterContactFixture(e)},t.testPoint=function(e){var t=M6.x=e.x/I4,n=M6.y=e.y/I4,i=.2/I4;z6.lowerBound.x=t-i,z6.lowerBound.y=n-i,z6.upperBound.x=t+i,z6.upperBound.y=n+i;var r=this._aabbQueryCallback;r.init(M6),this._world.QueryAABB(r,z6);var o=r.getFixtures();V6.length=0;for(var a=0;a<o.length;a++){var s=o[a].m_userData.collider;V6.includes(s)||V6.push(s)}return V6},t.testAABB=function(e){z6.lowerBound.x=e.xMin/I4,z6.lowerBound.y=e.yMin/I4,z6.upperBound.x=e.xMax/I4,z6.upperBound.y=e.yMax/I4;var t=this._aabbQueryCallback;t.init(),this._world.QueryAABB(t,z6);var n=t.getFixtures();V6.length=0;for(var i=0;i<n.length;i++){var r=n[i].m_userData.collider;V6.includes(r)||V6.push(r)}return V6},t.drawDebug=function(){this._checkDebugDrawValid(),this._debugGraphics&&(this._debugGraphics.clear(),this._world.DrawDebugData())},t._onBeginContact=function(e){I6.get(e).emit(w4.BEGIN_CONTACT)},t._onEndContact=function(e){var t=e.m_userData;t&&(t.emit(w4.END_CONTACT),I6.put(e))},t._onPreSolve=function(e){var t=e.m_userData;t&&t.emit(w4.PRE_SOLVE)},t._onPostSolve=function(e,t){var n=e.m_userData;n&&(n._setImpulse(t),n.emit(w4.POST_SOLVE),n._setImpulse(null))},J(e,[{key:"impl",get:function(){return this._world}},{key:"debugDrawFlags",get:function(){return this._debugDrawFlags},set:function(e){e||this._debugGraphics&&(this._debugGraphics.node.parent=null),this._debugDrawFlags=e}}]),e}(),U6=(new Pn,new T4.Vec2),k6=function(){function e(){this._animatedPos=new Yn,this._animatedAngle=0,this._body=null,this._inited=!1}var t=e.prototype;return t.initialize=function(e){this._rigidBody=e,T3.instance._callAfterStep(this,this._init)},t.onDestroy=function(){T3.instance._callAfterStep(this,this._destroy)},t.onEnable=function(){this.setActive(!0)},t.onDisable=function(){this.setActive(!1)},t._registerNodeEvents=function(){this.rigidBody.node.on(eb.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)},t._unregisterNodeEvents=function(){this.rigidBody.node.off(eb.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)},t._onNodeTransformChanged=function(e){if(!T3.instance.stepping){if(e&nE.TransformBit.SCALE)for(var t=this.rigidBody.getComponents(d6),n=0;n<t.length;n++)t[n].apply();e&nE.TransformBit.POSITION&&this.syncPositionToPhysics(!0),e&nE.TransformBit.ROTATION&&this.syncRotationToPhysics(!0)}},t._init=function(){this._inited||(this._registerNodeEvents(),T3.instance.physicsWorld.addBody(this),this._inited=!0)},t._destroy=function(){this._inited&&(T3.instance.physicsWorld.removeBody(this),this._unregisterNodeEvents(),this._inited=!1)},t.animate=function(e){var t=this._body;if(t){var n=t.GetPosition();t.SetAwake(!0);var i=1/e;U6.x=(this._animatedPos.x-n.x)*i,U6.y=(this._animatedPos.y-n.y)*i,t.SetLinearVelocity(U6);var r=t.GetAngle();t.SetAngularVelocity((this._animatedAngle-r)*i)}},t.syncPositionToPhysics=function(e){void 0===e&&(e=!1);var t=this._body;if(t){var n,i=this._rigidBody.node.worldPosition,r=this._rigidBody.type;(n=r===x4.Animated?t.GetLinearVelocity():t.GetPosition()).x=i.x/I4,n.y=i.y/I4,r===x4.Animated&&e?this._animatedPos.set(n.x,n.y):t.SetTransformVec(n,t.GetAngle())}},t.syncRotationToPhysics=function(e){void 0===e&&(e=!1);var t=this._body;if(t){var n=hn(this._rigidBody.node.eulerAngles.z);this._rigidBody.type===x4.Animated&&e?this._animatedAngle=n:t.SetTransformVec(t.GetPosition(),n)}},t.resetVelocity=function(){var e=this._body;if(e){var t=e.m_linearVelocity;t.Set(0,0),e.SetLinearVelocity(t),e.SetAngularVelocity(0)}},t.setType=function(e){this._body.SetType(e)},t.setLinearDamping=function(e){this._body.SetLinearDamping(e)},t.setAngularDamping=function(e){this._body.SetAngularDamping(e)},t.setGravityScale=function(e){this._body.SetGravityScale(e)},t.setFixedRotation=function(e){this._body.SetFixedRotation(e)},t.setAllowSleep=function(e){this._body.SetSleepingAllowed(e)},t.isActive=function(){return this._body.IsActive()},t.setActive=function(e){this._body.SetActive(e)},t.wakeUp=function(){this._body.SetAwake(!0)},t.sleep=function(){this._body.SetAwake(!1)},t.getMass=function(){return this._body.GetMass()},t.setLinearVelocity=function(e){this._body.SetLinearVelocity(e)},t.getLinearVelocity=function(e){var t=this._body.GetLinearVelocity();return e.x=t.x,e.y=t.y,e},t.getLinearVelocityFromWorldPoint=function(e,t){return U6.Set(e.x/I4,e.y/I4),this._body.GetLinearVelocityFromWorldPoint(U6,t),t.x*=I4,t.y*=I4,t},t.setAngularVelocity=function(e){this._body.SetAngularVelocity(e)},t.getAngularVelocity=function(){return _n(this._body.GetAngularVelocity())},t.getLocalVector=function(e,t){return t=t||new Yn,U6.Set(e.x/I4,e.y/I4),this._body.GetLocalVector(U6,t),t.x*=I4,t.y*=I4,t},t.getWorldVector=function(e,t){return U6.Set(e.x/I4,e.y/I4),this._body.GetWorldVector(U6,t),t.x*=I4,t.y*=I4,t},t.getLocalPoint=function(e,t){return t=t||new Yn,U6.Set(e.x/I4,e.y/I4),this._body.GetLocalPoint(U6,t),t.x*=I4,t.y*=I4,t},t.getWorldPoint=function(e,t){return t=t||new Yn,U6.Set(e.x/I4,e.y/I4),this._body.GetWorldPoint(U6,t),t.x*=I4,t.y*=I4,t},t.getLocalCenter=function(e){e=e||new Yn;var t=this._body.GetLocalCenter();return e.x=t.x*I4,e.y=t.y*I4,e},t.getWorldCenter=function(e){e=e||new Yn;var t=this._body.GetWorldCenter();return e.x=t.x*I4,e.y=t.y*I4,e},t.getInertia=function(){return this._body.GetInertia()},t.applyForce=function(e,t,n){this._body&&(U6.Set(t.x/I4,t.y/I4),this._body.ApplyForce(e,U6,n))},t.applyForceToCenter=function(e,t){this._body&&this._body.ApplyForceToCenter(e,t)},t.applyTorque=function(e,t){this._body&&this._body.ApplyTorque(e,t)},t.applyLinearImpulse=function(e,t,n){this._body&&(U6.Set(t.x/I4,t.y/I4),this._body.ApplyLinearImpulse(e,U6,n))},t.applyLinearImpulseToCenter=function(e,t){this._body&&this._body.ApplyLinearImpulse(e,this._body.GetPosition(),t)},t.applyAngularImpulse=function(e,t){this._body&&this._body.ApplyAngularImpulse(e,t)},J(e,[{key:"impl",get:function(){return this._body}},{key:"_imp",set:function(e){this._body=e}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"isAwake",get:function(){return this._body.IsAwake()}},{key:"isSleeping",get:function(){return!this._body.IsAwake()}}]),e}(),H6=new T4.Filter;function j6(e){var t=e.collider;return H6.categoryBits=t.group===t3.DEFAULT?t.body.group:t.group,H6.maskBits=T3.instance.collisionMatrix[H6.categoryBits],H6}var W6,q6=function(){function e(){this._shapes=[],this._fixtures=[],this._collider=null,this._body=null,this._inited=!1,this._rect=new ii}var t=e.prototype;return t.initialize=function(e){this._collider=e},t.onLoad=function(){},t.onEnable=function(){T3.instance._callAfterStep(this,this._init)},t.onDisable=function(){T3.instance._callAfterStep(this,this._destroy)},t.start=function(){},t.onGroupChanged=function(){var e=j6(this);this._fixtures.forEach((function(t){t.SetFilterData(e)}))},t.apply=function(){this._destroy(),this._init()},t.getFixtureIndex=function(e){return this._fixtures.indexOf(e)},t._createShapes=function(){return[]},t._init=function(){var e;if(!this._inited){var t=this.collider,n=t.getComponent(f6);if(n){var i=null===(e=n.impl)||void 0===e?void 0:e.impl;if(i){for(var r=n.node.worldScale,o=0===r.x&&0===r.y?[]:this._createShapes(r.x,r.y),a=j6(this),s=0;s<o.length;s++){var c=o[s],l={density:t.density,isSensor:t.sensor,friction:t.friction,restitution:t.restitution,shape:c,filter:a},u=i.CreateFixture(l);u.m_userData=this,n.enabledContactListener&&T3.instance.physicsWorld.registerContactFixture(u),this._shapes.push(c),this._fixtures.push(u)}this._body=i,this._inited=!0}}}},t._destroy=function(){if(this._inited){for(var e=this._fixtures,t=this._body,n=e.length-1;n>=0;n--){var i=e[n];i.m_userData=null,T3.instance.physicsWorld.unregisterContactFixture(i),t&&t.DestroyFixture(i)}this._body=null,this._fixtures.length=0,this._shapes.length=0,this._inited=!1}},J(e,[{key:"impl",get:function(){return this._shapes}},{key:"collider",get:function(){return this._collider}},{key:"worldAABB",get:function(){for(var e=1e7,t=e,n=e,i=-e,r=-e,o=this._fixtures,a=0;a<o.length;a++)for(var s=o[a],c=s.GetShape().GetChildCount(),l=0;l<c;l++){var u=s.GetAABB(l);u.lowerBound.x<t&&(t=u.lowerBound.x),u.lowerBound.y<n&&(n=u.lowerBound.y),u.upperBound.x>i&&(i=u.upperBound.x),u.upperBound.y>r&&(r=u.upperBound.y)}t*=I4,n*=I4,i*=I4,r*=I4;var h=this._rect;return h.x=t,h.y=n,h.width=i-t,h.height=r-n,h}}]),e}(),X6=new ii,Y6=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._worldPoints=[new Yn,new Yn,new Yn,new Yn],t}return Z(t,e),t.prototype._createShapes=function(e,t){e=Math.abs(e),t=Math.abs(t);var n=this.collider,i=n.size.width/2/I4*e,r=n.size.height/2/I4*t,o=n.offset.x/I4*e,a=n.offset.y/I4*t,s=new T4.PolygonShape;return s.SetAsBox(i,r,new T4.Vec2(o,a),0),[s]},J(t,[{key:"worldPoints",get:function(){var e=X6,t=this.collider,n=t.size,i=t.offset;e.x=i.x-n.width/2,e.y=i.y-n.height/2,e.width=n.width,e.height=n.height;var r=this._worldPoints,o=r[0],a=r[1],s=r[2],c=r[3];return e.transformMat4ToPoints(t.node.worldMatrix,o,a,s,c),r}}]),t}(q6),K6=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._worldPosition=new Yn,t}return Z(t,e),t.prototype._createShapes=function(e,t){e=Math.abs(e),t=Math.abs(t);var n=this.collider,i=n.offset.x/I4*e,r=n.offset.y/I4*t,o=new T4.CircleShape;return o.m_radius=n.radius/I4*e,o.m_p.Set(i,r),[o]},J(t,[{key:"worldRadius",get:function(){return this._shapes[0].m_radius*I4}},{key:"worldPosition",get:function(){var e=this._shapes[0].m_p;return this._worldPosition.set(e.x*I4,e.y*I4)}}]),t}(q6),J6=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._worldPoints=[],t}return Z(t,e),t.prototype._createShapes=function(e,t){var n=[],i=this.collider,r=i.points;r.length>0&&r[0].equals(r[r.length-1])&&(r.length-=1);for(var o=N4(r),a=i.offset,s=0;s<o.length;s++){for(var c=o[s],l=null,u=[],h=null,_=0,f=c.length;_<f;_++){l||(l=new T4.PolygonShape);var d=c[_],p=(d.x+a.x)/I4*e,m=(d.y+a.y)/I4*t,v=new T4.Vec2(p,m);u.push(v),h||(h=v),u.length===T4.maxPolygonVertices&&(l.Set(u,u.length),n.push(l),l=null,_<f-1&&(u=[h,u[u.length-1]]))}l&&(l.Set(u,u.length),n.push(l))}return n},J(t,[{key:"worldPoints",get:function(){for(var e=this.collider,t=e.points,n=this._worldPoints,i=e.node.worldMatrix,r=0;r<t.length;r++)n[r]||(n[r]=new Yn),Yn.transformMat4(n[r],t[r],i);return n.length=t.length,this._worldPoints}}]),t}(q6),Q6=function(){function e(){this._b2joint=null,this._jointComp=null,this._body=null,this._inited=!1}var t=e.prototype;return t.initialize=function(e){this._jointComp=e},t.onEnable=function(){T3.instance._callAfterStep(this,this._init)},t.onDisable=function(){T3.instance._callAfterStep(this,this._destroy)},t.start=function(){T3.instance._callAfterStep(this,this._init)},t._init=function(){if(!this._inited){var e=this._jointComp;if(e.isValid){this._body=e.getComponent(f6);var t=this._createJointDef();if(t){var n=e.connectedBody;n&&n.enabledInHierarchy&&(t.bodyA=this._body.impl.impl,t.bodyB=n.impl.impl,t.collideConnected=e.collideConnected,this._b2joint=T3.instance.physicsWorld.impl.CreateJoint(t),this._inited=!0)}}}},t._destroy=function(){this._inited&&(T3.instance.physicsWorld.impl.DestroyJoint(this._b2joint),this._b2joint=null,this._inited=!1)},t._createJointDef=function(){return null},t.isValid=function(){return this._b2joint&&this._body&&this._body.impl&&this._jointComp&&this._jointComp.connectedBody&&this._jointComp.connectedBody.impl},J(e,[{key:"impl",get:function(){return this._b2joint}},{key:"comp",get:function(){return this._jointComp}},{key:"body",get:function(){return this._body}}]),e}(),Z6=new T4.Vec2;W6={PhysicsWorld:G6,RigidBody:k6,BoxShape:Y6,CircleShape:K6,PolygonShape:J6,MouseJoint:function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._touchPoint=new Yn,t._isTouched=!1,t}Z(t,e);var n=t.prototype;return n.setTarget=function(e){this._b2joint&&(Z6.x=e.x/I4,Z6.y=e.y/I4,this._b2joint.SetTarget(Z6))},n.setDampingRatio=function(e){this._b2joint&&this._b2joint.SetDampingRatio(e)},n.setFrequency=function(e){this._b2joint&&this._b2joint.SetFrequency(e)},n.setMaxForce=function(e){this._b2joint&&this._b2joint.SetMaxForce(e)},n._createJointDef=function(){var e=new T4.MouseJointDef,t=this._jointComp;return e.target.Set(this._touchPoint.x/I4,this._touchPoint.y/I4),e.maxForce=t.maxForce,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e},n.initialize=function(t){e.prototype.initialize.call(this,t);var n=OR("Canvas");n&&(n.on(eb.TOUCH_START,this.onTouchBegan,this),n.on(eb.TOUCH_MOVE,this.onTouchMove,this),n.on(eb.TOUCH_END,this.onTouchEnd,this),n.on(eb.TOUCH_CANCEL,this.onTouchEnd,this))},n.onEnable=function(){},n.start=function(){},n.onTouchBegan=function(e){this._isTouched=!0;var t=this._touchPoint.set(e.getUILocation()),n=T3.instance.physicsWorld.testPoint(t);if(!(n.length<=0)){var i=n[0].body;i.wakeUp();var r=this._jointComp;r.connectedBody=i,this._init(),this.setMaxForce(r.maxForce*i.getMass()),this.setTarget(t)}},n.onTouchMove=function(e){this._touchPoint=e.getUILocation()},n.onTouchEnd=function(){this._destroy(),this._isTouched=!1},n.update=function(){this._isTouched&&this.isValid()&&this.setTarget(this._touchPoint)},t}(Q6),DistanceJoint:function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.setMaxLength=function(e){this._b2joint&&this._b2joint.SetMaxLength(e)},n._createJointDef=function(){var e=this._jointComp,t=new T4.RopeJointDef;return t.localAnchorA.Set(e.anchor.x/I4,e.anchor.y/I4),t.localAnchorB.Set(e.connectedAnchor.x/I4,e.connectedAnchor.y/I4),t.maxLength=e.maxLength/I4,t},t}(Q6),SpringJoint:function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.setDampingRatio=function(e){this._b2joint&&this._b2joint.SetDampingRatio(e)},n.setFrequency=function(e){this._b2joint&&this._b2joint.SetFrequency(e)},n.setDistance=function(e){this._b2joint&&this._b2joint.SetLength(e)},n._createJointDef=function(){var e=this._jointComp,t=new T4.DistanceJointDef;return t.localAnchorA.Set(e.anchor.x/I4,e.anchor.y/I4),t.localAnchorB.Set(e.connectedAnchor.x/I4,e.connectedAnchor.y/I4),t.length=e.distance/I4,t.dampingRatio=e.dampingRatio,t.frequencyHz=e.frequency,t},t}(Q6),RelativeJoint:function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.setMaxForce=function(e){this._b2joint&&this._b2joint.SetMaxForce(e)},n.setAngularOffset=function(e){this._b2joint&&this._b2joint.SetAngularOffset(hn(e))},n.setLinearOffset=function(e){this._b2joint&&this._b2joint.SetLinearOffset(new T4.Vec2(e.x/I4,e.y/I4))},n.setCorrectionFactor=function(e){this._b2joint&&(this._b2joint.m_correctionFactor=e)},n.setMaxTorque=function(e){this._b2joint&&this._b2joint.SetMaxTorque(e)},n._createJointDef=function(){var e=this._jointComp,t=new T4.MotorJointDef;return t.linearOffset.Set(e.linearOffset.x/I4,e.linearOffset.y/I4),t.angularOffset=hn(e.angularOffset),t.maxForce=e.maxForce,t.maxTorque=e.maxTorque,t.correctionFactor=e.correctionFactor,t},t}(Q6),SliderJoint:function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.enableLimit=function(e){this._b2joint&&this._b2joint.EnableLimit(e)},n.setLowerLimit=function(){this.updateLimits()},n.setUpperLimit=function(){this.updateLimits()},n.updateLimits=function(){if(this._b2joint){var e=this._jointComp;this._b2joint.SetLimits(e.lowerLimit/I4,e.upperLimit/I4)}},n.enableMotor=function(e){this._b2joint&&this._b2joint.EnableMotor(e)},n.setMaxMotorForce=function(e){this._b2joint&&this._b2joint.SetMaxMotorForce(e)},n.setMotorSpeed=function(e){this._b2joint&&this._b2joint.SetMotorSpeed(e)},n._createJointDef=function(){var e=this._jointComp,t=new T4.PrismaticJointDef;t.localAnchorA.Set(e.anchor.x/I4,e.anchor.y/I4),t.localAnchorB.Set(e.connectedAnchor.x/I4,e.connectedAnchor.y/I4);var n=hn(e.angle);return t.localAxisA.Set(Math.cos(n),Math.sin(n)),t.referenceAngle=0,t.enableLimit=e.enableLimit,t.lowerTranslation=e.lowerLimit/I4,t.upperTranslation=e.upperLimit/I4,t.enableMotor=e.enableMotor,t.maxMotorForce=e.maxMotorForce,t.motorSpeed=e.motorSpeed,t},t}(Q6),FixedJoint:function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.setFrequency=function(e){this._b2joint&&this._b2joint.SetFrequency(e)},n.setDampingRatio=function(e){this._b2joint&&this._b2joint.SetDampingRatio(e)},n._createJointDef=function(){var e=this._jointComp,t=new T4.WeldJointDef;return t.localAnchorA.Set(e.anchor.x/I4,e.anchor.y/I4),t.localAnchorB.Set(e.connectedAnchor.x/I4,e.connectedAnchor.y/I4),t.referenceAngle=0,t.frequencyHz=e.frequency,t.dampingRatio=e.dampingRatio,t},t}(Q6),WheelJoint:function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.setDampingRatio=function(e){this._b2joint&&this._b2joint.SetSpringDampingRatio(e)},n.setFrequency=function(e){this._b2joint&&this._b2joint.SetSpringFrequencyHz(e)},n.enableMotor=function(e){this._b2joint&&this._b2joint.EnableMotor(e)},n.setMaxMotorTorque=function(e){this._b2joint&&this._b2joint.SetMaxMotorTorque(e)},n.setMotorSpeed=function(e){this._b2joint&&this._b2joint.SetMotorSpeed(e)},n._createJointDef=function(){var e=this._jointComp,t=new T4.WheelJointDef;t.localAnchorA.Set(e.anchor.x/I4,e.anchor.y/I4),t.localAnchorB.Set(e.connectedAnchor.x/I4,e.connectedAnchor.y/I4);var n=hn(e.angle);return t.localAxisA.Set(Math.cos(n),Math.sin(n)),t.maxMotorTorque=e.maxMotorTorque,t.motorSpeed=hn(e.motorSpeed),t.enableMotor=e.enableMotor,t.dampingRatio=e.dampingRatio,t.frequencyHz=e.frequency,t},t}(Q6),HingeJoint:function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.enableLimit=function(e){this._b2joint&&this._b2joint.EnableLimit(e)},n.setLowerAngle=function(){this.updateLimits()},n.setUpperAngle=function(){this.updateLimits()},n.updateLimits=function(){if(this._b2joint){var e=this._jointComp;this._b2joint.SetLimits(hn(e.lowerAngle),hn(e.upperAngle))}},n.enableMotor=function(e){this._b2joint&&this._b2joint.EnableMotor(e)},n.setMaxMotorTorque=function(e){this._b2joint&&this._b2joint.SetMaxMotorTorque(e)},n.setMotorSpeed=function(e){this._b2joint&&this._b2joint.SetMotorSpeed(e)},n._createJointDef=function(){var e=this._jointComp,t=new T4.RevoluteJointDef;return t.localAnchorA.Set(e.anchor.x/I4,e.anchor.y/I4),t.localAnchorB.Set(e.connectedAnchor.x/I4,e.connectedAnchor.y/I4),t.enableMotor=e.enableMotor,t.maxMotorTorque=e.maxMotorTorque,t.motorSpeed=hn(e.motorSpeed),t.enableLimit=e.enableLimit,t.lowerAngle=e.lowerAngle,t.upperAngle=e.upperAngle,t},t}(Q6)},f4="box2d",l._global.CC_PHYSICS_2D_BUILTIN=!1,l._global.CC_PHYSICS_2D_BOX2D=!0,_4=W6;var $6=function(){function e(){this.originalTarget=null,this.target=null,this.tag=e.TAG_INVALID}var t=e.prototype;return t.clone=function(){var t=new e;return t.originalTarget=null,t.target=null,t.tag=this.tag,t},t.isDone=function(){return!0},t.startWithTarget=function(e){this.originalTarget=e,this.target=e},t.stop=function(){this.target=null},t.step=function(){I(1006)},t.update=function(){I(1007)},t.getTarget=function(){return this.target},t.setTarget=function(e){this.target=e},t.getOriginalTarget=function(){return this.originalTarget},t.setOriginalTarget=function(e){this.originalTarget=e},t.getTag=function(){return this.tag},t.setTag=function(e){this.tag=e},t.reverse=function(){return I(1008),null},t.retain=function(){},t.release=function(){},e}();$6.TAG_INVALID=-1;var e8=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._duration=0,t._timesForRepeat=1,t}Z(t,e);var n=t.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(e){this._duration=e},n.clone=function(){return new t},t}($6),t8=(function(e){function t(t,n){var i;return void 0===n&&(n=1),(i=e.call(this)||this)._speed=0,i._innerAction=null,t&&i.initWithAction(t,n),i}Z(t,e);var n=t.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(e){this._speed=e},n.initWithAction=function(e,t){return e?(this._innerAction=e,this._speed=t,!0):(O(1021),!1)},n.clone=function(){var e=new t;return e.initWithAction(this._innerAction.clone(),this._speed),e},n.startWithTarget=function(e){$6.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),$6.prototype.stop.call(this)},n.step=function(e){this._innerAction.step(e*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new t(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction}}($6),0),n8=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},i8=function(){function e(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var t=e.prototype;return t._searchElementByTarget=function(e,t){for(var n=0;n<e.length;n++)if(t===e[n].target)return e[n];return null},t._getElement=function(e,t){var n=this._elementPool.pop();return n||(n=new n8),n.target=e,n.paused=!!t,n},t._putElement=function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)},t.addAction=function(e,t,n){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_"+t8++);var i=this._hashTargets.get(t);i?i.actions||(i.actions=[]):(i=this._getElement(t,n),this._hashTargets.set(t,i),this._arrayTargets.push(i)),i.target=t,i.actions.push(e),e.startWithTarget(t)}else O(1e3)},t.removeAllActions=function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var n=e[t];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},t.removeAllActionsFromTarget=function(e){if(null!=e){var t=this._hashTargets.get(e);t&&(t.actions.length=0,this._deleteHashElement(t))}},t.removeAction=function(e){if(null!=e){var t=e.getOriginalTarget(),n=this._hashTargets.get(t);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===e){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},t._removeActionByTag=function(e,t,n){for(var i=0,r=t.actions.length;i<r;++i){var o=t.actions[i];if(o&&o.getTag()===e){if(n&&o.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t);break}}},t._removeAllActionsByTag=function(e,t,n){for(var i=t.actions.length-1;i>=0;--i){var r=t.actions[i];if(r&&r.getTag()===e){if(n&&r.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t)}}},t.removeActionByTag=function(e,t){var n=this;e===$6.TAG_INVALID&&I(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeActionByTag(e,r,t)}else i.forEach((function(t){n._removeActionByTag(e,t)}))},t.removeAllActionsByTag=function(e,t){var n=this;e===$6.TAG_INVALID&&I(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeAllActionsByTag(e,r,t)}else i.forEach((function(t){n._removeAllActionsByTag(e,t)}))},t.getActionByTag=function(e,t){e===$6.TAG_INVALID&&I(1004);var n=this._hashTargets.get(t);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===e)return r}I(1005,e)}return null},t.getNumberOfRunningActionsInTarget=function(e){var t=this._hashTargets.get(e);return t&&t.actions?t.actions.length:0},t.pauseTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!0)},t.resumeTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!1)},t.pauseAllRunningActions=function(){for(var e=[],t=this._arrayTargets,n=0;n<t.length;n++){var i=t[n];i&&!i.paused&&(i.paused=!0,e.push(i.target))}return e},t.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])},t.pauseTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])},t.purgeSharedManager=function(){l.director.getScheduler().unscheduleUpdate(this)},t._removeActionAtIndex=function(e,t){t.actions[e],t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)},t._deleteHashElement=function(e){var t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}this._putElement(e),t=!0}return t},t.update=function(e){for(var t,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(t=this._currentTarget).target;if(r instanceof fl&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!t.paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var o=t.currentAction;t.currentAction=null,this.removeAction(o)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&i--}}},e}(),r8=e("TweenSystem",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).actionMgr=new i8,t}return Z(t,e),t.prototype.update=function(e){this.actionMgr.update(e)},J(t,[{key:"ActionManager",get:function(){return this.actionMgr}}]),t}(VO));r8.ID="TWEEN",r8.instance=void 0,$O.on(ZO.EVENT_INIT,(function(){var e=new r8;r8.instance=e,$O.registerSystem(r8.ID,e,VO.Priority.MEDIUM)}));var o8=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new t},t}(e8),a8=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(vL),t=0;t<e.length;++t)e[t].enabled=!0},n.reverse=function(){return new s8},n.clone=function(){return new t},t}(o8),s8=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(vL),t=0;t<e.length;++t)e[t].enabled=!1},n.reverse=function(){return new a8},n.clone=function(){return new t},t}(o8);!function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;n.update=function(){for(var e=this.target.getComponentsInChildren(vL),t=0;t<e.length;++t){var n=e[t];n.enabled=!n.enabled}},n.reverse=function(){return new t},n.clone=function(){return new t}}(o8);var c8=function(e){function t(t){var n;return(n=e.call(this)||this)._isNeedCleanUp=!0,void 0!==t&&n.init(t),n}Z(t,e);var n=t.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(e){return this._isNeedCleanUp=e,!0},n.reverse=function(){return new t(this._isNeedCleanUp)},n.clone=function(){return new t(this._isNeedCleanUp)},t}(o8),l8=function(e){function t(t,n,i){var r;return(r=e.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(t,n,i),r}Z(t,e);var n=t.prototype;return n.initWithFunction=function(e,t,n){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)},n.clone=function(){var e=new t;return e.initWithFunction(this._function,this._selectorTarget,this._data),e},t}(o8),u8=function(e){function t(t){var n;return(n=e.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===t||isNaN(t)||n.initWithDuration(t),n}Z(t,e);var n=t.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(e){return this._duration=0===e?lt.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod},n._reverseEaseList=function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}},n.clone=function(){var e=new t(this._duration);return this._cloneDecoration(e),e},n.easing=function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this},n._computeEaseTime=function(e){return e},n.step=function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=t<1?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(e){$6.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return I(1010),this},n.setAmplitudeRate=function(){I(1011)},n.getAmplitudeRate=function(){return I(1012),0},n.speed=function(e){return e<=0?(I(1013),this):(this._speedMethod=!0,this._speed*=e,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(e){return this._speed=e,this},n.repeat=function(e){return e=Math.round(e),isNaN(e)||e<1?(I(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},t}(e8),h8=function(e){function t(n){var i;(i=e.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return O(1019),re(i);var o=r.length-1;if(o>=0&&null==r[o]&&I(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}Z(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return O(1025),!1;var n=e._duration,i=t._duration,r=(n*=e._repeatMethod?e._timesForRepeat:1)+(i*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=e,this._actions[1]=t,!0},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e},n.startWithTarget=function(e){u8.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),$6.prototype.stop.call(this)},n.update=function(e){var t,n,i=0,r=this._split,o=this._actions,a=this._last;(e=this._computeEaseTime(e))<r?(t=0!==r?e/r:1,0===i&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(i=1,t=1===r?1:(e-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),n=o[i],a===i&&n.isDone()||(a!==i&&n.startWithTarget(this.target),t*=n._timesForRepeat,n.update(t>1?t%1:t),this._last=i)},n.reverse=function(){var e=t._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e},t}(u8);function _8(e){var t=e instanceof Array?e:arguments;if(1===t.length)return O(1019),null;var n=t.length-1;n>=0&&null==t[n]&&I(1015);var i=null;if(n>=0){i=t[0];for(var r=1;r<=n;r++)t[r]&&(i=h8._actionOneTwo(i,t[r]))}return i}h8._actionOneTwo=function(e,t){var n=new h8;return n.initWithTwoActions(e,t),n};var f8=function(e){function t(t,n){var i;return(i=e.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(t,n),i}Z(t,e);var n=t.prototype;return n.initWithAction=function(e,t){var n=e._duration*t;return!!this.initWithDuration(n)&&(this._times=t,this._innerAction=e,e instanceof o8&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e},n.startWithTarget=function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,u8.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),$6.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e);var t=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(e>=r){for(;e>r&&this._total<i;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/n,this._nextDt=r>1?1:r;e>=1&&this._total<i&&(t.update(1),this._total++),this._actionInstant||(this._total===i?t.stop():t.update(e-(r-t._duration/n)))}else t.update(e*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var e=new t(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(u8),d8=function(e){function t(t){var n;return(n=e.call(this)||this)._innerAction=null,t&&n.initWithAction(t),n}Z(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?(this._innerAction=e,!0):(O(1026),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e},n.startWithTarget=function(e){u8.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.step=function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))},n.isDone=function(){return!1},n.reverse=function(){var e=new t(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(u8),p8=function(e){function t(n){var i;(i=e.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return O(1020),re(i);var o=r.length-1;if(o>=0&&null==r[o]&&I(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}Z(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return O(1027),!1;var n=!1,i=e._duration,r=t._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=e,this._two=t,i>r?this._two=h8._actionOneTwo(t,g8(i-r)):i<r&&(this._one=h8._actionOneTwo(e,g8(r-i))),n=!0),n},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e},n.startWithTarget=function(e){u8.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)},n.stop=function(){this._one.stop(),this._two.stop(),$6.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)},n.reverse=function(){var e=t._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},t}(u8);function m8(e){var t=e instanceof Array?e:arguments;if(1===t.length)return O(1020),null;t.length>0&&null==t[t.length-1]&&I(1015);for(var n=t[0],i=1;i<t.length;i++)null!=t[i]&&(n=p8._actionOneTwo(n,t[i]));return n}p8._actionOneTwo=function(e,t){var n=new p8;return n.initWithTwoActions(e,t),n};var v8=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.update=function(){},n.reverse=function(){var e=new t(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithDuration(this._duration),e},t}(u8);function g8(e){return new v8(e)}var y8,x8,S8,C8,A8,b8,T8,E8,w8,I8,P8,R8,D8,O8,N8,B8,M8,L8,F8,z8,V8,G8,U8,k8,H8,j8,W8,q8,X8,Y8,K8,J8,Q8,Z8,$8,e7,t7,n7,i7,r7,o7,a7,s7,c7,l7,u7,h7,_7,f7,d7,p7,m7,v7,g7,y7,x7,S7,C7,A7,b7,T7=function(e){function t(t){var n;return(n=e.call(this)||this)._other=null,t&&n.initWithAction(t),n}Z(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?e===this._other?(O(1029),!1):!!u8.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(O(1028),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e},n.startWithTarget=function(e){u8.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)},n.update=function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),$6.prototype.stop.call(this)},t}(u8),E7=e("TweenAction",function(e){function t(t,n,i){var r;if((r=e.call(this)||this)._opts=void 0,r._props=void 0,r._originProps=void 0,null==i)i=Object.create(null);else if(function(e){var t=" [Tween:] ",n=" option is not support in v + "+u,i=e;i.delay&&x(t+"delay"+n),i.repeat&&x(t+"repeat"+n),i.repeatDelay&&x(t+"repeatDelay"+n),i.interpolation&&x(t+"interpolation"+n),i.onStop&&x(t+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){var n=(e=e.replace(t,t.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)e="linear";else{var r=n[1];switch(i){case"quadratic":e="quad"+r;break;case"quartic":e="quart"+r;break;case"quintic":e="quint"+r;break;case"sinusoidal":e="sine"+r;break;case"exponential":e="expo"+r;break;case"circular":e="circ"+r;break;default:e=i+r}}}}return e}(i.easing)),i.progress||(i.progress=r.progress),i.easing&&"string"==typeof i.easing){var o=i.easing;i.easing=J_[o],i.easing||R(1031,o)}for(var a in r._opts=i,r._props=Object.create(null),n)if(n.hasOwnProperty(a)){var s=n[a];if("function"==typeof s&&(s=s()),null!=s&&"string"!=typeof s){var c=void 0,l=void 0;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(c=J_[s.easing])||R(1031,s.easing):c=s.easing,l=s.progress,s=s.value);var h=Object.create(null);h.value=s,h.easing=c,h.progress=l,r._props[a]=h}}return r._originProps=n,r.initWithDuration(t),r}Z(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e},n.startWithTarget=function(e){u8.prototype.startWithTarget.call(this,e);var t=!!this._opts.relative,n=this._props;for(var i in n){var r=e[i];if(void 0!==r){var o=n[i],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=t?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=t?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(e){var t=this.target;if(t){var n=this._props,i=this._opts,r=e;i.easing&&(r=i.easing(e));var o=i.progress;for(var a in n){var s=n[a],c=s.easing?s.easing(e):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var _ in u)s.current[_]=l(u[_],h[_],s.current[_],c);t[a]=s.current}i.onUpdate&&i.onUpdate(this.target,e),1===e&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(e,t,n,i){return e+(t-e)*i},t}(u8)),w7=function(e){function t(t){var n;return(n=e.call(this)||this)._props=void 0,n._props={},void 0!==t&&n.init(t),n}Z(t,e);var n=t.prototype;return n.init=function(e){for(var t in e)this._props[t]=e[t];return!0},n.update=function(){var e=this._props,t=this.target;for(var n in e)t[n]=e[n]},n.clone=function(){var e=new t;return e.init(this._props),e},t}(o8),I7=e("Tween",function(){function e(e){this._actions=[],this._finalAction=null,this._target=null,this._tag=$6.TAG_INVALID,this._target=void 0===e?null:e}var t=e.prototype;return t.tag=function(e){return this._tag=e,this},t.then=function(e){return e instanceof $6?this._actions.push(e.clone()):this._actions.push(e._union()),this},t.target=function(e){return this._target=e,this},t.start=function(){return this._target?(this._finalAction&&r8.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),r8.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(x("Please set target to tween first"),this)},t.stop=function(){return this._finalAction&&r8.instance.ActionManager.removeAction(this._finalAction),this},t.clone=function(e){var t=this._union();return P7(e).then(t.clone())},t.union=function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this},t.to=function(e,t,n){(n=n||Object.create(null)).relative=!1;var i=new E7(e,t,n);return this._actions.push(i),this},t.by=function(e,t,n){(n=n||Object.create(null)).relative=!0;var i=new E7(e,t,n);return this._actions.push(i),this},t.set=function(e){var t=new w7(e);return this._actions.push(t),this},t.delay=function(e){var t=g8(e);return this._actions.push(t),this},t.call=function(e){var t=new l8(e,undefined,undefined);return this._actions.push(t),this},t.sequence=function(){var t=e._wrappedSequence.apply(e,arguments);return this._actions.push(t),this},t.parallel=function(){var t=e._wrappedParallel.apply(e,arguments);return this._actions.push(t),this},t.repeat=function(t,n){if(t===1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof e?n._union():r.pop(),r.push(function(e,t){return new f8(e,t)}(i,t)),this},t.repeatForever=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new d8(e)}(n)),this},t.reverseTime=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new T7(e)}(n)),this},t.hide=function(){var e=new s8;return this._actions.push(e),this},t.show=function(){var e=new a8;return this._actions.push(e),this},t.removeSelf=function(){var e=new c8(!1);return this._actions.push(e),this},e.stopAll=function(){r8.instance.ActionManager.removeAllActions()},e.stopAllByTag=function(e,t){r8.instance.ActionManager.removeAllActionsByTag(e,t)},e.stopAllByTarget=function(e){r8.instance.ActionManager.removeAllActionsFromTarget(e)},t._union=function(){var e=this._actions;return 1===e.length?e[0]:_8(e)},t._destroy=function(){this.stop()},e._wrappedSequence=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return _8.apply(_8,t)},e._wrappedParallel=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return m8.apply(m8,t)},e}());function P7(e){return new I7(e)}function R7(e){return x("tweenUtil' is deprecated, please use 'tween' instead "),new I7(e)}I7._tmp_args=[],l.Tween=I7,l.tween=P7,l.tweenUtil=R7;var D7,O7,N7,B7=new wn;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(D7||(D7={})),st(D7),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(O7||(O7={})),function(e){e.CLICK="click"}(N7||(N7={}));var M7=function(t){return e({Button:t,ButtonComponent:t}),t}((y8=Ac("cc.Button"),x8=Uc(),S8=Tc(110),C8=Fc(),A8=bc(uz),b8=ol(nE),T8=Zc(),E8=qc(),w8=Zc(),I8=qc(),P8=ol(D7),R8=Zc(),D8=qc(),O8=Zc(),N8=qc(),B8=Zc(),M8=qc(),L8=Zc(),F8=qc(),z8=Zc(),V8=qc(),G8=Yc(),U8=Kc(),k8=Zc(),H8=qc(),j8=Zc(),W8=qc(),q8=ol(BL),X8=Zc(),Y8=qc(),K8=ol(BL),J8=Zc(),Q8=qc(),Z8=ol(BL),$8=Zc(),e7=qc(),t7=ol(BL),n7=Zc(),i7=qc(),r7=ol([QM]),o7=Zc(),a7=qc(),y8(s7=x8(s7=S8(s7=C8(s7=A8(s7=Lc((b7=A7=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"clickEvents",l7,re(t)),se(t,"_interactable",u7,re(t)),se(t,"_transition",h7,re(t)),se(t,"_normalColor",_7,re(t)),se(t,"_hoverColor",f7,re(t)),se(t,"_pressedColor",d7,re(t)),se(t,"_disabledColor",p7,re(t)),se(t,"_normalSprite",m7,re(t)),se(t,"_hoverSprite",v7,re(t)),se(t,"_pressedSprite",g7,re(t)),se(t,"_disabledSprite",y7,re(t)),se(t,"_duration",x7,re(t)),se(t,"_zoomScale",S7,re(t)),se(t,"_target",C7,re(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new wn,t._toColor=new wn,t._time=0,t._transitionFinished=!0,t._fromScale=new Pn,t._toScale=new Pn,t._originalScale=null,t._sprite=null,t._targetScale=new Pn,t}Z(t,e);var n=t.prototype;return n.__preload=function(){this.target||(this.target=this.node);var e=this.node.getComponent(Ik);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===D7.COLOR||this._transition===D7.SCALE)){this._time+=e;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===D7.COLOR){var i=t._uiProps.uiComp;wn.lerp(B7,this._fromColor,this._toColor,n),i&&(i.color=B7)}else this.transition===D7.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=un(this._fromScale.x,this._toScale.x,n),this._targetScale.y=un(this._fromScale.y,this._toScale.y,n),t.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=this._transition;if(t===D7.COLOR&&this._interactable){var n=e.getComponent(YV);n&&(n.color=this._normalColor)}else t===D7.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(eb.TOUCH_START,this._onTouchBegan,this),this.node.on(eb.TOUCH_MOVE,this._onTouchMove,this),this.node.on(eb.TOUCH_END,this._onTouchEnded,this),this.node.on(eb.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(eb.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(eb.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(e){e.on(eb.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(eb.TOUCH_START,this._onTouchBegan,this),this.node.off(eb.TOUCH_MOVE,this._onTouchMove,this),this.node.off(eb.TOUCH_END,this._onTouchEnded,this),this.node.off(eb.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(eb.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(eb.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(e){e.off(eb.TRANSFORM_CHANGED)},n._getTargetSprite=function(e){var t=null;return e&&(t=e.getComponent(Ik)),t},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new Pn),Pn.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(e){this._transition===D7.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)},n._setCurrentStateSpriteFrame=function(e){if(e)switch(this._getButtonState()){case O7.NORMAL:this._normalSprite=e;break;case O7.HOVER:this._hoverSprite=e;break;case O7.PRESSED:this._pressedSprite=e;break;case O7.DISABLED:this._disabledSprite=e}},n._onTargetColorChanged=function(e){this._transition===D7.COLOR&&this._setCurrentStateColor(e)},n._setCurrentStateColor=function(e){switch(this._getButtonState()){case O7.NORMAL:this._normalColor=e;break;case O7.HOVER:this._hoverColor=e;break;case O7.PRESSED:this._pressedColor=e;break;case O7.DISABLED:this._disabledColor=e}},n._onTargetTransformChanged=function(e){e&py.SCALE&&this._originalScale&&this._transition===D7.SCALE&&this._transitionFinished&&Pn.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchMove=function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&e){var t=e.touch;if(t){var n,i=this.node._uiProps.uiTransformComp.hitTest(t.getLocation());this._transition===D7.SCALE&&this.target&&this._originalScale?i?(Pn.copy(this._fromScale,this._originalScale),Pn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?O7.PRESSED:O7.NORMAL,this._applyTransition(n)),e&&(e.propagationStopped=!0)}}},n._onTouchEnded=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(QM.emitEvents(this.clickEvents,e),this.node.emit(N7.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==D7.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var e=this._getButtonState();this._applyTransition(e)},n._getButtonState=function(){var e=O7.NORMAL;return this._interactable?this._pressed?e=O7.PRESSED:this._hovered&&(e=O7.HOVER):e=O7.DISABLED,e.toString()},n._updateColorTransition=function(e){var t,n=this[e+"Color"],i=null===(t=this.target)||void 0===t?void 0:t.getComponent(YV);i&&(e===O7.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)},n._updateScaleTransition=function(e){this._interactable&&(e===O7.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(Pn.copy(this._fromScale,this._originalScale),Pn.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(Pn.copy(this._fromScale,this.target.getScale()),Pn.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(e){var t=this._transition;t===D7.COLOR?this._updateColorTransition(e):t===D7.SPRITE?this._updateSpriteTransition(e):t===D7.SCALE&&this._updateScaleTransition(e)},J(t,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable!==e&&(this._interactable=e,this._updateState(),this._interactable||this._resetState())}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===D7.COLOR?this._updateColorTransition(O7.NORMAL):this._transition===D7.SPRITE&&this._updateSpriteTransition(O7.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(Ik);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),t}(Ku),A7.Transition=D7,A7.EventType=N7,ce((c7=b7).prototype,"target",[b8,T8,E8],Object.getOwnPropertyDescriptor(c7.prototype,"target"),c7.prototype),ce(c7.prototype,"interactable",[w8,I8],Object.getOwnPropertyDescriptor(c7.prototype,"interactable"),c7.prototype),ce(c7.prototype,"transition",[P8,R8,D8],Object.getOwnPropertyDescriptor(c7.prototype,"transition"),c7.prototype),ce(c7.prototype,"normalColor",[O8,N8],Object.getOwnPropertyDescriptor(c7.prototype,"normalColor"),c7.prototype),ce(c7.prototype,"pressedColor",[B8,M8],Object.getOwnPropertyDescriptor(c7.prototype,"pressedColor"),c7.prototype),ce(c7.prototype,"hoverColor",[L8,F8],Object.getOwnPropertyDescriptor(c7.prototype,"hoverColor"),c7.prototype),ce(c7.prototype,"disabledColor",[z8,V8],Object.getOwnPropertyDescriptor(c7.prototype,"disabledColor"),c7.prototype),ce(c7.prototype,"duration",[G8,U8,k8,H8],Object.getOwnPropertyDescriptor(c7.prototype,"duration"),c7.prototype),ce(c7.prototype,"zoomScale",[j8,W8],Object.getOwnPropertyDescriptor(c7.prototype,"zoomScale"),c7.prototype),ce(c7.prototype,"normalSprite",[q8,X8,Y8],Object.getOwnPropertyDescriptor(c7.prototype,"normalSprite"),c7.prototype),ce(c7.prototype,"pressedSprite",[K8,J8,Q8],Object.getOwnPropertyDescriptor(c7.prototype,"pressedSprite"),c7.prototype),ce(c7.prototype,"hoverSprite",[Z8,$8,e7],Object.getOwnPropertyDescriptor(c7.prototype,"hoverSprite"),c7.prototype),ce(c7.prototype,"disabledSprite",[t7,n7,i7],Object.getOwnPropertyDescriptor(c7.prototype,"disabledSprite"),c7.prototype),l7=ce(c7.prototype,"clickEvents",[r7,Dc,o7,a7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),u7=ce(c7.prototype,"_interactable",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),h7=ce(c7.prototype,"_transition",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return D7.NONE}}),_7=ce(c7.prototype,"_normalColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wn.WHITE.clone()}}),f7=ce(c7.prototype,"_hoverColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(211,211,211,255)}}),d7=ce(c7.prototype,"_pressedColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wn.WHITE.clone()}}),p7=ce(c7.prototype,"_disabledColor",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new wn(124,124,124,255)}}),m7=ce(c7.prototype,"_normalSprite",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),v7=ce(c7.prototype,"_hoverSprite",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),g7=ce(c7.prototype,"_pressedSprite",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),y7=ce(c7.prototype,"_disabledSprite",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),x7=ce(c7.prototype,"_duration",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),S7=ce(c7.prototype,"_zoomScale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),C7=ce(c7.prototype,"_target",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),s7=c7))||s7)||s7)||s7)||s7)||s7)||s7));l.Button=M7;var L7,F7,z7,V7=function(){function e(){}return e.add=function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)},e.remove=function(e){var t=this._tabIndexList,n=t.indexOf(e);-1!==n&&t.splice(n,1)},e.resort=function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))},e.next=function(e){var t=this._tabIndexList,n=t.indexOf(e);if(e.setFocus(!1),-1!==n){var i=t[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},e}();V7._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(L7||(L7={})),rt(L7),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(F7||(F7={})),rt(F7),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(z7||(z7={})),rt(z7);var G7,U7,k7,H7,j7,W7,q7,X7,Y7,K7,J7,Q7,Z7,$7,e9,t9,n9,i9,r9,o9,a9,s9,c9,l9,u9,h9,_9,f9,d9,p9,m9,v9,g9,y9,x9,S9,C9,A9,b9,T9,E9,w9,I9,P9,R9,D9,O9,N9,B9,M9,L9,F9,z9,V9,G9,U9,k9,H9,j9,W9,q9,X9=function(){function e(){this._editing=!1,this._delegate=null}var t=e.prototype;return t.init=function(){},t.onEnable=function(){},t.update=function(){},t.onDisable=function(){this._editing&&this.endEditing()},t.clear=function(){this._delegate=null},t.setTabIndex=function(){},t.setSize=function(){},t.setFocus=function(e){e?this.beginEditing():this.endEditing()},t.isFocused=function(){return this._editing},t.beginEditing=function(){},t.endEditing=function(){},e}(),Y9=new jn,K9=new jn,J9=new Pn,Q9=null,Z9=0,$9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._delegate=null,t._inputMode=-1,t._inputFlag=-1,t._returnType=-1,t.__eventListeners={},t.__autoResize=!1,t.__orientationChanged=void 0,t._edTxt=null,t._isTextArea=!1,t._textLabelFont=null,t._textLabelFontSize=null,t._textLabelFontColor=null,t._textLabelAlign=null,t._placeholderLabelFont=null,t._placeholderLabelFontSize=null,t._placeholderLabelFontColor=null,t._placeholderLabelAlign=null,t._placeholderLineHeight=null,t._placeholderStyleSheet=null,t._domId="EditBoxId_"+ ++Z9,t}Z(t,e);var n=t.prototype;return n.init=function(e){e&&(this._delegate=e,e.inputMode===F7.ANY?this._createTextArea():this._createInput(),V7.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),V7.remove(this),Q9===this&&(Q9=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(e){this._edTxt.tabIndex=e,V7.resort()},n.setSize=function(e,t){var n=this._edTxt;n&&(n.style.width=e+"px",n.style.height=t+"px")},n.beginEditing=function(){Q9&&Q9!==this&&Q9.setFocus(!1),this._editing=!0,Q9=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){l.GAME_VIEW&&this._edTxt?(l.gameView.container.appendChild(this._edTxt),l.gameView.head.appendChild(this._placeholderStyleSheet)):QO.container&&this._edTxt&&(QO.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(l.GAME_VIEW?vt(l.gameView.container,this._edTxt):vt(QO.container,this._edTxt))&&this._edTxt&&(l.GAME_VIEW?l.gameView.container.removeChild(this._edTxt):QO.container.removeChild(this._edTxt)),(l.GAME_VIEW?vt(l.gameView.head,this._placeholderStyleSheet):vt(document.head,this._placeholderStyleSheet))&&(l.GAME_VIEW?l.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),oh.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),oh.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){oh.os!==iu.ANDROID&&oh.os!==iu.OHOS||(nh.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){oh.os!==iu.ANDROID&&oh.os!==iu.OHOS||(nh.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){oh.browserType!==eu.WECHAT||oh.os!==iu.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var e=this._delegate.node,t=lN.getScaleX(),n=lN.getScaleY(),i=1,r=1;l.GAME_VIEW&&(i=l.gameView.canvas.width/l.game.canvas.width,r=l.gameView.canvas.height/l.game.canvas.height),t*=i,n*=r;var o=lN.getViewportRect(),a=nh.devicePixelRatio;e.getWorldMatrix(Y9);var s=e._uiProps.uiTransformComp;if(s&&Pn.set(J9,-s.anchorX*s.width,-s.anchorY*s.height,J9.z),jn.transform(Y9,Y9,J9),e._uiProps.uiTransformComp){var c=$O.root.batcher2D.getFirstRenderCamera(e);if(c){c.node.getWorldRT(K9);var u=K9.m12,h=K9.m13,_=nN.center;K9.m12=_.x-(K9.m00*u+K9.m04*h),K9.m13=_.y-(K9.m01*u+K9.m05*h),jn.multiply(K9,K9,Y9),t/=a,n/=a;var f=l.GAME_VIEW?l.gameView.container:QO.container,d=K9.m00*t,p=Y9.m01,m=Y9.m04,v=K9.m05*n,g=parseInt(f&&f.style.paddingLeft||"0");g+=o.x*i/a;var y=parseInt(f&&f.style.paddingBottom||"0");y+=o.y/a;var x="matrix("+d+","+-p+","+-m+","+v+","+(K9.m12*t+g)+","+-(K9.m13*n+y)+")";this._edTxt.style.transform=x,this._edTxt.style["-webkit-transform"]=x,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var e=this._delegate,t=e.inputMode,n=e.inputFlag,i=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=t,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===z7.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===z7.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===z7.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;t===F7.EMAIL_ADDR?a="email":t===F7.NUMERIC||t===F7.DECIMAL?a="number":t===F7.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):t===F7.URL?a="url":(a="text",i===L7.SEARCH&&(a="search")),r.type=a;var s="none";n===z7.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===z7.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e},n._initStyleSheet=function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,this._updateTextLabel(e.textLabel))},n._updateTextLabel=function(e){if(e){var t=e.font;t=!t||t instanceof tF?e.fontFamily:t._fontFamily;var n=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==n||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=n,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=e.color.toCSS(),i.style.fontFamily=t,e.horizontalAlign){case ZV.HorizontalAlign.LEFT:i.style.textAlign="left";break;case ZV.HorizontalAlign.CENTER:i.style.textAlign="center";break;case ZV.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(e){if(e){var t=e.font;t=!t||t instanceof tF?e.fontFamily:e.font._fontFamily;var n=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,r=e.color.toCSS(),o=e.fontSize,a="";switch(e.horizontalAlign){case ZV.HorizontalAlign.LEFT:a="left";break;case ZV.HorizontalAlign.CENTER:a="center";break;case ZV.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",oh.browserType===eu.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var e=this;if(this._edTxt){var t=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,e._delegate._editBoxTextChanged(t.value)},i.onInput=function(){if(!n){var i=e._delegate,r=i.maxLength;r>=0&&(t.value=t.value.slice(0,r)),i._editBoxTextChanged(t.value)}},i.onClick=function(){e._editing&&oh.isMobile&&e._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===rR.ENTER?(n.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):n.keyCode===rR.TAB&&(n.propagationStopped=!0,n.preventDefault(),V7.next(e))},i.onBlur=function(){oh.isMobile&&n&&i.compositionEnd(),e._editing=!1,Q9=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",i.compositionStart),t.addEventListener("compositionend",i.compositionEnd),t.addEventListener("input",i.onInput),t.addEventListener("keydown",i.onKeydown),t.addEventListener("blur",i.onBlur),t.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}},t}(X9);!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(q9||(q9={}));var eee,tee,nee,iee,ree,oee,aee,see,cee,lee,uee,hee,_ee,fee,dee,pee,mee,vee,gee,yee,xee,See,Cee,Aee,bee,Tee,Eee,wee,Iee,Pee,Ree,Dee,Oee,Nee,Bee,Mee,Lee,Fee,zee,Vee,Gee,Uee,kee,Hee,jee,Wee,qee,Xee,Yee,Kee,Jee,Qee,Zee,$ee,ete,tte,nte,ite,rte,ote,ate,ste=function(t){return e({EditBox:t,EditBoxComponent:t}),t}((G7=Ac("cc.EditBox"),U7=Uc(),k7=Tc(110),H7=Fc(),j7=bc(uz),W7=Zc(),q7=qc(),X7=Zc(),Y7=qc(),K7=ol(ZV),J7=Zc(),Q7=qc(),Z7=ol(ZV),$7=Zc(),e9=qc(),t9=ol(BL),n9=Zc(),i9=qc(),r9=ol(z7),o9=Zc(),a9=qc(),s9=ol(F7),c9=Zc(),l9=qc(),u9=ol(L7),h9=Zc(),_9=qc(),f9=Zc(),d9=qc(),p9=Zc(),m9=qc(),v9=ol([QM]),g9=Zc(),y9=qc(),x9=ol([QM]),S9=Zc(),C9=qc(),A9=ol([QM]),b9=Zc(),T9=qc(),E9=ol([QM]),w9=Zc(),I9=qc(),G7(P9=U7(P9=k7(P9=H7(P9=j7(P9=Lc((W9=j9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"editingDidBegan",D9,re(t)),se(t,"textChanged",O9,re(t)),se(t,"editingDidEnded",N9,re(t)),se(t,"editingReturn",B9,re(t)),t._impl=null,t._background=null,se(t,"_textLabel",M9,re(t)),se(t,"_placeholderLabel",L9,re(t)),se(t,"_returnType",F9,re(t)),se(t,"_string",z9,re(t)),se(t,"_tabIndex",V9,re(t)),se(t,"_backgroundImage",G9,re(t)),se(t,"_inputFlag",U9,re(t)),se(t,"_inputMode",k9,re(t)),se(t,"_maxLength",H9,re(t)),t._isLabelVisible=!1,t}Z(t,e);var n=t.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){QM.emitEvents(this.editingDidBegan,this),this.node.emit(q9.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){QM.emitEvents(this.editingDidEnded,this),this.node.emit(q9.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,QM.emitEvents(this.textChanged,e,this),this.node.emit(q9.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){QM.emitEvents(this.editingReturn,this),this.node.emit(q9.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(e){e.propagationStopped=!0},n._onTouchCancel=function(e){e.propagationStopped=!0},n._onTouchEnded=function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(eb.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var e=this.node.getComponent(Ik);e||(e=this.node.addComponent(Ik)),e!==this._background&&(e.type=Ik.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||((t=new nE("TEXT_LABEL")).layer=this.node.layer),(e=t.getComponent(ZV))||(e=t.addComponent(ZV)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=ZV.Overflow.CLAMP,this._inputMode===F7.ANY?(e.verticalAlign=WV.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||((t=new nE("PLACEHOLDER_LABEL")).layer=this.node.layer),(e=t.getComponent(ZV))||(e=t.addComponent(ZV)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),this._inputMode===F7.ANY?e.enableWrapText=!0:e.enableWrapText=!1,e.string=this.placeholder},n._syncSize=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=e.anchorPoint,n.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)},n._updateLabels=function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}},n._updateString=function(e){var t=this._textLabel;if(t){var n=e;n&&(n=this._updateLabelStringStyle(n)),t.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(e,t){void 0===t&&(t=!1);var n,i=this._inputFlag;if(t||i!==z7.PASSWORD)i===z7.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===z7.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()})):i===z7.INITIAL_CAPS_SENTENCE&&(e=(n=e).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=e.length,a=0;a<o;++a)r+="";e=r}return e},n._registerEvent=function(){this.node.on(eb.TOUCH_START,this._onTouchBegan,this),this.node.on(eb.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(eb.TOUCH_START,this._onTouchBegan,this),this.node.off(eb.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.on(Ik.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.off(Ik.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=-t.anchorX*t.width,i=-t.anchorY*t.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),o.node.setPosition(n+2,i+e.height,o.node.position.z),this._inputMode===F7.ANY&&(o.verticalAlign=WV.TOP),o.enableWrapText=this._inputMode===F7.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(n+2,i+e.height,r.node.position.z),r.enableWrapText=this._inputMode===F7.ANY)},n._resizeChildNodes=function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-e.width/2,e.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(e.contentSize),this._syncSize()},J(t,[{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string!==e&&(this._string=e,this._updateString(e))}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag!==e&&(this._inputFlag=e,this._updateString(this._string))}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(Ku),j9._EditBoxImpl=X9,j9.KeyboardReturnType=L7,j9.InputFlag=z7,j9.InputMode=F7,j9.EventType=q9,ce((R9=W9).prototype,"string",[W7,q7],Object.getOwnPropertyDescriptor(R9.prototype,"string"),R9.prototype),ce(R9.prototype,"placeholder",[X7,Y7],Object.getOwnPropertyDescriptor(R9.prototype,"placeholder"),R9.prototype),ce(R9.prototype,"textLabel",[K7,J7,Q7],Object.getOwnPropertyDescriptor(R9.prototype,"textLabel"),R9.prototype),ce(R9.prototype,"placeholderLabel",[Z7,$7,e9],Object.getOwnPropertyDescriptor(R9.prototype,"placeholderLabel"),R9.prototype),ce(R9.prototype,"backgroundImage",[t9,n9,i9],Object.getOwnPropertyDescriptor(R9.prototype,"backgroundImage"),R9.prototype),ce(R9.prototype,"inputFlag",[r9,o9,a9],Object.getOwnPropertyDescriptor(R9.prototype,"inputFlag"),R9.prototype),ce(R9.prototype,"inputMode",[s9,c9,l9],Object.getOwnPropertyDescriptor(R9.prototype,"inputMode"),R9.prototype),ce(R9.prototype,"returnType",[u9,h9,_9],Object.getOwnPropertyDescriptor(R9.prototype,"returnType"),R9.prototype),ce(R9.prototype,"maxLength",[f9,d9],Object.getOwnPropertyDescriptor(R9.prototype,"maxLength"),R9.prototype),ce(R9.prototype,"tabIndex",[p9,m9],Object.getOwnPropertyDescriptor(R9.prototype,"tabIndex"),R9.prototype),D9=ce(R9.prototype,"editingDidBegan",[v9,Dc,g9,y9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),O9=ce(R9.prototype,"textChanged",[x9,Dc,S9,C9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),N9=ce(R9.prototype,"editingDidEnded",[A9,Dc,b9,T9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),B9=ce(R9.prototype,"editingReturn",[E9,Dc,w9,I9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),M9=ce(R9.prototype,"_textLabel",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),L9=ce(R9.prototype,"_placeholderLabel",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),F9=ce(R9.prototype,"_returnType",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return L7.DEFAULT}}),z9=ce(R9.prototype,"_string",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),V9=ce(R9.prototype,"_tabIndex",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),G9=ce(R9.prototype,"_backgroundImage",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),U9=ce(R9.prototype,"_inputFlag",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return z7.DEFAULT}}),k9=ce(R9.prototype,"_inputMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return F7.ANY}}),H9=ce(R9.prototype,"_maxLength",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),P9=R9))||P9)||P9)||P9)||P9)||P9)||P9));"object"==typeof window&&"object"==typeof document&&(ste._EditBoxImpl=$9),l.internal.EditBox=ste,function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(tte||(tte={})),st(tte),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(nte||(nte={})),st(nte),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(ite||(ite={})),st(ite),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(rte||(rte={})),st(rte),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(ote||(ote={})),st(ote),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(ate||(ate={})),st(ate);var cte,lte,ute,hte,_te,fte,dte,pte,mte,vte,gte,yte,xte,Ste,Cte,Ate,bte,Tte,Ete,wte,Ite,Pte,Rte,Dte=new Pn,Ote=function(t){return e({Layout:t,LayoutComponent:t}),t}((eee=Ac("cc.Layout"),tee=Uc(),nee=Tc(110),iee=Fc(),ree=bc(uz),oee=Hc(),aee=qc(),see=Hc(),cee=qc(),lee=ol(tte),uee=Zc(),hee=qc(),_ee=ol(nte),fee=Hc(),dee=qc(),pee=Hc(),mee=qc(),vee=ol(ite),gee=qc(),yee=qc(),xee=qc(),See=qc(),Cee=qc(),Aee=qc(),bee=qc(),Tee=ol(rte),Eee=qc(),wee=ol(ote),Iee=qc(),Pee=ol(ate),Ree=Hc(),Dee=qc(),Oee=Hc(),Nee=qc(),Bee=qc(),eee(Mee=tee(Mee=nee(Mee=iee(Mee=ree(Mee=Lc((ete=$ee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_resizeMode",Fee,re(t)),se(t,"_layoutType",zee,re(t)),se(t,"_cellSize",Vee,re(t)),se(t,"_startAxis",Gee,re(t)),se(t,"_paddingLeft",Uee,re(t)),se(t,"_paddingRight",kee,re(t)),se(t,"_paddingTop",Hee,re(t)),se(t,"_paddingBottom",jee,re(t)),se(t,"_spacingX",Wee,re(t)),se(t,"_spacingY",qee,re(t)),se(t,"_verticalDirection",Xee,re(t)),se(t,"_horizontalDirection",Yee,re(t)),se(t,"_constraint",Kee,re(t)),se(t,"_constraintNum",Jee,re(t)),se(t,"_affectedByScale",Qee,re(t)),se(t,"_isAlign",Zee,re(t)),t._layoutSize=new ti(300,200),t._layoutDirty=!0,t._childrenDirty=!1,t._usefulLayoutObj=[],t._init=!1,t}Z(t,e);var n=t.prototype;return n.updateLayout=function(e){void 0===e&&(e=!1),(this._layoutDirty||e)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(ti.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){$O.on(ZO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(eb.SIZE_CHANGED,this._resized,this),this.node.on(eb.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(eb.CHILD_ADDED,this._childAdded,this),this.node.on(eb.CHILD_REMOVED,this._childRemoved,this),this.node.on(eb.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){$O.off(ZO.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(eb.SIZE_CHANGED,this._resized,this),this.node.off(eb.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(eb.CHILD_ADDED,this._childAdded,this),this.node.off(eb.CHILD_REMOVED,this._childRemoved,this),this.node.off(eb.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.on(eb.SIZE_CHANGED,this._doLayoutDirty,this),n.on(eb.TRANSFORM_CHANGED,this._transformDirty,this),n.on(eb.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(eb.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.off(eb.SIZE_CHANGED,this._doLayoutDirty,this),n.off(eb.TRANSFORM_CHANGED,this._transformDirty,this),n.off(eb.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(eb.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(e){e.on(eb.SIZE_CHANGED,this._doLayoutDirty,this),e.on(eb.TRANSFORM_CHANGED,this._transformDirty,this),e.on(eb.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on(eb.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(e){e.off(eb.SIZE_CHANGED,this._doLayoutDirty,this),e.off(eb.TRANSFORM_CHANGED,this._transformDirty,this),e.off(eb.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off(eb.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===ote.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*e+a*s,l=c-a*this._spacingX,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==tte.GRID&&this._resizeMode===nte.CHILDREN&&(m=(e-v-(p-1)*this._spacingX)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,C=S.scale,A=this._getUsedScaleValue(C.x),b=this._getUsedScaleValue(C.y);this._resizeMode===nte.CHILDREN&&(x.width=m/A,this._layoutType===tte.GRID&&(x.height=this._cellSize.height/b));var T=Math.abs(this._horizontalDirection-x.anchorX),E=x.width*A,w=x.height*b;w>_&&(f=Math.max(_,f),h=_||w,_=w),l+=a*(T*E+this._spacingX);var I=a*(1-T)*E;if(t){if(o>0)(d=y/o>0&&y%o==0)&&(h=_>w?_:h);else if(E>e-v)l>c+a*T*E&&(d=!0);else{var P=(1-this._horizontalDirection-r.x)*e,R=l+I+a*(a>0?this._paddingRight:this._paddingLeft);d=Math.abs(R)>Math.abs(P)}d&&(l=c+a*T*E,w!==_&&(h=_),u+=h+this._spacingY,h=_=w)}var D=n(S,x,u);i&&S.setPosition(l,D),l+=I}return h=Math.max(h,_),Math.max(f,u+h)+this._getPaddingV()},n._doLayoutVertically=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===rte.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*e+a*s,l=c-a*this._spacingY,u=0,h=0,_=0,f=0,d=!1,p=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==tte.GRID&&this._resizeMode===nte.CHILDREN&&(m=(e-v-(p-1)*this._spacingY)/p);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,C=S.scale,A=this._getUsedScaleValue(C.x),b=this._getUsedScaleValue(C.y);this._resizeMode===nte.CHILDREN&&(x.height=m/b,this._layoutType===tte.GRID&&(x.width=this._cellSize.width/A));var T=Math.abs(this._verticalDirection-x.anchorY),E=x.width*A,w=x.height*b;E>u&&(h=Math.max(u,h),_=u||E,u=E),l+=a*(T*w+this._spacingY);var I=a*(1-T)*w;if(t){if(o>0)(d=y/o>0&&y%o==0)&&(_=u>w?u:_);else if(w>e-v)l>c+a*T*w&&(d=!0);else{var P=(1-this._verticalDirection-r.y)*e,R=l+I+a*(a>0?this._paddingTop:this._paddingBottom);d=Math.abs(R)>Math.abs(P)}d&&(l=c+a*T*w,E!==u&&(_=u),f+=_+this._spacingX,_=u=E)}var D=n(S,x,f);i&&(S.getPosition(Dte),S.setPosition(D,l,Dte.z)),l+=I}return _=Math.max(_,u),Math.max(h,f+_)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(e,t){var n=this,i=t.width,r=1,o=-e.y*t.height,a=this._paddingBottom;this._verticalDirection===rte.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*t.height,a=this._paddingTop);var s=function(e,t,i){return o+r*(i+(1-t.anchorY)*t.height*n._getUsedScaleValue(e.scale.y)+a)},c=0;this._resizeMode===nte.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-e.y*c,this._verticalDirection===rte.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===nte.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(e,t){var n=this,i=t.height,r=1,o=-e.x*t.width,a=this._paddingLeft;this._horizontalDirection===ote.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*t.width,a=this._paddingRight);var s=function(e,t,i){return o+r*(i+(1-t.anchorX)*t.width*n._getUsedScaleValue(e.scale.x)+a)},c=0;this._resizeMode===nte.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-e.x*c,this._horizontalDirection===ote.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===nte.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,n=e.contentSize;this.startAxis===ite.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,n):this.startAxis===ite.VERTICAL&&this._doLayoutGridAxisVertical(t,n)},n._getHorizontalBaseWidth=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===nte.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.width*this._getUsedScaleValue(o.x)}t+=(n-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t},n._getVerticalBaseHeight=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===nte.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.height*this._getUsedScaleValue(o.y)}t+=(n-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t},n._doLayout=function(){var e=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===tte.HORIZONTAL){var t=this._getHorizontalBaseWidth();this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?Pn.ZERO:t.position).y}),!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===tte.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(t){return(e._isAlign?Pn.ZERO:t.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===tte.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(e){return this._affectedByScale?Math.abs(e):1},n._transformDirty=function(e){e&py.SCALE&&e&py.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==tte.GRID||this._constraint===ate.NONE||this._constraintNum<=0)return 0;var e=this._constraint===ate.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===ite.VERTICAL&&(e=this._constraint===ate.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e},J(t,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===tte.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===tte.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==tte.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==tte.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==ate.NONE&&this._constraintNum!==e&&(e<=0&&x("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(Ku),$ee.Type=tte,$ee.VerticalDirection=rte,$ee.HorizontalDirection=ote,$ee.ResizeMode=nte,$ee.AxisDirection=ite,$ee.Constraint=ate,ce((Lee=ete).prototype,"alignHorizontal",[oee,aee],Object.getOwnPropertyDescriptor(Lee.prototype,"alignHorizontal"),Lee.prototype),ce(Lee.prototype,"alignVertical",[see,cee],Object.getOwnPropertyDescriptor(Lee.prototype,"alignVertical"),Lee.prototype),ce(Lee.prototype,"type",[lee,uee,hee],Object.getOwnPropertyDescriptor(Lee.prototype,"type"),Lee.prototype),ce(Lee.prototype,"resizeMode",[_ee,fee,dee],Object.getOwnPropertyDescriptor(Lee.prototype,"resizeMode"),Lee.prototype),ce(Lee.prototype,"cellSize",[pee,mee],Object.getOwnPropertyDescriptor(Lee.prototype,"cellSize"),Lee.prototype),ce(Lee.prototype,"startAxis",[vee,gee],Object.getOwnPropertyDescriptor(Lee.prototype,"startAxis"),Lee.prototype),ce(Lee.prototype,"paddingLeft",[yee],Object.getOwnPropertyDescriptor(Lee.prototype,"paddingLeft"),Lee.prototype),ce(Lee.prototype,"paddingRight",[xee],Object.getOwnPropertyDescriptor(Lee.prototype,"paddingRight"),Lee.prototype),ce(Lee.prototype,"paddingTop",[See],Object.getOwnPropertyDescriptor(Lee.prototype,"paddingTop"),Lee.prototype),ce(Lee.prototype,"paddingBottom",[Cee],Object.getOwnPropertyDescriptor(Lee.prototype,"paddingBottom"),Lee.prototype),ce(Lee.prototype,"spacingX",[Aee],Object.getOwnPropertyDescriptor(Lee.prototype,"spacingX"),Lee.prototype),ce(Lee.prototype,"spacingY",[bee],Object.getOwnPropertyDescriptor(Lee.prototype,"spacingY"),Lee.prototype),ce(Lee.prototype,"verticalDirection",[Tee,Eee],Object.getOwnPropertyDescriptor(Lee.prototype,"verticalDirection"),Lee.prototype),ce(Lee.prototype,"horizontalDirection",[wee,Iee],Object.getOwnPropertyDescriptor(Lee.prototype,"horizontalDirection"),Lee.prototype),ce(Lee.prototype,"constraint",[Pee,Ree,Dee],Object.getOwnPropertyDescriptor(Lee.prototype,"constraint"),Lee.prototype),ce(Lee.prototype,"constraintNum",[Oee,Nee],Object.getOwnPropertyDescriptor(Lee.prototype,"constraintNum"),Lee.prototype),ce(Lee.prototype,"affectedByScale",[Bee],Object.getOwnPropertyDescriptor(Lee.prototype,"affectedByScale"),Lee.prototype),Fee=ce(Lee.prototype,"_resizeMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nte.NONE}}),zee=ce(Lee.prototype,"_layoutType",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tte.NONE}}),Vee=ce(Lee.prototype,"_cellSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(40,40)}}),Gee=ce(Lee.prototype,"_startAxis",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ite.HORIZONTAL}}),Uee=ce(Lee.prototype,"_paddingLeft",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kee=ce(Lee.prototype,"_paddingRight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hee=ce(Lee.prototype,"_paddingTop",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jee=ce(Lee.prototype,"_paddingBottom",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wee=ce(Lee.prototype,"_spacingX",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qee=ce(Lee.prototype,"_spacingY",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xee=ce(Lee.prototype,"_verticalDirection",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rte.TOP_TO_BOTTOM}}),Yee=ce(Lee.prototype,"_horizontalDirection",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ote.LEFT_TO_RIGHT}}),Kee=ce(Lee.prototype,"_constraint",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ate.NONE}}),Jee=ce(Lee.prototype,"_constraintNum",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Qee=ce(Lee.prototype,"_affectedByScale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zee=ce(Lee.prototype,"_isAlign",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mee=Lee))||Mee)||Mee)||Mee)||Mee)||Mee)||Mee));l.Layout=Ote,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(Rte||(Rte={})),rt(Rte);var Nte,Bte,Mte,Lte,Fte,zte,Vte,Gte,Ute,kte,Hte,jte,Wte,qte,Xte,Yte,Kte,Jte,Qte,Zte,$te,ene,tne,nne,ine=function(t){return e({ProgressBar:t,ProgressBarComponent:t}),t}((cte=Ac("cc.ProgressBar"),lte=Uc(),ute=Tc(110),hte=Fc(),_te=bc(uz),fte=ol(Ik),dte=qc(),pte=ol(Rte),mte=qc(),vte=qc(),gte=Xc(),yte=qc(),xte=qc(),cte(Ste=lte(Ste=ute(Ste=hte(Ste=_te((Pte=Ite=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_barSprite",Ate,re(t)),se(t,"_mode",bte,re(t)),se(t,"_totalLength",Tte,re(t)),se(t,"_progress",Ete,re(t)),se(t,"_reverse",wte,re(t)),t}Z(t,e);var n=t.prototype;return n._initBarSprite=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===Ik.FillType.RADIAL&&(this._mode=Rte.FILLED),this._mode===Rte.HORIZONTAL?this.totalLength=r.width:this._mode===Rte.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var o=-n.width*i.x;e.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,n=t.anchorPoint,i=t.contentSize,r=e.getPosition(),o=new Yn(0,.5),a=ln(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case Rte.HORIZONTAL:this._reverse&&(o=new Yn(1,.5)),c=new ti(s,i.height),l=this._totalLength,u=i.height;break;case Rte.VERTICAL:o=this._reverse?new Yn(.5,1):new Yn(.5,0),c=new ti(i.width,s),l=i.width,u=this._totalLength}if(this._mode===Rte.FILLED)this._barSprite.type!==Ik.Type.FILLED?x("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==Ik.Type.FILLED){var h=o.x-n.x,_=o.y-n.y,f=new Pn(l*h,u*_,0);e.setPosition(r.x+f.x,r.y+f.y,r.z),t.setAnchorPoint(o),t.setContentSize(c)}else x("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},J(t,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var n=t._uiProps.uiTransformComp.contentSize;this._mode===Rte.HORIZONTAL?this.totalLength=n.width:this._mode===Rte.VERTICAL?this.totalLength=n.height:this._mode===Rte.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===Rte.FILLED&&(e=ln(e)),this._totalLength!==e&&(this._totalLength=e,this._updateBarStatus())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(Ku),Ite.Mode=Rte,ce((Cte=Pte).prototype,"barSprite",[fte,dte],Object.getOwnPropertyDescriptor(Cte.prototype,"barSprite"),Cte.prototype),ce(Cte.prototype,"mode",[pte,mte],Object.getOwnPropertyDescriptor(Cte.prototype,"mode"),Cte.prototype),ce(Cte.prototype,"totalLength",[vte],Object.getOwnPropertyDescriptor(Cte.prototype,"totalLength"),Cte.prototype),ce(Cte.prototype,"progress",[gte,Qc,yte],Object.getOwnPropertyDescriptor(Cte.prototype,"progress"),Cte.prototype),ce(Cte.prototype,"reverse",[xte],Object.getOwnPropertyDescriptor(Cte.prototype,"reverse"),Cte.prototype),Ate=ce(Cte.prototype,"_barSprite",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bte=ce(Cte.prototype,"_mode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rte.HORIZONTAL}}),Tte=ce(Cte.prototype,"_totalLength",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ete=ce(Cte.prototype,"_progress",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),wte=ce(Cte.prototype,"_reverse",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ste=Cte))||Ste)||Ste)||Ste)||Ste)||Ste));l.ProgressBar=ine;var rne,one=new Pn,ane=new Pn,sne=new Pn,cne=new Yn,lne=new wn,une=new Yn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(rne||(rne={})),st(rne);var hne,_ne=function(t){return e({ScrollBar:t,ScrollBarComponent:t}),t}((Nte=Ac("cc.ScrollBar"),Bte=Uc(),Mte=Tc(110),Lte=Fc(),Fte=bc(uz),zte=ol(Ik),Vte=Zc(),Gte=qc(),Ute=ol(rne),kte=Zc(),Hte=qc(),jte=Zc(),Wte=qc(),qte=Zc(),Xte=qc(),Nte(Yte=Bte(Yte=Mte(Yte=Lte(Yte=Fte((nne=tne=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_scrollView",Jte,re(t)),se(t,"_handle",Qte,re(t)),se(t,"_direction",Zte,re(t)),se(t,"_enableAutoHide",$te,re(t)),se(t,"_autoHideTime",ene,re(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}Z(t,e);var n=t.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var n=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=une;u.set(0,0),this._direction===rne.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=e.x,this._convertToScrollViewSpace(u,t),c=-u.x):this._direction===rne.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=e.y,this._convertToScrollViewSpace(u,t),c=-u.y);var h=this._calculateLength(o,a,l,s),_=une;this._calculatePosition(_,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(_)}}}},n.setScrollView=function(e){this._scrollView=e},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var e=this.node.getComponent(Ik);e&&(this._opacity=e.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(e){this._processAutoHide(e)},n._convertToScrollViewSpace=function(e,t){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp;if(n&&i){one.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(one,ane);var r=n.convertToNodeSpaceAR(ane);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,e.set(r.x,r.y)}else e.set(Yn.ZERO)},n._setOpacity=function(e){if(this._handle){var t=this.node.getComponent(Ik);t&&(lne.set(t.color),lne.a=e,t.color=lne),(t=this._handle.getComponent(Ik))&&(lne.set(t.color),lne.a=e,t.color=lne)}},n._updateHandlerPosition=function(e){if(this._handle){var t=sne;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}},n._fixupHandlerPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;Pn.set(one,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(one,ane),s=e;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===rne.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===rne.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(e,t){return e.width<=t.width&&this._direction===rne.HORIZONTAL||e.height<=t.height&&this._direction===rne.VERTICAL},n._calculateLength=function(e,t,n,i){var r=e;return i&&(r+=20*(i>0?i:-i)),n*(t/r)},n._calculatePosition=function(e,t,n,i,r,o,a){var s=t-n;o&&(s+=Math.abs(o));var c=0;s&&(c=ln(c=r/s));var l=(i-a)*c;this._direction===rne.VERTICAL?e.set(0,l):e.set(l,0)},n._updateLength=function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint;i.x===cne.x&&i.y===cne.y||t.setAnchorPoint(cne),this._direction===rne.HORIZONTAL?t.setContentSize(e,n.height):t.setContentSize(n.width,e)}},n._processAutoHide=function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}},J(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(Yn.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(Yn.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(Ku),tne.Direction=rne,ce((Kte=nne).prototype,"handle",[zte,Vte,Gte],Object.getOwnPropertyDescriptor(Kte.prototype,"handle"),Kte.prototype),ce(Kte.prototype,"direction",[Ute,kte,Hte],Object.getOwnPropertyDescriptor(Kte.prototype,"direction"),Kte.prototype),ce(Kte.prototype,"enableAutoHide",[jte,Wte],Object.getOwnPropertyDescriptor(Kte.prototype,"enableAutoHide"),Kte.prototype),ce(Kte.prototype,"autoHideTime",[qte,Xte],Object.getOwnPropertyDescriptor(Kte.prototype,"autoHideTime"),Kte.prototype),Jte=ce(Kte.prototype,"_scrollView",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qte=ce(Kte.prototype,"_handle",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zte=ce(Kte.prototype,"_direction",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rne.HORIZONTAL}}),$te=ce(Kte.prototype,"_enableAutoHide",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ene=ce(Kte.prototype,"_autoHideTime",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Yte=Kte))||Yte)||Yte)||Yte)||Yte)||Yte));l.ScrollBar=_ne;var fne,dne,pne,mne,vne,gne,yne,xne,Sne,Cne,Ane,bne,Tne,Ene,wne,Ine,Pne,Rne,Dne,One,Nne,Bne,Mne,Lne,Fne,zne,Vne,Gne,Une,kne,Hne,jne,Wne,qne,Xne,Yne,Kne,Jne,Qne,Zne,$ne,eie,tie,nie,iie,rie,oie,aie,sie=e("ViewGroup",Ac("cc.ViewGroup")(hne=Tc(110)(hne=function(e){function t(){return e.apply(this,arguments)||this}return Z(t,e),t}(Ku))||hne)||hne);l.ViewGroup=sie;var cie,lie=1e-4,uie=new Pn,hie=new Pn,_ie=new Yn,fie=new Yn,die=function(){return(new Date).getMilliseconds()},pie={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(cie||(cie={}));var mie,vie,gie,yie,xie,Sie,Cie,Aie,bie,Tie,Eie,wie,Iie,Pie,Rie,Die,Oie,Nie,Bie,Mie,Lie,Fie=function(t){return e({ScrollView:t,ScrollViewComponent:t}),t}((fne=Ac("cc.ScrollView"),dne=Uc(),pne=Tc(110),mne=Fc(),vne=bc(uz),gne=Xc(),yne=Zc(),xne=qc(),Sne=Xc(),Cne=Zc(),Ane=qc(),bne=Zc(),Tne=qc(),Ene=Zc(),wne=qc(),Ine=ol(nE),Pne=Zc(),Rne=qc(),Dne=Zc(),One=qc(),Nne=ol(_ne),Bne=Zc(),Mne=qc(),Lne=Zc(),Fne=qc(),zne=ol(_ne),Vne=Zc(),Gne=qc(),Une=Zc(),kne=qc(),Hne=ol([QM]),jne=Zc(),Wne=qc(),fne(qne=dne(qne=pne(qne=mne(qne=vne((aie=oie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"bounceDuration",Yne,re(t)),se(t,"brake",Kne,re(t)),se(t,"elastic",Jne,re(t)),se(t,"inertia",Qne,re(t)),se(t,"horizontal",Zne,re(t)),se(t,"vertical",$ne,re(t)),se(t,"cancelInnerEvents",eie,re(t)),se(t,"scrollEvents",tie,re(t)),t._autoScrolling=!1,t._scrolling=!1,se(t,"_content",nie,re(t)),se(t,"_horizontalScrollBar",iie,re(t)),se(t,"_verticalScrollBar",rie,re(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new Pn,t._autoScrollTargetDelta=new Pn,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new Pn,t._outOfBoundaryAmount=new Pn,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new Pn,t._deltaPos=new Pn,t}Z(t,e);var n=t.prototype;return n.scrollToBottom=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n,!0)},n.scrollToTop=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Yn(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToOffset=function(e,t,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new Yn(0,0);0===i.x?r.x=0:r.x=e.x/i.x,0===i.y?r.y=1:r.y=(i.y-e.y)/i.y,this.scrollTo(r,t,n)},n.getScrollOffset=function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Yn(t,e)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return Yn.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,n=e.height-this.view.height;return new Yn(t=t>=0?t:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Yn(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==n):this._moveContent(i)},n.scrollTo=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Yn(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.scrollToPercentVertical=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Yn(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(e){this._setContentPosition(e)},n._setContentPosition=function(e){if(this._content){var t=this._getContentPosition();Math.abs(e.x-t.x)<lie&&Math.abs(e.y-t.y)<lie||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):Pn.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return lie},n.start=function(){this._calculateBoundary(),this._content&&$O.once(ZO.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(eb.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(eb.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(eb.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(eb.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(e){this._autoScrolling&&this._processAutoScrolling(e)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(eb.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(eb.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(eb.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(eb.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(eb.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(eb.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(eb.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(eb.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(eb.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(eb.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(eb.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(eb.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(eb.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(eb.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var n=new Pn,i=e.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}},n._onTouchBegan=function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))},n._onTouchMoved=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var n=e.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(_ie);if(i.subtract(n.getUIStartLocation(fie)),i.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new iR(e.getTouches(),e.bubbles,KE.TOUCH_CANCEL);r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}},n._onTouchEnded=function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(cie.TOUCH_UP);var n=e.touch;this._handleReleaseLogic(n),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}},n._onTouchCancelled=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var n=e.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(e)}},n._calculateBoundary=function(){if(this._content&&this.view){var e=this._content.getComponent(Ote);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,n=t.width*t.anchorX,i=t.height*t.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}},n._hasNestedViewGroup=function(e,t){if(!e||e.eventPhase!==ZP.CAPTURING_PHASE)return!1;if(t)for(var n,i=ae(t);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!e.target||!e.target.getComponent(sie));if(r.getComponent(sie))return!0}return!1},n._startInertiaScroll=function(e){var t=new Pn(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)},n._calculateAttenuatedFactor=function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))},n._startAttenuatingAutoScroll=function(e,t){var n=e.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=e.length(),u=n.length()/l;if(n.add(e),this.brake>0&&u>7){u=Math.sqrt(u);var h=e.clone();h.multiplyScalar(u),n.set(h),n.add(e)}var _=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&u>3&&(_*=u=3),0===this.brake&&u>1&&(_*=u),this._startAutoScroll(n,_,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(e){return Math.sqrt(Math.sqrt(e/5))},n._startAutoScroll=function(e,t,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,Pn.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(Pn.ZERO,lie)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var e=new Pn,t=0;if((t=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),t))<=0||t>=.5)e.set(Pn.ZERO);else{var n=new Pn;n=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),n),e.set(n.x*(1-this.brake)/t,n.y*(1-this.brake)/t,n.z)}return e},n._flattenVectorByDirection=function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t},n._moveContent=function(e,t){var n=this._flattenVectorByDirection(e);uie.set(this._getContentPosition()),uie.add(n),uie.set(Math.round(1e4*uie.x)*lie,Math.round(1e4*uie.y)*lie,uie.z),this._setContentPosition(uie);var i=this._getHowMuchOutOfBoundary();_ie.set(i.x,i.y),this._updateScrollBar(_ie),this.elastic&&t&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height},n._getHowMuchOutOfBoundary=function(e){if((e=e||new Pn).equals(Pn.ZERO,lie)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new Pn,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+e.x>this._leftBoundary?t.x=this._leftBoundary-(n+e.x):i+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(i+e.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+e.y<this._topBoundary?t.y=this._topBoundary-(r+e.y):o+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(o+e.y)),e.equals(Pn.ZERO,lie)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t},n._updateScrollBar=function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(e){if(e===cie.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===cie.SCROLL_TO_TOP||e===cie.SCROLL_TO_BOTTOM||e===cie.SCROLL_TO_LEFT||e===cie.SCROLL_TO_RIGHT){var t=1<<pie[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}QM.emitEvents(this.scrollEvents,this,pie[e]),this.node.emit(e,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();uie.set(this._getContentPosition()),uie.add(e),this._content.setPosition(uie),this._updateScrollBar(Yn.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(e){e.eventPhase===ZP.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)},n._processDeltaMove=function(e){this._scrollChildren(e),this._gatherTouchMove(e)},n._handleMoveLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(cie.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(e,t){var n=this.node._uiProps.uiTransformComp,i=new Pn;n&&(t.getUILocation(_ie),t.getUIPreviousLocation(fie),uie.set(_ie.x,_ie.y,0),hie.set(fie.x,fie.y,0),n.convertToNodeSpaceAR(uie,uie),n.convertToNodeSpaceAR(hie,hie),Pn.subtract(i,uie,hie)),e.set(i)},n._scrollChildren=function(e){this._clampDelta(e);var t,n=e;this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||Pn.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=cie.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=cie.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=cie.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=cie.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(cie.SCROLL_BEGAN)),this._dispatchEvent(cie.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(cie.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=die(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(e){if(this._content&&this.view){var t=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<t.width&&(e.x=0),n.height<t.height&&(e.y=0)}},n._gatherTouchMove=function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var n=die();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(Pn.ZERO,lie))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(cie.BOUNCE_TOP),e.y<0&&this._dispatchEvent(cie.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(cie.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(cie.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(uie,lie)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(Pn.ZERO,lie)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,Pn.copy(this._autoScrollBrakingStartPosition,this._getContentPosition()),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(e){var t=this._isNecessaryAutoScrollBrake(),n=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=lie;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(cie.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),t&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(Pn.ZERO,lie)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(cie.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(cie.SCROLL_ENDED))},n._checkMouseWheel=function(e){if(!this._getHowMuchOutOfBoundary().equals(Pn.ZERO,lie))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(cie.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(cie.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(e){var t=e.anchor,n=e.applyToHorizontal,i=e.applyToVertical;this._calculateBoundary(),t.clampf(Yn.ZERO,Yn.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new Pn;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*t.x),i&&(s=c.height-l.height,a.y=r-s*t.y)}return a},n._moveContentToTopLeft=function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var n=new Pn,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<e.height&&(i=o.height-e.height,n.y=t-i),o.width<e.width&&(i=o.width-e.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(e){e===py.SCALE&&this._calculateBoundary()},J(t,[{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):I(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Yn.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Yn.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}}]),t}(sie),oie.EventType=cie,Yne=ce((Xne=aie).prototype,"bounceDuration",[Dc,gne,yne,xne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Kne=ce(Xne.prototype,"brake",[Dc,Sne,Cne,Ane],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Jne=ce(Xne.prototype,"elastic",[Dc,bne,Tne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Qne=ce(Xne.prototype,"inertia",[Dc,Ene,wne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ce(Xne.prototype,"content",[Ine,Pne,Rne],Object.getOwnPropertyDescriptor(Xne.prototype,"content"),Xne.prototype),Zne=ce(Xne.prototype,"horizontal",[Dc,Dne,One],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ce(Xne.prototype,"horizontalScrollBar",[Nne,Bne,Mne],Object.getOwnPropertyDescriptor(Xne.prototype,"horizontalScrollBar"),Xne.prototype),$ne=ce(Xne.prototype,"vertical",[Dc,Lne,Fne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ce(Xne.prototype,"verticalScrollBar",[zne,Vne,Gne],Object.getOwnPropertyDescriptor(Xne.prototype,"verticalScrollBar"),Xne.prototype),eie=ce(Xne.prototype,"cancelInnerEvents",[Dc,Une,kne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tie=ce(Xne.prototype,"scrollEvents",[Hne,Dc,jne,Wne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nie=ce(Xne.prototype,"_content",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iie=ce(Xne.prototype,"_horizontalScrollBar",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rie=ce(Xne.prototype,"_verticalScrollBar",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qne=Xne))||qne)||qne)||qne)||qne)||qne));l.ScrollView=Fie;var zie,Vie=new Pn;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(zie||(zie={})),st(zie);var Gie,Uie,kie,Hie,jie,Wie,qie,Xie,Yie,Kie,Jie,Qie,Zie,$ie,ere,tre,nre,ire,rre,ore,are=function(t){return e({Slider:t,SliderComponent:t}),t}((mie=Ac("cc.Slider"),vie=Uc(),gie=Tc(110),yie=Fc(),xie=bc(uz),Sie=ol(Ik),Cie=qc(),Aie=ol(zie),bie=qc(),Tie=Xc(),Eie=qc(),wie=ol([QM]),Iie=qc(),mie(Pie=vie(Pie=gie(Pie=yie(Pie=xie((Lie=Mie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"slideEvents",Die,re(t)),se(t,"_handle",Oie,re(t)),se(t,"_direction",Nie,re(t)),se(t,"_progress",Bie,re(t)),t._offset=new Pn,t._dragging=!1,t._touchHandle=!1,t._handleLocalPos=new Pn,t._touchPos=new Pn,t}Z(t,e);var n=t.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(eb.TOUCH_START,this._onTouchBegan,this),this.node.on(eb.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(eb.TOUCH_END,this._onTouchEnded,this),this.node.on(eb.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(eb.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(eb.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(eb.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(eb.TOUCH_START,this._onTouchBegan,this),this.node.off(eb.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(eb.TOUCH_END,this._onTouchEnded,this),this.node.off(eb.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(eb.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(eb.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(eb.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();Pn.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}},n._onTouchBegan=function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchMoved=function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchEnded=function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new Pn,e&&(e.propagationStopped=!0)},n._onTouchCancelled=function(e){this._dragging=!1,e&&(e.propagationStopped=!0)},n._handleSliderLogic=function(e){this._updateProgress(e),this._emitSlideEvent()},n._emitSlideEvent=function(){QM.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(e){if(this._handle&&e){var t=e.getUILocation();Pn.set(this._touchPos,t.x,t.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,Vie);this.direction===zie.Horizontal?this.progress=ln(.5+(i.x-this._offset.x)/n.width):this.progress=ln(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===zie.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var n=this._handle.node.position;this._direction===zie.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},J(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(Ku),Mie.Direction=zie,ce((Rie=Lie).prototype,"handle",[Sie,Cie],Object.getOwnPropertyDescriptor(Rie.prototype,"handle"),Rie.prototype),ce(Rie.prototype,"direction",[Aie,bie],Object.getOwnPropertyDescriptor(Rie.prototype,"direction"),Rie.prototype),ce(Rie.prototype,"progress",[Qc,Tie,Eie],Object.getOwnPropertyDescriptor(Rie.prototype,"progress"),Rie.prototype),Die=ce(Rie.prototype,"slideEvents",[wie,Dc,Iie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Oie=ce(Rie.prototype,"_handle",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nie=ce(Rie.prototype,"_direction",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zie.Horizontal}}),Bie=ce(Rie.prototype,"_progress",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Pie=Rie))||Pie)||Pie)||Pie)||Pie)||Pie));function sre(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(t))}l.Slider=are,function(e){e.TOGGLE="toggle"}(ore||(ore={}));var cre,lre,ure,hre,_re,fre,dre,pre,mre,vre,gre,yre,xre=function(t){return e({Toggle:t,ToggleComponent:t}),t}((Gie=Ac("cc.Toggle"),Uie=Uc(),kie=Tc(110),Hie=Fc(),jie=bc(uz),Wie=Zc(),qie=qc(),Xie=ol(Ik),Yie=Zc(),Kie=qc(),Jie=ol([QM]),Qie=qc(),Gie(Zie=Uie(Zie=kie(Zie=Hie(Zie=jie((rre=ire=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"checkEvents",ere,re(t)),se(t,"_isChecked",tre,re(t)),se(t,"_checkMark",nre,re(t)),t}Z(t,e);var n=t.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(e,t){if(void 0===t&&(t=!0),this._isChecked!=e){this._isChecked=e;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(e||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(e){this._set(e,!1)},n.onEnable=function(){e.prototype.onEnable.call(this),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(t.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var e=this._toggleContainer;e&&e.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&QM.emitEvents(this.checkEvents,this)},J(t,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return l.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}}]),t}(M7),ire.EventType=sre(ore,N7),ce(($ie=rre).prototype,"isChecked",[Wie,qie],Object.getOwnPropertyDescriptor($ie.prototype,"isChecked"),$ie.prototype),ce($ie.prototype,"checkMark",[Xie,Yie,Kie],Object.getOwnPropertyDescriptor($ie.prototype,"checkMark"),$ie.prototype),ere=ce($ie.prototype,"checkEvents",[Jie,Dc,Qie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tre=ce($ie.prototype,"_isChecked",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nre=ce($ie.prototype,"_checkMark",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zie=$ie))||Zie)||Zie)||Zie)||Zie)||Zie));l.Toggle=xre;var Sre,Cre,Are,bre,Tre,Ere,wre,Ire,Pre,Rre,Dre,Ore,Nre,Bre,Mre,Lre,Fre,zre,Vre,Gre,Ure,kre,Hre,jre,Wre,qre,Xre,Yre,Kre,Jre,Qre,Zre,$re,eoe,toe,noe,ioe,roe,ooe,aoe,soe,coe,loe,uoe,hoe,_oe=function(t){return e({ToggleContainer:t,ToggleContainerComponent:t}),t}((cre=Ac("cc.ToggleContainer"),lre=Uc(),ure=Tc(110),hre=Fc(),_re=qc(),fre=ol([QM]),dre=qc(),cre(pre=lre(pre=ure(pre=hre(pre=Lc((yre=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"_allowSwitchOff",vre,re(t)),se(t,"checkEvents",gre,re(t)),t}Z(t,e);var n=t.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(eb.CHILD_ADDED,this.ensureValidState,this),this.node.on(eb.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(eb.CHILD_ADDED,this.ensureValidState,this),this.node.off(eb.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(e){return e.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(e){return e.isChecked}))},n.notifyToggleCheck=function(e,t){if(void 0===t&&(t=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var i=this.toggleItems[n];i!==e&&(t?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&l.Component.EventHandler.emitEvents(this.checkEvents,e)}},n.ensureValidState=function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},J(t,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}}]),t}(Ku),vre=ce((mre=yre).prototype,"_allowSwitchOff",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ce(mre.prototype,"allowSwitchOff",[_re],Object.getOwnPropertyDescriptor(mre.prototype,"allowSwitchOff"),mre.prototype),gre=ce(mre.prototype,"checkEvents",[fre,Dc,dre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pre=mre))||pre)||pre)||pre)||pre)||pre));l.ToggleContainer=_oe;var foe,doe,poe=new Yn;function moe(e){return e instanceof DR?nN:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:ti.ZERO}function voe(e,t,n,i){e.parent?poe.set(e.parent.getScale().x,e.parent.getScale().y):poe.set(0,0);for(var r=poe.x,o=poe.y,a=0,s=0,c=e.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===t)break;c?poe.set(c.getScale().x,c.getScale().y):poe.set(0,0);var u=poe.x,h=poe.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(foe||(foe={})),st(foe),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(doe||(doe={}));var goe,yoe,xoe,Soe,Coe,Aoe,boe,Toe,Eoe,woe,Ioe,Poe,Roe,Doe,Ooe,Noe,Boe,Moe,Loe,Foe=doe.TOP|doe.BOT,zoe=doe.LEFT|doe.RIGHT,Voe=function(t){return e({Widget:t,WidgetComponent:t}),t}((Sre=Ac("cc.Widget"),Cre=Uc(),Are=Tc(110),bre=Fc(),Tre=bc(uz),Ere=ol(nE),wre=qc(),Ire=qc(),Pre=qc(),Rre=qc(),Dre=qc(),Ore=qc(),Nre=qc(),Bre=Hc(),Mre=Hc(),Lre=qc(),Fre=qc(),zre=qc(),Vre=qc(),Gre=qc(),Ure=qc(),kre=ol(foe),Hre=qc(),Sre(jre=Cre(jre=Are(jre=bre(jre=Tre(jre=Lc((hoe=uoe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastPos=new Pn,t._lastSize=new ti,t._dirty=!0,t._hadAlignOnce=!1,se(t,"_alignFlags",qre,re(t)),se(t,"_target",Xre,re(t)),se(t,"_left",Yre,re(t)),se(t,"_right",Kre,re(t)),se(t,"_top",Jre,re(t)),se(t,"_bottom",Qre,re(t)),se(t,"_horizontalCenter",Zre,re(t)),se(t,"_verticalCenter",$re,re(t)),se(t,"_isAbsLeft",eoe,re(t)),se(t,"_isAbsRight",toe,re(t)),se(t,"_isAbsTop",noe,re(t)),se(t,"_isAbsBottom",ioe,re(t)),se(t,"_isAbsHorizontalCenter",roe,re(t)),se(t,"_isAbsVerticalCenter",ooe,re(t)),se(t,"_originalWidth",aoe,re(t)),se(t,"_originalHeight",soe,re(t)),se(t,"_alignMode",coe,re(t)),se(t,"_lockFlags",loe,re(t)),t}Z(t,e);var n=t.prototype;return n.updateAlignment=function(){l._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),l._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){l._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(eb.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(eb.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(eb.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(eb.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(eb.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(eb.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(eb.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(eb.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(e,t){if((this._alignFlags&e)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:nN;this.isAlignLeft&&e===doe.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===doe.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===doe.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===doe.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===doe.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===doe.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var e=this._target||this.node.parent;e&&e.getComponent(uz)&&(e.on(eb.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(eb.SIZE_CHANGED,this._setDirtyByMode,this),e.on(eb.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var e=this._target||this.node.parent;e&&(e.off(eb.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(eb.SIZE_CHANGED,this._setDirtyByMode,this),e.off(eb.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(e){var t=this._target||e;t&&(t.off(eb.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(eb.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===foe.ALWAYS&&this._recursiveDirty()},n._setAlign=function(e,t){if(t!==(this._alignFlags&e)>0){var n=(e&zoe)>0,i=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~e)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},J(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&doe.TOP)>0},set:function(e){this._setAlign(doe.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&doe.BOT)>0},set:function(e){this._setAlign(doe.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&doe.LEFT)>0},set:function(e){this._setAlign(doe.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&doe.RIGHT)>0},set:function(e){this._setAlign(doe.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&doe.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=doe.MID):this._alignFlags&=~doe.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&doe.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=doe.CENTER):this._alignFlags&=~doe.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&zoe)===zoe}},{key:"isStretchHeight",get:function(){return(this._alignFlags&Foe)===Foe}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(doe.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(doe.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(doe.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(doe.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(doe.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(doe.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(Ku),uoe.AlignMode=foe,ce((Wre=hoe).prototype,"target",[Ere,wre],Object.getOwnPropertyDescriptor(Wre.prototype,"target"),Wre.prototype),ce(Wre.prototype,"isAlignTop",[Ire],Object.getOwnPropertyDescriptor(Wre.prototype,"isAlignTop"),Wre.prototype),ce(Wre.prototype,"isAlignBottom",[Pre],Object.getOwnPropertyDescriptor(Wre.prototype,"isAlignBottom"),Wre.prototype),ce(Wre.prototype,"isAlignLeft",[Rre],Object.getOwnPropertyDescriptor(Wre.prototype,"isAlignLeft"),Wre.prototype),ce(Wre.prototype,"isAlignRight",[Dre],Object.getOwnPropertyDescriptor(Wre.prototype,"isAlignRight"),Wre.prototype),ce(Wre.prototype,"isAlignVerticalCenter",[Ore],Object.getOwnPropertyDescriptor(Wre.prototype,"isAlignVerticalCenter"),Wre.prototype),ce(Wre.prototype,"isAlignHorizontalCenter",[Nre],Object.getOwnPropertyDescriptor(Wre.prototype,"isAlignHorizontalCenter"),Wre.prototype),ce(Wre.prototype,"isStretchWidth",[Bre],Object.getOwnPropertyDescriptor(Wre.prototype,"isStretchWidth"),Wre.prototype),ce(Wre.prototype,"isStretchHeight",[Mre],Object.getOwnPropertyDescriptor(Wre.prototype,"isStretchHeight"),Wre.prototype),ce(Wre.prototype,"top",[Lre],Object.getOwnPropertyDescriptor(Wre.prototype,"top"),Wre.prototype),ce(Wre.prototype,"editorTop",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"editorTop"),Wre.prototype),ce(Wre.prototype,"bottom",[Fre],Object.getOwnPropertyDescriptor(Wre.prototype,"bottom"),Wre.prototype),ce(Wre.prototype,"editorBottom",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"editorBottom"),Wre.prototype),ce(Wre.prototype,"left",[zre],Object.getOwnPropertyDescriptor(Wre.prototype,"left"),Wre.prototype),ce(Wre.prototype,"editorLeft",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"editorLeft"),Wre.prototype),ce(Wre.prototype,"right",[Vre],Object.getOwnPropertyDescriptor(Wre.prototype,"right"),Wre.prototype),ce(Wre.prototype,"editorRight",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"editorRight"),Wre.prototype),ce(Wre.prototype,"horizontalCenter",[Gre],Object.getOwnPropertyDescriptor(Wre.prototype,"horizontalCenter"),Wre.prototype),ce(Wre.prototype,"editorHorizontalCenter",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"editorHorizontalCenter"),Wre.prototype),ce(Wre.prototype,"verticalCenter",[Ure],Object.getOwnPropertyDescriptor(Wre.prototype,"verticalCenter"),Wre.prototype),ce(Wre.prototype,"editorVerticalCenter",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"editorVerticalCenter"),Wre.prototype),ce(Wre.prototype,"isAbsoluteTop",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"isAbsoluteTop"),Wre.prototype),ce(Wre.prototype,"isAbsoluteBottom",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"isAbsoluteBottom"),Wre.prototype),ce(Wre.prototype,"isAbsoluteLeft",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"isAbsoluteLeft"),Wre.prototype),ce(Wre.prototype,"isAbsoluteRight",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"isAbsoluteRight"),Wre.prototype),ce(Wre.prototype,"isAbsoluteHorizontalCenter",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"isAbsoluteHorizontalCenter"),Wre.prototype),ce(Wre.prototype,"isAbsoluteVerticalCenter",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"isAbsoluteVerticalCenter"),Wre.prototype),ce(Wre.prototype,"alignMode",[kre,Hre],Object.getOwnPropertyDescriptor(Wre.prototype,"alignMode"),Wre.prototype),ce(Wre.prototype,"alignFlags",[kc],Object.getOwnPropertyDescriptor(Wre.prototype,"alignFlags"),Wre.prototype),qre=ce(Wre.prototype,"_alignFlags",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xre=ce(Wre.prototype,"_target",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yre=ce(Wre.prototype,"_left",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Kre=ce(Wre.prototype,"_right",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jre=ce(Wre.prototype,"_top",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qre=ce(Wre.prototype,"_bottom",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zre=ce(Wre.prototype,"_horizontalCenter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$re=ce(Wre.prototype,"_verticalCenter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eoe=ce(Wre.prototype,"_isAbsLeft",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),toe=ce(Wre.prototype,"_isAbsRight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),noe=ce(Wre.prototype,"_isAbsTop",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ioe=ce(Wre.prototype,"_isAbsBottom",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),roe=ce(Wre.prototype,"_isAbsHorizontalCenter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ooe=ce(Wre.prototype,"_isAbsVerticalCenter",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),aoe=ce(Wre.prototype,"_originalWidth",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),soe=ce(Wre.prototype,"_originalHeight",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),coe=ce(Wre.prototype,"_alignMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return foe.ON_WINDOW_RESIZE}}),loe=ce(Wre.prototype,"_lockFlags",[Dc,Nc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jre=Wre))||jre)||jre)||jre)||jre)||jre)||jre));l.internal.computeInverseTransForTarget=voe,l.internal.getReadonlyNodeSize=moe,l.Widget=Voe;var Goe,Uoe=new wn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Goe||(Goe={})),st(Goe);var koe,Hoe,joe,Woe,qoe,Xoe,Yoe,Koe,Joe,Qoe,Zoe,$oe,eae,tae,nae,iae,rae,oae,aae,sae,cae,lae,uae,hae,_ae,fae,dae,pae,mae,vae,gae,yae,xae,Sae,Cae,Aae,bae,Tae,Eae,wae,Iae,Pae,Rae,Dae=function(t){return e({PageViewIndicator:t,PageViewIndicatorComponent:t}),t}((goe=Ac("cc.PageViewIndicator"),yoe=Uc(),xoe=Tc(110),Soe=Fc(),Coe=ol(BL),Aoe=qc(),boe=ol(Goe),Toe=qc(),Eoe=ol(ti),woe=qc(),Ioe=qc(),goe(Poe=yoe(Poe=xoe(Poe=Soe((Loe=Moe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"spacing",Doe,re(t)),se(t,"_spriteFrame",Ooe,re(t)),se(t,"_direction",Noe,re(t)),se(t,"_cellSize",Boe,re(t)),t._layout=null,t._pageView=null,t._indicators=[],t}Z(t,e);var n=t.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(e){this._pageView=e,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(Ote),this._layout||(this._layout=this.addComponent(Ote));var e=this._layout;this.direction===Goe.HORIZONTAL?(e.type=Ote.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===Goe.VERTICAL&&(e.type=Ote.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=Ote.ResizeMode.CONTAINER},n._createIndicator=function(){var e=new nE;e.layer=this.node.layer;var t=e.addComponent(Ik);return t.spriteFrame=this.spriteFrame,t.sizeMode=Ik.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e},n._changedState=function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var n=0;n<e.length;++n){var i=e[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;Uoe.set(r.color),Uoe.a=127.5,r.color=Uoe}}if(e[t]._uiProps.uiComp){var o=e[t]._uiProps.uiComp;Uoe.set(o.color),Uoe.a=255,o.color=Uoe}}}},n._refresh=function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var n=0;if(t.length>e.length)for(n=0;n<t.length;++n)e[n]||(e[n]=this._createIndicator());else for(n=e.length-t.length;n>0;--n){var i=e[n-1];this.node.removeChild(i),e.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},J(t,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(Ku),Moe.Direction=Goe,ce((Roe=Loe).prototype,"spriteFrame",[Coe,Aoe],Object.getOwnPropertyDescriptor(Roe.prototype,"spriteFrame"),Roe.prototype),ce(Roe.prototype,"direction",[boe,Toe],Object.getOwnPropertyDescriptor(Roe.prototype,"direction"),Roe.prototype),ce(Roe.prototype,"cellSize",[Eoe,woe],Object.getOwnPropertyDescriptor(Roe.prototype,"cellSize"),Roe.prototype),Doe=ce(Roe.prototype,"spacing",[Dc,Ioe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ooe=ce(Roe.prototype,"_spriteFrame",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Noe=ce(Roe.prototype,"_direction",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Goe.HORIZONTAL}}),Boe=ce(Roe.prototype,"_cellSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(20,20)}}),Poe=Roe))||Poe)||Poe)||Poe)||Poe));l.PageViewIndicator=Dae;var Oae,Nae,Bae,Mae=new Yn;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(Oae||(Oae={})),st(Oae),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(Nae||(Nae={})),st(Nae),function(e){e.PAGE_TURNING="page-turning"}(Bae||(Bae={}));var Lae=function(t){return e({PageView:t,PageViewComponent:t}),t}((koe=Ac("cc.PageView"),Hoe=Uc(),joe=Tc(110),Woe=Fc(),qoe=ol(Oae),Xoe=qc(),Yoe=ol(Nae),Koe=qc(),Joe=Xc(),Qoe=qc(),Zoe=Xc(),$oe=qc(),eae=ol(Dae),tae=qc(),nae=qc(),iae=ol(_ne),rae=Hc(),oae=ol(_ne),aae=Hc(),sae=Hc(),cae=Hc(),lae=Hc(),uae=ol([QM]),hae=Hc(),_ae=qc(),fae=ol([QM]),dae=qc(),koe(pae=Hoe(pae=joe(pae=Woe((Rae=Pae=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"autoPageTurningThreshold",vae,re(t)),se(t,"horizontal",gae,re(t)),se(t,"vertical",yae,re(t)),se(t,"cancelInnerEvents",xae,re(t)),se(t,"scrollEvents",Sae,re(t)),se(t,"pageTurningSpeed",Cae,re(t)),se(t,"pageEvents",Aae,re(t)),se(t,"_sizeMode",bae,re(t)),se(t,"_direction",Tae,re(t)),se(t,"_scrollThreshold",Eae,re(t)),se(t,"_pageTurningEventTiming",wae,re(t)),se(t,"_indicator",Iae,re(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new Pn,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new Yn,t._touchEndPosition=new Yn,t}Z(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this.node.on(eb.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(eb.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(e){this.scrollToPage(e,1)},n.getPages=function(){return this._pages},n.addPage=function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):I(4301))},n.insertPage=function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void I(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}},n.removePage=function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):R(4300,e.name)}},n.removePageAtIndex=function(e){var t=this._pages;if(!(e<0||e>=t.length)){var n=t[e];n&&this.content&&(this.content.removeChild(n),t.splice(e,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var e=this._pages,t=0,n=e.length;t<n;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(e,t){void 0===t&&(t=.3),e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var e=this.content.getComponent(Ote);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<t;++i){var r=this._pages[i].position;this.direction===Nae.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var e=this.view;if(this.content&&e&&this._sizeMode===Oae.Unified)for(var t=this._pages,n=e.contentSize,i=0,r=t.length;i<r;i++)t[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))},n._onTouchBegan=function(t,n){t.touch.getUILocation(Mae),Yn.set(this._touchBeganPosition,Mae.x,Mae.y),e.prototype._onTouchBegan.call(this,t,n)},n._onTouchMoved=function(t,n){e.prototype._onTouchMoved.call(this,t,n)},n._onTouchEnded=function(t,n){t.touch.getUILocation(Mae),Yn.set(this._touchEndPosition,Mae.x,Mae.y),e.prototype._onTouchEnded.call(this,t,n)},n._onTouchCancelled=function(t,n){t.touch.getUILocation(Mae),Yn.set(this._touchEndPosition,Mae.x,Mae.y),e.prototype._onTouchCancelled.call(this,t,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===Nae.Horizontal,this.vertical=this.direction===Nae.Vertical},n._syncSizeMode=function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(Ote);if(t){if(this._sizeMode===Oae.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===Nae.Horizontal?(t.paddingLeft=(e.width-n.width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===Nae.Vertical&&(t.paddingTop=(e.height-n.height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var n=e[t];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,QM.emitEvents(this.pageEvents,this,Bae.PAGE_TURNING),this.node.emit(Bae.PAGE_TURNING,this))},n._isQuicklyScrollable=function(e){if(this.direction===Nae.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===Nae.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(e){var t=new Yn;if(this._sizeMode===Oae.Free)this.direction===Nae.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===Nae.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var n=this.view;if(!n)return t;this.direction===Nae.Horizontal?t.x=e*n.width:this.direction===Nae.Vertical&&(t.y=e*n.height)}return t},n._getDragDirection=function(e){return this._direction===Nae.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1},n._isScrollable=function(e,t,n){if(this._sizeMode===Oae.Free){var i=0,r=0;if(this.direction===Nae.Horizontal)return i=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[n],Math.abs(e.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===Nae.Vertical)return i=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[n],Math.abs(e.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===Nae.Horizontal)return Math.abs(e.x)>=o.width*this.scrollThreshold;if(this.direction===Nae.Vertical)return Math.abs(e.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new Yn;Yn.subtract(t,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(t,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},J(t,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return e.prototype.verticalScrollBar},set:function(e){this.verticalScrollBar=e}},{key:"horizontalScrollBar",get:function(){return e.prototype.horizontalScrollBar},set:function(e){this.horizontalScrollBar=e}}]),t}(Fie),Pae.SizeMode=Oae,Pae.Direction=Nae,Pae.EventType=sre(Bae,cie),ce((mae=Rae).prototype,"sizeMode",[qoe,Xoe],Object.getOwnPropertyDescriptor(mae.prototype,"sizeMode"),mae.prototype),ce(mae.prototype,"direction",[Yoe,Koe],Object.getOwnPropertyDescriptor(mae.prototype,"direction"),mae.prototype),ce(mae.prototype,"scrollThreshold",[Qc,Joe,Qoe],Object.getOwnPropertyDescriptor(mae.prototype,"scrollThreshold"),mae.prototype),ce(mae.prototype,"pageTurningEventTiming",[Qc,Zoe,$oe],Object.getOwnPropertyDescriptor(mae.prototype,"pageTurningEventTiming"),mae.prototype),ce(mae.prototype,"indicator",[eae,tae],Object.getOwnPropertyDescriptor(mae.prototype,"indicator"),mae.prototype),vae=ce(mae.prototype,"autoPageTurningThreshold",[Dc,nae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),ce(mae.prototype,"verticalScrollBar",[iae,sl,rae],Object.getOwnPropertyDescriptor(mae.prototype,"verticalScrollBar"),mae.prototype),ce(mae.prototype,"horizontalScrollBar",[oae,sl,aae],Object.getOwnPropertyDescriptor(mae.prototype,"horizontalScrollBar"),mae.prototype),gae=ce(mae.prototype,"horizontal",[sl,Dc,sae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yae=ce(mae.prototype,"vertical",[sl,Dc,cae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xae=ce(mae.prototype,"cancelInnerEvents",[sl,Dc,lae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Sae=ce(mae.prototype,"scrollEvents",[uae,Dc,sl,hae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cae=ce(mae.prototype,"pageTurningSpeed",[Dc,kc,_ae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),Aae=ce(mae.prototype,"pageEvents",[fae,Dc,dae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bae=ce(mae.prototype,"_sizeMode",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Oae.Unified}}),Tae=ce(mae.prototype,"_direction",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nae.Horizontal}}),Eae=ce(mae.prototype,"_scrollThreshold",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),wae=ce(mae.prototype,"_pageTurningEventTiming",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Iae=ce(mae.prototype,"_indicator",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pae=mae))||pae)||pae)||pae)||pae));l.PageView=Lae;var Fae=new Pn,zae=new Yn,Vae=new Yn,Gae=new Yn(1,1),Uae=new Yn,kae=new Yn;function Hae(e,t){if(!t._hadAlignOnce){t.alignMode===foe.ONCE&&(t._hadAlignOnce=!0);var n,i=t.target,r=Vae,o=Gae;i?voe(e,n=i,r,o):n=e.parent;var a=moe(n),s=n instanceof DR||!n.getComponent(uz),c=s?zae:n.getComponent(uz).anchorPoint,l=s;e.getPosition(Fae);var u=e._uiProps.uiTransformComp,h=Fae.x,_=Fae.y,f=u.anchorPoint,d=e.getScale();if(t.alignFlags&doe.HORIZONTAL){var p=0,m=0,v=a.width;l?(p=nN.left.x,m=nN.right.x):m=(p=-c.x*v)+v,p+=t.isAbsoluteLeft?t.left:t.left*v,m-=t.isAbsoluteRight?t.right:t.right*v,i&&(p+=r.x,p*=o.x,m+=r.x,m*=o.x);var g=0,y=f.x,x=d.x;if(x<0&&(y=1-y,x=-x),t.isStretchWidth)g=m-p,0!==x&&(u.width=g/x),h=p+y*g;else if(g=u.width*x,t.isAlignHorizontalCenter){var S=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,C=(.5-c.x)*a.width;i&&(S*=o.x,C+=r.x,C*=o.x),h=C+(y-.5)*g+S}else h=t.isAlignLeft?p+y*g:m+(y-1)*g;t._lastSize.width=g}if(t.alignFlags&doe.VERTICAL){var A=0,b=0,T=a.height;l?(b=nN.bottom.y,A=nN.top.y):A=(b=-c.y*T)+T,b+=t.isAbsoluteBottom?t.bottom:t.bottom*T,A-=t.isAbsoluteTop?t.top:t.top*T,i&&(b+=r.y,b*=o.y,A+=r.y,A*=o.y);var E=0,w=f.y,I=d.y;if(I<0&&(w=1-w,I=-I),t.isStretchHeight)E=A-b,0!==I&&(u.height=E/I),_=b+w*E;else if(E=u.height*I,t.isAlignVerticalCenter){var P=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*T,R=(.5-c.y)*a.height;i&&(P*=o.y,R+=r.y,R*=o.y),_=R+(w-.5)*E+P}else _=t.isAlignBottom?b+w*E:A+(w-1)*E;t._lastSize.height=E}e.setPosition(h,_,Fae.z),Pn.set(t._lastPos,h,_,Fae.z)}}function jae(e){var t=e.getComponent(Voe);if(t&&t.enabled){if(!l.isValid(e,!0))return;Xae.push(t)}for(var n,i=ae(e.children);!(n=i()).done;){var r=n.value;r.active&&jae(r)}}function Wae(){var e=$O.getScene();if(e){Yae.isAligning=!0,Yae._nodesOrderDirty&&(Xae.length=0,jae(e),Yae._nodesOrderDirty=!1);var t=null,n=Yae._activeWidgetsIterator;for(n.i=0;n.i<Xae.length;++n.i)(t=Xae[n.i])._dirty&&(Hae(t.node,t),t._dirty=!1);Yae.isAligning=!1}}var qae,Xae=[],Yae=e("widgetManager",l._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new tt.MutableForwardIterator(Xae),animationState:null,init:function(){$O.on(ZO.EVENT_AFTER_SCENE_LAUNCH,Wae),$O.on(ZO.EVENT_AFTER_UPDATE,Wae),oN.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);oN.instance.on("canvas-resize",e),nh.on("orientation-change",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=$O.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=nE.isNode(e)&&e.getComponent(Voe);t&&t.enabled&&(t.alignMode===foe.ON_WINDOW_RESIZE||t.alignMode===foe.ALWAYS)&&t.setDirty();for(var n,i=ae(e.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function n(e,t){return Math.abs(e-t)>1e-10?t:e}var i=e.node,r=i.parent;if(r){var o=Uae;o.set(0,0);var a=kae;if(a.set(1,1),e.target&&voe(i,r=e.target,o,a),!t)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:zae,l=i._uiProps.uiTransformComp,u=moe(r),h=l.anchorPoint,_=i.getPosition(),f=doe,d=i.getScale(),p=0;if(t&f.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,p=_.x-h.x*l.width*Math.abs(d.x)-m,e.isAbsoluteLeft||(p/=u.width),p/=a.x,e.left=n(e.left,p)}if(t&f.RIGHT){var v=(1-c.x)*u.width;v+=o.x,p=(v*=a.x)-(_.x+(1-h.x)*l.width*Math.abs(d.x)),e.isAbsoluteRight||(p/=u.width),p/=a.x,e.right=n(e.right,p)}if(t&f.TOP){var g=(1-c.y)*u.height;g+=o.y,p=(g*=a.y)-(_.y+(1-h.y)*l.height*Math.abs(d.y)),e.isAbsoluteTop||(p/=u.height),p/=a.y,e.top=n(e.top,p)}if(t&f.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,p=_.y-h.y*l.height*Math.abs(d.y)-y,e.isAbsoluteBottom||(p/=u.height),p/=a.y,e.bottom=n(e.bottom,p)}}},updateAlignment:function e(t){var n=t.parent;n&&nE.isNode(n)&&e(n);var i=t.getComponent(Voe);i&&n&&Hae(t,i)},AlignMode:foe,AlignFlags:doe});$O.on(ZO.EVENT_INIT,(function(){Yae.init()}));var Kae,Jae,Qae,Zae,$ae,ese,tse,nse,ise,rse,ose,ase,sse,cse,lse,use,hse,_se,fse,dse=function(t){return e({SafeArea:t,SafeAreaComponent:t}),t}(Ac("cc.SafeArea")(qae=Uc()(qae=Tc(110)(qae=Lc(qae=Fc()(qae=bc(Voe)(qae=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.onEnable=function(){this.updateArea(),nh.on("window-resize",this.updateArea,this),nh.on("orientation-change",this.updateArea,this)},n.onDisable=function(){nh.off("window-resize",this.updateArea,this),nh.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var e=this.node.getComponent(Voe),t=this.node.getComponent(uz);if(e&&t){e.updateAlignment();var n=this.node.position.clone(),i=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var r=lN.getVisibleSize(),o=r.width,a=r.height,s=oh.getSafeAreaRect();e.top=a-s.y-s.height,e.bottom=s.y,e.left=s.x,e.right=o-s.x-s.width,e.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/t.width,u=i.y-(c.y-n.y)/t.height;t.setAnchorPoint(l,u),Yae.add(e)}},t}(Ku))||qae)||qae)||qae)||qae)||qae)||qae);l.SafeArea=dse;var pse,mse=function(t){return e({UICoordinateTracker:t,UICoordinateTrackerComponent:t}),t}((Kae=Ac("cc.UICoordinateTracker"),Jae=Uc(),Qae=Fc(),Zae=Tc(110),$ae=ol(nE),ese=qc(),tse=ol(pL),nse=qc(),ise=qc(),rse=qc(),ose=ol([QM]),ase=qc(),Kae(sse=Jae(sse=Qae(sse=Zae((ce((cse=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return se(t=e.call.apply(e,[this].concat(i))||this,"syncEvents",lse,re(t)),se(t,"_target",use,re(t)),se(t,"_camera",hse,re(t)),se(t,"_useScale",_se,re(t)),se(t,"_distance",fse,re(t)),t._transformPos=new Pn,t._viewPos=new Pn,t._canMove=!0,t._lastWPos=new Pn,t._lastCameraPos=new Pn,t}Z(t,e);var n=t.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&Pn.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);QM.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},J(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}(Ku)).prototype,"target",[$ae,ese],Object.getOwnPropertyDescriptor(cse.prototype,"target"),cse.prototype),ce(cse.prototype,"camera",[tse,nse],Object.getOwnPropertyDescriptor(cse.prototype,"camera"),cse.prototype),ce(cse.prototype,"useScale",[ise],Object.getOwnPropertyDescriptor(cse.prototype,"useScale"),cse.prototype),ce(cse.prototype,"distance",[rse],Object.getOwnPropertyDescriptor(cse.prototype,"distance"),cse.prototype),lse=ce(cse.prototype,"syncEvents",[ose,Dc,ase],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),use=ce(cse.prototype,"_target",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hse=ce(cse.prototype,"_camera",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_se=ce(cse.prototype,"_useScale",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),fse=ce(cse.prototype,"_distance",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sse=cse))||sse)||sse)||sse)||sse)),vse=[eb.TOUCH_START,eb.TOUCH_END,eb.TOUCH_MOVE,eb.MOUSE_DOWN,eb.MOUSE_MOVE,eb.MOUSE_UP,eb.MOUSE_ENTER,eb.MOUSE_LEAVE,eb.MOUSE_WHEEL];function gse(e){e.propagationStopped=!0}var yse,xse,Sse,Cse,Ase,bse,Tse,Ese,wse,Ise,Pse,Rse,Dse=function(t){return e({BlockInputEvents:t,BlockInputEventsComponent:t}),t}(Ac("cc.BlockInputEvents")(pse=Uc()(pse=Fc()(pse=function(e){function t(){return e.apply(this,arguments)||this}Z(t,e);var n=t.prototype;return n.onEnable=function(){for(var e=0;e<vse.length;e++)this.node.on(vse[e],gse,this)},n.onDisable=function(){for(var e=0;e<vse.length;e++)this.node.off(vse[e],gse,this)},t}(Ku))||pse)||pse)||pse),Ose=e("SubContextView",(yse=Ac("cc.SubContextView"),xse=Uc(),Sse=Tc(110),Cse=bc(uz),Ase=Fc(),bse=qc(),Tse=qc(),yse(Ese=xse(Ese=Sse(Ese=Cse(Ese=Ase((ce((wse=function(e){function t(){var t;return se(t=e.call(this)||this,"_fps",Ise,re(t)),t._sprite=void 0,t._imageAsset=void 0,t._texture=void 0,t._updatedTime=0,t._updateInterval=0,t._openDataContext=void 0,t._content=void 0,se(t,"_designResolutionSize",Pse,re(t)),t._content=new nE("content"),t._content.hideFlags|=fl.Flags.DontSave|fl.Flags.HideInHierarchy,t._sprite=null,t._imageAsset=new Um,t._openDataContext=null,t._updatedTime=performance.now(),t._texture=new uv,t}Z(t,e);var n=t.prototype;return n.onLoad=function(){SL.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=SL.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._designResolutionSize.width,n=this._designResolutionSize.height;e.width=t,e.height=n}},n._initContentNode=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(Ik),this._sprite||(this._sprite=this._content.addComponent(Ik)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new BL;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var e=this.node.getComponent(uz),t=this._content.getComponent(uz),n=e.width/t.width,i=e.height/t.height,r=n>i?i:n;t.width*=r,t.height*=r;var o=lN.getViewportRect(),a=t.getBoundingBoxToWorld(),s=lN.getVisibleSize(),c=nh.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,_=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:_})}},n._updateSubContextTexture=function(){var e=this._imageAsset;if(e&&this._openDataContext&&!(e.width<=0||e.height<=0)){var t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}},n._registerNodeEvent=function(){this.node.on(eb.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(eb.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(eb.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(eb.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(eb.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(eb.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},J(t,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}}]),t}(Ku)).prototype,"designResolutionSize",[bse],Object.getOwnPropertyDescriptor(wse.prototype,"designResolutionSize"),wse.prototype),ce(wse.prototype,"fps",[Tse],Object.getOwnPropertyDescriptor(wse.prototype,"fps"),wse.prototype),Ise=ce(wse.prototype,"_fps",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Pse=ce(wse.prototype,"_designResolutionSize",[Dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ti(640,960)}}),Ese=wse))||Ese)||Ese)||Ese)||Ese)||Ese));l.SubContextView=Ose;var Nse=e("UIReorderComponent",Ac("cc.UIReorderComponent")(Rse=function(){R(1408,"UIReorderComponent")})||Rse);l.UIReorderComponent=Nse,l.ButtonComponent=M7,nt.setClassAlias(M7,"cc.ButtonComponent"),l.EditBoxComponent=ste,nt.setClassAlias(ste,"cc.EditBoxComponent"),l.LayoutComponent=Ote,nt.setClassAlias(Ote,"cc.LayoutComponent"),l.ProgressBarComponent=ine,nt.setClassAlias(ine,"cc.ProgressBarComponent"),l.ScrollViewComponent=Fie,nt.setClassAlias(Fie,"cc.ScrollViewComponent"),l.ScrollBarComponent=_ne,nt.setClassAlias(_ne,"cc.ScrollBarComponent"),l.SliderComponent=are,nt.setClassAlias(are,"cc.SliderComponent"),l.ToggleComponent=xre,nt.setClassAlias(xre,"cc.ToggleComponent"),l.ToggleContainerComponent=_oe,nt.setClassAlias(_oe,"cc.ToggleContainerComponent"),l.WidgetComponent=Voe,nt.setClassAlias(Voe,"cc.WidgetComponent"),l.PageViewComponent=Lae,nt.setClassAlias(Lae,"cc.PageViewComponent"),l.PageViewIndicatorComponent=Dae,nt.setClassAlias(Dae,"cc.PageViewIndicatorComponent"),l.SafeAreaComponent=dse,nt.setClassAlias(dse,"cc.SafeAreaComponent"),nt.setClassAlias(mse,"cc.UICoordinateTrackerComponent"),l.BlockInputEventsComponent=Dse,nt.setClassAlias(Dse,"cc.BlockInputEventsComponent")}}}));
